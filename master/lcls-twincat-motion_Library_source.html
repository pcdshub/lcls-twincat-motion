

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUTs &mdash; pcdshub/lcls-twincat-motion  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/tree.css?v=837a00b9" />
      <link rel="stylesheet" type="text/css" href="_static/width.css?v=ab210c7a" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/docs-versions-menu.js?v=3d6a1aea"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Data Types" href="lcls-twincat-motion_Library_epics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pcdshub/lcls-twincat-motion
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">lcls-twincat-motion</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_pragmas.html">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_nc.html">NC Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_ethercat.html">EtherCAT Terminals</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_boxes.html">Boxes</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_links.html">Links</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Library</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_Library_summary.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_Library_summary.html#pragmas">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_Library_summary.html#libraries">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_Library_summary.html#symbols">Symbols</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_Library_epics.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_Library_epics.html#database-records">Database Records</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DUTs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dut-axisstatus-v0-01">DUT_AxisStatus_v0_01</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-errorstate">DUT_ErrorState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-motionpneumaticactuator">DUT_MotionPneumaticActuator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-motionstage">DUT_MotionStage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-positionstate">DUT_PositionState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-terminalerror">DUT_TerminalError</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dutel2521-ctrl">dutEL2521_Ctrl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dutel2521-status">dutEL2521_Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-ds402drivestate">E_DS402DriveState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-ds402egu">E_DS402EGU</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-ds402homingmethod">E_DS402HomingMethod</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-ds402opmode">E_DS402OpMode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-epicsinout">E_EpicsInOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-homestates">E_HomeStates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-lclsmotionerror">E_LCLSMotionError</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-module">E_Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-movemode">E_MoveMode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-movestate">E_MoveState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-pnuematicactuatorpositionstate">E_PnuematicActuatorPositionState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-stagebrakemode">E_StageBrakeMode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-statepmpsstatus">E_StatePMPSStatus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-teststates">E_TestStates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el5042-status">EL5042_Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-axisstates">ENUM_AxisStates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-epicshomecmd">ENUM_EpicsHomeCmd</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-epicsinout">ENUM_EpicsInOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-epicsinout-int">ENUM_EpicsInOut_INT</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-epicsmotorcmd">ENUM_EpicsMotorCmd</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-motionfftype">ENUM_MotionFFType</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-motionrequest">ENUM_MotionRequest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-pnuematicactuatorpositionstate">ENUM_PnuematicActuatorPositionState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-stagebrakemode">ENUM_StageBrakeMode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-stageenablemode">ENUM_StageEnableMode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-statepmpsstatus">ENUM_StatePMPSStatus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-axisparametersetexposed">ST_AxisParameterSetExposed</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-ds402drive">ST_DS402Drive</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-ds402drivestatus">ST_DS402DriveStatus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-el5042-status">ST_EL5042_Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-motionepicsinterface">ST_MotionEpicsInterface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-motionpneumaticactuator">ST_MotionPneumaticActuator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-positionstate">ST_PositionState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-renishawabsenc">ST_RenishawAbsEnc</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-statepmpsepicstoplc">ST_StatePMPSEpicsToPlc</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-statepmpsplctoepics">ST_StatePMPSPlcToEpics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#gvls">GVLs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#gvl">GVL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-errorsystem">GVL_ErrorSystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#motionconstants">MotionConstants</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#pous">POUs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#checkbounds">CheckBounds</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkdivdint">CheckDivDInt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkdivlint">CheckDivLInt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkdivlreal">CheckDivLReal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkdivreal">CheckDivReal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#demo">Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ek1200">EK1200</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el1008">EL1008</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el1018">EL1018</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el1808">EL1808</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el1809">EL1809</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el1819">EL1819</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el2014">EL2014</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el2252">EL2252</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el2808">EL2808</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el2819">EL2819</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el3174-0002">EL3174_0002</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el3214">EL3214</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el3255">EL3255</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el5002">EL5002</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el5021">EL5021</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el5042">EL5042</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el5101">EL5101</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el7211-v1-00">EL7211_v1_00</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el9410">EL9410</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el9505">EL9505</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el9576-v1-00">EL9576_v1_00</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-motionerrorcodelookup">F_MotionErrorCodeLookup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-posoverlowerbound">F_PosOverLowerBound</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-posunderupperbound">F_PosUnderUpperBound</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-poswithindelta">F_PosWithinDelta</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-atpositionstate-test">FB_AtPositionState_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-axisparametersetexposed-test">FB_AxisParameterSetExposed_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-axisstatusnc">FB_AxisStatusNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-backlashcompensationnc">FB_BacklashCompensationNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-brakenc">FB_BrakeNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-brakenc-test">FB_BrakeNC_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-calculatefrequency-3702-v0-01">FB_CalculateFrequency_3702_v0_01</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-causencerror">FB_CauseNCError</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-drivevirtual">FB_DriveVirtual</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-el1252asm-v1-00">FB_EL1252ASM_v1_00</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-encerrorffo">FB_EncErrorFFO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-encoderscaling">FB_EncoderScaling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-encodervalue">FB_EncoderValue</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-encsaverestore">FB_EncSaveRestore</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-epicsinout">FB_EpicsInOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-errorlist">FB_ErrorList</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gantryautocoupling">FB_GantryAutoCoupling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gantrydiffvirtuallimitswitch">FB_GantryDiffVirtualLimitSwitch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-haltnc">FB_HaltNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homedirect">FB_HomeDirect</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homeds402">FB_HomeDS402</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homefinish">FB_HomeFinish</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homenc">FB_HomeNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homeprepare">FB_HomePrepare</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homereadncvelocities">FB_HomeReadNcVelocities</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homereadsoftlimenable">FB_HomeReadSoftLimEnable</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-hometoswitch">FB_HomeToSwitch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homevirtual">FB_HomeVirtual</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homewritencvelocities">FB_HomeWriteNcVelocities</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homewritesoftlimenable">FB_HomeWriteSoftLimEnable</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-limswstatus">FB_LimSwStatus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-logmotionerror">FB_LogMotionError</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-microstepcounttest">FB_MicroStepCountTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-miscstateserrorffo">FB_MiscStatesErrorFFO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-miscstateserrorffo-test">FB_MiscStatesErrorFFO_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionaxisnc">FB_MotionAxisNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionbacklashcompensation">FB_MotionBacklashCompensation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionbacklashcompensation-test">FB_MotionBacklashCompensation_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionbptm">FB_MotionBPTM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionbptm-test">FB_MotionBPTM_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionclearasserts">FB_MotionClearAsserts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionclearasserts-test">FB_MotionClearAsserts_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motiondrive">FB_MotionDrive</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionhoming">FB_MotionHoming</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motioninterlockscommon">FB_MotionInterlocksCommon</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motioninterlockslimsw">FB_MotionInterlocksLimSw</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionlogger">FB_MotionLogger</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionpneumaticactuator">FB_MotionPneumaticActuator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionreadpmpsdbnd">FB_MotionReadPMPSDBND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionreadpmpsdbnd-test">FB_MotionReadPMPSDBND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionrequest">FB_MotionRequest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionstagee727">FB_MotionStageE727</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionstagemcs2csp">FB_MotionStageMCS2CSP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionstagenc">FB_MotionStageNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionstagencparams">FB_MotionStageNCParams</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionstagesetandmovehelper">FB_MotionStageSetAndMoveHelper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionstagesethelper">FB_MotionStageSetHelper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionstagesim">FB_MotionStageSim</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionvirtualframe">FB_MotionVirtualFrame</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionvirtualframe-test">FB_MotionVirtualFrame_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-moveabsolutenc">FB_MoveAbsoluteNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ncaxis">FB_NcAxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ncerrorffo">FB_NCErrorFFO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ncerrorffo-test">FB_NCErrorFFO_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-newarchmcmotionblocks-test">FB_NewArchMcMotionBlocks_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-paramssaverestorenc">FB_ParamsSaveRestoreNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-permotorffond">FB_PerMotorFFOND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-permotorffond-test">FB_PerMotorFFOND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-persistentdatastorage">FB_PersistentDataStorage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pmpsjsontesthelper">FB_PMPSJsonTestHelper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstate2d">FB_PositionState2D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstate2d-inout">FB_PositionState2D_InOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstate3d">FB_PositionState3D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatebase">FB_PositionStateBase</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatebase-withpmps">FB_PositionStateBase_WithPMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatebase-withpmps-test">FB_PositionStateBase_WithPMPS_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateinout">FB_PositionStateInOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateinout-withpmps">FB_PositionStateInOut_WithPMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateinout-withpmps-test">FB_PositionStateInOut_WithPMPS_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateinternalnd">FB_PositionStateInternalND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatelock">FB_PositionStateLock</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatemanager">FB_PositionStateManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatemove">FB_PositionStateMove</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatemove-test">FB_PositionStateMove_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatemovend">FB_PositionStateMoveND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatemovend-test">FB_PositionStateMoveND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatend-test">FB_PositionStateND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps">FB_PositionStatePMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps1d-inout">FB_PositionStatePMPS1D_InOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps2d">FB_PositionStatePMPS2D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps2d-inout">FB_PositionStatePMPS2D_InOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps3d">FB_PositionStatePMPS3D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps-base">FB_PositionStatePMPS_Base</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps-test">FB_PositionStatePMPS_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmpsnd-core">FB_PositionStatePMPSND_Core</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmpsnd-test">FB_PositionStatePMPSND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateread">FB_PositionStateRead</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateread-test">FB_PositionStateRead_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatereadnd">FB_PositionStateReadND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatereadnd-test">FB_PositionStateReadND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-powerenablemode-test">FB_PowerEnableMode_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-powernc">FB_PowerNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-rawcountconverter">FB_RawCountConverter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-readfloatparameter">FB_ReadFloatParameter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-readparameterinnc-v1-00">FB_ReadParameterInNc_v1_00</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-readparameternc">FB_ReadParameterNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-resetnc">FB_ResetNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-setenables">FB_SetEnables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-standard-pmpsdb">FB_Standard_PMPSDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statepmpsenables">FB_StatePMPSEnables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statepmpsenables-test">FB_StatePMPSEnables_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statepmpsenablesnd">FB_StatePMPSEnablesND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statepmpsenablesnd-test">FB_StatePMPSEnablesND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-stateptpmove">FB_StatePTPMove</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statesetuphelper">FB_StateSetupHelper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statesetuphelper-test">FB_StateSetupHelper_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statesinputhandler">FB_StatesInputHandler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-testhelpersetandmove">FB_TestHelperSetAndMove</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-testhelpersetandmove-test">FB_TestHelperSetAndMove_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-teststateinittiming">FB_TestStateInitTiming</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-writefloatparameter">FB_WriteFloatParameter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-writeparameterinnc-v1-00">FB_WriteParameterInNc_v1_00</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-writeparameternc">FB_WriteParameterNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prg-test">PRG_TEST</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pcdshub/lcls-twincat-motion</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">DUTs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/lcls-twincat-motion_Library_source.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="duts">
<h1>DUTs<a class="headerlink" href="#duts" title="Link to this heading"></a></h1>
<section id="dut-axisstatus-v0-01">
<h2>DUT_AxisStatus_v0_01<a class="headerlink" href="#dut-axisstatus-v0-01" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">DUT_AxisStatus_v0_01</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nCommand</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fAcceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fDeceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bJogFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bJogBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fOverride</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">bHomeSensor</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">fActVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fActPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fActDiff</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bHomed</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-axisstatus-v0-01">DUT_AxisStatus_v0_01</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="dut-errorstate">
<h2>DUT_ErrorState<a class="headerlink" href="#dut-errorstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">DUT_ErrorState</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="kc">None</span><span class="p">,</span>
    <span class="n">Active</span><span class="p">,</span>
    <span class="n">Inactive</span><span class="p">,</span>
    <span class="n">Acknowledged</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="dut-motionpneumaticactuator">
<h2>DUT_MotionPneumaticActuator<a class="headerlink" href="#dut-motionpneumaticactuator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;DUT_MotionPneumaticActuator has been renamed to ST_MotionPneumaticActuator&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">DUT_MotionPneumaticActuator</span> <span class="p">:</span> <span class="n">ST_MotionPneumaticActuator</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionpneumaticactuator">ST_MotionPneumaticActuator</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="dut-motionstage">
<h2>DUT_MotionStage<a class="headerlink" href="#dut-motionstage" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;DUT_MotionStage has been renamed to ST_MotionStage&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">DUT_MotionStage</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="dut-positionstate">
<h2>DUT_PositionState<a class="headerlink" href="#dut-positionstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;DUT_PositionState has been renamed to ST_PositionState&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">DUT_PositionState</span> <span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="dut-terminalerror">
<h2>DUT_TerminalError<a class="headerlink" href="#dut-terminalerror" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">DUT_TerminalError</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">//</span><span class="n">Error</span> <span class="n">system</span> <span class="n">related</span>
    <span class="n">iTerminalID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>                                      <span class="o">//</span><span class="n">ID</span> <span class="n">of</span> <span class="n">the</span> <span class="n">terminal</span>
    <span class="n">Error_ID</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>                          <span class="o">//</span><span class="n">ID</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Error</span> <span class="n">entry</span>
    <span class="n">ErrorState</span> <span class="p">:</span> <span class="n">DUT_ErrorState</span><span class="p">;</span>            <span class="o">//</span><span class="n">State</span> <span class="n">of</span> <span class="n">the</span> <span class="n">error</span>

    <span class="o">//</span><span class="n">Error</span> <span class="n">related</span>
    <span class="n">nDateTimeOn</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>                            <span class="o">//</span><span class="n">Date</span> <span class="ow">and</span> <span class="n">time</span> <span class="n">when</span> <span class="n">the</span> <span class="n">error</span> <span class="n">occured</span><span class="o">.</span> <span class="n">Raw</span> <span class="n">data</span>
    <span class="n">sDateTimeOn</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>                       <span class="o">//</span><span class="n">Date</span> <span class="ow">and</span> <span class="n">time</span> <span class="n">when</span> <span class="n">the</span> <span class="n">error</span> <span class="n">occured</span><span class="o">.</span> <span class="n">Readable</span> <span class="nb">format</span>
    <span class="n">nDateTimeOff</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>                           <span class="o">//</span><span class="n">Date</span> <span class="ow">and</span> <span class="n">time</span> <span class="n">when</span> <span class="n">the</span> <span class="n">error</span> <span class="n">disapeared</span><span class="o">.</span> <span class="n">Raw</span> <span class="n">data</span>
    <span class="n">sDateTimeOff</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>                      <span class="o">//</span><span class="n">Date</span> <span class="ow">and</span> <span class="n">time</span> <span class="n">when</span> <span class="n">the</span> <span class="n">error</span> <span class="n">disapeared</span><span class="o">.</span> <span class="n">Readable</span> <span class="nb">format</span>
    <span class="n">bWcState</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                        <span class="o">//</span><span class="n">WcState</span> <span class="n">variable</span> <span class="n">of</span> <span class="n">the</span> <span class="n">terminal</span>
    <span class="n">uiInfoDataState</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                         <span class="o">//</span><span class="n">InfoData</span><span class="o">.</span><span class="n">State</span> <span class="n">variable</span> <span class="n">of</span> <span class="n">the</span> <span class="n">terminal</span>
    <span class="n">sErrorMessage</span> <span class="p">:</span> <span class="n">STRING</span> <span class="p">(</span><span class="mi">128</span><span class="p">);</span>           <span class="o">//</span><span class="n">Error</span> <span class="n">message</span> <span class="n">corresponding</span> <span class="n">to</span> <span class="n">WcState</span> <span class="ow">and</span> <span class="n">InfoData</span><span class="o">.</span><span class="n">State</span>
    <span class="n">ErrorType</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>                                        <span class="o">//</span><span class="n">Error</span> <span class="n">types</span> <span class="p">(</span><span class="n">priorities</span><span class="p">)</span> <span class="n">need</span> <span class="n">to</span> <span class="n">be</span> <span class="n">developed</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-errorstate">DUT_ErrorState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="dutel2521-ctrl">
<h2>dutEL2521_Ctrl<a class="headerlink" href="#dutel2521-ctrl" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">dutEL2521_Ctrl</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">///</span><span class="n">The</span> <span class="n">control</span> <span class="n">word</span> <span class="p">(</span><span class="n">CW</span><span class="p">)</span> <span class="ow">is</span> <span class="n">located</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">output</span> <span class="n">process</span> <span class="n">image</span><span class="p">,</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">transmitted</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">controller</span> <span class="n">to</span> <span class="n">the</span> <span class="n">terminal</span><span class="o">.</span>
    <span class="o">///</span><span class="n">CW</span><span class="mf">.0</span> <span class="n">FREQ_SEL</span> <span class="mi">0</span><span class="nb">bin</span> <span class="o">/</span> <span class="mi">1</span><span class="nb">bin</span>  <span class="n">Rapid</span> <span class="n">change</span> <span class="n">of</span> <span class="n">the</span> <span class="n">base</span> <span class="n">frequency</span> <span class="p">(</span><span class="n">only</span> <span class="k">if</span> <span class="n">the</span> <span class="n">ramp</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">inactive</span><span class="p">):</span>
    <span class="o">///</span><span class="mi">0</span><span class="nb">bin</span> <span class="o">=</span> <span class="n">Base</span> <span class="n">frequency</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">object</span> <span class="mi">8001</span><span class="p">:</span><span class="mi">02</span><span class="p">)</span>
    <span class="o">///</span><span class="mi">1</span><span class="nb">bin</span> <span class="o">=</span> <span class="n">Base</span> <span class="n">frequency</span> <span class="mi">2</span> <span class="p">(</span><span class="nb">object</span> <span class="mi">8001</span><span class="p">:</span><span class="mi">03</span><span class="p">)</span>
    <span class="n">FREQ_SEL</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">CW</span><span class="mf">.1</span> <span class="n">RAMP_DIS</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">Operation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">ramp</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">cancelled</span><span class="p">,</span> <span class="ow">in</span> <span class="n">spite</span> <span class="n">of</span> <span class="nb">object</span> <span class="mi">8000</span><span class="p">:</span><span class="mi">06</span> <span class="n">being</span> <span class="n">active</span><span class="p">;</span> <span class="k">if</span> <span class="n">travel</span> <span class="n">distance</span> <span class="n">control</span> <span class="ow">is</span> <span class="n">active</span><span class="p">,</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">interrupted</span> <span class="n">by</span> <span class="n">this</span> <span class="n">bit</span>
    <span class="n">RAMP_DIS</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">CW</span><span class="mf">.2</span> <span class="n">GO_COUNTER</span> <span class="mi">1</span><span class="nb">bin</span>  <span class="n">If</span> <span class="n">travel</span> <span class="n">distance</span> <span class="n">control</span> <span class="ow">is</span> <span class="n">active</span> <span class="p">(</span><span class="nb">object</span> <span class="mi">8000</span><span class="p">:</span><span class="mi">0</span><span class="n">A</span><span class="p">),</span> <span class="n">then</span> <span class="n">a</span> <span class="n">pre</span><span class="o">-</span><span class="nb">set</span> <span class="n">counter</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">approached</span> <span class="n">when</span> <span class="n">the</span> <span class="n">bit</span> <span class="ow">is</span> <span class="nb">set</span>
    <span class="n">GO_COUNTER</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">CW</span><span class="mf">.5</span> <span class="n">CNT_CLR</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">The</span> <span class="n">contents</span> <span class="n">of</span> <span class="n">the</span> <span class="n">counter</span> <span class="ow">is</span> <span class="n">cleared</span> <span class="ow">or</span> <span class="nb">set</span> <span class="p">(</span><span class="nb">object</span> <span class="mi">8000</span><span class="p">:</span><span class="mi">0</span><span class="n">B</span><span class="p">)</span> <span class="n">by</span> <span class="n">this</span> <span class="n">bit</span><span class="o">.</span>
    <span class="o">///</span><span class="n">Any</span> <span class="n">overflow</span> <span class="ow">or</span> <span class="n">underflow</span> <span class="n">bits</span> <span class="n">that</span> <span class="n">might</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">are</span> <span class="n">also</span> <span class="n">cleared</span> <span class="n">by</span> <span class="n">this</span> <span class="n">bit</span><span class="o">.</span>
    <span class="o">///</span><span class="n">The</span> <span class="n">process</span> <span class="n">can</span> <span class="n">be</span> <span class="n">edge</span> <span class="n">triggered</span> <span class="ow">or</span> <span class="n">level</span> <span class="n">triggered</span> <span class="p">(</span><span class="nb">object</span> <span class="mi">8000</span><span class="p">:</span><span class="mi">05</span><span class="p">)</span><span class="o">.</span>
    <span class="n">CNT_CLR</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="dutel2521-status">
<h2>dutEL2521_Status<a class="headerlink" href="#dutel2521-status" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">dutEL2521_Status</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">///</span><span class="n">The</span> <span class="n">status</span> <span class="n">word</span> <span class="p">(</span><span class="n">SW</span><span class="p">)</span> <span class="ow">is</span> <span class="n">located</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">input</span> <span class="n">process</span> <span class="n">image</span><span class="p">,</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">transmitted</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">terminal</span> <span class="n">to</span> <span class="n">the</span> <span class="n">controller</span><span class="o">.</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.0</span> <span class="n">SEL_ACK</span><span class="o">/</span><span class="n">END_COUNTER</span> <span class="mi">1</span><span class="nb">bin</span>  <span class="n">Confirms</span> <span class="n">the</span> <span class="n">change</span> <span class="n">of</span> <span class="n">base</span> <span class="n">frequency</span><span class="o">.</span> <span class="n">At</span> <span class="n">activated</span> <span class="n">travel</span> <span class="n">distance</span> <span class="n">control</span><span class="p">:</span> <span class="n">target</span> <span class="n">counter</span> <span class="n">value</span> <span class="n">reached</span>
    <span class="n">SEL_ACK</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.1</span> <span class="n">RAMP_ACTIVE</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">Ramp</span> <span class="ow">is</span> <span class="n">currently</span> <span class="n">being</span> <span class="n">followed</span>
    <span class="n">RAMP_ACTIVE</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.2</span> <span class="n">UNDERFLOW</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">This</span> <span class="n">bit</span> <span class="ow">is</span> <span class="nb">set</span> <span class="k">if</span> <span class="n">the</span> <span class="mi">16</span><span class="o">-</span><span class="n">bit</span> <span class="n">counter</span> <span class="n">underflows</span> <span class="p">(</span><span class="mi">0</span> <span class="o">-&gt;</span> <span class="mi">65535</span><span class="p">)</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">reset</span> <span class="n">when</span> <span class="n">the</span> <span class="n">counter</span> <span class="n">drops</span> <span class="n">below</span> <span class="n">two</span> <span class="n">thirds</span> <span class="n">of</span> <span class="n">its</span> <span class="n">measuring</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">43690</span> <span class="o">-&gt;</span> <span class="mi">43689</span><span class="p">)</span> <span class="ow">or</span> <span class="n">immediately</span> <span class="n">an</span> <span class="n">overflow</span> <span class="n">occurs</span><span class="o">.</span>
    <span class="n">UNDERFLOW</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.3</span> <span class="n">OVERFLOW</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">This</span> <span class="n">bit</span> <span class="ow">is</span> <span class="nb">set</span> <span class="k">if</span> <span class="n">the</span> <span class="mi">16</span><span class="o">-</span><span class="n">bit</span> <span class="n">counter</span> <span class="n">overflows</span> <span class="p">(</span><span class="mi">65535</span> <span class="o">-&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">reset</span> <span class="n">when</span> <span class="n">the</span> <span class="n">counter</span> <span class="n">exceeds</span> <span class="n">one</span> <span class="n">third</span> <span class="n">of</span> <span class="n">its</span> <span class="n">measuring</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">21845</span> <span class="o">-&gt;</span> <span class="mi">21846</span><span class="p">)</span> <span class="ow">or</span> <span class="n">immediately</span> <span class="n">an</span> <span class="n">underflow</span> <span class="n">occurs</span>
    <span class="n">OVERFLOW</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.4</span> <span class="n">INPUT_T</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">Status</span> <span class="n">of</span> <span class="n">INPUT_T</span>
    <span class="n">INPUT_T</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.5</span> <span class="n">INPUT_Z</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">Status</span> <span class="n">of</span> <span class="n">INPUT_Z</span>
    <span class="n">INPUT_Z</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.6</span> <span class="n">ERROR</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">General</span> <span class="n">error</span> <span class="n">bit</span><span class="p">,</span> <span class="n">included</span> <span class="k">with</span> <span class="n">overflow</span><span class="o">/</span><span class="n">underflow</span>
    <span class="n">ERROR</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-ds402drivestate">
<h2>E_DS402DriveState<a class="headerlink" href="#e-ds402drivestate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;to_string&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_DS402DriveState</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">INIT</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">NO_FAULT</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">SWITCH_ON_READY</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">SWITCH_ON</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">OPERATION_ENABLED</span><span class="o">:=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">FAULT</span><span class="o">:=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">FAULT_ACTIVE</span><span class="o">:=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">QUICK_STOP_ACTIVE</span><span class="o">:=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">SWITCH_ON_DISABLED</span><span class="o">:=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">MODE_ERROR</span><span class="o">:=</span><span class="mi">9</span><span class="p">,</span>
    <span class="n">WAIT</span>    <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">DONE</span><span class="o">:=</span><span class="mi">11</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-ds402egu">
<h2>E_DS402EGU<a class="headerlink" href="#e-ds402egu" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;to_string&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_DS402EGU</span>  <span class="p">:</span>
<span class="p">(</span>
    <span class="n">MM</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">UM</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">NM</span><span class="o">:=</span><span class="mi">2</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-ds402homingmethod">
<h2>E_DS402HomingMethod<a class="headerlink" href="#e-ds402homingmethod" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;to_string&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_DS402HomingMethod</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">AutoMethod</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">CurrentPositionMethod</span> <span class="o">:=</span> <span class="mi">37</span>
<span class="p">)</span><span class="n">INT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-ds402opmode">
<h2>E_DS402OpMode<a class="headerlink" href="#e-ds402opmode" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;to_string&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_DS402OpMode</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">NONE</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="o">//</span> <span class="n">P</span><span class="o">-</span><span class="n">T</span><span class="o">-</span><span class="n">P</span> <span class="n">target</span> <span class="n">profil</span>
    <span class="n">PROFILE_POSITION</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">PROFIL_VELOCITY</span> <span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">HOME</span><span class="o">:=</span><span class="mi">6</span><span class="p">,</span>
    <span class="o">//</span> <span class="n">Cyclic</span> <span class="n">synchronous</span> <span class="n">modes</span>
    <span class="n">CSP</span> <span class="o">:=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">CSV</span> <span class="o">:=</span><span class="mi">9</span><span class="p">,</span>
    <span class="n">CST</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">CSTCA</span> <span class="o">:=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="o">//</span> <span class="n">smartAct</span> <span class="n">MCS2</span> <span class="nb">open</span> <span class="n">loop</span>
    <span class="n">MCS2_CALIBRATION</span><span class="o">:=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">MCS2_OL_STEP_MODE</span><span class="o">:=-</span><span class="mi">4</span>
<span class="p">)</span> <span class="n">SINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-epicshomecmd">
<h2>E_EpicsHomeCmd<a class="headerlink" href="#e-epicshomecmd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_EpicsHomeCmd</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">the</span> <span class="n">valid</span> <span class="n">options</span> <span class="k">for</span> <span class="n">homing</span> <span class="ow">in</span> <span class="n">FB_MotionStage</span>
<span class="p">(</span>
    <span class="n">LOW_LIMIT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">Low</span> <span class="n">limit</span> <span class="n">switch</span>
    <span class="n">HIGH_LIMIT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">//</span> <span class="n">High</span> <span class="n">limit</span> <span class="n">switch</span>
    <span class="n">HOME_VIA_LOW</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span> <span class="o">//</span> <span class="n">Home</span> <span class="n">switch</span> <span class="n">via</span> <span class="n">low</span> <span class="n">switch</span>
    <span class="n">HOME_VIA_HIGH</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span> <span class="o">//</span> <span class="n">Home</span> <span class="n">switch</span> <span class="n">via</span> <span class="n">high</span> <span class="n">switch</span>
    <span class="n">ABSOLUTE_SET</span> <span class="o">:=</span> <span class="mi">15</span><span class="p">,</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">here</span> <span class="n">to</span> <span class="n">be</span> <span class="n">fHomePosition</span>
    <span class="o">//</span> <span class="n">MCS2</span>
    <span class="n">AUTOZERO</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">CURRENT_POSITION_METHOD</span> <span class="o">:=</span> <span class="mi">37</span><span class="p">,</span>
    <span class="n">NONE</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">99</span> <span class="o">//</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">home</span><span class="p">,</span> <span class="n">ever</span>
<span class="p">)</span> <span class="o">:=</span> <span class="n">NONE</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-epicsinout">
<h2>E_EpicsInOut<a class="headerlink" href="#e-epicsinout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">Example</span> <span class="n">EPICS</span> <span class="n">states</span> <span class="n">enum</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="nb">all</span> <span class="n">versions</span> <span class="n">of</span> <span class="n">the</span> <span class="n">states</span> <span class="n">FBs</span>
<span class="o">//</span> <span class="n">Remove</span> <span class="n">strict</span> <span class="n">attribute</span> <span class="k">for</span> <span class="n">easier</span> <span class="n">handling</span>
<span class="n">TYPE</span> <span class="n">E_EpicsInOut</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">UNKNOWN</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">UNKNOWN</span> <span class="n">must</span> <span class="n">be</span> <span class="ow">in</span> <span class="n">slot</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">FB</span> <span class="n">breaks</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">OUT</span> <span class="n">at</span> <span class="n">slot</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">convention</span>
    <span class="n">IN</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-epicsmotorcmd">
<h2>E_EpicsMotorCmd<a class="headerlink" href="#e-epicsmotorcmd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_EpicsMotorCmd</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">valid</span> <span class="n">EPICS</span> <span class="n">commands</span> <span class="k">for</span> <span class="n">nCommand</span>
<span class="p">(</span>
    <span class="n">JOG</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">MOVE_VELOCITY</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">MOVE_RELATIVE</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">MOVE_ABSOLUTE</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">MOVE_MODULO</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">HOME</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">GEAR</span> <span class="o">:=</span> <span class="mi">30</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-homestates">
<h2>E_HomeStates<a class="headerlink" href="#e-homestates" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;to_string&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_HomeStates</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">IDLING</span><span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">NEXT_MOVE</span><span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">CHECK_FWD</span><span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">CHECK_BWD</span><span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">FINAL_MOVE</span><span class="o">:=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">FINAL_SETPOS</span><span class="o">:=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">ERROR</span><span class="o">:=</span> <span class="o">-</span><span class="mi">99</span><span class="p">,</span>
    <span class="n">WAIT_STOP</span><span class="o">:=</span> <span class="mi">7</span>
<span class="p">)</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-lclsmotionerror">
<h2>E_LCLSMotionError<a class="headerlink" href="#e-lclsmotionerror" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_LCLSMotionError</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">ABORTED</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#7900,</span>
    <span class="n">UNSAFE</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#7901,</span>
    <span class="n">INVALID</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#7902,</span>
    <span class="n">TEST</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FFFF</span>
<span class="p">)</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-module">
<h2>E_Module<a class="headerlink" href="#e-module" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;to_string&#39;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">Default</span> <span class="n">CHAN</span> <span class="mi">1</span><span class="p">,</span> <span class="n">add</span> <span class="mh">0x800</span> <span class="nb">next</span> <span class="n">channel</span>
<span class="n">TYPE</span> <span class="n">E_Module</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">CHAN1</span>   <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">CHAN2</span>   <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">CHAN3</span>   <span class="o">:=</span> <span class="mi">3</span>
<span class="p">)</span> <span class="n">WORD</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-motionfftype">
<h2>E_MotionFFType<a class="headerlink" href="#e-motionfftype" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_MotionFFType</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">STOPPER_FAULT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1000,</span>
    <span class="n">ZERO_RATE</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1001,</span>
    <span class="n">BPTM_TIMEOUT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1002,</span>
    <span class="n">BPTM_ERROR</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1003,</span>
    <span class="n">MAINT_MODE</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1004,</span>
    <span class="n">NOT_A_STATE</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1005,</span>
    <span class="n">INVALID_GOAL</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1006,</span>
    <span class="n">TOO_MANY_TRIPS</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1007,</span>
    <span class="n">BP_MISMATCH</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1008,</span>
    <span class="n">INTERNAL_ERROR</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1009,</span>
    <span class="n">PNEUMATIC_MOVE</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1010,</span>
    <span class="n">MOT_GENERIC</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1011,</span>
    <span class="n">LOW_RESERVED_NC</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#2000,</span>
    <span class="n">HIGH_RESERVED_NC</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#20FF,</span>
    <span class="n">DEVICE_MOVE</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#2100</span>
<span class="p">)</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="n">MOT_GENERIC</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-motionrequest">
<h2>E_MotionRequest<a class="headerlink" href="#e-motionrequest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_MotionRequest</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">behavior</span> <span class="n">options</span> <span class="k">for</span> <span class="n">when</span> <span class="n">FB_MotionRequest</span> <span class="ow">is</span> <span class="n">run</span> <span class="n">during</span> <span class="n">an</span> <span class="n">active</span> <span class="n">move</span> <span class="kn">from</span><span class="w"> </span><span class="nn">another</span> <span class="n">source</span>
<span class="p">(</span>
    <span class="n">WAIT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">INTERRUPT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">ABORT</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionrequest">FB_MotionRequest</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-movemode">
<h2>E_MoveMode<a class="headerlink" href="#e-movemode" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;to_string&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_MoveMode</span>  <span class="p">:</span>
<span class="p">(</span>
    <span class="n">DISCRETE_JOG</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">DISCRETE_VELOCITY</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">DISCRETE_RELATIVE</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">DISCRETE_ABSOLUTE</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">DISCRETE_MODULO</span><span class="o">:=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">DISCRETE_HOMING</span><span class="o">:=</span><span class="mi">10</span>
<span class="p">)</span><span class="n">INT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-movestate">
<h2>E_MoveState<a class="headerlink" href="#e-movestate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;to_string&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_MoveState</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">IDLING</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">INIT</span><span class="o">:=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">STARTED</span><span class="o">:=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">IN_PROGRESS</span> <span class="o">:=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">REACHED</span><span class="o">:=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">INTERRUPTED</span><span class="o">:=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">DONE</span><span class="o">:=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">ERROR</span><span class="o">:=-</span><span class="mi">99</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-pnuematicactuatorpositionstate">
<h2>E_PnuematicActuatorPositionState<a class="headerlink" href="#e-pnuematicactuatorpositionstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">Defines</span> <span class="n">the</span> <span class="n">positions</span> <span class="k">for</span> <span class="n">a</span> <span class="n">pnuematic</span> <span class="n">actuator</span>
<span class="n">TYPE</span> <span class="n">E_PnuematicActuatorPositionState</span> <span class="p">:</span>
<span class="p">(</span>
   <span class="n">RETRACTED</span>    <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">Out</span> <span class="n">limit</span> <span class="n">switch</span> <span class="ow">is</span> <span class="n">active</span>
   <span class="n">INSERTED</span>    <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">In</span> <span class="n">limit</span> <span class="n">switch</span> <span class="ow">is</span> <span class="n">active</span>
   <span class="n">MOVING</span>    <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">//</span> <span class="n">Neither</span> <span class="n">limit</span> <span class="n">switches</span> <span class="ow">is</span> <span class="n">Active</span>
   <span class="n">INVALID</span> <span class="o">:=</span><span class="mi">3</span> <span class="o">//</span> <span class="n">Invalid</span> <span class="n">state</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-stagebrakemode">
<h2>E_StageBrakeMode<a class="headerlink" href="#e-stagebrakemode" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_StageBrakeMode</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">when</span> <span class="n">to</span> <span class="n">send</span> <span class="n">the</span> <span class="n">brake</span> <span class="n">disengage</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">FB_MotionStage</span>
<span class="p">(</span>
    <span class="n">IF_ENABLED</span><span class="p">,</span> <span class="o">//</span> <span class="n">Disengage</span> <span class="n">brake</span> <span class="n">when</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">enabled</span>
    <span class="n">IF_MOVING</span><span class="p">,</span> <span class="o">//</span> <span class="n">Disengage</span> <span class="n">brake</span> <span class="n">when</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">moving</span>
    <span class="n">NO_BRAKE</span> <span class="o">//</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">change</span> <span class="n">the</span> <span class="n">brake</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">FB_MotionStage</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-stageenablemode">
<h2>E_StageEnableMode<a class="headerlink" href="#e-stageenablemode" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_StageEnableMode</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">conditions</span> <span class="n">when</span> <span class="n">FB_MotionStage</span> <span class="n">automatically</span> <span class="n">sets</span> <span class="n">bEnable</span>
<span class="p">(</span>
    <span class="n">ALWAYS</span><span class="p">,</span> <span class="o">//</span> <span class="n">Always</span> <span class="nb">set</span> <span class="n">bEnable</span> <span class="n">to</span> <span class="n">TRUE</span>
    <span class="n">NEVER</span><span class="p">,</span>  <span class="o">//</span> <span class="n">Only</span> <span class="n">change</span> <span class="n">bEnable</span> <span class="n">on</span> <span class="n">errors</span>
    <span class="n">DURING_MOTION</span>  <span class="o">//</span> <span class="n">Enable</span> <span class="n">before</span> <span class="n">motion</span><span class="p">,</span> <span class="n">disable</span> <span class="n">after</span> <span class="n">motion</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-statepmpsstatus">
<h2>E_StatePMPSStatus<a class="headerlink" href="#e-statepmpsstatus" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_StatePMPSStatus</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="o">//</span> <span class="n">No</span> <span class="n">other</span> <span class="n">enum</span> <span class="n">state</span> <span class="n">describes</span> <span class="n">it</span>
    <span class="n">UNKNOWN</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="o">//</span> <span class="n">Moving</span> <span class="n">toward</span> <span class="n">a</span> <span class="n">known</span> <span class="n">state</span>
    <span class="n">TRANSITION</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">//</span> <span class="n">Within</span> <span class="n">a</span> <span class="n">known</span> <span class="n">state</span><span class="p">,</span> <span class="ow">not</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">leave</span>
    <span class="n">AT_STATE</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">some</span> <span class="n">way</span> <span class="n">disabled</span><span class="p">,</span> <span class="n">either</span> <span class="k">with</span> <span class="n">maint</span> <span class="n">mode</span> <span class="ow">or</span> <span class="n">arbiter</span> <span class="n">disable</span>
    <span class="n">DISABLED</span> <span class="o">:=</span> <span class="mi">3</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-teststates">
<h2>E_TestStates<a class="headerlink" href="#e-teststates" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_TestStates</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Unknown</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">TARGET1</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">TARGET2</span> <span class="o">:=</span> <span class="mi">3</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="el5042-status">
<h2>EL5042_Status<a class="headerlink" href="#el5042-status" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;EL5042_Status has been renamed to ST_EL5042_Status&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">EL5042_Status</span> <span class="p">:</span> <span class="n">ST_EL5042_Status</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-el5042-status">ST_EL5042_Status</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-axisstates">
<h2>ENUM_AxisStates<a class="headerlink" href="#enum-axisstates" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;to_string&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_AxisStates</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">UNKNOWN</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">UNKNOWN</span> <span class="n">must</span> <span class="n">be</span> <span class="ow">in</span> <span class="n">slot</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">FB</span> <span class="n">breaks</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">YAG</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">TT</span> <span class="o">:=</span> <span class="mi">3</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="enum-epicshomecmd">
<h2>ENUM_EpicsHomeCmd<a class="headerlink" href="#enum-epicshomecmd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_EpicsHomeCmd&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_EpicsHomeCmd</span> <span class="p">:</span> <span class="n">E_EpicsHomeCmd</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-epicsinout">
<h2>ENUM_EpicsInOut<a class="headerlink" href="#enum-epicsinout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_EpicsInOut&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_EpicsInOut</span> <span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsinout">E_EpicsInOut</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-epicsinout-int">
<h2>ENUM_EpicsInOut_INT<a class="headerlink" href="#enum-epicsinout-int" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use ENUM_EpicsInOut&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">Example</span> <span class="n">EPICS</span> <span class="n">states</span> <span class="n">enum</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="nb">all</span> <span class="n">versions</span> <span class="n">of</span> <span class="n">the</span> <span class="n">states</span> <span class="n">FBs</span>
<span class="o">//</span> <span class="n">Remove</span> <span class="n">strict</span> <span class="n">attribute</span> <span class="k">for</span> <span class="n">easier</span> <span class="n">handling</span>
<span class="n">TYPE</span> <span class="n">ENUM_EpicsInOut_INT</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">UNKNOWN</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">UNKNOWN</span> <span class="n">must</span> <span class="n">be</span> <span class="ow">in</span> <span class="n">slot</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">FB</span> <span class="n">breaks</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">OUT</span> <span class="n">at</span> <span class="n">slot</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">convention</span>
    <span class="n">IN</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="p">)</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-epicsinout">ENUM_EpicsInOut</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-epicsmotorcmd">
<h2>ENUM_EpicsMotorCmd<a class="headerlink" href="#enum-epicsmotorcmd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_EpicsMotorCmd&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_EpicsMotorCmd</span> <span class="p">:</span> <span class="n">E_EpicsMotorCmd</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-motionfftype">
<h2>ENUM_MotionFFType<a class="headerlink" href="#enum-motionfftype" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_MotionFFType&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_MotionFFType</span> <span class="p">:</span> <span class="n">E_MotionFFType</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-motionrequest">
<h2>ENUM_MotionRequest<a class="headerlink" href="#enum-motionrequest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_MotionRequest&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_MotionRequest</span> <span class="p">:</span> <span class="n">E_MotionRequest</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-pnuematicactuatorpositionstate">
<h2>ENUM_PnuematicActuatorPositionState<a class="headerlink" href="#enum-pnuematicactuatorpositionstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_PnuematicActuatorPositionState&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_PnuematicActuatorPositionState</span> <span class="p">:</span> <span class="n">E_PnuematicActuatorPositionState</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-pnuematicactuatorpositionstate">E_PnuematicActuatorPositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-stagebrakemode">
<h2>ENUM_StageBrakeMode<a class="headerlink" href="#enum-stagebrakemode" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_StageBrakeMode&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_StageBrakeMode</span> <span class="p">:</span> <span class="n">E_StageBrakeMode</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stagebrakemode">E_StageBrakeMode</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-stageenablemode">
<h2>ENUM_StageEnableMode<a class="headerlink" href="#enum-stageenablemode" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_StageEnableMode&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_StageEnableMode</span> <span class="p">:</span> <span class="n">E_StageEnableMode</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-statepmpsstatus">
<h2>ENUM_StatePMPSStatus<a class="headerlink" href="#enum-statepmpsstatus" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_StatePMPSStatus&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_StatePMPSStatus</span> <span class="p">:</span> <span class="n">E_StatePMPSStatus</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-statepmpsstatus">E_StatePMPSStatus</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-axisparametersetexposed">
<h2>ST_AxisParameterSetExposed<a class="headerlink" href="#st-axisparametersetexposed" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_AxisParameterSetExposed</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Collects</span> <span class="n">the</span> <span class="n">axis</span> <span class="n">parameters</span> <span class="n">that</span> <span class="n">are</span> <span class="n">intentionally</span> <span class="n">exposed</span> <span class="n">to</span> <span class="n">EPICS</span><span class="o">.</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">Maximum</span> <span class="n">Dynamics</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MaxVel</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Maximum</span> <span class="n">commandable</span> <span class="n">speed</span> <span class="n">of</span> <span class="n">the</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
    <span class="s1">&#39;}</span>
    <span class="n">fVeloMaximum</span>                <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Maximum</span> <span class="n">commandable</span> <span class="n">speed</span> <span class="n">of</span> <span class="n">the</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">/</span><span class="n">s</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MaxAccel</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Maximum</span> <span class="n">rate</span> <span class="n">of</span> <span class="n">increase</span> <span class="ow">in</span> <span class="n">speed</span> <span class="n">of</span> <span class="n">the</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">/</span><span class="n">s</span><span class="o">^</span><span class="mf">2.</span>
    <span class="s1">&#39;}</span>
    <span class="n">fAccelerationMax</span>            <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Maximum</span> <span class="n">rate</span> <span class="n">of</span> <span class="n">increase</span> <span class="ow">in</span> <span class="n">speed</span> <span class="n">of</span> <span class="n">the</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">/</span><span class="n">s</span><span class="o">^</span><span class="mf">2.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MaxDecel</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Maximum</span> <span class="n">rate</span> <span class="n">of</span> <span class="n">decrease</span> <span class="ow">in</span> <span class="n">speed</span> <span class="n">of</span> <span class="n">the</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">/</span><span class="n">s</span><span class="o">^</span><span class="mf">2.</span>
    <span class="s1">&#39;}</span>
    <span class="n">fDecelerationMax</span>            <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Maximum</span> <span class="n">rate</span> <span class="n">of</span> <span class="n">decrease</span> <span class="ow">in</span> <span class="n">speed</span> <span class="n">of</span> <span class="n">the</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">/</span><span class="n">s</span><span class="o">^</span><span class="mf">2.</span>

    <span class="o">//</span> <span class="n">Monitoring</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PosLagEn</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">position</span> <span class="n">lag</span> <span class="n">monitor</span> <span class="p">(</span><span class="n">also</span> <span class="n">known</span> <span class="k">as</span> <span class="n">stall</span> <span class="n">monitor</span><span class="p">)</span> <span class="ow">is</span> <span class="n">enabled</span><span class="o">.</span>
    <span class="s1">&#39;}</span>
    <span class="n">bCtrlEnablePosDiffControl</span>   <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Enable</span><span class="o">/</span><span class="n">Disable</span> <span class="n">state</span> <span class="n">of</span> <span class="n">Position</span> <span class="n">Lag</span> <span class="n">Monitor</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PosLagVal</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Maximum</span> <span class="n">magnitude</span> <span class="n">of</span> <span class="n">position</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">.</span>
    <span class="s1">&#39;}</span>
    <span class="n">fCtrlPosDiffMax</span>             <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Maximum</span> <span class="n">magnitude</span> <span class="n">of</span> <span class="n">position</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PosLagTime</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Maximum</span> <span class="n">allowable</span> <span class="n">duration</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">maximum</span> <span class="n">position</span> <span class="n">lag</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">seconds</span><span class="o">.</span>
    <span class="s1">&#39;}</span>
    <span class="n">fCtrlPosDiffMaxTime</span>         <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Maximum</span> <span class="n">allowable</span> <span class="n">duration</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">maximum</span> <span class="n">position</span> <span class="n">lag</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">seconds</span><span class="o">.</span>

    <span class="o">//</span> <span class="n">Limit</span> <span class="n">Switches</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SLimMinEn</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">controller</span> <span class="n">static</span> <span class="n">minimum</span> <span class="n">limit</span> <span class="ow">is</span> <span class="n">enabled</span><span class="o">.</span>
    <span class="s1">&#39;}</span>
    <span class="n">bEncEnableSoftEndMinControl</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Enable</span><span class="o">/</span><span class="n">Disable</span> <span class="n">state</span> <span class="n">of</span> <span class="n">controller</span> <span class="n">static</span> <span class="n">minimum</span> <span class="n">limit</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SLimMaxEn</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">controller</span> <span class="n">static</span> <span class="n">maximum</span> <span class="n">limit</span> <span class="ow">is</span> <span class="n">enabled</span><span class="o">.</span>
    <span class="s1">&#39;}</span>
    <span class="n">bEncEnableSoftEndMaxControl</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Enable</span><span class="o">/</span><span class="n">Disable</span> <span class="n">state</span> <span class="n">of</span> <span class="n">controller</span> <span class="n">static</span> <span class="n">maximum</span> <span class="n">limit</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SLimMin</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Minimum</span> <span class="n">commandable</span> <span class="n">position</span> <span class="n">of</span> <span class="n">the</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">.</span>
    <span class="s1">&#39;}</span>
    <span class="n">fEncSoftEndMin</span>              <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Minimum</span> <span class="n">commandable</span> <span class="n">position</span> <span class="n">of</span> <span class="n">the</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SLimMax</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Maximum</span> <span class="n">commandable</span> <span class="n">position</span> <span class="n">of</span> <span class="n">the</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">.</span>
    <span class="s1">&#39;}</span>
    <span class="n">fEncSoftEndMax</span>              <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Maximum</span> <span class="n">commandable</span> <span class="n">position</span> <span class="n">of</span> <span class="n">the</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">.</span>

    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">Evaluation</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">EncScaling</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Encoder</span> <span class="n">scaling</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">/</span><span class="n">COUNT</span><span class="o">.</span>
    <span class="s1">&#39;}</span>
    <span class="n">fEncScaleFactorInternal</span>      <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Encoder</span> <span class="n">scaling</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">/</span><span class="n">COUNT</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">EncOffset</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Encoder</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">.</span>
    <span class="s1">&#39;}</span>
    <span class="n">fEncOffset</span>                   <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Encoder</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">EU</span><span class="o">.</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-ds402drive">
<h2>ST_DS402Drive<a class="headerlink" href="#st-ds402drive" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_DS402Drive</span><span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Global</span> <span class="n">variables</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TPDO</span> <span class="n">data</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">drive</span><span class="o">.</span> <span class="n">Each</span> <span class="n">one</span> <span class="ow">is</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">respective</span> <span class="n">TPDO</span> <span class="n">channel</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">stDS402DriveStatus</span>              <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">ST_DS402DriveStatus</span><span class="p">;</span>
    <span class="n">nModeOfOperationDisplay</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">SINT</span><span class="p">;</span>
    <span class="o">//</span><span class="n">nActualPosition</span>               <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">CSP</span> <span class="n">drive</span> <span class="n">mode</span><span class="o">*</span><span class="p">)</span>
    <span class="n">nFollowingError</span>                 <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Global</span> <span class="n">variables</span> <span class="k">for</span> <span class="n">the</span> <span class="n">RPDO</span> <span class="n">data</span> <span class="n">to</span> <span class="n">the</span> <span class="n">drive</span><span class="o">.</span> <span class="n">Each</span> <span class="n">one</span> <span class="ow">is</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">respective</span> <span class="n">RPDO</span> <span class="n">channel</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">Task</span> <span class="s1">&#39;Control Word&#39;</span>
    <span class="n">nDS402DriveControl</span>              <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Connected</span> <span class="n">to</span> <span class="n">NC</span> <span class="n">task</span> <span class="n">Ctrl</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">Ctrl</span> <span class="mi">2</span>
    <span class="n">nDS402DriveControlNC</span>    <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nTargetPosition</span>                 <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nModeOfOperation</span>                <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">SINT</span><span class="p">;</span>
    <span class="n">nModeOfOperationNC</span>              <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">SINT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Global</span> <span class="n">variables</span> <span class="k">for</span> <span class="n">the</span> <span class="n">RPDO</span> <span class="n">data</span> <span class="n">to</span> <span class="n">the</span> <span class="n">drive</span><span class="o">.</span> <span class="n">Each</span> <span class="n">one</span> <span class="ow">is</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">respective</span> <span class="n">RPDO</span> <span class="n">channel</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">nProfilVelocity</span>                 <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nProfilAcceleration</span>             <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nProfilDecceleration</span>    <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nVelocityActualValue</span>    <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Global</span> <span class="n">variables</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TPDO</span> <span class="n">data</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">drive</span><span class="o">.</span> <span class="n">Each</span> <span class="n">one</span> <span class="ow">is</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">respective</span> <span class="n">TPDO</span> <span class="n">channel</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">nScantargetPosition</span>             <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="n">uScantargetVelocity</span>             <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">ULINT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Port</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">EtherCAT</span> <span class="n">Slave</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">nSlaveAddr</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-ds402drivestatus">ST_DS402DriveStatus</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-ds402drivestatus">
<h2>ST_DS402DriveStatus<a class="headerlink" href="#st-ds402drivestatus" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_DS402DriveStatus</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">ReadyToSwitchOn</span>                 <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">0</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">SwitchedOn</span>                              <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">1</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">OperationEnabled</span>                <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">2</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">Fault</span>                                   <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">3</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">VoltageEnabled</span>                  <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">4</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">QuickStopActive</span>                 <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">5</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">SwitchOnDisabled</span>                <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">6</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">WarningCondition</span>                <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">7</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">TrajectoryAborted</span>               <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">8</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">RemoteCANopenControl</span>    <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">9</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">TargetReached</span>                   <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">10</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">InternalLimitActive</span>             <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">11</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">Bit12_OpModeSpecific</span>    <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">12</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">Bit13_OpModeSpecific</span>    <span class="p">:</span> <span class="n">BIT</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">13</span> <span class="o">*</span><span class="p">)</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-el5042-status">
<h2>ST_EL5042_Status<a class="headerlink" href="#st-el5042-status" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_EL5042_Status</span> <span class="p">:</span>
<span class="n">STRUCT</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-errorsystem">
<h2>ST_ErrorSystem<a class="headerlink" href="#st-errorsystem" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_ErrorSystem</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">//</span><span class="n">Array</span> <span class="n">of</span> <span class="n">error</span> <span class="n">data</span><span class="o">.</span> <span class="n">Size</span> <span class="o">=</span> <span class="n">cSizeOfErrorData</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">GVL</span>
    <span class="n">aErrorData</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="n">OF</span> <span class="n">DUT_TerminalError</span><span class="p">;</span>
    <span class="n">lNextErrorID</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>                                      <span class="o">//</span><span class="n">ErrorID</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">error</span> <span class="n">entry</span>
    <span class="n">nNoErrors</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                                                       <span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">errors</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">list</span>
    <span class="n">nNoOverflows</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>                                        <span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">overflows</span><span class="o">.</span> <span class="n">How</span> <span class="n">many</span> <span class="n">error</span> <span class="n">entries</span> <span class="n">have</span> <span class="n">been</span> <span class="n">lost</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-terminalerror">DUT_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#gvl">GVL</a></p></li>
<li><p><a class="reference internal" href="#gvl-errorsystem">GVL_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-motionepicsinterface">
<h2>ST_MotionEpicsInterface<a class="headerlink" href="#st-motionepicsinterface" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_MotionEpicsInterface</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">the</span> <span class="n">EPICS</span> <span class="n">interface</span> <span class="n">to</span> <span class="n">moving</span> <span class="n">a</span> <span class="n">motor</span> <span class="ow">in</span> <span class="n">TwinCAT</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">Name</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="n">log</span> <span class="n">messages</span><span class="p">,</span> <span class="n">fast</span> <span class="n">faults</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span>
    <span class="n">sName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">gantry</span> <span class="n">difference</span> <span class="n">tolerance</span>
    <span class="n">nGantryTol</span><span class="p">:</span> <span class="n">LINT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">count</span> <span class="n">at</span> <span class="n">which</span> <span class="n">this</span> <span class="n">axis</span> <span class="ow">is</span> <span class="n">aligned</span> <span class="k">with</span> <span class="n">other</span> <span class="n">axis</span>
    <span class="n">nEncRef</span><span class="p">:</span> <span class="n">ULINT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Commands</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">request</span> <span class="n">enables</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">errors</span> <span class="ow">and</span> <span class="n">other</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bReset</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">errors</span>
    <span class="s1">&#39;}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">start</span> <span class="ow">or</span> <span class="n">stop</span> <span class="n">a</span> <span class="n">move</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Command</span> <span class="n">Args</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">what</span> <span class="n">kind</span> <span class="n">of</span> <span class="n">move</span> <span class="n">to</span> <span class="n">do</span>
    <span class="n">nCommand</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="k">pass</span> <span class="n">additional</span> <span class="n">data</span> <span class="n">to</span> <span class="n">some</span> <span class="n">commands</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">a</span> <span class="n">destination</span> <span class="k">for</span> <span class="n">the</span> <span class="n">move</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">a</span> <span class="n">move</span> <span class="n">velocity</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">a</span> <span class="n">move</span> <span class="n">acceleration</span>
    <span class="n">fAcceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">a</span> <span class="n">move</span> <span class="n">deceleration</span>
    <span class="n">fDeceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">a</span> <span class="n">home</span> <span class="n">position</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">fHomePosition</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">home</span> <span class="n">position</span>
    <span class="s1">&#39;}</span>
    <span class="n">fHomePosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Info</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Unique</span> <span class="n">ID</span> <span class="n">assigned</span> <span class="n">to</span> <span class="n">each</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">NC</span>
    <span class="n">nMotionAxisID</span><span class="p">:</span> <span class="n">UDINT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Returns</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">a</span> <span class="n">command</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;ve done a command and it has finished</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">been</span> <span class="n">homed</span><span class="p">,</span> <span class="ow">or</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">need</span> <span class="n">to</span> <span class="n">be</span> <span class="n">homed</span>
    <span class="n">bHomed</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re in an error state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bError</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">error</span> <span class="n">state</span>
        <span class="n">update</span><span class="p">:</span> <span class="mi">100</span><span class="n">Hz</span> <span class="n">notify</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span> <span class="k">if</span> <span class="n">nonzero</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">nErrorId</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Error</span> <span class="n">code</span> <span class="k">if</span> <span class="n">nonzero</span>
        <span class="n">update</span><span class="p">:</span> <span class="mi">100</span><span class="n">Hz</span> <span class="n">notify</span>
    <span class="s1">&#39;}</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Message</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">the</span> <span class="n">error</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">sErrorMessage</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Message</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">the</span> <span class="n">error</span> <span class="n">state</span>
        <span class="n">update</span><span class="p">:</span> <span class="mi">100</span><span class="n">Hz</span> <span class="n">notify</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Misc</span> <span class="n">axis</span> <span class="n">status</span> <span class="n">information</span> <span class="k">for</span> <span class="n">the</span> <span class="n">IOC</span>
    <span class="n">stAxisStatus</span><span class="p">:</span> <span class="n">ST_AxisStatus</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-motionpneumaticactuator">
<h2>ST_MotionPneumaticActuator<a class="headerlink" href="#st-motionpneumaticactuator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ST_MotionPneumaticActuator</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">the</span> <span class="n">EPICS</span> <span class="n">interface</span> <span class="n">to</span> <span class="n">actuating</span> <span class="n">a</span> <span class="n">pneumatic</span> <span class="n">stage</span>
<span class="n">STRUCT</span>
     <span class="p">(</span><span class="o">*</span> <span class="n">Hardware</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span><span class="n">Readbacks</span>
    <span class="o">//</span><span class="n">Limit</span> <span class="n">Switch</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bInLimitSwitch</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">IN</span> <span class="n">limit</span> <span class="ow">is</span> <span class="n">reached</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_bInLimitSwitch</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bOutLimitSwitch</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">OUT</span> <span class="n">limit</span> <span class="ow">is</span> <span class="n">reached</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_bOutLimitSwitch</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Controls</span>
    <span class="o">//</span><span class="n">Digital</span> <span class="n">outputs</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">bRetractDigitalOutput</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FALSE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">TRUE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">Retract</span> <span class="n">digital</span> <span class="n">output</span> <span class="ow">is</span> <span class="n">active</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_bRetract</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">bInsertDigitalOutput</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FALSE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">TRUE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">Insert</span> <span class="n">digital</span> <span class="n">output</span> <span class="ow">is</span> <span class="n">active</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_bInsert</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>


    <span class="o">//</span><span class="n">Logic</span> <span class="ow">and</span> <span class="n">supervisory</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">bInterlockOK</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">actuator</span> <span class="n">has</span> <span class="n">permission</span> <span class="n">to</span> <span class="n">move</span> <span class="ow">in</span> <span class="n">either</span> <span class="n">direction</span>
    <span class="s1">&#39;}</span>
    <span class="n">bILK_OK</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">bInsertEnable</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">actuator</span> <span class="n">had</span> <span class="n">permission</span> <span class="n">to</span> <span class="n">be</span> <span class="n">retracted</span>
    <span class="s1">&#39;}</span>
    <span class="n">bInsertOK</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">bRetractEnable</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">actuator</span> <span class="n">had</span> <span class="n">permission</span> <span class="n">to</span> <span class="n">be</span> <span class="n">inserted</span>
    <span class="s1">&#39;}</span>
    <span class="n">bRetractOK</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Commands</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="kn">from</span><span class="w"> </span><span class="nn">Epics</span> <span class="n">to</span> <span class="n">comand</span> <span class="n">the</span> <span class="n">actuator</span> <span class="n">to</span>  <span class="n">move</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">CMD</span><span class="p">:</span><span class="n">IN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">by</span> <span class="n">EPICS</span> <span class="ow">and</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">request</span> <span class="n">Insert</span> <span class="n">motion</span>
    <span class="s1">&#39;}</span>
    <span class="n">bInsert_SW</span>        <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">CMD</span><span class="p">:</span><span class="n">OUT</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">by</span> <span class="n">EPICS</span> <span class="ow">and</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">request</span> <span class="n">retract</span> <span class="n">motion</span>
    <span class="s1">&#39;}</span>
    <span class="n">bRetract_SW</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Returns</span><span class="o">*</span><span class="p">)</span>
     <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">a</span> <span class="n">command</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">bBusy</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FALSE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">TRUE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">a</span> <span class="n">command</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;ve done a command and it has finished</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">bDone</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FALSE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">TRUE</span>
      <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">command</span> <span class="n">finished</span> <span class="n">successfully</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">bReset</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">errors</span>
    <span class="s1">&#39;}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re in an error state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bError</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FALSE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">TRUE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re in an error state</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

     <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span> <span class="k">if</span> <span class="n">nonzero</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">nErrorId</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Error</span> <span class="n">code</span> <span class="k">if</span> <span class="n">nonzero</span>
    <span class="s1">&#39;}</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Message</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">the</span> <span class="n">error</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">sErrorMessage</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Message</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">the</span> <span class="n">error</span> <span class="n">state</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">nPositionState</span> <span class="p">;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">mbbi</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZRST</span> <span class="n">RETRACTED</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONST</span> <span class="n">INSERTED</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">TWST</span> <span class="n">MOVING</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">THST</span> <span class="n">INVALID</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Pneumatic</span> <span class="n">actuator</span> <span class="n">position</span>
    <span class="s1">&#39;}</span>

    <span class="n">eState</span>    <span class="p">:</span>    <span class="n">E_PnuematicActuatorPositionState</span> <span class="o">:=</span> <span class="n">E_PnuematicActuatorPositionState</span><span class="o">.</span><span class="n">INVALID</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-pnuematicactuatorpositionstate">E_PnuematicActuatorPositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-motionstage">
<h2>ST_MotionStage<a class="headerlink" href="#st-motionstage" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>TYPE ST_MotionStage :
    // Defines the EPICS interface to moving a motor in TwinCAT
STRUCT
    (* Hardware *)

    // PLC Axis Reference
    Axis: AXIS_REF;
    // NC Forward Limit Switch: TRUE if ok to move
    bLimitForwardEnable AT %I*: BOOL;
    // NC Backward Limit Switch: TRUE if ok to move
    bLimitBackwardEnable AT %I*: BOOL;
    // NO Home Switch: TRUE if at home
    bHome AT %I*: BOOL;
    // NC Brake Output: TRUE to release brake
    bBrakeRelease AT %Q*: BOOL;
    // NC STO Input: TRUE if ok to move
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:bHardwareEnable
        io: i
        field: ZNAM FALSE
        field: ONAM TRUE
        field: DESC TRUE if STO not hit
    &#39;}
    bHardwareEnable AT %I*: BOOL;

    // Raw encoder IO for ULINT (Biss-C)
    nRawEncoderULINT AT %I*: ULINT;
    // Raw encoder IO for UINT (Relative Encoders)
    nRawEncoderUINT AT %I*: UINT;
    // Raw encoder IO for INT (LVDT)
    nRawEncoderINT AT %I*: INT;
    // Raw encoder IO for INT (EL5072 LVDT)
    nRawEncoderDINT AT %I*: DINT;

    (* Psuedo-hardware *)

    // Forward enable EPS summary
    bAllForwardEnable: BOOL:=FALSE;
    // Backward enable EPS summary
    bAllBackwardEnable: BOOL:=FALSE;
    // Enable EPS summary encapsulating emergency stop button and any additional motion preventive hardware
    bAllEnable: BOOL:=FALSE;
    // Forward virtual gantry limit switch
    bGantryForwardEnable: BOOL:=FALSE;
    // Backward virtual gantry limit switch
    bGantryBackwardEnable: BOOL:=FALSE;
    // Encoder count summary, if linked above
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:nEncoderCount
        io: i
        field: DESC Count from encoder hardware
    &#39;}
    nEncoderCount: UDINT;
    // Forward Enable EPS struct
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:stEPSF
        io: i
        field: DESC Forward Enable Interlocks
    &#39;}
    stEPSForwardEnable: DUT_EPS;
    // Backward Enable EPS struct
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:stEPSB
        io: i
        field: DESC Backward Enable Interlocks
    &#39;}
    stEPSBackwardEnable: DUT_EPS;
    // Power Enable EPS struct
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:stEPSP
        io: i
        field: DESC Power Interlocks
    &#39;}
    stEPSPowerEnable: DUT_EPS;

    (* Settings *)
    // Name to use for log messages, fast faults, etc.
    sName: STRING;
    // If TRUE, we want to enable the motor independently of PMPS or other safety systems.
    bPowerSelf: BOOL:=FALSE;
    // Determines when we automatically enable the motor
    nEnableMode: E_StageEnableMode:=E_StageEnableMode.DURING_MOTION;
    // Determines when we automatically disengage the brake
    nBrakeMode: E_StageBrakeMode:=E_StageBrakeMode.IF_ENABLED;
    // Determines our encoder homing strategy
    nHomingMode: E_EpicsHomeCmd:=E_EpicsHomeCmd.NONE;
    // Set true to activate gantry EPS
    bGantryAxis: BOOL:=FALSE;

    // Set to gantry difference tolerance
    nGantryTol: LINT:=0;

    // Encoder count at which this axis is aligned with other axis
    nEncRef: ULINT:=0;

    (* Commands *)
    // Used internally to request enables
    bEnable: BOOL;
    // Used internally to reset errors and other state
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:bReset
        io: io
        field: ZNAM FALSE
        field: ONAM TRUE
        field: DESC Used internally to reset errors
    &#39;}
    bReset: BOOL;
    // Used internally and by the IOC to start or stop a move
    bExecute: BOOL;
    // Used by the IOC to disable an axis
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:bUserEnable
        io: io
        field: ZNAM DISABLE
        field: ONAM ENABLE
        field: DESC Used to disable power entirely for an axis
    &#39;}
    bUserEnable: BOOL := 1;

    (* Shortcut Commands *)
    // Start a move to fPosition with fVelocity
    bMoveCmd: BOOL;
    // Start the homing routine
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:bHomeCmd
        io: io
        field: DESC Start the homing routine
    &#39;}
    bHomeCmd: BOOL;

    (* Command Args *)
    // Used internally and by the IOC to pick what kind of move to do
    nCommand: INT;
    // Used internally and by the IOC to pass additional data to some commands
    nCmdData: INT;
    // Used internally and by the IOC to pick a destination for the move
    fPosition: LREAL;
    // Used internally and by the IOC to pick a move velocity
    fVelocity: LREAL;
    // Used internally and by the IOC to pick a move acceleration
    fAcceleration: LREAL;
    // Used internally and by the IOC to pick a move deceleration
    fDeceleration: LREAL;
    // Used internally and by the IOC to pick a home position
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:fHomePosition
        io: io
        field: DESC Used internally and by the IOC to pick home position
    &#39;}
    fHomePosition: LREAL;

    (* Info *)
    // Unique ID assigned to each axis in the NC
    nMotionAxisID: UDINT:=0;

    (* Returns *)
    // TRUE if done enabling
    bEnableDone: BOOL;
    // TRUE if in the middle of a command
    bBusy: BOOL;
    // TRUE if we&#39;ve done a command and it has finished
    bDone: BOOL;
    // TRUE if the motor has been homed, or does not need to be homed
    bHomed: BOOL;
    // TRUE if we have safety permission to move
    bSafetyReady: BOOL;
    // TRUE if we&#39;re in an error state
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:bError
        io: i
        field: ZNAM FALSE
        field: ONAM TRUE
        field: DESC TRUE if we are in an error state
        update: 100Hz notify
    &#39;}
    bError: BOOL;
    // Error code if nonzero
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:nErrorId
        io: i
        field: DESC Error code if nonzero
        update: 100Hz notify
    &#39;}
    nErrorId: UDINT;
    // Message to identify the error state
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:sErrorMessage
        io: i
        field: DESC Message to identify the error state
        update: 100Hz notify
    &#39;}
    sErrorMessage: STRING;
    // Internal hook for custom error messages
    sCustomErrorMessage: STRING;
    // MC_ReadParameterSet Output
    stAxisParameters: ST_AxisParameterSet;
    // NC parameters that are exposed with pytmc pragmas
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:AxisPar
        io: i
        field: DESC Axis configuration parameters in the numerical controller.
    &#39;}
    stAxisParametersExposed: ST_AxisParameterSetExposed;
    // True if we&#39;ve updated stAxisParameters at least once
    bAxisParamsInit: BOOL;

    // Misc axis status information for the IOC
    stAxisStatus: DUT_AxisStatus_v0_01;

    (* Other status information for users of the IOC *)
    // Position lag difference
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:fPosDiff
        io: i
        field: DESC Position lag difference
    &#39;}
    fPosDiff: LREAL;

    (* Backlash compensation*)
    // Enabled axis backlash compensation
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:bBacklashEn
        io: io
        field: ZNAM FALSE
        field: ONAM TRUE
        field: DESC Enable Backlash compensation
    &#39;}
    bUserBacklashEn: BOOL;

    // backlash compensation status
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:bBacklasStatus
        io: i
        field: ZNAM DISABLED
        field: ONAM ENABLED
        field: DESC Backlash compensation status
    &#39;}
    bBacklashStatus: BOOL;

    // Backlash compensation value
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:fBacklash
        io: io
        field: DESC Backlash compensation
    &#39;}
    fBacklash: LREAL;

    // Current Backlash compensation value ?
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:fCurrentBacklash
        io: i
        field: DESC Currently applied compensation
    &#39;}
    fCurrentBacklash: LREAL;
END_STRUCT
END_TYPE
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-axisstatus-v0-01">DUT_AxisStatus_v0_01</a></p></li>
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#e-stagebrakemode">E_StageBrakeMode</a></p></li>
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#st-axisparametersetexposed">ST_AxisParameterSetExposed</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-positionstate">
<h2>ST_PositionState<a class="headerlink" href="#st-positionstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PositionState</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">settings</span> <span class="ow">and</span> <span class="n">current</span> <span class="n">safety</span> <span class="n">status</span> <span class="k">for</span> <span class="n">moves</span> <span class="n">to</span> <span class="n">specific</span> <span class="n">positions</span> <span class="k">for</span> <span class="n">an</span> <span class="n">axis</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">Name</span> <span class="k">as</span> <span class="n">queried</span> <span class="n">via</span> <span class="n">the</span> <span class="n">NAME</span> <span class="n">PV</span> <span class="ow">in</span> <span class="n">EPICS</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">NAME</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Name</span> <span class="n">of</span> <span class="n">this</span> <span class="n">position</span> <span class="n">state</span>
    <span class="s1">&#39;}</span>
    <span class="n">sName</span><span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Position</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">this</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SETPOINT</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Axis</span> <span class="n">position</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">this</span> <span class="n">state</span>
    <span class="s1">&#39;}</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ENCODER</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Encoder</span> <span class="n">count</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">this</span> <span class="n">state</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncoderCount</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Maximum</span> <span class="n">allowable</span> <span class="n">deviation</span> <span class="kn">from</span><span class="w"> </span><span class="nn">fPosition</span> <span class="k">while</span> <span class="n">at</span> <span class="n">the</span> <span class="n">state</span>
    <span class="n">fDelta</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Speed</span> <span class="n">at</span> <span class="n">which</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span> <span class="n">this</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">VELO</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Speed</span> <span class="n">at</span> <span class="n">which</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span> <span class="n">this</span> <span class="n">state</span>
    <span class="s1">&#39;}</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="o">//</span> <span class="p">(</span><span class="n">optional</span><span class="p">)</span> <span class="n">Acceleration</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="n">moves</span> <span class="n">to</span> <span class="n">this</span> <span class="n">state</span>
    <span class="n">fAccel</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="o">//</span> <span class="p">(</span><span class="n">optional</span><span class="p">)</span> <span class="n">Deceleration</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="n">moves</span> <span class="n">to</span> <span class="n">this</span> <span class="n">state</span>
    <span class="n">fDecel</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Safety</span> <span class="n">parameter</span><span class="o">.</span> <span class="n">This</span> <span class="n">must</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">by</span> <span class="n">the</span> <span class="n">PLC</span> <span class="n">program</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">moves</span> <span class="n">to</span> <span class="n">this</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="n">change</span> <span class="k">as</span> <span class="n">conditions</span> <span class="n">change</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MOVE_OK</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">move</span> <span class="n">would</span> <span class="n">be</span> <span class="n">safe</span>
    <span class="s1">&#39;}</span>
    <span class="n">bMoveOk</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Signifies</span> <span class="n">to</span> <span class="n">FB_PositionStateLock</span> <span class="n">that</span> <span class="n">this</span> <span class="n">state</span> <span class="n">should</span> <span class="n">be</span> <span class="n">immutable</span>
    <span class="n">bLocked</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">you</span> <span class="n">make</span> <span class="n">your</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">defaults</span> <span class="n">to</span> <span class="n">FALSE</span> <span class="n">so</span> <span class="n">that</span> <span class="n">uninitialized</span> <span class="n">states</span> <span class="n">can</span> <span class="n">never</span> <span class="n">be</span> <span class="n">moved</span> <span class="n">to</span>
    <span class="n">bValid</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span> <span class="n">the</span> <span class="n">raw</span> <span class="n">encoder</span> <span class="n">counts</span> <span class="n">to</span> <span class="n">define</span> <span class="n">the</span> <span class="n">state</span>
    <span class="n">bUseRawCounts</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">by</span> <span class="n">FB_PositionStateInternal</span> <span class="n">when</span> <span class="n">called</span>
    <span class="n">bUpdated</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">We</span> <span class="n">give</span> <span class="n">this</span> <span class="n">a</span> <span class="n">state</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">load</span> <span class="n">parameters</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">pmps</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">stPMPS</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatelock">FB_PositionStateLock</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-renishawabsenc">
<h2>ST_RenishawAbsEnc<a class="headerlink" href="#st-renishawabsenc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Renishaw</span> <span class="n">BiSS</span><span class="o">-</span><span class="n">C</span> <span class="n">absolute</span> <span class="n">encoder</span> <span class="n">used</span> <span class="k">with</span> <span class="n">an</span> <span class="n">EL5042</span>
<span class="n">TYPE</span> <span class="n">ST_RenishawAbsEnc</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">Count</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Connect</span> <span class="n">to</span> <span class="n">encoder</span> <span class="s2">&quot;Position&quot;</span> <span class="nb">input</span>
    <span class="n">Status</span><span class="p">:</span> <span class="n">ST_EL5042_Status</span><span class="p">;</span> <span class="o">//</span> <span class="n">Status</span> <span class="n">struct</span> <span class="n">placeholder</span>
    <span class="n">Ref</span><span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Encoder</span> <span class="n">zero</span> <span class="n">position</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">aligned</span> <span class="n">position</span> <span class="k">with</span> <span class="n">gantries</span><span class="p">)</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#el5042">EL5042</a></p></li>
<li><p><a class="reference internal" href="#st-el5042-status">ST_EL5042_Status</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-stateepicstoplc">
<h2>ST_StateEpicsToPlc<a class="headerlink" href="#st-stateepicstoplc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_StateEpicsToPlc</span> <span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">data</span> <span class="n">structure</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">EPICS</span> <span class="nb">input</span> <span class="n">connection</span> <span class="n">points</span> <span class="k">for</span> <span class="n">the</span> <span class="n">state</span> <span class="n">movers</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">struct</span> <span class="n">flows</span> <span class="kn">from</span><span class="w"> </span><span class="nn">EPICS</span> <span class="n">to</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>

    <span class="n">It</span> <span class="n">includes</span> <span class="n">everything</span> <span class="k">except</span> <span class="n">the</span> <span class="n">SET</span> <span class="n">PV</span><span class="p">,</span> <span class="n">which</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">included</span> <span class="n">here</span>
    <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">sourced</span> <span class="kn">from</span><span class="w"> </span><span class="nn">enum</span> <span class="n">values</span> <span class="n">unique</span> <span class="n">to</span> <span class="n">the</span> <span class="n">application</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">PVs</span><span class="p">,</span> <span class="n">which</span> <span class="n">are</span>
    <span class="n">gathered</span> <span class="ow">in</span> <span class="n">their</span> <span class="n">own</span> <span class="n">data</span> <span class="nb">type</span><span class="p">,</span> <span class="n">ST_StatePMPSEpicsToPlc</span><span class="o">.</span> <span class="n">That</span> <span class="n">actually</span> <span class="n">means</span> <span class="n">that</span> <span class="n">this</span> <span class="n">only</span>
    <span class="n">holds</span> <span class="n">the</span> <span class="n">RESET</span> <span class="n">PV</span><span class="p">,</span> <span class="k">for</span> <span class="n">now</span><span class="o">.</span>

    <span class="n">nSetValue</span> <span class="n">here</span> <span class="ow">is</span> <span class="n">actively</span> <span class="n">used</span> <span class="n">by</span> <span class="n">state</span> <span class="n">blocks</span> <span class="n">even</span> <span class="n">though</span> <span class="n">it</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">exposed</span>
    <span class="n">directly</span> <span class="n">to</span> <span class="n">EPICS</span><span class="o">.</span> <span class="n">You</span> <span class="n">should</span> <span class="n">avoid</span> <span class="n">manually</span> <span class="n">modifying</span> <span class="n">it</span> <span class="ow">or</span> <span class="k">else</span>
    <span class="n">you</span> <span class="n">may</span> <span class="n">interfere</span> <span class="k">with</span> <span class="n">normal</span> <span class="n">operations</span> <span class="n">of</span> <span class="n">the</span> <span class="n">state</span> <span class="n">function</span> <span class="n">blocks</span><span class="o">.</span>

    <span class="n">For</span> <span class="n">including</span> <span class="n">your</span> <span class="n">own</span> <span class="n">ENUM</span> <span class="nb">input</span><span class="p">,</span> <span class="n">you</span> <span class="n">should</span> <span class="n">pytmc</span> <span class="n">pragma</span> <span class="n">the</span> <span class="n">PV</span> <span class="n">name</span> <span class="n">to</span> <span class="n">end</span> <span class="ow">in</span> <span class="s2">&quot;SET&quot;</span><span class="p">,</span>
    <span class="ow">and</span> <span class="n">match</span> <span class="n">the</span> <span class="n">prefix</span> <span class="n">of</span> <span class="n">this</span> <span class="n">FB</span><span class="s1">&#39;s &quot;RESET&quot; PV. Then, you can include your enum</span>
    <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="n">IN_OUT</span> <span class="n">var</span> <span class="ow">and</span> <span class="n">let</span> <span class="n">the</span> <span class="n">EPICS</span> <span class="n">IOC</span> <span class="n">handle</span> <span class="n">it</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">For</span> <span class="n">internal</span> <span class="n">use</span> <span class="n">only</span><span class="o">.</span> <span class="n">This</span> <span class="n">holds</span> <span class="n">new</span> <span class="n">goal</span> <span class="n">positions</span> <span class="k">as</span> <span class="n">an</span> <span class="n">integer</span><span class="p">,</span> <span class="k">else</span> <span class="n">it</span> <span class="ow">is</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">new</span> <span class="n">state</span> <span class="n">move</span> <span class="n">request</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">written</span> <span class="n">to</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">user</span><span class="s1">&#39;s input enum.</span>
    <span class="n">nSetValue</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">acknowledge</span> <span class="ow">and</span> <span class="n">clear</span> <span class="n">an</span> <span class="n">error</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RESET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-statepmpsepicstoplc">ST_StatePMPSEpicsToPlc</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-stateplctoepics">
<h2>ST_StatePlcToEpics<a class="headerlink" href="#st-stateplctoepics" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_StatePlcToEpics</span> <span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">data</span> <span class="n">structure</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">EPICS</span> <span class="n">connection</span> <span class="n">points</span> <span class="k">for</span> <span class="n">the</span> <span class="n">state</span> <span class="n">movers</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">struct</span> <span class="n">flows</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">PLC</span> <span class="n">to</span> <span class="n">EPICS</span><span class="o">.</span>

    <span class="n">It</span> <span class="n">includes</span> <span class="n">everything</span> <span class="k">except</span> <span class="n">the</span> <span class="n">GET</span> <span class="n">PV</span><span class="p">,</span> <span class="n">which</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">included</span> <span class="n">here</span>
    <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">sourced</span> <span class="kn">from</span><span class="w"> </span><span class="nn">enum</span> <span class="n">values</span> <span class="n">unique</span> <span class="n">to</span> <span class="n">the</span> <span class="n">application</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">PVs</span><span class="p">,</span> <span class="n">which</span> <span class="n">are</span>
    <span class="n">gathered</span> <span class="ow">in</span> <span class="n">their</span> <span class="n">own</span> <span class="n">data</span> <span class="nb">type</span><span class="p">,</span> <span class="n">ST_StatePMPSPlcToEpics</span><span class="o">.</span>

    <span class="n">nGetValue</span> <span class="n">here</span> <span class="ow">is</span> <span class="n">actively</span> <span class="n">used</span> <span class="n">by</span> <span class="n">state</span> <span class="n">blocks</span> <span class="n">even</span> <span class="n">though</span> <span class="n">it</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">exposed</span> <span class="n">directly</span>
    <span class="n">to</span> <span class="n">EPICS</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">safe</span> <span class="n">to</span> <span class="n">read</span> <span class="n">this</span> <span class="n">value</span><span class="p">,</span> <span class="n">but</span> <span class="n">you</span> <span class="n">should</span> <span class="n">avoid</span> <span class="n">modifying</span> <span class="n">it</span><span class="p">,</span> <span class="n">which</span> <span class="n">may</span>
    <span class="n">interfere</span> <span class="k">with</span> <span class="n">normal</span> <span class="n">operations</span> <span class="n">of</span> <span class="n">the</span> <span class="n">state</span> <span class="n">function</span> <span class="n">blocks</span><span class="o">.</span>

    <span class="n">For</span> <span class="n">including</span> <span class="n">your</span> <span class="n">own</span> <span class="n">ENUM</span> <span class="nb">input</span><span class="p">,</span> <span class="n">you</span> <span class="n">should</span> <span class="n">pytmc</span> <span class="n">pragma</span> <span class="n">the</span> <span class="n">PV</span> <span class="n">name</span> <span class="n">to</span> <span class="n">end</span> <span class="ow">in</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
    <span class="ow">and</span> <span class="n">match</span> <span class="n">the</span> <span class="n">prefix</span> <span class="n">of</span> <span class="n">this</span> <span class="n">FB</span><span class="s1">&#39;s &quot;DONE&quot; PV. Then, you can include your enum</span>
    <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumGet</span> <span class="n">IN_OUT</span> <span class="n">var</span> <span class="ow">and</span> <span class="n">let</span> <span class="n">the</span> <span class="n">EPICS</span> <span class="n">IOC</span> <span class="n">handle</span> <span class="n">it</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">For</span> <span class="n">internal</span> <span class="n">use</span> <span class="n">only</span><span class="o">.</span> <span class="n">This</span> <span class="n">holds</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">index</span> <span class="k">as</span> <span class="n">an</span> <span class="n">integer</span><span class="p">,</span> <span class="k">else</span> <span class="n">it</span> <span class="ow">is</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="n">changing</span> <span class="n">states</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">at</span> <span class="nb">any</span> <span class="n">particular</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">nGetValue</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">active</span> <span class="n">state</span> <span class="n">move</span> <span class="ow">and</span> <span class="n">FALSE</span> <span class="n">otherwise</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BUSY</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="n">TRUE</span> <span class="n">after</span> <span class="n">a</span> <span class="n">move</span> <span class="n">completes</span> <span class="ow">and</span> <span class="n">FALSE</span> <span class="n">otherwise</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DONE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">most</span> <span class="n">recent</span> <span class="n">move</span> <span class="n">had</span> <span class="n">an</span> <span class="n">error</span> <span class="ow">and</span> <span class="n">FALSE</span> <span class="n">otherwise</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">an</span> <span class="n">NC</span> <span class="n">error</span> <span class="n">code</span> <span class="n">during</span> <span class="n">an</span> <span class="n">error</span> <span class="k">if</span> <span class="n">one</span> <span class="n">exists</span> <span class="ow">or</span> <span class="n">left</span> <span class="n">at</span> <span class="mi">0</span> <span class="n">otherwise</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRID</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nErrorID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">an</span> <span class="n">appropriate</span> <span class="n">error</span> <span class="n">message</span> <span class="n">during</span> <span class="n">an</span> <span class="n">error</span> <span class="k">if</span> <span class="n">one</span> <span class="n">exists</span> <span class="ow">or</span> <span class="n">left</span> <span class="k">as</span> <span class="n">an</span> <span class="n">empty</span> <span class="n">string</span> <span class="n">otherwise</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRMSG</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMsg</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-statepmpsplctoepics">ST_StatePMPSPlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-statepmpsepicstoplc">
<h2>ST_StatePMPSEpicsToPlc<a class="headerlink" href="#st-statepmpsepicstoplc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_StatePMPSEpicsToPlc</span> <span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">data</span> <span class="n">structure</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">connection</span> <span class="n">points</span> <span class="k">for</span> <span class="n">the</span> <span class="n">state</span> <span class="n">movers</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">struct</span> <span class="n">flows</span> <span class="kn">from</span><span class="w"> </span><span class="nn">EPICS</span> <span class="n">to</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">User</span> <span class="n">setting</span><span class="p">:</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">arbiter</span><span class="p">,</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">it</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PMPS</span><span class="p">:</span><span class="n">ARB</span><span class="p">:</span><span class="n">ENABLE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">bArbiterEnabled</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">User</span> <span class="n">setting</span><span class="p">:</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">maintenance</span> <span class="n">mode</span> <span class="p">(</span><span class="n">Fast</span> <span class="n">fault</span><span class="p">,</span> <span class="n">free</span> <span class="n">motion</span><span class="p">),</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">it</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PMPS</span><span class="p">:</span><span class="n">MAINT</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">bMaintMode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-statepmpsplctoepics">
<h2>ST_StatePMPSPlcToEpics<a class="headerlink" href="#st-statepmpsplctoepics" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_StatePMPSPlcToEpics</span> <span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">data</span> <span class="n">structure</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">connection</span> <span class="n">points</span> <span class="k">for</span> <span class="n">the</span> <span class="n">state</span> <span class="n">movers</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">struct</span> <span class="n">flows</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">PLC</span> <span class="n">to</span> <span class="n">EPICS</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">database</span> <span class="n">entry</span> <span class="k">for</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">always</span> <span class="n">be</span> <span class="n">present</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PMPS</span><span class="p">:</span><span class="n">TRANS</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">stTransitionDb</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
</section>
<section id="gvls">
<h1>GVLs<a class="headerlink" href="#gvls" title="Link to this heading"></a></h1>
<section id="gvl">
<h2>GVL<a class="headerlink" href="#gvl" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span>
    <span class="n">nHomingError</span><span class="p">:</span><span class="n">UDINT</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#14D00;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-errorsystem">
<h2>GVL_ErrorSystem<a class="headerlink" href="#gvl-errorsystem" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="n">cSizeOfErrorData</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">128</span><span class="p">;</span>

<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="motion-gvl">
<h2>MOTION_GVL<a class="headerlink" href="#motion-gvl" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span>
    <span class="o">//</span> <span class="n">Global</span> <span class="n">file</span> <span class="n">reader</span> <span class="n">instance</span><span class="p">,</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">fbStandardPMPSDB</span>
    <span class="n">fbPmpsFileReader</span><span class="p">:</span> <span class="n">FB_JsonFileToJsonDoc</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="n">DB</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="o">//</span> <span class="n">Global</span> <span class="n">DB</span> <span class="n">handler</span><span class="p">,</span> <span class="n">Must</span> <span class="n">be</span> <span class="n">called</span> <span class="ow">in</span> <span class="n">PLC</span> <span class="n">project</span> <span class="n">to</span> <span class="n">use</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="k">for</span> <span class="n">a</span> <span class="n">motion</span> <span class="n">project</span>
    <span class="n">fbStandardPMPSDB</span><span class="p">:</span> <span class="n">FB_Standard_PMPSDB</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Debug</span><span class="p">,</span> <span class="n">records</span> <span class="n">the</span> <span class="n">highest</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">ND</span> <span class="n">states</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span> <span class="n">Can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">limit</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span> <span class="n">to</span> <span class="n">save</span> <span class="n">on</span> <span class="n">memory</span> <span class="n">usage</span> <span class="ow">and</span> <span class="n">PV</span> <span class="n">count</span><span class="o">.</span>
    <span class="n">nMaxStateMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Debug</span><span class="p">,</span> <span class="n">records</span> <span class="n">the</span> <span class="n">highest</span> <span class="n">state</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span> <span class="n">Can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">limit</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">to</span> <span class="n">save</span> <span class="n">on</span> <span class="n">memory</span> <span class="n">usage</span> <span class="ow">and</span> <span class="n">PV</span> <span class="n">count</span><span class="o">.</span>
    <span class="n">nMaxStates</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-standard-pmpsdb">FB_Standard_PMPSDB</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="motionconstants">
<h2>MotionConstants<a class="headerlink" href="#motionconstants" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Global</span> <span class="n">Configurable</span> <span class="n">Motion</span> <span class="n">Constants</span>

    <span class="n">These</span> <span class="n">are</span> <span class="n">reconfigurable</span> <span class="n">at</span> <span class="n">the</span> <span class="n">project</span> <span class="n">level</span><span class="o">.</span>
    <span class="n">When</span> <span class="n">reconfigured</span> <span class="n">they</span> <span class="n">are</span> <span class="nb">set</span> <span class="n">prior</span> <span class="n">to</span> <span class="n">compilation</span> <span class="ow">and</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">changed</span> <span class="n">at</span> <span class="n">runtime</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="p">(</span><span class="o">*</span>
    <span class="n">Arbitary</span> <span class="n">cap</span> <span class="n">on</span> <span class="n">multidimensional</span> <span class="n">states</span> <span class="n">to</span> <span class="n">simplify</span> <span class="n">statements</span> <span class="k">for</span> <span class="n">the</span> <span class="n">compiler</span><span class="o">.</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">reconfigurable</span> <span class="n">at</span> <span class="n">the</span> <span class="n">project</span> <span class="n">level</span> <span class="ow">and</span> <span class="n">should</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">highest</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="o">.</span>
    <span class="n">If</span> <span class="n">you</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">sure</span> <span class="n">how</span> <span class="n">many</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">used</span> <span class="n">per</span> <span class="n">state</span> <span class="n">block</span><span class="p">,</span> <span class="n">check</span> <span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">nMaxStateMotorCount</span>
    <span class="o">*</span><span class="p">)</span>
    <span class="n">MAX_STATE_MOTORS</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>
<section id="pous">
<h1>POUs<a class="headerlink" href="#pous" title="Link to this heading"></a></h1>
<section id="checkbounds">
<h2>CheckBounds<a class="headerlink" href="#checkbounds" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckBounds</span> <span class="p">:</span> <span class="n">DINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">index</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span>  <span class="n">index</span> <span class="o">&lt;</span> <span class="n">lower</span> <span class="n">THEN</span>
    <span class="n">CheckBounds</span> <span class="o">:=</span> <span class="n">lower</span><span class="p">;</span>
<span class="n">ELSIF</span>  <span class="n">index</span> <span class="o">&gt;</span> <span class="n">upper</span> <span class="n">THEN</span>
    <span class="n">CheckBounds</span> <span class="o">:=</span> <span class="n">upper</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckBounds</span> <span class="o">:=</span> <span class="n">index</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkdivdint">
<h2>CheckDivDInt<a class="headerlink" href="#checkdivdint" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckDivDInt</span> <span class="p">:</span> <span class="n">DINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">divisor</span><span class="p">:</span><span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">CheckDivDInt</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckDivDInt</span><span class="o">:=</span><span class="n">divisor</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkdivlint">
<h2>CheckDivLInt<a class="headerlink" href="#checkdivlint" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckDivLInt</span> <span class="p">:</span> <span class="n">LINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">divisor</span><span class="p">:</span><span class="n">LINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">CheckDivLInt</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckDivLInt</span><span class="o">:=</span><span class="n">divisor</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkdivlreal">
<h2>CheckDivLReal<a class="headerlink" href="#checkdivlreal" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckDivLReal</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">divisor</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">CheckDivLReal</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckDivLReal</span><span class="o">:=</span><span class="n">divisor</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkdivreal">
<h2>CheckDivReal<a class="headerlink" href="#checkdivreal" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckDivReal</span> <span class="p">:</span> <span class="n">REAL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">divisor</span><span class="p">:</span><span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">CheckDivReal</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckDivReal</span><span class="o">:=</span><span class="n">divisor</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="demo">
<h2>Demo<a class="headerlink" href="#demo" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">Demo</span>
<span class="n">VAR</span>

<span class="o">//</span>     <span class="n">fbMotionLogger</span> <span class="p">:</span> <span class="n">FB_MotionLogger</span><span class="p">;</span>
<span class="o">//</span>     <span class="o">//</span> <span class="n">Persistant</span> <span class="n">storage</span>
<span class="o">//</span>     <span class="n">fbPersistentDataStorage</span> <span class="p">:</span> <span class="n">FB_PersistentDataStorage</span><span class="p">;</span>
<span class="o">//</span>     <span class="n">M1</span> <span class="p">:</span> <span class="n">ST_MotionEpicsInterface</span><span class="p">;</span>
<span class="o">//</span>
<span class="o">//</span>     <span class="n">fbMotionStage</span> <span class="p">:</span> <span class="n">FB_MotionStageNC</span><span class="p">(</span>    <span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;NC&#39;</span><span class="p">,</span>
<span class="o">//</span>                                         <span class="n">stMotionEpicsItf</span> <span class="o">:=</span> <span class="n">M1</span><span class="p">,</span>
<span class="o">//</span>                                         <span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">NcAxis_GVL</span><span class="o">.</span><span class="n">NC</span><span class="p">,</span>
<span class="o">//</span>                                         <span class="n">iMotionLogger</span> <span class="o">:=</span> <span class="n">fbMotionLogger</span><span class="p">,</span>
<span class="o">//</span>                                         <span class="n">iPersistentDataStorage</span> <span class="o">:=</span> <span class="n">fbPersistentDataStorage</span>
<span class="o">//</span>                                     <span class="p">)</span> <span class="o">:=</span> <span class="p">(</span><span class="n">BrakeMode</span> <span class="o">:=</span> <span class="n">E_StageBrakeMode</span><span class="o">.</span><span class="n">IF_MOVING</span><span class="p">,</span> <span class="n">EnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">,</span> <span class="n">HomeMode</span><span class="o">:=</span><span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">AUTOZERO</span><span class="p">);</span>

<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">fbMotionLogger</span><span class="p">();</span>
<span class="o">//</span> <span class="n">fbPersistentDataStorage</span><span class="p">();</span>
<span class="o">//</span> <span class="n">fbMotionStage</span><span class="p">();</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-stageenablemode">ENUM_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#e-stagebrakemode">E_StageBrakeMode</a></p></li>
<li><p><a class="reference internal" href="#fb-motionlogger">FB_MotionLogger</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstagenc">FB_MotionStageNC</a></p></li>
<li><p><a class="reference internal" href="#fb-persistentdatastorage">FB_PersistentDataStorage</a></p></li>
<li><p><a class="reference internal" href="#st-motionepicsinterface">ST_MotionEpicsInterface</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="ek1200">
<h2>EK1200<a class="headerlink" href="#ek1200" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">EK1200</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="el1008">
<h2>EL1008<a class="headerlink" href="#el1008" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL1008</span> <span class="o">|</span> <span class="mi">8</span><span class="o">-</span><span class="n">channel</span> <span class="n">digital</span> <span class="nb">input</span> <span class="n">terminal</span> <span class="mi">24</span> <span class="n">V</span> <span class="n">DC</span><span class="p">,</span> <span class="mi">3</span> <span class="n">ms</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL1008</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL1008_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL1008_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">Channel_1_Input</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">Channel_2_Input</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">Channel_3_Input</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">Channel_4_Input</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">Channel_5_Input</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">Channel_6_Input</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">Channel_7_Input</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">Channel_8_Input</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el1018">
<h2>EL1018<a class="headerlink" href="#el1018" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL1018</span> <span class="o">|</span> <span class="mi">8</span><span class="o">-</span><span class="n">channel</span> <span class="n">digital</span> <span class="nb">input</span> <span class="n">terminal</span> <span class="mi">24</span> <span class="n">V</span> <span class="n">DC</span><span class="p">,</span> <span class="mi">10</span> <span class="n">µs</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL1018</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span>  <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL1018_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL1018_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">Channel_1_Input</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">Channel_2_Input</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">Channel_3_Input</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">Channel_4_Input</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">Channel_5_Input</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">Channel_6_Input</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">Channel_7_Input</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">Channel_8_Input</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el1808">
<h2>EL1808<a class="headerlink" href="#el1808" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL1808</span> <span class="o">|</span> <span class="n">HD</span> <span class="n">EtherCAT</span> <span class="n">Terminals</span><span class="p">,</span> <span class="mi">8</span><span class="o">-</span><span class="n">channel</span> <span class="n">digital</span> <span class="nb">input</span> <span class="mi">24</span> <span class="n">V</span> <span class="n">DC</span><span class="p">,</span> <span class="mi">3</span> <span class="n">ms</span><span class="p">,</span> <span class="mi">2</span><span class="o">-</span><span class="n">wire</span> <span class="n">connection</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL1808</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL1808_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL1808_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">Channel_1_Input</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">Channel_2_Input</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">Channel_3_Input</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">Channel_4_Input</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">Channel_5_Input</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">Channel_6_Input</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">Channel_7_Input</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">Channel_8_Input</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el1809">
<h2>EL1809<a class="headerlink" href="#el1809" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL1809</span> <span class="o">|</span> <span class="n">HD</span> <span class="n">EtherCAT</span> <span class="n">Terminals</span><span class="p">,</span> <span class="mi">16</span><span class="o">-</span><span class="n">channel</span> <span class="n">digital</span> <span class="nb">input</span> <span class="mi">24</span> <span class="n">V</span> <span class="n">DC</span><span class="p">,</span> <span class="mi">3</span> <span class="n">ms</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL1809</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_9</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_10</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_11</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_12</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_13</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_14</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_15</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_16</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_9_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_10_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_11_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_12_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_13_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_14_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_15_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_16_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL1809_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL1809_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">Channel_1_Input</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">Channel_2_Input</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">Channel_3_Input</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">Channel_4_Input</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">Channel_5_Input</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">Channel_6_Input</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">Channel_7_Input</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">Channel_8_Input</span><span class="p">;</span>
            <span class="n">bDi_9</span><span class="o">:=</span><span class="n">Channel_9_Input</span><span class="p">;</span>
            <span class="n">bDi_10</span><span class="o">:=</span><span class="n">Channel_10_Input</span><span class="p">;</span>
            <span class="n">bDi_11</span><span class="o">:=</span><span class="n">Channel_11_Input</span><span class="p">;</span>
            <span class="n">bDi_12</span><span class="o">:=</span><span class="n">Channel_12_Input</span><span class="p">;</span>
            <span class="n">bDi_13</span><span class="o">:=</span><span class="n">Channel_13_Input</span><span class="p">;</span>
            <span class="n">bDi_14</span><span class="o">:=</span><span class="n">Channel_14_Input</span><span class="p">;</span>
            <span class="n">bDi_15</span><span class="o">:=</span><span class="n">Channel_15_Input</span><span class="p">;</span>
            <span class="n">bDi_16</span><span class="o">:=</span><span class="n">Channel_16_Input</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_9</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_10</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_11</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_12</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_13</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_14</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_15</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_16</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el1819">
<h2>EL1819<a class="headerlink" href="#el1819" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL1819</span> <span class="o">|</span> <span class="n">HD</span> <span class="n">EtherCAT</span> <span class="n">Terminals</span><span class="p">,</span> <span class="mi">16</span><span class="o">-</span><span class="n">channel</span> <span class="n">digital</span> <span class="nb">input</span> <span class="mi">24</span> <span class="n">V</span> <span class="n">DC</span><span class="p">,</span> <span class="mi">10</span> <span class="n">µs</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL1819</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_9</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_10</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_11</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_12</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_13</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_14</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_15</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_16</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_9_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_10_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_11_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_12_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_13_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_14_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_15_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_16_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL1819_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL1819_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">Channel_1_Input</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">Channel_2_Input</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">Channel_3_Input</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">Channel_4_Input</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">Channel_5_Input</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">Channel_6_Input</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">Channel_7_Input</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">Channel_8_Input</span><span class="p">;</span>
            <span class="n">bDi_9</span><span class="o">:=</span><span class="n">Channel_9_Input</span><span class="p">;</span>
            <span class="n">bDi_10</span><span class="o">:=</span><span class="n">Channel_10_Input</span><span class="p">;</span>
            <span class="n">bDi_11</span><span class="o">:=</span><span class="n">Channel_11_Input</span><span class="p">;</span>
            <span class="n">bDi_12</span><span class="o">:=</span><span class="n">Channel_12_Input</span><span class="p">;</span>
            <span class="n">bDi_13</span><span class="o">:=</span><span class="n">Channel_13_Input</span><span class="p">;</span>
            <span class="n">bDi_14</span><span class="o">:=</span><span class="n">Channel_14_Input</span><span class="p">;</span>
            <span class="n">bDi_15</span><span class="o">:=</span><span class="n">Channel_15_Input</span><span class="p">;</span>
            <span class="n">bDi_16</span><span class="o">:=</span><span class="n">Channel_16_Input</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_9</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_10</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_11</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_12</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_13</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_14</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_15</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_16</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el2014">
<h2>EL2014<a class="headerlink" href="#el2014" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">EL2014</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bDo_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL2014_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">diagnostic</span> <span class="n">variables</span> <span class="ow">and</span> <span class="n">device</span> <span class="n">diag</span> <span class="n">variables</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">EL2014_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">bDo_1</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">bDo_2</span><span class="p">;</span>
            <span class="n">Channel_3_Output</span><span class="o">:=</span><span class="n">bDo_3</span><span class="p">;</span>
            <span class="n">Channel_4_Output</span><span class="o">:=</span><span class="n">bDo_4</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_3_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_4_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el2252">
<h2>EL2252<a class="headerlink" href="#el2252" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL2252</span> <span class="o">|</span> <span class="n">XFC</span><span class="p">,</span> <span class="mi">2</span><span class="o">-</span><span class="n">channel</span> <span class="n">digital</span> <span class="n">output</span> <span class="n">terminal</span> <span class="k">with</span> <span class="n">time</span> <span class="n">stamp</span><span class="p">,</span> <span class="n">tri</span><span class="o">-</span><span class="n">state</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL2252</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bDo_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL2252_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Add</span> <span class="n">the</span> <span class="n">DC</span> <span class="n">sync</span> <span class="n">variables</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EL2252_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">bDo_1</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">bDo_2</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el2808">
<h2>EL2808<a class="headerlink" href="#el2808" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">EL2808</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bDo_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL2808_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">EL2808_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">bDo_1</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">bDo_2</span><span class="p">;</span>
            <span class="n">Channel_3_Output</span><span class="o">:=</span><span class="n">bDo_3</span><span class="p">;</span>
            <span class="n">Channel_4_Output</span><span class="o">:=</span><span class="n">bDo_4</span><span class="p">;</span>
            <span class="n">Channel_5_Output</span><span class="o">:=</span><span class="n">bDo_5</span><span class="p">;</span>
            <span class="n">Channel_6_Output</span><span class="o">:=</span><span class="n">bDo_6</span><span class="p">;</span>
            <span class="n">Channel_7_Output</span><span class="o">:=</span><span class="n">bDo_7</span><span class="p">;</span>
            <span class="n">Channel_8_Output</span><span class="o">:=</span><span class="n">bDo_8</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_3_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_4_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_5_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_6_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_7_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_8_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el2819">
<h2>EL2819<a class="headerlink" href="#el2819" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">EL2819</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bDo_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_9</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_10</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_11</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_12</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_13</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_14</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_15</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_16</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_9_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_10_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_11_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_12_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_13_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_14_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_15_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_16_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL2819_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">diagnostic</span> <span class="n">variables</span> <span class="ow">and</span> <span class="n">device</span> <span class="n">diag</span> <span class="n">variables</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">EL2819_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">bDo_1</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">bDo_2</span><span class="p">;</span>
            <span class="n">Channel_3_Output</span><span class="o">:=</span><span class="n">bDo_3</span><span class="p">;</span>
            <span class="n">Channel_4_Output</span><span class="o">:=</span><span class="n">bDo_4</span><span class="p">;</span>
            <span class="n">Channel_5_Output</span><span class="o">:=</span><span class="n">bDo_5</span><span class="p">;</span>
            <span class="n">Channel_6_Output</span><span class="o">:=</span><span class="n">bDo_6</span><span class="p">;</span>
            <span class="n">Channel_7_Output</span><span class="o">:=</span><span class="n">bDo_7</span><span class="p">;</span>
            <span class="n">Channel_8_Output</span><span class="o">:=</span><span class="n">bDo_8</span><span class="p">;</span>
            <span class="n">Channel_9_Output</span><span class="o">:=</span><span class="n">bDo_9</span><span class="p">;</span>
            <span class="n">Channel_10_Output</span><span class="o">:=</span><span class="n">bDo_10</span><span class="p">;</span>
            <span class="n">Channel_11_Output</span><span class="o">:=</span><span class="n">bDo_11</span><span class="p">;</span>
            <span class="n">Channel_12_Output</span><span class="o">:=</span><span class="n">bDo_12</span><span class="p">;</span>
            <span class="n">Channel_13_Output</span><span class="o">:=</span><span class="n">bDo_13</span><span class="p">;</span>
            <span class="n">Channel_14_Output</span><span class="o">:=</span><span class="n">bDo_14</span><span class="p">;</span>
            <span class="n">Channel_15_Output</span><span class="o">:=</span><span class="n">bDo_15</span><span class="p">;</span>
            <span class="n">Channel_16_Output</span><span class="o">:=</span><span class="n">bDo_16</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_3_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_4_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_5_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_6_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_7_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_8_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_9_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_10_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_11_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_12_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_13_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_14_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_15_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_16_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el3174-0002">
<h2>EL3174_0002<a class="headerlink" href="#el3174-0002" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL3174</span><span class="o">-</span><span class="mi">0002</span> <span class="o">|</span> <span class="mi">4</span><span class="o">-</span><span class="n">channel</span> <span class="n">analog</span> <span class="nb">input</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="o">/</span><span class="mf">0.</span><span class="o">..+</span><span class="mi">10</span><span class="n">V</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="o">/</span><span class="mi">0</span><span class="o">/+</span><span class="mf">4.</span><span class="o">.</span><span class="mf">.20</span><span class="n">mA</span><span class="p">,</span> <span class="mi">16</span> <span class="n">bit</span><span class="p">,</span> <span class="n">differential</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL3174_0002</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iAi_Ch1_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iAi_Ch2_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iAi_Ch3_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iAi_Ch4_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="o">//</span><span class="n">Channels</span>
    <span class="n">AI_Std_Ch_1_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_1_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_2_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_2_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_3_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_3_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_4_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_4_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Terminal</span> <span class="n">status</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL3174_0002_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Status</span> <span class="n">words</span> <span class="n">of</span> <span class="n">the</span> <span class="n">channels</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span> <span class="o">:=</span> <span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL3174_0002_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">iAi_Ch1_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch_1_Value</span><span class="p">;</span>
            <span class="n">iAi_Ch2_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch_2_Value</span><span class="p">;</span>
            <span class="n">iAi_Ch3_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch_3_Value</span><span class="p">;</span>
            <span class="n">iAi_Ch4_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch_4_Value</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">iAi_Ch1_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">iAi_Ch2_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">iAi_Ch3_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">iAi_Ch4_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el3214">
<h2>EL3214<a class="headerlink" href="#el3214" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL3214</span> <span class="o">|</span> <span class="mi">4</span><span class="o">-</span><span class="n">channel</span> <span class="n">analog</span> <span class="nb">input</span> <span class="n">terminal</span><span class="p">,</span> <span class="n">PT100</span> <span class="p">(</span><span class="n">RTD</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL3214</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iAi_Ch1_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iAi_Ch2_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iAi_Ch3_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iAi_Ch4_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="o">//</span><span class="n">Channels</span>
    <span class="n">AI_RTD_Ch_1_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_1_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_2_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_2_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_3_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_3_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_4_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_4_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Terminal</span> <span class="n">status</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL3214_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Status</span> <span class="n">words</span> <span class="n">of</span> <span class="n">the</span> <span class="n">channels</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span> <span class="o">:=</span> <span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL3214_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">iAi_Ch1_Value</span> <span class="o">:=</span> <span class="n">AI_RTD_Ch_1_Value</span><span class="p">;</span>
            <span class="n">iAi_Ch2_Value</span> <span class="o">:=</span> <span class="n">AI_RTD_Ch_2_Value</span><span class="p">;</span>
            <span class="n">iAi_Ch3_Value</span> <span class="o">:=</span> <span class="n">AI_RTD_Ch_3_Value</span><span class="p">;</span>
            <span class="n">iAi_Ch4_Value</span> <span class="o">:=</span> <span class="n">AI_RTD_Ch_4_Value</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">iAi_Ch1_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">iAi_Ch2_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">iAi_Ch3_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">iAi_Ch4_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el3255">
<h2>EL3255<a class="headerlink" href="#el3255" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL3255</span> <span class="o">|</span> <span class="mi">5</span><span class="o">-</span><span class="n">channel</span> <span class="n">potentiometer</span> <span class="n">measurement</span> <span class="k">with</span> <span class="n">sensor</span> <span class="n">supply</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL3255</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Ch1_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">Ch2_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">Ch3_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">Ch4_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">Ch5_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">AI_Std_Ch1_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch2_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch3_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch4_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch5_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL3255_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">Status</span> <span class="n">words</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL3255_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">EN</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">Ch1_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch1_Value</span><span class="p">;</span>
            <span class="n">Ch2_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch2_Value</span><span class="p">;</span>
            <span class="n">Ch3_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch3_Value</span><span class="p">;</span>
            <span class="n">Ch4_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch4_Value</span><span class="p">;</span>
            <span class="n">Ch5_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch5_Value</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Ch1_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Ch2_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Ch3_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Ch4_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Ch5_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el5002">
<h2>EL5002<a class="headerlink" href="#el5002" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL5002</span> <span class="o">|</span> <span class="mi">2</span><span class="o">-</span><span class="n">chennel</span> <span class="n">SSI</span> <span class="n">absolute</span> <span class="n">encoder</span> <span class="n">terminal</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL5002</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Ch1_Counter_Value</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">Ch2_Counter_Value</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">udi_Ch1_Cnt_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">udi_Ch2_Cnt_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL5002_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">Status</span> <span class="n">words</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL5002_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">EN</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">Ch1_Counter_Value</span> <span class="o">:=</span> <span class="n">udi_Ch1_Cnt_Value</span><span class="p">;</span>
            <span class="n">Ch2_Counter_Value</span> <span class="o">:=</span> <span class="n">udi_Ch2_Cnt_Value</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Ch1_Counter_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Ch2_Counter_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el5021">
<h2>EL5021<a class="headerlink" href="#el5021" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL5021</span> <span class="o">|</span> <span class="mi">1</span><span class="o">-</span><span class="n">channel</span> <span class="n">Sin</span><span class="o">/</span><span class="n">Cos</span> <span class="n">encoder</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL5021</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Counter_Value</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">Latch_Value</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">udiCounter_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">udiLatch_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL5021_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">Status</span> <span class="n">words</span><span class="p">,</span> <span class="n">control</span> <span class="n">words</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL5021_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">EN</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">Counter_Value</span> <span class="o">:=</span> <span class="n">udiCounter_Value</span><span class="p">;</span>
            <span class="n">Latch_Value</span> <span class="o">:=</span> <span class="n">udiLatch_Value</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Counter_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Latch_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el5042">
<h2>EL5042<a class="headerlink" href="#el5042" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL5042</span> <span class="o">|</span> <span class="mi">2</span><span class="o">-</span><span class="n">channel</span> <span class="n">BiSS</span><span class="o">-</span><span class="n">C</span> <span class="n">absolute</span> <span class="n">encoder</span> <span class="n">terminal</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL5042</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Ch1_Position</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="n">Ch2_Position</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">FB_Inputs_ch1_Position</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="n">FB_Inputs_ch2_Position</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL5042_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">Status</span> <span class="n">words</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL5042_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">EN</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">Ch1_Position</span> <span class="o">:=</span> <span class="n">FB_Inputs_ch1_Position</span><span class="p">;</span>
            <span class="n">Ch2_Position</span> <span class="o">:=</span> <span class="n">FB_Inputs_ch2_Position</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Ch1_Position</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Ch2_Position</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el5101">
<h2>EL5101<a class="headerlink" href="#el5101" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">EL5101</span> <span class="o">|</span> <span class="mi">1</span><span class="o">-</span><span class="n">channel</span> <span class="n">incremental</span> <span class="n">encoder</span> <span class="n">terminal</span><span class="p">,</span> <span class="mi">5</span><span class="n">V</span><span class="p">,</span> <span class="n">RS422</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL5101</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Counter_Value</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">Latch_Value</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">uiCounter_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">uiLatch_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL5101_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">Status</span> <span class="n">word</span><span class="p">,</span> <span class="n">control</span> <span class="n">words</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL5101_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">EN</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">Counter_Value</span> <span class="o">:=</span> <span class="n">uiCounter_Value</span><span class="p">;</span>
            <span class="n">Latch_Value</span> <span class="o">:=</span> <span class="n">uiLatch_Value</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Counter_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Latch_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el7211-v1-00">
<h2>EL7211_v1_00<a class="headerlink" href="#el7211-v1-00" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL7211</span> <span class="o">|</span> <span class="n">Servo</span> <span class="n">motor</span> <span class="n">termional</span> <span class="mi">5</span> <span class="n">A</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL7211_v1_00</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">AND</span> <span class="p">(</span><span class="n">WcState_WcState</span> <span class="n">OR</span> <span class="n">InfoData_State</span><span class="o">&lt;&gt;</span><span class="mi">16</span><span class="c1">#8) THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="el9410">
<h2>EL9410<a class="headerlink" href="#el9410" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL9410</span> <span class="o">|</span> <span class="n">E</span><span class="o">-</span><span class="n">Bus</span> <span class="n">power</span> <span class="n">supplier</span> <span class="ow">and</span> <span class="n">refresher</span><span class="p">,</span> <span class="n">diagnostics</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL9410</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">bStatus_Us_UV</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bStatus_Up_UV</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL9410_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Status</span> <span class="n">bits</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL9410_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el9505">
<h2>EL9505<a class="headerlink" href="#el9505" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL9505</span> <span class="o">|</span> <span class="n">Power</span> <span class="n">supply</span> <span class="n">terminal</span> <span class="mi">5</span><span class="n">V</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL9505</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">bStatus_Uo_Power_OK</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bStatus_Uo_Overload</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL9505_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Status</span> <span class="n">bits</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL9505_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el9576-v1-00">
<h2>EL9576_v1_00<a class="headerlink" href="#el9576-v1-00" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL9576</span> <span class="o">|</span> <span class="n">Brake</span> <span class="n">terminal</span> <span class="p">(</span><span class="n">vap</span> <span class="ow">and</span> <span class="n">resistor</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL9576_v1_00</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">OverTemperature</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">I2TError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">I2TWarning</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">OverVoltage</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">UnderVoltage</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ChopperOn</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">DCLinkVoltage</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">DutyCycle</span>  <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">ResistorCurrent</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">BCTOverTemperature</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">BCTI2TError</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">BCTI2TWarning</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">BCTOverVoltage</span>  <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">BCTUnderVoltage</span>  <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">BCTChopperOn</span>  <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">BCTDCLinkVoltage</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">BCTDutyCycle</span>  <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">USINT</span><span class="p">;</span>
    <span class="n">BCTResistorCurrent</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">AND</span> <span class="p">(</span><span class="n">WcState_WcState</span> <span class="n">OR</span> <span class="n">InfoData_State</span><span class="o">&lt;&gt;</span><span class="mi">16</span><span class="c1">#8 OR BCTI2TError OR BCTI2TWarning OR BCTOverTemperature OR BCTOverVoltage OR BCTUnderVoltage) THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">OverTemperature</span><span class="o">:=</span><span class="n">BCTOverTemperature</span><span class="p">;</span>
<span class="n">I2TError</span><span class="o">:=</span><span class="n">BCTI2TError</span><span class="p">;</span>
<span class="n">I2TWarning</span><span class="o">:=</span><span class="n">BCTI2TWarning</span><span class="p">;</span>
<span class="n">OverVoltage</span><span class="o">:=</span><span class="n">BCTOverVoltage</span><span class="p">;</span>
<span class="n">UnderVoltage</span><span class="o">:=</span><span class="n">bctUnderVoltage</span><span class="p">;</span>
<span class="n">ChopperOn</span><span class="o">:=</span><span class="n">bctChopperOn</span><span class="p">;</span>
<span class="n">DCLinkVoltage</span><span class="o">:=</span><span class="n">UDINT_TO_LREAL</span><span class="p">(</span><span class="n">bctDCLinkVoltage</span><span class="p">);</span>
<span class="n">DutyCycle</span><span class="o">:=</span><span class="n">USINT_TO_LREAL</span><span class="p">(</span><span class="n">BCTDutyCycle</span><span class="p">);</span>
<span class="n">ResistorCurrent</span><span class="o">:=</span><span class="n">UDINT_TO_LREAL</span><span class="p">(</span><span class="n">BCTResistorCurrent</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="f-atpositionstate">
<h2>F_AtPositionState<a class="headerlink" href="#f-atpositionstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_AtPositionState</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Check</span> <span class="k">if</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">within</span> <span class="n">the</span> <span class="n">state</span> <span class="n">bounds</span>
    <span class="n">This</span> <span class="n">will</span> <span class="n">only</span> <span class="n">run</span> <span class="n">properly</span> <span class="k">if</span> <span class="n">FB_PositionStateInternal</span> <span class="n">has</span> <span class="n">been</span> <span class="n">called</span> <span class="n">on</span> <span class="n">the</span> <span class="n">position</span> <span class="n">state</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">it</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">defined</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="n">within</span> <span class="n">the</span> <span class="n">delta</span><span class="p">,</span> <span class="ow">and</span> <span class="n">we</span> <span class="n">are</span> <span class="n">either</span> <span class="ow">not</span> <span class="n">moving</span> <span class="ow">or</span> <span class="n">our</span> <span class="n">destination</span> <span class="ow">is</span> <span class="n">within</span> <span class="n">the</span> <span class="n">delta</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="n">at</span> <span class="n">the</span> <span class="n">state</span>
<span class="n">F_AtPositionState</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bUpdated</span>
                     <span class="n">AND</span> <span class="n">F_PosWithinDelta</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span> <span class="n">stPositionState</span><span class="p">)</span>
                     <span class="n">AND</span> <span class="p">((</span><span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">)</span> <span class="n">OR</span> <span class="n">F_PosWithinDelta</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span> <span class="n">stPositionState</span><span class="p">));</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#f-poswithindelta">F_PosWithinDelta</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-motionerrorcodelookup">
<h2>F_MotionErrorCodeLookup<a class="headerlink" href="#f-motionerrorcodelookup" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_MotionErrorCodeLookup</span> <span class="p">:</span> <span class="n">STRING</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">msg</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CASE</span> <span class="n">nErrorId</span> <span class="n">OF</span>
    <span class="o">//</span> <span class="n">Common</span> <span class="n">NC</span> <span class="n">errors</span>
    <span class="mi">16</span><span class="c1">#4221: msg:=&#39;Requested set velocity is not allowed&#39;;</span>
    <span class="mi">16</span><span class="c1">#4222: msg:=&#39;Requested set position is not allowed&#39;;</span>
    <span class="mi">16</span><span class="c1">#4223: msg:=&#39;No enable for controller and/or feed&#39;;</span>
    <span class="mi">16</span><span class="c1">#4225: msg:=&#39;Drive not ready during axis start&#39;;</span>
    <span class="mi">16</span><span class="c1">#4260: msg:=&#39;Drive disabled&#39;;</span>
    <span class="mi">16</span><span class="c1">#42A0: msg:=&#39;Coupled axis error&#39;;</span>
    <span class="mi">16</span><span class="c1">#4357: msg:=&#39;Negative limit hit&#39;;</span>
    <span class="mi">16</span><span class="c1">#4358: msg:=&#39;Positive limit hit&#39;;</span>
    <span class="mi">16</span><span class="c1">#4395: msg:=&#39;Set velocity not allowed&#39;;</span>
    <span class="mi">16</span><span class="c1">#4466: msg:=&#39;Invalid I/O data for more than n continuous NC cycles (encoder)&#39;;</span>
    <span class="mi">16</span><span class="c1">#4467: msg:=&#39;Encoder error: invalid actual position data&#39;;</span>
    <span class="mi">16</span><span class="c1">#4550: msg:=&#39;Stall: position lag monitoring error&#39;;</span>
    <span class="mi">16</span><span class="c1">#4650: msg:=&#39;Drive hardware not ready to operate&#39;;</span>
    <span class="mi">16</span><span class="c1">#4655: msg:=&#39;Invalid IO data&#39;;</span>
    <span class="mi">16</span><span class="c1">#4B07: msg:=&#39;Timeout axis function block after 6 seconds&#39;;</span>
    <span class="mi">16</span><span class="c1">#4FFF: msg:=&#39;Unknown NC error (not in manual)&#39;;</span>

    <span class="o">//</span> <span class="n">Custom</span> <span class="n">error</span> <span class="n">definitions</span>
    <span class="n">E_LCLSMotionError</span><span class="o">.</span><span class="n">ABORTED</span><span class="p">:</span> <span class="n">msg</span><span class="o">:=</span><span class="s1">&#39;Aborted move request with active move in progress&#39;</span><span class="p">;</span>
    <span class="n">E_LCLSMotionError</span><span class="o">.</span><span class="n">UNSAFE</span><span class="p">:</span> <span class="n">msg</span><span class="o">:=</span><span class="s1">&#39;Position state unsafe&#39;</span><span class="p">;</span>
    <span class="n">E_LCLSMotionError</span><span class="o">.</span><span class="n">INVALID</span><span class="p">:</span> <span class="n">msg</span><span class="o">:=</span><span class="s1">&#39;Position state invalid&#39;</span><span class="p">;</span>
    <span class="n">E_LCLSMotionError</span><span class="o">.</span><span class="n">TEST</span><span class="p">:</span> <span class="n">msg</span><span class="o">:=</span><span class="s1">&#39;Fake testing error&#39;</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Fallbacks</span>
    <span class="mi">0</span><span class="p">:</span> <span class="n">msg</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">msg</span><span class="o">:=</span><span class="s1">&#39;Contact PCDS to add new message&#39;</span><span class="p">;</span>
<span class="n">END_CASE</span>
<span class="n">F_MotionErrorCodeLookup</span> <span class="o">:=</span> <span class="n">msg</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-lclsmotionerror">E_LCLSMotionError</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-posoverlowerbound">
<h2>F_PosOverLowerBound<a class="headerlink" href="#f-posoverlowerbound" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_PosOverLowerBound</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">F_PosOverLowerBound</span> <span class="o">:=</span> <span class="n">fPosition</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="n">ABS</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span><span class="p">));</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-posunderupperbound">
<h2>F_PosUnderUpperBound<a class="headerlink" href="#f-posunderupperbound" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_PosUnderUpperBound</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">F_PosUnderUpperBound</span> <span class="o">:=</span> <span class="n">fPosition</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">ABS</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span><span class="p">));</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-poswithindelta">
<h2>F_PosWithinDelta<a class="headerlink" href="#f-poswithindelta" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_PosWithinDelta</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">F_PosWithinDelta</span> <span class="o">:=</span> <span class="n">F_PosOverLowerBound</span><span class="p">(</span><span class="n">fPosition</span><span class="p">,</span> <span class="n">stPositionState</span><span class="p">)</span> <span class="n">AND</span>
                    <span class="n">F_PosUnderUpperBound</span><span class="p">(</span><span class="n">fPosition</span><span class="p">,</span> <span class="n">stPositionState</span><span class="p">);</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-posoverlowerbound">F_PosOverLowerBound</a></p></li>
<li><p><a class="reference internal" href="#f-posunderupperbound">F_PosUnderUpperBound</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-atpositionstate-test">
<h2>FB_AtPositionState_Test<a class="headerlink" href="#fb-atpositionstate-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_AtPositionState_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">the</span> <span class="n">following</span> <span class="n">related</span> <span class="n">helper</span> <span class="n">functions</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">F_PosOverLowerBound</span>
    <span class="o">-</span> <span class="n">F_PosUnderUpperBound</span>
    <span class="o">-</span> <span class="n">F_PosWithinDelta</span>
    <span class="o">-</span> <span class="n">F_AtPositionState</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">For</span> <span class="n">the</span> <span class="n">multi</span><span class="o">-</span><span class="n">cycle</span> <span class="n">tests</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbTestMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>
    <span class="n">stPositionStateInactive</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stPositionStateInvalid</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stPositionStateGood</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">tonInactive</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">fbInternalGood</span><span class="p">:</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">fbInternalInvalid</span><span class="p">:</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Single</span> <span class="n">cycle</span> <span class="n">tests</span>
<span class="n">TestPosOverLowerBoundYes</span><span class="p">();</span>
<span class="n">TestPosOverLowerBoundNo</span><span class="p">();</span>
<span class="n">TestPosUnderUpperBoundYes</span><span class="p">();</span>
<span class="n">TestPosUnderUpperBoundNo</span><span class="p">();</span>
<span class="n">TestPosWithinDeltaTooLow</span><span class="p">();</span>
<span class="n">TestPosWithinDeltaTooHigh</span><span class="p">();</span>
<span class="n">TestPosWithinDeltaJustRight</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Multi</span> <span class="n">cycle</span> <span class="n">tests</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">stPositionStateInactive</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Inactive&#39;</span><span class="p">;</span>
<span class="n">stPositionStateInactive</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">30.0</span><span class="p">;</span>
<span class="n">stPositionStateInactive</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>
<span class="n">stPositionStateInactive</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">tonInactive</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1s,</span>
<span class="p">);</span>
<span class="n">TestAtPositionStateWithoutInternal</span><span class="p">();</span>

<span class="n">stPositionStateInvalid</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">;</span>
<span class="n">stPositionStateInvalid</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">40.0</span><span class="p">;</span>
<span class="n">stPositionStateInvalid</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>
<span class="n">stPositionStateInvalid</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">fbInternalInvalid</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateInvalid</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TestAtPositionStateInvalid</span><span class="p">();</span>

<span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Good&#39;</span><span class="p">;</span>
<span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">50.0</span><span class="p">;</span>
<span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>
<span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">fbInternalGood</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TestAtPositionStateTooLow</span><span class="p">();</span>
<span class="n">TestAtPositionStateTooHigh</span><span class="p">();</span>
<span class="n">TestAtPositionStateJustRight</span><span class="p">();</span>
<span class="n">TestAtPositionStateTweak</span><span class="p">();</span>
<span class="n">TestAtPositionStateLeave</span><span class="p">();</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fbTestMove</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateInvalid</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">If</span> <span class="n">a</span> <span class="n">position</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">invalid</span><span class="p">,</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">never</span> <span class="n">the</span> <span class="n">right</span> <span class="n">state</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateInvalid&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">1</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">stPositionStateInvalid</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">stPositionStateInvalid</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (stPositionStateInvalid.bUpdated AND fbTestMove.bSetDone) THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateInvalid</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Invalid state was marked OK&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateJustRight</span>
<span class="n">VAR</span>
    <span class="n">fLocalGoal</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateJustRight&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">4</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fLocalGoal</span> <span class="o">:=</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fLocalGoal</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fLocalGoal</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (stPositionStateGood.bUpdated AND fbTestMove.bSetDone) THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Within delta counted as outside range&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateLeave</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">A</span> <span class="n">move</span> <span class="n">away</span> <span class="kn">from</span><span class="w"> </span><span class="nn">a</span> <span class="n">state</span> <span class="n">should</span> <span class="n">be</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">the</span> <span class="n">state</span><span class="p">,</span> <span class="n">even</span> <span class="n">before</span> <span class="n">we</span><span class="s1">&#39;ve left</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateLeave&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">6</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s OR (stPositionStateGood.bUpdated AND fbTestMove.bMotionStarted) THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&lt;</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;We must be at the state location still to properly run this test.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Leaving state is not at state once the move starts&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateTooHigh</span>
<span class="n">VAR</span>
    <span class="n">fLocalGoal</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateTooHigh&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">3</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fLocalGoal</span> <span class="o">:=</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fLocalGoal</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fLocalGoal</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (stPositionStateGood.bUpdated AND fbTestMove.bSetDone) THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Above delta counted as in range&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateTooLow</span>
<span class="n">VAR</span>
    <span class="n">fLocalGoal</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateTooLow&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">2</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fLocalGoal</span> <span class="o">:=</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fLocalGoal</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fLocalGoal</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (stPositionStateGood.bUpdated AND fbTestMove.bSetDone) THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Below delta counted as in range&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateTweak</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">A</span> <span class="n">small</span> <span class="n">tweak</span> <span class="n">move</span> <span class="n">within</span> <span class="n">the</span> <span class="n">delta</span> <span class="n">of</span> <span class="n">a</span> <span class="n">position</span> <span class="n">state</span> <span class="n">should</span> <span class="n">be</span> <span class="n">OK</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateTweak&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">5</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s OR (stPositionStateGood.bUpdated AND fbTestMove.bMotionStarted) THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Small tweak in range should count as at state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateWithoutInternal</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">If</span> <span class="n">a</span> <span class="n">position</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">never</span> <span class="n">updated</span> <span class="n">by</span> <span class="n">the</span> <span class="n">internal</span> <span class="n">FB</span><span class="p">,</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">never</span> <span class="n">the</span> <span class="n">right</span> <span class="n">state</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateWithoutInternal&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">stPositionStateInactive</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">stPositionStateInactive</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (stPositionStateInvalid.bUpdated AND fbTestMove.bSetDone) THEN</span>
    <span class="o">//</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">a</span> <span class="n">different</span> <span class="n">state</span> <span class="n">to</span> <span class="n">be</span> <span class="n">bUpdated</span> <span class="k">for</span> <span class="n">timing</span> <span class="n">purposes</span><span class="p">,</span> <span class="n">this</span> <span class="n">one</span> <span class="n">never</span> <span class="n">gets</span> <span class="n">bUpdated</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateInactive</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;This is the control group, internal was not run so this should not work&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosOverLowerBoundNo</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosOverLowerBoundNo&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosOverLowerBound</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">8.5</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 8.5 &gt; 9.0&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosOverLowerBoundYes</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosOverLowerBoundYes&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosOverLowerBound</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">9.1</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 9.0 &gt; 9.1&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosUnderUpperBoundNo</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosUnderUpperBoundNo&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosUnderUpperBound</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">12.0</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 11.0 &gt; 12.0&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosUnderUpperBoundYes</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosUnderUpperBoundYes&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosUnderUpperBound</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">10.9</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 10.9 &gt; 11.0&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosWithinDeltaJustRight</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosWithinDeltaJustRight&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosWithinDelta</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">20.2</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 20.2 not within 19 to 21 bounds&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosWithinDeltaTooHigh</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosWithinDeltaTooHigh&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosWithinDelta</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">25.0</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 21.0 &gt; 25.0&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosWithinDeltaTooLow</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosWithinDeltaTooLow&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosWithinDelta</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">12.0</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 12.0 &gt; 19.0&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove">FB_TestHelperSetAndMove</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#f-posoverlowerbound">F_PosOverLowerBound</a></p></li>
<li><p><a class="reference internal" href="#f-posunderupperbound">F_PosUnderUpperBound</a></p></li>
<li><p><a class="reference internal" href="#f-poswithindelta">F_PosWithinDelta</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-axisparametersetexposed-test">
<h2>FB_AxisParameterSetExposed_Test<a class="headerlink" href="#fb-axisparametersetexposed-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_AxisParameterSetExposed_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Quick</span> <span class="n">Check</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">exposed</span> <span class="n">NC</span> <span class="n">parameters</span> <span class="n">are</span> <span class="n">copied</span> <span class="n">properly</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Test</span> <span class="n">that</span> <span class="n">parameters</span> <span class="n">are</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">exposed</span> <span class="n">parameters</span> <span class="n">properly</span><span class="o">.</span>
<span class="n">TestParameterCopy</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">nTestCounter</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#2s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestParameterCopy</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">bLocalInit</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bAllModified</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;TestParameterCopy&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nTestIndex</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIndex</span> <span class="n">OR</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bLocalInit</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">bCtrlEnablePosDiffControl</span>     <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">bEncEnableSoftEndMaxControl</span>   <span class="o">:=</span> <span class="mi">101</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">bEncEnableSoftEndMinControl</span>   <span class="o">:=</span> <span class="mi">102</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fAccelerationMax</span>              <span class="o">:=</span> <span class="mi">103</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fCtrlPosDiffMax</span>               <span class="o">:=</span> <span class="mi">104</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fCtrlPosDiffMaxTime</span>           <span class="o">:=</span> <span class="mi">105</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fDecelerationMax</span>              <span class="o">:=</span> <span class="mi">106</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncSoftEndMax</span>                <span class="o">:=</span> <span class="mi">107</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncSoftEndMin</span>                <span class="o">:=</span> <span class="mi">108</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fVeloMaximum</span>                  <span class="o">:=</span> <span class="mi">109</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncOffset</span>                                        <span class="o">:=</span> <span class="mi">110</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span>           <span class="o">:=</span> <span class="mi">111</span><span class="p">;</span>

    <span class="n">bLocalInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">bAllModified</span> <span class="o">:=</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">bCtrlEnablePosDiffControl</span>     <span class="o">&lt;&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bCtrlEnablePosDiffControl</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">bEncEnableSoftEndMaxControl</span>   <span class="o">&lt;&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bEncEnableSoftEndMaxControl</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">bEncEnableSoftEndMinControl</span>   <span class="o">&lt;&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bEncEnableSoftEndMinControl</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fAccelerationMax</span>              <span class="o">&lt;&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fAccelerationMax</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fCtrlPosDiffMax</span>               <span class="o">&lt;&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fCtrlPosDiffMax</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fCtrlPosDiffMaxTime</span>           <span class="o">&lt;&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fCtrlPosDiffMaxTime</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fDecelerationMax</span>              <span class="o">&lt;&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fDecelerationMax</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncSoftEndMax</span>                <span class="o">&lt;&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncSoftEndMax</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncSoftEndMin</span>                <span class="o">&lt;&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncSoftEndMin</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fVeloMaximum</span>                  <span class="o">&lt;&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fVeloMaximum</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncOffset</span>                    <span class="o">&lt;&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncOffset</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span>       <span class="o">&lt;&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span><span class="p">;</span>

    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">bAllModified</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;One or more parameters was not modified initially so the check is invalid.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">bReady</span> <span class="o">:=</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bCtrlEnablePosDiffControl</span>     <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bEncEnableSoftEndMaxControl</span>   <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bEncEnableSoftEndMinControl</span>   <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fAccelerationMax</span>              <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fCtrlPosDiffMax</span>               <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fCtrlPosDiffMaxTime</span>           <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fDecelerationMax</span>              <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncSoftEndMax</span>                <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncSoftEndMin</span>                <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fVeloMaximum</span>                  <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncOffset</span>                                    <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span>       <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bReady</span> <span class="n">THEN</span>
    <span class="n">bDone</span> <span class="o">:=</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">bCtrlEnablePosDiffControl</span>     <span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bCtrlEnablePosDiffControl</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">bEncEnableSoftEndMaxControl</span>   <span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bEncEnableSoftEndMaxControl</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">bEncEnableSoftEndMinControl</span>   <span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bEncEnableSoftEndMinControl</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fAccelerationMax</span>              <span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fAccelerationMax</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fCtrlPosDiffMax</span>               <span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fCtrlPosDiffMax</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fCtrlPosDiffMaxTime</span>           <span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fCtrlPosDiffMaxTime</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fDecelerationMax</span>              <span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fDecelerationMax</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncSoftEndMax</span>                <span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncSoftEndMax</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncSoftEndMin</span>                <span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncSoftEndMin</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fVeloMaximum</span>                  <span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fVeloMaximum</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncOffset</span>                    <span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncOffset</span> <span class="n">AND</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span>       <span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bDone</span> <span class="n">OR</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Failed to update the parameters within &#39;</span><span class="p">,</span> <span class="n">TIME_TO_STRING</span><span class="p">(</span><span class="n">tonTimer</span><span class="o">.</span><span class="n">PT</span><span class="p">)),</span><span class="s1">&#39; seconds.&#39;</span><span class="p">),</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;One or more parameters was not copied properly.&#39;</span><span class="p">,</span>
    <span class="p">);</span>

    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-axisstatusnc">
<h2>FB_AxisStatusNC<a class="headerlink" href="#fb-axisstatusnc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_AxisStatusNC</span> <span class="n">IMPLEMENTS</span> <span class="n">I_AxisStatus</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_copy&#39;</span><span class="p">}</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">bDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span><span class="p">;</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">AxisEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="o">//</span> <span class="n">Get</span> <span class="n">a</span> <span class="n">definitive</span> <span class="n">bEnabled</span> <span class="n">reading</span>
<span class="n">CASE</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">MotionState</span> <span class="n">OF</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">enabled</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">issue</span>
    <span class="n">MC_AXISSTATE_UNDEFINED</span><span class="p">,</span> <span class="n">MC_AXISSTATE_DISABLED</span><span class="p">,</span> <span class="n">MC_AXISSTATE_ERRORSTOP</span><span class="p">:</span>
        <span class="n">AxisEnabled</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">AxisEnabled</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_CASE</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Aborted</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">HasBeenStopped</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Active</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">HasJob</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">AxisID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">AxisId</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">AxisState</span> <span class="p">:</span> <span class="n">MC_AxisStates</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">AxisState</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">MotionState</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Moving</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Done</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">InTargetPosition</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">InTargetPosition</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">InTargetPosition</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">InTargetPosition</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MeasuredAcceleration</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MeasuredAcceleration</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActAcc</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MeasuredPosition</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="p">(</span><span class="o">*</span><span class="n">Actual</span> <span class="n">Position</span><span class="o">*</span><span class="p">)</span>
<span class="n">MeasuredPosition</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MeasuredPositionDiff</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="p">(</span><span class="o">*</span><span class="n">Actual</span> <span class="n">Position</span> <span class="n">Diff</span><span class="o">*</span><span class="p">)</span>
<span class="n">MeasuredPositionDiff</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">PosDiff</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MeasuredVelocity</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="p">(</span><span class="o">*</span><span class="n">Actual</span> <span class="n">Velocity</span><span class="o">*</span><span class="p">)</span>
<span class="n">MeasuredVelocity</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActVelo</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Message</span> <span class="o">:=</span> <span class="n">sMessage</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">NegativeMotionIsEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">NegativeMotionIsEnabled</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NegativeDirection</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">PositiveMotionIsEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">PositiveMotionIsEnabled</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">PositiveDirection</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">StandStill</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">StandStill</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">StandStill</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Stopped</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Stopped</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">HasBeenStopped</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
</section>
<section id="fb-backlashcompensationnc">
<h2>FB_BacklashCompensationNC<a class="headerlink" href="#fb-backlashcompensationnc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_BacklashCompensationNC IMPLEMENTS I_BacklashCompensation
VAR
    {attribute &#39;no_copy&#39;}
    AxisRef : REFERENCE TO AXIS_REF;
    fbMcBacklashCompensation: MC_BacklashCompensation;
    (* Other status information for users of the IOC *)
    // Enabled axis backlash compensation
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:bBacklashCompUserEn
        io: io
        field: ZNAM FALSE
        field: ONAM TRUE
        field: DESC Enable Backlash compensation
    &#39;}
    bUserEnable: BOOL;

    // backlash compensation status
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:bBacklashCompStatus
        io: i
        field: ZNAM DISABLED
        field: ONAM ENABLED
        field: DESC Backlash compensation status
    &#39;}
    bBacklashCompStatus: BOOL;

    // Backlash compensation value
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:fBacklashComp
        io: io
        field: DESC Backlash compensation
    &#39;}
    fBacklashComp: LREAL := 0.0;

    // Backlash Ramp Velocity
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:fRampVelo
        io: io
        field: DESC Backlash compensation Ramp Velocity
    &#39;}
     fRampVelo : LREAL := 10.0;

    // Current Backlash compensation value ?
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:fMeasuredBacklashComp
        io: i
        field: DESC Currently applied compensation
    &#39;}
    fActCompensation: LREAL;

    fPrevCompensation : LREAL := 0.0;
    bActive: BOOL;

    bLocalEnable : BOOL;
    sMessage : T_MAXSTRING;
END_VAR
IF NOT __ISVALIDREF(AxisRef) THEN
    RETURN;
END_IF

AxisRef.ReadStatus();

(*Note: Configure within the axis parameters set &quot;position correction&quot; to true
    Directional compensation change
      FALSE -&gt; positive backlash
      TRUE  -&gt; Negative backlash compensation
    Reset Compensation to register a new value change
    fRampVelocity : a tenth of Moveabsolute velocity is a good starting point
*)
bLocalEnable R= NOT bActive OR (fBacklashComp&lt;&gt;fPrevCompensation);
bLocalEnable S= bActive;

fbMcBacklashCompensation(Axis:=AxisRef,
    Enable:= bLocalEnable AND bUserEnable,
    Backlash:= fBacklashComp,
    CompensationInPositiveDirection:=(fBacklashComp &lt; 0.0),
    Ramp:=fRampVelo,
    CurrentBacklash=&gt;fActCompensation
);
fPrevCompensation:=fBacklashComp;

END_FUNCTION_BLOCK

(*
    Handle positive/negative backlash compensation
    User needs to set the direction of backlash from the sign of the compensation value
    Backlash compensation is disabled during referencing (homing).
    When direction is positive/negative, further movement in the negative/positive direction not compensated
    further movement in the negative/positive direction will be compensated
*)
METHOD BacklashCompensation
VAR_INPUT
    Activate     : BOOL;
    DisableMode     : E_DISABLEMODE := E_DISABLEMODE.DisableModeHold;
END_VAR
fbMcBacklashCompensation(Axis:=AxisRef,
    Enable:= Activate,
    DisableMode:=DisableMode
);
END_METHOD

METHOD PUBLIC CallAfterInit
VAR_INPUT
    AxisRef : REFERENCE TO AXIS_REF;
END_VAR
THIS^.AxisRef REF= AxisRef;
END_METHOD

METHOD FB_Init : BOOL
VAR_INPUT
    bInitRetains : BOOL; // if TRUE, the retain variables are initialized (warm start / cold start)
    bInCopyCode : BOOL;  // if TRUE, the instance afterwards gets moved into the copy code (online change)
    AxisRef : REFERENCE TO AXIS_REF;
END_VAR
THIS^.AxisRef REF= AxisRef;
END_METHOD

PROPERTY Aborted : BOOL
VAR
END_VAR

END_PROPERTY

PROPERTY ActCompensation : LREAL
VAR
END_VAR
ActCompensation := THIS^.fbMcBacklashCompensation.CurrentBacklash;
END_PROPERTY

PROPERTY Active : BOOL
VAR
END_VAR

END_PROPERTY

PROPERTY Busy : BOOL
VAR
END_VAR
Busy := THIS^.fbMcBacklashCompensation.Busy;
END_PROPERTY

PROPERTY Done : BOOL
VAR
END_VAR

END_PROPERTY

PROPERTY Error : BOOL
VAR
END_VAR
Error := THIS^.fbMcBacklashCompensation.Error;
END_PROPERTY

PROPERTY ErrorID : UDINT
VAR
END_VAR
ErrorID := THIS^.fbMcBacklashCompensation.ErrorID;
END_PROPERTY

PROPERTY Message : T_MaxString
VAR
END_VAR
Message :=sMessage;
END_PROPERTY
</pre></div>
</div>
</section>
<section id="fb-brakenc">
<h2>FB_BrakeNC<a class="headerlink" href="#fb-brakenc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_BrakeNC</span> <span class="n">IMPLEMENTS</span> <span class="n">I_Brake</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Determines</span> <span class="n">when</span> <span class="n">we</span> <span class="n">automatically</span> <span class="n">disengage</span> <span class="n">the</span> <span class="n">brake</span>
    <span class="n">eBrakeMode</span><span class="p">:</span> <span class="n">E_StageBrakeMode</span><span class="o">:=</span><span class="n">E_StageBrakeMode</span><span class="o">.</span><span class="n">IF_ENABLED</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">NC</span> <span class="n">Brake</span> <span class="n">Output</span><span class="p">:</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">release</span> <span class="n">brake</span>
    <span class="n">bBrakeRelease</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="k">pass</span> <span class="n">it</span> <span class="n">an</span> <span class="n">AXIS_REF</span><span class="o">.</span>
    <span class="n">eAxisState</span> <span class="p">:</span> <span class="n">MC_AxisStates</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Handle</span> <span class="n">the</span> <span class="n">brake</span><span class="o">.</span> <span class="n">TRUE</span> <span class="n">means</span> <span class="n">brake</span> <span class="n">disabled</span><span class="o">/</span><span class="n">released</span>
<span class="n">CASE</span> <span class="n">eBrakeMode</span> <span class="n">OF</span>
    <span class="n">E_StageBrakeMode</span><span class="o">.</span><span class="n">NO_BRAKE</span><span class="p">:</span>
        <span class="n">bBrakeRelease</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">CASE</span> <span class="n">eAxisState</span> <span class="n">OF</span>
            <span class="n">MC_AXISSTATE_UNDEFINED</span><span class="p">,</span>
            <span class="n">MC_AXISSTATE_DISABLED</span><span class="p">,</span>
            <span class="n">MC_AXISSTATE_ERRORSTOP</span><span class="p">:</span>
                <span class="o">//</span> <span class="n">Brake</span> <span class="n">applied</span>
                <span class="n">bBrakeRelease</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">MC_AXISSTATE_STANDSTILL</span><span class="p">:</span>
                <span class="n">IF</span> <span class="n">eBrakeMode</span> <span class="o">=</span> <span class="n">E_StageBrakeMode</span><span class="o">.</span><span class="n">IF_MOVING</span> <span class="n">THEN</span>
                    <span class="n">bBrakeRelease</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">ELSE</span>
                    <span class="o">//</span> <span class="n">Brake</span> <span class="n">Released</span>
                    <span class="n">bBrakeRelease</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">END_IF</span>
            <span class="n">ELSE</span>
                <span class="n">bBrakeRelease</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_CASE</span>
<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
<span class="n">END_VAR</span>

<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">AxisState</span> <span class="p">:</span> <span class="n">MC_AxisStates</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">eAxisState</span> <span class="o">:=</span> <span class="n">AxisState</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">BrakeMode</span> <span class="p">:</span> <span class="n">E_StageBrakeMode</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">BrakeMode</span>  <span class="o">:=</span> <span class="n">eBrakeMode</span> <span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">BrakeMode</span> <span class="p">:</span> <span class="n">E_StageBrakeMode</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">eBrakeMode</span>  <span class="o">:=</span> <span class="n">BrakeMode</span> <span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">BrakeRelease</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">BrakeRelease</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bBrakeRelease</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stagebrakemode">E_StageBrakeMode</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-brakenc-test">
<h2>FB_BrakeNC_Test<a class="headerlink" href="#fb-brakenc-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_BrakeNC_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_TestSuite</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">GivenBrakeModeIfEnabledThenOnlyReleaseBrakeWhenEnabled</span><span class="p">();</span>
<span class="n">GivenBrakeModeNoBrakeAlwaysReleaseBrake</span><span class="p">();</span>
<span class="n">GivenBrakeModeIfMovingThenOnlyReleaseBrakeWhenInMotion</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">GivenBrakeModeIfEnabledThenOnlyReleaseBrakeWhenEnabled</span>
<span class="n">VAR_INST</span>
    <span class="o">//</span> <span class="n">Subject</span> <span class="n">under</span> <span class="n">test</span>
    <span class="n">fbBrakeNC</span> <span class="p">:</span> <span class="n">FB_BrakeNC</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">__POUNAME</span><span class="p">());</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_DISABLED</span><span class="p">;</span>
<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeMode</span> <span class="o">:=</span> <span class="n">E_StageBrakeMode</span><span class="o">.</span><span class="n">IF_ENABLED</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
           <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #1&#39;</span><span class="p">);</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_ERRORSTOP</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
            <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #2&#39;</span><span class="p">);</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_UNDEFINED</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
            <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #3&#39;</span><span class="p">);</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_STANDSTILL</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
           <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #4&#39;</span><span class="p">);</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_CONTINOUSMOTION</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
           <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #5&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">GivenBrakeModeIfMovingThenOnlyReleaseBrakeWhenInMotion</span>
<span class="n">VAR_INST</span>
    <span class="o">//</span> <span class="n">Subject</span> <span class="n">under</span> <span class="n">test</span>
    <span class="n">fbBrakeNC</span> <span class="p">:</span> <span class="n">FB_BrakeNC</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">__POUNAME</span><span class="p">());</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_DISABLED</span><span class="p">;</span>
<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeMode</span> <span class="o">:=</span> <span class="n">E_StageBrakeMode</span><span class="o">.</span><span class="n">IF_MOVING</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
           <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #1&#39;</span><span class="p">);</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_ERRORSTOP</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
            <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #2&#39;</span><span class="p">);</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_UNDEFINED</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
            <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #3&#39;</span><span class="p">);</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_STANDSTILL</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
           <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #4&#39;</span><span class="p">);</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_CONTINOUSMOTION</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
           <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #5&#39;</span><span class="p">);</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_DISCRETEMOTION</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
           <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #6&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">GivenBrakeModeNoBrakeAlwaysReleaseBrake</span>
<span class="n">VAR_INST</span>
    <span class="o">//</span> <span class="n">Subject</span> <span class="n">under</span> <span class="n">test</span>
    <span class="n">fbBrakeNC</span> <span class="p">:</span> <span class="n">FB_BrakeNC</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">__POUNAME</span><span class="p">());</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_HOMING</span><span class="p">;</span>
<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeMode</span> <span class="o">:=</span> <span class="n">E_StageBrakeMode</span><span class="o">.</span><span class="n">NO_BRAKE</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
           <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #1&#39;</span><span class="p">);</span>

<span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">AxisState</span> <span class="o">:=</span> <span class="n">MC_AxisStates</span><span class="o">.</span><span class="n">MC_AXISSTATE_STOPPING</span><span class="p">;</span>

<span class="n">fbBrakeNC</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbBrakeNC</span><span class="o">.</span><span class="n">BrakeRelease</span><span class="p">,</span>
           <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Not correct brake #2&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stagebrakemode">E_StageBrakeMode</a></p></li>
<li><p><a class="reference internal" href="#fb-brakenc">FB_BrakeNC</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-calculatefrequency-3702-v0-01">
<h2>FB_CalculateFrequency_3702_v0_01<a class="headerlink" href="#fb-calculatefrequency-3702-v0-01" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_CalculateFrequency_3702_v0_01</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="o">///</span><span class="mi">200</span> <span class="n">samples</span><span class="o">/</span><span class="n">period</span>
    <span class="n">cBufferSize</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bCalculate</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">aBufferValue</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="p">(</span><span class="n">cBuffersize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="n">OF</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">aBufferDcTime</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="p">(</span><span class="n">cBuffersize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="n">OF</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">///</span><span class="n">If</span> <span class="n">curve</span> <span class="n">has</span> <span class="n">a</span> <span class="n">DC</span> <span class="n">offset</span>
    <span class="n">nDCOffset</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fActFrequency</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">nFirstZeroCrossing</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">nLastZeroCrossing</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">rTimeFirst</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rTimeLast</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rTimeRes</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nCrossings</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_TEMP</span>
    <span class="n">rRange</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rTimeSpan</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>
<span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">nCrossings</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">En</span> <span class="n">AND</span> <span class="n">bCalculate</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">Serach</span> <span class="k">for</span> <span class="n">crossings</span> <span class="n">of</span> <span class="n">nDCOffset</span>
    <span class="n">FOR</span> <span class="n">nIndex</span><span class="o">:=</span><span class="mi">1</span> <span class="n">TO</span> <span class="n">cBuffersize</span><span class="o">-</span><span class="mi">1</span> <span class="n">DO</span>
            <span class="n">IF</span><span class="p">((</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">&gt;</span><span class="n">nDCOffset</span> <span class="n">AND</span> <span class="n">aBufferValue</span><span class="p">[</span><span class="n">nIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">nDCOffset</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">&lt;</span><span class="n">nDCOffset</span> <span class="n">AND</span> <span class="n">aBufferValue</span><span class="p">[</span><span class="n">nIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">nDCOffset</span><span class="p">))</span>    <span class="n">THEN</span>
                    <span class="n">IF</span><span class="p">(</span><span class="n">nCrossings</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span>
                            <span class="n">nFirstZeroCrossing</span><span class="o">:=</span><span class="n">nIndex</span><span class="p">;</span>
                    <span class="n">END_IF</span>
                    <span class="n">nLastZeroCrossing</span><span class="o">:=</span><span class="n">nIndex</span><span class="p">;</span>
                    <span class="n">nCrossings</span><span class="o">:=</span><span class="n">nCrossings</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">END_FOR</span>

    <span class="n">IF</span> <span class="n">nFirstZeroCrossing</span> <span class="o">&lt;</span> <span class="n">nLastZeroCrossing</span>  <span class="n">AND</span>  <span class="n">nCrossings</span><span class="o">&gt;</span><span class="mi">2</span> <span class="n">THEN</span>
            <span class="o">//</span><span class="n">interpolate</span> <span class="n">zero</span> <span class="n">crossings</span> <span class="k">for</span> <span class="n">higher</span> <span class="n">accuracy</span>
            <span class="n">rTimeRes</span><span class="o">:=</span><span class="n">UDINT_TO_REAL</span><span class="p">(</span><span class="n">aBufferDcTime</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">aBufferDcTime</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="o">//</span><span class="n">Buffer</span> <span class="n">must</span> <span class="n">contain</span> <span class="n">more</span> <span class="n">than</span> <span class="mi">2</span> <span class="n">values</span>
            <span class="n">rRange</span><span class="o">:=</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nFirstZeroCrossing</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nFirstZeroCrossing</span><span class="p">]));</span>
            <span class="n">rTimeFirst</span><span class="o">:=</span><span class="n">UDINT_TO_REAL</span><span class="p">(</span> <span class="n">aBufferDcTime</span><span class="p">[</span><span class="n">nFirstZeroCrossing</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">ABS</span><span class="p">(</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nFirstZeroCrossing</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">rRange</span><span class="o">*</span><span class="n">rTimeRes</span><span class="p">);</span>
            <span class="n">rRange</span><span class="o">:=</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nLastZeroCrossing</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nLastZeroCrossing</span><span class="p">]));</span>
            <span class="n">rTimeLast</span><span class="o">:=</span><span class="n">UDINT_TO_REAL</span><span class="p">(</span> <span class="n">aBufferDcTime</span><span class="p">[</span><span class="n">nLastZeroCrossing</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">ABS</span><span class="p">(</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nLastZeroCrossing</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">rRange</span><span class="o">*</span><span class="n">rTimeRes</span><span class="p">);</span>

            <span class="o">//</span><span class="n">Time</span> <span class="n">span</span> <span class="n">first</span> <span class="n">to</span> <span class="n">last</span> <span class="p">(</span><span class="n">considering</span> <span class="n">that</span> <span class="nb">max</span> <span class="n">one</span> <span class="n">time</span> <span class="n">counter</span> <span class="n">overflow</span> <span class="n">have</span> <span class="n">occured</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">total</span> <span class="n">time</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">the</span> <span class="n">time</span> <span class="n">buffer</span><span class="p">)</span>
            <span class="n">IF</span> <span class="n">rTimeFirst</span><span class="o">&lt;</span><span class="n">rTimeLast</span> <span class="n">THEN</span>
                    <span class="n">rTimeSpan</span><span class="o">:=</span><span class="n">rTimeLast</span><span class="o">-</span><span class="n">rTimeFirst</span><span class="p">;</span>
            <span class="n">ELSE</span> <span class="o">//</span><span class="n">overflow</span> <span class="n">of</span> <span class="n">counter</span> <span class="n">once</span> <span class="p">(</span><span class="n">only</span> <span class="mi">32</span><span class="n">bit</span> <span class="n">timestamp</span> <span class="o">=</span><span class="mf">4.29</span><span class="n">seconds</span><span class="p">)</span>
                    <span class="n">rTimeSpan</span><span class="o">:=</span><span class="mf">4294967296.0</span><span class="o">-</span><span class="n">rTimeFirst</span><span class="o">+</span><span class="n">rTimeLast</span><span class="p">;</span>
            <span class="n">END_IF</span>

            <span class="n">fActFrequency</span><span class="o">:=</span><span class="mf">1000000000.0</span><span class="o">/</span><span class="n">rTimeSpan</span><span class="o">*</span><span class="p">(</span><span class="n">nCrossings</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="o">//</span><span class="n">two</span> <span class="n">crossings</span> <span class="n">per</span> <span class="n">period</span> <span class="o">=&gt;</span> <span class="n">Average</span> <span class="n">frequency</span> <span class="n">over</span> <span class="n">buffer</span><span class="o">.</span>
    <span class="n">ELSE</span>
            <span class="n">fActFrequency</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-causencerror">
<h2>FB_CauseNCError<a class="headerlink" href="#fb-causencerror" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_CauseNCError</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Simulate</span> <span class="n">an</span> <span class="n">NC</span> <span class="n">error</span><span class="o">.</span>
    <span class="n">This</span> <span class="n">will</span> <span class="n">look</span> <span class="n">like</span> <span class="n">a</span> <span class="n">real</span> <span class="n">NC</span> <span class="n">error</span> <span class="k">for</span> <span class="n">everyone</span><span class="p">,</span> <span class="n">including</span> <span class="n">TwinCAT</span> <span class="n">itself</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorCode</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">adsWrite</span><span class="p">:</span> <span class="n">ADSWRITE</span><span class="p">;</span>
    <span class="n">mcReadDriveAddress</span><span class="p">:</span> <span class="n">MC_ReadDriveAddress</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">bBusy</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">mcReadDriveAddress</span><span class="o">.</span><span class="n">Done</span> <span class="n">THEN</span>
    <span class="n">mcReadDriveAddress</span><span class="p">(</span>
        <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
        <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">DriveAddress</span><span class="o">=&gt;</span><span class="n">Axis</span><span class="o">.</span><span class="n">DriveAddress</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">bBusy</span> <span class="n">AND</span> <span class="n">mcReadDriveAddress</span><span class="o">.</span><span class="n">Done</span> <span class="n">THEN</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">adsWrite</span><span class="p">(</span>
        <span class="n">PORT</span><span class="o">:=</span><span class="mi">501</span><span class="p">,</span>
        <span class="n">IDXGRP</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4200 + Axis.DriveAddress.NcDriveId,</span>
        <span class="n">IDXOFFS</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#0019,</span>
        <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nErrorCode</span><span class="p">),</span>
        <span class="n">SRCADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nErrorCode</span><span class="p">),</span>
        <span class="n">WRITE</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">BUSY</span><span class="o">=&gt;</span><span class="n">bBusy</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">adsWrite</span><span class="p">(</span><span class="n">WRITE</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-drivevirtual">
<h2>FB_DriveVirtual<a class="headerlink" href="#fb-drivevirtual" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="c1">#########################################################</span>
<span class="o">///</span><span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">run</span> <span class="n">a</span> <span class="n">virtual</span> <span class="n">drive</span> <span class="k">with</span> <span class="n">Nc</span>
<span class="o">///</span> <span class="n">Library</span><span class="p">:</span>
<span class="o">///</span> <span class="n">Tc2_MC2</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Global</span> <span class="n">Variables</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Data</span> <span class="n">types</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">External</span> <span class="n">functions</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span><span class="c1">###########################################################</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_DriveVirtual</span>
<span class="n">VAR</span>
    <span class="n">sVersion</span><span class="p">:</span> <span class="n">STRING</span><span class="o">:=</span><span class="s1">&#39;1.0.3&#39;</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">/////</span>   <span class="n">nCommandLocal</span><span class="o">...</span>
    <span class="o">/////</span>   <span class="mi">0</span> <span class="o">=</span> <span class="n">Jog</span>
    <span class="o">/////</span>   <span class="mi">1</span> <span class="o">=</span> <span class="n">MoveVelocity</span>
    <span class="o">/////</span>   <span class="mi">2</span> <span class="o">=</span> <span class="n">MoveRelative</span>
    <span class="o">/////</span>   <span class="mi">3</span> <span class="o">=</span> <span class="n">MoveAbsolut</span>
    <span class="o">/////</span>   <span class="mi">4</span> <span class="o">=</span> <span class="n">MoveModulo</span>
    <span class="o">/////</span>   <span class="mi">10</span> <span class="o">=</span> <span class="n">Homing</span>
    <span class="o">/////</span>   <span class="mi">20</span> <span class="o">=</span> <span class="n">SuperInp</span> <span class="o">&gt;&gt;&gt;</span><span class="n">ToBe</span>
    <span class="o">/////</span>   <span class="mi">30</span> <span class="o">=</span> <span class="n">Gear</span>
    <span class="n">nCommand</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fAcceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fDeceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bJogFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bJogBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fOverride</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">bHomeSensor</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fHomePosition</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nHomeRevOffset</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">MasterAxis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">bPowerSelf</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomed</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nMotionAxisID</span><span class="p">:</span><span class="n">UDINT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>  <span class="o">//</span><span class="n">Axis</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">Motion</span> <span class="p">(</span><span class="n">NC</span><span class="p">)</span>
    <span class="n">Status</span><span class="p">:</span> <span class="n">ST_AxisStatus</span><span class="p">;</span>
    <span class="n">fActVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fActPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fActDiff</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">sErrorMessage</span><span class="p">:</span><span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nCommandLocal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nCmdDataLocal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bFirstScan</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fbReset</span><span class="p">:</span> <span class="n">MC_Reset</span><span class="p">;</span>
    <span class="n">fbPower</span><span class="p">:</span> <span class="n">MC_Power</span><span class="p">;</span>
    <span class="n">fbHalt</span><span class="p">:</span> <span class="n">MC_Halt</span><span class="p">;</span>
    <span class="n">fbJog</span><span class="p">:</span> <span class="n">MC_Jog</span><span class="p">;</span>
    <span class="n">fbMoveVelocity</span><span class="p">:</span> <span class="n">MC_MoveVelocity</span><span class="p">;</span>
    <span class="n">fbMoveRelative</span><span class="p">:</span> <span class="n">MC_MoveRelative</span><span class="p">;</span>
    <span class="n">fbMoveAbsolute</span><span class="p">:</span> <span class="n">MC_MoveAbsolute</span><span class="p">;</span>
    <span class="n">fbMoveModulo</span><span class="p">:</span> <span class="n">MC_MoveModulo</span><span class="p">;</span>
    <span class="n">fbHomeVirtual</span><span class="p">:</span><span class="n">FB_HomeVirtual</span><span class="p">;</span>
    <span class="n">fbGearInDyn</span><span class="p">:</span> <span class="n">MC_GearInDyn</span><span class="p">;</span>
    <span class="n">fbGearOut</span><span class="p">:</span> <span class="n">MC_GearOut</span><span class="p">;</span>
    <span class="n">fbExecuteRiseEdge</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">stAxisStatus</span><span class="p">:</span> <span class="n">DUT_AxisStatus_v0_01</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Transfer</span> <span class="n">nCommand</span> <span class="ow">and</span> <span class="n">nCmdData</span> <span class="n">to</span> <span class="n">local</span> <span class="n">copies</span> <span class="n">at</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">of</span> <span class="n">bExecute</span> <span class="p">(</span><span class="n">avoid</span> <span class="n">issues</span> <span class="k">if</span> <span class="n">nCommand</span> <span class="ow">or</span> <span class="n">nCmdData</span> <span class="n">are</span> <span class="n">changed</span> <span class="n">during</span> <span class="n">a</span> <span class="n">command</span><span class="p">)</span>
<span class="n">fbExecuteRiseEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbExecuteRiseEdge</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
  <span class="n">nCmdDataLocal</span><span class="o">:=</span><span class="n">nCmdData</span><span class="p">;</span>
  <span class="n">nCommandLocal</span><span class="o">:=</span><span class="n">nCommand</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bHomed</span><span class="o">:=</span><span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bHomed</span><span class="p">;</span> <span class="o">//</span><span class="n">Add</span> <span class="ow">in</span> <span class="n">DUT_AxisStatus</span> <span class="n">later</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Reset</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbReset</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bReset</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">Power</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">bPowerSelf</span> <span class="n">THEN</span>
<span class="n">fbPower</span><span class="p">(</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Enable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">,</span>
    <span class="n">Enable_Positive</span><span class="o">:=</span><span class="n">bEnable</span> <span class="n">AND</span> <span class="n">bLimitFwd</span><span class="p">,</span>
    <span class="n">Enable_Negative</span><span class="o">:=</span><span class="n">bEnable</span> <span class="n">AND</span> <span class="n">bLimitBwd</span><span class="p">,</span>
    <span class="n">Override</span><span class="o">:=</span><span class="n">fOverride</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Status</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Halt</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbHalt</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bExecute</span>  <span class="n">AND</span> <span class="p">(((</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="n">fbPower</span><span class="o">.</span><span class="n">Busy</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">10</span><span class="p">))),</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span> <span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">Jog</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbJog</span><span class="p">(</span>
    <span class="n">JogForward</span><span class="o">:=</span><span class="n">bJogFwd</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">,</span>
    <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">bJogBwd</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">,</span>
    <span class="n">Mode</span><span class="o">:=</span><span class="n">UINT_TO_INT</span><span class="p">(</span><span class="n">nCmdDataLocal</span><span class="p">),</span>
    <span class="n">Position</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">MoveVelocity</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbMoveVelocity</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fVelocity</span><span class="p">),</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">Direction</span><span class="o">:=</span><span class="n">SEL</span><span class="p">(</span><span class="n">fVelocity</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">MC_Positive_Direction</span><span class="p">,</span> <span class="n">MC_Negative_Direction</span><span class="p">),</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">InVelocity</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">MoveRelative</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbMoveRelative</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">Distance</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fVelocity</span><span class="p">),</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="n">IF</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">2</span> <span class="n">THEN</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">MoveAbsolute</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbMoveAbsolute</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">Position</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fVelocity</span><span class="p">),</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="n">IF</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">3</span> <span class="n">THEN</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">MoveModulo</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbMoveModulo</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
    <span class="n">Position</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fVelocity</span><span class="p">),</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">Direction</span><span class="o">:=</span><span class="n">UINT_TO_INT</span><span class="p">(</span><span class="n">nCmdDataLocal</span><span class="p">),</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="n">IF</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">4</span> <span class="n">THEN</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Home</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbHomeVirtual</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">10</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">fHomePosition</span><span class="o">:=</span><span class="n">fHomePosition</span><span class="p">,</span>
    <span class="n">bHomeSensor</span><span class="o">:=</span><span class="n">bHomeSensor</span><span class="p">,</span>
    <span class="n">bLimitBwd</span><span class="o">:=</span><span class="n">bLimitBwd</span><span class="p">,</span>
    <span class="n">bLimitFwd</span><span class="o">:=</span><span class="n">bLimitFwd</span><span class="p">,</span>
    <span class="n">nCmdData</span><span class="o">:=</span><span class="n">nCmdDataLocal</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
    <span class="n">nHomeRevOffset</span><span class="o">:=</span><span class="n">nHomeRevOffset</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
    <span class="p">);</span>

<span class="n">IF</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">10</span> <span class="n">THEN</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bDone</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Gear</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbGearInDyn</span><span class="p">(</span>
    <span class="n">Enable</span><span class="o">:=</span><span class="n">bExecute</span>  <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
    <span class="n">GearRatio</span><span class="o">:=</span><span class="n">SEL</span><span class="p">(</span><span class="n">nCmdDataLocal</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">fVelocity</span><span class="p">),</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Master</span><span class="o">:=</span><span class="n">MasterAxis</span><span class="p">,</span>
    <span class="n">Slave</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">InGear</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="n">fbGearOut</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
    <span class="n">Slave</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span><span class="p">);</span>


<span class="n">IF</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">30</span> <span class="n">THEN</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Coupled</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Busy</span><span class="o">*</span><span class="p">)</span>
<span class="n">bBusy</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">HasJob</span> <span class="n">OR</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">HomingBusy</span> <span class="n">OR</span> <span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Enabled</span><span class="o">*</span><span class="p">)</span>
<span class="n">bEnabled</span><span class="o">:=</span><span class="n">fbPower</span><span class="o">.</span><span class="n">Status</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="kn">from</span><span class="w"> </span><span class="nn">functions</span> <span class="ow">and</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">fbPower</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">fbPower</span><span class="o">.</span><span class="n">Active</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbPower</span><span class="o">.</span><span class="n">Enable</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbPower</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbHalt</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">fbHalt</span><span class="o">.</span><span class="n">Active</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbHalt</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHalt</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">0</span> <span class="p">(</span><span class="o">*</span><span class="n">fbJog</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbJog</span><span class="o">.</span><span class="n">JogForward</span> <span class="n">OR</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">JogBackwards</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbJog</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">1</span><span class="p">(</span><span class="o">*</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">2</span> <span class="p">(</span><span class="o">*</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">3</span> <span class="p">(</span><span class="o">*</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">4</span> <span class="p">(</span><span class="o">*</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">10</span> <span class="p">(</span><span class="o">*</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">nErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbGearInDyn</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">30</span> <span class="p">(</span><span class="o">*</span><span class="n">fbGearInDyn</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbGearInDyn</span><span class="o">.</span><span class="n">Enable</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbGearInDyn</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbGearOut</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">30</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Coupled</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbGearOut</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbGearOut</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span>  <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Converese</span> <span class="n">nErrorID</span> <span class="n">to</span> <span class="n">string</span><span class="o">*</span><span class="p">)</span>
<span class="n">sErrorMessage</span><span class="o">:=</span><span class="n">WORD_TO_HEXSTR</span><span class="p">(</span><span class="ow">in</span><span class="o">:=</span><span class="n">TO_WORD</span><span class="p">(</span><span class="n">nErrorID</span><span class="p">)</span> <span class="p">,</span> <span class="n">iPrecision</span><span class="o">:=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bLoCase</span><span class="o">:=</span><span class="mi">0</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">Status</span> <span class="kn">from</span><span class="w"> </span><span class="nn">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">Status</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Axis</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">motion</span> <span class="s2">&quot;motor&quot;</span><span class="o">*</span><span class="p">)</span>
<span class="n">nMotionAxisID</span><span class="o">:=</span><span class="n">axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Actual</span> <span class="n">Velocity</span><span class="o">*</span><span class="p">)</span>
<span class="n">fActVelocity</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActVelo</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Actual</span> <span class="n">Position</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">OpMode</span><span class="o">.</span><span class="n">Modulo</span> <span class="n">THEN</span>
    <span class="n">fActPosition</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ModuloActPos</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">fActPosition</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Actual</span> <span class="n">Position</span><span class="o">*</span><span class="p">)</span>
<span class="n">fActDiff</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">PosDiff</span><span class="p">;</span>


<span class="o">//</span><span class="n">Status</span> <span class="n">struct</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">communication</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bEnabled</span><span class="o">:=</span><span class="n">bEnabled</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bError</span><span class="o">:=</span><span class="n">bError</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bHomeSensor</span><span class="o">:=</span><span class="n">bHomeSensor</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bJogBwd</span><span class="o">:=</span><span class="n">bJogBwd</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bJogFwd</span><span class="o">:=</span><span class="n">bJogFwd</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bLimitBwd</span><span class="o">:=</span><span class="n">bLimitBwd</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bLimitFwd</span><span class="o">:=</span><span class="n">bLimitFwd</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fAcceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActDiff</span><span class="o">:=</span><span class="n">fActDiff</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="o">:=</span><span class="n">fActPosition</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActVelocity</span><span class="o">:=</span><span class="n">fActVelocity</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fDeceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fOverride</span><span class="o">:=</span><span class="n">fOverride</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fPosition</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fVelocity</span><span class="o">:=</span><span class="n">fVelocity</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">nCmdData</span><span class="o">:=</span><span class="n">nCmdData</span><span class="p">;</span>  <span class="o">//</span><span class="n">Or</span> <span class="n">nCmdDataLocal</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">nCommand</span><span class="o">:=</span><span class="n">nCommand</span><span class="p">;</span>  <span class="o">//</span><span class="n">Or</span> <span class="n">nCommandLocal</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">nErrorId</span><span class="o">:=</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bBusy</span><span class="o">:=</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bHomed</span><span class="o">:=</span><span class="n">bHomed</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bFirstScan</span> <span class="n">THEN</span>
    <span class="n">bFirstScan</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-axisstatus-v0-01">DUT_AxisStatus_v0_01</a></p></li>
<li><p><a class="reference internal" href="#fb-homevirtual">FB_HomeVirtual</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-el1252asm-v1-00">
<h2>FB_EL1252ASM_v1_00<a class="headerlink" href="#fb-el1252asm-v1-00" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_EL1252ASM_v1_00
VAR_INPUT
    En: BOOL;
END_VAR
VAR_OUTPUT
    EnO: BOOL;
    Di_1: BOOL;
    Di_2: BOOL;
    Di_1_LatchTimePos: ULINT;
    Di_2_LatchTimePos: ULINT;
    Di_1_LatchTimeNeg: ULINT;
    Di_2_LatchTimeNeg: ULINT;
    ///Below bits can be used but then they must be enabled in the COE of the card. Nicklas suggested to not use these (since something wss written that you then only were allowed to read the latch time onece (some kkind of auto reset??))
    ///Di_1_LatchNeg:BOOL;
    ///     Di_1_LatchPos:BOOL;
    ///     Di_2_LatchNeg:BOOL;
    ///     Di_2_LatchPos:BOOL;
    Error: BOOL;
END_VAR
VAR
    Channel_1_Input AT %I*: BOOL;
    Channel_2_Input AT %I*: BOOL;
    ///Latch_Status1 AT %I*: USINT;
    ///     Latch_Status2 AT %I*: USINT;
    Latch_LatchPos1 AT %I*: ULINT;
    Latch_LatchNeg1 AT %I*: ULINT;
    Latch_LatchPos2 AT %I*: ULINT;
    Latch_LatchNeg2 AT %I*: ULINT;
    WcState_WcState AT %I*: BOOL;
    InfoData_State AT %I*: UINT;
END_VAR
EnO:=En;

IF En AND (WcState_WcState OR InfoData_State&lt;&gt;16#8) THEN //InfoData_State==0 =&gt; in OP mode
    Error:=TRUE;
ELSE
    Error:=FALSE;
END_IF

IF En THEN
    IF Error=FALSE THEN
            Di_1:=Channel_1_Input;
            Di_2:=Channel_2_Input;
    (*      Di_1_LatchPos:=Latch_Status1.0;
            Di_1_LatchNeg:=Latch_Status1.1;
            Di_2_LatchPos:=Latch_Status2.0;
            Di_2_LatchNeg:=Latch_Status2.1;*)
            Di_1_LatchTimePos:=Latch_LatchPos1;
            Di_2_LatchTimePos:=Latch_LatchPos2;
            Di_1_LatchTimeNeg:=Latch_LatchNeg1;
            Di_2_LatchTimeNeg:=Latch_LatchNeg2;

    ELSE
            Di_1:=FALSE;
            Di_2:=FALSE;
    END_IF
END_IF

END_FUNCTION_BLOCK
</pre></div>
</div>
</section>
<section id="fb-encerrorffo">
<h2>FB_EncErrorFFO<a class="headerlink" href="#fb-encerrorffo" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EncErrorFFO</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Example</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">FB_NCErrorFFO</span> <span class="n">that</span> <span class="n">only</span> <span class="n">counts</span> <span class="n">encoder</span> <span class="n">errors</span> <span class="k">as</span> <span class="n">faults</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motion</span> <span class="n">stage</span> <span class="n">to</span> <span class="n">monitor</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">FFO</span> <span class="n">to</span> <span class="n">trip</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">fault</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Auto</span> <span class="n">reset</span> <span class="n">the</span> <span class="n">fault</span>
    <span class="n">bAutoReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Quick</span> <span class="n">way</span> <span class="k">for</span> <span class="n">nearby</span> <span class="n">code</span> <span class="n">to</span> <span class="n">check</span> <span class="k">if</span> <span class="n">this</span> <span class="n">block</span> <span class="n">has</span> <span class="n">tripped</span> <span class="n">the</span> <span class="n">FFO</span><span class="o">.</span>
    <span class="n">bTripped</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbNCErrorFFO</span><span class="p">:</span> <span class="n">FB_NCErrorFFO</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">nLowErrorId</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#4400,</span>
        <span class="n">nHighErrorId</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#44FF,</span>
        <span class="n">sDesc</span> <span class="o">:=</span> <span class="s1">&#39;Encoder error&#39;</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">fbNCErrorFFO</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">bReset</span><span class="p">,</span>
    <span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">bAutoReset</span><span class="p">,</span>
    <span class="n">bTripped</span> <span class="o">=&gt;</span> <span class="n">bTripped</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-ncerrorffo">FB_NCErrorFFO</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-encoderscaling">
<h2>FB_EncoderScaling<a class="headerlink" href="#fb-encoderscaling" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EncoderScaling</span> <span class="n">IMPLEMENTS</span> <span class="n">I_EncoderScaling</span>
<span class="n">VAR</span>
    <span class="n">nRawEncoderULINT</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Raw</span> <span class="n">encoder</span> <span class="n">IO</span> <span class="k">for</span> <span class="n">UINT</span> <span class="p">(</span><span class="n">Relative</span> <span class="n">Encoders</span><span class="p">)</span>
    <span class="n">nRawEncoderUINT</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Raw</span> <span class="n">encoder</span> <span class="n">IO</span> <span class="k">for</span> <span class="n">INT</span> <span class="p">(</span><span class="n">LVDT</span><span class="p">)</span>
    <span class="n">nRawEncoderINT</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Raw</span> <span class="n">encoder</span> <span class="n">IO</span> <span class="k">for</span> <span class="n">INT</span> <span class="p">(</span><span class="n">EL5072</span> <span class="n">LVDT</span><span class="p">)</span>
    <span class="n">nRawEncoderDINT</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">count</span> <span class="n">summary</span><span class="p">,</span> <span class="k">if</span> <span class="n">linked</span> <span class="n">above</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">nEncoderCount</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Count</span> <span class="kn">from</span><span class="w"> </span><span class="nn">encoder</span> <span class="n">hardware</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncoderCount</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">nRawEncoderULINT</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">nRawEncoderULINT</span> <span class="o">&lt;</span> <span class="mi">4294967296</span> <span class="n">THEN</span>
        <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">nRawEncoderULINT</span><span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="mi">18446744073709551615</span> <span class="o">-</span> <span class="n">nRawEncoderULINT</span><span class="p">);</span>
    <span class="n">END_IF</span>
<span class="n">ELSIF</span> <span class="n">nRawEncoderUINT</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">UINT_TO_UDINT</span><span class="p">(</span><span class="n">nRawEncoderUINT</span><span class="p">);</span>
<span class="n">ELSIF</span> <span class="n">nRawEncoderINT</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">INT_TO_UDINT</span><span class="p">(</span><span class="n">nRawEncoderINT</span><span class="p">);</span>
<span class="n">ELSIF</span> <span class="n">nRawEncoderDINT</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">DINT_TO_UDINT</span><span class="p">(</span><span class="n">nRawEncoderDINT</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">EncoderScaling</span> <span class="p">:</span> <span class="n">UDINT</span>

<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">EncoderCount</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">EncoderCount</span> <span class="o">:=</span> <span class="n">nEncoderCount</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
</section>
<section id="fb-encodervalue">
<h2>FB_EncoderValue<a class="headerlink" href="#fb-encodervalue" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EncoderValue</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Process</span> <span class="n">the</span> <span class="n">encoder</span> <span class="n">value</span> <span class="k">for</span> <span class="n">ST_MotionStage</span>

    <span class="n">A</span> <span class="n">few</span> <span class="n">different</span> <span class="n">problems</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">solve</span><span class="p">:</span>
        <span class="mf">1.</span> <span class="n">Different</span> <span class="n">encoders</span> <span class="n">show</span> <span class="k">as</span> <span class="n">different</span> <span class="n">types</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">IO</span><span class="p">,</span>
           <span class="n">but</span> <span class="n">we</span> <span class="n">want</span> <span class="n">a</span> <span class="n">consistent</span> <span class="nb">type</span> <span class="k">for</span> <span class="n">checks</span> <span class="ow">and</span> <span class="k">for</span> <span class="n">PVs</span>
        <span class="mf">2.</span> <span class="n">Some</span> <span class="n">inverted</span> <span class="n">encoders</span> <span class="n">display</span> <span class="k">as</span> <span class="n">very</span> <span class="n">high</span> <span class="n">numbers</span>
           <span class="k">as</span> <span class="n">they</span> <span class="n">count</span> <span class="n">down</span> <span class="kn">from</span><span class="w"> </span><span class="nn">max</span> <span class="nb">int</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">up</span> <span class="kn">from</span><span class="w"> </span><span class="mi">0</span>
        <span class="mf">3.</span> <span class="n">Some</span> <span class="n">encoders</span> <span class="n">have</span> <span class="n">raw</span> <span class="n">signed</span> <span class="n">values</span><span class="p">,</span> <span class="n">others</span> <span class="n">unsigned</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">this</span> <span class="n">end</span><span class="p">,</span> <span class="n">we</span> <span class="n">figure</span> <span class="n">out</span> <span class="n">which</span> <span class="n">encoder</span> <span class="ow">is</span> <span class="n">linked</span> <span class="ow">and</span> <span class="n">process</span>
    <span class="n">the</span> <span class="n">value</span> <span class="n">appropriately</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderULINT</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderULINT</span> <span class="o">&lt;</span> <span class="mi">4294967296</span> <span class="n">THEN</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="mi">18446744073709551615</span> <span class="o">-</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="p">);</span>
    <span class="n">END_IF</span>
<span class="n">ELSIF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderUINT</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">UINT_TO_UDINT</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderUINT</span><span class="p">);</span>
<span class="n">ELSIF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderINT</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">INT_TO_UDINT</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderINT</span><span class="p">);</span>
<span class="n">ELSIF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderDINT</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">DINT_TO_UDINT</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderDINT</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-encsaverestore">
<h2>FB_EncSaveRestore<a class="headerlink" href="#fb-encsaverestore" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EncSaveRestore</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbSetPos</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">timer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLoad</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nLatchError</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">bEncError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tRetryDelay</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1s;</span>
    <span class="n">nMaxRetries</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">nCurrTries</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bWaitRetry</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tonRetry</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">PERSISTENT</span>
    <span class="n">bSaved</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Trigger</span> <span class="n">a</span> <span class="n">load</span> <span class="k">if</span> <span class="n">anything</span> <span class="n">was</span> <span class="n">saved</span> <span class="n">at</span> <span class="nb">all</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
        <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bLoad</span> <span class="n">S</span><span class="o">=</span> <span class="n">bSaved</span><span class="p">;</span>
        <span class="n">fbSetPos</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">ClearPositionLag</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="o">//</span> <span class="n">Set</span> <span class="n">our</span> <span class="n">position</span> <span class="k">if</span> <span class="n">bLoad</span> <span class="ow">is</span> <span class="n">true</span>
    <span class="n">fbSetPos</span><span class="p">(</span>
        <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
        <span class="n">Execute</span><span class="o">:=</span><span class="n">bLoad</span><span class="p">,</span>
        <span class="n">Position</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">Only</span> <span class="n">load</span> <span class="n">once</span><span class="p">,</span> <span class="n">at</span> <span class="n">startup</span>
    <span class="n">bLoad</span> <span class="n">R</span><span class="o">=</span> <span class="n">fbSetPos</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">fbSetPos</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>

    <span class="n">IF</span> <span class="n">fbSetPos</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
        <span class="o">//</span> <span class="n">Keep</span> <span class="n">the</span> <span class="n">error</span> <span class="n">latched</span><span class="p">,</span> <span class="n">it</span> <span class="n">can</span> <span class="n">disappear</span> <span class="k">if</span> <span class="n">Execute</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">FALSE</span>
        <span class="n">nLatchError</span> <span class="o">:=</span> <span class="n">fbSetPos</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
        <span class="n">nCurrTries</span> <span class="o">:=</span> <span class="n">nCurrTries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">nCurrTries</span> <span class="o">&gt;=</span> <span class="n">nMaxRetries</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">Alert</span> <span class="n">the</span> <span class="n">user</span> <span class="n">that</span> <span class="n">something</span> <span class="n">has</span> <span class="n">gone</span> <span class="n">wrong</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">nLatchError</span><span class="p">;</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Error loading previously saved position.&#39;</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">FB</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">retry</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                <span class="n">Position</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">);</span>
            <span class="o">//</span> <span class="n">Try</span> <span class="n">again</span>
            <span class="n">bWaitRetry</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="n">tonRetry</span><span class="p">(</span>
        <span class="n">IN</span> <span class="o">:=</span> <span class="n">bWaitRetry</span><span class="p">,</span>
        <span class="n">PT</span> <span class="o">:=</span> <span class="n">tRetryDelay</span><span class="p">);</span>

    <span class="n">bLoad</span> <span class="n">S</span><span class="o">=</span> <span class="n">tonRetry</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
    <span class="n">bWaitRetry</span> <span class="n">R</span><span class="o">=</span> <span class="n">tonRetry</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Check</span> <span class="n">ST_MotionStage</span> <span class="k">for</span> <span class="n">an</span> <span class="n">encoder</span> <span class="n">error</span> <span class="p">(</span><span class="nb">range</span> <span class="mh">0x44</span><span class="n">nn</span><span class="p">)</span>
    <span class="n">bEncError</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="c1">#4400 AND stMotionStage.nErrorId &lt;= 16#44FF;</span>

    <span class="o">//</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">save</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re currently loading or if there is an encoder error</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLoad</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bEncError</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bWaitRetry</span> <span class="n">THEN</span>
        <span class="n">fPosition</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">This</span> <span class="n">persistent</span> <span class="n">variable</span> <span class="n">lets</span> <span class="n">us</span> <span class="n">check</span> <span class="k">if</span> <span class="n">anything</span> <span class="n">was</span> <span class="n">saved</span>
        <span class="o">//</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">TRUE</span> <span class="n">at</span> <span class="n">startup</span> <span class="k">if</span> <span class="n">we</span> <span class="n">have</span> <span class="n">saved</span> <span class="n">values</span>
        <span class="n">bSaved</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-epicsinout">
<h2>FB_EpicsInOut<a class="headerlink" href="#fb-epicsinout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionState1D_InOut instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EpicsInOut</span>
<span class="o">//</span> <span class="n">Example</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">FB_PositionStateManager</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">IN</span><span class="o">/</span><span class="n">OUT</span> <span class="n">axis</span><span class="o">.</span> <span class="n">See</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">comments</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Also</span> <span class="n">usable</span> <span class="k">as</span> <span class="n">a</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">these</span> <span class="n">cases</span> <span class="p">(</span><span class="n">no</span> <span class="n">need</span> <span class="n">to</span> <span class="n">roll</span> <span class="n">your</span> <span class="n">own</span> <span class="ow">in</span><span class="o">/</span><span class="n">out</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motor</span> <span class="n">to</span> <span class="n">apply</span> <span class="n">states</span> <span class="n">to</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">position</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">pragma</span> <span class="n">these</span><span class="p">,</span> <span class="n">let</span> <span class="n">it</span> <span class="n">happen</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">manager</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">IN</span> <span class="n">parameter</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">will</span> <span class="n">be</span> <span class="n">moved</span> <span class="n">when</span> <span class="n">enumSet</span> <span class="ow">is</span> <span class="n">changed</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">When</span> <span class="n">changed</span><span class="p">,</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">destination</span> <span class="ow">and</span> <span class="n">starts</span> <span class="n">a</span> <span class="n">move</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumSet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumSet</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">error</span> <span class="n">state</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">pragma</span> <span class="n">these</span><span class="p">,</span> <span class="n">already</span> <span class="n">has</span> <span class="n">pragma</span> <span class="ow">in</span> <span class="n">manager</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Message</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">bError</span> <span class="o">=</span> <span class="n">TRUE</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="n">currently</span> <span class="n">moving</span> <span class="n">between</span> <span class="n">states</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">asked</span> <span class="k">for</span> <span class="n">a</span> <span class="n">move</span> <span class="n">between</span> <span class="n">states</span><span class="p">,</span> <span class="n">it</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">,</span> <span class="ow">and</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">ongoing</span> <span class="n">move</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">readback</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumGet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumGet</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..15</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbStateManager</span><span class="p">:</span> <span class="n">FB_PositionStateManager</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">up</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">PVs</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Fist</span> <span class="n">cycle</span> <span class="n">setup</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
    <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Stuff</span> <span class="n">first</span> <span class="n">two</span> <span class="n">values</span> <span class="n">of</span> <span class="n">the</span> <span class="mi">15</span> <span class="n">element</span> <span class="n">array</span> <span class="k">for</span> <span class="n">the</span> <span class="n">manager</span>
<span class="n">arrStates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
<span class="n">arrStates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">function</span> <span class="n">block</span> <span class="n">every</span> <span class="n">cycle</span>
<span class="n">fbStateManager</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">arrStates</span> <span class="o">:=</span> <span class="n">arrStates</span><span class="p">,</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">,</span>
    <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">bEnable</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
    <span class="n">nErrorId</span> <span class="o">=&gt;</span> <span class="n">nErrorId</span><span class="p">,</span>
    <span class="n">sErrorMessage</span> <span class="o">=&gt;</span> <span class="n">sErrorMessage</span><span class="p">,</span>
    <span class="n">bBusy</span> <span class="o">=&gt;</span> <span class="n">bBusy</span><span class="p">,</span>
    <span class="n">bDone</span> <span class="o">=&gt;</span> <span class="n">bDone</span><span class="p">,</span>
    <span class="n">getState</span> <span class="o">=&gt;</span> <span class="n">enumGet</span><span class="p">);</span> <span class="o">//</span> <span class="n">Cannot</span> <span class="n">do</span> <span class="n">this</span> <span class="n">assignment</span> <span class="k">if</span> <span class="n">enumGet</span> <span class="n">has</span> <span class="n">attribute</span> <span class="n">strict</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-epicsinout-int">ENUM_EpicsInOut_INT</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemanager">FB_PositionStateManager</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-errorlist">
<h2>FB_ErrorList<a class="headerlink" href="#fb-errorlist" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ErrorList</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                                                                      <span class="o">//</span><span class="n">Enable</span> <span class="nb">input</span>
    <span class="n">bReset</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                                                          <span class="o">//</span><span class="n">Delete</span> <span class="nb">all</span> <span class="n">Error</span> <span class="n">entry</span>
    <span class="n">lErrorID</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>                                                                       <span class="o">//</span><span class="n">ErrorID</span> <span class="n">to</span> <span class="n">be</span> <span class="n">acknoledged</span>
    <span class="n">bACK</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                                                            <span class="o">//</span><span class="n">Acknoledge</span> <span class="n">the</span> <span class="n">given</span> <span class="n">error</span> <span class="ow">and</span> <span class="n">delete</span> <span class="n">it</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="nb">list</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                                                                     <span class="o">//</span><span class="n">Enable</span> <span class="n">output</span>
    <span class="n">nNoError</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                                                                         <span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">Errors</span>
    <span class="n">nNoOverflow</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>                                                                      <span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">Overflows</span>
    <span class="n">pErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>                       <span class="o">//</span><span class="n">Pointer</span> <span class="n">to</span> <span class="n">ErrorSystem</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">nFreePos</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                                                                        <span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">free</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">list</span>
    <span class="n">nListCnt1</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                                                                       <span class="o">//</span><span class="n">work</span> <span class="n">variable</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>                                           <span class="o">//</span><span class="n">Data</span> <span class="n">structure</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Error</span> <span class="nb">list</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="o">================================================================================</span>
<span class="o">*</span>                                   <span class="n">DESCRIPTION</span>
<span class="o">*</span> <span class="o">================================================================================</span>
<span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">implements</span> <span class="n">the</span> <span class="n">core</span> <span class="n">structure</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Error</span><span class="o">/</span><span class="ne">Warning</span> <span class="n">Handling</span>
<span class="o">*</span> <span class="n">system</span><span class="o">.</span> <span class="n">It</span> <span class="n">realizes</span> <span class="n">the</span> <span class="n">datastructure</span> <span class="n">containing</span> <span class="n">every</span> <span class="n">Error</span> <span class="n">Entry</span><span class="p">,</span> <span class="n">collect</span>
<span class="o">*</span> <span class="n">statistics</span> <span class="n">about</span> <span class="n">the</span> <span class="n">usage</span> <span class="ow">and</span> <span class="n">manage</span> <span class="n">the</span> <span class="n">Error</span> <span class="n">Entries</span><span class="o">.</span>
<span class="o">*</span> <span class="n">Note</span><span class="p">:</span> <span class="n">The</span> <span class="n">system</span> <span class="ow">is</span> <span class="n">under</span> <span class="n">development</span><span class="p">,</span> <span class="n">most</span> <span class="n">of</span> <span class="n">the</span> <span class="n">functionalities</span> <span class="n">are</span> <span class="ow">not</span>
<span class="o">*</span> <span class="n">implemented</span> <span class="ow">or</span> <span class="n">existing</span> <span class="n">functionalities</span> <span class="n">may</span> <span class="n">change</span> <span class="k">with</span> <span class="n">time</span><span class="o">.</span>
<span class="o">*</span> <span class="o">================================================================================</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">EnO</span> <span class="o">:=</span> <span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Ponter</span> <span class="n">to</span> <span class="n">ErrorSystem</span>
<span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">ErrorSystem</span><span class="p">);</span>

<span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">overflows</span>
<span class="n">nNoOverflow</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="o">.</span><span class="n">nNoOverflows</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">MEMSET</span> <span class="p">(</span> <span class="n">ADR</span><span class="p">(</span><span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">*</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">DUT_TerminalError</span><span class="p">));</span>
    <span class="n">ErrorSystem</span><span class="o">.</span><span class="n">lNextErrorID</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">errors</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">system</span>
<span class="n">nNoError</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nListCnt1</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nListCnt1</span><span class="p">]</span><span class="o">.</span><span class="n">Error_ID</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span>  <span class="n">THEN</span>
            <span class="n">nNoError</span> <span class="o">:=</span> <span class="n">nNoError</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>
<span class="n">ErrorSystem</span><span class="o">.</span><span class="n">nNoErrors</span> <span class="o">:=</span> <span class="n">nNoError</span><span class="p">;</span>

<span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">free</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">list</span>
<span class="n">nFreePos</span> <span class="o">:=</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="n">nNoError</span><span class="p">;</span>

<span class="o">//</span><span class="n">Acknoledge</span> <span class="n">specified</span> <span class="n">Error</span> <span class="n">entry</span>
<span class="n">IF</span> <span class="n">bACK</span> <span class="n">THEN</span>
    <span class="n">FOR</span> <span class="n">nListCnt1</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">DO</span>
            <span class="n">IF</span> <span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nListCnt1</span><span class="p">]</span><span class="o">.</span><span class="n">Error_ID</span> <span class="o">=</span> <span class="n">lErrorID</span> <span class="n">THEN</span>
                    <span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nListCnt1</span><span class="p">]</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">:=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Acknowledged</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">END_FOR</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Deleting</span> <span class="n">acknoledged</span> <span class="n">errors</span>
<span class="n">FOR</span> <span class="n">nListCnt1</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nListCnt1</span><span class="p">]</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Acknowledged</span> <span class="n">THEN</span>
            <span class="n">MEMMOVE</span> <span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nListCnt1</span><span class="p">]),</span> <span class="n">ADR</span><span class="p">(</span><span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nListCnt1</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">nListCnt1</span><span class="p">)</span> <span class="o">*</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">DUT_TerminalError</span><span class="p">));</span>
            <span class="n">MEMSET</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">DUT_TerminalError</span><span class="p">));</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-errorstate">DUT_ErrorState</a></p></li>
<li><p><a class="reference internal" href="#dut-terminalerror">DUT_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#gvl-errorsystem">GVL_ErrorSystem</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-gantryautocoupling">
<h2>FB_GantryAutoCoupling<a class="headerlink" href="#fb-gantryautocoupling" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GantryAutoCoupling</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nGantryTol</span> <span class="p">:</span> <span class="n">LINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bGantryAlreadyCoupled</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Master</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">MasterEnc</span> <span class="p">:</span> <span class="n">ST_RenishawAbsEnc</span><span class="p">;</span>
    <span class="n">Slave</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">SlaveEnc</span> <span class="p">:</span> <span class="n">ST_RenishawAbsEnc</span><span class="p">;</span>
    <span class="n">bExecuteCouple</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecuteDecouple</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">gantry_diff_limit</span> <span class="p">:</span> <span class="n">FB_GantryDiffVirtualLimitSwitch</span><span class="p">;</span>
    <span class="n">couple</span> <span class="p">:</span> <span class="n">MC_GEARIN</span><span class="p">;</span>
    <span class="n">decouple</span> <span class="p">:</span> <span class="n">MC_GEAROUT</span><span class="p">;</span>
    <span class="n">bInitComplete</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fbSetEnables</span> <span class="p">:</span> <span class="n">FB_SetEnables</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Designate</span> <span class="n">Master</span> <span class="ow">and</span> <span class="n">SLave</span> <span class="n">Axes</span>
<span class="n">Master</span><span class="o">.</span><span class="n">bGantryAxis</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">Slave</span><span class="o">.</span><span class="n">bGantryAxis</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">Master</span><span class="o">.</span><span class="n">nGantryTol</span> <span class="o">:=</span> <span class="n">nGantryTol</span><span class="p">;</span>
<span class="n">Slave</span><span class="o">.</span><span class="n">nGantryTol</span> <span class="o">:=</span> <span class="n">Master</span><span class="o">.</span><span class="n">nGantryTol</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Activate</span> <span class="n">Gantry</span> <span class="n">Virtual</span> <span class="n">Limit</span> <span class="n">Switch</span>
<span class="n">gantry_diff_limit</span><span class="p">(</span><span class="n">Penc</span><span class="o">:=</span><span class="n">MasterEnc</span><span class="p">,</span> <span class="n">SEnc</span><span class="o">:=</span><span class="n">SlaveEnc</span><span class="p">,</span> <span class="n">GantDiffTol</span><span class="o">:=</span><span class="n">Master</span><span class="o">.</span><span class="n">nGantryTol</span><span class="p">,</span>
                  <span class="n">PLimFwd</span><span class="o">=&gt;</span><span class="n">Master</span><span class="o">.</span><span class="n">bGantryForwardEnable</span><span class="p">,</span> <span class="n">PLimBwd</span><span class="o">=&gt;</span><span class="n">Master</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span><span class="p">,</span>
                  <span class="n">SLimFwd</span><span class="o">=&gt;</span><span class="n">Slave</span><span class="o">.</span><span class="n">bGantryForwardEnable</span><span class="p">,</span> <span class="n">SLimBwd</span><span class="o">=&gt;</span><span class="n">Slave</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Coupling</span> <span class="n">Status</span> <span class="n">Bit</span>
<span class="n">bGantryAlreadyCoupled</span> <span class="o">:=</span> <span class="n">Master</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">CoupleState</span><span class="o">=</span><span class="mi">1</span> <span class="n">AND</span> <span class="n">Slave</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">CoupleState</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>

<span class="n">fbSetEnables</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">Master</span><span class="p">);</span>
<span class="n">fbSetEnables</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">Slave</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bGantryAlreadyCoupled</span> <span class="n">THEN</span>
    <span class="n">Master</span><span class="o">.</span><span class="n">bGantryForwardEnable</span> <span class="o">:=</span> <span class="n">Master</span><span class="o">.</span><span class="n">bGantryForwardEnable</span> <span class="n">AND</span> <span class="n">Slave</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">;</span>
    <span class="n">Slave</span><span class="o">.</span><span class="n">bGantryForwardEnable</span> <span class="o">:=</span> <span class="n">Master</span><span class="o">.</span><span class="n">bAllForwardEnable</span> <span class="n">AND</span> <span class="n">Slave</span><span class="o">.</span><span class="n">bGantryForwardEnable</span><span class="p">;</span>

    <span class="n">Master</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span> <span class="o">:=</span> <span class="n">Master</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span> <span class="n">AND</span> <span class="n">Slave</span><span class="o">.</span><span class="n">bAllBackwardEnable</span><span class="p">;</span>
    <span class="n">Slave</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span> <span class="o">:=</span> <span class="n">Master</span><span class="o">.</span><span class="n">bAllBackwardEnable</span> <span class="n">AND</span> <span class="n">Slave</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Coupling</span> <span class="n">states</span>
<span class="o">//</span> <span class="n">Auto</span><span class="o">-</span><span class="n">coupling</span> <span class="n">at</span> <span class="n">init</span> <span class="ow">and</span> <span class="n">auto</span><span class="o">-</span><span class="n">reset</span> <span class="n">of</span> <span class="n">coupling</span> <span class="n">boolean</span>
<span class="n">bExecuteCouple</span> <span class="n">S</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bInitComplete</span><span class="p">;</span>

<span class="n">bExecuteCouple</span> <span class="n">R</span><span class="o">=</span> <span class="n">couple</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="n">bGantryAlreadyCoupled</span><span class="p">;</span>
<span class="n">couple</span><span class="p">(</span><span class="n">Master</span><span class="o">:=</span><span class="n">Master</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span> <span class="n">Slave</span><span class="o">:=</span><span class="n">Slave</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span> <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecuteCouple</span><span class="p">);</span>

<span class="n">bInitComplete</span> <span class="n">S</span><span class="o">=</span> <span class="n">bGantryAlreadyCoupled</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Decoupling</span> <span class="k">with</span> <span class="n">auto</span><span class="o">-</span><span class="n">reset</span> <span class="n">of</span> <span class="n">coupling</span> <span class="n">boolean</span>
<span class="n">bExecuteDecouple</span> <span class="n">R</span><span class="o">=</span> <span class="n">decouple</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bGantryAlreadyCoupled</span><span class="p">;</span>
<span class="n">decouple</span><span class="p">(</span><span class="n">Slave</span><span class="o">:=</span><span class="n">Slave</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span> <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecuteDecouple</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-gantrydiffvirtuallimitswitch">FB_GantryDiffVirtualLimitSwitch</a></p></li>
<li><p><a class="reference internal" href="#fb-setenables">FB_SetEnables</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-renishawabsenc">ST_RenishawAbsEnc</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-gantrydiffvirtuallimitswitch">
<h2>FB_GantryDiffVirtualLimitSwitch<a class="headerlink" href="#fb-gantrydiffvirtuallimitswitch" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GantryDiffVirtualLimitSwitch</span>
<span class="n">VAR_INPUT</span>
    <span class="n">PEnc</span><span class="p">:</span> <span class="n">ST_RenishawAbsEnc</span><span class="p">;</span> <span class="o">//</span> <span class="n">Primary</span> <span class="n">axis</span> <span class="n">encoder</span> <span class="p">(</span><span class="n">usually</span> <span class="n">the</span> <span class="n">upstream</span> <span class="n">one</span><span class="p">)</span>
    <span class="n">SEnc</span><span class="p">:</span> <span class="n">ST_RenishawAbsEnc</span><span class="p">;</span> <span class="o">//</span> <span class="n">Secondary</span> <span class="n">axis</span> <span class="n">encoder</span> <span class="p">(</span><span class="n">couples</span> <span class="n">to</span> <span class="n">the</span> <span class="n">primary</span><span class="p">)</span>

    <span class="n">GantDiffTol</span><span class="p">:</span> <span class="n">LINT</span><span class="p">;</span>        <span class="o">//</span> <span class="n">Gantry</span> <span class="n">differenace</span> <span class="n">tolerance</span> <span class="ow">in</span> <span class="n">encoder</span> <span class="n">counts</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">PLimFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Primary</span> <span class="n">axis</span> <span class="n">forward</span> <span class="n">direction</span> <span class="n">enable</span>
    <span class="n">PLimBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Primary</span> <span class="n">axis</span> <span class="n">reverse</span> <span class="n">direction</span> <span class="n">enable</span>
    <span class="n">SLimFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Secondary</span> <span class="n">axis</span> <span class="n">forward</span> <span class="n">direction</span> <span class="n">enable</span>
    <span class="n">SLimBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Secondary</span> <span class="n">axis</span> <span class="n">reverse</span> <span class="n">direction</span> <span class="n">enable</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">GantryDiff</span><span class="p">:</span> <span class="n">LINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Gantry</span> <span class="n">Difference</span> <span class="n">Virtual</span> <span class="n">Limit</span> <span class="n">Switch</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">15</span>

<span class="n">Determines</span> <span class="n">which</span> <span class="n">direction</span> <span class="ow">is</span> <span class="n">disabled</span> <span class="n">due</span> <span class="n">to</span> <span class="n">it</span> <span class="n">increasing</span> <span class="n">the</span> <span class="n">gantry</span> <span class="n">difference</span><span class="o">.</span>
<span class="n">Refer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ESD</span> <span class="k">for</span> <span class="n">actual</span> <span class="n">conventions</span><span class="o">.</span>

<span class="n">A</span> <span class="n">positive</span> <span class="n">gantry</span> <span class="n">error</span> <span class="n">refers</span> <span class="n">to</span> <span class="n">a</span> <span class="n">CCW</span> <span class="n">clocked</span> <span class="n">assembly</span><span class="p">:</span>
<span class="n">eg</span><span class="o">.</span> <span class="k">for</span> <span class="n">X</span>
<span class="n">X1</span> <span class="n">upstream</span><span class="p">,</span> <span class="n">X2</span> <span class="n">downstream</span><span class="o">.</span> <span class="n">Primary</span> <span class="n">axis</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">upstream</span><span class="o">.</span>
<span class="n">Gantry</span> <span class="n">difference</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">when</span>
<span class="n">X2</span><span class="o">&gt;</span><span class="n">X1</span>
<span class="n">Therefore</span>
<span class="n">X2</span> <span class="n">positive</span> <span class="n">direction</span> <span class="n">disabled</span>
<span class="n">X1</span> <span class="n">negative</span> <span class="n">direction</span> <span class="n">disabled</span>

<span class="n">Call</span> <span class="n">before</span> <span class="n">FB_MotionStage</span> <span class="n">fb</span> <span class="n">calls</span> <span class="k">for</span> <span class="n">the</span> <span class="n">gantry</span> <span class="n">axes</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">GantryDiff</span> <span class="o">:=</span> <span class="p">(</span> <span class="n">ULINT_TO_LINT</span><span class="p">(</span><span class="n">PEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">)</span> <span class="o">-</span> <span class="n">ULINT_TO_LINT</span><span class="p">(</span><span class="n">PEnc</span><span class="o">.</span><span class="n">Ref</span><span class="p">)</span> <span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">ULINT_TO_LINT</span><span class="p">(</span><span class="n">SEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">)</span> <span class="o">-</span> <span class="n">ULINT_TO_LINT</span><span class="p">(</span><span class="n">SEnc</span><span class="o">.</span><span class="n">Ref</span><span class="p">)</span> <span class="p">);</span>

<span class="n">IF</span> <span class="n">ABS</span><span class="p">(</span><span class="n">GantryDiff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">GantDiffTol</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">GantryDiff</span> <span class="o">&lt;</span> <span class="mi">0</span>  <span class="n">THEN</span>
        <span class="n">PLimBwd</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">SLimFwd</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">PLimBwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">SLimFwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">IF</span> <span class="n">GantryDiff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">PLimFwd</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">SLimBwd</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">PLimFwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">SLimBwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="o">//</span><span class="n">If</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">fault</span><span class="p">,</span> <span class="nb">all</span> <span class="n">directions</span> <span class="n">are</span> <span class="n">enabled</span>
    <span class="n">PLimFwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">PLimBwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">SLimFwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">SLimBwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-renishawabsenc">ST_RenishawAbsEnc</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-haltnc">
<h2>FB_HaltNC<a class="headerlink" href="#fb-haltnc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HaltNC</span> <span class="n">IMPLEMENTS</span> <span class="n">I_Halt</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_copy&#39;</span><span class="p">}</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">fbMcHalt</span>                <span class="p">:</span> <span class="n">MC_Halt</span><span class="p">;</span>
    <span class="n">eBufferMode</span> <span class="p">:</span> <span class="n">MC_BufferMode</span> <span class="o">:=</span> <span class="n">MC_BufferMode</span><span class="o">.</span><span class="n">MC_Aborting</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span><span class="p">;</span>
    <span class="n">eHaltState</span> <span class="p">:</span> <span class="p">(</span><span class="n">WaitingHalt</span><span class="p">,</span> <span class="n">Halting</span><span class="p">);</span>
    <span class="n">bDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">__ISVALIDREF</span><span class="p">(</span><span class="n">AxisRef</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">AxisRef</span><span class="o">.</span><span class="n">ReadStatus</span><span class="p">();</span>

<span class="n">CASE</span> <span class="n">eHaltState</span> <span class="n">OF</span>
    <span class="n">WaitingHalt</span> <span class="p">:</span>
        <span class="n">fbMcHalt</span><span class="p">(</span>
        <span class="n">Axis</span> <span class="o">:=</span> <span class="n">AxisRef</span><span class="p">,</span>
        <span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="n">Halting</span> <span class="p">:</span>
        <span class="n">fbMcHalt</span><span class="p">(</span>
        <span class="n">Axis</span> <span class="o">:=</span> <span class="n">AxisRef</span><span class="p">,</span>
        <span class="n">Execute</span> <span class="o">:=</span> <span class="n">TRUE</span>
        <span class="p">);</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Halt</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Deceleration</span>    <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Jerk</span>    <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BufferMode</span>      <span class="p">:</span> <span class="n">MC_BufferMode</span> <span class="o">:=</span> <span class="n">MC_BufferMode</span><span class="o">.</span><span class="n">MC_Aborting</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Clear</span> <span class="n">previous</span> <span class="n">status</span><span class="p">:</span> <span class="n">MC_Halt</span> <span class="n">auto</span> <span class="n">clear</span> <span class="n">this</span> <span class="n">bit</span> <span class="n">when</span> <span class="n">Done</span> <span class="ow">is</span> <span class="nb">set</span><span class="o">.</span>
<span class="n">fbMcHalt</span><span class="p">(</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>  <span class="n">Axis</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">);</span>
<span class="o">//</span> <span class="n">initiate</span> <span class="n">a</span> <span class="n">new</span> <span class="n">halting</span> <span class="n">request</span>
<span class="n">fbMcHalt</span><span class="p">(</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">Axis</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">,</span>
    <span class="n">Execute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">Deceleration</span> <span class="o">:=</span> <span class="n">Deceleration</span><span class="p">,</span>
    <span class="n">Jerk</span> <span class="o">:=</span> <span class="n">Jerk</span><span class="p">,</span>
    <span class="n">BufferMode</span> <span class="o">:=</span> <span class="n">BufferMode</span><span class="p">);</span>

<span class="n">eHaltState</span> <span class="o">:=</span> <span class="n">Halting</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Aborted</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcHalt</span><span class="o">.</span><span class="n">CommandAborted</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Active</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcHalt</span><span class="o">.</span><span class="n">Active</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcHalt</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">CommandHalt</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcHalt</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">CommandHalt</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Done</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcHalt</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcHalt</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcHalt</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Message</span>  <span class="o">:=</span> <span class="n">sMessage</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
</section>
<section id="fb-homedirect">
<h2>FB_HomeDirect<a class="headerlink" href="#fb-homedirect" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeDirect</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fHomePosition</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomed</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbHome</span><span class="p">:</span> <span class="n">MC_Home</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbHome</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">Position</span><span class="o">:=</span><span class="n">fHomePosition</span><span class="p">,</span>
    <span class="n">HomingMode</span><span class="o">:=</span><span class="n">MC_Direct</span><span class="p">,</span>
    <span class="n">bCalibrationCam</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
    <span class="p">);</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">fbHome</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-homeds402">
<h2>FB_HomeDS402<a class="headerlink" href="#fb-homeds402" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeDS402</span> <span class="n">IMPLEMENTS</span> <span class="n">I_HomeDS402</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">iMotionLogger</span> <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
    <span class="o">//</span><span class="n">iLimSwStatus</span> <span class="p">:</span> <span class="n">I_LimSwStatus</span><span class="p">;</span>
    <span class="o">//</span><span class="n">iHomeShareData</span> <span class="p">:</span> <span class="n">I_HomeShareData</span> <span class="p">;</span>
    <span class="n">bCommandMoveHome</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bAbort</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bAborted</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorID</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">fOffset</span>  <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosition</span>       <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">rtDone</span>  <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fHomeSpeedFast</span>  <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fHomeSpeedSlow</span>  <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bBit13OpModeSpecific</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBit12OpModeSpecific</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bTargetReached</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nDriveControl</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nModeOfOperation</span> <span class="p">:</span> <span class="n">SINT</span><span class="p">;</span>
    <span class="n">nModeOfOperationDisplay</span> <span class="p">:</span> <span class="n">SINT</span><span class="p">;</span>
    <span class="n">nMostRecentModeOfOperation</span> <span class="p">:</span> <span class="n">SINT</span><span class="p">;</span>
    <span class="n">eHomeMode</span><span class="p">:</span> <span class="n">E_EpicsHomeCmd</span> <span class="o">:=</span><span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">AUTOZERO</span><span class="p">;</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftExec</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">bMove</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tonSyncHoming</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">eHomeState</span>      <span class="p">:</span> <span class="n">E_MoveState</span><span class="p">;</span>
    <span class="n">rtReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sMessage</span><span class="p">:</span> <span class="n">T_MAXSTRING</span><span class="p">;</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">iMotionLogger</span> <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span> <span class="o">:=</span> <span class="n">iMotionLogger</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">iMotionLogger</span> <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span> <span class="o">:=</span> <span class="n">iMotionLogger</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Home</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Execute</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">HomeSpeedFast</span>   <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">HomeSpeedSlow</span>   <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bCommandMoveHome</span> <span class="o">:=</span> <span class="n">Execute</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">fHomeSpeedFast</span> <span class="o">:=</span> <span class="n">HomeSpeedFast</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">fHomeSpeedSlow</span> <span class="o">:=</span> <span class="n">HomeSpeedSlow</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Status</span>
<span class="n">VAR_INPUT</span>
    <span class="n">ModeOfOperationDisplay</span> <span class="p">:</span> <span class="n">SINT</span><span class="p">;</span>
    <span class="n">Bit13OpModeSpecific</span>     <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Bit12OpModeSpecific</span>     <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">TargetReached</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">nModeOfOperationDisplay</span> <span class="o">:=</span> <span class="n">ModeOfOperationDisplay</span><span class="p">;</span>
<span class="n">bBit13OpModeSpecific</span> <span class="o">:=</span> <span class="n">Bit13OpModeSpecific</span><span class="p">;</span>
<span class="n">bBit12OpModeSpecific</span> <span class="o">:=</span> <span class="n">Bit12OpModeSpecific</span><span class="p">;</span>
<span class="n">bTargetReached</span> <span class="o">:=</span> <span class="n">TargetReached</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Aborted</span> <span class="o">:=</span> <span class="n">bAborted</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">CommandMoveHome</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">bCommandMoveHome</span> <span class="o">:=</span> <span class="n">CommandMoveHome</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ControlWord</span> <span class="p">:</span> <span class="n">UINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ControlWord</span> <span class="o">:=</span> <span class="n">nDriveControl</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Done</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bDone</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">nErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Message</span> <span class="o">:=</span> <span class="n">sMessage</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Mode</span> <span class="p">:</span> <span class="n">E_EpicsHomeCmd</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Mode</span> <span class="o">:=</span> <span class="n">eHomeMode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Mode</span> <span class="p">:</span> <span class="n">E_EpicsHomeCmd</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">eHomeMode</span> <span class="o">:=</span> <span class="n">Mode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ModeOfOperation</span> <span class="p">:</span> <span class="n">SINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ModeOfOperation</span>  <span class="o">:=</span> <span class="n">nModeOfOperation</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Offset</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">fOffset</span> <span class="o">:=</span> <span class="n">Offset</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Position</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">fPosition</span> <span class="o">:=</span> <span class="n">Position</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Reset</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">bReset</span> <span class="o">:=</span> <span class="n">Reset</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#e-movestate">E_MoveState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homefinish">
<h2>FB_HomeFinish<a class="headerlink" href="#fb-homefinish" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeFinish</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bSofLimEnableLow</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSofLimEnableHigh</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbHomewriteSoftLimEnable</span><span class="p">:</span><span class="n">FB_HomeWriteSoftLimEnable</span><span class="p">;</span>
    <span class="n">fbExecuteRiseEdge</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bExecuteWriteNC</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span><span class="n">INT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
  <span class="n">bExecuteWriteNC</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">bSofLimEnableLow</span><span class="p">;</span>
  <span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">bSofLimEnableHigh</span><span class="p">;</span>
  <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbExecuteRiseEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbExecuteRiseEdge</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
  <span class="n">bExecuteWriteNC</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
  <span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">bSofLimEnableLow</span><span class="p">;</span>
  <span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">bSofLimEnableHigh</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Write</span> <span class="n">to</span> <span class="n">NC</span> <span class="p">(</span><span class="n">disable</span> <span class="n">soft</span> <span class="n">limits</span><span class="p">)</span>
<span class="n">fbHomewriteSoftLimEnable</span><span class="p">(</span>
    <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteWriteNC</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bDone</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-homewritesoftlimenable">FB_HomeWriteSoftLimEnable</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homenc">
<h2>FB_HomeNC<a class="headerlink" href="#fb-homenc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeNC</span> <span class="n">IMPLEMENTS</span> <span class="n">I_Home</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_copy&#39;</span><span class="p">}</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">iMotionLogger</span> <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
    <span class="n">iLimSwStatus</span> <span class="p">:</span> <span class="n">I_LimSwStatus</span><span class="p">;</span>
    <span class="o">//</span><span class="n">iHomeShareData</span> <span class="p">:</span> <span class="n">I_HomeShareData</span> <span class="p">;</span>
    <span class="n">bCommandMoveHome</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span>                   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span>                   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span>                  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bAbort</span>       <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bAborted</span>       <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorID</span>                <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">fRefVeloSearch</span>  <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fRefVeloSync</span>    <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fOffset</span>  <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosition</span>       <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bFirstDirection</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtDone</span>                          <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtAborted</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span><span class="p">;</span>
    <span class="n">fbMcSetPos</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">fbMcJog</span><span class="p">:</span> <span class="n">MC_Jog</span><span class="p">;</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftExec</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">nStateMachine</span><span class="p">:</span> <span class="n">E_MoveState</span><span class="p">;</span>
    <span class="n">nStateAfterStop</span><span class="p">:</span> <span class="n">E_MoveState</span><span class="p">;</span>
    <span class="n">nMoves</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bFirstDir</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bAtHome</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrCount</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">eHomeMode</span><span class="p">:</span> <span class="n">E_EpicsHomeCmd</span> <span class="o">:=</span><span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">NONE</span><span class="p">;</span>
    <span class="n">bLimForward</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimBackward</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimHome</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtReset</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bHalted</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="p">(</span><span class="o">*</span>
        <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">simpler</span> <span class="n">way</span> <span class="n">of</span> <span class="n">disabling</span> <span class="n">the</span> <span class="n">soft</span> <span class="n">limits</span> <span class="n">that</span> <span class="n">ends</span> <span class="n">up</span> <span class="n">being</span> <span class="n">really</span> <span class="n">obvious</span> <span class="k">if</span> <span class="n">something</span> <span class="n">has</span> <span class="n">gone</span> <span class="n">wrong</span><span class="o">.</span>
        <span class="n">If</span> <span class="n">you</span> <span class="n">turn</span> <span class="n">the</span> <span class="n">limits</span> <span class="n">off</span><span class="o">/</span><span class="n">on</span><span class="p">,</span> <span class="ow">not</span> <span class="n">only</span> <span class="n">do</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">track</span> <span class="n">of</span> <span class="k">if</span> <span class="n">you</span> <span class="n">had</span> <span class="n">soft</span> <span class="n">limits</span> <span class="nb">set</span><span class="p">,</span>
        <span class="n">but</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">always</span> <span class="n">restore</span> <span class="n">this</span> <span class="n">properly</span> <span class="ow">or</span> <span class="n">risk</span> <span class="n">some</span> <span class="n">issue</span><span class="o">.</span>
        <span class="n">Instead</span><span class="p">,</span> <span class="n">I</span> <span class="nb">set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">a</span> <span class="n">ridiculous</span> <span class="n">value</span> <span class="n">that</span> <span class="n">can</span> <span class="n">always</span> <span class="n">move</span> <span class="n">forward</span> <span class="ow">or</span> <span class="n">backward</span><span class="o">.</span>
        <span class="n">If</span> <span class="n">this</span> <span class="n">gets</span> <span class="n">stuck</span> <span class="k">for</span> <span class="nb">any</span> <span class="n">reason</span> <span class="n">it</span><span class="s1">&#39;s very clear that something has gone wrong,</span>
        <span class="n">rather</span> <span class="n">than</span> <span class="n">a</span> <span class="n">silent</span> <span class="n">failure</span> <span class="n">of</span> <span class="n">the</span> <span class="n">soft</span> <span class="n">limit</span> <span class="n">marks</span><span class="o">.</span>
    <span class="o">*</span><span class="p">)</span>
    <span class="n">FWD_START</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">99999999</span><span class="p">;</span>
    <span class="n">BWD_START</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span>  <span class="mi">99999999</span><span class="p">;</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">iMotionLogger</span> <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
    <span class="n">iLimSwStatus</span> <span class="p">:</span> <span class="n">I_LimSwStatus</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span> <span class="o">:=</span> <span class="n">iMotionLogger</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iLimSwStatus</span><span class="o">:=</span> <span class="n">iLimSwStatus</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">iMotionLogger</span> <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
    <span class="n">iLimSwStatus</span> <span class="p">:</span> <span class="n">I_LimSwStatus</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span> <span class="o">:=</span> <span class="n">iMotionLogger</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iLimSwStatus</span><span class="o">:=</span> <span class="n">iLimSwStatus</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span>  <span class="n">Home</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Execute</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">HomeSpeedFast</span>   <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">HomeSpeedSlow</span>   <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bCommandMoveHome</span> <span class="o">:=</span> <span class="n">Execute</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">fRefVeloSearch</span> <span class="o">:=</span> <span class="n">HomeSpeedFast</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">fRefVeloSync</span> <span class="o">:=</span> <span class="n">HomeSpeedSlow</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Aborted</span> <span class="o">:=</span> <span class="n">bAborted</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">CommandMoveHome</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">bCommandMoveHome</span> <span class="o">:=</span> <span class="n">CommandMoveHome</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Done</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bDone</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">nErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Message</span> <span class="o">:=</span> <span class="n">sMessage</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Mode</span> <span class="p">:</span> <span class="n">E_EpicsHomeCmd</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Mode</span> <span class="o">:=</span> <span class="n">eHomeMode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Mode</span> <span class="p">:</span> <span class="n">E_EpicsHomeCmd</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">eHomeMode</span> <span class="o">:=</span> <span class="n">Mode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Offset</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">fOffset</span> <span class="o">:=</span> <span class="n">Offset</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Position</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">fPosition</span> <span class="o">:=</span> <span class="n">Position</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Reset</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">bReset</span> <span class="o">:=</span> <span class="n">Reset</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#e-movestate">E_MoveState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homeprepare">
<h2>FB_HomePrepare<a class="headerlink" href="#fb-homeprepare" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomePrepare</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">bSofLimEnableLowOriginal</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSofLimEnableHighOriginal</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fVelocityToCam</span><span class="p">:</span> <span class="n">LREAL</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">fVelocityFromCam</span><span class="p">:</span> <span class="n">LREAL</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbHomeReadSoftLimEnable</span><span class="p">:</span><span class="n">FB_HomeReadSoftLimEnable</span><span class="p">;</span>
    <span class="n">fbHomeDisableSoftLimEnable</span><span class="p">:</span><span class="n">FB_HomeWriteSoftLimEnable</span><span class="p">;</span>
    <span class="n">fbHomeReadNCVelocities</span><span class="p">:</span> <span class="n">FB_HomeReadNcVelocities</span><span class="p">;</span>
    <span class="n">fbHomeResetCalibrationFlag</span><span class="p">:</span><span class="n">MC_Home</span><span class="p">;</span>   <span class="o">//</span><span class="n">Only</span> <span class="n">used</span> <span class="k">for</span> <span class="n">reset</span> <span class="n">of</span> <span class="n">calibration</span> <span class="n">flag</span>
    <span class="n">fbExecuteRiseEdge</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bExecuteReadNC</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecuteWriteNC</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span><span class="n">INT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
  <span class="n">bExecuteReadNC</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bExecuteWriteNC</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbExecuteRiseEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbExecuteRiseEdge</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
  <span class="n">bExecuteReadNC</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Read</span> <span class="kn">from</span><span class="w"> </span><span class="nn">NC</span>
<span class="n">fbHomeReadNCVelocities</span><span class="p">(</span>
  <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
  <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteReadNC</span><span class="p">,</span> <span class="o">//</span> <span class="n">Actualy</span> <span class="ow">not</span> <span class="n">needed</span> <span class="k">for</span> <span class="n">sequence</span> <span class="mi">15</span> <span class="p">(</span><span class="nb">set</span> <span class="n">position</span> <span class="n">only</span><span class="p">,</span> <span class="n">no</span> <span class="n">movement</span><span class="p">))</span>
  <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
  <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbHomeReadSoftLimEnable</span><span class="p">(</span>
    <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteReadNC</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Reset</span> <span class="n">calibration</span> <span class="n">flag</span>
<span class="n">fbHomeResetCalibrationFlag</span><span class="p">(</span>
  <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecuteReadNC</span><span class="p">,</span>
  <span class="n">HomingMode</span><span class="o">:=</span><span class="n">MC_ResetCalibration</span><span class="p">,</span>
  <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
<span class="p">);</span>

<span class="n">bSofLimEnableLowOriginal</span><span class="o">:=</span><span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="p">;</span>
<span class="n">bSofLimEnableHighOriginal</span><span class="o">:=</span><span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="p">;</span>

<span class="n">fVelocityToCam</span><span class="o">:=</span><span class="n">fbHomeReadNCVelocities</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">;</span>
<span class="n">fVelocityFromCam</span><span class="o">:=</span><span class="n">fbHomeReadNCVelocities</span><span class="o">.</span><span class="n">fVelocityFromCam</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bExecuteReadNC</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecuteWriteNC</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span><span class="n">Always</span> <span class="n">write</span> <span class="p">(</span><span class="n">only</span> <span class="n">needed</span> <span class="k">if</span> <span class="n">enabled</span> <span class="n">actually</span><span class="p">)</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Write</span> <span class="n">to</span> <span class="n">NC</span> <span class="p">(</span><span class="n">disable</span> <span class="n">soft</span> <span class="n">limits</span><span class="p">)</span>
<span class="n">fbHomeDisableSoftLimEnable</span><span class="p">(</span>
    <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteWriteNC</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbHomeReadNCVelocities</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbHomeResetCalibrationFlag</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbHomeReadNCVelocities</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbHomeResetCalibrationFlag</span><span class="o">.</span><span class="n">Done</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbHomeReadNCVelocities</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbHomeResetCalibrationFlag</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbHomeResetCalibrationFlag</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeResetCalibrationFlag</span><span class="o">.</span><span class="n">ErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-homereadncvelocities">FB_HomeReadNcVelocities</a></p></li>
<li><p><a class="reference internal" href="#fb-homereadsoftlimenable">FB_HomeReadSoftLimEnable</a></p></li>
<li><p><a class="reference internal" href="#fb-homewritesoftlimenable">FB_HomeWriteSoftLimEnable</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homereadncvelocities">
<h2>FB_HomeReadNcVelocities<a class="headerlink" href="#fb-homereadncvelocities" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeReadNcVelocities</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">fVelocityToCam</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVelocityFromCam</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbReadVelocityToCam</span><span class="p">:</span><span class="n">FB_ReadFloatParameter</span><span class="p">;</span>
    <span class="n">fbReadVelocityFromCam</span><span class="p">:</span><span class="n">FB_ReadFloatParameter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbReadVelocityToCam</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#4000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#6,</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">fbReadVelocityFromCam</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#4000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#7,</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">fVelocityToCam</span><span class="o">:=</span><span class="n">fbReadVelocityToCam</span><span class="o">.</span><span class="n">nData</span><span class="p">;</span>
<span class="n">fVelocityFromCam</span><span class="o">:=</span><span class="n">fbReadVelocityFromCam</span><span class="o">.</span><span class="n">nData</span><span class="p">;</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbReadVelocityFromCam</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbReadVelocityToCam</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbReadVelocityFromCam</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbReadVelocityToCam</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbReadVelocityToCam</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbReadVelocityFromCam</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">fbReadVelocityToCam</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbReadVelocityToCam</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbReadVelocityFromCam</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbReadVelocityFromCam</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-readfloatparameter">FB_ReadFloatParameter</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homereadsoftlimenable">
<h2>FB_HomeReadSoftLimEnable<a class="headerlink" href="#fb-homereadsoftlimenable" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeReadSoftLimEnable</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">bSofLimEnableLow</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSofLimEnableHigh</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbReadSoftLimEnableLow</span><span class="p">:</span><span class="n">FB_ReadParameterInNc_v1_00</span><span class="p">;</span>
    <span class="n">fbReadSoftLimEnableHigh</span><span class="p">:</span><span class="n">FB_ReadParameterInNc_v1_00</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbReadSoftLimEnableLow</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#5000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#B,</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">fbReadSoftLimEnableHigh</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#5000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#C,</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">DWORD_TO_BOOL</span><span class="p">(</span><span class="n">fbReadSoftLimEnableLow</span><span class="o">.</span><span class="n">nData</span><span class="p">);</span>
<span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">DWORD_TO_BOOL</span><span class="p">(</span><span class="n">fbReadSoftLimEnableHigh</span><span class="o">.</span><span class="n">nData</span><span class="p">);</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbReadSoftLimEnableLow</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbReadSoftLimEnableHigh</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbReadSoftLimEnableLow</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbReadSoftLimEnableHigh</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbReadSoftLimEnableLow</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbReadSoftLimEnableHigh</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">fbReadSoftLimEnableLow</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbReadSoftLimEnableLow</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbReadSoftLimEnableHigh</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbReadSoftLimEnableHigh</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-readparameterinnc-v1-00">FB_ReadParameterInNc_v1_00</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-hometoswitch">
<h2>FB_HomeToSwitch<a class="headerlink" href="#fb-hometoswitch" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeToSwitch</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bCamSensor</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nSearchDirTwoardsCam</span><span class="p">:</span> <span class="n">MC_Direction</span><span class="p">;</span>
    <span class="n">nSearchDirOffCam</span><span class="p">:</span> <span class="n">MC_Direction</span><span class="p">;</span>
    <span class="n">fHomePosition</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVelocityToCamNC</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Velcoity</span> <span class="n">when</span> <span class="n">searching</span> <span class="k">for</span> <span class="n">cam</span>
    <span class="n">fVelocityFromCamNC</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Velocity</span> <span class="n">after</span> <span class="n">found</span> <span class="n">cam</span> <span class="p">(</span><span class="n">searching</span> <span class="k">for</span> <span class="nb">next</span> <span class="n">signal</span> <span class="n">transition</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomed</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbHome</span><span class="p">:</span> <span class="n">MC_Home</span><span class="p">;</span>
    <span class="n">fbWriteHomeDirCamToNC</span><span class="p">:</span><span class="n">FB_WriteParameterInNc_v1_00</span><span class="p">;</span>
    <span class="n">fbWriteHomeDirSyncToNC</span><span class="p">:</span><span class="n">FB_WriteParameterInNc_v1_00</span><span class="p">;</span>
    <span class="n">fbWriteHomeModeToNC</span><span class="p">:</span><span class="n">FB_WriteParameterInNc_v1_00</span><span class="p">;</span>
    <span class="n">fbWriteHomeVelocitiesToNC</span><span class="p">:</span> <span class="n">FB_HomeWriteNcVelocities</span><span class="p">;</span>
    <span class="n">bConfigNCDone</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbRTrigg</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bConfigNCDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Start</span> <span class="n">preparation</span> <span class="n">of</span> <span class="n">NC</span> <span class="k">if</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">on</span> <span class="n">bExecute</span>
<span class="n">fbRTrigg</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbRTrigg</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bConfigNCDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="n">fbWriteHomeDirCamToNC</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bConfigNCDone</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#5000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#101,   //Direction for Calibration Cam Search</span>
    <span class="n">nData</span><span class="o">:=</span><span class="n">BOOL_TO_DWORD</span><span class="p">(</span><span class="n">nSearchDirTwoardsCam</span><span class="o">=</span><span class="n">MC_Negative_Direction</span><span class="p">),</span><span class="o">//</span><span class="n">BOOL_TO_DWORD</span><span class="p">(</span><span class="n">NOT</span> <span class="n">bSearchDirTwoardsCam</span><span class="p">),</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
<span class="p">);</span>

<span class="n">fbWriteHomeDirSyncToNC</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bConfigNCDone</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#5000 ,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#102 , //Direction for Sync Impuls Search</span>
    <span class="n">nData</span><span class="o">:=</span><span class="n">BOOL_TO_DWORD</span><span class="p">(</span><span class="n">nSearchDirOffCam</span><span class="o">=</span><span class="n">MC_Negative_Direction</span><span class="p">),</span><span class="o">//</span><span class="n">BOOL_TO_DWORD</span><span class="p">(</span><span class="n">NOT</span> <span class="n">bSearchDirOffCam</span><span class="p">),</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span>
<span class="p">);</span>

<span class="n">fbWriteHomeModeToNC</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bConfigNCDone</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#5000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#107,  //Reference Mode</span>
    <span class="n">nData</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">axis</span><span class="p">);</span>

<span class="n">fbWriteHomeVelocitiesToNC</span><span class="p">(</span>
  <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
  <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bConfigNCDone</span><span class="p">,</span>
  <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
  <span class="n">fVelocityFromCam</span><span class="o">:=</span><span class="n">fVelocityFromCamNC</span><span class="p">,</span>
  <span class="n">fVelocityToCam</span><span class="o">:=</span><span class="n">fVelocityToCamNC</span><span class="p">,</span>
  <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">);</span>

<span class="n">fbHome</span><span class="o">.</span><span class="n">bCalibrationCam</span><span class="o">:=</span><span class="n">bCamSensor</span><span class="p">;</span>

<span class="n">fbHome</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">bConfigNCDone</span><span class="p">(</span><span class="o">*</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span><span class="o">*</span><span class="p">),</span>
    <span class="n">Position</span><span class="o">:=</span><span class="n">fHomePosition</span><span class="p">,</span>
    <span class="n">HomingMode</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
    <span class="p">);</span>
<span class="n">bBusy</span><span class="o">:=</span><span class="p">(</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bConfigNCDone</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">));</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Done</span> <span class="n">AND</span> <span class="n">bConfigNCDone</span><span class="p">;</span>
<span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bConfigNCDone</span><span class="p">)</span> <span class="n">AND</span> <span class="n">fbWriteHomeDirCamToNC</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbWriteHomeDirSyncToNC</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbWriteHomeModeToNC</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbWriteHomeVelocitiesToNC</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
  <span class="n">bConfigNCDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">For</span> <span class="n">some</span> <span class="n">reason</span> <span class="n">MC_HOME</span> <span class="n">gives</span> <span class="n">an</span> <span class="n">Error</span> <span class="k">for</span> <span class="n">one</span> <span class="n">cycle</span> <span class="n">of</span> <span class="n">NC</span><span class="o">-</span><span class="n">Task</span> <span class="mi">1</span> <span class="n">SVB</span> <span class="p">(</span><span class="mi">10</span><span class="n">ms</span> <span class="n">default</span><span class="o">..</span><span class="p">)</span> <span class="n">so</span> <span class="nb">filter</span> <span class="k">with</span> <span class="n">bExecute</span>
<span class="n">bError</span><span class="o">:=</span><span class="p">(</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">)</span> <span class="n">OR</span> <span class="n">fbWriteHomeDirCamToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbWriteHomeDirSyncToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbWriteHomeModeToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbWriteHomeVelocitiesToNC</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">)</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteHomeDirCamToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteHomeDirCamToNC</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteHomeDirSyncToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteHomeDirSyncToNC</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteHomeModeToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteHomeModeToNC</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteHomeVelocitiesToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteHomeVelocitiesToNC</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-homewritencvelocities">FB_HomeWriteNcVelocities</a></p></li>
<li><p><a class="reference internal" href="#fb-writeparameterinnc-v1-00">FB_WriteParameterInNc_v1_00</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homevirtual">
<h2>FB_HomeVirtual<a class="headerlink" href="#fb-homevirtual" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeVirtual</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bLimitFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomeSensor</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fHomePosition</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nHomeRevOffset</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomed</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbHomeToSwitch</span><span class="p">:</span> <span class="n">FB_HomeToSwitch</span><span class="p">;</span>
    <span class="n">fbHomeDirect</span><span class="p">:</span> <span class="n">FB_HomeDirect</span><span class="p">;</span> <span class="o">//</span><span class="n">Only</span> <span class="n">used</span> <span class="k">for</span> <span class="n">direct</span> <span class="n">homing</span> <span class="p">(</span><span class="nb">set</span> <span class="n">of</span> <span class="n">position</span><span class="p">)</span>
    <span class="n">fbMoveVelocity</span><span class="p">:</span><span class="n">MC_MoveVelocity</span><span class="p">;</span>
    <span class="n">fbHomePrepare</span><span class="p">:</span><span class="n">FB_HomePrepare</span><span class="p">;</span>
    <span class="n">fbHomeFinish</span><span class="p">:</span><span class="n">FB_HomeFinish</span><span class="p">;</span>
    <span class="n">fbExecuteRiseEdge</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">nHomingState</span><span class="p">:</span><span class="n">INT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">bExecuteHomeToSwitch</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecuteMoveVelocity</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecutePrepare</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecuteFinish</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecuteHomeDirect</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nCmdDataLocal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>  <span class="o">//</span><span class="n">Ensure</span> <span class="n">that</span> <span class="n">nCmdData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">changed</span> <span class="n">during</span> <span class="n">sequence</span>
    <span class="n">bSequenceReady</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bRestoreNCDataNeeded</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Reset</span> <span class="n">when</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">low</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
  <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
  <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
  <span class="n">bExecuteHomeToSwitch</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bExecuteHomeDirect</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bExecutePrepare</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Reset</span> <span class="n">at</span> <span class="n">rinsing</span> <span class="n">edge</span> <span class="n">of</span> <span class="n">bExecute</span>
<span class="n">fbExecuteRiseEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbExecuteRiseEdge</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
  <span class="n">nCmdDataLocal</span><span class="o">:=</span><span class="n">nCmdData</span><span class="p">;</span> <span class="o">//</span><span class="n">Ensure</span> <span class="n">that</span> <span class="n">nCmdData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">changed</span> <span class="n">during</span> <span class="n">sequence</span> <span class="p">(</span><span class="n">nCmdData</span> <span class="n">will</span> <span class="n">only</span> <span class="n">be</span> <span class="n">read</span> <span class="n">at</span> <span class="n">a</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">of</span> <span class="n">bExecute</span><span class="p">)</span>
  <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bExecutePrepare</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
  <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="o">//</span><span class="n">Check</span> <span class="k">if</span> <span class="n">valid</span> <span class="n">nCmdDataLocal</span>
  <span class="n">CASE</span> <span class="n">nCmdDataLocal</span> <span class="n">OF</span>
    <span class="mi">1</span><span class="p">:</span>
    <span class="mi">2</span><span class="p">:</span>
    <span class="mi">3</span><span class="p">:</span>
    <span class="mi">4</span><span class="p">:</span>
    <span class="mi">15</span><span class="p">:</span>
    <span class="n">ELSE</span> <span class="o">//</span><span class="n">nCmdData</span> <span class="ow">not</span> <span class="n">valid</span>
      <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
      <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4FFF;</span>
  <span class="n">END_CASE</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="c1">############# Prepare for homing (Read from NC and reset homed flag)</span>
<span class="n">fbHomePrepare</span><span class="p">(</span>
  <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
  <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecutePrepare</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span><span class="p">,</span> <span class="o">//</span> <span class="n">Not</span> <span class="n">needed</span> <span class="k">for</span> <span class="n">sequence</span> <span class="mi">15</span> <span class="p">(</span><span class="nb">set</span> <span class="n">position</span> <span class="n">only</span><span class="p">,</span> <span class="n">no</span> <span class="n">movement</span><span class="p">))</span>
  <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
  <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span><span class="c1">############# Homing Sequences:</span>
<span class="n">CASE</span> <span class="n">nCmdDataLocal</span> <span class="n">OF</span>

   <span class="mi">1</span><span class="p">:</span> <span class="o">//</span> <span class="n">Home</span> <span class="n">to</span> <span class="n">low</span> <span class="n">limit</span> <span class="n">switch</span>
       <span class="n">CASE</span> <span class="n">nHomingState</span> <span class="n">OF</span>
              <span class="mi">0</span><span class="p">:</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">read</span> <span class="n">of</span> <span class="n">velocities</span> <span class="kn">from</span><span class="w"> </span><span class="nn">NC</span> <span class="ow">and</span> <span class="n">reset</span> <span class="n">of</span> <span class="n">calibration</span> <span class="n">flag</span>
            <span class="n">IF</span> <span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bSequenceReady</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">IF</span> <span class="n">bLimitBwd</span> <span class="n">THEN</span>
                <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
              <span class="n">ELSE</span>
                            <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>  <span class="o">//</span><span class="n">Standing</span> <span class="n">on</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">go</span> <span class="n">direct</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">2</span>
              <span class="n">END_IF</span>
            <span class="n">END_IF</span>
              <span class="mi">1</span><span class="p">:</span> <span class="o">//</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">reach</span> <span class="n">low</span> <span class="n">limit</span> <span class="n">then</span> <span class="n">trigger</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">);</span>
            <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Direction</span><span class="o">:=</span><span class="n">MC_Negative_Direction</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Execute</span> <span class="n">MC_MoveVelocity</span>
                <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLimitBwd</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">MC_MoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">goes</span> <span class="n">down</span> <span class="n">when</span> <span class="n">ramp</span> <span class="n">down</span> <span class="n">initiates</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ends</span><span class="p">)</span><span class="o">.</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>
                <span class="n">END_IF</span>
              <span class="mi">2</span><span class="p">:</span> <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteHomeToSwitch</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirTwoardsCam</span><span class="o">:=</span><span class="n">MC_Positive_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirOffCam</span><span class="o">:=</span><span class="n">MC_Positive_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityToCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">;</span> <span class="o">//</span> <span class="n">High</span> <span class="n">speed</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityFromCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityFromCam</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Low</span> <span class="n">speed</span>
                <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bCamSensor</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bLimitBwd</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">3</span><span class="p">;</span>
                      <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableHighOriginal</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableLowOriginal</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
          <span class="mi">3</span><span class="p">:</span> <span class="o">//</span> <span class="n">restore</span> <span class="n">softlimit</span> <span class="n">enable</span>
            <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
              <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
                      <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
       <span class="n">END_CASE</span><span class="p">;</span>

   <span class="mi">2</span><span class="p">:</span> <span class="o">//</span> <span class="n">Home</span> <span class="n">to</span> <span class="n">high</span> <span class="n">limit</span> <span class="n">switch</span>
       <span class="n">CASE</span> <span class="n">nHomingState</span> <span class="n">OF</span>
              <span class="mi">0</span><span class="p">:</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">read</span> <span class="n">of</span> <span class="n">velocities</span> <span class="kn">from</span><span class="w"> </span><span class="nn">NC</span> <span class="ow">and</span> <span class="n">reset</span> <span class="n">of</span> <span class="n">calibration</span> <span class="n">flag</span>
            <span class="n">IF</span> <span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bSequenceReady</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">IF</span> <span class="n">bLimitFwd</span> <span class="n">THEN</span>
                <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
              <span class="n">ELSE</span>
                            <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>  <span class="o">//</span><span class="n">Standing</span> <span class="n">on</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">go</span> <span class="n">direct</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">2</span>
              <span class="n">END_IF</span>
            <span class="n">END_IF</span>
              <span class="mi">1</span><span class="p">:</span> <span class="o">//</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">reach</span> <span class="n">low</span> <span class="n">limit</span> <span class="n">then</span> <span class="n">trigger</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">);</span>
            <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Direction</span><span class="o">:=</span><span class="n">MC_Positive_Direction</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Execute</span> <span class="n">MC_MoveVelocity</span>
                <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLimitFwd</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">MC_MoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">goes</span> <span class="n">down</span> <span class="n">when</span> <span class="n">ramp</span> <span class="n">down</span> <span class="n">initiates</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ends</span><span class="p">)</span><span class="o">.</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>
                <span class="n">END_IF</span>
              <span class="mi">2</span><span class="p">:</span> <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteHomeToSwitch</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirTwoardsCam</span><span class="o">:=</span><span class="n">MC_Negative_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirOffCam</span><span class="o">:=</span><span class="n">MC_Negative_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityToCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">;</span> <span class="o">//</span> <span class="n">High</span> <span class="n">speed</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityFromCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityFromCam</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Low</span> <span class="n">speed</span>
                <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bCamSensor</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bLimitFwd</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">3</span><span class="p">;</span>
                      <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableHighOriginal</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableLowOriginal</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
          <span class="mi">3</span><span class="p">:</span> <span class="o">//</span> <span class="n">restore</span> <span class="n">softlimit</span> <span class="n">enable</span>
            <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
              <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
                      <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
       <span class="n">END_CASE</span><span class="p">;</span>

   <span class="mi">3</span><span class="p">:</span> <span class="o">//</span> <span class="n">Home</span> <span class="n">on</span> <span class="n">bHomeSensor</span> <span class="n">via</span> <span class="n">bLimitBwd</span>
       <span class="n">CASE</span> <span class="n">nHomingState</span> <span class="n">OF</span>
              <span class="mi">0</span><span class="p">:</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">read</span> <span class="n">of</span> <span class="n">velocities</span> <span class="kn">from</span><span class="w"> </span><span class="nn">NC</span> <span class="ow">and</span> <span class="n">reset</span> <span class="n">of</span> <span class="n">calibration</span> <span class="n">flag</span>
            <span class="n">IF</span> <span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bSequenceReady</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">IF</span> <span class="n">bLimitBwd</span> <span class="n">THEN</span>
                <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
              <span class="n">ELSE</span>
                            <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>  <span class="o">//</span><span class="n">Standing</span> <span class="n">on</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">go</span> <span class="n">direct</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">2</span>
              <span class="n">END_IF</span>
            <span class="n">END_IF</span>
              <span class="mi">1</span><span class="p">:</span> <span class="o">//</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">reach</span> <span class="n">low</span> <span class="n">limit</span> <span class="n">then</span> <span class="n">trigger</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">);</span>
            <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Direction</span><span class="o">:=</span><span class="n">MC_Negative_Direction</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Execute</span> <span class="n">MC_MoveVelocity</span>
                <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLimitBwd</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">MC_MoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">goes</span> <span class="n">down</span> <span class="n">when</span> <span class="n">ramp</span> <span class="n">down</span> <span class="n">initiates</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ends</span><span class="p">)</span><span class="o">.</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>
                <span class="n">END_IF</span>
              <span class="mi">2</span><span class="p">:</span> <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteHomeToSwitch</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirTwoardsCam</span><span class="o">:=</span><span class="n">MC_Positive_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirOffCam</span><span class="o">:=</span><span class="n">MC_Positive_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityToCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">;</span> <span class="o">//</span> <span class="n">High</span> <span class="n">speed</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityFromCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityFromCam</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Low</span> <span class="n">speed</span>
                <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bCamSensor</span><span class="o">:=</span><span class="n">bHomeSensor</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">3</span><span class="p">;</span>
                      <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableHighOriginal</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableLowOriginal</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
          <span class="mi">3</span><span class="p">:</span> <span class="o">//</span> <span class="n">restore</span> <span class="n">softlimit</span> <span class="n">enable</span>
            <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                  <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
              <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
                      <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
       <span class="n">END_CASE</span><span class="p">;</span>
    <span class="mi">4</span><span class="p">:</span>  <span class="o">//</span> <span class="n">Home</span> <span class="n">on</span> <span class="n">bHomeSensor</span> <span class="n">via</span> <span class="n">bLimitFwd</span>
       <span class="n">CASE</span> <span class="n">nHomingState</span> <span class="n">OF</span>
              <span class="mi">0</span><span class="p">:</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">read</span> <span class="n">of</span> <span class="n">velocities</span> <span class="kn">from</span><span class="w"> </span><span class="nn">NC</span> <span class="ow">and</span> <span class="n">reset</span> <span class="n">of</span> <span class="n">calibration</span> <span class="n">flag</span>
            <span class="n">IF</span> <span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bSequenceReady</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">IF</span> <span class="n">bLimitFwd</span> <span class="n">THEN</span>
                <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
              <span class="n">ELSE</span>
                            <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>  <span class="o">//</span><span class="n">Standing</span> <span class="n">on</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">go</span> <span class="n">direct</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">2</span>
              <span class="n">END_IF</span>
            <span class="n">END_IF</span>
              <span class="mi">1</span><span class="p">:</span> <span class="o">//</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">reach</span> <span class="n">low</span> <span class="n">limit</span> <span class="n">then</span> <span class="n">trigger</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">);</span>
            <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Direction</span><span class="o">:=</span><span class="n">MC_Positive_Direction</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Execute</span> <span class="n">MC_MoveVelocity</span>
                <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLimitFwd</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">MC_MoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">goes</span> <span class="n">down</span> <span class="n">when</span> <span class="n">ramp</span> <span class="n">down</span> <span class="n">initiates</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ends</span><span class="p">)</span><span class="o">.</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>
                <span class="n">END_IF</span>
              <span class="mi">2</span><span class="p">:</span> <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteHomeToSwitch</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirTwoardsCam</span><span class="o">:=</span><span class="n">MC_Negative_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirOffCam</span><span class="o">:=</span><span class="n">MC_Negative_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityToCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">;</span> <span class="o">//</span> <span class="n">High</span> <span class="n">speed</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityFromCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityFromCam</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Low</span> <span class="n">speed</span>
                <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bCamSensor</span><span class="o">:=</span><span class="n">bHomeSensor</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">3</span><span class="p">;</span>
                      <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableHighOriginal</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableLowOriginal</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
          <span class="mi">3</span><span class="p">:</span> <span class="o">//</span> <span class="n">Restore</span> <span class="n">softlimit</span> <span class="n">enable</span>
            <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
              <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
                      <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
       <span class="n">END_CASE</span><span class="p">;</span>

   <span class="mi">15</span><span class="p">:</span> <span class="o">//</span><span class="n">Set</span> <span class="n">current</span> <span class="n">position</span> <span class="p">(</span><span class="n">simplest</span> <span class="n">homing</span> <span class="n">sequence</span><span class="p">)</span>
     <span class="n">bExecuteHomeDirect</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>
     <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
     <span class="n">IF</span> <span class="n">fbHomeDirect</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>  <span class="o">//</span><span class="n">Homing</span> <span class="n">ready</span>
       <span class="n">bExecuteHomeDirect</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
       <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
     <span class="n">END_IF</span>

<span class="n">ELSE</span>
  <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bCamSensor</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
<span class="n">END_CASE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Main</span> <span class="n">homing</span> <span class="n">block</span>
<span class="n">fbHomeToSwitch</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteHomeToSwitch</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecuteHomeDirect</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecuteMoveVelocity</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
    <span class="n">fHomePosition</span><span class="o">:=</span><span class="n">fHomePosition</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Approach</span> <span class="n">limit</span> <span class="n">switch</span> <span class="p">(</span><span class="n">error</span> <span class="k">if</span> <span class="n">MC_Home</span> <span class="ow">is</span> <span class="n">used</span><span class="p">)</span>
<span class="n">fbMoveVelocity</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span> <span class="n">bExecuteMoveVelocity</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecuteHomeToSwitch</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecuteHomeDirect</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">No</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">just</span> <span class="nb">set</span> <span class="n">position</span> <span class="n">value</span> <span class="p">(</span><span class="n">nCmdDataLocal</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span> <span class="n">Can</span> <span class="ow">not</span> <span class="n">run</span> <span class="k">if</span> <span class="n">fbHomeToSwitch</span> <span class="ow">is</span> <span class="n">executed</span>
<span class="n">fbHomeDirect</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteHomeDirect</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span>  <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecuteHomeToSwitch</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecuteMoveVelocity</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
    <span class="n">fHomePosition</span><span class="o">:=</span><span class="n">fHomePosition</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
<span class="p">);</span>


<span class="o">//</span><span class="c1">############# Finish homing</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bexecute</span> <span class="n">AND</span> <span class="n">bRestoreNCDataNeeded</span> <span class="n">THEN</span>  <span class="o">//</span><span class="n">If</span> <span class="n">homing</span> <span class="ow">is</span> <span class="n">aborted</span> <span class="n">restore</span> <span class="ow">is</span> <span class="n">needed</span>
    <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
      <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">fbHomeFinish</span><span class="p">(</span>
  <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
  <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteFinish</span><span class="p">,</span>
  <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
  <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Error</span> <span class="n">handling</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">IF</span> <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
  <span class="n">ELSIF</span> <span class="n">fbHomeDirect</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbHomeDirect</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeDirect</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
  <span class="n">ELSIF</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">ErrorId</span><span class="p">;</span>
  <span class="n">END_IF</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Done</span> <span class="ow">and</span> <span class="n">busy</span> <span class="n">bit</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">bSequenceReady</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">;</span>
<span class="n">bBusy</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bSequenceReady</span><span class="p">;</span>

<span class="n">RETURN</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-homedirect">FB_HomeDirect</a></p></li>
<li><p><a class="reference internal" href="#fb-homefinish">FB_HomeFinish</a></p></li>
<li><p><a class="reference internal" href="#fb-homeprepare">FB_HomePrepare</a></p></li>
<li><p><a class="reference internal" href="#fb-hometoswitch">FB_HomeToSwitch</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homewritencvelocities">
<h2>FB_HomeWriteNcVelocities<a class="headerlink" href="#fb-homewritencvelocities" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeWriteNcVelocities</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fVelocityToCam</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVelocityFromCam</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbExecuteRiseEdge</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fbWriteVelocityToCam</span><span class="p">:</span><span class="n">FB_WriteFloatParameter</span><span class="p">;</span>
    <span class="n">fbWriteVelocityFromCam</span><span class="p">:</span><span class="n">FB_WriteFloatParameter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbExecuteRiseEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>

<span class="n">fbWriteVelocityToCam</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#4000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#6,</span>
    <span class="n">nData</span><span class="o">:=</span><span class="n">fVelocityToCam</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">fbWriteVelocityFromCam</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#4000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#7,</span>
    <span class="n">nData</span><span class="o">:=</span><span class="n">fVelocityFromCam</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbWriteVelocityFromCam</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbWriteVelocityToCam</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbWriteVelocityFromCam</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbWriteVelocityToCam</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbWriteVelocityToCam</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbWriteVelocityFromCam</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">fbWriteVelocityToCam</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteVelocityToCam</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteVelocityFromCam</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteVelocityFromCam</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-writefloatparameter">FB_WriteFloatParameter</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homewritesoftlimenable">
<h2>FB_HomeWriteSoftLimEnable<a class="headerlink" href="#fb-homewritesoftlimenable" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeWriteSoftLimEnable</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bSofLimEnableLow</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSofLimEnableHigh</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbExecuteRiseEdge</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fbWriteSoftLimEnableLow</span><span class="p">:</span><span class="n">FB_WriteParameterInNc_v1_00</span><span class="p">;</span>
    <span class="n">fbWriteSoftLimEnableHigh</span><span class="p">:</span><span class="n">FB_WriteParameterInNc_v1_00</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbExecuteRiseEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>

<span class="n">fbWriteSoftLimEnableLow</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#5000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#B,</span>
    <span class="n">nData</span><span class="o">:=</span><span class="n">BOOL_TO_DWORD</span><span class="p">(</span><span class="n">bSofLimEnableLow</span><span class="p">),</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">fbWriteSoftLimEnableHigh</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#5000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#C,</span>
    <span class="n">nData</span><span class="o">:=</span><span class="n">BOOL_TO_DWORD</span><span class="p">(</span><span class="n">bSofLimEnableHigh</span><span class="p">),</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbWriteSoftLimEnableLow</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbWriteSoftLimEnableHigh</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbWriteSoftLimEnableLow</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbWriteSoftLimEnableHigh</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbWriteSoftLimEnableHigh</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbWriteSoftLimEnableLow</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">fbWriteSoftLimEnableHigh</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteSoftLimEnableHigh</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteSoftLimEnableLow</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteSoftLimEnableLow</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-writeparameterinnc-v1-00">FB_WriteParameterInNc_v1_00</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-limswstatus">
<h2>FB_LimSwStatus<a class="headerlink" href="#fb-limswstatus" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LimSwStatus</span> <span class="n">IMPLEMENTS</span> <span class="n">I_LimSwStatus</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Hardware</span> <span class="o">*</span><span class="p">)</span>
   <span class="o">//</span> <span class="n">NC</span> <span class="n">Forward</span> <span class="n">Limit</span> <span class="n">Switch</span><span class="p">:</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ok</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">bLimitForwardEnable</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">NC</span> <span class="n">Backward</span> <span class="n">Limit</span> <span class="n">Switch</span><span class="p">:</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ok</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">bLimitBackwardEnable</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">NO</span> <span class="n">Home</span> <span class="n">Switch</span><span class="p">:</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">at</span> <span class="n">home</span>
    <span class="n">bHome</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">PROPERTY</span> <span class="n">LimBackward</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">LimBackward</span> <span class="o">:=</span> <span class="n">bLimitBackwardEnable</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">LimForward</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">LimForward</span> <span class="o">:=</span> <span class="n">bLimitForwardEnable</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">LimHome</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">LimHome</span> <span class="o">:=</span>  <span class="n">bHome</span> <span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
</section>
<section id="fb-logmotionerror">
<h2>FB_LogMotionError<a class="headerlink" href="#fb-logmotionerror" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LogMotionError</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">If</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">struct</span> <span class="n">has</span> <span class="n">an</span> <span class="n">error</span><span class="p">,</span> <span class="n">log</span> <span class="n">it</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">log</span> <span class="n">condition</span> <span class="ow">is</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">When</span> <span class="n">bError</span> <span class="n">goes</span> <span class="n">TRUE</span> <span class="p">(</span><span class="n">catch</span> <span class="n">transition</span> <span class="kn">from</span><span class="w"> </span><span class="nn">no</span> <span class="n">error</span> <span class="n">to</span> <span class="n">error</span><span class="p">)</span>
    <span class="o">-</span> <span class="n">When</span> <span class="n">the</span> <span class="n">error</span> <span class="n">message</span> <span class="n">changes</span> <span class="k">while</span> <span class="n">bError</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="p">(</span><span class="n">catch</span> <span class="n">transition</span> <span class="kn">from</span><span class="w"> </span><span class="nn">error</span> <span class="n">a</span> <span class="n">to</span> <span class="n">error</span> <span class="n">b</span><span class="p">)</span>

    <span class="n">Includes</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">NC</span> <span class="n">error</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">json</span> <span class="n">blob</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbLogMessage</span><span class="p">:</span> <span class="n">FB_LogMessage</span><span class="p">;</span>
    <span class="n">rtNewError</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bChangedError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sPrevErr</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fbJson</span><span class="p">:</span> <span class="n">FB_JsonSaxWriter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtNewError</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">);</span>
<span class="n">bChangedError</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;&#39;</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">&lt;&gt;</span> <span class="n">sPrevErr</span><span class="p">;</span>
<span class="n">sPrevErr</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bEnable</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rtNewError</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">bChangedError</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">StartObject</span><span class="p">();</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddString</span><span class="p">(</span><span class="s1">&#39;ST_MotionStage.bError&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;dut_name&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddString</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">sName</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;axis_name&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddString</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">sAxisName</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;axis_id&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddUdint</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">AxisId</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;err_id&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddUdint</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddLreal</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;position_lag&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddLreal</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActDiff</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">EndObject</span><span class="p">();</span>
    <span class="n">fbLogMessage</span><span class="o">.</span><span class="n">sJson</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">GetDocument</span><span class="p">();</span>
    <span class="n">fbLogMessage</span><span class="p">(</span>
        <span class="n">sMsg</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span>
        <span class="n">eSevr</span> <span class="o">:=</span> <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span>
        <span class="n">eSubsystem</span> <span class="o">:=</span> <span class="n">E_Subsystem</span><span class="o">.</span><span class="n">MOTION</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">ResetDocument</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-microstepcounttest">
<h2>FB_MicroStepCountTest<a class="headerlink" href="#fb-microstepcounttest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MicroStepCountTest</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fStepSize</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nSteps</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fMicroStep</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tSettleTime</span><span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">nStepsCounted</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nTheorySteps</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fPercent</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fEstMicroSize</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbMoveRel</span><span class="p">:</span> <span class="n">MC_MoveRelative</span><span class="p">;</span>
    <span class="n">fbSettleTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bDoMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nStepCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="n">arrPosBuffer</span><span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0..99</span><span class="p">]</span> <span class="n">OF</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fAvgPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nArrIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nLoopIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="n">fStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPrevPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fStepChange</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="n">fStepSum</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Motion</span> <span class="n">FB</span>
<span class="n">fbMoveRel</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bDoMove</span><span class="p">,</span>
    <span class="n">Distance</span><span class="o">:=</span><span class="n">fStepSize</span><span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">fVelocity</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Settle</span> <span class="n">time</span>
<span class="n">fbSettleTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">fbMoveRel</span><span class="o">.</span><span class="n">Done</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">tSettleTime</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Re</span><span class="o">-</span><span class="n">enable</span> <span class="n">the</span> <span class="n">move</span> <span class="k">for</span> <span class="nb">next</span> <span class="n">cycle</span>
<span class="n">bDoMove</span> <span class="o">:=</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">nStepCounter</span> <span class="o">&lt;</span> <span class="n">nSteps</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Calculate</span> <span class="n">rolling</span> <span class="n">average</span>
<span class="n">arrPosBuffer</span><span class="p">[</span><span class="n">nArrIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">;</span>
<span class="n">fAvgPos</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nLoopIndex</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="mi">99</span> <span class="n">DO</span>
    <span class="n">fAvgPos</span> <span class="o">:=</span> <span class="n">fAvgPos</span> <span class="o">+</span> <span class="n">arrPosBuffer</span><span class="p">[</span><span class="n">nLoopIndex</span><span class="p">];</span>
<span class="n">END_FOR</span><span class="p">;</span>
<span class="n">fAvgPos</span> <span class="o">:=</span> <span class="n">fAvgPos</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
<span class="n">nArrIndex</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nArrIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="n">MOD</span> <span class="mi">100</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Initialize</span> <span class="n">starting</span> <span class="n">variables</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">fStartPos</span> <span class="o">:=</span> <span class="n">fAvgPos</span><span class="p">;</span>
    <span class="n">fPrevPos</span> <span class="o">:=</span> <span class="n">fAvgPos</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Check</span> <span class="n">results</span>
<span class="n">IF</span> <span class="n">fbSettleTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">fStepChange</span> <span class="o">:=</span> <span class="n">fAvgPos</span> <span class="o">-</span> <span class="n">fPrevPos</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Invert</span> <span class="n">fStepChange</span> <span class="k">if</span> <span class="n">we</span> <span class="n">were</span> <span class="n">doing</span> <span class="n">negative</span> <span class="n">steps</span>
    <span class="n">IF</span> <span class="n">fStepSize</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">fStepChange</span> <span class="o">:=</span> <span class="n">fStepChange</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">IF</span> <span class="n">fStepChange</span> <span class="o">&gt;</span> <span class="n">fMicroStep</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="n">THEN</span>
        <span class="n">nStepsCounted</span> <span class="o">:=</span> <span class="n">nStepsCounted</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">fStepSum</span> <span class="o">:=</span> <span class="n">fStepSum</span> <span class="o">+</span> <span class="n">fStepChange</span><span class="p">;</span>
        <span class="n">fEstMicroSize</span> <span class="o">:=</span> <span class="n">fStepSum</span> <span class="o">/</span> <span class="n">nStepsCounted</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">nTheorySteps</span> <span class="o">:=</span> <span class="n">DINT_TO_UINT</span><span class="p">(</span><span class="n">TRUNC</span><span class="p">(</span><span class="n">ABS</span><span class="p">((</span><span class="n">fStartPos</span> <span class="o">-</span> <span class="n">fAvgPos</span><span class="p">)</span> <span class="o">/</span> <span class="n">fMicroStep</span><span class="p">)));</span>
    <span class="n">IF</span> <span class="n">nTheorySteps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">fPercent</span> <span class="o">:=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">nStepsCounted</span> <span class="o">/</span> <span class="n">nTheorySteps</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">fPrevPos</span> <span class="o">:=</span> <span class="n">fAvgPos</span><span class="p">;</span>
    <span class="n">nStepCounter</span> <span class="o">:=</span> <span class="n">nStepCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">move</span> <span class="n">block</span>
    <span class="n">bDoMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-miscstateserrorffo">
<h2>FB_MiscStatesErrorFFO<a class="headerlink" href="#fb-miscstateserrorffo" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_MiscStatesErrorFFO
(*
    A catch-all for miscellaneous state FFOs that are not better organized elsewhere.
    Contains the following fast faults:
    - ffBeamParamsOK: trip the beam if the beam parameters are not safe enough for our current (known) state
    - ffZeroRate: trip the beam if we&#39;ve asked for zero rate (as a shortcut)
    - ffUnknown: trip the beam if we&#39;re at an unknown state and our transition id is not asserted.
    - ffDebounce: trip the beam (no autoreset) if ffBeamParamsOK fast faults fault on and off multiple times too quickly.
      This solves an issue where ffBeamParamsOK might solve its own problem and creating a blinking fast fault issue.

    The inputs are mostly outputs of non-pmps function blocks and heavily-reused info like state details.
*)
VAR_IN_OUT
    // The arbiter to request beam states from
    fbArbiter: FB_Arbiter;
    // The fast fault output to fault to
    fbFFHWO: FB_HardwareFFOutput;
END_VAR
VAR_INPUT
    // A name to link to these fast faults
    sDeviceName: STRING;
    // Current requested beam details: either a known state or the transition beam
    stCurrentBeamReq: ST_BeamParams;
    // TRUE if we&#39;re at a known state (doesn&#39;t matter which)
    bKnownState: BOOL;
    // Lookup ID of the transition beam
    nTransitionID: DWORD;
END_VAR
VAR_OUTPUT
END_VAR
VAR CONSTANT
    // Number of consecutive trips before we debounce
    nMaxTrips: UINT := 5;
    // Decrease trip count by 1 after this much time has passed
    tTripReset: TIME := T#1s;
END_VAR
VAR
    // If the beam parameters are wrong, it is a fault! This encompasses all unknown arbiter-related errors.
    ffBeamParamsOk: FB_FastFault;
    // If we asked for zero rate (NC or SC) then we can cut the beam early. This is somewhat redundant.
    ffZeroRate: FB_FastFault;
    // Trip the beam for unknown state
    ffUnknown: FB_FastFault;
    // Trip the beam (no autoreset) if ffBeamParamsOK faults/resets multiple times too quickly.
    ffDebounce: FB_FastFault;

    // Number of consecutive trips so far
    nTripCount: UINT;
    // Increase by 1 whenever there is a fault (rising edge)
    ftTripCount: F_TRIG;
    // Decrease trip count by 1 each timeout
    tonTripCount: TON;
    // TRUE on only the first cycle
    bFirstCycle: BOOL := TRUE;
END_VAR
ffBeamParamsOk(
    i_xOK:=F_SafeBPCompare(PMPS_GVL.stCurrentBeamParameters, stCurrentBeamReq),
    i_xAutoReset:=TRUE,
    i_DevName:=sDeviceName,
    i_Desc:=&#39;Beam parameter mismatch&#39;,
    i_TypeCode:=E_MotionFFType.BP_MISMATCH,
    io_fbFFHWO:=fbFFHWO);

CASE PMPS_GVL.stCurrentBeamParameters.nMachineMode OF
    // NC mode
    1: ffZeroRate.i_xOK := stCurrentBeamReq.nRate &gt; 0;
    // SC mode
    2: ffZeroRate.i_xOK := stCurrentBeamReq.nBCRange &gt; 0;
ELSE
    // Ambiguous or new mode
    ffZeroRate.i_xOK := stCurrentBeamReq.nRate &gt; 0 AND stCurrentBeamReq.nBCRange &gt; 0;
END_CASE

ffZeroRate(
    i_xAutoReset := TRUE,
    i_DevName := sDeviceName,
    i_Desc := &#39;Device requesting zero rate&#39;,
    i_TypeCode := E_MotionFFType.ZERO_RATE,
    io_fbFFHWO := fbFFHWO,
);

ffUnknown(
    i_xOK := bknownState OR fbArbiter.CheckRequestInPool(nReqID:=nTransitionID),
    i_xAutoReset := TRUE,
    i_DevName := sDeviceName,
    i_Desc := &#39;Unknown position between moves&#39;,
    i_TypeCode := E_MotionFFType.NOT_A_STATE,
    io_fbFFHWO := fbFFHWO,
);

ftTripCount(CLK:=ffBeamParamsOk.i_xOK);

IF ftTripCount.Q THEN
    nTripCount := MIN(nTripCount + 1, 5);
END_IF

tonTripCount(
    IN:=NOT tonTripCount.Q,
    PT:=tTripReset,
);
IF tonTripCount.Q AND nTripCount &gt; 0 THEN
    nTripCount := nTripCount - 1;
END_IF

// This is required for non-autoresetting FBs to come up in a beam permitted state
ffDebounce.i_xReset := bFirstCycle OR nTripCount=0;
ffDebounce(
    i_xOK := nTripCount &lt; 5,
    i_DevName := sDeviceName,
    i_Desc := &#39;Tripped beam parameter mismatch off/on too many times, hold off&#39;,
    i_TypeCode := E_MotionFFType.TOO_MANY_TRIPS,
    io_fbFFHWO := fbFFHWO,
);
bFirstCycle := FALSE;

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-miscstateserrorffo-test">
<h2>FB_MiscStatesErrorFFO_Test<a class="headerlink" href="#fb-miscstateserrorffo-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_MiscStatesErrorFFO_Test EXTENDS TcUnit.FB_TestSuite
(*
    Unit tests for FB_MiscStatesErrorFFO
*)
VAR
END_VAR
TestBeamParamsNotOk();
TestZeroRate();
TestUnknownState();
TestTransitionState();
TestDebounce();

END_FUNCTION_BLOCK

METHOD TestBeamParamsNotOk
VAR_INST
    fbMiscFFO: FB_MiscStatesErrorFFO;
    fbArbiter: FB_Arbiter(1);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);

    stBeamReq: ST_BeamParams;
END_VAR
TEST(&#39;TestBeamParamsNotOk&#39;);

fbFFHWO.EvaluateOutput();
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Started with a fault&#39;,
);

// Trigger only a beam parameter mismatch
// Do not trip zero rate, unknown state, or debounce
PMPS_GVL.stCurrentBeamParameters := PMPS_GVL.cstFullBeam;
stBeamReq := PMPS_GVL.cstFullBeam;
stBeamReq.nTran := 0.5;
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=stBeamReq,
    bKnownState:=TRUE,
    nTransitionID:=1,
);

fbFFHWO.EvaluateOutput();
AssertFalse(
    fbFFHWO.q_xFastFaultOut,
    &#39;Did not fault with bad attenuator state&#39;,
);

TEST_FINISHED();
END_METHOD

METHOD TestDebounce
VAR_INST
    fbMiscFFO: FB_MiscStatesErrorFFO;
    fbArbiter: FB_Arbiter(5);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);
END_VAR
VAR
    nIter: DINT;
END_VAR
TEST(&#39;TestDebounce&#39;);

fbFFHWO.EvaluateOutput();
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Started with a fault prior to first FB run-through&#39;,
);
// Ask for full beam: there should be no faults of any kind
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=PMPS_GVL.cstFullBeam,
    bKnownState:=TRUE,
    nTransitionID:=5,
);
fbFFHWO.EvaluateOutput();

AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Started with a fault prior to trip checks&#39;,
);

// Trip and untrip the beam fast fault once, show no fault
TripUntrip(
    fbMiscFFO:=fbMiscFFO,
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
);
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Control group failed: one trip/untrip should not be enough to debounce&#39;,
);
// Trip and untrip the beam fast fault like 10 times, show fault
FOR nIter := 1 TO 10 DO
    TripUntrip(
        fbMiscFFO:=fbMiscFFO,
        fbArbiter:=fbArbiter,
        fbFFHWO:=fbFFHWO,
    );
END_FOR
AssertFalse(
    fbFFHWO.q_xFastFaultOut,
    &#39;Debouncer failed to debounce&#39;,
);

TEST_FINISHED();
END_METHOD

METHOD TestTransitionState
VAR_INST
    fbMiscFFO: FB_MiscStatesErrorFFO;
    fbArbiter: FB_Arbiter(4);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);
END_VAR
TEST(&#39;TestTransitionState&#39;);

fbFFHWO.EvaluateOutput();
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Started with a fault&#39;,
);

// Trigger no faults, we&#39;re at an unknown state but it&#39;s a transition state
// Do not trip bad beam, zero rate, or debounce
fbArbiter.AddRequest(
    nReqID:=4,
    stReqBP:=PMPS_GVL.cstFullBeam,
    sDevName:=&#39;UnitTest&#39;,
);
PMPS_GVL.stCurrentBeamParameters := PMPS_GVL.cstFullBeam;
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=PMPS_GVL.cstFullBeam,
    bKnownState:=FALSE,
    nTransitionID:=4,
);

fbFFHWO.EvaluateOutput();
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Faulted in unknown states even though we were moving normally&#39;,
);

TEST_FINISHED();
END_METHOD

METHOD TestUnknownState
VAR_INST
    fbMiscFFO: FB_MiscStatesErrorFFO;
    fbArbiter: FB_Arbiter(3);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);
END_VAR
TEST(&#39;TestUnknownState&#39;);

fbFFHWO.EvaluateOutput();
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Started with a fault&#39;,
);

// Trigger only an unknown states
// Do not trip bad beam, zero rate, or debounce
PMPS_GVL.stCurrentBeamParameters := PMPS_GVL.cstFullBeam;
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=PMPS_GVL.cstFullBeam,
    bKnownState:=FALSE,
    nTransitionID:=3,
);

fbFFHWO.EvaluateOutput();
AssertFalse(
    fbFFHWO.q_xFastFaultOut,
    &#39;Did not fault with unknown state&#39;,
);

TEST_FINISHED();
END_METHOD

METHOD TestZeroRate
VAR_INST
    fbMiscFFO: FB_MiscStatesErrorFFO;
    fbArbiter: FB_Arbiter(2);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);

    stNoBeam: ST_BeamParams;
END_VAR
TEST(&#39;TestBeamZeroRate&#39;);

fbFFHWO.EvaluateOutput();
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Started with a fault&#39;,
);

// Trigger only a zero rate
// Do not trip beam parameter mismatch, unknown state, or debounce
PMPS_GVL.stCurrentBeamParameters := stNoBeam;
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=PMPS_GVL.cst0RateBeam,
    bKnownState:=TRUE,
    nTransitionID:=2
);

fbFFHWO.EvaluateOutput();
AssertFalse(
    fbFFHWO.q_xFastFaultOut,
    &#39;Did not fault with zero rate&#39;,
);

TEST_FINISHED();
END_METHOD

METHOD TripUntrip
VAR_IN_OUT
    fbMiscFFO: FB_MiscStatesErrorFFO;
    fbArbiter: FB_Arbiter;
    fbFFHWO: FB_HardwareFFOutput;
END_VAR
VAR
    stBeamReq: ST_BeamParams;
END_VAR
// Use anything other than 0 rate, which is its own check
stBeamReq := PMPS_GVL.cstFullBeam;
stBeamReq.nTran := 0.5;
// Trip: too much beam!
PMPS_GVL.stCurrentBeamParameters := PMPS_GVL.cstFullBeam;
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=stBeamReq,
    bKnownState:=TRUE,
    nTransitionID:=5,
);
fbFFHWO.EvaluateOutput();

// Untrip: correct beam!
PMPS_GVL.stCurrentBeamParameters := stBeamReq;
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=stBeamReq,
    bKnownState:=TRUE,
    nTransitionID:=5,
);
fbFFHWO.EvaluateOutput();
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-miscstateserrorffo">FB_MiscStatesErrorFFO</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionaxisnc">
<h2>FB_MotionAxisNC<a class="headerlink" href="#fb-motionaxisnc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionAxisNC</span> <span class="n">IMPLEMENTS</span> <span class="n">I_MotionAxis</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">iHome</span> <span class="p">:</span> <span class="n">I_Home</span><span class="p">;</span>
    <span class="n">iHalt</span> <span class="p">:</span> <span class="n">I_Halt</span><span class="p">;</span>
    <span class="n">iPower</span> <span class="p">:</span> <span class="n">I_Power</span><span class="p">;</span>
    <span class="n">iReset</span> <span class="p">:</span> <span class="n">I_Reset</span><span class="p">;</span>
    <span class="n">iMoveAbsolute</span> <span class="p">:</span> <span class="n">I_MoveAbsolute</span><span class="p">;</span>
    <span class="n">iReadParameter</span> <span class="p">:</span> <span class="n">I_ReadParameter</span><span class="p">;</span>
    <span class="n">iWriteParameter</span>  <span class="p">:</span> <span class="n">I_WriteParameter</span><span class="p">;</span>
    <span class="n">iParamSaveRestore</span><span class="p">:</span> <span class="n">I_ParamSaveRestore</span><span class="p">;</span>
    <span class="n">iEncoderScaling</span> <span class="p">:</span> <span class="n">I_EncoderScaling</span><span class="p">;</span>
    <span class="n">iAxisStatus</span> <span class="p">:</span> <span class="n">I_AxisStatus</span><span class="p">;</span>
    <span class="n">iBacklashCompensation</span> <span class="p">:</span> <span class="n">I_BacklashCompensation</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span><span class="p">;</span>
    <span class="n">rtAbortDone</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">AxisEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">AxisEnabled</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">AxisEnabled</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="p">(</span><span class="o">*</span>
    <span class="n">Handle</span> <span class="n">positive</span><span class="o">/</span><span class="n">negative</span> <span class="n">backlash</span> <span class="n">compensation</span>
    <span class="n">User</span> <span class="n">needs</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">direction</span> <span class="n">of</span> <span class="n">backlash</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">sign</span> <span class="n">of</span> <span class="n">the</span> <span class="n">compensation</span> <span class="n">value</span>
    <span class="n">Backlash</span> <span class="n">compensation</span> <span class="ow">is</span> <span class="n">disabled</span> <span class="n">during</span> <span class="n">referencing</span> <span class="p">(</span><span class="n">homing</span><span class="p">)</span><span class="o">.</span>
    <span class="n">When</span> <span class="n">direction</span> <span class="ow">is</span> <span class="n">positive</span><span class="o">/</span><span class="n">negative</span><span class="p">,</span> <span class="n">further</span> <span class="n">movement</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">negative</span><span class="o">/</span><span class="n">positive</span> <span class="n">direction</span> <span class="ow">not</span> <span class="n">compensated</span>
    <span class="n">further</span> <span class="n">movement</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">negative</span><span class="o">/</span><span class="n">positive</span> <span class="n">direction</span> <span class="n">will</span> <span class="n">be</span> <span class="n">compensated</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">METHOD</span> <span class="n">BacklashCompensation</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Active</span>     <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">DisableMode</span>     <span class="p">:</span> <span class="n">E_DISABLEMODE</span> <span class="o">:=</span> <span class="n">E_DISABLEMODE</span><span class="o">.</span><span class="n">DisableModeHold</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iBacklashCompensation</span><span class="o">.</span><span class="n">BacklashCompensation</span><span class="p">(</span>   <span class="n">Activate</span><span class="o">:=</span><span class="n">Active</span><span class="p">,</span>
                                                    <span class="n">DisableMode</span><span class="o">:=</span><span class="n">DisableMode</span>
                                                <span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">iHome</span> <span class="p">:</span> <span class="n">I_Home</span><span class="p">;</span>
    <span class="n">iHalt</span> <span class="p">:</span> <span class="n">I_Halt</span><span class="p">;</span>
    <span class="n">iPower</span> <span class="p">:</span> <span class="n">I_Power</span><span class="p">;</span>
    <span class="n">iReset</span> <span class="p">:</span> <span class="n">I_Reset</span><span class="p">;</span>
    <span class="n">iMoveAbsolute</span> <span class="p">:</span> <span class="n">I_MoveAbsolute</span><span class="p">;</span>
    <span class="n">iReadParameter</span> <span class="p">:</span> <span class="n">I_ReadParameter</span><span class="p">;</span>
    <span class="n">iWriteParameter</span>  <span class="p">:</span> <span class="n">I_WriteParameter</span><span class="p">;</span>
    <span class="n">iParamSaveRestore</span><span class="p">:</span> <span class="n">I_ParamSaveRestore</span><span class="p">;</span>
    <span class="n">iEncoderScaling</span> <span class="p">:</span> <span class="n">I_EncoderScaling</span><span class="p">;</span>
    <span class="n">iAxisStatus</span> <span class="p">:</span> <span class="n">I_AxisStatus</span><span class="p">;</span>
    <span class="n">iBacklashCompensation</span> <span class="p">:</span> <span class="n">I_BacklashCompensation</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span> <span class="o">:=</span> <span class="n">iHome</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iHalt</span> <span class="o">:=</span> <span class="n">iHalt</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iPower</span> <span class="o">:=</span> <span class="n">iPower</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iReset</span> <span class="o">:=</span> <span class="n">iReset</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span> <span class="o">:=</span> <span class="n">iMoveAbsolute</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iReadParameter</span> <span class="o">:=</span> <span class="n">iReadParameter</span> <span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iWriteParameter</span>  <span class="o">:=</span> <span class="n">iWriteParameter</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iParamSaveRestore</span><span class="o">:=</span> <span class="n">iParamSaveRestore</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iEncoderScaling</span> <span class="o">:=</span> <span class="n">iEncoderScaling</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span> <span class="o">:=</span> <span class="n">iAxisStatus</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iBacklashCompensation</span>  <span class="o">:=</span> <span class="n">iBacklashCompensation</span> <span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">DriveCommands</span>
<span class="n">VAR_INPUT</span>
    <span class="n">HomeCmd</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">NewMoveReq</span>      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">EnableMode</span>      <span class="p">:</span> <span class="n">E_StageEnableMode</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">ErrorHandling</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Error</span> <span class="kn">from</span><span class="w"> </span><span class="nn">functions</span> <span class="ow">and</span> <span class="n">Nc</span>
    <span class="n">The</span> <span class="n">error</span> <span class="n">will</span> <span class="n">send</span> <span class="n">to</span> <span class="n">EPICS</span> <span class="n">interface</span> <span class="n">based</span> <span class="n">on</span> <span class="n">predifined</span>
    <span class="n">priority</span><span class="p">:</span> <span class="n">axis</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">backlash</span><span class="p">,</span> <span class="n">absoluteMove</span><span class="p">,</span> <span class="n">etc</span><span class="o">...</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">Error</span>  <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iPower</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iPower</span><span class="o">.</span><span class="n">PowerIsEnabled</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iPower</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iPower</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iPower</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iBacklashCompensation</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iBacklashCompensation</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iBacklashCompensation</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iBacklashCompensation</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span><span class="o">.</span><span class="n">Error</span> <span class="p">(</span><span class="o">*</span><span class="n">Homing</span> <span class="n">error</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHalt</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHalt</span><span class="o">.</span><span class="n">Active</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iHalt</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iHalt</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHalt</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iReset</span><span class="o">.</span><span class="n">Error</span>  <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iReset</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iReset</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iReset</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iReadParameter</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iReadParameter</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iReadParameter</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iReadParameter</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iWriteParameter</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iWriteParameter</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iWriteParameter</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iWriteParameter</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iParamSaveRestore</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iParamSaveRestore</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iParamSaveRestore</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iParamSaveRestore</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>

    <span class="n">iHome</span> <span class="p">:</span> <span class="n">I_Home</span><span class="p">;</span>
    <span class="n">iHalt</span> <span class="p">:</span> <span class="n">I_Halt</span><span class="p">;</span>
    <span class="n">iPower</span> <span class="p">:</span> <span class="n">I_Power</span><span class="p">;</span>
    <span class="n">iReset</span> <span class="p">:</span> <span class="n">I_Reset</span><span class="p">;</span>
    <span class="n">iMoveAbsolute</span> <span class="p">:</span> <span class="n">I_MoveAbsolute</span><span class="p">;</span>
    <span class="n">iReadParameter</span> <span class="p">:</span> <span class="n">I_ReadParameter</span><span class="p">;</span>
    <span class="n">iWriteParameter</span>  <span class="p">:</span> <span class="n">I_WriteParameter</span><span class="p">;</span>
    <span class="n">iParamSaveRestore</span><span class="p">:</span> <span class="n">I_ParamSaveRestore</span><span class="p">;</span>
    <span class="n">iEncoderScaling</span> <span class="p">:</span> <span class="n">I_EncoderScaling</span><span class="p">;</span>
    <span class="n">iAxisStatus</span> <span class="p">:</span> <span class="n">I_AxisStatus</span><span class="p">;</span>
    <span class="n">iBacklashCompensation</span> <span class="p">:</span> <span class="n">I_BacklashCompensation</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span> <span class="o">:=</span> <span class="n">iHome</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iHalt</span> <span class="o">:=</span> <span class="n">iHalt</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iPower</span> <span class="o">:=</span> <span class="n">iPower</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iReset</span> <span class="o">:=</span> <span class="n">iReset</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span> <span class="o">:=</span> <span class="n">iMoveAbsolute</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iReadParameter</span> <span class="o">:=</span> <span class="n">iReadParameter</span> <span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iWriteParameter</span>  <span class="o">:=</span> <span class="n">iWriteParameter</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iParamSaveRestore</span><span class="o">:=</span> <span class="n">iParamSaveRestore</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iEncoderScaling</span> <span class="o">:=</span> <span class="n">iEncoderScaling</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span> <span class="o">:=</span> <span class="n">iAxisStatus</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iBacklashCompensation</span>  <span class="o">:=</span> <span class="n">iBacklashCompensation</span> <span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Halt</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Deceleration</span>    <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Jerk</span>    <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BufferMode</span>      <span class="p">:</span> <span class="n">MC_BufferMode</span> <span class="o">:=</span> <span class="n">MC_BufferMode</span><span class="o">.</span><span class="n">MC_Aborting</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iHalt</span><span class="o">.</span><span class="n">Halt</span><span class="p">(</span>   <span class="n">Deceleration</span><span class="o">:=</span><span class="n">Deceleration</span><span class="p">,</span>
                    <span class="n">Jerk</span><span class="o">:=</span><span class="n">Jerk</span> <span class="p">,</span>
                    <span class="n">BufferMode</span><span class="o">:=</span><span class="n">BufferMode</span> <span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Home</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Execute</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">HomeSpeedFast</span>   <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">HomeSpeedSlow</span>   <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span><span class="o">.</span><span class="n">Home</span><span class="p">(</span> <span class="n">Execute</span><span class="o">:=</span><span class="n">Execute</span><span class="p">,</span>
                  <span class="n">HomeSpeedFast</span><span class="o">:=</span><span class="n">HomeSpeedFast</span><span class="p">,</span>
                  <span class="n">HomeSpeedSlow</span><span class="o">:=</span><span class="n">HomeSpeedSlow</span> <span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">MoveAbsolute</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Position</span>        <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">Velocity</span>        <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">Acceleration</span>    <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">Deceleration</span>    <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">Jerk</span>    <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">BufferMode</span>      <span class="p">:</span> <span class="n">MC_BufferMode</span> <span class="o">:=</span> <span class="n">MC_BufferMode</span><span class="o">.</span><span class="n">MC_Aborting</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">MoveAbsolute</span><span class="p">(</span>   <span class="n">Position</span><span class="o">:=</span><span class="n">Position</span><span class="p">,</span>
                                       <span class="n">Velocity</span> <span class="o">:=</span> <span class="n">Velocity</span><span class="p">,</span>
                                    <span class="n">Acceleration</span> <span class="o">:=</span> <span class="n">Acceleration</span><span class="p">,</span>
                                    <span class="n">Deceleration</span> <span class="o">:=</span> <span class="n">Deceleration</span><span class="p">,</span>
                                    <span class="n">Jerk</span> <span class="o">:=</span> <span class="n">Jerk</span><span class="p">,</span>
                                    <span class="n">BufferMode</span> <span class="o">:=</span> <span class="n">BufferMode</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Power</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Enable</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Enable_Positive</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Enable_Negative</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Override</span>        <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">100.0</span><span class="p">;</span>
    <span class="n">BufferMode</span>      <span class="p">:</span> <span class="n">MC_BufferMode</span> <span class="o">:=</span> <span class="n">MC_BufferMode</span><span class="o">.</span><span class="n">MC_Aborting</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iPower</span><span class="o">.</span><span class="n">Power</span><span class="p">(</span> <span class="n">Enable</span><span class="o">:=</span><span class="n">Enable</span><span class="p">,</span>
                    <span class="n">Enable_Positive</span><span class="o">:=</span> <span class="n">Enable_Positive</span><span class="p">,</span>
                    <span class="n">Enable_Negative</span><span class="o">:=</span><span class="n">Enable_Negative</span><span class="p">,</span>
                    <span class="n">Override</span><span class="o">:=</span><span class="n">Override</span><span class="p">,</span>
                    <span class="n">BufferMode</span><span class="o">:=</span><span class="n">BufferMode</span>
                <span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="p">(</span><span class="o">*</span><span class="n">This</span> <span class="ow">is</span> <span class="n">overriden</span> <span class="n">by</span> <span class="n">this</span> <span class="nb">object</span> <span class="n">internal</span> <span class="n">acess</span> <span class="n">to</span> <span class="n">the</span> <span class="n">interlock</span> <span class="n">instance</span>
  <span class="n">this</span> <span class="ow">is</span> <span class="n">intended</span> <span class="n">to</span> <span class="k">pass</span> <span class="n">power</span> <span class="n">enable</span> <span class="n">flags</span> <span class="n">via</span> <span class="n">the</span> <span class="n">fbMotionDrive</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">METHOD</span> <span class="n">PowerEnables</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Enable</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Enable_Positive</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Enable_Negative</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iPower</span><span class="o">.</span><span class="n">Power</span><span class="p">(</span> <span class="n">Enable</span><span class="o">:=</span><span class="n">Enable</span><span class="p">,</span>
                    <span class="n">Enable_Positive</span><span class="o">:=</span> <span class="n">Enable_Positive</span><span class="p">,</span>
                    <span class="n">Enable_Negative</span><span class="o">:=</span><span class="n">Enable_Negative</span><span class="p">,</span>
                    <span class="n">Override</span><span class="o">:=</span><span class="mf">100.0</span><span class="p">,</span>
                    <span class="n">BufferMode</span><span class="o">:=</span><span class="n">MC_BufferMode</span><span class="o">.</span><span class="n">MC_Aborting</span>
                <span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">ReadAxisParams</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Enable</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">RefreshDelay</span>    <span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iReadParameter</span><span class="o">.</span><span class="n">ReadParameters</span><span class="p">(</span><span class="n">Enable</span><span class="o">:=</span><span class="n">Enable</span><span class="p">,</span> <span class="n">RefreshDelay</span><span class="o">:=</span><span class="n">RefreshDelay</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Reset</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iReset</span><span class="o">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">SaveAxisParams</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Enable</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iParamSaveRestore</span><span class="o">.</span><span class="n">SaveAxisParams</span><span class="p">(</span><span class="n">Enable</span><span class="o">:=</span><span class="n">Enable</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="p">(</span><span class="o">*</span>
    <span class="n">Check</span> <span class="nb">all</span> <span class="n">post</span> <span class="n">condition</span> <span class="n">before</span> <span class="n">updating</span> <span class="n">bCommandedMoveAbsolute</span>
    <span class="n">The</span> <span class="n">implmentatation</span> <span class="n">will</span> <span class="n">depend</span> <span class="n">on</span> <span class="n">the</span> <span class="n">axis</span> <span class="nb">type</span>
    <span class="n">DS402</span> <span class="n">NC</span><span class="o">/</span><span class="n">Direct</span> <span class="n">axis</span> <span class="p">:</span> <span class="n">Implementation</span> <span class="n">need</span> <span class="n">to</span> <span class="n">check</span> <span class="n">that</span> <span class="n">the</span> <span class="n">drive</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">mode</span> <span class="n">before</span> <span class="n">initaiting</span> <span class="n">the</span> <span class="n">move</span> <span class="n">then</span> <span class="nb">set</span> <span class="n">bCommandedMoveAbsolute</span>
    <span class="n">MP</span> <span class="n">NC</span> <span class="n">axis</span> <span class="p">:</span> <span class="n">will</span> <span class="n">immediately</span> <span class="n">write</span> <span class="n">to</span> <span class="n">bCommandedMoveAbsolute</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">METHOD</span> <span class="n">StartMove</span>
<span class="n">VAR_INPUT</span>
    <span class="n">MoveMode</span>        <span class="p">:</span> <span class="n">E_EpicsMotorCmd</span><span class="p">;</span>
    <span class="n">CmdExecute</span>      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CASE</span> <span class="n">MoveMode</span>  <span class="n">OF</span>
    <span class="n">E_EpicsMotorCmd</span><span class="o">.</span><span class="n">MOVE_ABSOLUTE</span><span class="p">:</span>
       <span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">CommandMoveAbsolute</span> <span class="o">:=</span> <span class="n">CmdExecute</span><span class="p">;</span>
    <span class="n">E_EpicsMotorCmd</span><span class="o">.</span><span class="n">HOME</span><span class="p">:</span>
        <span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span><span class="o">.</span><span class="n">Home</span><span class="p">(</span> <span class="n">Execute</span><span class="o">:=</span><span class="n">CmdExecute</span><span class="p">,</span>
                            <span class="n">HomeSpeedFast</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iReadParameter</span><span class="o">.</span><span class="n">RefVeloSearch</span><span class="p">,</span>
                            <span class="n">HomeSpeedSlow</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iReadParameter</span><span class="o">.</span><span class="n">RefVeloSync</span> <span class="p">);</span>
<span class="n">END_CASE</span>
<span class="o">//</span> <span class="k">for</span> <span class="n">typical</span> <span class="n">NC</span> <span class="n">axis</span> <span class="n">no</span> <span class="n">further</span> <span class="n">tests</span> <span class="n">needed</span>
<span class="o">//</span><span class="n">StartMove</span> <span class="o">:=</span> <span class="n">CmdExecute</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">AbortDone</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">AbortDone</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHalt</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iReset</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ABorted</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">Aborted</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">AxisReadParamsInit</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">AxisReadParamsInit</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iReadParameter</span><span class="o">.</span><span class="n">AxisReadParamsInit</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">AxisState</span> <span class="p">:</span> <span class="n">MC_AxisStates</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">AxisState</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">AxisState</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">BacklashCompStatus</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">BacklashCompStatus</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iBacklashCompensation</span><span class="o">.</span><span class="n">Active</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Done</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">bError</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">nErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">HaltActive</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">HaltActive</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHalt</span><span class="o">.</span><span class="n">Active</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">HaltBusy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">HaltBusy</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHalt</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">HaltDone</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">HaltDone</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHalt</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">HomeBusy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">HomeBusy</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">HomeDone</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">HomeDone</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">HomeMode</span> <span class="p">:</span> <span class="n">E_EpicsHomeCmd</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">HomeMode</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iHome</span><span class="o">.</span><span class="n">Mode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">InTargetPosition</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">InTargetPosition</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">InTargetPosition</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MeasuredAcceleration</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MeasuredAcceleration</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">MeasuredAcceleration</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MeasuredCompensation</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MeasuredCompensation</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iBacklashCompensation</span><span class="o">.</span><span class="n">ActCompensation</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MeasuredPosition</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MeasuredPosition</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">MeasuredPosition</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MeasuredPositionDiff</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MeasuredPositionDiff</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">MeasuredPositionDiff</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MeasuredVelocity</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MeasuredVelocity</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">MeasuredVelocity</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MaxString</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Message</span> <span class="o">:=</span><span class="n">sMessage</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MoveAbsoluteAborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MoveAbsoluteAborted</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">Aborted</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MoveAbsoluteActive</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MoveAbsoluteActive</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">Active</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MoveAbsoluteBusy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MoveAbsoluteBusy</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MoveAbsoluteDone</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MoveAbsoluteDone</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMoveAbsolute</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">NegativeMotionIsEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">NegativeMotionIsEnabled</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">NegativeMotionIsEnabled</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">PositiveMotionIsEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">PositiveMotionIsEnabled</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">PositiveMotionIsEnabled</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">PowerActive</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">PowerActive</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iPower</span><span class="o">.</span><span class="n">Active</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">PowerIsEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">PowerOverride</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">PowerOverride</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iPower</span><span class="o">.</span><span class="n">Override</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ResetBusy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ResetBusy</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iReset</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ResetDone</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ResetDone</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iReset</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">RestoreDone</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">RestoreDone</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iParamSaveRestore</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">SavedPosition</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">SavedPosition</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iParamSaveRestore</span><span class="o">.</span><span class="n">SavedPosition</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ScaledEncoderCount</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ScaledEncoderCount</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iEncoderScaling</span><span class="o">.</span><span class="n">EncoderCount</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">StandStill</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">StandStill</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">StandStill</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Stopped</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Stopped</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iAxisStatus</span><span class="o">.</span><span class="n">Stopped</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></p></li>
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionbacklashcompensation">
<h2>FB_MotionBacklashCompensation<a class="headerlink" href="#fb-motionbacklashcompensation" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionBacklashCompensation</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Handle</span> <span class="n">positive</span><span class="o">/</span><span class="n">negative</span> <span class="n">backlash</span> <span class="n">compensation</span>
    <span class="n">User</span> <span class="n">needs</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">direction</span> <span class="n">of</span> <span class="n">backlash</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">sign</span> <span class="n">of</span> <span class="n">the</span> <span class="n">compensation</span> <span class="n">value</span>
    <span class="n">Backlash</span> <span class="n">compensation</span> <span class="ow">is</span> <span class="n">disabled</span> <span class="n">during</span> <span class="n">referencing</span> <span class="p">(</span><span class="n">homing</span><span class="p">)</span><span class="o">.</span>
    <span class="n">When</span> <span class="n">direction</span> <span class="ow">is</span> <span class="n">positive</span><span class="o">/</span><span class="n">negative</span><span class="p">,</span> <span class="n">further</span> <span class="n">movement</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">negative</span><span class="o">/</span><span class="n">positive</span> <span class="n">direction</span> <span class="ow">not</span> <span class="n">compensated</span>
    <span class="n">further</span> <span class="n">movement</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">negative</span><span class="o">/</span><span class="n">positive</span> <span class="n">direction</span> <span class="n">will</span> <span class="n">be</span> <span class="n">compensated</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bHoming</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMoving</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbBacklashCompensation</span><span class="p">:</span> <span class="n">MC_BacklashCompensation</span><span class="p">;</span>
    <span class="n">fPrevCompensation</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">bBacklashCompEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">Note</span><span class="p">:</span> <span class="n">Configure</span> <span class="n">within</span> <span class="n">the</span> <span class="n">axis</span> <span class="n">parameters</span> <span class="nb">set</span> <span class="s2">&quot;position correction&quot;</span> <span class="n">to</span> <span class="n">true</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="n">Directional</span> <span class="n">change</span> <span class="k">for</span> <span class="n">compensation</span>
  <span class="n">default</span><span class="p">:</span> <span class="n">positive</span> <span class="n">backlash</span><span class="p">):</span>
  <span class="n">TRUE</span> <span class="o">-&gt;</span> <span class="n">Negative</span> <span class="n">backlash</span> <span class="n">compensation</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Reset</span> <span class="n">Compensation</span> <span class="n">to</span> <span class="n">register</span> <span class="n">a</span> <span class="n">new</span> <span class="n">value</span> <span class="n">change</span><span class="o">*</span><span class="p">)</span>
<span class="n">bBacklashCompEnable</span> <span class="n">R</span><span class="o">=</span> <span class="n">bHoming</span> <span class="n">OR</span> <span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fBacklash</span><span class="o">&lt;&gt;</span><span class="n">fPrevCompensation</span><span class="p">);</span>
<span class="n">bBacklashCompEnable</span> <span class="n">S</span><span class="o">=</span> <span class="n">bMoving</span><span class="p">;</span>

<span class="n">fbBacklashCompensation</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Enable</span><span class="o">:=</span> <span class="p">(</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bUserBacklashEn</span> <span class="n">AND</span> <span class="n">bBacklashCompEnable</span><span class="p">),</span>
    <span class="n">Backlash</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fBacklash</span><span class="p">,</span>
    <span class="n">CompensationInPositiveDirection</span><span class="o">:=</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fBacklash</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">),</span>
    <span class="n">Ramp</span><span class="o">:=</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">),</span>
    <span class="n">DisableMode</span><span class="o">:=</span><span class="n">DisableModeHold</span><span class="p">,</span>
    <span class="n">Enabled</span><span class="o">=&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBacklashStatus</span><span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span><span class="n">bError</span><span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span><span class="n">nErrorID</span><span class="p">,</span>
    <span class="n">CurrentBacklash</span><span class="o">=&gt;</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fCurrentBacklash</span><span class="p">);</span>

<span class="n">fPrevCompensation</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fBacklash</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionbacklashcompensation-test">
<h2>FB_MotionBacklashCompensation_Test<a class="headerlink" href="#fb-motionbacklashcompensation-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionBacklashCompensation_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span>  <span class="n">FB_MotionStage</span> <span class="n">backlash</span> <span class="n">compensation</span> <span class="n">functionalities</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">The</span> <span class="n">Test</span> <span class="n">capture</span> <span class="n">the</span> <span class="n">status</span> <span class="n">of</span> <span class="n">the</span> <span class="n">backhash</span> <span class="n">FB</span> <span class="n">during</span> <span class="n">homing</span>  <span class="n">expected</span> <span class="n">to</span> <span class="n">be</span> <span class="n">disabled</span>
    <span class="o">-</span> <span class="n">The</span>  <span class="n">status</span> <span class="ow">and</span> <span class="n">value</span> <span class="n">of</span> <span class="n">backlash</span> <span class="n">compensation</span> <span class="ow">in</span> <span class="n">either</span> <span class="n">direction</span> <span class="n">of</span> <span class="nb">set</span> <span class="n">correction</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">fbMotorTestSuite</span>        <span class="p">:</span> <span class="n">FB_MotorTestSuite</span><span class="p">;</span>
    <span class="n">stMotionStage</span>           <span class="p">:</span> <span class="n">ST_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;RATTM:MOTION&#39;</span><span class="p">,</span>
                                                <span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
                                                <span class="n">nEnableMode</span><span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span>
                                                <span class="n">fHomePosition</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span>
                                                <span class="n">nHomingMode</span><span class="o">:=</span><span class="n">ENUM_EpicsHomeCmd</span><span class="o">.</span><span class="n">LOW_LIMIT</span><span class="p">);</span>
    <span class="n">fbMotionStage</span>           <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">TestMotionBacklashCompensation</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestMotionBacklashCompensation</span>
<span class="n">VAR_INST</span>
<span class="n">tonHomeSwitchSim</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">tonTestTimer</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">uStates</span>     <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">bLimitBackward</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">bLimitForward</span>  <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">bBacklashCompensationHomeExp</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">bBacklashCompensationHomeStatus</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">bBacklashCompensationStatus</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">bBacklashCompensationStatusExp</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Positive</span> <span class="n">compensation</span>
<span class="n">bBacklashCompensationPosFwd</span>  <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">bBacklashCompensationPosRev</span>  <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Negative</span> <span class="n">compensation</span>
<span class="n">bBacklashCompensationNegFwd</span>  <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">bBacklashCompensationNegRev</span>  <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

<span class="n">bBacklashCompensationActPos</span>  <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span><span class="mf">4.0</span><span class="p">;</span>
<span class="n">bBacklashCompensationActNeg</span>  <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=-</span><span class="mf">4.0</span><span class="p">;</span>
<span class="n">bBacklashCompensationNotAct</span>  <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span><span class="mf">0.0</span><span class="p">;</span>
<span class="n">ptWaitTime</span><span class="p">:</span> <span class="n">TIME</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1S;</span>
<span class="n">rtMotionInProgress</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestMotionBacklashCompensation&#39;</span><span class="p">);</span>

<span class="n">CASE</span> <span class="n">uStates</span> <span class="n">OF</span>

    <span class="mi">10</span><span class="p">:</span>
        <span class="o">//</span>  <span class="n">start</span> <span class="n">homming</span> <span class="ow">and</span> <span class="n">get</span> <span class="n">backalsh</span> <span class="n">status</span><span class="o">.</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHomeCmd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">tonHomeSwitchSim</span><span class="o">.</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
        <span class="n">ptWaitTime</span><span class="o">:=</span><span class="n">T</span><span class="c1">#100MS;</span>
        <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="mi">20</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">Homing</span> <span class="ow">is</span> <span class="n">done</span> <span class="n">without</span> <span class="nb">any</span> <span class="n">backlash</span> <span class="n">compensation</span>
            <span class="n">bBacklashCompensationHomeStatus</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBacklashStatus</span><span class="p">;</span>
        <span class="n">END_IF</span>

        <span class="o">//</span> <span class="n">Homming</span> <span class="n">busy</span><span class="p">,</span> <span class="n">simualte</span> <span class="n">a</span> <span class="n">state</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">backward</span> <span class="p">(</span><span class="n">homing</span> <span class="n">switch</span><span class="p">)</span> <span class="n">switch</span>
        <span class="n">IF</span> <span class="n">tonHomeSwitchSim</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">StateDWord</span><span class="mf">.10</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">StateDWord</span><span class="mf">.3</span> <span class="n">THEN</span>
            <span class="n">bLimitBackward</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">tonHomeSwitchSim</span><span class="o">.</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="n">END_IF</span>

        <span class="o">//</span>  <span class="n">Homing</span> <span class="n">switch</span> <span class="n">pulse</span> <span class="n">detected</span> <span class="n">motion</span> <span class="ow">is</span> <span class="n">reverse</span> <span class="n">release</span> <span class="n">the</span> <span class="n">backward</span> <span class="n">limit</span> <span class="n">switch</span> <span class="k">for</span> <span class="n">completion</span><span class="o">.</span>
        <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">StateDWord</span><span class="mf">.9</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">StateDWord</span><span class="mf">.3</span> <span class="n">THEN</span>
            <span class="n">bLimitBackward</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>

        <span class="o">//</span> <span class="n">Homing</span> <span class="ow">is</span> <span class="n">done</span>
        <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHomed</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="nb">set</span> <span class="n">initial</span> <span class="n">position</span>
            <span class="o">//</span><span class="n">fbSetPos</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span> <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">Position</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Mode</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">40</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="mi">40</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">simualte</span> <span class="n">a</span> <span class="n">user</span> <span class="n">enabled</span> <span class="k">for</span> <span class="n">backlash</span> <span class="n">compensation</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bUserBacklashEn</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">Positive</span> <span class="n">backlash</span> <span class="n">compensation</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fBacklash</span><span class="o">:=</span><span class="mi">4</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">Initiate</span> <span class="n">an</span> <span class="n">absolute</span> <span class="n">move</span>
        <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>
    <span class="mi">50</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Initate</span> <span class="n">Positive</span> <span class="n">backlash</span> <span class="n">compensation</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">50.0</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">500.0</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="mf">1000.0</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fDeceleration</span><span class="o">:=</span> <span class="mf">1000.0</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bMoveCmd</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
        <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">60</span><span class="p">;</span>

    <span class="mi">60</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">rtMotionInProgress</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">At</span> <span class="n">this</span> <span class="n">point</span> <span class="n">the</span> <span class="n">backlash</span> <span class="n">compensation</span> <span class="ow">is</span> <span class="n">enabled</span>
            <span class="n">bBacklashCompensationStatus</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBacklashStatus</span><span class="p">;</span>
            <span class="n">tonHomeSwitchSim</span><span class="o">.</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">ptWaitTime</span><span class="o">:=</span><span class="n">T</span><span class="c1">#0.1S;</span>

        <span class="o">//</span> <span class="k">if</span> <span class="n">compensation</span> <span class="ow">not</span> <span class="n">active</span> <span class="n">complete</span> <span class="n">test</span>
        <span class="n">ELSIF</span> <span class="n">tonHomeSwitchSim</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bBacklashCompensationStatus</span> <span class="n">THEN</span>
            <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">130</span><span class="p">;</span>

        <span class="o">//</span> <span class="n">No</span> <span class="n">backlash</span> <span class="n">compensation</span> <span class="n">expected</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">direction</span>
        <span class="n">ELSIF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
            <span class="n">bBacklashCompensationPosFwd</span><span class="o">:=</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span> <span class="o">-</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPosWithoutPosCorrection</span><span class="p">);</span>
            <span class="n">tonHomeSwitchSim</span><span class="o">.</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">70</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">70</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">reverse</span> <span class="n">movement</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">25.0</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bMoveCmd</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
        <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">80</span><span class="p">;</span>
    <span class="mi">80</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">this</span> <span class="n">move</span> <span class="n">has</span> <span class="n">been</span> <span class="n">compensated</span>
        <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
            <span class="n">bBacklashCompensationPosRev</span><span class="o">:=</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span> <span class="o">-</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPosWithoutPosCorrection</span><span class="p">);</span>
            <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">90</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="mi">90</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Initiate</span> <span class="n">compensation</span> <span class="k">for</span> <span class="n">Negative</span> <span class="n">Backlash</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fBacklash</span><span class="o">:=-</span><span class="mf">4.0</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span><span class="o">:=</span><span class="mf">10.0</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bMoveCmd</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
        <span class="n">uStates</span><span class="o">:=</span><span class="mi">100</span><span class="p">;</span>

    <span class="mi">100</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">No</span> <span class="n">compensation</span> <span class="n">here</span>
        <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
            <span class="n">bBacklashCompensationNegFwd</span><span class="o">:=</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span> <span class="o">-</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPosWithoutPosCorrection</span><span class="p">);</span>
            <span class="n">uStates</span><span class="o">:=</span><span class="mi">110</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">110</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">this</span> <span class="n">move</span> <span class="n">will</span> <span class="n">be</span> <span class="n">compensated</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span><span class="o">:=</span><span class="mf">25.0</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bMoveCmd</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
        <span class="n">uStates</span><span class="o">:=</span><span class="mi">120</span><span class="p">;</span>

    <span class="mi">120</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">when</span> <span class="n">done</span> <span class="n">a</span> <span class="n">negative</span> <span class="n">compensation</span> <span class="n">must</span> <span class="n">have</span> <span class="n">been</span> <span class="n">done</span><span class="o">.</span>
        <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
            <span class="n">bBacklashCompensationNegRev</span><span class="o">:=</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span> <span class="o">-</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPosWithoutPosCorrection</span><span class="p">);</span>
            <span class="n">uStates</span><span class="o">:=</span><span class="mi">130</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">130</span><span class="p">:;</span>

    <span class="n">ELSE</span>
        <span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">bLimitBackward</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">bLimitForward</span><span class="p">;</span>

<span class="n">tonHomeSwitchSim</span><span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">ptWaitTime</span><span class="p">);</span>
<span class="n">tonTestTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5S);</span>
<span class="n">rtMotionInProgress</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">watchdog</span> <span class="n">timer</span><span class="p">:</span> <span class="n">override</span> <span class="n">state</span> <span class="n">machine</span> <span class="ow">and</span> <span class="n">complete</span> <span class="n">tests</span>
<span class="n">IF</span> <span class="n">tonTestTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">uStates</span> <span class="o">=</span> <span class="mi">130</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">AssertEquals</span> <span class="p">(</span> <span class="n">Expected</span><span class="o">:=</span><span class="n">bBacklashCompensationHomeExp</span><span class="p">,</span> <span class="n">Actual</span><span class="o">:=</span><span class="n">bBacklashCompensationHomeStatus</span> <span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error:Backlash compensation enable in while homming&#39;</span><span class="p">);</span>
        <span class="n">AssertEquals</span> <span class="p">(</span> <span class="n">Expected</span><span class="o">:=</span><span class="n">bBacklashCompensationStatusExp</span><span class="p">,</span> <span class="n">Actual</span><span class="o">:=</span><span class="n">bBacklashCompensationStatus</span> <span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error:Backlash compensation disabled in absolute move mode&#39;</span><span class="p">);</span>
        <span class="n">AssertEquals_LREAL</span> <span class="p">(</span> <span class="n">Expected</span><span class="o">:=</span><span class="n">bBacklashCompensationNotAct</span><span class="p">,</span> <span class="n">Actual</span><span class="o">:=</span><span class="n">bBacklashCompensationPosFwd</span> <span class="p">,</span> <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error: Positive compensation enabled: Not compensation must be applied&#39;</span><span class="p">);</span>
        <span class="n">AssertEquals_LREAL</span> <span class="p">(</span> <span class="n">Expected</span><span class="o">:=</span><span class="n">bBacklashCompensationActPos</span><span class="p">,</span>    <span class="n">Actual</span><span class="o">:=</span><span class="n">bBacklashCompensationPosRev</span> <span class="p">,</span> <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error: Positive compensation enabled: Compensation must be applied&#39;</span><span class="p">);</span>
        <span class="n">AssertEquals_LREAL</span> <span class="p">(</span> <span class="n">Expected</span><span class="o">:=</span><span class="n">bBacklashCompensationNotAct</span><span class="p">,</span> <span class="n">Actual</span><span class="o">:=</span><span class="n">bBacklashCompensationNegFwd</span> <span class="p">,</span> <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error: Negative compensation enabled: Not compensation should be applied&#39;</span><span class="p">);</span>
        <span class="n">AssertEquals_LREAL</span> <span class="p">(</span> <span class="n">Expected</span><span class="o">:=</span><span class="n">bBacklashCompensationActNeg</span><span class="p">,</span>    <span class="n">Actual</span><span class="o">:=</span><span class="n">bBacklashCompensationNegRev</span> <span class="p">,</span> <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error: Negative compensation enabled: Compensation must be applied&#39;</span><span class="p">);</span>

        <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-epicshomecmd">ENUM_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#enum-stageenablemode">ENUM_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionbptm">
<h2>FB_MotionBPTM<a class="headerlink" href="#fb-motionbptm" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionBPTM</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">handles</span> <span class="n">the</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">transition</span> <span class="n">manager</span> <span class="k">for</span> <span class="n">a</span> <span class="n">group</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">moving</span> <span class="n">together</span> <span class="n">to</span> <span class="n">a</span> <span class="n">destination</span> <span class="k">with</span> <span class="n">shared</span> <span class="n">beam</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stGoalParams</span> <span class="ow">and</span> <span class="n">stTransParams</span> <span class="n">are</span> <span class="n">required</span> <span class="n">arguments</span> <span class="ow">and</span> <span class="n">must</span> <span class="ow">not</span> <span class="n">share</span> <span class="n">IDs</span> <span class="k">with</span> <span class="n">other</span> <span class="n">state</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>

    <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">building</span> <span class="n">block</span> <span class="ow">not</span> <span class="n">intended</span> <span class="k">for</span> <span class="n">use</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">lcls</span><span class="o">-</span><span class="n">twincat</span><span class="o">-</span><span class="n">motion</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Array</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">that</span> <span class="n">will</span> <span class="n">move</span> <span class="k">for</span> <span class="n">this</span> <span class="n">beam</span> <span class="n">transition</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">states</span> <span class="kn">from</span>
<span class="w">    </span><span class="nn">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">parameters</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">transition</span> <span class="n">to</span>
    <span class="n">stGoalParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">parameters</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span> <span class="n">during</span> <span class="n">the</span> <span class="n">transition</span>
    <span class="n">stTransParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">we</span><span class="s1">&#39;re actually using</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">use</span> <span class="n">the</span> <span class="n">BPTM</span><span class="p">,</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">stop</span> <span class="n">using</span> <span class="n">the</span> <span class="n">BPTM</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re at the physical state that matches the goal parameters</span>
    <span class="n">bAtState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">device</span> <span class="n">name</span> <span class="n">to</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">GUI</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">How</span> <span class="n">long</span> <span class="n">to</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">parameters</span> <span class="n">before</span> <span class="n">timing</span> <span class="n">out</span>
    <span class="n">tArbiterTimeout</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1s;</span>
    <span class="o">//</span> <span class="n">Whether</span> <span class="n">to</span> <span class="n">fault</span> <span class="ow">and</span> <span class="n">move</span> <span class="n">on</span> <span class="n">timeout</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="ow">or</span> <span class="n">to</span> <span class="n">wait</span> <span class="p">(</span><span class="n">FALSE</span><span class="p">)</span>
    <span class="n">bMoveOnArbiterTimeout</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">safe</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">the</span> <span class="n">BPTM</span> <span class="n">timeout</span> <span class="n">fast</span> <span class="n">fault</span><span class="p">,</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">it</span> <span class="n">early</span><span class="o">.</span>
    <span class="n">bResetBPTMTimeout</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">make</span> <span class="n">the</span> <span class="n">BPTM</span> <span class="n">retry</span>
    <span class="n">bRetry</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">becomes</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">allowed</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span> <span class="n">their</span> <span class="n">destinations</span><span class="o">.</span>
    <span class="n">bTransitionAuthorized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">becomes</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">full</span> <span class="n">beam</span> <span class="n">transition</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re using a bad motor count</span>
    <span class="n">bMotorCountError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bptm</span><span class="p">:</span> <span class="n">BeamParameterTransitionManager</span><span class="p">;</span>
    <span class="n">bDoneMoving</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nPrevID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>

    <span class="n">bInternalAuth</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDoneResetQueued</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">tonArbiter</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bArbiterTimeout</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ffBPTMTimeoutAndMove</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">ffBPTMError</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CheckCount</span><span class="p">();</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMotorCountError</span> <span class="n">THEN</span>
    <span class="n">SetDoneMoving</span><span class="p">();</span>
    <span class="n">IF</span> <span class="n">bEnable</span> <span class="n">THEN</span>
        <span class="n">RunBPTM</span><span class="p">();</span>
    <span class="n">END_IF</span>
    <span class="n">HandleTimeout</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">CheckCount</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">valid</span> <span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">,</span> <span class="n">less</span> <span class="ow">or</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">max</span><span class="p">)</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&gt;</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandleTimeout</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Measure</span> <span class="n">the</span> <span class="n">time</span> <span class="n">that</span> <span class="n">the</span> <span class="n">bptm</span> <span class="ow">is</span> <span class="n">busy</span>
<span class="n">tonArbiter</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bptm</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">tArbiterTimeout</span><span class="p">,</span>
    <span class="n">Q</span><span class="o">=&gt;</span><span class="n">bArbiterTimeout</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bTransitionAuthorized</span> <span class="o">:=</span> <span class="n">bInternalAuth</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bArbiterTimeout</span> <span class="n">AND</span> <span class="n">bMoveOnArbiterTimeout</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Trip</span> <span class="n">the</span> <span class="n">beam</span> <span class="k">for</span> <span class="n">BPTM</span> <span class="n">timeouts</span> <span class="k">if</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">move</span>
<span class="o">//</span> <span class="n">Only</span> <span class="n">reset</span> <span class="n">at</span> <span class="n">safe</span> <span class="n">beam</span> <span class="n">OR</span> <span class="n">at</span> <span class="n">no</span> <span class="n">bptm</span> <span class="n">errors</span> <span class="p">(</span><span class="n">some</span> <span class="n">other</span> <span class="n">FF</span> <span class="n">should</span> <span class="n">catch</span> <span class="n">additional</span> <span class="n">issues</span><span class="p">)</span>
<span class="n">ffBPTMTimeoutAndMove</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">bArbiterTimeout</span> <span class="n">AND</span> <span class="n">bMoveOnArbiterTimeout</span> <span class="n">AND</span> <span class="n">bEnable</span><span class="p">);</span>
<span class="n">ffBPTMTimeoutAndMove</span><span class="o">.</span><span class="n">i_xReset</span> <span class="n">S</span><span class="o">=</span> <span class="n">bResetBPTMTimeout</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bptm</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bptm</span><span class="o">.</span><span class="n">bError</span><span class="p">);</span>
<span class="n">ffBPTMTimeoutAndMove</span><span class="o">.</span><span class="n">i_xReset</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">ffBPTMTimeoutAndMove</span><span class="o">.</span><span class="n">i_xOK</span><span class="p">;</span>
<span class="n">ffBPTMTimeoutAndMove</span><span class="o">.</span><span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">ffBPTMTimeoutAndMove</span><span class="o">.</span><span class="n">i_xReset</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bEnable</span><span class="p">;</span>
<span class="n">ffBPTMTimeoutAndMove</span><span class="p">(</span>
    <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;BPTM Timeout&#39;</span><span class="p">,</span>
    <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">BPTM_TIMEOUT</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">RunBPTM</span><span class="p">:</span>
<span class="n">bptm</span><span class="p">(</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">i_sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">i_TransitionAssertionID</span><span class="o">:=</span><span class="n">stTransParams</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">,</span>
    <span class="n">i_stTransitionAssertion</span><span class="o">:=</span><span class="n">stTransParams</span><span class="o">.</span><span class="n">stBeamParams</span><span class="p">,</span>
    <span class="n">i_nRequestedAssertionID</span><span class="o">:=</span><span class="n">stGoalParams</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">,</span>
    <span class="n">i_stRequestedAssertion</span><span class="o">:=</span><span class="n">stGoalParams</span><span class="o">.</span><span class="n">stBeamParams</span><span class="p">,</span>
    <span class="n">i_xDoneMoving</span><span class="o">:=</span><span class="n">bDoneMoving</span> <span class="n">AND</span> <span class="n">bAtState</span><span class="p">,</span>
    <span class="n">stCurrentBeamParameters</span><span class="o">:=</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="p">,</span>
    <span class="n">bRetry</span><span class="o">:=</span><span class="n">bRetry</span><span class="p">,</span>
    <span class="n">q_xTransitionAuthorized</span><span class="o">=&gt;</span><span class="n">bInternalAuth</span><span class="p">,</span>
    <span class="n">bDone</span><span class="o">=&gt;</span><span class="n">bDone</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Trip</span> <span class="n">the</span> <span class="n">beam</span> <span class="k">for</span> <span class="n">BPTM</span> <span class="n">Errors</span>
<span class="n">ffBPTMError</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bptm</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">ffBPTMError</span><span class="o">.</span><span class="n">i_xReset</span> <span class="n">S</span><span class="o">=</span> <span class="n">bptm</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">ffBPTMError</span><span class="o">.</span><span class="n">i_xOK</span><span class="p">;</span>
<span class="n">ffBPTMError</span><span class="o">.</span><span class="n">i_xReset</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">ffBPTMError</span><span class="o">.</span><span class="n">i_xOK</span><span class="p">;</span>
<span class="n">ffBPTMError</span><span class="p">(</span>
    <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;BPTM error, state transition failed&#39;</span><span class="p">,</span>
    <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">BPTM_ERROR</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">SetDoneMoving</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Set</span> <span class="n">bDoneMoving</span> <span class="k">if</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">done</span>
<span class="n">bDoneMoving</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bDoneMoving</span> <span class="o">:=</span> <span class="n">bDoneMoving</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="o">//</span> <span class="n">Reset</span> <span class="n">bDoneMoving</span> <span class="k">if</span> <span class="n">the</span> <span class="n">goal</span> <span class="n">has</span> <span class="n">changed</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">bptm</span><span class="s1">&#39;s motor done for an in-place transition</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">allows</span> <span class="n">us</span> <span class="n">to</span> <span class="n">change</span> <span class="n">to</span> <span class="n">a</span> <span class="n">new</span> <span class="n">beam</span> <span class="n">state</span> <span class="n">without</span> <span class="n">requiring</span> <span class="n">a</span> <span class="n">motor</span> <span class="n">state</span> <span class="n">change</span>
<span class="o">//</span> <span class="n">BPTM</span> <span class="n">only</span> <span class="n">checks</span> <span class="k">for</span> <span class="n">this</span> <span class="s2">&quot;done&quot;</span> <span class="n">transition</span> <span class="n">after</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">has</span> <span class="n">been</span> <span class="n">authorized</span><span class="p">,</span> <span class="n">so</span> <span class="n">we</span> <span class="n">may</span> <span class="n">need</span> <span class="n">to</span> <span class="n">wait</span>
<span class="n">bDoneResetQueued</span> <span class="n">S</span><span class="o">=</span> <span class="n">nPrevID</span> <span class="o">&lt;&gt;</span> <span class="n">stGoalParams</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">;</span>
<span class="n">bDoneMoving</span> <span class="n">R</span><span class="o">=</span> <span class="n">bDoneResetQueued</span> <span class="n">AND</span> <span class="n">bptm</span><span class="o">.</span><span class="n">q_xTransitionAuthorized</span><span class="p">;</span>
<span class="n">bDoneResetQueued</span> <span class="n">R</span><span class="o">=</span> <span class="n">bptm</span><span class="o">.</span><span class="n">q_xTransitionAuthorized</span><span class="p">;</span>
<span class="n">nPrevID</span> <span class="o">:=</span> <span class="n">stGoalParams</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionbptm-test">
<h2>FB_MotionBPTM_Test<a class="headerlink" href="#fb-motionbptm-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_MotionBPTM_Test EXTENDS TcUnit.FB_TestSuite
(*
    Test the functionality of the motion bptm,
    Which is just a bptm wrapped up with a set of n motors.
    We&#39;re basically just making sure that we push the done button at the appropriate time.
    Direct tests of BPTM itself are reserved for the pmps library.

    The BPTM takes care of these executions across multiple cycles,
    so these tests must implement timeouts.
*)
VAR
    astMotionStage: ARRAY[1..MotionConstants.MAX_STATE_MOTORS] OF ST_MotionStage;
    stGoal1: ST_DbStateParams;
    stGoal2: ST_DbStateParams;
    stTrans: ST_DbStateParams;
    stNoBeam: ST_BeamParams;
END_VAR
stGoal1.stBeamParams := PMPS_GVL.cstFullBeam;
stGoal1.nRequestAssertionID := 1;
stGoal1.sPmpsState := &#39;stGoal1&#39;;
stGoal2.stBeamParams := PMPS_GVL.cstFullBeam;
stGoal2.stBeamParams.nTran := 0.5;
stGoal2.nRequestAssertionID := 2;
stGoal2.sPmpsState := &#39;stGoal2&#39;;
stTrans.stBeamParams := PMPS_GVL.cst0RateBeam;
stTrans.nRequestAssertionID := 3;
stTrans.sPmpsState := &#39;stTrans&#39;;

// Just put a blanket global no beam so these won&#39;t wait for any changes ever
PMPS_GVL.stCurrentBeamParameters := stNoBeam;
TestInit();
Test3dMove();
TestNoMove();
TestCount();

END_FUNCTION_BLOCK

METHOD AssertInPool
VAR_IN_OUT
    fbArbiter: FB_Arbiter;
    stDbStateParams: ST_DbStateParams;
END_VAR
VAR_INPUT
    bInPool: BOOL;
    sContext: STRING;
END_VAR
IF bInPool THEN
    AssertTrue(
        fbArbiter.CheckRequestInPool(stDbStateParams.nRequestAssertionID),
        CONCAT(CONCAT(stDbStateParams.sPmpsState, &#39; Beam parameters were not in the pool &#39;), sContext),
    );
ELSE
    AssertFalse(
        fbArbiter.CheckRequestInPool(stDbStateParams.nRequestAssertionID),
        CONCAT(CONCAT(stDbStateParams.sPmpsState, &#39; Beam parameters unexpectedly found in the pool &#39;), sContext),
    );
END_IF
END_METHOD

METHOD SetMotorDone
VAR_INPUT
END_VAR
// Force post-move state
astMotionStage[1].bBusy := FALSE;
astMotionStage[1].bDone := TRUE;
astMotionStage[2].bBusy := FALSE;
astMotionStage[2].bDone := TRUE;
astMotionStage[3].bBusy := FALSE;
astMotionStage[3].bDone := TRUE;
END_METHOD

METHOD SetMotorMoving
VAR_INPUT
END_VAR
// Force a moving but not done state
astMotionStage[1].bBusy := TRUE;
astMotionStage[1].bDone := FALSE;
astMotionStage[2].bBusy := TRUE;
astMotionStage[2].bDone := FALSE;
astMotionStage[3].bBusy := TRUE;
astMotionStage[3].bDone := FALSE;
END_METHOD

METHOD SetMotorStartup
VAR_INPUT
END_VAR
// Force some sort of default looking state
astMotionStage[1].bBusy := FALSE;
astMotionStage[1].bDone := FALSE;
astMotionStage[2].bBusy := FALSE;
astMotionStage[2].bDone := FALSE;
astMotionStage[3].bBusy := FALSE;
astMotionStage[3].bDone := FALSE;
END_METHOD

METHOD Test3dMove : BOOL
(*
    Can we safely do a 3d move?
*)
VAR_INST
    fbBptm: FB_MotionBPTM;
    fbArbiter: FB_Arbiter(2);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);
    fbSubSysIO : FB_DummyArbIO;

    nState: UINT;
    tonTimer: TON;
END_VAR
TEST(&#39;Test3DMove&#39;);

tonTimer(
    IN:=TRUE,
    PT:=T#5s,
);
IF tonTimer.Q THEN
    nState := 4;
END_IF

CASE nState OF
    0:
        // Establish baseline at Goal1
        SetMotorStartup();
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal1,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=TRUE,
            bAtState:=TRUE,
        );
        IF fbBptm.bDone THEN
            nState := 1;
        END_IF
    1:
        // Request a move
        SetMotorStartup();
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal2,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=TRUE,
            bAtState:=FALSE,
        );
        IF fbBptm.bTransitionAuthorized THEN
            // We should have transition and goal 2 asserts in
            AssertInPool(fbArbiter, stGoal1, FALSE, &#39;with trans auth&#39;);
            AssertInPool(fbArbiter, stGoal2, TRUE, &#39;with trans auth&#39;);
            AssertInPool(fbArbiter, stTrans, TRUE, &#39;with trans auth&#39;);
            nState := 2;
        END_IF
    2:
        // Simulate a move
        SetMotorMoving();
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal2,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=TRUE,
            bAtState:=FALSE,
        );
        // Same situation as before
        AssertInPool(fbArbiter, stGoal1, FALSE, &#39;after move started&#39;);
        AssertInPool(fbArbiter, stGoal2, TRUE, &#39;after move started&#39;);
        AssertInPool(fbArbiter, stTrans, TRUE, &#39;after move started&#39;);
        nState := 3;
    3:
        // Move is done
        SetMotorDone();
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal2,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=TRUE,
            bAtState:=TRUE,
        );
        IF fbBptm.bDone THEN
            // Dropped the transition assert
            AssertInPool(fbArbiter, stGoal1, FALSE, &#39;with move complete&#39;);
            AssertInPool(fbArbiter, stGoal2, TRUE, &#39;with move complete&#39;);
            AssertInPool(fbArbiter, stTrans, FALSE, &#39;with move complete&#39;);
            nState := 4;
        END_IF
    4:
        AssertFalse(
            tonTimer.Q,
            &#39;Timeout in test&#39;,
        );
        TEST_FINISHED();
END_CASE

fbSubSysIO(
    LA:=fbArbiter,
    FFO:=fbFFHWO,
);
END_METHOD

METHOD TestCount
(*
    FB Should just error out if we forgot to give a count
*)
VAR_INST
    fbBptm: FB_MotionBPTM;
    fbArbiter: FB_Arbiter(1);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);

    tonWait: TON;
END_VAR
TEST(&#39;TestCount&#39;);

SetMotorStartup();
fbBptm(
    astMotionStage:=astMotionStage,
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stGoalParams:=stGoal1,
    stTransParams:=stTrans,
    bEnable:=True,
    bAtState:=True,
);
AssertTrue(
    fbBptm.bMotorCountError,
    &#39;Did not properly error on missing motor count&#39;,
);

tonWait(
    IN:=TRUE,
    PT:=T#1s,
);
IF tonWait.Q THEN
    // Should have no arbiter activity at all
    AssertInPool(fbArbiter, stGoal1, FALSE, &#39;with bad count&#39;);
    AssertInPool(fbArbiter, stGoal2, FALSE, &#39;with bad count&#39;);
    AssertInPool(fbArbiter, stTrans, FALSE, &#39;with bad count&#39;);

    TEST_FINISHED();
END_IF
END_METHOD

METHOD TestInit : BOOL
(*
    If we initialize with still motors, do we get an arbiter request at the current goal? Hopefully we do.
*)
VAR_INST
    fbBptm: FB_MotionBPTM;
    fbArbiter: FB_Arbiter(1);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);
    fbSubSysIO : FB_DummyArbIO;

    tonTimer: TON;
END_VAR
TEST(&#39;TestInit&#39;);

SetMotorStartup();
fbBptm(
    astMotionStage:=astMotionStage,
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stGoalParams:=stGoal1,
    stTransParams:=stTrans,
    nActiveMotorCount:=3,
    bEnable:=True,
    bAtState:=True,
);
fbSubSysIO(
    LA:=fbArbiter,
    FFO:=fbFFHWO,
);

tonTimer(
    IN:=TRUE,
    PT:=T#5s,
);
IF tonTimer.Q OR fbBptm.bDone THEN
    AssertFalse(
        tonTimer.Q,
        &#39;Timeout in test&#39;,
    );
    // We should have a request in the pool for goal 1 but not for transition
    // If no request are in the pool, we may come up in a no protection state!
    // If both requests are in the pool, we may come up in a too much blocking beam state!
    AssertInPool(fbArbiter, stGoal1, TRUE, &#39;at startup&#39;);
    AssertInPool(fbArbiter, stTrans, FALSE, &#39;at startup&#39;);

    TEST_FINISHED();
END_IF
END_METHOD

METHOD TestNoMove
(*
    In place transitions should work at startup and also at done positions.
*)
VAR_INST
    fbBptm: FB_MotionBPTM;
    fbArbiter: FB_Arbiter(1);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);
    fbSubSysIO : FB_DummyArbIO;

    nState: UINT;
    tonTimer: TON;
END_VAR
TEST(&#39;TestNoMove&#39;);

tonTimer(
    IN:=TRUE,
    PT:=T#5s,
);
IF tonTimer.Q THEN
    nState := 3;
END_IF

CASE nState OF
    0:
        SetMotorStartup();
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal1,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=True,
            bAtState:=True,
        );
        IF fbBptm.bDone THEN
            nState := 1;
        END_IF
    1:
        SetMotorStartup();
        // NOTE: we kept bAtState TRUE the whole time, so this should be a completed in-place transition
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal2,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=True,
            bAtState:=True,
        );
        IF fbBptm.bDone THEN
            // Only Goal2 should be in the pool
            AssertInPool(fbArbiter, stGoal1, FALSE, &#39;after switching goals (1)&#39;);
            AssertInPool(fbArbiter, stGoal2, TRUE, &#39;after switching goals (1)&#39;);
            AssertInPool(fbArbiter, stTrans, FALSE, &#39;after switching goals (1)&#39;);
            nState := 2;
        END_IF
    2:
        // Repeat from a done position!
        SetMotorDone();
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal1,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=True,
            bAtState:=True,
        );
        IF fbBptm.bDone THEN
            // Only Goal1 should be in the pool
            AssertInPool(fbArbiter, stGoal1, TRUE, &#39;after switching goals (2)&#39;);
            AssertInPool(fbArbiter, stGoal2, FALSE, &#39;after switching goals (2)&#39;);
            AssertInPool(fbArbiter, stTrans, FALSE, &#39;after switching goals (2)&#39;);
            nState := 3;
        END_IF
    3:
        AssertFalse(
            tonTimer.Q,
            &#39;Timeout in test&#39;,
        );
        TEST_FINISHED();
END_CASE

fbSubSysIO(
    LA:=fbArbiter,
    FFO:=fbFFHWO,
);
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionbptm">FB_MotionBPTM</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionclearasserts">
<h2>FB_MotionClearAsserts<a class="headerlink" href="#fb-motionclearasserts" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionClearAsserts</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Clear</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">asserts</span> <span class="n">related</span> <span class="n">to</span> <span class="n">a</span> <span class="n">states</span> <span class="n">mover</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">states</span> <span class="n">to</span> <span class="n">deactivate</span><span class="p">:</span> <span class="n">transition</span> <span class="o">+</span> <span class="n">the</span> <span class="n">static</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">astDbStateParams</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">who</span> <span class="n">made</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="k">assert</span> <span class="n">requests</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_ARBITER</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Clear</span> <span class="n">asserts</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
        <span class="n">fbArbiter</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">);</span>
    <span class="n">END_FOR</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-motionclearasserts-test">
<h2>FB_MotionClearAsserts_Test<a class="headerlink" href="#fb-motionclearasserts-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionClearAsserts_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TestBasic</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestBasic</span>
<span class="n">VAR</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbClear</span><span class="p">:</span> <span class="n">FB_MotionClearAsserts</span><span class="p">;</span>
    <span class="n">astDbStateParams</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestBasic&#39;</span><span class="p">);</span>

<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span>
        <span class="n">nReqID</span><span class="o">:=</span><span class="mi">100</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">,</span>
        <span class="n">stReqBP</span><span class="o">:=</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">,</span>
        <span class="n">sDevName</span><span class="o">:=</span><span class="s1">&#39;UnitTest&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="mi">100</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">),</span>
        <span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;State &#39;</span><span class="p">,</span> <span class="n">UDINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">)),</span> <span class="s1">&#39; was not in the pool&#39;</span><span class="p">),</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">fbClear</span><span class="p">(</span>
    <span class="n">astDbStateParams</span><span class="o">:=</span><span class="n">astDbStateParams</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="mi">100</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">),</span>
        <span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;State &#39;</span><span class="p">,</span> <span class="n">UDINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">)),</span> <span class="s1">&#39; was not cleared from the pool&#39;</span><span class="p">),</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionclearasserts">FB_MotionClearAsserts</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motiondrive">
<h2>FB_MotionDrive<a class="headerlink" href="#fb-motiondrive" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionDrive</span> <span class="n">IMPLEMENTS</span> <span class="n">I_MotionDrive</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
   <span class="o">//</span> <span class="n">EPICS</span> <span class="n">Interface</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_copy&#39;</span><span class="p">}</span>
    <span class="n">stMotionEpicsItf</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">ST_MotionEpicsInterface</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">iMotionAxis</span><span class="p">:</span> <span class="n">I_MotionAxis</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">iBrake</span>                          <span class="p">:</span> <span class="n">I_Brake</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">iMotionInterlocks</span>       <span class="p">:</span> <span class="n">I_MotionInterlocks</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">iMotionLogger</span>           <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">eMoveMode</span> <span class="p">:</span> <span class="n">E_EpicsMotorCmd</span> <span class="o">:=</span> <span class="n">E_EpicsMotorCmd</span><span class="o">.</span><span class="n">MOVE_ABSOLUTE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Determines</span> <span class="n">when</span> <span class="n">we</span> <span class="n">automatically</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">motor</span>
    <span class="o">//</span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">eEnableMode</span><span class="p">:</span> <span class="n">E_StageEnableMode</span><span class="o">:=</span><span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Shortcut</span> <span class="n">Commands</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">a</span> <span class="n">move</span> <span class="n">to</span> <span class="n">fPosition</span> <span class="k">with</span> <span class="n">fVelocity</span>
    <span class="n">bMoveCmd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">the</span> <span class="n">homing</span> <span class="n">routine</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bHomeCmd</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Start</span> <span class="n">the</span> <span class="n">homing</span> <span class="n">routine</span>
    <span class="s1">&#39;}</span>
    <span class="n">bHomeCmd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Close</span> <span class="ow">or</span> <span class="nb">open</span> <span class="n">loop</span> <span class="n">operation</span> <span class="p">(</span> <span class="n">DS402</span> <span class="n">Piezo</span> <span class="n">axis</span> <span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bServo</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">errors</span>
    <span class="s1">&#39;}</span>
    <span class="n">bServo</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">sName</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">eMoveState</span>      <span class="p">:</span> <span class="n">E_MoveState</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bNewMoveReq</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bExecHome</span>       <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bExecMove</span>       <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtMoveCmdShortcut</span>       <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtHomeCmdShortcut</span>       <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtUserExec</span>                      <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtNewMoveReq</span>            <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtTarget</span>                        <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtHomed</span>                         <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtValidExec</span>     <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtReset</span>                         <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">ftStopExec</span>                      <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">ftError</span>                         <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">nCommandLocal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">nCmdDataLocal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">ftLocalStart</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bInitStart</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bLocalExec</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bEnableDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bPrepareDisable</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtEnableMode</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtStopExec</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtInterlockEvent</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bCmdExecute</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bHaltAbort</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">ftHaltAbort</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtRestoreDone</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bHaltEvent</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">move</span> <span class="n">state</span> <span class="n">machine</span> <span class="n">to</span> <span class="n">error</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">case</span> <span class="n">a</span> <span class="n">move</span> <span class="n">command</span> <span class="n">gets</span> <span class="n">stuck</span> <span class="n">after</span>
    <span class="o">//</span> <span class="n">the</span> <span class="n">corresponding</span> <span class="n">start</span> <span class="n">signal</span> <span class="n">was</span> <span class="n">forwarded</span><span class="o">.</span> <span class="n">the</span> <span class="n">start</span> <span class="n">signal</span> <span class="n">should</span> <span class="n">yeild</span> <span class="n">a</span> <span class="n">busy</span> <span class="n">true</span> <span class="n">response</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">the</span> <span class="n">move</span> <span class="n">processing</span> <span class="n">block</span> <span class="n">may</span> <span class="n">get</span> <span class="n">stuck</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">no</span> <span class="n">errors</span><span class="o">.</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">contingency</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">that</span> <span class="n">reset</span> <span class="n">would</span> <span class="n">reinit</span> <span class="nb">all</span> <span class="n">state</span> <span class="n">machines</span><span class="o">.</span>
    <span class="n">tonSyncTimer</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bLocalError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLocalMessage</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">__ISVALIDREF</span><span class="p">(</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stMotionEpicsItf</span> <span class="p">)</span> <span class="n">THEN</span>
   <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Restore</span> <span class="n">axis</span> <span class="n">parameters</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">RestoreSettings</span><span class="p">();</span>

<span class="o">//</span> <span class="n">catch</span> <span class="n">high</span> <span class="n">priority</span> <span class="n">message</span>
<span class="o">//</span> <span class="n">an</span> <span class="n">extended</span> <span class="n">error</span> <span class="n">message</span> <span class="kn">from</span><span class="w"> </span><span class="nn">FB_MotionLogger</span> <span class="n">will</span> <span class="n">display</span> <span class="n">cyclic</span> <span class="n">errors</span> <span class="ow">and</span> <span class="n">warning</span>
<span class="n">IF</span> <span class="n">iMotionAxis</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
   <span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">iMotionAxis</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
   <span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">iMotionAxis</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
   <span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">iMotionAxis</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">iMotionInterlocks</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
   <span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">iMotionInterlocks</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
   <span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">iMotionInterlocks</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
   <span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">iMotionInterlocks</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">bLocalError</span> <span class="n">THEN</span>
   <span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">bLocalError</span><span class="p">;</span>
   <span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">bLocalMessage</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Warnings</span> <span class="n">have</span> <span class="n">lowest</span> <span class="n">priority</span>
<span class="n">ELSIF</span> <span class="n">iMotionInterlocks</span><span class="o">.</span><span class="n">Warning</span> <span class="n">THEN</span>
   <span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">iMotionInterlocks</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">ELSE</span>
       <span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
       <span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Drive</span> <span class="n">state</span> <span class="n">machine</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">StateMachine</span><span class="p">();</span>
<span class="o">//</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">PostHandling</span><span class="p">();</span>
<span class="o">//</span> <span class="n">update</span> <span class="n">EPICS</span> <span class="n">status</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">UpdateParamAndStatus</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">stMotionEpicsItf</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">ST_MotionEpicsInterface</span><span class="p">;</span>
    <span class="n">iBrake</span> <span class="p">:</span> <span class="n">I_Brake</span><span class="p">;</span>
    <span class="n">iMotionInterlocks</span> <span class="p">:</span> <span class="n">I_MotionInterlocks</span><span class="p">;</span>
    <span class="n">iMotionLogger</span> <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
    <span class="n">iMotionAxis</span><span class="p">:</span> <span class="n">I_MotionAxis</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">stMotionEpicsItf</span> <span class="n">REF</span><span class="o">=</span><span class="n">stMotionEpicsItf</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionAxis</span> <span class="o">:=</span> <span class="n">iMotionAxis</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span><span class="o">:=</span><span class="n">iMotionLogger</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iBrake</span><span class="o">:=</span><span class="n">iBrake</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionInterlocks</span><span class="o">:=</span><span class="n">iMotionInterlocks</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">ClearVars</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">bDone</span> <span class="o">:=</span> <span class="n">Done</span><span class="p">;</span>
<span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">falling</span> <span class="n">edge</span> <span class="n">here</span> <span class="n">when</span> <span class="n">target</span> <span class="ow">is</span> <span class="n">reached</span><span class="p">,</span> <span class="n">move</span> <span class="n">halted</span>
<span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bLocalExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">release</span> <span class="n">the</span> <span class="n">cmds</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bHomeCmd</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bMoveCmd</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">binitStart</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bCmdExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">tonSyncTimer</span><span class="o">.</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">stMotionEpicsItf</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">ST_MotionEpicsInterface</span><span class="p">;</span>
    <span class="n">iBrake</span> <span class="p">:</span> <span class="n">I_Brake</span><span class="p">;</span>
    <span class="n">iMotionInterlocks</span> <span class="p">:</span> <span class="n">I_MotionInterlocks</span><span class="p">;</span>
    <span class="n">iMotionLogger</span> <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
    <span class="n">iMotionAxis</span><span class="p">:</span> <span class="n">I_MotionAxis</span><span class="p">;</span>
   <span class="o">//</span> <span class="n">iLimSwStatus</span> <span class="p">:</span> <span class="n">I_LimSwStatus</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">stMotionEpicsItf</span> <span class="n">REF</span><span class="o">=</span><span class="n">stMotionEpicsItf</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionAxis</span> <span class="o">:=</span> <span class="n">iMotionAxis</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span><span class="o">:=</span><span class="n">iMotionLogger</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iBrake</span><span class="o">:=</span><span class="n">iBrake</span><span class="p">;</span>
<span class="o">//</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iLimSwStatus</span><span class="o">:=</span><span class="n">iLimSwStatus</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionInterlocks</span><span class="o">:=</span><span class="n">iMotionInterlocks</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">METHOD</span> <span class="n">Instances</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">bMotionAxisNC</span>  <span class="o">:=</span> <span class="n">__QUERYINTERFACE</span><span class="p">(</span><span class="n">iMotionAxisCommon</span><span class="p">,</span> <span class="n">iMotionAxisNC</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">__QUERYINTERFACE</span><span class="p">(</span><span class="n">iMotionAxisCommon</span><span class="p">,</span><span class="n">iMotionAxisCommonDS402</span><span class="p">);</span>
<span class="o">//</span> <span class="n">bMotionAxisNCDS402</span>  <span class="o">:=</span> <span class="n">__QUERYINTERFACE</span><span class="p">(</span><span class="n">iMotionAxisCommon</span><span class="p">,</span><span class="n">iMotionAxisNCDS402</span><span class="p">)</span> <span class="n">AND</span> <span class="n">__QUERYINTERFACE</span><span class="p">(</span><span class="n">iMotionAxisCommon</span><span class="p">,</span><span class="n">iMotionAxisCommonDS402</span><span class="p">);</span>
<span class="o">//</span> <span class="n">bMotionAxisDS402</span>  <span class="o">:=</span> <span class="n">__QUERYINTERFACE</span><span class="p">(</span><span class="n">iMotionAxisCommon</span><span class="p">,</span> <span class="n">iMotionAxisDS402</span><span class="p">);</span>
<span class="o">//</span> <span class="n">bMotionInterlocks</span>  <span class="o">:=</span> <span class="n">__QUERYINTERFACE</span><span class="p">(</span><span class="n">iMotionInterlocks</span><span class="p">,</span><span class="n">iMotionInterlocks</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">__QUERYINTERFACE</span><span class="p">(</span><span class="n">iMotionInterlocks</span><span class="p">,</span><span class="n">iLimSw</span><span class="p">);</span>
<span class="o">//</span> <span class="n">bMotionInterlocksLimSw</span>  <span class="o">:=</span> <span class="n">__QUERYINTERFACE</span><span class="p">(</span><span class="n">iMotionInterlocks</span><span class="p">,</span><span class="n">iMotionInterlocks</span><span class="p">)</span> <span class="n">AND</span> <span class="n">__QUERYINTERFACE</span><span class="p">(</span><span class="n">iMotionInterlocks</span><span class="p">,</span><span class="n">iLimSw</span><span class="p">);;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PostHandling</span>

<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PreHandling</span>

<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">RestoreSettings</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>

<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">StateMachine</span>

<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">UpdateParamAndStatus</span>

<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">EnableMode</span> <span class="p">:</span> <span class="n">ENUM_StageEnableMode</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">EnableMode</span> <span class="o">:=</span> <span class="n">eEnableMode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">EnableMode</span> <span class="p">:</span> <span class="n">ENUM_StageEnableMode</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">eEnableMode</span> <span class="o">:=</span> <span class="n">EnableMode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Name</span> <span class="p">:</span> <span class="n">STRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Name</span> <span class="o">:=</span> <span class="n">sName</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Name</span> <span class="p">:</span> <span class="n">STRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">sName</span> <span class="o">:=</span> <span class="n">Name</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-stageenablemode">ENUM_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></p></li>
<li><p><a class="reference internal" href="#e-movestate">E_MoveState</a></p></li>
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#fb-motionlogger">FB_MotionLogger</a></p></li>
<li><p><a class="reference internal" href="#st-motionepicsinterface">ST_MotionEpicsInterface</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionhoming">
<h2>FB_MotionHoming<a class="headerlink" href="#fb-motionhoming" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionHoming</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbSetPos</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">fbJog</span><span class="p">:</span> <span class="n">MC_Jog</span><span class="p">;</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftExec</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">nHomeStateMachine</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="n">IDLE</span><span class="p">;</span>
    <span class="n">nStateAfterStop</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">nMoves</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bFirstDirection</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bAtHome</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrCount</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bInterrupted</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">IDLE</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">NEXT_MOVE</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">CHECK_FWD</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">CHECK_BWD</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">FINAL_MOVE</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">FINAL_SETPOS</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">ERROR</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">WAIT_STOP</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span>
        <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">simpler</span> <span class="n">way</span> <span class="n">of</span> <span class="n">disabling</span> <span class="n">the</span> <span class="n">soft</span> <span class="n">limits</span> <span class="n">that</span> <span class="n">ends</span> <span class="n">up</span> <span class="n">being</span> <span class="n">really</span> <span class="n">obvious</span> <span class="k">if</span> <span class="n">something</span> <span class="n">has</span> <span class="n">gone</span> <span class="n">wrong</span><span class="o">.</span>
        <span class="n">If</span> <span class="n">you</span> <span class="n">turn</span> <span class="n">the</span> <span class="n">limits</span> <span class="n">off</span><span class="o">/</span><span class="n">on</span><span class="p">,</span> <span class="ow">not</span> <span class="n">only</span> <span class="n">do</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">track</span> <span class="n">of</span> <span class="k">if</span> <span class="n">you</span> <span class="n">had</span> <span class="n">soft</span> <span class="n">limits</span> <span class="nb">set</span><span class="p">,</span>
        <span class="n">but</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">always</span> <span class="n">restore</span> <span class="n">this</span> <span class="n">properly</span> <span class="ow">or</span> <span class="n">risk</span> <span class="n">some</span> <span class="n">issue</span><span class="o">.</span>
        <span class="n">Instead</span><span class="p">,</span> <span class="n">I</span> <span class="nb">set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">a</span> <span class="n">ridiculous</span> <span class="n">value</span> <span class="n">that</span> <span class="n">can</span> <span class="n">always</span> <span class="n">move</span> <span class="n">forward</span> <span class="ow">or</span> <span class="n">backward</span><span class="o">.</span>
        <span class="n">If</span> <span class="n">this</span> <span class="n">gets</span> <span class="n">stuck</span> <span class="k">for</span> <span class="nb">any</span> <span class="n">reason</span> <span class="n">it</span><span class="s1">&#39;s very clear that something has gone wrong,</span>
        <span class="n">rather</span> <span class="n">than</span> <span class="n">a</span> <span class="n">silent</span> <span class="n">failure</span> <span class="n">of</span> <span class="n">the</span> <span class="n">soft</span> <span class="n">limit</span> <span class="n">marks</span><span class="o">.</span>
    <span class="o">*</span><span class="p">)</span>
    <span class="n">FWD_START</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">99999999</span><span class="p">;</span>
    <span class="n">BWD_START</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span>  <span class="mi">99999999</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbSetPos</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">ClearPositionLag</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">ftExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>

<span class="n">bError</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bExecute</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">nErrorID</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nHomingMode</span> <span class="n">OF</span>
    <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">LOW_LIMIT</span><span class="p">:</span>
        <span class="n">bFirstDirection</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bAtHome</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="p">;</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">HIGH_LIMIT</span><span class="p">:</span>
        <span class="n">bFirstDirection</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bAtHome</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span><span class="p">;</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">HOME_VIA_LOW</span><span class="p">:</span>
        <span class="n">bFirstDirection</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bAtHome</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHome</span><span class="p">;</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">HOME_VIA_HIGH</span><span class="p">:</span>
        <span class="n">bFirstDirection</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bAtHome</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHome</span><span class="p">;</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">ABSOLUTE_SET</span><span class="p">:</span>
        <span class="n">fbSetPos</span><span class="p">(</span>
            <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
            <span class="n">Position</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fHomePosition</span><span class="p">);</span>
        <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">NONE</span><span class="p">:</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">IF</span> <span class="n">bMove</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bBusy</span> <span class="n">AND</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
        <span class="n">bInterrupted</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">CASE</span> <span class="n">nHomeStateMachine</span> <span class="n">OF</span>
        <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">a</span> <span class="n">rising</span> <span class="n">edge</span>
        <span class="n">IDLE</span><span class="p">:</span>
            <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nErrCount</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">fbJog</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
                <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">NEXT_MOVE</span><span class="p">;</span>
                <span class="n">nMoves</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">nErrorID</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">bInterrupted</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="o">//</span> <span class="n">Figure</span> <span class="n">out</span> <span class="n">whether</span> <span class="n">to</span> <span class="n">move</span> <span class="n">forward</span><span class="p">,</span> <span class="n">move</span> <span class="n">backward</span><span class="p">,</span> <span class="ow">or</span> <span class="n">give</span> <span class="n">up</span>
        <span class="n">NEXT_MOVE</span><span class="p">:</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">fbJog</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">CASE</span> <span class="n">nMoves</span> <span class="n">OF</span>
                <span class="mi">0</span><span class="p">:</span>
                    <span class="n">IF</span> <span class="n">bFirstDirection</span> <span class="n">THEN</span>
                        <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">CHECK_FWD</span><span class="p">;</span>
                    <span class="n">ELSE</span>
                        <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">CHECK_BWD</span><span class="p">;</span>
                    <span class="n">END_IF</span>
                <span class="mi">1</span><span class="p">:</span>
                    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bFirstDirection</span> <span class="n">THEN</span>
                        <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">CHECK_FWD</span><span class="p">;</span>
                    <span class="n">ELSE</span>
                        <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">CHECK_BWD</span><span class="p">;</span>
                    <span class="n">END_IF</span>
                <span class="n">ELSE</span>
                    <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
            <span class="n">END_CASE</span>
            <span class="n">nMoves</span> <span class="o">:=</span> <span class="n">nMoves</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">bAtHome</span> <span class="n">THEN</span>
                <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">FINAL_MOVE</span><span class="p">;</span>
            <span class="n">END_IF</span>
            <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">WAIT_STOP</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">Move</span> <span class="n">forward</span> <span class="n">until</span> <span class="n">we</span> <span class="n">find</span> <span class="n">the</span> <span class="n">home</span> <span class="n">signal</span> <span class="ow">or</span> <span class="n">reach</span> <span class="n">end</span> <span class="n">of</span> <span class="n">travel</span>
        <span class="n">CHECK_FWD</span><span class="p">:</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
                <span class="n">Position</span><span class="o">:=</span><span class="n">FWD_START</span><span class="p">);</span>
            <span class="n">fbJog</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">JogForward</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bATHome</span><span class="p">,</span>
                <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                <span class="n">Mode</span><span class="o">:=</span><span class="n">E_JogMode</span><span class="o">.</span><span class="n">MC_JOGMODE_CONTINOUS</span><span class="p">,</span>
                <span class="n">Velocity</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fRefVeloSearch</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">JogForward</span> <span class="n">THEN</span>
                <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">NEXT_MOVE</span><span class="p">;</span>
            <span class="n">ELSIF</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
                <span class="n">fbJog</span><span class="p">(</span>
                    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                    <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                    <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                <span class="n">nErrCount</span> <span class="o">:=</span> <span class="n">nErrCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">IF</span> <span class="n">nErrCount</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="n">THEN</span>
                    <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
                <span class="n">END_IF</span>
            <span class="n">END_IF</span>
        <span class="o">//</span> <span class="n">Move</span> <span class="n">backward</span> <span class="n">until</span> <span class="n">we</span> <span class="n">find</span> <span class="n">the</span> <span class="n">home</span> <span class="n">signal</span> <span class="ow">or</span> <span class="n">reach</span> <span class="n">end</span> <span class="n">of</span> <span class="n">travel</span>
        <span class="n">CHECK_BWD</span><span class="p">:</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
                <span class="n">Position</span><span class="o">:=</span><span class="n">BWD_START</span><span class="p">);</span>
            <span class="n">fbJog</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bATHome</span><span class="p">,</span>
                <span class="n">Mode</span><span class="o">:=</span><span class="n">E_JogMode</span><span class="o">.</span><span class="n">MC_JOGMODE_CONTINOUS</span><span class="p">,</span>
                <span class="n">Velocity</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fRefVeloSearch</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">JogBackwards</span> <span class="n">THEN</span>
                <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">NEXT_MOVE</span><span class="p">;</span>
            <span class="n">ELSIF</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
                <span class="n">fbJog</span><span class="p">(</span>
                    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                    <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                    <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                <span class="n">nErrCount</span> <span class="o">:=</span> <span class="n">nErrCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">IF</span> <span class="n">nErrCount</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="n">THEN</span>
                    <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
                <span class="n">END_IF</span>
            <span class="n">END_IF</span>
        <span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">get</span> <span class="n">within</span> <span class="n">soft</span> <span class="n">lims</span><span class="p">,</span> <span class="n">move</span> <span class="n">slowly</span> <span class="n">off</span> <span class="n">signal</span>
        <span class="n">FINAL_MOVE</span><span class="p">:</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
                <span class="n">Position</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fHomePosition</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">bAtHome</span> <span class="n">THEN</span>
                <span class="n">fbJog</span><span class="p">(</span>
                    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                    <span class="n">JogForward</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bFirstDirection</span><span class="p">,</span>
                    <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">bFirstDirection</span><span class="p">,</span>
                    <span class="n">Mode</span><span class="o">:=</span><span class="n">E_JogMode</span><span class="o">.</span><span class="n">MC_JOGMODE_CONTINOUS</span><span class="p">,</span>
                    <span class="n">Velocity</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fRefVeloSync</span><span class="p">);</span>
            <span class="n">ELSIF</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
                <span class="n">fbJog</span><span class="p">(</span>
                    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                    <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                    <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                <span class="n">nErrCount</span> <span class="o">:=</span> <span class="n">nErrCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">IF</span> <span class="n">nErrCount</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="n">THEN</span>
                    <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
                <span class="n">END_IF</span>
            <span class="n">ELSE</span>
                <span class="n">fbJog</span><span class="p">(</span>
                    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                    <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                    <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                <span class="n">fbSetPos</span><span class="p">(</span>
                    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                    <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">WAIT_STOP</span><span class="p">;</span>
                <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">FINAL_SETPOS</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">FINAL_SETPOS</span><span class="p">:</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
                <span class="n">Position</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fHomePosition</span><span class="p">);</span>
            <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">IDLE</span><span class="p">;</span>
            <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">ERROR</span><span class="p">:</span>
            <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">nErrorID</span> <span class="o">:=</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
            <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">FINAL_SETPOS</span><span class="p">;</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">bInterrupted</span> <span class="n">THEN</span>
                <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Homing interrupted&#39;</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Homing failure&#39;</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">WAIT_STOP</span><span class="p">:</span>
            <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">THEN</span>
                <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">nStateAfterStop</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">END_CASE</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motioninterlockscommon">
<h2>FB_MotionInterlocksCommon<a class="headerlink" href="#fb-motioninterlockscommon" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionInterlocksCommon</span> <span class="n">IMPLEMENTS</span> <span class="n">I_MotionInterlocksCommon</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">iMotionLogger</span>           <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bAllForwardEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Backward</span> <span class="n">enable</span> <span class="n">EPS</span> <span class="n">summary</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bAllBackwardEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bPowerEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
   <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">independently</span> <span class="n">of</span> <span class="n">PMPS</span> <span class="ow">or</span> <span class="n">other</span> <span class="n">safety</span> <span class="n">systems</span><span class="o">.</span>
      <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bPowerSelf</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span> <span class="n">have</span> <span class="n">safety</span> <span class="n">permission</span> <span class="n">to</span> <span class="n">move</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bSafetyReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
   <span class="o">//</span> <span class="n">NC</span> <span class="n">STO</span> <span class="n">Input</span><span class="p">:</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ok</span> <span class="n">to</span> <span class="n">move</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bHardwareEnable</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">STO</span> <span class="ow">not</span> <span class="n">hit</span>
    <span class="s1">&#39;}</span>
    <span class="n">bHardwareEnable</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span> <span class="p">;</span>

    <span class="o">//</span> <span class="n">Used</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">an</span> <span class="n">axis</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bUserEnable</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">DISABLE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ENABLE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">power</span> <span class="n">entirely</span> <span class="k">for</span> <span class="n">an</span> <span class="n">axis</span>
    <span class="s1">&#39;}</span>
    <span class="n">bUserEnable</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bReset</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bNewMoveReq</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">sMessage</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">nErrorID</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">by</span> <span class="n">default</span><span class="p">,</span> <span class="n">an</span> <span class="n">error</span> <span class="n">condition</span> <span class="n">will</span> <span class="n">reset</span> <span class="n">this</span>
    <span class="n">bMoveOk</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtGlobalReset</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bInterlockEvent</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMoveForwardEnabled</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bMoveBackwardEnabled</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="p">(</span> <span class="n">iMotionLogger</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">throw</span> <span class="n">an</span> <span class="n">exception</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">read</span> <span class="n">share</span>
<span class="n">bPowerEnabled</span> <span class="o">:=</span> <span class="n">bEnable</span> <span class="n">AND</span> <span class="n">bHardwareEnable</span><span class="p">;</span>
<span class="n">bPowerEnabled</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bUserEnable</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Moves</span> <span class="n">are</span> <span class="n">automatically</span> <span class="n">allowed</span> <span class="k">if</span> <span class="n">no</span> <span class="n">safety</span> <span class="n">hooks</span><span class="o">.</span> <span class="n">Otherwise</span><span class="p">,</span> <span class="n">some</span> <span class="n">other</span> <span class="n">code</span> <span class="n">will</span> <span class="nb">set</span> <span class="n">this</span><span class="o">.</span>
<span class="n">bSafetyReady</span> <span class="n">S</span><span class="o">=</span> <span class="n">bPowerSelf</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bUserEnable</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorID</span><span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="s1">&#39;User enable interlock triggered!&#39;</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">bHardwareEnable</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorID</span><span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="s1">&#39;Hardware enbale interlocks triggered!&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">wait</span> <span class="k">for</span> <span class="k">global</span> <span class="n">reset</span> <span class="n">event</span> <span class="n">to</span> <span class="n">complete</span>
<span class="n">rtGlobalReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bReset</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtGlobalReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorID</span><span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sMessage</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">iMotionLogger</span> <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span> <span class="o">:=</span> <span class="n">iMotionLogger</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">DriveCommands</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Enable</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">NewMoveReq</span>      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Reset</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bEnable</span> <span class="o">:=</span> <span class="n">Enable</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">Reset</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bNewMoveReq</span> <span class="o">:=</span> <span class="n">NewMoveReq</span> <span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>

    <span class="n">iMotionLogger</span>           <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span> <span class="o">:=</span> <span class="n">iMotionLogger</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">bError</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">nErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Message</span> <span class="o">:=</span> <span class="n">sMessage</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MoveBackwardEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MoveBackwardEnabled</span> <span class="o">:=</span> <span class="n">bMoveBackwardEnabled</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MoveForwardEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MoveForwardEnabled</span> <span class="o">:=</span> <span class="n">bMoveForwardEnabled</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MoveOk</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MoveOk</span> <span class="o">:=</span> <span class="n">bMoveOk</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">PowerEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">PowerEnabled</span> <span class="o">:=</span><span class="n">bPowerEnabled</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
</section>
<section id="fb-motioninterlockslimsw">
<h2>FB_MotionInterlocksLimSw<a class="headerlink" href="#fb-motioninterlockslimsw" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionInterlocksLimSw</span> <span class="n">IMPLEMENTS</span> <span class="n">I_MotionInterlocks</span>
<span class="n">VAR</span>
    <span class="n">iMotionInterlocksCommon</span> <span class="p">:</span> <span class="n">I_MotionInterlocksCommon</span><span class="p">;</span>
    <span class="n">iLimSwStatus</span> <span class="p">:</span> <span class="n">I_LimSwStatus</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorID</span><span class="p">:</span><span class="n">UDINT</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bNewMoveReq</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bEnable</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bReset</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bMoveOk</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bMoveBackwardEnabled</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bMoveForwardEnabled</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bPowerEnable</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">Enable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bLimHit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">ftForwardEnabled</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">ftBackwardEnabled</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtUserExec</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">rtReset</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bLimHitIdling</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bLimHitMoving</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bWarning</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bPositiveDirection</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bNegativeDirection</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">bHomeBusy</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Read</span> <span class="n">Limits</span> <span class="n">status</span> <span class="ow">and</span> <span class="n">update</span> <span class="n">shared</span> <span class="n">space</span>
<span class="n">bMoveBackwardEnabled</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iLimSwStatus</span><span class="o">.</span><span class="n">LimBackward</span><span class="p">;</span>
<span class="n">bMoveForwardEnabled</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iLimSwStatus</span><span class="o">.</span><span class="n">LimForward</span><span class="p">;</span>

<span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bReset</span><span class="p">);</span>
<span class="n">rtUserExec</span> <span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bNewMoveReq</span><span class="p">);</span>
<span class="n">ftForwardEnabled</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bMoveForwardEnabled</span><span class="p">);</span>
<span class="n">ftBackwardEnabled</span> <span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bMoveBackwardEnabled</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bHomeBusy</span> <span class="n">AND</span> <span class="p">((</span><span class="n">ftForwardEnabled</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bPositiveDirection</span><span class="p">)</span>
        <span class="n">OR</span> <span class="p">(</span><span class="n">ftBackwardEnabled</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bNegativeDirection</span><span class="p">))</span><span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Not</span> <span class="n">an</span> <span class="n">error</span><span class="p">,</span> <span class="n">just</span> <span class="n">a</span> <span class="n">warning</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMoveForwardEnabled</span> <span class="n">THEN</span>
            <span class="n">THIS</span><span class="o">^.</span><span class="n">sMessage</span><span class="o">:=</span><span class="s1">&#39;Cannot move past Positive limit.&#39;</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">bMoveBackwardEnabled</span> <span class="n">THEN</span>
            <span class="n">THIS</span><span class="o">^.</span><span class="n">sMessage</span><span class="o">:=</span><span class="s1">&#39;Cannot move past Negative limit.&#39;</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">THIS</span><span class="o">^.</span><span class="n">bWarning</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">THIS</span><span class="o">^.</span><span class="n">bLimHit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">THIS</span><span class="o">^.</span><span class="n">bLimHitMoving</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">rtUserExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">THIS</span><span class="o">^.</span><span class="n">bLimHit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">THIS</span><span class="o">^.</span><span class="n">bLimHitMoving</span> <span class="o">:=</span> <span class="n">bLimHit</span><span class="p">;</span>
    <span class="n">THIS</span><span class="o">^.</span><span class="n">bLimHitIdling</span> <span class="o">:=</span> <span class="n">bLimHit</span><span class="p">;</span>
    <span class="n">THIS</span><span class="o">^.</span><span class="n">sMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">THIS</span><span class="o">^.</span><span class="n">bWarning</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionInterlocksCommon</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionInterlocksCommon</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorID</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionInterlocksCommon</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionInterlocksCommon</span><span class="o">.</span><span class="n">Message</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">AxisStatus</span>
<span class="n">VAR_INPUT</span>
    <span class="n">HomeBusy</span>        <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">PositiveDirection</span>       <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">NegativeDirection</span>       <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bPositiveDirection</span> <span class="o">:=</span> <span class="n">PositiveDirection</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bNegativeDirection</span> <span class="o">:=</span> <span class="n">NegativeDirection</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bHomeBusy</span> <span class="o">:=</span> <span class="n">HomeBusy</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">iMotionInterlocksCommon</span> <span class="p">:</span> <span class="n">I_MotionInterlocksCommon</span><span class="p">;</span>
    <span class="n">iLimSwStatus</span> <span class="p">:</span> <span class="n">I_LimSwStatus</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionInterlocksCommon</span> <span class="o">:=</span> <span class="n">iMotionInterlocksCommon</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iLimSwStatus</span> <span class="o">:=</span> <span class="n">iLimSwStatus</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">DriveCommands</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Enable</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">NewMoveReq</span>      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Reset</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bReset</span> <span class="o">:=</span>  <span class="n">Reset</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Forward</span> <span class="n">drive</span> <span class="n">cmds</span> <span class="n">to</span> <span class="n">Generic</span> <span class="n">interlocks</span> <span class="ow">and</span> <span class="n">lim</span> <span class="n">status</span> <span class="n">FB</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionInterlocksCommon</span><span class="o">.</span><span class="n">DriveCommands</span><span class="p">(</span><span class="n">Enable</span><span class="o">:=</span><span class="n">Enable</span><span class="p">,</span> <span class="n">NewMoveReq</span><span class="o">:=</span><span class="n">NewMoveReq</span><span class="p">,</span> <span class="n">Reset</span><span class="o">:=</span><span class="n">Reset</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">iMotionInterlocksCommon</span> <span class="p">:</span> <span class="n">I_MotionInterlocksCommon</span><span class="p">;</span>
    <span class="n">iLimSwStatus</span> <span class="p">:</span> <span class="n">I_LimSwStatus</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionInterlocksCommon</span>  <span class="o">:=</span> <span class="n">iMotionInterlocksCommon</span> <span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iLimSwStatus</span> <span class="o">:=</span> <span class="n">iLimSwStatus</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;monitoring&#39;</span> <span class="o">:=</span> <span class="s1">&#39;variable&#39;</span><span class="p">}</span>
<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">bError</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;monitoring&#39;</span> <span class="o">:=</span> <span class="s1">&#39;variable&#39;</span><span class="p">}</span>
<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">nErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;monitoring&#39;</span> <span class="o">:=</span> <span class="s1">&#39;variable&#39;</span><span class="p">}</span>
<span class="n">PROPERTY</span> <span class="n">InterlockEvent</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">InterlockEvent</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bLimHit</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">LimHit</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Limhit</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bLimHit</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">LimHome</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">LimHome</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iLimSwStatus</span><span class="o">.</span><span class="n">LimHome</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Message</span> <span class="o">:=</span> <span class="n">sMessage</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;monitoring&#39;</span> <span class="o">:=</span> <span class="s1">&#39;variable&#39;</span><span class="p">}</span>
<span class="n">PROPERTY</span> <span class="n">MoveBackwardEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MoveBackwardEnabled</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bMoveBackwardEnabled</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;monitoring&#39;</span> <span class="o">:=</span> <span class="s1">&#39;variable&#39;</span><span class="p">}</span>
<span class="n">PROPERTY</span> <span class="n">MoveForwardEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MoveForwardEnabled</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bMoveForwardEnabled</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;monitoring&#39;</span> <span class="o">:=</span> <span class="s1">&#39;variable&#39;</span><span class="p">}</span>
<span class="n">PROPERTY</span> <span class="n">MoveOk</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MoveOk</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionInterlocksCommon</span><span class="o">.</span><span class="n">MoveOk</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;monitoring&#39;</span> <span class="o">:=</span> <span class="s1">&#39;variable&#39;</span><span class="p">}</span>
<span class="n">PROPERTY</span> <span class="n">PowerEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">PowerEnabled</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionInterlocksCommon</span><span class="o">.</span><span class="n">PowerEnabled</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;monitoring&#39;</span> <span class="o">:=</span> <span class="s1">&#39;variable&#39;</span><span class="p">}</span>
<span class="n">PROPERTY</span> <span class="ne">Warning</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="ne">Warning</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">bWarning</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
</section>
<section id="fb-motionlogger">
<h2>FB_MotionLogger<a class="headerlink" href="#fb-motionlogger" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionLogger</span> <span class="n">IMPLEMENTS</span> <span class="n">I_MotionLogger</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-motionpneumaticactuator">
<h2>FB_MotionPneumaticActuator<a class="headerlink" href="#fb-motionpneumaticactuator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*This function blcok implements a pnuematic actuator. That can be signle or double acting by setting the ibSingleCntrl accordingly*)
(* with double acting ibCntrlHold signal should be false, while with single acting the signal should be true*)
FUNCTION_BLOCK FB_MotionPneumaticActuator
VAR_INPUT
    (*EPS Interlock Bits*)
    ibInsertOK: BOOL; (*Actuator can be Inserted*)
    ibRetractOK: BOOL; (*ACtuator can be retracted*)
    ibPMPS_OK:BOOL; (*to be linked the Arbiter bit*)
    ibSingleCntrl:BOOL;(* TRUE if Actuator requires one Output signal to be activated, FALSE if its double acting i.e two outputs are required*)
    ibCntrlHold:BOOL; (* Control Signal must retain its value, must be TRUE in the case of single acting*)
    ibOverrideInterlock:BOOL; (*if true interlocks are ignored*)
    // Reset fault
    {attribute &#39;pytmc&#39; := &#39;
    pv: FFO_Reset
    &#39;}
    i_xReset: BOOL;
    {attribute &#39;pytmc&#39; := &#39;
    pv: FFO_AutoReset
    &#39;}
    i_xAutoReset: BOOL;
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
    pv:
    &#39;}
    stPneumaticActuator    :    ST_MotionPneumaticActuator;
    {attribute &#39;pytmc&#39; := &#39;
     pv: MPS_OK
     field: ZNAM FALSE
     field: ONAM TRUE
     field: DESC TRUE if MPS signal is OK
    &#39;}
    xMPS_OK:BOOL;
END_VAR
VAR_IN_OUT
    io_fbFFHWO    :    FB_HardwareFFOutput;
END_VAR
VAR
    // PMPS
    fbFF    :    FB_FastFault :=(
        i_DevName := &#39;MPA&#39;,
        i_Desc := &#39;Fault occurs when the device is moving&#39;,
        i_TypeCode := E_MotionFFType.PNEUMATIC_MOVE);

    (*Init*)
    xFirstPass    :    BOOL;
    fbFSInit        :    R_TRIG;

    (* Timeouts*)
    tTimeOutDuration: TIME:= T#10S;
    tInserttimeout: TON;
    tRetracttimeout:TON;
    (*Limit switch latch timer*)
    tLimitSwitchLatchDuration: TIME:=T#1S;
    tInsertLimitSwitch:TON;
    tRetractLimitSwitch:TON;

    (*Logging*)
    fbLogger : FB_LogMessage := (eSubsystem:=E_SubSystem.MOTION);
    ePrevState : E_PnuematicActuatorPositionState;
    tAction : R_TRIG; // Primary action of this device (Insert_DO, Retract_DO, etc.)
    tOverrideActivated : R_TRIG;

    (*IO*)
    i_xInsertedLS    AT%I*: BOOL;
    i_xRetractedLS    AT%I*: BOOL;
    q_xInsert_DO    AT%Q*: BOOL;
    q_xRetract_DO    AT%Q*: BOOL;

END_VAR
(*Initialize*)
fbFSInit( CLK := TRUE, Q =&gt; xFirstPass);
IF xFirstPass THEN
    stPneumaticActuator.eState := E_PnuematicActuatorPositionState.INVALID;
    stPneumaticActuator.bRetract_SW := FALSE;
    stPneumaticActuator.bInsert_SW := FALSE;
END_IF

(*Soft IO Mapping to EPICS PVs*)
ACT_IO();

(* Manage States*)
IF stPneumaticActuator.i_bInLimitSwitch AND  stPneumaticActuator.i_bOutLimitSwitch THEN
    stPneumaticActuator.eState:=E_PnuematicActuatorPositionState.INVALID;
ELSIF NOT stPneumaticActuator.i_bInLimitSwitch AND stPneumaticActuator.i_bOutLimitSwitch THEN
    stPneumaticActuator.eState:=E_PnuematicActuatorPositionState.RETRACTED;
ELSIF stPneumaticActuator.i_bInLimitSwitch AND NOT stPneumaticActuator.i_bOutLimitSwitch THEN
    stPneumaticActuator.eState:=E_PnuematicActuatorPositionState.INSERTED;
ELSIF NOT stPneumaticActuator.i_bInLimitSwitch AND NOT stPneumaticActuator.i_bOutLimitSwitch THEN
    stPneumaticActuator.eState:=E_PnuematicActuatorPositionState.MOVING;
ELSE
    stPneumaticActuator.eState:=E_PnuematicActuatorPositionState.INVALID ;
END_IF

(*Set the Done/Busy signal*)
stPneumaticActuator.bDone := (stPneumaticActuator.bRetract_SW AND stPneumaticActuator.eState=E_PnuematicActuatorPositionState.RETRACTED)
                            OR (stPneumaticActuator.bInsert_SW AND stPneumaticActuator.eState=E_PnuematicActuatorPositionState.INSERTED);
stPneumaticActuator.bBusy := (stPneumaticActuator.bRetract_SW AND stPneumaticActuator.eState&lt;&gt;E_PnuematicActuatorPositionState.RETRACTED)
                            OR (stPneumaticActuator.bInsert_SW AND stPneumaticActuator.eState&lt;&gt;E_PnuematicActuatorPositionState.INSERTED);
(*MPS FAULT*)
(* MPS Faults when the actuator is in motion*)
xMPS_OK := (stPneumaticActuator.eState=E_PnuematicActuatorPositionState.RETRACTED) OR (stPneumaticActuator.eState=E_PnuematicActuatorPositionState.INSERTED);
(*PMPS PERMISSION*)
// yet to be implemented

(* Can&#39;t have bRetract_SW and  bInsert_SW both be true*)
If (stPneumaticActuator.bRetract_SW) AND (stPneumaticActuator.bInsert_SW) THEN
    stPneumaticActuator.bRetract_SW := FALSE;
    stPneumaticActuator.bInsert_SW := FALSE;
END_IF
//Redundant??
(*Check if both digital outputs active at the same time, and clear all*)
IF stPneumaticActuator.q_bInsert THEN
    stPneumaticActuator.q_bRetract := FALSE;
    stPneumaticActuator.bRetract_SW:= FALSE;
END_IF;
IF stPneumaticActuator.q_bRetract THEN
    stPneumaticActuator.q_bInsert := FALSE;
    stPneumaticActuator.bInsert_SW:= FALSE;
END_IF;

(*Actuate the device*)
stPneumaticActuator.q_bRetract := stPneumaticActuator.bRetractOK AND stPneumaticActuator.bRetract_SW AND NOT stPneumaticActuator.bInsert_SW ;
stPneumaticActuator.q_bInsert := stPneumaticActuator.bInsertOK AND stPneumaticActuator.bInsert_SW AND NOT stPneumaticActuator.bRetract_SW ;

(*Reset the Control signal when command has been executed and give time to ensure the actuator is fully seated in either direction*)
IF (NOT ibSingleCntrl AND NOT ibCntrlHold) THEN
   IF (stPneumaticActuator.bRetract_SW AND stPneumaticActuator.i_bOutLimitSwitch AND tRetractLimitSwitch.Q ) THEN stPneumaticActuator.q_bRetract := FALSE; END_IF
   IF (stPneumaticActuator.bInsert_SW AND stPneumaticActuator.i_bInLimitSwitch AND tInsertLimitSwitch.Q) THEN stPneumaticActuator.q_bInsert := FALSE; END_IF
END_IF

(*Timers*)
tInserttimeout(IN:= stPneumaticActuator.q_bInsert, PT := tTimeOutDuration );
tRetracttimeout(IN:= stPneumaticActuator.q_bRetract, PT := tTimeOutDuration);
tInsertLimitSwitch(IN:= stPneumaticActuator.i_bInLimitSwitch, PT := tLimitSwitchLatchDuration);
tRetractLimitSwitch(IN:= stPneumaticActuator.i_bOutLimitSwitch, PT := tLimitSwitchLatchDuration);


///Check moving postion timout
IF NOT stPneumaticActuator.i_bInLimitSwitch AND tInserttimeout.Q THEN
    stPneumaticActuator.bError := TRUE;
    stPneumaticActuator.sErrorMessage:= &#39;Actuator insert timeout&#39;;
ELSIF NOT stPneumaticActuator.i_bOutLimitSwitch AND tRetracttimeout.Q THEN
    stPneumaticActuator.bError := TRUE;
    stPneumaticActuator.sErrorMessage:= &#39;Actuator retract timeout&#39;;
END_IF
// Reset error
stPneumaticActuator.bError R= stPneumaticActuator.bReset;

(*FAST FAULT*)
fbFF(i_xOK := xMPS_OK,
    i_xReset := i_xReset,
    i_xAutoReset := i_xAutoReset,
    io_fbFFHWO := io_fbFFHWO);

(*Soft IO Mapping to Epics pvs*)
ACT_IO();

END_FUNCTION_BLOCK

ACTION ACT_IO:
(*Inputs*)
stPneumaticActuator.i_bInLimitSwitch :=  i_xInsertedLS;
stPneumaticActuator.i_bOutLimitSwitch := i_xRetractedLS;

(*outputs*)
q_xInsert_DO:=stPneumaticActuator.q_bInsert;
q_xRetract_DO:=stPneumaticActuator.q_bRetract;

(*EPICS*)
stPneumaticActuator.bRetractOK := ibRetractOK;
stPneumaticActuator.bInsertOK := ibInsertOK;
END_ACTION

ACTION ACT_Logger:
// Log Valve timeouts
IF (tInserttimeout.Q OR tRetracttimeout.Q) THEN fbLogger(sMsg:=stPneumaticActuator.sErrorMessage, eSevr:=TcEventSeverity.Warning); END_IF

// Log Actuator commands
// Log valve open
tAction(CLK:= (stPneumaticActuator.q_bRetract OR stPneumaticActuator.q_bInsert));
IF tAction.Q THEN
   IF(stPneumaticActuator.q_bRetract) THEN fbLogger(sMsg:=&#39;Actuator commanded retract&#39;, eSevr:=TcEventSeverity.Info); END_IF
   IF(stPneumaticActuator.q_bInsert) THEN fbLogger(sMsg:=&#39;Actuator commanded insert&#39;, eSevr:=TcEventSeverity.Info); END_IF
END_IF


// State Logging
IF ePrevState &lt;&gt; stPneumaticActuator.eState THEN
      CASE stPneumaticActuator.eState OF
        E_PnuematicActuatorPositionState.INVALID:
            fbLogger(sMsg:=&#39;Actuator invalid position.&#39;, eSevr:=TcEventSeverity.Critical);
          E_PnuematicActuatorPositionState.MOVING:
            fbLogger(sMsg:=&#39;Actuator moving&#39;, eSevr:=TcEventSeverity.Warning);
        E_PnuematicActuatorPositionState.RETRACTED:
            fbLogger(sMsg:=&#39;Actuator Retracted.&#39;, eSevr:=TcEventSeverity.Info);
        E_PnuematicActuatorPositionState.INSERTED:
            fbLogger(sMsg:=&#39;Actuator Inserted.&#39;, eSevr:=TcEventSeverity.Info);
      END_CASE
      ePrevState := stPneumaticActuator.eState;
  END_IF
END_ACTION
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#e-pnuematicactuatorpositionstate">E_PnuematicActuatorPositionState</a></p></li>
<li><p><a class="reference internal" href="#st-motionpneumaticactuator">ST_MotionPneumaticActuator</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionreadpmpsdbnd">
<h2>FB_MotionReadPMPSDBND<a class="headerlink" href="#fb-motionreadpmpsdbnd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_MotionReadPMPSDBND
(*
    When we read the JSON PMPS database file, update the lookup parameters for one state mover.
    It is a building block not meant for use outside of lcls-twincat-motion.

    This is intended to support one N-dimensional state motion function block.
    The keys for the database lookup can be set on any of the motor&#39;s position states.
    Each of them have an allocated state.stPMPS.sPmpsState STRING parameter.
    If there is a conflict and two of the motors disagree on parameter lookups, that will
    be a fast fault.

    When the global JSON read function block is no longer busy and has no errors,
    we will assume that the file has been read and we will update the parameters here.

    This will also re-read in the event that the input position state keys change in any way,
    provided that we&#39;ve read once before.
*)
VAR_IN_OUT
    // Each motor&#39;s respective position states along its direction. These will not be modified.
    astPositionState: ARRAY[1..MotionConstants.MAX_STATE_MOTORS] OF ARRAY[1..GeneralConstants.MAX_STATES] OF ST_PositionState;
    // Hardware output to fault to if there is a problem.
    fbFFHWO: FB_HardwareFFOutput;
END_VAR
VAR_INPUT
    // The database lookup key for the transition state. This has no corresponding ST_PositionState.
    sTransitionKey: STRING;
    // A name to use for fast faults, etc.
    sDeviceName: STRING;
    // For debug: set this to TRUE in online mode to read the database immediately.
    bReadNow: BOOL;
END_VAR
VAR_OUTPUT
    // The raw lookup results from this FB. Index 0 is the transition beam, the rest of the indices match the state positions.
    astDbStateParams: ARRAY[0..GeneralConstants.MAX_STATES] OF ST_DbStateParams;
    // TRUE if we&#39;ve had at least one successful read.
    bFirstReadDone: BOOL;
    // This will be set to TRUE if there was an error reading from the database.
    bError: BOOL;
END_VAR
VAR
    ffError: FB_FastFault;
    fbReadPmpsDb: FB_JsonDocToSafeBP;
    ftDbBusy: F_TRIG;
    ftRead: F_TRIG;
    bReadPmpsDb: BOOL;
    nIterMotor: DINT;
    nIterState: DINT;
    nIterState2: DINT;
    sLoopNewKey: STRING;
    sLoopPrevKey: STRING;
    abStateError: ARRAY[0..GeneralConstants.MAX_STATES] OF BOOL;
    asLookupKeys: ARRAY[0..GeneralConstants.MAX_STATES] OF STRING;
    asPrevLookupKeys: ARRAY[0..GeneralConstants.MAX_STATES] OF STRING;
    bNewKeys: BOOL;
    sTempBackfill: STRING;
END_VAR
SelectLookupKeys();
ReadDatabase();
RunFastFaults();
BackfillInfo();

END_FUNCTION_BLOCK

ACTION BackfillInfo:
// Put the results of the PMPS lookup back to the motion states
// This is purely for debugging purposes, as only the astDbStateParams output is used by the libraries.

// Copy everything except for the lookup key: avoid clobbering the user&#39;s original keys
// Do it this way instead of one element at a time to be forwards-compatible with any future additions to the db struct
FOR nIterState := 1 TO GeneralConstants.MAX_STATES DO
    FOR nIterMotor := 1 TO MotionConstants.MAX_STATE_MOTORS DO
        sTempBackfill := astPositionState[nIterMotor][nIterState].stPMPS.sPmpsState;
        astPositionState[nIterMotor][nIterState].stPMPS := astDbStateParams[nIterState];
        astPositionState[nIterMotor][nIterState].stPMPS.sPmpsState := sTempBackfill;
    END_FOR
END_FOR
END_ACTION

ACTION ReadDatabase:
// Read the database at the right timing
ftDbBusy(CLK:=MOTION_GVL.fbPmpsFileReader.bBusy);
IF ftDbBusy.Q THEN
    bReadPmpsDb S= NOT MOTION_GVL.fbPmpsFileReader.bError;
END_IF

bReadPmpsDb S= bFirstReadDone AND bNewKeys;
bReadPmpsDb S= bReadNow;
bReadNow := FALSE;

fbReadPmpsDb(
    bExecute:=bReadPmpsDb,
    jsonDoc:=PMPS_GVL.BP_jsonDoc,
    sDeviceName:=sDeviceName,
    io_fbFFHWO:=fbFFHWO,
    arrStates:=astDbStateParams,
);
bReadPmpsDb R= NOT fbReadPmpsDb.bBusy;

ftRead(CLK:=fbReadPmpsDb.bBusy);
bFirstReadDone S= ftRead.Q AND NOT fbReadPmpsDb.bError;
END_ACTION

ACTION RunFastFaults:
ffError(
    i_xOK:=NOT bError,
    i_xAutoReset:=TRUE,
    i_DevName:=sDeviceName,
    i_Desc:=&#39;Programmer error selecting state names in ND motion FB&#39;,
    i_TypeCode:=E_MotionFFType.INTERNAL_ERROR,
    io_fbFFHWO:=fbFFHWO,
);
END_ACTION

ACTION SelectLookupKeys:
// Fill the lookup key information in astDbStateParams based on the strings from astPositionState and sTransitionKey.

// Start by emptying any pre-existing values
FOR nIterState := 0 TO GeneralConstants.MAX_STATES DO
    asLookupKeys[nIterState] := &#39;&#39;;
    abStateError[nIterState] := FALSE;
END_FOR

// Transition key is simple
asLookupKeys[0] := sTransitionKey;

// The other keys might be at different points in the astPositionState array.
// Try all of the posibilities, set error if we end up overwriting something.

// Outer loop: index of each motor at this position state
FOR nIterMotor := 1 TO MotionConstants.MAX_STATE_MOTORS DO
    // Inner loop: index of each position state for this motor
    FOR nIterState := 1 TO GeneralConstants.MAX_STATES DO
        sLoopNewKey := astPositionState[nIterMotor][nIterState].stPMPS.sPmpsState;
        IF sLoopNewKey &lt;&gt; &#39;&#39; THEN
            // We have a new key, start doing things
            sLoopPrevKey := asLookupKeys[nIterState];
            IF sLoopPrevKey = &#39;&#39; OR sLoopPrevKey = sLoopNewKey THEN
                // No key yet, or exactly the same key (redudant programmer)
                asLookupKeys[nIterState] := sLoopNewKey;
            ELSE
                // We already had a different key! Don&#39;t just override it, have an error!
                bError := TRUE;
                abStateError[nIterState] := TRUE;
            END_IF
        END_IF
    END_FOR
END_FOR

// Check for duplicated sPmpsState strings
FOR nIterState := 0 TO GeneralConstants.MAX_STATES DO
    FOR nIterState2 := 0 TO nIterState DO
        IF nIterState &lt;&gt; nIterState2 AND asLookupKeys[nIterState] = asLookupKeys[nIterState2] AND asLookupKeys[nIterState] &lt;&gt; &#39;&#39; THEN
            // Duplicated key, we need an error and a flag in both spots
            bError := TRUE;
            abStateError[nIterState] := TRUE;
            abStateError[nIterState2] := TRUE;
        END_IF
    END_FOR
END_FOR

// Clear the erroneous states so they won&#39;t be used as lookups
IF bError THEN
    FOR nIterState := 0 TO GeneralConstants.MAX_STATES DO
        IF abStateError[nIterState] THEN
            asLookupKeys[nIterState] := &#39;&#39;;
        END_IF
    END_FOR
END_IF

// Copy the keys into the db state params
FOR nIterState := 0 TO GeneralConstants.MAX_STATES DO
    astDbStateParams[nIterState].sPmpsState := asLookupKeys[nIterState];
END_FOR

// Check if the keys changed from prev cycle
bNewKeys := FALSE;
FOR nIterState := 0 TO GeneralConstants.MAX_STATES DO
    IF asLookupKeys[nIterState] &lt;&gt; asPrevLookupKeys[nIterState] THEN
        bNewKeys := TRUE;
        EXIT;
    END_IF
END_FOR

// Save prev keys for next cycle
asPrevLookupKeys := asLookupKeys;
END_ACTION
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionreadpmpsdbnd-test">
<h2>FB_MotionReadPMPSDBND_Test<a class="headerlink" href="#fb-motionreadpmpsdbnd-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionReadPMPSDBND_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">We</span> <span class="n">test</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">db</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">pmps</span> <span class="n">lib</span>
    <span class="n">Here</span><span class="p">,</span> <span class="n">we</span> <span class="n">test</span> <span class="n">that</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">keys</span> <span class="n">are</span> <span class="n">ready</span> <span class="k">for</span> <span class="n">the</span> <span class="n">read</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">inputs</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">user</span> <span class="n">submits</span> <span class="n">a</span> <span class="n">transition</span> <span class="n">key</span> <span class="ow">and</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">their</span> <span class="n">ST_PositionState</span> <span class="n">instances</span> <span class="kn">from</span><span class="w"> </span><span class="nn">all</span> <span class="n">of</span> <span class="n">their</span> <span class="n">motors</span><span class="o">.</span>
    <span class="n">Any</span> <span class="n">subset</span> <span class="n">of</span> <span class="n">these</span> <span class="n">instances</span> <span class="n">can</span> <span class="n">have</span> <span class="n">lookup</span> <span class="n">keys</span><span class="o">.</span>

    <span class="n">If</span> <span class="n">only</span> <span class="n">one</span> <span class="n">state</span> <span class="n">at</span> <span class="n">the</span> <span class="n">index</span> <span class="n">has</span> <span class="n">a</span> <span class="n">lookup</span> <span class="n">key</span><span class="p">,</span> <span class="n">use</span> <span class="n">that</span> <span class="n">key</span><span class="o">.</span>
    <span class="n">If</span> <span class="n">more</span> <span class="n">than</span> <span class="n">one</span> <span class="n">state</span> <span class="n">at</span> <span class="n">the</span> <span class="n">index</span> <span class="n">has</span> <span class="n">the</span> <span class="n">same</span> <span class="n">lookup</span> <span class="n">key</span><span class="p">,</span> <span class="n">use</span> <span class="n">that</span> <span class="n">key</span><span class="o">.</span>
    <span class="n">If</span> <span class="n">states</span> <span class="n">at</span> <span class="n">the</span> <span class="n">same</span> <span class="n">index</span> <span class="n">have</span> <span class="n">different</span> <span class="n">keys</span><span class="p">,</span> <span class="n">that</span><span class="s1">&#39;s an error and a fast fault.</span>
    <span class="n">If</span> <span class="n">states</span> <span class="n">at</span> <span class="n">different</span> <span class="n">indices</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">keys</span><span class="p">,</span> <span class="n">that</span><span class="s1">&#39;s an error and a fast fault.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">astCorrectStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astNonsenseStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astDuplicatedStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astHalfFullStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Set</span> <span class="n">up</span> <span class="n">the</span> <span class="n">state</span> <span class="n">arrays</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">test</span> <span class="n">methods</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">astCorrectStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">));</span>
    <span class="n">astNonsenseStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;asdf&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">));</span>
    <span class="n">IF</span> <span class="n">UINT_TO_BOOL</span><span class="p">(</span><span class="n">nIter</span> <span class="n">MOD</span> <span class="mi">2</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">astDuplicatedStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="s1">&#39;State0&#39;</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">astDuplicatedStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="s1">&#39;State1&#39;</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">IF</span> <span class="n">nIter</span> <span class="o">&lt;=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="o">/</span> <span class="mi">2</span> <span class="n">THEN</span>
        <span class="n">astHalfFullStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">));</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="n">TestSolo</span><span class="p">();</span>
<span class="n">TestTrio</span><span class="p">();</span>
<span class="n">TestNonsense</span><span class="p">();</span>
<span class="n">TestDupe</span><span class="p">();</span>
<span class="n">TestBackfill</span><span class="p">();</span>
<span class="n">TestHalfFull</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestBackfill</span>
<span class="n">VAR_INST</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">stDefaultBP</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestBackfill&#39;</span><span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astCorrectStates</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Pick</span> <span class="n">a</span> <span class="n">few</span> <span class="n">parameters</span> <span class="n">to</span> <span class="n">drop</span> <span class="ow">in</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">999</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">777</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">bBeamParamsLoaded</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">stDefaultBP</span><span class="o">.</span><span class="n">bBeamParamsLoaded</span><span class="p">;</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestBackfill&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">Everything</span> <span class="n">should</span> <span class="n">be</span> <span class="n">cleared</span> <span class="n">to</span> <span class="n">the</span> <span class="n">defaults</span><span class="p">:</span> <span class="n">the</span> <span class="n">library</span> <span class="n">should</span> <span class="n">let</span> <span class="n">us</span> <span class="n">know</span> <span class="n">what</span> <span class="n">params</span> <span class="n">got</span> <span class="n">loaded</span> <span class="p">(</span><span class="n">none</span><span class="p">)</span>
<span class="n">AssertEquals_UDINT</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">stDefaultBP</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nRate</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nRate</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;nRate of motor 1 state 3 not backfilled&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_UDINT</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">stDefaultBP</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;nRequestAssertionID of motor 2 state 3 not backfilled&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">stDefaultBP</span><span class="o">.</span><span class="n">bBeamParamsLoaded</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">bBeamParamsLoaded</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bBeamParamsLoaded of motor 3 state 2 not backfilled&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestDupe</span>
<span class="n">VAR_INST</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestDupe&#39;</span><span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astDuplicatedStates</span><span class="p">;</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestTrio&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbRead</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Should have had an error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">AssertEquals_STRING</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Errored output should have had no state names: &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">)),</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestHalfFull</span>
<span class="n">VAR_INST</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestHalfFull&#39;</span><span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astHalfFullStates</span><span class="p">;</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestHalfFull&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbRead</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Had an error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_STRING</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Output did not have the correct transition state&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="o">/</span> <span class="mi">2</span> <span class="n">DO</span>
    <span class="n">AssertEquals_STRING</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astCorrectStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Output did not have the correct position state: &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">)),</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestNonsense</span>
<span class="n">VAR_INST</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestNonsense&#39;</span><span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astCorrectStates</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astNonsenseStates</span><span class="p">;</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestTrio&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbRead</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Should have had an error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">Only</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="n">should</span> <span class="n">be</span> <span class="n">spared</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">nonsense</span>
<span class="n">AssertEquals_STRING</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Transition state should be OK&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">AssertEquals_STRING</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Errored output should have had no state names: &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">)),</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestSolo</span>
<span class="n">VAR_INST</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestSolo&#39;</span><span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astCorrectStates</span><span class="p">;</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestSolo&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbRead</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Had an error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_STRING</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Output did not have the correct transition state&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">AssertEquals_STRING</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astCorrectStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Output did not have the correct position state: &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">)),</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestTrio</span>
<span class="n">VAR_INST</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestTrio&#39;</span><span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astCorrectStates</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astCorrectStates</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astCorrectStates</span><span class="p">;</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestTrio&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbRead</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Had an error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_STRING</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Output did not have the correct transition state&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">AssertEquals_STRING</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astCorrectStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Output did not have the correct position state: &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">)),</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionreadpmpsdbnd">FB_MotionReadPMPSDBND</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionrequest">
<h2>FB_MotionRequest<a class="headerlink" href="#fb-motionrequest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionRequest</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Request</span> <span class="n">a</span> <span class="n">move</span> <span class="kn">from</span><span class="w"> </span><span class="nn">an</span> <span class="n">axis</span> <span class="n">controlled</span> <span class="n">via</span> <span class="n">EPICS</span> <span class="n">using</span> <span class="n">FB_MotionStage</span>
    <span class="n">This</span> <span class="n">exists</span> <span class="n">to</span> <span class="n">manage</span> <span class="n">situations</span> <span class="n">where</span> <span class="n">different</span> <span class="n">bits</span> <span class="n">of</span> <span class="n">code</span> <span class="n">may</span> <span class="n">need</span> <span class="n">to</span> <span class="n">move</span> <span class="n">the</span> <span class="n">same</span> <span class="n">motor</span><span class="o">.</span>
    <span class="n">With</span> <span class="n">just</span> <span class="n">the</span> <span class="n">ST_MotionStage</span><span class="o">/</span><span class="n">FB_MotionStage</span> <span class="n">setup</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">possible</span> <span class="k">for</span> <span class="n">two</span> <span class="n">function</span> <span class="n">blocks</span> <span class="n">to</span>
    <span class="n">fight</span> <span class="k">with</span> <span class="ow">and</span> <span class="n">interfere</span> <span class="k">with</span> <span class="n">each</span> <span class="n">other</span> <span class="ow">and</span> <span class="k">with</span> <span class="n">the</span> <span class="n">EPICS</span> <span class="n">commands</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">move</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">stop</span> <span class="n">move</span> <span class="n">on</span> <span class="n">falling</span> <span class="n">edge</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Reset</span> <span class="n">errors</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">behavior</span> <span class="k">for</span> <span class="n">when</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">moving</span>
    <span class="n">enumMotionRequest</span><span class="p">:</span> <span class="n">E_MotionRequest</span> <span class="o">:=</span> <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">WAIT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goal</span> <span class="n">position</span>
    <span class="n">fPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Move</span> <span class="n">velocity</span>
    <span class="n">fVel</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Optional</span> <span class="n">acceleration</span>
    <span class="n">fAcc</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Optional</span> <span class="n">deceleration</span>
    <span class="n">fDec</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="kc">True</span> <span class="k">if</span> <span class="ow">in</span> <span class="n">error</span> <span class="n">state</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">What</span> <span class="n">the</span> <span class="n">error</span> <span class="n">code</span> <span class="n">means</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">motor</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">and</span> <span class="n">our</span> <span class="n">most</span> <span class="n">recent</span> <span class="n">move</span> <span class="n">was</span> <span class="n">successful</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftExec</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">rtReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftBusy</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bMyMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bCausedError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Define</span> <span class="n">local</span> <span class="n">constants</span> <span class="k">for</span> <span class="n">our</span> <span class="n">state</span> <span class="n">machine</span> <span class="n">states</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">INIT</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">WAIT_EXEC</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">PICK_REQUEST</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">WAIT_OTHER_MOVE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">STOP_OTHER_MOVE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">START_MOVE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">WAIT_MY_MOVE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">STOP_MY_MOVE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">;</span>
    <span class="n">DONE_MOVING</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">ERROR</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">9</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">ftExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bReset</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Go</span> <span class="n">back</span> <span class="n">to</span> <span class="n">INIT</span> <span class="n">state</span> <span class="n">on</span> <span class="n">reset</span>
<span class="n">IF</span> <span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">nState</span> <span class="o">:=</span> <span class="n">INIT</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">by</span> <span class="n">setting</span> <span class="n">everything</span> <span class="n">to</span> <span class="n">a</span> <span class="n">known</span> <span class="n">value</span>
    <span class="n">INIT</span><span class="p">:</span>
        <span class="n">nState</span> <span class="o">:=</span> <span class="n">WAIT_EXEC</span><span class="p">;</span>
        <span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bCausedError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="s2">&quot;waiting for move command&quot;</span> <span class="n">state</span>
    <span class="n">WAIT_EXEC</span><span class="p">:</span>
        <span class="n">bMyMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">Looking</span> <span class="k">for</span> <span class="n">a</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">on</span> <span class="n">bExecute</span>
        <span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">PICK_REQUEST</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Decide</span> <span class="n">how</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">the</span> <span class="n">request</span>
    <span class="n">PICK_REQUEST</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
            <span class="n">CASE</span> <span class="n">enumMotionRequest</span> <span class="n">OF</span>
                <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">WAIT</span><span class="p">:</span>
                    <span class="n">nState</span> <span class="o">:=</span> <span class="n">WAIT_OTHER_MOVE</span><span class="p">;</span>
                <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="p">:</span>
                    <span class="n">nState</span> <span class="o">:=</span> <span class="n">STOP_OTHER_MOVE</span><span class="p">;</span>
                <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">ABORT</span><span class="p">:</span>
                    <span class="n">nState</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
                    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">E_LCLSMotionError</span><span class="o">.</span><span class="n">ABORTED</span><span class="p">;</span>
            <span class="n">END_CASE</span>
        <span class="n">ELSE</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">START_MOVE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Watch</span> <span class="n">the</span> <span class="n">other</span> <span class="n">move</span><span class="p">,</span> <span class="n">then</span> <span class="n">see</span> <span class="k">if</span> <span class="n">it</span><span class="s1">&#39;s our turn</span>
    <span class="n">WAIT_OTHER_MOVE</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">Try</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">request</span> <span class="n">again</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">once</span> <span class="n">the</span> <span class="n">move</span> <span class="ow">is</span> <span class="n">over</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">PICK_REQUEST</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Interrupt</span> <span class="n">the</span> <span class="n">other</span> <span class="n">move</span><span class="p">,</span> <span class="n">then</span> <span class="n">go</span> <span class="n">to</span> <span class="n">start</span> <span class="n">ours</span>
    <span class="n">STOP_OTHER_MOVE</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">START_MOVE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">values</span> <span class="n">on</span> <span class="n">ST_MotionStage</span> <span class="n">to</span> <span class="n">start</span> <span class="n">a</span> <span class="n">new</span> <span class="n">absolute</span> <span class="n">move</span>
    <span class="n">START_MOVE</span><span class="p">:</span>
        <span class="n">bMyMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCommand</span> <span class="o">:=</span> <span class="n">E_EpicsMotorCmd</span><span class="o">.</span><span class="n">MOVE_ABSOLUTE</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fPos</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">fVel</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">fAcc</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fDeceleration</span> <span class="o">:=</span> <span class="n">fDec</span><span class="p">;</span>
        <span class="n">nState</span> <span class="o">:=</span> <span class="n">WAIT_MY_MOVE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Watch</span> <span class="n">our</span> <span class="n">ongoing</span> <span class="n">move</span><span class="p">,</span> <span class="n">look</span> <span class="k">for</span> <span class="n">the</span> <span class="n">move</span> <span class="n">to</span> <span class="n">end</span> <span class="ow">or</span> <span class="n">requests</span> <span class="n">to</span> <span class="n">stop</span> <span class="n">the</span> <span class="n">move</span> <span class="kn">from</span><span class="w"> </span><span class="nn">this</span> <span class="n">FB</span>
    <span class="n">WAIT_MY_MOVE</span><span class="p">:</span>
        <span class="n">ftBusy</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>
        <span class="n">IF</span> <span class="n">ftBusy</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">DONE_MOVING</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="o">//</span> <span class="n">Implement</span> <span class="n">stop</span> <span class="n">on</span> <span class="n">falling</span> <span class="n">trigger</span>
        <span class="n">IF</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">STOP_MY_MOVE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Request</span> <span class="n">a</span> <span class="n">stop</span> <span class="ow">and</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">it</span> <span class="n">to</span> <span class="n">happen</span>
    <span class="n">STOP_MY_MOVE</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">DONE_MOVING</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Pick</span> <span class="n">out</span> <span class="n">the</span> <span class="n">bDone</span> <span class="n">state</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">to</span> <span class="n">waiting</span>
    <span class="n">DONE_MOVING</span><span class="p">:</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bDone</span><span class="p">;</span>
        <span class="n">nState</span> <span class="o">:=</span> <span class="n">WAIT_EXEC</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Lock</span> <span class="n">us</span> <span class="n">into</span> <span class="n">the</span> <span class="n">error</span> <span class="n">state</span> <span class="n">until</span> <span class="n">the</span> <span class="n">FB</span> <span class="ow">is</span> <span class="n">reset</span>
    <span class="n">ERROR</span><span class="p">:</span>
        <span class="n">bMyMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="o">//</span> <span class="n">Transition</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ERROR</span> <span class="n">state</span> <span class="k">if</span> <span class="n">applicable</span>
<span class="n">IF</span> <span class="n">bMyMove</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">nState</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
    <span class="n">bCausedError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">F_MotionErrorCodeLookup</span><span class="p">(</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">nErrorId</span><span class="p">);</span>

<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="n">INIT</span><span class="p">,</span> <span class="n">WAIT_EXEC</span><span class="p">,</span> <span class="n">ERROR</span><span class="p">:</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></p></li>
<li><p><a class="reference internal" href="#e-lclsmotionerror">E_LCLSMotionError</a></p></li>
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#f-motionerrorcodelookup">F_MotionErrorCodeLookup</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionstage">
<h2>FB_MotionStage<a class="headerlink" href="#fb-motionstage" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_MotionStage
(*
    Default implementation for PLC behavior when motor IOC asks for a move
    This can be extended or replaced in your PLC project if you want
    non-default behavior to arise from the motor record processing
*)
VAR_IN_OUT
    stMotionStage: ST_MotionStage;
END_VAR
VAR
    fbDriveVirtual: FB_DriveVirtual;
    fbMotionHome: FB_MotionHoming;
    fbSaveRestore: FB_EncSaveRestore;
    fbLogError: FB_LogMotionError;
    fbBacklashCompensation: FB_MotionBacklashCompensation;
    bExecute: BOOL;
    bExecMove: BOOL;
    bExecHome: BOOL;
    bFwdHit: BOOL;
    bBwdHit: BOOL;
    ftExec: F_TRIG;
    rtExec: R_TRIG;
    rtUserExec: R_TRIG;
    rtTarget: R_TRIG;
    rtHomed: R_TRIG;
    fbSetEnables: FB_SetEnables;
    bPosGoal: BOOL;
    bNegGoal: BOOL;
    fbEncoderValue: FB_EncoderValue;
    fbNCParams: FB_MotionStageNCParams;
    bNewMoveReq: BOOL;
    bPrepareDisable: BOOL;
    bMoveCmd: BOOL;
    rtMoveCmdShortcut: R_TRIG;
    rtHomeCmdShortcut: R_TRIG;
    rtEnableMode: R_TRIG;
END_VAR
// Start with an accurate status
stMotionStage.Axis.ReadStatus();

// Check for the plc shortcut commands
// Used for testing or to circumvent motor record issues
rtMoveCmdShortcut(CLK:=stMotionStage.bMoveCmd);
rtHomeCmdShortcut(CLK:=stMotionStage.bHomeCmd);
// Execute on rising edge
IF rtMoveCmdShortcut.Q AND NOT stMotionStage.bExecute THEN
    stMotionStage.bExecute := TRUE;
    stMotionStage.nCommand := E_EpicsMotorCmd.MOVE_ABSOLUTE;

    // attempting to move an axis without homing first?
    IF stMotionStage.nHomingMode &lt;&gt; E_EpicsHomeCmd.NONE AND NOT stMotionStage.bHomed THEN
        // one can just set bHome here even though no homing was done?
        stMotionStage.sErrorMessage := &#39;Axis homing mode set, but homing routine pending&#39;;
    END_IF

ELSIF rtHomeCmdShortcut.Q AND NOT stMotionStage.bExecute THEN
    stMotionStage.bExecute := TRUE;
    stMotionStage.nCommand := E_EpicsMotorCmd.HOME;
END_IF
// Always reset, even if not rising edge, so command can be issued again
IF stMotionStage.bMoveCmd OR stMotionStage.bHomeCmd THEN
    stMotionStage.bMoveCmd := FALSE;
    stMotionStage.bHomeCmd := FALSE;
END_IF

// Automatically fill the correct nCmdData for homing
IF stMotionStage.nCommand = E_EpicsMotorCmd.HOME THEN
    stMotionStage.nCmdData := stMotionStage.nHomingMode;
END_IF

// Check if the command wants to cause a move
bMoveCmd R= stMotionStage.nCmdData = E_EpicsHomeCmd.ABSOLUTE_SET;
bMoveCmd R= stMotionStage.nCmdData = E_EpicsHomeCmd.NONE;
bMoveCmd S= stMotionStage.nCommand &lt;&gt; E_EpicsMotorCmd.HOME;

// Handle main execs
rtUserExec(CLK := stMotionStage.bExecute);
bNewMoveReq S= rtUserExec.Q AND bMoveCmd;
bNewMoveReq R= NOT stMotionStage.bExecute;
bPrepareDisable R= bNewMoveReq;

bPosGoal := stMotionStage.stAxisStatus.fActPosition &lt; stMotionStage.fPosition;
bNegGoal := stMotionStage.stAxisStatus.fActPosition &gt; stMotionStage.fPosition;

// Moves are automatically allowed if no safety hooks. Otherwise, some other code will set this.
stMotionStage.bSafetyReady S= stMotionStage.bPowerSelf;

// Transition to DURING_MOTION drive mode
rtEnableMode(CLK:=(stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION));
// Handle auto-enable timing
CASE stMotionStage.nEnableMode OF
    E_StageEnableMode.ALWAYS:
        stMotionStage.bEnable := TRUE;
    E_StageEnableMode.DURING_MOTION:
        IF rtEnableMode.Q THEN
            stMotionStage.bEnable := FALSE;
        END_IF
        IF bNewMoveReq THEN
            IF stMotionStage.nCommand = E_EpicsMotorCmd.HOME THEN
                stMotionStage.bEnable := stMotionStage.bSafetyReady;
            ELSIF bPosGoal THEN
                IF stMotionStage.bAllForwardEnable THEN
                    stMotionStage.bEnable S= stMotionStage.bSafetyReady;
                ELSIF NOT stMotionStage.bError THEN
                    // Not an error, just a warning
                    stMotionStage.sErrorMessage := &#39;Cannot move past positive limit.&#39;;
                    stMotionStage.bExecute := FALSE;
                END_IF
            ELSIF bNegGoal THEN
                IF stMotionStage.bAllBackwardEnable THEN
                    stMotionStage.bEnable S= stMotionStage.bSafetyReady;
                ELSIF NOT stMotionStage.bError THEN
                    // Not an error, just a warning
                    stMotionStage.sErrorMessage := &#39;Cannot move past negative limit.&#39;;
                    stMotionStage.bExecute := FALSE;
                END_IF
            ELSE
                // Super rare condition where we asked for a move to exactly the same floating point we&#39;re already at
                stMotionStage.bEnable S= stMotionStage.bSafetyReady;
            END_IF
            IF stMotionStage.bEnable OR stMotionStage.bError THEN
                bNewMoveReq := FALSE;
            END_IF
        END_IF
END_CASE

// Update all enable booleans
fbSetEnables(stMotionStage:=stMotionStage);

IF stMotionStage.stAxisStatus.bBusy AND NOT bExecute THEN
    // Wait for the previous move to end
    bExecute := FALSE;
ELSIF bMoveCmd THEN
    // Do not start the move until we have power and the safety system says it is OK
    bExecute := stMotionStage.bExecute AND stMotionStage.bAllEnable AND stMotionStage.bEnableDone AND stMotionStage.bSafetyReady;
ELSE
    bExecute := stMotionStage.bExecute;
END_IF

IF bExecute AND NOT stMotionStage.bError THEN
    // Reset local warnings if things are going well
    stMotionStage.sErrorMessage := &#39;&#39;;
END_IF

// No moves allowed in error states
IF stMotionStage.bError THEN
    bExecute := FALSE;
END_IF


bExecHome := bExecute AND stMotionStage.nCommand = 10;
bExecMove := bExecute AND NOT bExecHome;

// handles backlash compensention
fbBacklashCompensation(stMotionStage:=stMotionStage,
    bHoming:=bExecHome,
    bMoving:=bExecMove );

// Handle standard commands using ESS&#39;s FB
fbDriveVirtual(En:=TRUE,
    bEnable:=stMotionStage.bAllEnable,
    bReset:=stMotionStage.bReset,
    bExecute:=bExecMove,
    nCommand:=INT_TO_UINT(stMotionStage.nCommand),
    nCmdData:=INT_TO_UINT(stMotionStage.nCmdData),
    fVelocity:=stMotionStage.fVelocity,
    fPosition:=stMotionStage.fPosition,
    fAcceleration:=stMotionStage.fAcceleration,
    fDeceleration:=stMotionStage.fDeceleration,
    bLimitFwd:=stMotionStage.bAllForwardEnable,
    bLimitBwd:=stMotionStage.bAllBackwardEnable,
    bHomeSensor:=stMotionStage.bHome,
    fHomePosition:=stMotionStage.fHomePosition,
    bPowerSelf:=stMotionStage.bPowerSelf,
    nMotionAxisID=&gt;stMotionStage.nMotionAxisID,
    Axis:=stMotionStage.Axis);

// Some custom home handling
fbMotionHome(
    stMotionStage:=stMotionStage,
    bExecute:=bExecHome);

// Update status again after the move starts or stops
stMotionStage.Axis.ReadStatus();

// Check for a new error
IF NOT stMotionStage.bError THEN
    stMotionStage.bError := fbDriveVirtual.bError;
    stMotionStage.nErrorId := fbDriveVirtual.nErrorId;
END_IF
IF NOT stMotionStage.bError THEN
    stMotionStage.bError := fbBacklashCompensation.bError;
    stMotionStage.nErrorId := fbBacklashCompensation.nErrorId;
END_IF
IF NOT stMotionStage.bError THEN
    stMotionStage.bError := fbMotionHome.bError;
    stMotionStage.nErrorId := fbMotionHome.nErrorId;
END_IF
IF NOT stMotionStage.bError AND stMotionStage.bExecute AND NOT stMotionStage.bUserEnable THEN
    stMotionStage.bError := TRUE;
    stMotionStage.nErrorId := 1;
    stMotionStage.sCustomErrorMessage := &#39;Move requested, but user enable is disabled!&#39;;
END_IF

// Set the error message if we have one
IF stMotionStage.bError THEN
    // Hook if other code wants to inject a non-NC error
    IF stMotionStage.sCustomErrorMessage &lt;&gt; &#39;&#39; THEN
        stMotionStage.sErrorMessage := stMotionSTage.sCustomErrorMessage;
    ELSE
        stMotionStage.sErrorMessage := F_MotionErrorCodeLookup(nErrorId := stMotionStage.nErrorId);
    END_IF
END_IF

fbLogError(
    stMotionStage:=stMotionStage,
    bEnable:=TRUE);

// When we start, set the busy/done appropriately
rtExec(CLK:=bExecute);
IF rtExec.Q THEN
    stMotionStage.bBusy := TRUE;
    stMotionStage.bDone := FALSE;
END_IF

// Force everything off in case of error
IF stMotionStage.bError THEN
    stMotionStage.bBusy := FALSE;
    stMotionStage.bDone := FALSE;
    stMotionStage.bEnable := FALSE;
END_IF

// Check the limits and cancel execution if appropriate. Without this block we have infinite error spam
bFwdHit := stMotionStage.Axis.Status.PositiveDirection AND NOT stMotionStage.bAllForwardEnable;
bBwdHit := stMotionStage.Axis.Status.NegativeDirection AND NOT stMotionStage.bAllBackwardEnable;
IF (bFwdHit OR bBwdHit) AND NOT fbMotionHome.bBusy THEN
    stMotionStage.bExecute := FALSE;
END_IF

// Check done moving via user stop, fbDriveVirtual and Target Position Monitoring, or from homing.
ftExec(CLK:=stMotionStage.bExecute);
rtTarget(CLK:=(stMotionStage.Axis.Status.InTargetPosition AND fbDriveVirtual.bDone AND bExecMove));
rtHomed(CLK:=fbMotionHome.bDone AND bExecHome);
IF ftExec.Q OR rtTarget.Q OR rtHomed.Q THEN
    IF NOT stMotionStage.bDone THEN
        stMotionStage.bDone := TRUE;
        stMotionStage.bBusy := FALSE;
        IF NOT stMotionStage.Axis.Status.Error THEN
            bExecute := FALSE;
            stMotionStage.bExecute := FALSE;
        END_IF
    END_IF
END_IF

// Handle auto-disable timing
bPrepareDisable S= stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION AND ftExec.Q;
// Delay the disable until we reach standstill, else brake issues or other race conditions
IF bPrepareDisable AND stMotionStage.Axis.Status.MotionState = MC_AXISSTATE_STANDSTILL THEN
    bPrepareDisable := FALSE;
    stMotionStage.bEnable := FALSE;
END_IF

// Get a definitive bEnabled reading
CASE stMotionStage.Axis.Status.MotionState OF
    // We are not enabled if there is an issue
    MC_AXISSTATE_UNDEFINED, MC_AXISSTATE_DISABLED, MC_AXISSTATE_ERRORSTOP:
        stMotionStage.bEnableDone := FALSE;
    ELSE
        stMotionStage.bEnableDone := TRUE;
END_CASE

// Handle the brake. TRUE means brake disabled/released
IF stMotionStage.nBrakeMode &lt;&gt; E_StageBrakeMode.NO_BRAKE THEN
    CASE stMotionStage.Axis.Status.MotionState OF
        MC_AXISSTATE_UNDEFINED,
        MC_AXISSTATE_DISABLED,
        MC_AXISSTATE_ERRORSTOP:
            stMotionStage.bBrakeRelease := FALSE;
        MC_AXISSTATE_STANDSTILL:
            IF stMotionStage.nBrakeMode = E_StageBrakeMode.IF_MOVING THEN
                stMotionStage.bBrakeRelease := FALSE;
            ELSE
                stMotionStage.bBrakeRelease := TRUE;
            END_IF
        ELSE
            stMotionStage.bBrakeRelease := TRUE;
    END_CASE
END_IF

// Sync the epics status struct
stMotionStage.stAxisStatus := fbDriveVirtual.stAxisStatus;
stMotionStage.stAxisStatus.bEnabled := stMotionStage.bEnableDone;

// Override homing status, dmov as appropriate
stMotionStage.bHomed := fbMotionHome.bDone AND NOT fbMotionHome.bError;
stMotionStage.stAxisStatus.bHomed := stMotionStage.bHomed;
stMotionStage.stAxisStatus.bExecute := bExecute;
stMotionStage.stAxisStatus.nCommand := 3; // If this is not 3, the IOC stops updating positions during homing

// Fill in auxiliary status info
stMotionStage.fPosDiff := stMotionStage.Axis.NcToPlc.PosDiff;

// Reset everything when bReset is flagged
IF stMotionStage.bReset THEN
    stMotionStage.bEnable := FALSE;
    stMotionStage.bReset := FALSE;
    stMotionStage.bExecute := FALSE;
    stMotionStage.bError := FALSE;
    stMotionStage.nErrorId := 0;
    stMotionStage.sErrorMessage := &#39;&#39;;
    stMotionStage.sCustomErrorMessage := &#39;&#39;;
    bExecute := FALSE;
END_IF

fbEncoderValue(stMotionStage:=stMotionStage);
fbNCParams(
    stMotionStage:=stMotionStage,
    bEnable:=TRUE,
    tRefreshDelay:=T#1s);

// Save and restore as long as not an absolute encoder
fbSaveRestore(
    stMotionStage:=stMotionStage,
    bEnable:=stMotionStage.nHomingMode &lt;&gt; E_EpicsHomeCmd.NONE);

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></p></li>
<li><p><a class="reference internal" href="#e-stagebrakemode">E_StageBrakeMode</a></p></li>
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#fb-drivevirtual">FB_DriveVirtual</a></p></li>
<li><p><a class="reference internal" href="#fb-encsaverestore">FB_EncSaveRestore</a></p></li>
<li><p><a class="reference internal" href="#fb-encodervalue">FB_EncoderValue</a></p></li>
<li><p><a class="reference internal" href="#fb-logmotionerror">FB_LogMotionError</a></p></li>
<li><p><a class="reference internal" href="#fb-motionbacklashcompensation">FB_MotionBacklashCompensation</a></p></li>
<li><p><a class="reference internal" href="#fb-motionhoming">FB_MotionHoming</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstagencparams">FB_MotionStageNCParams</a></p></li>
<li><p><a class="reference internal" href="#fb-setenables">FB_SetEnables</a></p></li>
<li><p><a class="reference internal" href="#f-motionerrorcodelookup">F_MotionErrorCodeLookup</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionstagee727">
<h2>FB_MotionStageE727<a class="headerlink" href="#fb-motionstagee727" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*  MCS2 Motion Stage . Controller a stage in CSP (NC), STEP_MODE and Homing via DS402 interface
     Using an overriden Position Holding timer. power enable mode must be &#39;DURING_MOTION&#39;. for close loop aka CSP control
    set bServo PV to true, fort open loop step mode bServo must be cleared
*)
{attribute &#39;call_after_init&#39;}
FUNCTION_BLOCK FB_MotionStageE727 IMPLEMENTS I_DS402GenericDrive
VAR
    {attribute &#39;no_copy&#39;}
    stMotionStage  : REFERENCE TO ST_MotionStage;
    // Hardware I/O
    stDS402Drive            : ST_DS402Drive;
    // Must be Provided
    {attribute &#39;hide&#39;}
    eModule                         : E_Module;
    {attribute &#39;hide&#39;}
    eHomeMode                       : E_EpicsHomeCmd :=E_EpicsHomeCmd.AUTOZERO;
    {attribute &#39;hide&#39;}
    eBufferMode             : MC_BufferMode := MC_BufferMode.MC_Aborting;
    {attribute &#39;hide&#39;}
    eMotionState            : E_MoveState;
    {attribute &#39;hide&#39;}
    eHomeState              : E_MoveState;
    {attribute &#39;hide&#39;}
    fbMcPower                       : MC_Power;
    {attribute &#39;hide&#39;}
    fbMcMoveAbsolute        : MC_MoveAbsolute;
    {attribute &#39;hide&#39;}
    fbMcHalt                        : MC_Halt;
    {attribute &#39;hide&#39;}
    fbMcReset                       : MC_Reset;
    {attribute &#39;hide&#39;}
    fbMcWriteParameter      : MC_WriteParameter;
    {attribute &#39;hide&#39;}
    fbMcReadParams          : MC_ReadParameterSet;
    {attribute &#39;hide&#39;}
    bEnPosLag                       : BOOL;
    {attribute &#39;hide&#39;}
    bWrongParameter         : BOOL;
    {attribute &#39;hide&#39;}
    bExecMove                       : BOOL;
    {attribute &#39;hide&#39;}
    bExecHome                       : BOOL;
    {attribute &#39;hide&#39;}
    bNewMoveReq             : BOOL;
    {attribute &#39;hide&#39;}
    bHomeBusy                       : BOOL;
    {attribute &#39;hide&#39;}
    bPrepareDisable         : BOOL;
    {attribute &#39;hide&#39;}
    bStop                           : BOOL;
    {attribute &#39;hide&#39;}
    bOperational            : BOOL;
    {attribute &#39;hide&#39;}
    bLimOverride            : BOOL;
    // use this for motion time axis states
    {attribute &#39;hide&#39;}
    bLocalExec                      : BOOL;
    // Save abd restore encoder value
    {attribute &#39;hide&#39;}
    bInit                           : BOOL;
    {attribute &#39;hide&#39;}
    bHomeDone                       : BOOL;
    {attribute &#39;hide&#39;}
    bHomeModeEnabled        : BOOL;
    {attribute &#39;hide&#39;}
    bCSPModeEnabled         : BOOL;
    {attribute &#39;hide&#39;}
    bRestoreLoad            : BOOL;
    {attribute &#39;hide&#39;}
    bExecParamsRead         : BOOL;
    {attribute &#39;hide&#39;}
    bCommandMoveAbsolute : BOOL;
    {attribute &#39;hide&#39;}
    bRecentEnPosLagStatus   : BOOL;
    {attribute &#39;hide&#39;}
    bHomeAborted : BOOL;
    {attribute &#39;hide&#39;}
    bDS402ManualEnabled : BOOL;
    {attribute &#39;hide&#39;}
    fMeasuredVelo           : LREAL;
    {attribute &#39;hide&#39;}
    fMeasuredAcc            : LREAL;
    {attribute &#39;hide&#39;}
    fScalingFactor          : LREAL:= 0.000001;
    {attribute &#39;hide&#39;}
    fParameterValue : LREAL;
    {attribute &#39;hide&#39;}
    fMeasuredPos            : LREAL;
    {attribute &#39;hide&#39;}
    nSoftLimMin             : LINT;
    {attribute &#39;hide&#39;}
    nSoftLimMax             : LINT;
    {attribute &#39;hide&#39;}
    tonSyncHoming           : TON;
    {attribute &#39;hide&#39;}
    tonSlowParamReadTimer: TON;
    {attribute &#39;hide&#39;}
    NCParamsTimer           : TON;
    {attribute &#39;hide&#39;}
    tonRestoreRetry         : TON;
    {attribute &#39;hide&#39;}
    rtAborted                       : R_TRIG;
    {attribute &#39;hide&#39;}
    rtStopDone                      : R_TRIG;
    {attribute &#39;hide&#39;}
    rtExec                          : R_TRIG;
    {attribute &#39;hide&#39;}
    rtMoveCmdShortcut       : R_TRIG;
    {attribute &#39;hide&#39;}
    rtHomeCmdShortcut       : R_TRIG;
    {attribute &#39;hide&#39;}
    rtEnableMode            : R_TRIG;
    {attribute &#39;hide&#39;}
    rtUserExec              : R_TRIG;
    {attribute &#39;hide&#39;}
    rtModeChange            : R_TRIG;
    {attribute &#39;hide&#39;}
    rtMoveDone              : R_TRIG;
    {attribute &#39;hide&#39;}
    {attribute &#39;hide&#39;}
    rtNewMoveReq            : R_TRIG;
    {attribute &#39;hide&#39;}
    ftExec                  : F_TRIG;
    {attribute &#39;hide&#39;}
    rtHomeDone                      : R_TRIG;
    {attribute &#39;hide&#39;}
    rtCSPModeOk                     : R_TRIG;
    {attribute &#39;hide&#39;}
    rtHomeModeEnable        : R_TRIG;
    {attribute &#39;hide&#39;}
    nSubIndex                       : BYTE := 0;
    {attribute &#39;hide&#39;}
    nChanSoftwareLimIdx : WORD;
    {attribute &#39;hide&#39;}
    nChanErrorCodeIdx       : WORD;
    {attribute &#39;hide&#39;}
    nChanSoftLimitIdx       : WORD;
    {attribute &#39;hide&#39;}
    bLocalReset: BOOL;
    {attribute &#39;hide&#39;}
    nCommandLocal: INT := 3;
    {attribute &#39;hide&#39;}
    nCmdDataLocal: INT;

END_VAR

VAR CONSTANT
    {attribute &#39;hide&#39;}
    nChanSoftLimitBase      : WORD := 16#607D;
    {attribute &#39;hide&#39;}
    nErrorCodeBase          : WORD := 16#603F;
    // this true for SmartAct MCS2 and E-727.
    {attribute &#39;hide&#39;}
    nChanOfsBase            : WORD := 16#800;

END_VAR

VAR PERSISTENT
    bSaved  : BOOL;
    fSavedPosition  : LREAL;
END_VAR
IF NOT __ISVALIDREF(stMotionStage) THEN
    RETURN;
END_IF

(* Done once after init*)
IF bInit THEN
    stMotionStage.nMotionAxisID := stMotionStage.Axis.NcToPlc.AxisId;
    (* Clear drive error/wraning condition, in open loop mode
       this will trigger a correct startup for procedure *)
    stDS402Drive.nDS402DriveControl := 128;
    // fist cycle reading of NC paramters
    bExecParamsRead := TRUE;
    bInit := FALSE;
END_IF
(* Check for the plc shortcut commands
   Used for testing or to circumvent motor record issues*)
rtMoveCmdShortcut(CLK:=stMotionStage.bMoveCmd);
rtHomeCmdShortcut(CLK:=stMotionStage.bHomeCmd);

(* Execute on rising edge*)
IF rtMoveCmdShortcut.Q AND NOT stMotionStage.bExecute THEN
    stMotionStage.bExecute:=TRUE;
    stMotionStage.nCommand := E_EpicsMotorCmd.MOVE_ABSOLUTE;
    bEnPosLag := bRecentEnPosLagStatus;
    fParameterValue := BOOL_TO_LREAL(bRecentEnPosLagStatus);

ELSIF rtHomeCmdShortcut.Q AND NOT stMotionStage.bExecute THEN
    stMotionStage.bExecute:= NOT ( stMotionStage.nCmdData=E_EpicsHomeCmd.ABSOLUTE_SET )
                            OR NOT ( stMotionStage.nCmdData=E_EpicsHomeCmd.NONE);
    stMotionStage.nCommand:=E_EpicsMotorCmd.HOME;
    (* Automatically fill the correct nCmdData for homing*)
    stMotionStage.nCmdData:=stMotionStage.nHomingMode;
    (*      Positional lag is not evaluated by E727 during homing, but NC does evaluated
        the condition which will lead to error as the lag is significant during homing
        disable the NC lag check and reenable it after homing is done
    *)
    IF stMotionStage.stAxisParameters.bCtrlEnablePosDiffControl.0 THEN
        bRecentEnPosLagStatus := stMotionStage.stAxisParameters.bCtrlEnablePosDiffControl.0;
        bEnPosLag := TRUE;
        fParameterValue := 0;
    END_IF

END_IF

(* entry point for local and EPICS main execs *)
rtUserExec(CLK:=stMotionStage.bExecute);
(* if a Move/Home Goal is comfirmed and there is no persistant
   error conditions, then we have a valid move request.*)
bNewMoveReq S= NOT stMotionStage.bBusy AND rtUserExec.Q AND NOT stMotionStage.bError;
(* this Move request is valid till an error occurs or the currently move is done *)
bNewMoveReq R= NOT stMotionStage.bExecute OR stMotionStage.bError;
bPrepareDisable R= bNewMoveReq;
rtNewMoveReq(CLK:=bNewMoveReq);
(* Moves are automatically allowed if no safety hooks.
   Otherwise, some other code will set this.*)
stMotionStage.bSafetyReady S= stMotionStage.bPowerSelf;
(* Set the proper command for the request move;
   if bservo not set, manual step moves will be performed *)
IF rtUserExec.Q THEN
    // Transfer nCommand and nCmdData to local copies at rising edge of bExecute (avoid issues if nCommand or nCmdData are changed during a command)
    nCmdDataLocal:=stMotionStage.nCmdData;
    nCommandLocal:=stMotionStage.nCommand;
    (* attempting to move an axis without homing first? *)
    IF stMotionStage.nHomingMode &lt;&gt; E_EpicsHomeCmd.NONE AND NOT stMotionStage.bHomed THEN
        (* one can just set bHome here even though no homing was done?*)
        stMotionStage.sErrorMessage:=&#39;Axis homing mode set, but homing routine pending&#39;;
    END_IF
END_IF

(* Set the drive in the correct operating mode. based on requested move command!
    NB: bservo must set for close loop motion
*)
ModeOperation();

(* NB: This is the only tested mode of operation so far. also aligned
    piezo drive position holding feature
*)
rtEnableMode(CLK:=(stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION));
(* Handle auto-enable timing *)
CASE stMotionStage.nEnableMode OF
    (* Not recommended, not tested *)
    E_StageEnableMode.ALWAYS:
        stMotionStage.bEnable:=TRUE;
    E_StageEnableMode.DURING_MOTION:
        IF rtEnableMode.Q THEN
            stMotionStage.bEnable := FALSE;
        END_IF
        IF rtNewMoveReq.Q THEN
            (*MC block are not compatible with open loop Motion
                thus we wathc for correct close loop modes to use NC features *)
            stMotionStage.bEnable S= stMotionStage.bSafetyReady;
            bStop:=FALSE;
        END_IF
END_CASE
(*  Interlock mainly react on internal limit conditions inthe ove direction.
    MCS2 drive will go into error state when an internal limit is hit *)
Interlock();

IF bCSPModeEnabled THEN
    (*CSP using TwinCAT NC*)
    bLocalExec:= NOT stMotionStage.bError AND stMotionStage.bExecute AND stMotionStage.bAllEnable AND stMotionStage.bEnableDone AND stMotionStage.bSafetyReady;
ELSIF bHomeModeEnabled THEN
    bLocalExec:= NOT stMotionStage.bError AND stMotionStage.bExecute AND stMotionStage.bAllEnable AND  bOperational AND  stMotionStage.bSafetyReady;
ELSE
    bLocalExec:= FALSE;
END_IF

bExecHome:=bLocalExec AND stMotionStage.nCommand = 10;
bExecMove:=bLocalExec AND NOT bExecHome;

(* When we start, set the busy/done appropriately
   NB: CLose loop control using NC *)
rtExec(CLK:=bLocalExec);
IF rtExec.Q THEN
    // Release previous interruption if any
    stDS402Drive.nDS402DriveControl.8 := FALSE;
    stMotionStage.bDone := FALSE;
END_IF

(* updated axis status
   Not needed in manual mode *)
IF NOT bDS402ManualEnabled THEN
    stMotionStage.Axis.ReadStatus();
END_IF

(* Get a definitive bEnabled reading
   NB: use only in close loop mode, NC feature needed*)
CASE stMotionStage.Axis.Status.MotionState OF
    (* We are not enabled if there is an issue*)
    MC_AXISSTATE_UNDEFINED, MC_AXISSTATE_DISABLED, MC_AXISSTATE_ERRORSTOP:
        stMotionStage.bEnableDone := FALSE;
    ELSE
        stMotionStage.bEnableDone := TRUE;
END_CASE
//
IF stMotionStage.bReset THEN
    stMotionStage.bExecute:=FALSE;
    stMotionStage.bError := FALSE;
    stMotionStage.nErrorId := 0;
    stMotionStage.sErrorMessage:=&#39;&#39;;
    stMotionStage.sCustomErrorMessage:=&#39;&#39;;
    (*Manual Drive reset*)
    IF bDS402ManualEnabled THEN
        stDS402Drive.nDS402DriveControl := 128;
    ELSE
        bLocalReset := TRUE;
    END_IF

    stMotionStage.bReset:=FALSE;
END_IF

// Halt is always a user stop during motion
bStop S= NOT bLocalExec AND ((bHomeBusy AND (nCommandLocal=10)) OR (fbMcMoveAbsolute.Busy AND (nCommandLocal=3)));

//auto handle position lag monitoring, disable during homing.
WriteParameterNC(   Execute:=bEnPosLag,
                    ParameterNumber:=MC_AxisParameter.AxisEnPositionLagMonitoring,
                    ParameterValue:=fParameterValue);

(* Requested commands processing *)
CASE nCommandLocal OF
    E_EpicsMotorCmd.MOVE_ABSOLUTE:
        (*NC CSP Move Handling*)
        (* Trigger MC_Reset for close loop operation aka CSP mode *)
        Reset();
        Power();
        Halt();
        (*Wait for drive to be in the correct mode after a request was validated *)
        bCommandMoveAbsolute := bExecMove AND fbMcPower.Status AND bCSPModeEnabled;
        MoveAbsolute();
        (*IN CSP mode the drive control word is update via the NC
          Manual step mode and Homing will override this *)
         stDS402Drive.nDS402DriveControl := stDS402Drive.nDS402DriveControlNC;
    E_EpicsMotorCmd.HOME:
        (*DS402 Manual Homing*)
       Home();
END_CASE

stMotionStage.bBusy := bHomeBusy OR fbMcMoveAbsolute.Busy;

(* Check done moving via user stop, limit hit, Target Position reached, or from homing.*)
rtMoveDone(CLK:=fbMcMoveAbsolute.Done);
rtHomeDone(CLK:=bHomeDone);
rtStopDone(CLK:=fbMcHalt.Done);
rtAborted(CLK:=bHomeAborted);
IF rtAborted.Q OR rtStopDone.Q OR rtMoveDone.Q OR rtHomeDone.Q THEN
    IF NOT stMotionStage.bDone THEN
        stMotionStage.bHomed := bHomeDone;
        stMotionStage.bExecute:=FALSE;
        bCommandMoveAbsolute := FALSE;
        stMotionStage.bDone := fbMcMoveAbsolute.Done OR bHomeDone;
        IF bDS402ManualEnabled THEN
            // No standstill in Manual Mode
            stMotionStage.bEnable:=FALSE;
            (*Restore Postional lag monitoring*)
            bEnPosLag := FALSE;
        END_IF
        (* Release the internal limit override*)
        bLimOverride := FALSE;
        bHomeAborted := FALSE;
    END_IF
END_IF

(* updated axis status
   Not needed in manual mode *)
IF NOT bDS402ManualEnabled THEN
    stMotionStage.Axis.ReadStatus();
END_IF

ftExec(CLK:=stMotionStage.bExecute);
(*Handle auto-disable timing*)
bPrepareDisable S= stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION AND ftExec.Q;
(* Delay the disable until we reach standstill *)
IF bPrepareDisable AND stMotionStage.Axis.Status.StandStill THEN
    bPrepareDisable:=FALSE;
    stMotionStage.bEnable:=FALSE;
END_IF

(* update encoder value and calibrated position*)
ScaleEncRawValue();
(*Drive parameters*)
ExposedParameters(Enable:=TRUE, tRefreshDelay:=T#2S);
(*Sync NC setting to drive settings*)
UpdateDriveMonitoringParams(Enable:=stMotionStage.bAxisParamsInit AND NOT stMotionStage.bBusy);
(* Save and restore as long as not an absolute encoder*)
PersistParameters( Enable:=stMotionStage.nHomingMode &lt;&gt; E_EpicsHomeCmd.NONE);
(*Restore encoder value at initialization*)
RestoreMotionParams(Enable:=stMotionStage.nHomingMode &lt;&gt; E_EpicsHomeCmd.NONE);

(*EPICS Motor record Update*)
UpdateEpicsStatus();
(*
    Error from functions and Nc. The error will send to EPICS interface based on predifined
    priority: axis, power, backlash, absoluteMove, etc...
*)
IF fbMcPower.Error AND fbMcPower.Active THEN
    stMotionStage.bError:=fbMcPower.Error;
    stMotionStage.nErrorId:=fbMcPower.ErrorID;
ELSIF fbMcMoveAbsolute.Error THEN
    stMotionStage.bError:=fbMcMoveAbsolute.Error;
    stMotionStage.nErrorId:=fbMcMoveAbsolute.ErrorID;
ELSIF fbMcHalt.Error AND fbMcHalt.Active THEN
    stMotionStage.bError:=fbMcHalt.Error;
    stMotionStage.nErrorId:=fbMcHalt.ErrorID;
ELSIF fbMcReset.Error  THEN
    stMotionStage.bError:=fbMcReset.Error;
    stMotionStage.nErrorId:=fbMcReset.ErrorID;
ELSIF fbMcWriteParameter.Error THEN
    stMotionStage.bError:=fbMcWriteParameter.Error;
    stMotionStage.nErrorId:=fbMcWriteParameter.ErrorID;
ELSIF fbMcReadParams.Error AND NOT stMotionStage.bBusy THEN
    stMotionStage.bError:=fbMcReadParams.Error;
    stMotionStage.nErrorId:=fbMcReadParams.ErrorID;
ELSE
    IF stMotionStage.bBusy THEN
        stMotionStage.sErrorMessage := &#39;&#39;;
        stMotionStage.sCustomErrorMessage := &#39;&#39;;
    END_IF
END_IF;

(*Double function, prioritize NC error otherwise read drive channel error code*)
ReadDriveCodes();

IF stMotionStage.sCustomErrorMessage &lt;&gt; &#39;&#39;
    AND stMotionStage.sErrorMessage = &#39;&#39; THEN
    stMotionStage.sErrorMessage := stMotionStage.sCustomErrorMessage;
END_IF

(*Clear motion flag when error occurs*)
IF stMotionStage.bError  THEN
    stMotionStage.bBusy := FALSE;
    stMotionStage.bDone := FALSE;
    stMotionStage.bEnable := FALSE;
END_IF

(* We&#39;ve got the rising edge clear this flags.*)
stMotionStage.bMoveCmd:=FALSE;
stMotionStage.bHomeCmd:=FALSE;

END_FUNCTION_BLOCK

METHOD PUBLIC  ExposedParameters
VAR_INPUT
    Enable : BOOL;
    tRefreshDelay: TIME;
END_VAR
// Periodic update of NC parameters
NCParamsTimer( IN:=Enable AND NOT bExecParamsRead, PT:=tRefreshDelay);
bExecParamsRead S= NCParamsTimer.Q;
fbMcReadParams(
    Parameter:=stMotionStage.stAxisParameters,
    Axis:=stMotionStage.Axis,
    Execute:= bExecParamsRead );

// Copy axis parameters that we want to expose to the EPICS layer.
stMotionStage.stAxisParametersExposed.bCtrlEnablePosDiffControl     := stMotionStage.stAxisParameters.bCtrlEnablePosDiffControl;
stMotionStage.stAxisParametersExposed.bEncEnableSoftEndMaxControl   := stMotionStage.stAxisParameters.bEncEnableSoftEndMaxControl;
stMotionStage.stAxisParametersExposed.bEncEnableSoftEndMinControl   := stMotionStage.stAxisParameters.bEncEnableSoftEndMinControl;
stMotionStage.stAxisParametersExposed.fAccelerationMax              := stMotionStage.stAxisParameters.fAccelerationMax;
stMotionStage.stAxisParametersExposed.fCtrlPosDiffMax               := stMotionStage.stAxisParameters.fCtrlPosDiffMax;
stMotionStage.stAxisParametersExposed.fCtrlPosDiffMaxTime           := stMotionStage.stAxisParameters.fCtrlPosDiffMaxTime;
stMotionStage.stAxisParametersExposed.fDecelerationMax              := stMotionStage.stAxisParameters.fDecelerationMax;
stMotionStage.stAxisParametersExposed.fEncSoftEndMax                := stMotionStage.stAxisParameters.fEncSoftEndMax;
stMotionStage.stAxisParametersExposed.fEncSoftEndMin                := stMotionStage.stAxisParameters.fEncSoftEndMin;
stMotionStage.stAxisParametersExposed.fVeloMaximum                  := stMotionStage.stAxisParameters.fVeloMaximum;
stMotionStage.stAxisParametersExposed.fEncOffset                            := stMotionStage.stAxisParameters.fEncOffset;
stMotionStage.stAxisParametersExposed.fEncScaleFactorInternal       := stMotionStage.stAxisParameters.fEncScaleFactorInternal;

bExecParamsRead R= fbMcReadParams.Done OR fbMcReadParams.Error;
stMotionStage.bAxisParamsInit S= fbMcReadParams.Done;
END_METHOD

//FB_Init is always available implicitly and it is used primarily for initialization.
//The return value is not evaluated. For a specific influence, you can also declare the
//methods explicitly and provide additional code there with the standard initialization
//code. You can evaluate the return value.
METHOD FB_Init: BOOL
VAR_INPUT
    bInitRetains: BOOL; // TRUE: the retain variables are initialized (reset warm / reset cold)
    bInCopyCode: BOOL;  // TRUE: the instance will be copied to the copy code afterward (online change)
    stPiezoStage            :       REFERENCE TO ST_MotionStage;
    (*Mandatory must be unique for each MCS2 axis *)
    eModule : E_Module;
END_VAR
THIS^.stMotionStage REF= stPiezoStage;
THIS^.eModule := eModule;
END_METHOD

METHOD Halt : BOOL
fbMcHalt(
    Axis := stMotionStage.Axis,
    Execute := bStop AND bCSPModeEnabled,
    Deceleration := stMotionStage.fDeceleration,
    BufferMode := eBufferMode,
);
END_METHOD

METHOD PUBLIC Home

VAR_INST
    {attribute &#39;hide&#39;}
    bMove                           : BOOL;
END_VAR
CASE eHomeMode OF
    E_EpicsHomeCmd.AUTOZERO:
        bMove S=  bExecHome;
    E_EpicsHomeCmd.NONE:
        bMove := FALSE;
        bHomeBusy :=  bExecHome;
        bHomeDone := NOT  bExecHome;
    ELSE
        bMove := FALSE;
END_CASE

IF bMove THEN
    CASE eHomeState OF
        // Wait for a rising edge
        E_MoveState.IDLING:
            IF bHomeModeEnabled AND bExecHome THEN
                bHomeDone := FALSE;
                bHomeBusy := TRUE;
                stMotionStage.bDone := FALSE;
                stDS402Drive.nDS402DriveControl:=15;
                eHomeState :=  E_MoveState.INIT;
            END_IF
        E_MoveState.INIT:
                        stDS402Drive.nDS402DriveControl.4:=1;
                                        eHomeState := E_MoveState.STARTED;
        E_MoveState.STARTED :
            // this is a comfirmation that routine is ongoing
            IF NOT stDS402Drive.stDS402DriveStatus.TargetReached
                AND NOT stDS402Drive.stDS402DriveStatus.Bit13_OpModeSpecific THEN
                bHomeBusy:=TRUE;
                bHomeDone:=FALSE;

                eHomeState:=E_MoveState.IN_PROGRESS;
            END_IF

        E_MoveState.IN_PROGRESS :

        IF bStop THEN
         stDS402Drive.nDS402DriveControl.8 :=1;
          bHomeAborted := TRUE;
          eHomeState:=E_MoveState.INTERRUPTED;

        // Genral Motion error i.e Following error ?
        ELSIF stDS402Drive.stDS402DriveStatus.Bit13_OpModeSpecific
                OR stDS402Drive.stDS402DriveStatus.WarningCondition THEN
            stMotionStage.bError := TRUE;
            eHomeState:=E_MoveState.ERROR;

        // Reached
        ELSIF stDS402Drive.stDS402DriveStatus.TargetReached
            AND stDS402Drive.stDS402DriveStatus.Bit12_OpModeSpecific
            AND NOT stDS402Drive.stDS402DriveStatus.Bit13_OpModeSpecific THEN
           eHomeState:=E_MoveState.DONE;
        END_IF
        E_MoveState.INTERRUPTED:
            bHomeBusy:=FALSE;
            eHomeState:=E_MoveState.IDLING;
        E_MoveState.DONE:
            bHomeBusy:=FALSE;
            bHomeDone:=TRUE;
            stMotionStage.fPosition:=0.0;

            IF (stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION ) THEN
                stDS402Drive.nDS402DriveControl.4:=FALSE;

            ELSE
                stDS402Drive.nDS402DriveControl:=6;
            END_IF
            eHomeState:=E_MoveState.IDLING;
        E_MoveState.ERROR:
            bHomeDone:=FALSE;
            bHomeBusy:= FALSE;
            IF bWrongParameter THEN
                stMotionStage.sCustomErrorMessage:=&#39;Invalid motion Parameters&#39;;
                bWrongParameter := FALSE;
                stMotionStage.bError := TRUE;
            END_IF
            IF NOT stMotionStage.bError THEN
                eHomeState:=E_MoveState.IDLING;
            END_IF
    END_CASE
END_IF
END_METHOD

METHOD PUBLIC Interlock

VAR_INST
    {attribute &#39;hide&#39;}
    bPositiveDirection  : BOOL;
    {attribute &#39;hide&#39;}
    bNegativeDirection  : BOOL;
    {attribute &#39;hide&#39;}
    ftForwardEnabled        : F_TRIG;

    {attribute &#39;hide&#39;}
    ftBackwardEnabled       : F_TRIG;
END_VAR
// Positive or Negative direction
bPositiveDirection:=stMotionStage.bBusy AND stMotionStage.fPosDiff &gt; 0;
bNegativeDirection:=stMotionStage.bBusy AND stMotionStage.fPosDiff &lt; 0;

// For SmartAct MCS2 these limit are range and enstop limits. however a single bit in the status is used
// bLimOverride  : act as an override after limit was hit to allow reverse movement
stMotionStage.bLimitForwardEnable :=  bLimOverride OR NOT( bPositiveDirection AND stDS402Drive.stDS402DriveStatus.InternalLimitActive );
stMotionStage.bLimitBackwardEnable := bLimOverride OR NOT( bNegativeDirection AND stDS402Drive.stDS402DriveStatus.InternalLimitActive );

// use falling trigger to avoid spaming  sErrorMessage
ftForwardEnabled(CLK:=stMotionStage.bLimitForwardEnable);
ftBackwardEnabled(CLK:=stMotionStage.bLimitBackwardEnable);

IF  NOT bHomeBusy AND ftForwardEnabled.Q THEN
    // Not an error, just a warning
    stMotionStage.sCustomErrorMessage:=&#39;Cannot move past positive limit.&#39;;
    bLimOverride := TRUE;
END_IF

IF NOT bHomeBusy AND ftBackwardEnabled.Q THEN
    // Not an error, just a warning
    stMotionStage.sCustomErrorMessage:=&#39;Cannot move past Negative limit.&#39;;
    bLimOverride := TRUE;
END_IF

IF NOT stMotionStage.bError AND stMotionStage.bExecute AND NOT stMotionStage.bUserEnable THEN
    stMotionStage.bError := TRUE;
    stMotionStage.nErrorId := 1;
    stMotionStage.sCustomErrorMessage := &#39;Move requested, but user enable is disabled!&#39;;
END_IF

// Update all enable booleans
SetEnables();
END_METHOD

(*Switch the drive mod eof Operation
  Servo On: Profil Positioning or HOME
  Servo Off : STEP mode
*)
METHOD ModeOperation

VAR_INST
    tonSwitching : TON;
    bManualTransition: BOOL;
END_VAR
rtCSPModeOk(CLK:=( stDS402Drive.nModeOfOperationDisplay=E_DS402OpMode.CSP));
rtHomeModeEnable(CLK:=( stDS402Drive.nModeOfOperationDisplay=E_DS402OpMode.HOME));
// transition to close loop mode
IF rtCSPModeOk.Q THEN
    bHomeModeEnabled := FALSE;
    bCSPModeEnabled := TRUE;
ELSIF rtHomeModeEnable.Q THEN
    bHomeModeEnabled := TRUE;
    bCSPModeEnabled := FALSE;
    stDS402Drive.nDS402DriveControl := 0;
END_IF

IF rtUserExec.Q AND stMotionStage.bHomeCmd THEN
    IF (stDS402Drive.nModeOfOperationDisplay&lt;&gt;E_DS402OpMode.HOME) THEN
        stDS402Drive.nModeOfOperation := E_DS402OpMode.HOME;
        stDS402Drive.nDS402DriveControl := 128;
        // clear previous operational from switching away from this mode.
        bOperational := FALSE;
        bCSPModeEnabled := FALSE;
        bManualTransition := TRUE;
    ELSE
        bHomeModeEnabled := TRUE;
    END_IF
ELSIF rtUserExec.Q THEN
    IF (stDS402Drive.nModeOfOperationDisplay&lt;&gt;E_DS402OpMode.CSP) THEN
        stDS402Drive.nModeOfOperation := E_DS402OpMode.CSP;
        stDS402Drive.nDS402DriveControl := 128;
        bHomeModeEnabled := FALSE;
        bManualTransition := FALSE;
    ELSE
        bCSPModeEnabled := TRUE;
    END_IF
END_IF

bDS402ManualEnabled :=bHomeModeEnabled;
(*Handle correct startup procedure for manual move*)
StateMachine(Enable:=1);
END_METHOD

METHOD PUBLIC  MoveAbsolute
fbMcMoveAbsolute(
    Axis := stMotionStage.Axis,
    Execute := bCommandMoveAbsolute,
    Position := stMotionStage.fPosition,
    Velocity := stMotionStage.fVelocity,
    Acceleration := stMotionStage.fAcceleration,
    Deceleration := stMotionStage.fDeceleration,
    BufferMode := eBufferMode,
);
END_METHOD

METHOD PersistParameters
VAR_INPUT
    Enable  : BOOL;
END_VAR

VAR_INST
    {attribute &#39;hide&#39;}
    bEncError                       : BOOL;

    {attribute &#39;hide&#39;}
    bRestoreWaitRetry       : BOOL;
END_VAR
// Save Encoder position
// needs some pre-conditions to use persistent storage
IF Enable THEN
    // Check ST_MotionStage for an encoder error (range 0x44nn)
    bEncError:= stMotionStage.Axis.Status.Error AND  ( stMotionStage.Axis.Status.ErrorID  &gt;= 16#4400  AND stMotionStage.Axis.Status.ErrorID &lt;= 16#44FF );
    // Do not save if we&#39;re currently loading or if there is an encoder error
    IF NOT bRestoreLoad AND NOT bEncError AND NOT bRestoreWaitRetry THEN
        fSavedPosition := stMotionStage.Axis.NcToPlc.ActPos;
        // This persistent variable lets us check if anything was saved
        // It will be TRUE at startup if we have saved values
        bSaved := TRUE;
        (*
            use this with a timer of a change threshold on the fActPosition
            to trigger a save from this PLC program. otherwise this will be a spamming
            persistence, filling up the disk.
        *)
        //iPersistentDataStorage.TriggerWriteOfPersistentData := bSaveEnabled;
    END_IF
END_IF
END_METHOD

{attribute &#39;call_after_init&#39;}
(*  eModule: Mandatory must be unique for each MCS2 axis
    clears startup errors or warnings. the process is completed at run time
    SDO update of Drive and open Loop parameter Indexes based on module number
*)
METHOD PostInit
VAR_INPUT
END_VAR
(* SDO update of Drive and open Loop parameter Indexes based on module number*)
nChanErrorCodeIdx   := nErrorCodeBase               + ((eModule-1) * nChanOfsBase);
nChanSoftLimitIdx   := nChanSoftLimitBase   + ((eModule-1) * nChanOfsBase);
bInit := TRUE;
END_METHOD

METHOD Power : BOOL
fbMcPower(
    Axis := stMotionStage.Axis,
    Enable := stMotionStage.bAllEnable AND bCSPModeEnabled,
    Enable_Positive := stMotionStage.bAllForwardEnable,
    Enable_Negative := stMotionStage.bAllBackwardEnable,
    Override := 100.0,
    BufferMode := eBufferMode );
END_METHOD

(* Read Drive error codes after a motion or fault condition occured *)
METHOD ReadDriveCodes : BOOL
VAR_INST
    {attribute &#39;hide&#39;}
    fbErrorRead                     : FB_EcCoESdoRead;
    {attribute &#39;hide&#39;}
    nPiezoErrorCode         : UDINT;
    {attribute &#39;hide&#39;}
    fbLogError              : FB_LogMotionError;
    {attribute &#39;hide&#39;}
    ftErrorReadDone         : F_TRIG;
END_VAR
fbErrorRead( sNetId:= THIS^.stMotionStage.stAxisParameters.sAmsNetId,
             nSlaveAddr:=stDS402Drive.nSlaveAddr,
             nIndex:=nChanErrorCodeIdx,
             nSubIndex :=nSubIndex,
             pDstBuf:= ADR(nPiezoErrorCode),
             cbBufLen:=SIZEOF(nPiezoErrorCode),
             bExecute:= stMotionStage.bError );

ftErrorReadDone(CLK:=fbErrorRead.bBusy);
IF ftErrorReadDone.Q THEN
    IF      NOT fbErrorRead.bError AND nPiezoErrorCode &lt;&gt; 0 THEN
        stMotionStage.nErrorId := nPiezoErrorCode;
    END_IF
    stMotionStage.sErrorMessage := F_MotionErrorCodeLookup(nErrorId:=stMotionStage.nErrorId);
    fbLogError( stMotionStage:=stMotionStage, bEnable:=stMotionStage.bError);
END_IF
END_METHOD

METHOD Reset : BOOL
fbMcReset(
    Axis := stMotionStage.Axis,
    Execute := bLocalReset AND bCSPModeEnabled
);

IF fbMcReset.Done OR fbMcReset.Error THEN
    bLocalReset := FALSE;
END_IF
END_METHOD

METHOD RestoreMotionParams
VAR_INPUT
    Enable  : BOOL;
END_VAR

VAR_INST
    {attribute &#39;hide&#39;}
    fbSetPos                        : MC_SetPosition;
    {attribute &#39;hide&#39;}
    bLoad                           : BOOL;
    {attribute &#39;hide&#39;}
    bRestoreDone            : BOOL;
    {attribute &#39;hide&#39;}
    bRestoreInit            : BOOL;
    {attribute &#39;hide&#39;}
    bRestoreWaitRetry       : BOOL;
    {attribute &#39;hide&#39;}
    nMaxRetries                     : UINT := 10;
    {attribute &#39;hide&#39;}
    nCurrTries                      : UINT := 0;
    {attribute &#39;hide&#39;}
    nLatchError                     : UDINT;
END_VAR
IF Enable THEN
    // Trigger a load if anything was saved at all
    IF NOT bRestoreInit THEN
        bRestoreInit := TRUE;
        bRestoreLoad S= bSaved;
        fbSetPos.Options.ClearPositionLag := TRUE;
    END_IF

    // Set our position if bRestoreLoad is true
    fbSetPos( Axis:=stMotionStage.Axis, Execute:=bRestoreLoad, Position:=fSavedPosition);

    // Only load once, at startup
    bRestoreLoad R= fbSetPos.Done OR fbSetPos.Error;

    IF fbSetPos.Error THEN
        // Keep the error latched, it can disappear if Execute is set to FALSE
        nLatchError := fbSetPos.ErrorID;
        nCurrTries := nCurrTries + 1;
        IF nCurrTries &gt;= nMaxRetries THEN
        // Alert the user that something has gone wrong
        stMotionStage.bError := TRUE;
        stMotionStage.nErrorId := nLatchError;
        stMotionStage.sCustomErrorMessage := &#39;Error loading previously saved position.&#39;;
        ELSE
            // Reset the FB for the next retry
            fbSetPos( Axis:=stMotionStage.Axis, Execute:=bRestoreLoad, Position:=fSavedPosition);
            // Try again
            bRestoreWaitRetry := TRUE;
        END_IF
    ELSE
        IF NOT bRestoreDone THEN
            stMotionStage.fPosition := fSavedPosition;
        END_IF
        bRestoreDone := TRUE;
    END_IF

    tonRestoreRetry( IN := bRestoreWaitRetry, PT := T#100MS);
    bRestoreLoad S= tonRestoreRetry.Q;
    bRestoreWaitRetry R= tonRestoreRetry.Q;
END_IF
END_METHOD

METHOD ScaleDriveParams
nSoftLimMax := LREAL_TO_DINT((stMotionStage.stAxisParameters.fEncSoftEndMax / MAX(stMotionStage.stAxisParameters.fEncScaleFactorInternal, fScalingFactor)));
nSoftLimMin := LREAL_TO_DINT((stMotionStage.stAxisParameters.fEncSoftEndMin / MAX(stMotionStage.stAxisParameters.fEncScaleFactorInternal, fScalingFactor)));
END_METHOD

METHOD ScaleEncRawValue
VAR_INPUT
  //  bEnable: BOOL;
END_VAR
(* SmartACT: The encoder count from the Piezo drive is not a raw count from the embeded actuator device
   we get a calibrated nm value. thus the use of abs() since this value is signed.
   PI: to be discovered *)
IF stMotionStage.nRawEncoderDINT &lt;&gt; 0 THEN
    stMotionStage.nEncoderCount:=DINT_TO_UDINT(ABS(stMotionStage.nRawEncoderDINT));
ELSE
    stMotionStage.nEncoderCount:=0;
END_IF

// calibrated encoder readback
fMeasuredPos:=stMotionStage.Axis.NcToPlc.ActPos;
fMeasuredVelo :=stMotionStage.Axis.NcToPlc.ActVelo;
fMeasuredAcc := stMotionStage.Axis.NcToPlc.ActAcc;
stMotionStage.fPosDiff:=stMotionStage.Axis.NcToPlc.PosDiff;
END_METHOD

(*Scale Home Move parameters*)
METHOD ScaleHomeMotionParams

END_METHOD

(*Scaled Open Loop Step mode motion parameters*)
METHOD ScaleServoOffMotionParams
VAR_INPUT
END_VAR

END_METHOD

METHOD SetEnables
VAR_INPUT
END_VAR
stMotionStage.bAllForwardEnable:=stMotionStage.bLimitForwardEnable AND (stMotionStage.bGantryForwardEnable OR NOT stMotionStage.bGantryAxis) AND stMotionStage.stEPSForwardEnable.bEPS_OK;
stMotionStage.bAllBackwardEnable:=stMotionStage.bLimitBackwardEnable AND (stMotionStage.bGantryBackwardEnable OR NOT stMotionStage.bGantryAxis) AND stMotionStage.stEPSBackwardEnable.bEPS_OK;

stMotionStage.bAllEnable:=stMotionStage.bEnable AND stMotionStage.bHardwareEnable AND stMotionStage.stEPSPowerEnable.bEPS_OK;
stMotionStage.bAllEnable R= NOT stMotionStage.bUserEnable;
END_METHOD

METHOD StateMachine
VAR_INPUT
    Enable : BOOL;
END_VAR

VAR_INST
    rtFault: R_TRIG;
    {attribute &#39;hide&#39;}
    bFault                          : BOOL;
END_VAR
rtFault(CLK:=bFault);
(*switch on disable*)
IF NOT stDS402Drive.stDS402DriveStatus.ReadyToSwitchOn
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchedOn
    AND NOT stDS402Drive.stDS402DriveStatus.OperationEnabled
    AND NOT stDS402Drive.stDS402DriveStatus.Fault
    AND stDS402Drive.stDS402DriveStatus.VoltageEnabled
    AND NOT stDS402Drive.stDS402DriveStatus.QuickStopActive
    AND  stDS402Drive.stDS402DriveStatus.SwitchOnDisabled THEN
        bOperational := FALSE;
        IF bDS402ManualEnabled AND NOT bStop  THEN
            THIS^.stDS402Drive.nDS402DriveControl := 6;
        END_IF
(*Ready to switch*)
ELSIF stDS402Drive.stDS402DriveStatus.ReadyToSwitchOn
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchedOn
    AND NOT stDS402Drive.stDS402DriveStatus.OperationEnabled
    AND NOT stDS402Drive.stDS402DriveStatus.Fault
    AND stDS402Drive.stDS402DriveStatus.VoltageEnabled
    AND stDS402Drive.stDS402DriveStatus.QuickStopActive
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchOnDisabled THEN
        bFault := FALSE;
        bOperational := FALSE;
        IF bDS402ManualEnabled AND NOT bStop  THEN
            THIS^.stDS402Drive.nDS402DriveControl := 7;
        END_IF
(*Switch on*)
ELSIF stDS402Drive.stDS402DriveStatus.ReadyToSwitchOn
    AND  stDS402Drive.stDS402DriveStatus.SwitchedOn
    AND NOT stDS402Drive.stDS402DriveStatus.OperationEnabled
    AND NOT stDS402Drive.stDS402DriveStatus.Fault
    AND stDS402Drive.stDS402DriveStatus.VoltageEnabled
    AND stDS402Drive.stDS402DriveStatus.QuickStopActive
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchOnDisabled THEN
        bOperational := FALSE;
        IF bDS402ManualEnabled AND NOT bStop  THEN
            THIS^.stDS402Drive.nDS402DriveControl := 15;
        END_IF
(*Operation enbaled*)
ELSIF stDS402Drive.stDS402DriveStatus.ReadyToSwitchOn
    AND stDS402Drive.stDS402DriveStatus.SwitchedOn
    AND stDS402Drive.stDS402DriveStatus.OperationEnabled
    AND NOT stDS402Drive.stDS402DriveStatus.Fault
    AND stDS402Drive.stDS402DriveStatus.VoltageEnabled
    AND stDS402Drive.stDS402DriveStatus.QuickStopActive
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchOnDisabled THEN
        THIS^.bOperational := TRUE;
(*Fault*)
ELSIF  NOT stDS402Drive.stDS402DriveStatus.ReadyToSwitchOn
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchedOn
    AND NOT stDS402Drive.stDS402DriveStatus.OperationEnabled
    AND stDS402Drive.stDS402DriveStatus.Fault
    AND stDS402Drive.stDS402DriveStatus.VoltageEnabled
    AND NOT stDS402Drive.stDS402DriveStatus.QuickStopActive
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchOnDisabled THEN
        bOperational := FALSE;
        bFault := TRUE;

ELSE
    bFault := FALSE;
    bOperational := FALSE;
END_IF

// wait for parameter init done at startup to read potential error from drive
stMotionStage.bError := bFault AND stMotionStage.bAxisParamsInit;
END_METHOD

{warning &#39;Add method implementation &#39;}
METHOD StepMove
VAR_INPUT
    Enable  : BOOL;
END_VAR

END_METHOD

(*  Drive parameters update
    Mirror NC axis parameters configurations to those of MCS2 drive
    1- Following error
    2- Home Speeds
    3- Home Acceleration
    4- SoftLimits
*)
METHOD UpdateDriveMonitoringParams
VAR_INPUT
    Enable : BOOL;
END_VAR

VAR_INST
    {attribute &#39;hide&#39;}
    fbSetFErrorWin          : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetSoftLimMin         : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetSoftLimMax         : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetHomeOffs           : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetHomeVeloFast       : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetHomeVeloSlow       : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetHomeAcc            : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    nRecentSoftLimMax       : LINT;
    {attribute &#39;hide&#39;}
    nRecentSoftLimMin       : LINT;
    {attribute &#39;hide&#39;}
    nRecentHomeVeloFast : UDINT;
    {attribute &#39;hide&#39;}
    nRecentHomeVeloSlow : UDINT;
    {attribute &#39;hide&#39;}
    nRecentHomeAcc          : UDINT;
    {attribute &#39;hide&#39;}
    nRecentFErrWin          : DINT;
    {attribute &#39;hide&#39;}
    nRecentHomeOffset       : DINT;
    {attribute &#39;hide&#39;}
    nHomeOffs                       : DINT;
    {attribute &#39;hide&#39;}
    ftFErrWinSetDone        : F_TRIG;

    {attribute &#39;hide&#39;}
    ftSoftLimMaxSetDone     : F_TRIG;
    {attribute &#39;hide&#39;}
    ftSoftLimMinSetDone     : F_TRIG;
    {attribute &#39;hide&#39;}
    ftHomeVeloFastSetDone: F_TRIG;
    {attribute &#39;hide&#39;}
    ftHomeAccSetDone        : F_TRIG;
    {attribute &#39;hide&#39;}
    ftHomeOffsSetDone       : F_TRIG;
    {attribute &#39;hide&#39;}
    ftHomeVeloSlowSetDone: F_TRIG;
END_VAR
IF Enable THEN

    (*      Drive parameters update
        Mirror NC axis parameters configurations to those of MCS2 drive
        1- Following error.
        2- SoftLimits
        3-Position Range
    *)
  // add some safety here for  0 div.
  ScaleDriveParams();

  fbSetSoftLimMin(
    sNetId     := THIS^.stMotionStage.stAxisParameters.sAmsNetId,
    nSlaveAddr := stDS402Drive.nSlaveAddr,
    nIndex     := nChanSoftLimitIdx,
    nSubIndex  := 1,
    pSrcBuf    := ADR(nSoftLimMin),
    cbBufLen   := SIZEOF(nSoftLimMin),
    bExecute   := NOT stMotionStage.bBusy AND (nSoftLimMin &lt;&gt; nRecentSoftLimMin)
  );
  fbSetSoftLimMax(
    sNetId     := THIS^.stMotionStage.stAxisParameters.sAmsNetId,
    nSlaveAddr := stDS402Drive.nSlaveAddr,
    nIndex     := nChanSoftLimitIdx,
    nSubIndex  := 2,
    pSrcBuf    := ADR(nSoftLimMax),
    cbBufLen   := SIZEOF(nSoftLimMax),
    bExecute   := NOT stMotionStage.bBusy AND (nSoftLimMax &lt;&gt; nRecentSoftLimMax)
    );

  ftSoftLimMaxSetDone(CLK:=fbSetSoftLimMax.bBusy);
  ftSoftLimMinSetDone(CLK:=fbSetSoftLimMin.bBusy);

    IF ftSoftLimMaxSetDone.Q OR ftSoftLimMinSetDone.Q  THEN
        IF fbSetSoftLimMin.bError THEN
           stMotionStage.bError := fbSetSoftLimMin.bError;
           stMotionStage.nErrorId := fbSetSoftLimMin.nErrId;
        ELSIF fbSetSoftLimMax.bError THEN
           stMotionStage.bError := fbSetSoftLimMax.bError;
           stMotionStage.nErrorId := fbSetSoftLimMax.nErrId;
        ELSE
           nRecentSoftLimMax := nSoftLimMax;
           nRecentSoftLimMin := nSoftLimMin;
        END_IF
        fbSetSoftLimMin.bExecute := FALSE;
        fbSetSoftLimMax.bExecute := FALSE;
    END_IF
END_IF
END_METHOD

METHOD UpdateEpicsStatus
VAR_INPUT
END_VAR
//////////////////////////////////////////////////////////////////
// Transfer NC parameter status to EPICS
//////////////////////////////////////////////////////////////////
stMotionStage.stAxisStatus.bEnable:=stMotionStage.bAllEnable;
stMotionStage.stAxisStatus.bEnabled:=stMotionStage.bEnableDone; // account for PowerEnable from power block
stMotionStage.stAxisStatus.bError:=stMotionStage.bError;
stMotionStage.stAxisStatus.bHomeSensor:=stMotionStage.bHome;
stMotionStage.stAxisStatus.bLimitBwd:=stMotionStage.bAllBackwardEnable;
stMotionStage.stAxisStatus.bLimitFwd:=stMotionStage.bAllForwardEnable;
stMotionStage.stAxisStatus.bReset:=stMotionStage.bReset;
stMotionStage.stAxisStatus.fAcceleration:=fMeasuredAcc;
stMotionStage.stAxisStatus.fActDiff:=stMotionStage.fPosDiff;
stMotionStage.stAxisStatus.fActPosition:=fMeasuredPos;
stMotionStage.stAxisStatus.fActVelocity:=fMeasuredVelo;
stMotionStage.stAxisStatus.fDeceleration:=fMeasuredAcc;
stMotionStage.stAxisStatus.fOverride:=THIS^.fbMcPower.Override;
stMotionStage.stAxisStatus.fPosition:=stMotionStage.fPosition;
stMotionStage.stAxisStatus.fVelocity:=stMotionStage.fVelocity;
stMotionStage.stAxisStatus.nCmdData:=INT_TO_UINT(stMotionStage.nCmdData);  //Or nCmdDataLocal
stMotionStage.stAxisStatus.nCommand:=INT_TO_UINT(stMotionStage.nCommand);  //Or nCommandLocal
stMotionStage.stAxisStatus.nErrorId:=stMotionStage.nErrorId;
stMotionStage.stAxisStatus.bBusy:=stMotionStage.bBusy;
stMotionStage.stAxisStatus.bHomed:=stMotionStage.bHomed;
stMotionStage.stAxisStatus.bExecute:=bLocalExec;
stMotionStage.stAxisStatus.nCommand:=3; // If this is not 3, the IOC stops updating positions during homing
END_METHOD

(*  MCS2 OL Step parameters update
    1- Step
    2- Step Amplitude
    3- StepFreq
*)
METHOD UpdateServoOffMotionParams
VAR_INPUT
    Enable : BOOL;
END_VAR

END_METHOD

METHOD WriteParameterNC
VAR_INPUT
    Execute:BOOL;
    ParameterNumber : MC_AxisParameter;
    ParameterValue  : LREAL;
END_VAR
(*Do not change a moving axis parameter*)
fbMcWriteParameter( Axis:=stMotionStage.Axis,
                    Execute:=(Execute AND stMotionStage.Axis.Status.NotMoving),
                    ParameterNumber:=ParameterNumber,
                    Value:=ParameterValue
                  );

// Reset execute after when done successfull or after abort reset
// this way the done and error condition is latched till next move or global reset.
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-ds402opmode">E_DS402OpMode</a></p></li>
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></p></li>
<li><p><a class="reference internal" href="#e-module">E_Module</a></p></li>
<li><p><a class="reference internal" href="#e-movestate">E_MoveState</a></p></li>
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#fb-logmotionerror">FB_LogMotionError</a></p></li>
<li><p><a class="reference internal" href="#f-motionerrorcodelookup">F_MotionErrorCodeLookup</a></p></li>
<li><p><a class="reference internal" href="#st-ds402drive">ST_DS402Drive</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionstagemcs2csp">
<h2>FB_MotionStageMCS2CSP<a class="headerlink" href="#fb-motionstagemcs2csp" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*  MCS2 Motion Stage . Controller a stage in CSP (NC), STEP_MODE and Homing via DS402 interface
     Using an overriden Position Holding timer. power enable mode must be &#39;DURING_MOTION&#39;. for close loop aka CSP control
    set bServo PV to true, fort open loop step mode bServo must be cleared
*)
{attribute &#39;call_after_init&#39;}
FUNCTION_BLOCK FB_MotionStageMCS2CSP IMPLEMENTS I_DS402GenericDrive
VAR
    {attribute &#39;no_copy&#39;}
    stMotionStage  : REFERENCE TO ST_MotionStage;
    // Hardware I/O
    stDS402Drive            : ST_DS402Drive;
    // Must be Provided
    {attribute &#39;hide&#39;}
    eModule                         : E_Module;
    {attribute &#39;hide&#39;}
    eHomeMode                       : E_EpicsHomeCmd :=E_EpicsHomeCmd.AUTOZERO;
    {attribute &#39;hide&#39;}
    eBufferMode             : MC_BufferMode := MC_BufferMode.MC_Aborting;
    {attribute &#39;hide&#39;}
    eMotionState            : E_MoveState;
    {attribute &#39;hide&#39;}
    eHomeState              : E_MoveState;
    {attribute &#39;hide&#39;}
    fbMcPower                       : MC_Power;
    {attribute &#39;hide&#39;}
    fbMcMoveAbsolute        : MC_MoveAbsolute;
    {attribute &#39;hide&#39;}
    fbMcHalt                        : MC_Halt;
    {attribute &#39;hide&#39;}
    fbMcReset                       : MC_Reset;
    {attribute &#39;hide&#39;}
    fbMcWriteParameter      : MC_WriteParameter;
    {attribute &#39;hide&#39;}
    fbMcReadParams          : MC_ReadParameterSet;
    // MCS2 OL PVs
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:nChanStep
        io: io
        field: DESC SmartAct: Open Loop Step Count
    &#39;}
    nChanStep : DINT := 500;

    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:nChanStepEgu
        io: io
        field: DESC SmartAct: Open Loop Step scale factor
    &#39;}
    nChanStepEgu: LREAL := 827.15;

    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:nChanStepFreq
        io: io
        field: DESC SmartAct: Open Loop Step Freq
    &#39;}
    nChanStepFreq : UINT := 500;

    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:nChanStepAmp
        io: io
        field: DESC SmartAct: Open Loop Step Amp
    &#39;}
    nChanStepAmp  : UINT := 50;
    // timeout for holding actual position ~ 30s
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:nHoldTime
        io: io
        field: DESC SmartAct: Set servo mode hold time
    &#39;}
    nHoldTime : UDINT := 30000;
    // Switch between closed and open loop operation
    {attribute &#39;pytmc&#39; := &#39;
        pv: PLC:bServo
        io: io
        field: ZNAM DISABLE
        field: ONAM ENABLE
        field: DESC Used to disable close loop mode
    &#39;}
    bServo                          : BOOL := TRUE;
   {attribute &#39;hide&#39;}
    bLastHoltTimeOut : BOOL;
   {attribute &#39;hide&#39;}
    bEnPosLag                       : BOOL;
    {attribute &#39;hide&#39;}
    bWrongParameter         : BOOL;
    {attribute &#39;hide&#39;}
    bExecMove                       : BOOL;
    {attribute &#39;hide&#39;}
    bExecHome                       : BOOL;
    {attribute &#39;hide&#39;}
    bNewMoveReq             : BOOL;
    {attribute &#39;hide&#39;}
    bHomeBusy                       : BOOL;
    {attribute &#39;hide&#39;}
    bPrepareDisable         : BOOL;
    {attribute &#39;hide&#39;}
    bStepMoveDone           : BOOL;
    {attribute &#39;hide&#39;}
    bStepMoveBusy           : BOOL;
    {attribute &#39;hide&#39;}
    bStop                           : BOOL;
    {attribute &#39;hide&#39;}
    bOperational            : BOOL;
    {attribute &#39;hide&#39;}
    bLimOverride            : BOOL;
    {attribute &#39;hide&#39;}
    bPositionHold           : BOOL;
    // use this for motion time axis states
    {attribute &#39;hide&#39;}
    bLocalExec                      : BOOL;
    // Save abd restore encoder value
    {attribute &#39;hide&#39;}
    bInit                           : BOOL;
    {attribute &#39;hide&#39;}
    bHomeDone                       : BOOL;
    {attribute &#39;hide&#39;}
    bStepModeEnabled        : BOOL;
    {attribute &#39;hide&#39;}
    bHomeModeEnabled        : BOOL;
    {attribute &#39;hide&#39;}
    bCSPModeEnabled         : BOOL;
    {attribute &#39;hide&#39;}
    bSteModeEnable          : BOOL;
    {attribute &#39;hide&#39;}
    bRestoreLoad            : BOOL;
   {attribute &#39;hide&#39;}
    bStepModeparamsSetDone  : BOOL;
    {attribute &#39;hide&#39;}
    bExecParamsRead                 : BOOL;
    {attribute &#39;hide&#39;}
    bCommandMoveAbsolute    : BOOL;
    {attribute &#39;hide&#39;}
    bRecentEnPosLagStatus   : BOOL;
    {attribute &#39;hide&#39;}
    bDS402ManualAborted : BOOL;
    {attribute &#39;hide&#39;}
    bStepMoveAborted : BOOL;
    {attribute &#39;hide&#39;}
    bHomeAborted : BOOL;
    {attribute &#39;hide&#39;}
    bDS402ManualEnabled : BOOL;
    {attribute &#39;hide&#39;}
    fScalededSteps          : LREAL;
    {attribute &#39;hide&#39;}
    fMeasuredVelo           : LREAL;
    {attribute &#39;hide&#39;}
    fMeasuredAcc            : LREAL;
    {attribute &#39;hide&#39;}
    fScalingFactor          : LREAL:= 0.000001;
   {attribute &#39;hide&#39;}
    fHomeAcc                        : LREAL := 0.8;
    fParameterValue : LREAL;
    {attribute &#39;hide&#39;}
    fMeasuredPos            : LREAL;
    {attribute &#39;hide&#39;}
    nScalededStepAmp        : UINT;
    {attribute &#39;hide&#39;}
    nScaledStepFreq         : UINT;
    {attribute &#39;hide&#39;}
    nHomeVeloFast           : UDINT;
    {attribute &#39;hide&#39;}
    nSoftLimMin             : LINT;
    {attribute &#39;hide&#39;}
    nSoftLimMax             : LINT;
    {attribute &#39;hide&#39;}
    nHomeVeloSlow           : UDINT;
    {attribute &#39;hide&#39;}
    nHomeAcc                        : UDINT;
    {attribute &#39;hide&#39;}
    {attribute &#39;hide&#39;}
    nScaledFErrWin          : DINT;
    {attribute &#39;hide&#39;}
    nHomeOffset             : DINT;
    {attribute &#39;hide&#39;}
    nScalededSteps          : DINT;
    {attribute &#39;hide&#39;}
    tonSyncHoming           : TON;
    {attribute &#39;hide&#39;}
    tonHoldTime             : TON;
    {attribute &#39;hide&#39;}
    tonSlowParamReadTimer: TON;
    {attribute &#39;hide&#39;}
    NCParamsTimer           : TON;
    {attribute &#39;hide&#39;}
    tonRestoreRetry         : TON;
    {attribute &#39;hide&#39;}
    rtAborted                       : R_TRIG;
    {attribute &#39;hide&#39;}
    rtStepMoveDone          : R_TRIG;
    {attribute &#39;hide&#39;}
    rtStopDone                      : R_TRIG;
    {attribute &#39;hide&#39;}
    rtExec                          : R_TRIG;
    {attribute &#39;hide&#39;}
    rtMoveCmdShortcut       : R_TRIG;
    {attribute &#39;hide&#39;}
    rtHomeCmdShortcut       : R_TRIG;
    {attribute &#39;hide&#39;}
    rtEnableMode            : R_TRIG;
    {attribute &#39;hide&#39;}
    rtUserExec              : R_TRIG;
    {attribute &#39;hide&#39;}
    rtModeChange            : R_TRIG;
    {attribute &#39;hide&#39;}
    rtMoveDone              : R_TRIG;
    {attribute &#39;hide&#39;}
    {attribute &#39;hide&#39;}
    rtNewMoveReq            : R_TRIG;
    {attribute &#39;hide&#39;}
    ftExec                  : F_TRIG;

    {attribute &#39;hide&#39;}
    rtHomeDone                      : R_TRIG;
    {attribute &#39;hide&#39;}
    rtCSPModeOk                     : R_TRIG;
    {attribute &#39;hide&#39;}
    rtHomeModeEnable        : R_TRIG;
    {attribute &#39;hide&#39;}
    rtStepModeEnabled       : R_TRIG;
    {attribute &#39;hide&#39;}
    rtNewServoMove          : R_TRIG;
    {attribute &#39;hide&#39;}
    rtStepMove                      : R_TRIG;
    {attribute &#39;hide&#39;}
    nSubIndex                       : BYTE := 0;
    {attribute &#39;hide&#39;}
    nChanFErrWinIdx         : WORD;
    {attribute &#39;hide&#39;}
    nChanSoftwareLimIdx : WORD;
    {attribute &#39;hide&#39;}
    nChanMotorLoadIdx       : WORD;
    {attribute &#39;hide&#39;}
    nChanErrorCodeIdx       : WORD;
    {attribute &#39;hide&#39;}
    nChanStepIdx            : WORD;
    {attribute &#39;hide&#39;}
    nChanStepFreqIdx        : WORD;
    {attribute &#39;hide&#39;}
    nChanStepAmpIdx         : WORD;
    {attribute &#39;hide&#39;}
    nChanSoftLimitIdx       : WORD;
    {attribute &#39;hide&#39;}
    nChanHomeOffsIdx        : WORD;
    {attribute &#39;hide&#39;}
    nChanHomeVeloIdx        : WORD;
    {attribute &#39;hide&#39;}
    nChanhomeAccIdx         : WORD;
    {attribute &#39;hide&#39;}
    bLocalReset: BOOL;
    {attribute &#39;hide&#39;}
    nCommandLocal: INT := 3;
    {attribute &#39;hide&#39;}
    nCmdDataLocal: INT;
   {attribute &#39;hide&#39;}
    bManualTransition: BOOL;
END_VAR

VAR CONSTANT
    {attribute &#39;hide&#39;}
    nChanSoftLimitBase      : WORD := 16#200E;
    {attribute &#39;hide&#39;}
    nHomeOffsetBase         : WORD := 16#607C;
    {attribute &#39;hide&#39;}
    nHomingSpeedBase        : WORD := 16#6099;
    {attribute &#39;hide&#39;}
    nhomingAccBase          : WORD := 16#609A;
    {attribute &#39;hide&#39;}
    nErrorCodeBase          : WORD := 16#603F;
    {attribute &#39;hide&#39;}
    nFErrWinBase            : WORD := 16#6065;
    // this true for SmartAct MCS2 and E-727.
    {attribute &#39;hide&#39;}
    nChanOfsBase            :  WORD := 16#800;
    // DS 402 Motor encoder defective code : this is needed for save and restore.
    {attribute &#39;hide&#39;}
    nEncErrorCode           : WORD := 16#7300;
    {attribute &#39;hide&#39;}
    nSoftLimBase            : WORD := 16#200E;
    {attribute &#39;hide&#39;}
    nOlStepBase             : WORD := 16#2022;
    {attribute &#39;hide&#39;}
    nOlStepAmpBase          : WORD := 16#2023;
    {attribute &#39;hide&#39;}
    nOlStepFreqBase         : WORD := 16#2024;
END_VAR

VAR PERSISTENT
    bSaved  : BOOL;
    fSavedPosition  : LREAL;
END_VAR
IF NOT __ISVALIDREF(stMotionStage) THEN
    RETURN;
END_IF

(* Done once after init*)
IF bInit THEN
    stMotionStage.nMotionAxisID := stMotionStage.Axis.NcToPlc.AxisId;
    (* Clear drive error/wraning condition, in open loop mode
       this will trigger a correct startup for procedure *)
    stDS402Drive.nDS402DriveControl := 128;
    // fist cycle reading of NC paramters
    bExecParamsRead := TRUE;
    bInit := FALSE;
END_IF
(* Check for the plc shortcut commands
   Used for testing or to circumvent motor record issues*)
rtMoveCmdShortcut(CLK:=stMotionStage.bMoveCmd);
rtHomeCmdShortcut(CLK:=stMotionStage.bHomeCmd);

(* Execute on rising edge*)
IF rtMoveCmdShortcut.Q AND NOT stMotionStage.bExecute THEN
    stMotionStage.bExecute:=TRUE;
    stMotionStage.nCommand := E_EpicsMotorCmd.MOVE_ABSOLUTE;
    bEnPosLag := bRecentEnPosLagStatus;
    fParameterValue := BOOL_TO_LREAL(bRecentEnPosLagStatus);

ELSIF rtHomeCmdShortcut.Q AND NOT stMotionStage.bExecute THEN
    stMotionStage.bExecute:= NOT ( stMotionStage.nCmdData=E_EpicsHomeCmd.ABSOLUTE_SET )
                            OR NOT ( stMotionStage.nCmdData=E_EpicsHomeCmd.NONE);
    stMotionStage.nCommand:=E_EpicsMotorCmd.HOME;
    (* Automatically fill the correct nCmdData for homing*)
    stMotionStage.nCmdData:=stMotionStage.nHomingMode;
    (*      Positional lag is not evaluated by E727 during homing, but NC does evaluated
        the condition which will lead to error as the lag is significant during homing
        disable the NC lag check and reenable it after homing is done
    *)
    IF stMotionStage.stAxisParameters.bCtrlEnablePosDiffControl.0 THEN
        bRecentEnPosLagStatus := stMotionStage.stAxisParameters.bCtrlEnablePosDiffControl.0;
        bEnPosLag := TRUE;
        fParameterValue := 0;
    END_IF

END_IF

(* entry point for local and EPICS main execs *)
rtUserExec(CLK:=stMotionStage.bExecute);
(* if a Move/Home Goal is comfirmed and there is no persistant
   error conditions, then we have a valid move request.*)
bNewMoveReq S= NOT stMotionStage.bBusy AND rtUserExec.Q AND NOT stMotionStage.bError;
(* this Move request is valid till an error occurs or the currently move is done *)
bNewMoveReq R= NOT stMotionStage.bExecute OR stMotionStage.bError;
bPrepareDisable R= bNewMoveReq;
rtNewMoveReq(CLK:=bNewMoveReq);
(* Moves are automatically allowed if no safety hooks.
   Otherwise, some other code will set this.*)
stMotionStage.bSafetyReady S= stMotionStage.bPowerSelf;
(* Set the proper command for the request move;
   if bservo not set, manual step moves will be performed *)
IF rtUserExec.Q THEN
    // Transfer nCommand and nCmdData to local copies at rising edge of bExecute (avoid issues if nCommand or nCmdData are changed during a command)
    nCmdDataLocal:=stMotionStage.nCmdData;
    nCommandLocal:=stMotionStage.nCommand;
    IF NOT stMotionStage.bHomeCmd THEN
        IF NOT bServo THEN
            (* Open Loop Step Mode *)
            stMotionStage.nCommand:=E_EpicsMotorCmd.JOG;
            nCommandLocal := E_EpicsMotorCmd.JOG;
        END_IF

        (* attempting to move an axis without homing first? *)
        IF stMotionStage.nHomingMode &lt;&gt; E_EpicsHomeCmd.NONE AND NOT stMotionStage.bHomed THEN
            (* one can just set bHome here even though no homing was done?*)
            stMotionStage.sErrorMessage:=&#39;Axis homing mode set, but homing routine pending&#39;;
        END_IF
    END_IF
END_IF

(* Set the drive in the correct operating mode. based on requested move command!
    NB: bservo must set for close loop motion
*)
ModeOperation();

(* NB: This is the only tested mode of operation so far. also aligned
    piezo drive position holding feature
*)
rtEnableMode(CLK:=(stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION));
(* Handle auto-enable timing *)
CASE stMotionStage.nEnableMode OF
    (* Not recommended, not tested *)
    E_StageEnableMode.ALWAYS:
        stMotionStage.bEnable:=FALSE;
    E_StageEnableMode.DURING_MOTION:
        IF rtEnableMode.Q THEN
            stMotionStage.bEnable := FALSE;
        END_IF
        IF rtNewMoveReq.Q THEN
            (* override ongoing holding.*)
            bPositionHold := FALSE;
            tonHoldTime.IN:=FALSE;
            (*MC block are not compatible with open loop Motion
                thus we wathc for correct close loop modes to use NC features *)
            stMotionStage.bEnable S= stMotionStage.bSafetyReady;
            bLastHoltTimeOut := FALSE;
            bStop:=FALSE;
        END_IF
END_CASE
(*  Interlock mainly react on internal limit conditions inthe ove direction.
    MCS2 drive will go into error state when an internal limit is hit *)
Interlock();

IF bCSPModeEnabled THEN
    (*CSP using TwinCAT NC*)
    bLocalExec:= NOT stMotionStage.bError AND stMotionStage.bExecute AND stMotionStage.bAllEnable AND stMotionStage.bEnableDone AND stMotionStage.bSafetyReady AND bServo;
ELSIF bHomeModeEnabled THEN
    bLocalExec:= NOT stMotionStage.bError AND stMotionStage.bExecute AND stMotionStage.bAllEnable AND  bOperational AND  stMotionStage.bSafetyReady;
ELSIF bStepModeEnabled THEN
    (*Manual, i.e Homing using DS402*)
    bLocalExec:= NOT stMotionStage.bError AND stMotionStage.bExecute AND stMotionStage.bAllEnable AND  bOperational AND  stMotionStage.bSafetyReady AND NOT bServo;
ELSE
    bLocalExec:= FALSE;
END_IF
bExecHome:=bLocalExec AND stMotionStage.nCommand = 10;
bExecMove:=bLocalExec AND NOT bExecHome;

(* When we start, set the busy/done appropriately
   NB: CLose loop control using NC *)
rtExec(CLK:=bLocalExec);
IF rtExec.Q THEN
    // Release previous interruption if any
    stDS402Drive.nDS402DriveControl.8 := FALSE;
    stMotionStage.bDone := FALSE;
END_IF

(* updated axis status
   Not needed in manual mode *)
IF NOT bDS402ManualEnabled THEN
    stMotionStage.Axis.ReadStatus();
END_IF

(* Get a definitive bEnabled reading
   NB: use only in close loop mode, NC feature needed*)
CASE stMotionStage.Axis.Status.MotionState OF
    (* We are not enabled if there is an issue*)
    MC_AXISSTATE_UNDEFINED, MC_AXISSTATE_DISABLED, MC_AXISSTATE_ERRORSTOP:
        stMotionStage.bEnableDone := FALSE;
    ELSE
        stMotionStage.bEnableDone := TRUE;
END_CASE
//
IF stMotionStage.bReset THEN
    stMotionStage.bExecute:=FALSE;
    stMotionStage.bError := FALSE;
    stMotionStage.nErrorId := 0;
    stMotionStage.sErrorMessage:=&#39;&#39;;
    stMotionStage.sCustomErrorMessage:=&#39;&#39;;
    (*Manual Drive reset*)
    IF bDS402ManualEnabled THEN
        // Clear error/warning
        bManualTransition:=FALSE;
        IF NOT stMotionStage.bBusy THEN
            stDS402Drive.nDS402DriveControl := 128;
        ELSE
            // Power off the drive
            stMotionStage.bEnable:=FALSE;
            stDS402Drive.nDS402DriveControl := 6;
        END_IF
    ELSE
        bLocalReset := TRUE;
    END_IF
    stMotionStage.bReset:=FALSE;
END_IF

// Halt is always a user stop during motion
bStop S= NOT bLocalExec AND NOT bLocalReset AND ((bHomeBusy AND (nCommandLocal=10))
                        OR(fbMcMoveAbsolute.Busy AND (nCommandLocal=3)) OR (bStepMoveBusy AND (nCommandLocal=0)));

//auto handle position lag monitoring, disable during homing.
WriteParameterNC(   Execute:=bEnPosLag,
                    ParameterNumber:=MC_AxisParameter.AxisEnPositionLagMonitoring,
                    ParameterValue:=fParameterValue);

(* Requested commands processing *)
CASE nCommandLocal OF
    E_EpicsMotorCmd.MOVE_ABSOLUTE:
        (*NC CSP Move Handling*)
        Reset();
        Power();
        Halt();
        (*Wait for drive to be in the correct mode after a request was validated *)
        bCommandMoveAbsolute := bExecMove AND fbMcPower.Status AND bCSPModeEnabled;
        MoveAbsolute();
        (*IN CSP mode the drive control word is update via the NC
          Manual step mode and Homing will override this *)
         stDS402Drive.nDS402DriveControl := stDS402Drive.nDS402DriveControlNC;
    E_EpicsMotorCmd.HOME:
        (*DS402 Manual Homing*)
        Home();
    E_EpicsMotorCmd.JOG:
        (* Set drive to correct operating mode, ensure motion params are correct
          following a validated open loop mode request.
          NB: bservo must be off. a PV is provided for that
        *)
         StepMove(Enable:=bExecMove AND bStepModeparamsSetDone AND NOT bWrongParameter);
END_CASE

stMotionStage.bBusy := bHomeBusy OR fbMcMoveAbsolute.Busy OR bStepMoveBusy;

(* Check done moving via user stop, limit hit, Target Position reached, or from homing.*)
rtMoveDone(CLK:=fbMcMoveAbsolute.Done);
rtStepMoveDone(CLK:=bStepMoveDone);
rtHomeDone(CLK:=bHomeDone);
rtStopDone(CLK:=fbMcHalt.Done);
rtAborted(CLK:=bHomeAborted OR bStepMoveAborted);
IF rtAborted.Q OR rtStopDone.Q OR rtMoveDone.Q OR rtHomeDone.Q OR rtStepMoveDone.Q THEN
    IF NOT stMotionStage.bDone THEN
        stMotionStage.bHomed := bHomeDone;
        stMotionStage.bExecute:=FALSE;
        bCommandMoveAbsolute := FALSE;
        stMotionStage.bDone := fbMcMoveAbsolute.Done OR bHomeDone OR bStepMoveDone;
        IF bDS402ManualEnabled THEN
            (*Restore Postional lag monitoring*)
            bEnPosLag := FALSE;
        END_IF
        (* Release the internal limit override*)
        bLimOverride := FALSE;
        bHomeAborted := FALSE;
        bStepMoveAborted := FALSE;
    END_IF
END_IF

(* hold stage in place before timeout *)
tonHoldTime(PT:=UDINT_TO_TIME(nHoldTime));
IF tonHoldTime.Q THEN
    bPositionHold := FALSE;
    tonHoldTime.IN:=FALSE;
    bLastHoltTimeOut := TRUE;
    (* open loop mode is not compatible with MC_Power, MC _Halt...*)
    (* Manual power disabling is required*)
    IF bDS402ManualEnabled THEN
        stDS402Drive.nDS402DriveControl := 6;
    END_IF
    stMotionStage.bEnable:=FALSE;
    bStop := FALSE;
END_IF

(* updated axis status
   Not needed in manual mode *)
IF NOT bDS402ManualEnabled THEN
    stMotionStage.Axis.ReadStatus();
END_IF
//
ftExec(CLK:=stMotionStage.bExecute);
(*Handle auto-disable timing*)
bPrepareDisable S= stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION AND ftExec.Q;
(* Delay the disable until we reach standstill *)
IF bPrepareDisable AND stMotionStage.Axis.Status.StandStill THEN
    IF NOT bPositionHold THEN
        bPrepareDisable:=FALSE;
        stMotionStage.bEnable:=FALSE;
    END_IF
END_IF

(* update encoder value and calibrated position*)
ScaleEncRawValue();
(*Drive parameters*)
ExposedParameters(Enable:=TRUE, tRefreshDelay:=T#2S);
(* Open Loop Motion paramters Update*)
UpdateServoOffMotionParams(Enable:=stMotionStage.bAxisParamsInit AND NOT stMotionStage.bBusy AND bStepModeEnabled);
(*Sync NC setting to drive settings*)
UpdateDriveMonitoringParams(Enable:=stMotionStage.bAxisParamsInit AND NOT stMotionStage.bBusy);
(* Save and restore as long as not an absolute encoder*)
PersistParameters( Enable:=stMotionStage.nHomingMode &lt;&gt; E_EpicsHomeCmd.NONE);
(*Restore encoder value at initialization*)
RestoreMotionParams(Enable:=stMotionStage.nHomingMode &lt;&gt; E_EpicsHomeCmd.NONE);

(*EPICS Motor record Update*)
UpdateEpicsStatus();
(*
    Error from functions and Nc. The error will send to EPICS interface based on predifined
    priority: axis, power, backlash, absoluteMove, etc...
*)
IF fbMcPower.Error AND fbMcPower.Active THEN
    stMotionStage.bError:=fbMcPower.Error;
    stMotionStage.nErrorId:=fbMcPower.ErrorID;
ELSIF fbMcMoveAbsolute.Error THEN
    stMotionStage.bError:=fbMcMoveAbsolute.Error;
    stMotionStage.nErrorId:=fbMcMoveAbsolute.ErrorID;
ELSIF fbMcHalt.Error AND fbMcHalt.Active THEN
    stMotionStage.bError:=fbMcHalt.Error;
    stMotionStage.nErrorId:=fbMcHalt.ErrorID;
ELSIF fbMcReset.Error  THEN
    stMotionStage.bError:=fbMcReset.Error;
    stMotionStage.nErrorId:=fbMcReset.ErrorID;
ELSIF fbMcWriteParameter.Error THEN
    stMotionStage.bError:=fbMcWriteParameter.Error;
    stMotionStage.nErrorId:=fbMcWriteParameter.ErrorID;
ELSIF fbMcReadParams.Error AND NOT stMotionStage.bBusy THEN
    stMotionStage.bError:=fbMcReadParams.Error;
    stMotionStage.nErrorId:=fbMcReadParams.ErrorID;
ELSE
    IF stMotionStage.bBusy THEN
        stMotionStage.sErrorMessage := &#39;&#39;;
        stMotionStage.sCustomErrorMessage := &#39;&#39;;
    END_IF
END_IF;

(*Double function, prioritize NC error otherwise read drive channel error code*)
ReadDriveCodes();

IF stMotionStage.sCustomErrorMessage &lt;&gt; &#39;&#39;
    AND stMotionStage.sErrorMessage = &#39;&#39; THEN
    stMotionStage.sErrorMessage := stMotionStage.sCustomErrorMessage;
END_IF

(*Clear motion flag when error occurs*)
IF stMotionStage.bError  THEN
    stMotionStage.bBusy := FALSE;
    stMotionStage.bDone := FALSE;
    stMotionStage.bEnable := FALSE;
END_IF

(* We&#39;ve got the rising edge clear this flags.*)
stMotionStage.bMoveCmd:=FALSE;
stMotionStage.bHomeCmd:=FALSE;

END_FUNCTION_BLOCK

METHOD PUBLIC  ExposedParameters
VAR_INPUT
    Enable : BOOL;
    tRefreshDelay: TIME;
END_VAR

VAR_INST
    {attribute &#39;hide&#39;}
    bParamReadTimer         : BOOL := TRUE;
END_VAR
// Periodic update of NC parameters
NCParamsTimer( IN:=Enable AND NOT bExecParamsRead, PT:=tRefreshDelay);
bExecParamsRead S= NCParamsTimer.Q;
fbMcReadParams(
    Parameter:=stMotionStage.stAxisParameters,
    Axis:=stMotionStage.Axis,
    Execute:= bExecParamsRead );

// Copy axis parameters that we want to expose to the EPICS layer.
stMotionStage.stAxisParametersExposed.bCtrlEnablePosDiffControl     := stMotionStage.stAxisParameters.bCtrlEnablePosDiffControl;
stMotionStage.stAxisParametersExposed.bEncEnableSoftEndMaxControl   := stMotionStage.stAxisParameters.bEncEnableSoftEndMaxControl;
stMotionStage.stAxisParametersExposed.bEncEnableSoftEndMinControl   := stMotionStage.stAxisParameters.bEncEnableSoftEndMinControl;
stMotionStage.stAxisParametersExposed.fAccelerationMax              := stMotionStage.stAxisParameters.fAccelerationMax;
stMotionStage.stAxisParametersExposed.fCtrlPosDiffMax               := stMotionStage.stAxisParameters.fCtrlPosDiffMax;
stMotionStage.stAxisParametersExposed.fCtrlPosDiffMaxTime           := stMotionStage.stAxisParameters.fCtrlPosDiffMaxTime;
stMotionStage.stAxisParametersExposed.fDecelerationMax              := stMotionStage.stAxisParameters.fDecelerationMax;
stMotionStage.stAxisParametersExposed.fEncSoftEndMax                := stMotionStage.stAxisParameters.fEncSoftEndMax;
stMotionStage.stAxisParametersExposed.fEncSoftEndMin                := stMotionStage.stAxisParameters.fEncSoftEndMin;
stMotionStage.stAxisParametersExposed.fVeloMaximum                  := stMotionStage.stAxisParameters.fVeloMaximum;
stMotionStage.stAxisParametersExposed.fEncOffset                            := stMotionStage.stAxisParameters.fEncOffset;
stMotionStage.stAxisParametersExposed.fEncScaleFactorInternal       := stMotionStage.stAxisParameters.fEncScaleFactorInternal;

bExecParamsRead R= fbMcReadParams.Done OR fbMcReadParams.Error;
stMotionStage.bAxisParamsInit S= fbMcReadParams.Done;
END_METHOD

//FB_Init is always available implicitly and it is used primarily for initialization.
//The return value is not evaluated. For a specific influence, you can also declare the
//methods explicitly and provide additional code there with the standard initialization
//code. You can evaluate the return value.
METHOD FB_Init: BOOL
VAR_INPUT
    bInitRetains: BOOL; // TRUE: the retain variables are initialized (reset warm / reset cold)
    bInCopyCode: BOOL;  // TRUE: the instance will be copied to the copy code afterward (online change)
    stPiezoStage            :       REFERENCE TO ST_MotionStage;
    (*Mandatory must be unique for each MCS2 axis *)
    eModule : E_Module;
END_VAR
THIS^.stMotionStage REF= stPiezoStage;
THIS^.eModule := eModule;
END_METHOD

METHOD Halt : BOOL
fbMcHalt(
    Axis := stMotionStage.Axis,
    Execute := bStop AND bCSPModeEnabled,
    Deceleration := stMotionStage.fDeceleration,
    BufferMode := eBufferMode,
);

IF fbMcHalt.Done (*OR fbMcReset.Done*) THEN
    (*Hold the position in close loop before dropping power, a positional drift will occur then*)
    IF (stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION ) THEN
        bPositionHold := TRUE;
        tonHoldTime.IN:=TRUE;
    END_IF
END_IF
END_METHOD

METHOD PUBLIC Home

VAR_INST
    {attribute &#39;hide&#39;}
    bMove                           : BOOL;
END_VAR
tonSyncHoming(PT:=T#20MS);
CASE eHomeMode OF
    E_EpicsHomeCmd.AUTOZERO:
        bMove S=  bExecHome;
    E_EpicsHomeCmd.NONE:
        bMove := FALSE;
        bHomeBusy :=  bExecHome;
        bHomeDone := NOT  bExecHome;
    ELSE
        bMove := FALSE;
END_CASE

IF bMove THEN
    CASE eHomeState OF
        // Wait for a rising edge
        E_MoveState.IDLING:
            IF bExecHome AND bHomeModeEnabled THEN
                bHomeDone := FALSE;
                bHomeBusy := TRUE;
                stMotionStage.bDone := FALSE;
                tonSyncHoming.IN := TRUE;
                stDS402Drive.nDS402DriveControl :=15;
                eHomeState := E_MoveState.INIT;
            END_IF
        E_MoveState.INIT:
            IF tonSyncHoming.Q THEN
                tonSyncHoming.IN := FALSE;
                stDS402Drive.nDS402DriveControl :=31;
                eHomeState:=E_MoveState.STARTED;
            END_IF
        E_MoveState.STARTED :
            // this is a comfirmation that routine is ongoing
            IF NOT stDS402Drive.stDS402DriveStatus.TargetReached
                AND NOT stDS402Drive.stDS402DriveStatus.Bit13_OpModeSpecific THEN
                bHomeBusy:=TRUE;
                bHomeDone:=FALSE;
                eHomeState:=E_MoveState.IN_PROGRESS;
            END_IF

        E_MoveState.IN_PROGRESS :

        IF bStop THEN
          stDS402Drive.nDS402DriveControl.8 :=1;
          bHomeAborted := TRUE;
          eHomeState:=E_MoveState.INTERRUPTED;

        // Genral Motion error i.e Following error ?
        ELSIF stDS402Drive.stDS402DriveStatus.Bit13_OpModeSpecific
                OR stDS402Drive.stDS402DriveStatus.WarningCondition THEN
            stMotionStage.bError := TRUE;
            eHomeState:=E_MoveState.ERROR;

        // Reached
        ELSIF stDS402Drive.stDS402DriveStatus.TargetReached
            AND stDS402Drive.stDS402DriveStatus.Bit12_OpModeSpecific
            AND NOT stDS402Drive.stDS402DriveStatus.Bit13_OpModeSpecific THEN
           eHomeState:=E_MoveState.DONE;
        END_IF
        E_MoveState.INTERRUPTED:
            IF (stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION ) THEN
                bPositionHold := TRUE;
                tonHoldTime.IN:=TRUE;
            END_IF
            bHomeBusy:=FALSE;
            eHomeState:=E_MoveState.IDLING;
        E_MoveState.DONE:
            bHomeBusy:=FALSE;
            tonSyncHoming.IN := FALSE;
            IF (stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION ) THEN
                bPositionHold := TRUE;
                tonHoldTime.IN:=TRUE;
            END_IF
            bHomeDone:=TRUE;
            stMotionStage.fPosition:=0.0;
            //stDS402Drive.nDS402DriveControl := 15;
            eHomeState:=E_MoveState.IDLING;
        E_MoveState.ERROR:
            bHomeDone:=FALSE;
            bHomeBusy:= FALSE;
            IF bWrongParameter THEN
                stMotionStage.sCustomErrorMessage:=&#39;Invalid motion Parameters&#39;;
                bWrongParameter := FALSE;
                stMotionStage.bError := TRUE;
            END_IF
            IF NOT stMotionStage.bError THEN
                eHomeState:=E_MoveState.IDLING;
            END_IF
    END_CASE
END_IF
END_METHOD

METHOD PUBLIC Interlock

VAR_INST
    {attribute &#39;hide&#39;}
    bPositiveDirection  : BOOL;
    {attribute &#39;hide&#39;}
    bNegativeDirection  : BOOL;
    {attribute &#39;hide&#39;}
    ftForwardEnabled        : F_TRIG;

    {attribute &#39;hide&#39;}
    ftBackwardEnabled       : F_TRIG;
END_VAR
// Positive or Negative direction
bPositiveDirection:=stMotionStage.bBusy AND stMotionStage.fPosDiff &gt; 0;
bNegativeDirection:=stMotionStage.bBusy AND stMotionStage.fPosDiff &lt; 0;

// For SmartAct MCS2 these limit are range and enstop limits. however a single bit in the status is used
// bLimOverride  : act as an override after limit was hit to allow reverse movement
stMotionStage.bLimitForwardEnable :=  bLimOverride OR NOT( bPositiveDirection AND stDS402Drive.stDS402DriveStatus.InternalLimitActive );
stMotionStage.bLimitBackwardEnable := bLimOverride OR NOT( bNegativeDirection AND stDS402Drive.stDS402DriveStatus.InternalLimitActive );

// use falling trigger to avoid spaming  sErrorMessage
ftForwardEnabled(CLK:=stMotionStage.bLimitForwardEnable);
ftBackwardEnabled(CLK:=stMotionStage.bLimitBackwardEnable);

IF  NOT bHomeBusy AND ftForwardEnabled.Q THEN
    // Not an error, just a warning
    stMotionStage.sCustomErrorMessage:=&#39;Cannot move past positive limit.&#39;;
    IF NOT bStepModeEnabled THEN
        bLimOverride := TRUE;
        bStop := TRUE;
    END_IF
END_IF

IF NOT bHomeBusy AND ftBackwardEnabled.Q THEN
    // Not an error, just a warning
    stMotionStage.sCustomErrorMessage:=&#39;Cannot move past Negative limit.&#39;;
    IF NOT bStepModeEnabled THEN
        bLimOverride := TRUE;
        bStop := TRUE;
    END_IF
END_IF

IF NOT stMotionStage.bError AND stMotionStage.bExecute AND NOT stMotionStage.bUserEnable THEN
    stMotionStage.bError := TRUE;
    stMotionStage.nErrorId := 1;
    stMotionStage.sCustomErrorMessage := &#39;Move requested, but user enable is disabled!&#39;;
END_IF

// Update all enable booleans
SetEnables();
END_METHOD

(*Switch the drive mod eof Operation
  Servo On: Profil Positioning or HOME
  Servo Off : STEP mode
*)
METHOD ModeOperation
rtCSPModeOk(CLK:=( stDS402Drive.nModeOfOperationDisplay=E_DS402OpMode.CSP));
rtHomeModeEnable(CLK:=( stDS402Drive.nModeOfOperationDisplay=E_DS402OpMode.HOME));
rtStepModeEnabled(CLK:=( stDS402Drive.nModeOfOperationDisplay=E_DS402OpMode.MCS2_OL_STEP_MODE));
// transition to close loop mode
IF rtCSPModeOk.Q THEN
    bCSPModeEnabled := TRUE;
ELSIF rtHomeModeEnable.Q THEN
    bHomeModeEnabled := TRUE;
ELSIF rtStepModeEnabled.Q THEN
    bStepModeEnabled := TRUE;
    bServo := FALSE;
END_IF

IF rtUserExec.Q AND stMotionStage.bHomeCmd THEN
    IF (stDS402Drive.nModeOfOperationDisplay&lt;&gt;E_DS402OpMode.HOME) THEN
        stDS402Drive.nModeOfOperation := E_DS402OpMode.HOME;
        IF stDS402Drive.nDS402DriveControl.4 THEN
            stDS402Drive.nDS402DriveControl := 15;
        ELSE
            stDS402Drive.nDS402DriveControl := 128;
        END_IF
        bManualTransition := TRUE;
        // clear previous operational from switching away from this mode.
        bOperational := FALSE;
        bStepModeEnabled := FALSE;
        bCSPModeEnabled := FALSE;
    ELSE
        bHomeModeEnabled := TRUE;
    END_IF
ELSIF rtUserExec.Q AND bServo THEN
    IF (stDS402Drive.nModeOfOperationDisplay&lt;&gt;E_DS402OpMode.CSP) THEN
        stDS402Drive.nModeOfOperation := E_DS402OpMode.CSP;
        IF stDS402Drive.nDS402DriveControl.4 THEN
            stDS402Drive.nDS402DriveControl := 15;
        ELSE
            stDS402Drive.nDS402DriveControl := 128;
        END_IF
        bManualTransition := FALSE;
        bHomeModeEnabled := FALSE;
        bStepModeEnabled := FALSE;
    ELSE
        bCSPModeEnabled := TRUE;
    END_IF
ELSIF rtUserExec.Q AND NOT bServo THEN
    IF (stDS402Drive.nModeOfOperationDisplay&lt;&gt;E_DS402OpMode.MCS2_OL_STEP_MODE) THEN
        stDS402Drive.nModeOfOperation := E_DS402OpMode.MCS2_OL_STEP_MODE;
        stDS402Drive.nDS402DriveControl := 128;
        // clear previous operational from switching away from this mode.
        bOperational := FALSE;
        bCSPModeEnabled := FALSE;
        bHomeModeEnabled := FALSE;
    ELSE
        bStepModeEnabled := TRUE;
    END_IF
    bManualTransition := TRUE;
END_IF

bDS402ManualEnabled :=bHomeModeEnabled OR bStepModeEnabled;
(*Handle correct startup procedure for manual move*)
StateMachine(Enable:=1);
END_METHOD

METHOD PUBLIC  MoveAbsolute
fbMcMoveAbsolute(
    Axis := stMotionStage.Axis,
    Execute := bCommandMoveAbsolute,
    Position := stMotionStage.fPosition,
    Velocity := stMotionStage.fVelocity,
    Acceleration := stMotionStage.fAcceleration,
    Deceleration := stMotionStage.fDeceleration,
    BufferMode := eBufferMode,
);


IF fbMcMoveAbsolute.Done (*OR fbMcReset.Done*) THEN
    (*Hold the position in close loop before dropping power, a positional drift will occur then*)
    IF (stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION ) THEN
        bPositionHold := TRUE;
        tonHoldTime.IN:=TRUE;
    END_IF
END_IF
END_METHOD

METHOD PersistParameters
VAR_INPUT
    Enable  : BOOL;
END_VAR

VAR_INST
    {attribute &#39;hide&#39;}
    bEncError                       : BOOL;

    {attribute &#39;hide&#39;}
    bRestoreWaitRetry       : BOOL;
END_VAR
// Save Encoder position
// needs some pre-conditions to use persistent storage
IF Enable THEN
    // Check ST_MotionStage for an encoder error (range 0x44nn)
    bEncError:= stMotionStage.Axis.Status.Error AND  ( stMotionStage.Axis.Status.ErrorID  &gt;= 16#4400  AND stMotionStage.Axis.Status.ErrorID &lt;= 16#44FF );
    // Do not save if we&#39;re currently loading or if there is an encoder error
    IF NOT bRestoreLoad AND NOT bEncError AND NOT bRestoreWaitRetry THEN
        fSavedPosition := stMotionStage.Axis.NcToPlc.ActPos;
        // This persistent variable lets us check if anything was saved
        // It will be TRUE at startup if we have saved values
        bSaved := TRUE;
        (*
            use this with a timer of a change threshold on the fActPosition
            to trigger a save from this PLC program. otherwise this will be a spamming
            persistence, filling up the disk.
        *)
        //iPersistentDataStorage.TriggerWriteOfPersistentData := bSaveEnabled;
    END_IF
END_IF
END_METHOD

{attribute &#39;call_after_init&#39;}
(*  eModule: Mandatory must be unique for each MCS2 axis
    clears startup errors or warnings. the process is completed at run time
    SDO update of Drive and open Loop parameter Indexes based on module number
*)
METHOD PostInit
VAR_INPUT
END_VAR
(* SDO update of Drive and open Loop parameter Indexes based on module number*)
nChanErrorCodeIdx   := nErrorCodeBase               + ((eModule-1) * nChanOfsBase);
nChanFErrWinIdx             := nFErrWinBase                 + ((eModule-1) * nChanOfsBase);
nChanSoftLimitIdx   := nChanSoftLimitBase   + ((eModule-1) * nChanOfsBase);
nChanHomeOffsIdx    := nHomeOffsetBase              + ((eModule-1) * nChanOfsBase);
nChanHomeVeloIdx    := nHomingSpeedBase             + ((eModule-1) * nChanOfsBase);
nChanhomeAccIdx     := nhomingAccBase               + ((eModule-1) * nChanOfsBase);
nChanStepIdx        := nOlStepBase                  + ((eModule-1) * nChanOfsBase);
nChanStepFreqIdx  := nOlStepFreqBase                + ((eModule-1) * nChanOfsBase);
nChanStepAmpIdx     := nOlStepAmpBase               + ((eModule-1) * nChanOfsBase);
bInit := TRUE;
END_METHOD

METHOD Power : BOOL
fbMcPower(
    Axis := stMotionStage.Axis,
    Enable := stMotionStage.bAllEnable AND bCSPModeEnabled,
    Enable_Positive := stMotionStage.bAllForwardEnable,
    Enable_Negative := stMotionStage.bAllBackwardEnable,
    Override := 100.0,
    BufferMode := eBufferMode );
END_METHOD

(* Read Drive error codes after a motion or fault condition occured *)
METHOD ReadDriveCodes : BOOL
VAR_INST
    {attribute &#39;hide&#39;}
    fbErrorRead                     : FB_EcCoESdoRead;
    {attribute &#39;hide&#39;}
    nPiezoErrorCode         : UDINT;
    {attribute &#39;hide&#39;}
    fbLogError              : FB_LogMotionError;
    {attribute &#39;hide&#39;}
    ftErrorReadDone         : F_TRIG;
END_VAR
fbErrorRead( sNetId:= THIS^.stMotionStage.stAxisParameters.sAmsNetId,
             nSlaveAddr:=stDS402Drive.nSlaveAddr,
             nIndex:=nChanErrorCodeIdx,
             nSubIndex :=nSubIndex,
             pDstBuf:= ADR(nPiezoErrorCode),
             cbBufLen:=SIZEOF(nPiezoErrorCode),
             bExecute:= stMotionStage.bError );

ftErrorReadDone(CLK:=fbErrorRead.bBusy);
IF ftErrorReadDone.Q THEN
    IF      NOT fbErrorRead.bError AND nPiezoErrorCode &lt;&gt; 0 THEN
        stMotionStage.nErrorId := nPiezoErrorCode;
    END_IF
    stMotionStage.sErrorMessage := F_MotionErrorCodeLookup(nErrorId:=stMotionStage.nErrorId);
    fbLogError( stMotionStage:=stMotionStage, bEnable:=stMotionStage.bError);
END_IF
END_METHOD

METHOD Reset : BOOL
fbMcReset(
    Axis := stMotionStage.Axis,
    Execute := bLocalReset AND bCSPModeEnabled
);

IF fbMcReset.Done OR fbMcReset.Error THEN
    bLocalReset := FALSE;
    IF (stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION ) THEN
        stMotionStage.bEnable:=FALSE;
    END_IF

END_IF
END_METHOD

METHOD RestoreMotionParams
VAR_INPUT
    Enable  : BOOL;
END_VAR

VAR_INST
    {attribute &#39;hide&#39;}
    fbSetPos                        : MC_SetPosition;
    {attribute &#39;hide&#39;}
    bLoad                           : BOOL;
    {attribute &#39;hide&#39;}
    bRestoreDone            : BOOL;
    {attribute &#39;hide&#39;}
    bRestoreInit            : BOOL;
    {attribute &#39;hide&#39;}
    bRestoreWaitRetry       : BOOL;
    {attribute &#39;hide&#39;}
    nMaxRetries                     : UINT := 10;
    {attribute &#39;hide&#39;}
    nCurrTries                      : UINT := 0;
    {attribute &#39;hide&#39;}
    nLatchError                     : UDINT;
END_VAR
IF Enable THEN
    // Trigger a load if anything was saved at all
    IF NOT bRestoreInit THEN
        bRestoreInit := TRUE;
        bRestoreLoad S= bSaved;
        fbSetPos.Options.ClearPositionLag := TRUE;
    END_IF

    // Set our position if bRestoreLoad is true
    fbSetPos( Axis:=stMotionStage.Axis, Execute:=bRestoreLoad, Position:=fSavedPosition);

    // Only load once, at startup
    bRestoreLoad R= fbSetPos.Done OR fbSetPos.Error;

    IF fbSetPos.Error THEN
        // Keep the error latched, it can disappear if Execute is set to FALSE
        nLatchError := fbSetPos.ErrorID;
        nCurrTries := nCurrTries + 1;
        IF nCurrTries &gt;= nMaxRetries THEN
        // Alert the user that something has gone wrong
        stMotionStage.bError := TRUE;
        stMotionStage.nErrorId := nLatchError;
        stMotionStage.sCustomErrorMessage := &#39;Error loading previously saved position.&#39;;
        ELSE
            // Reset the FB for the next retry
            fbSetPos( Axis:=stMotionStage.Axis, Execute:=bRestoreLoad, Position:=fSavedPosition);
            // Try again
            bRestoreWaitRetry := TRUE;
        END_IF
    ELSE
        IF NOT bRestoreDone THEN
            stMotionStage.fPosition := fSavedPosition;
        END_IF
        bRestoreDone := TRUE;
    END_IF

    tonRestoreRetry( IN := bRestoreWaitRetry, PT := T#100MS);
    bRestoreLoad S= tonRestoreRetry.Q;
    bRestoreWaitRetry R= tonRestoreRetry.Q;
END_IF
END_METHOD

METHOD ScaleDriveParams
nScaledFErrWin:=LREAL_TO_DINT((stMotionStage.stAxisParameters.fCtrlPosDiffMax / MAX(stMotionStage.stAxisParameters.fEncScaleFactorInternal, fScalingFactor)));
nSoftLimMax := LREAL_TO_DINT((stMotionStage.stAxisParameters.fEncSoftEndMax / MAX(stMotionStage.stAxisParameters.fEncScaleFactorInternal, fScalingFactor)));
nSoftLimMin := LREAL_TO_DINT((stMotionStage.stAxisParameters.fEncSoftEndMin / MAX(stMotionStage.stAxisParameters.fEncScaleFactorInternal, fScalingFactor)));
END_METHOD

METHOD ScaleEncRawValue
VAR_INPUT
  //  bEnable: BOOL;
END_VAR
(* SmartACT: The encoder count from the Piezo drive is not a raw count from the embeded actuator device
   we get a calibrated nm value. thus the use of abs() since this value is signed.
   PI: to be discovered *)
IF stMotionStage.nRawEncoderDINT &lt;&gt; 0 THEN
    stMotionStage.nEncoderCount:=DINT_TO_UDINT(ABS(stMotionStage.nRawEncoderDINT));
ELSE
    stMotionStage.nEncoderCount:=0;
END_IF

// calibrated encoder readback
IF NOT bStepModeEnabled THEN
    // Close loop NC
    fMeasuredPos:=stMotionStage.Axis.NcToPlc.ActPos;
    fMeasuredVelo :=stMotionStage.Axis.NcToPlc.ActVelo;
    fMeasuredAcc := stMotionStage.Axis.NcToPlc.ActAcc;
    stMotionStage.fPosDiff:=stMotionStage.Axis.NcToPlc.PosDiff;
ELSE
    fMeasuredPos:=DINT_TO_REAL(stMotionStage.nRawEncoderDINT) * MAX(stMotionStage.stAxisParameters.fEncScaleFactorInternal, fScalingFactor);
    stMotionStage.fPosDiff:=stMotionStage.fPosition - fMeasuredPos;
    // NB: Not actual in open loop
    fMeasuredVelo :=stMotionStage.fVelocity;
    fMeasuredAcc := stMotionStage.fAcceleration;
END_IF
END_METHOD

(*Scale Home Move parameters*)
METHOD ScaleHomeMotionParams
nHomeVeloFast := LREAL_TO_UDINT((stMotionStage.stAxisParameters.fRefVeloSearch / MAX(stMotionStage.stAxisParameters.fEncScaleFactorInternal, fScalingFactor)));
nHomeVeloSlow := LREAL_TO_UDINT((stMotionStage.stAxisParameters.fRefVeloSync / MAX(stMotionStage.stAxisParameters.fEncScaleFactorInternal, fScalingFactor)));
nHomeAcc := LREAL_TO_UDINT((THIS^.fHomeAcc / MAX(stMotionStage.stAxisParameters.fEncScaleFactorInternal, fScalingFactor)));
nHomeOffset := LREAL_TO_DINT((stMotionStage.fHomePosition / MAX(stMotionStage.stAxisParameters.fEncScaleFactorInternal, fScalingFactor)));
END_METHOD

(*Scaled Open Loop Step mode motion parameters*)
METHOD ScaleServoOffMotionParams
VAR_INPUT
END_VAR
IF  nChanStepAmp = 0
    OR nChanStepFreq = 0 THEN
    bWrongParameter := TRUE;
ELSE
    fScalededSteps := (THIS^.stMotionStage.fPosition * nChanStepEgu) ;
    nScalededSteps:=LIMIT(-1000, LREAL_TO_DINT(fScalededSteps), 1000);
    nScalededStepAmp:=REAL_TO_UINT(LIMIT(50, nChanStepAmp, 100) * 655.35);
    nScaledStepFreq:=REAL_TO_UINT(LIMIT(500, nChanStepFreq, 1000.0));
    bWrongParameter := FALSE;
END_IF
//827.31x-837.63
END_METHOD

METHOD SetEnables
VAR_INPUT
END_VAR
stMotionStage.bAllForwardEnable:=stMotionStage.bLimitForwardEnable AND (stMotionStage.bGantryForwardEnable OR NOT stMotionStage.bGantryAxis) AND stMotionStage.stEPSForwardEnable.bEPS_OK;
stMotionStage.bAllBackwardEnable:=stMotionStage.bLimitBackwardEnable AND (stMotionStage.bGantryBackwardEnable OR NOT stMotionStage.bGantryAxis) AND stMotionStage.stEPSBackwardEnable.bEPS_OK;

stMotionStage.bAllEnable:=stMotionStage.bEnable AND stMotionStage.bHardwareEnable AND stMotionStage.stEPSPowerEnable.bEPS_OK;
stMotionStage.bAllEnable R= NOT stMotionStage.bUserEnable;
END_METHOD

METHOD StateMachine
VAR_INPUT
    Enable : BOOL;
END_VAR

VAR_INST
    rtFault: R_TRIG;
    {attribute &#39;hide&#39;}
    bFault                          : BOOL;
END_VAR
(*switch on disable*)
IF NOT stDS402Drive.stDS402DriveStatus.ReadyToSwitchOn
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchedOn
    AND NOT stDS402Drive.stDS402DriveStatus.OperationEnabled
    AND NOT stDS402Drive.stDS402DriveStatus.Fault
    AND stDS402Drive.stDS402DriveStatus.VoltageEnabled
    AND NOT stDS402Drive.stDS402DriveStatus.QuickStopActive
    AND  stDS402Drive.stDS402DriveStatus.SwitchOnDisabled THEN
        bOperational := FALSE;
        bFault := FALSE;
        IF bManualTransition THEN
            THIS^.stDS402Drive.nDS402DriveControl := 6;
        END_IF
(*Ready to switch*)
ELSIF stDS402Drive.stDS402DriveStatus.ReadyToSwitchOn
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchedOn
    AND NOT stDS402Drive.stDS402DriveStatus.OperationEnabled
    AND NOT stDS402Drive.stDS402DriveStatus.Fault
    AND stDS402Drive.stDS402DriveStatus.VoltageEnabled
    AND stDS402Drive.stDS402DriveStatus.QuickStopActive
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchOnDisabled THEN
        bFault := FALSE;
        bOperational := FALSE;
        IF bManualTransition THEN
            THIS^.stDS402Drive.nDS402DriveControl := 7;
        END_IF
(*Switch on*)
ELSIF stDS402Drive.stDS402DriveStatus.ReadyToSwitchOn
    AND  stDS402Drive.stDS402DriveStatus.SwitchedOn
    AND NOT stDS402Drive.stDS402DriveStatus.OperationEnabled
    AND NOT stDS402Drive.stDS402DriveStatus.Fault
    AND stDS402Drive.stDS402DriveStatus.VoltageEnabled
    AND stDS402Drive.stDS402DriveStatus.QuickStopActive
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchOnDisabled THEN
        bOperational := FALSE;
        IF bManualTransition THEN
            THIS^.stDS402Drive.nDS402DriveControl := 15;
        END_IF
(*Operation enbaled*)
ELSIF stDS402Drive.stDS402DriveStatus.ReadyToSwitchOn
    AND stDS402Drive.stDS402DriveStatus.SwitchedOn
    AND stDS402Drive.stDS402DriveStatus.OperationEnabled
    AND NOT stDS402Drive.stDS402DriveStatus.Fault
    AND stDS402Drive.stDS402DriveStatus.VoltageEnabled
    AND stDS402Drive.stDS402DriveStatus.QuickStopActive
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchOnDisabled THEN
        THIS^.bOperational := TRUE;
(*Fault*)
ELSIF  NOT stDS402Drive.stDS402DriveStatus.ReadyToSwitchOn
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchedOn
    AND NOT stDS402Drive.stDS402DriveStatus.OperationEnabled
    AND stDS402Drive.stDS402DriveStatus.Fault
    AND stDS402Drive.stDS402DriveStatus.VoltageEnabled
    AND NOT stDS402Drive.stDS402DriveStatus.QuickStopActive
    AND NOT stDS402Drive.stDS402DriveStatus.SwitchOnDisabled THEN
        bOperational := FALSE;
        bFault := TRUE;

ELSE
    bFault := FALSE;
    bOperational := FALSE;
END_IF

// wait for parameter init done at startup to read potential error from drive
stMotionStage.bError := bFault AND stMotionStage.bAxisParamsInit;
END_METHOD

METHOD  StepMove
VAR_INPUT
    Enable : BOOL;
END_VAR
rtStepMove(CLK:=Enable);
CASE eMotionState OF
    E_MoveState.IDLING:;
        // Motion states
        IF rtStepMove.Q THEN
            // enter move discrete or continous here:
            bStepMoveBusy := TRUE;
            bStepMoveDone := FALSE;
            stMotionStage.bDone:=FALSE;
            bSteModeEnable := FALSE;
            stDS402Drive.nDS402DriveControl:=15;
            eMotionState:=E_MoveState.INIT;
        END_IF
    E_MoveState.INIT:
            stDS402Drive.nDS402DriveControl:=31;
            IF stMotionStage.bError THEN
                eMotionState:=E_MoveState.ERROR;
            ELSE
                stDS402Drive.nDS402DriveControl:=31;
                  eMotionState:=E_MoveState.IN_PROGRESS;
            END_IF

    E_MoveState.IN_PROGRESS:
        IF bStop THEN
            stDS402Drive.nDS402DriveControl.8 :=1;
            bStepMoveAborted := TRUE;
            eMotionState:=E_MoveState.INTERRUPTED;
        ELSIF stDS402Drive.stDS402DriveStatus.Bit13_OpModeSpecific THEN
            stMotionStage.bError := TRUE;
            eMotionState:=E_MoveState.ERROR;
        ELSE
            // Reached ?
            IF stDS402Drive.stDS402DriveStatus.TargetReached
                 AND NOT stDS402Drive.stDS402DriveStatus.Bit12_OpModeSpecific THEN
                eMotionState:=E_MoveState.REACHED;
            END_IF
        END_IF
    E_MoveState.INTERRUPTED:
        IF (stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION ) THEN
            bPositionHold := TRUE;
            tonHoldTime.IN:=TRUE;
        END_IF
        bStepMoveBusy:=FALSE;
        eMotionState:=E_MoveState.IDLING;
    E_MoveState.REACHED:
        // Release the endstop override
        bLimOverride := FALSE;
        bStepMoveBusy:=FALSE;
        IF (stMotionStage.nEnableMode = E_StageEnableMode.DURING_MOTION ) THEN
            bPositionHold := TRUE;
            tonHoldTime.IN:=TRUE;
        END_IF
        bStepMoveDone:=TRUE;
        stDS402Drive.nDS402DriveControl:=15;
        IF stMotionStage.bDone THEN
            eMotionState:=E_MoveState.IDLING;
        END_IF
    E_MoveState.ERROR:
        bStepMoveBusy:=FALSE;
        bStepMoveDone:=FALSE;
        IF bWrongParameter THEN
            stMotionStage.sCustomErrorMessage:=&#39;Invalid motion Parameters&#39;;
            bWrongParameter := FALSE;
            stMotionStage.bError := TRUE;
        END_IF
        IF NOT stMotionStage.bError THEN
            eMotionState:=E_MoveState.IDLING;
        END_IF
END_CASE
END_METHOD

(*  Drive parameters update
    Mirror NC axis parameters configurations to those of MCS2 drive
    1- Following error
    2- Home Speeds
    3- Home Acceleration
    4- SoftLimits
*)
METHOD UpdateDriveMonitoringParams
VAR_INPUT
    Enable : BOOL;
END_VAR

VAR_INST
    {attribute &#39;hide&#39;}
    fbSetFErrorWin          : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetSoftLimMin         : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetSoftLimMax         : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetHomeOffs           : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetHomeVeloFast       : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetHomeVeloSlow       : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetHomeAcc            : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    nRecentSoftLimMax       : LINT;
    {attribute &#39;hide&#39;}
    nRecentSoftLimMin       : LINT;
    {attribute &#39;hide&#39;}
    nRecentHomeVeloFast : UDINT;
    {attribute &#39;hide&#39;}
    nRecentHomeVeloSlow : UDINT;
    {attribute &#39;hide&#39;}
    nRecentHomeAcc          : UDINT;
    {attribute &#39;hide&#39;}
    nRecentFErrWin          : DINT;
    {attribute &#39;hide&#39;}
    nRecentHomeOffset       : DINT;
    {attribute &#39;hide&#39;}
    nHomeOffs                       : DINT;
    {attribute &#39;hide&#39;}
    ftFErrWinSetDone        : F_TRIG;

    {attribute &#39;hide&#39;}
    ftSoftLimMaxSetDone     : F_TRIG;
    {attribute &#39;hide&#39;}
    ftSoftLimMinSetDone     : F_TRIG;
    {attribute &#39;hide&#39;}
    ftHomeVeloFastSetDone: F_TRIG;
    {attribute &#39;hide&#39;}
    ftHomeAccSetDone        : F_TRIG;
    {attribute &#39;hide&#39;}
    ftHomeOffsSetDone       : F_TRIG;
    {attribute &#39;hide&#39;}
    ftHomeVeloSlowSetDone: F_TRIG;
END_VAR
IF Enable THEN

    (*      Drive parameters update
        Mirror NC axis parameters configurations to those of MCS2 drive
        1- Following error.
        2- SoftLimits
        3-Position Range
    *)
  // add some safety here for  0 div.
  ScaleDriveParams();
  ScaleHomeMotionParams ();

  fbSetFErrorWin(
    sNetId     := THIS^.stMotionStage.stAxisParameters.sAmsNetId,
    nSlaveAddr := stDS402Drive.nSlaveAddr,
    nIndex     := nChanFErrWinIdx,
    nSubIndex  := 0,
    pSrcBuf    := ADR(nScaledFErrWin),
    cbBufLen   := SIZEOF(nScaledFErrWin),
    bExecute   := NOT stMotionStage.bBusy AND (nScaledFErrWin &lt;&gt; nRecentFErrWin)
  );
  fbSetSoftLimMin(
    sNetId     := THIS^.stMotionStage.stAxisParameters.sAmsNetId,
    nSlaveAddr := stDS402Drive.nSlaveAddr,
    nIndex     := nChanSoftLimitIdx,
    nSubIndex  := 1,
    pSrcBuf    := ADR(nSoftLimMin),
    cbBufLen   := SIZEOF(nSoftLimMin),
    bExecute   := NOT stMotionStage.bBusy AND (nSoftLimMin &lt;&gt; nRecentSoftLimMin)
  );
  fbSetSoftLimMax(
    sNetId     := THIS^.stMotionStage.stAxisParameters.sAmsNetId,
    nSlaveAddr := stDS402Drive.nSlaveAddr,
    nIndex     := nChanSoftLimitIdx,
    nSubIndex  := 2,
    pSrcBuf    := ADR(nSoftLimMax),
    cbBufLen   := SIZEOF(nSoftLimMax),
    bExecute   := NOT stMotionStage.bBusy AND (nSoftLimMax &lt;&gt; nRecentSoftLimMax)
    );
  fbSetHomeVeloFast(
    sNetId     := THIS^.stMotionStage.stAxisParameters.sAmsNetId,
    nSlaveAddr := stDS402Drive.nSlaveAddr,
    nIndex     := nChanHomeVeloIdx,
    nSubIndex  := 1,
    pSrcBuf    := ADR(nHomeVeloFast),
    cbBufLen   := SIZEOF(nHomeVeloFast),
    bExecute   := NOT stMotionStage.bBusy AND (nHomeVeloFast &lt;&gt; nRecentHomeVeloFast)
  );
  fbSetHomeVeloSlow(
    sNetId     := THIS^.stMotionStage.stAxisParameters.sAmsNetId,
    nSlaveAddr := stDS402Drive.nSlaveAddr,
    nIndex     := nChanHomeVeloIdx,
    nSubIndex  := 2,
    pSrcBuf    := ADR(nHomeVeloSlow),
    cbBufLen   := SIZEOF(nHomeVeloSlow),
    bExecute   := NOT stMotionStage.bBusy AND (nHomeVeloSlow &lt;&gt; nRecentHomeVeloSlow)
  );
  fbSetHomeAcc(
    sNetId     := THIS^.stMotionStage.stAxisParameters.sAmsNetId,
    nSlaveAddr := stDS402Drive.nSlaveAddr,
    nIndex     := nChanhomeAccIdx,
    nSubIndex  := 0,
    pSrcBuf    := ADR(nHomeAcc),
    cbBufLen   := SIZEOF(nHomeAcc),
    bExecute   := NOT stMotionStage.bBusy AND (nHomeAcc &lt;&gt; nRecentHomeAcc)
  );

  fbSetHomeOffs(
    sNetId     := THIS^.stMotionStage.stAxisParameters.sAmsNetId,
    nSlaveAddr := stDS402Drive.nSlaveAddr,
    nIndex     := nChanHomeOffsIdx,
    nSubIndex  := 0,
    pSrcBuf    := ADR(nHomeOffset),
    cbBufLen   := SIZEOF(nHomeOffset),
    bExecute   := NOT stMotionStage.bBusy AND (nHomeOffset &lt;&gt; nRecentHomeOffset)
  );

  ftFErrWinSetDone(CLK:=fbSetFErrorWin.bBusy);
  ftSoftLimMaxSetDone(CLK:=fbSetSoftLimMax.bBusy);
  ftSoftLimMinSetDone(CLK:=fbSetSoftLimMin.bBusy);
  ftHomeVeloFastSetDone(CLK:=fbSetHomeVeloFast.bBusy);
  ftHomeVeloSlowSetDone(CLK:=fbSetHomeVeloFast.bBusy);
  ftHomeAccSetDone(CLK:=fbSetHomeAcc.bBusy);
  ftHomeOffsSetDone(CLK:=fbSetHomeOffs.bBusy);

    IF ftFErrWinSetDone.Q OR ftSoftLimMaxSetDone.Q
        OR ftSoftLimMinSetDone.Q OR ftHomeVeloFastSetDone.Q
        OR ftHomeAccSetDone.Q OR ftHomeOffsSetDone.Q OR ftHomeVeloSlowSetDone.Q THEN
        IF fbSetFErrorWin.bError THEN
           stMotionStage.bError := fbSetFErrorWin.bError;
           stMotionStage.nErrorId := fbSetFErrorWin.nErrId;
        ELSIF fbSetSoftLimMin.bError THEN
           stMotionStage.bError := fbSetSoftLimMin.bError;
           stMotionStage.nErrorId := fbSetSoftLimMin.nErrId;
        ELSIF fbSetSoftLimMax.bError THEN
           stMotionStage.bError := fbSetSoftLimMax.bError;
           stMotionStage.nErrorId := fbSetSoftLimMax.nErrId;
        ELSIF fbSetHomeVeloFast.bError THEN
           stMotionStage.bError := fbSetHomeVeloFast.bError;
           stMotionStage.nErrorId := fbSetHomeVeloFast.nErrId;
        ELSIF fbSetHomeVeloSlow.bError THEN
           stMotionStage.bError := fbSetHomeVeloSlow.bError;
           stMotionStage.nErrorId := fbSetHomeVeloSlow.nErrId;
        ELSIF fbSetHomeAcc.bError THEN
           stMotionStage.bError := fbSetHomeAcc.bError;
           stMotionStage.nErrorId := fbSetHomeAcc.nErrId;
        ELSIF fbSetHomeOffs.bError THEN
           stMotionStage.bError := fbSetHomeOffs.bError;
           stMotionStage.nErrorId := fbSetHomeOffs.nErrId;
        ELSE
           nRecentFErrWin := nScaledFErrWin;
           nRecentSoftLimMax := nSoftLimMax;
           nRecentSoftLimMin := nSoftLimMin;
           nRecentHomeVeloFast :=nHomeVeloFast;
           nRecentHomeVeloSlow := nHomeVeloSlow;
           nRecentHomeAcc := nHomeAcc;
           nRecentHomeOffset := nHomeOffs;
        END_IF
        fbSetFErrorWin.bExecute := FALSE;
        fbSetSoftLimMin.bExecute := FALSE;
        fbSetSoftLimMax.bExecute := FALSE;
        fbSetHomeVeloFast.bExecute := FALSE;
        fbSetHomeVeloSlow.bExecute := FALSE;
        fbSetHomeAcc.bExecute := FALSE;
        fbSetHomeOffs.bExecute := FALSE;
    END_IF
END_IF
END_METHOD

METHOD UpdateEpicsStatus
VAR_INPUT
END_VAR
//////////////////////////////////////////////////////////////////
// Transfer NC parameter status to EPICS
//////////////////////////////////////////////////////////////////
stMotionStage.stAxisStatus.bEnable:=stMotionStage.bAllEnable;
stMotionStage.stAxisStatus.bEnabled:=stMotionStage.bEnableDone; // account for PowerEnable from power block
stMotionStage.stAxisStatus.bError:=stMotionStage.bError;
stMotionStage.stAxisStatus.bHomeSensor:=stMotionStage.bHome;
stMotionStage.stAxisStatus.bLimitBwd:=stMotionStage.bAllBackwardEnable;
stMotionStage.stAxisStatus.bLimitFwd:=stMotionStage.bAllForwardEnable;
stMotionStage.stAxisStatus.bReset:=stMotionStage.bReset;
stMotionStage.stAxisStatus.fAcceleration:=fMeasuredAcc;
stMotionStage.stAxisStatus.fActDiff:=stMotionStage.fPosDiff;
stMotionStage.stAxisStatus.fActPosition:=fMeasuredPos;
stMotionStage.stAxisStatus.fActVelocity:=fMeasuredVelo;
stMotionStage.stAxisStatus.fDeceleration:=fMeasuredAcc;
stMotionStage.stAxisStatus.fOverride:=THIS^.fbMcPower.Override;
stMotionStage.stAxisStatus.fPosition:=stMotionStage.fPosition;
stMotionStage.stAxisStatus.fVelocity:=stMotionStage.fVelocity;
stMotionStage.stAxisStatus.nCmdData:=INT_TO_UINT(stMotionStage.nCmdData);  //Or nCmdDataLocal
stMotionStage.stAxisStatus.nCommand:=INT_TO_UINT(stMotionStage.nCommand);  //Or nCommandLocal
stMotionStage.stAxisStatus.nErrorId:=stMotionStage.nErrorId;
stMotionStage.stAxisStatus.bBusy:=stMotionStage.bBusy;
stMotionStage.stAxisStatus.bHomed:=stMotionStage.bHomed;
stMotionStage.stAxisStatus.bExecute:=bLocalExec;
stMotionStage.stAxisStatus.nCommand:=3; // If this is not 3, the IOC stops updating positions during homing
END_METHOD

(*  MCS2 OL Step parameters update
    1- Step
    2- Step Amplitude
    3- StepFreq
*)
METHOD UpdateServoOffMotionParams
VAR_INPUT
    Enable : BOOL;
END_VAR

VAR_INST
    // Open Loop Operations
    {attribute &#39;hide&#39;}
    fbSetSteps                      : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetStepFreq           : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    fbSetStepAmp            : FB_EcCoESdoWrite;
    {attribute &#39;hide&#39;}
    nRecentSteps            : DINT;
    {attribute &#39;hide&#39;}
    nRecentStepAmp          : UINT;
    {attribute &#39;hide&#39;}
    nRecentStepFreq         : UINT;
    {attribute &#39;hide&#39;}
    ftStepAmpUpdateDone     : F_TRIG;
    {attribute &#39;hide&#39;}
    ftStepFreqUpdateDone    : F_TRIG;
    {attribute &#39;hide&#39;}
    ftStepUpdateDone        : F_TRIG;
END_VAR
IF Enable THEN
  ScaleServoOffMotionParams();
  fbSetSteps(
    sNetId     := stMotionStage.stAxisParameters.sAmsNetId,
    nSlaveAddr := stDS402Drive.nSlaveAddr,
    nIndex     := nChanStepIdx,
    nSubIndex  := 0,
    pSrcBuf    := ADR(nScalededSteps),
    cbBufLen   := SIZEOF(nChanStep),
    bExecute   := NOT stMotionStage.bBusy AND (nScalededSteps &lt;&gt; nRecentSteps)
  );
  fbSetStepAmp(
    sNetId     := stMotionStage.stAxisParameters.sAmsNetId,
    nSlaveAddr := stDS402Drive.nSlaveAddr,
    nIndex     := nChanStepAmpIdx,
    nSubIndex  := 0,
    pSrcBuf    := ADR(nScalededStepAmp),
    cbBufLen   := SIZEOF(nChanStepAmp),
    bExecute   := NOT stMotionStage.bBusy AND (nScalededStepAmp &lt;&gt; nRecentStepAmp)
  );
  fbSetStepFreq(
    sNetId     := stMotionStage.stAxisParameters.sAmsNetId,
    nSlaveAddr := stDS402Drive.nSlaveAddr,
    nIndex     := nChanStepFreqIdx,
    nSubIndex  := 0,
    pSrcBuf    := ADR(nScaledStepFreq),
    cbBufLen   := SIZEOF(nChanStepFreq),
    bExecute   := NOT stMotionStage.bBusy AND (nScaledStepFreq &lt;&gt; nRecentStepFreq)
  );
  ftStepUpdateDone(CLK:=fbSetSteps.bBusy);
  ftStepAmpUpdateDone(CLK:=fbSetStepAmp.bBusy);
  ftStepFreqUpdateDone(CLK:=fbSetStepFreq.bBusy);

    bStepModeparamsSetDone R= fbSetSteps.bBusy OR fbSetStepAmp.bBusy OR fbSetStepFreq.bBusy;
  IF ftStepUpdateDone.Q
        OR ftStepAmpUpdateDone.Q
        OR ftStepFreqUpdateDone.Q THEN
    IF fbSetSteps.bError THEN
            stMotionStage.bError := fbSetSteps.bError;
            stMotionStage.nErrorId := fbSetSteps.nErrId;
        ELSIF fbSetStepFreq.bError THEN
                stMotionStage.bError := fbSetStepFreq.bError;
                stMotionStage.nErrorId := fbSetStepFreq.nErrId;
        ELSIF fbSetStepAmp.bError THEN
                stMotionStage.bError := fbSetStepAmp.bError;
                stMotionStage.nErrorId := fbSetStepAmp.nErrId;
    ELSE
            nRecentSteps := nScalededSteps;
            nRecentStepAmp := nScalededStepAmp;
            nRecentStepFreq := nScaledStepFreq;
            bStepModeparamsSetDone S= TRUE;
    END_IF
        fbSetSteps.bExecute := FALSE;
        fbSetStepFreq.bExecute := FALSE;
        fbSetStepAmp.bExecute := FALSE;
    END_IF
END_IF
END_METHOD

METHOD WriteParameterNC
VAR_INPUT
    Execute:BOOL;
    ParameterNumber : MC_AxisParameter;
    ParameterValue  : LREAL;
END_VAR
(*Do not change a moving axis parameter*)
fbMcWriteParameter( Axis:=stMotionStage.Axis,
                    Execute:=(Execute AND stMotionStage.Axis.Status.NotMoving),
                    ParameterNumber:=ParameterNumber,
                    Value:=ParameterValue );
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-ds402opmode">E_DS402OpMode</a></p></li>
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></p></li>
<li><p><a class="reference internal" href="#e-module">E_Module</a></p></li>
<li><p><a class="reference internal" href="#e-movestate">E_MoveState</a></p></li>
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#fb-logmotionerror">FB_LogMotionError</a></p></li>
<li><p><a class="reference internal" href="#f-motionerrorcodelookup">F_MotionErrorCodeLookup</a></p></li>
<li><p><a class="reference internal" href="#st-ds402drive">ST_DS402Drive</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionstagenc">
<h2>FB_MotionStageNC<a class="headerlink" href="#fb-motionstagenc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionStageNC</span>
<span class="n">VAR</span>
    <span class="n">iMotionLogger</span> <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_copy&#39;</span><span class="p">}</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_copy&#39;</span><span class="p">}</span>
    <span class="n">stMotionEpicsItf</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">ST_MotionEpicsInterface</span><span class="p">;</span>
    <span class="n">iPersistentDataStorage</span> <span class="p">:</span> <span class="n">I_PersistentDataStorage</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Brakes</span> <span class="p">:</span> <span class="n">brake</span> <span class="n">fb</span> <span class="n">participate</span> <span class="ow">in</span> <span class="n">sync</span> <span class="n">comm</span> <span class="k">with</span> <span class="n">fbMotionDrive</span><span class="p">,</span> <span class="n">fbMotionAxis</span> <span class="ow">and</span> <span class="n">fbMotionInterlocks</span>
    <span class="n">fbBrake</span> <span class="p">:</span> <span class="n">FB_BrakeNC</span> <span class="o">:=</span> <span class="p">(</span><span class="n">BrakeMode</span> <span class="o">:=</span> <span class="n">E_StageBrakeMode</span><span class="o">.</span><span class="n">IF_MOVING</span><span class="p">);</span>
    <span class="o">//</span> <span class="n">common</span> <span class="n">interlocks</span>
    <span class="n">fbMotionInterlocksCommon</span> <span class="p">:</span> <span class="n">FB_MotionInterlocksCommon</span><span class="p">(</span><span class="n">iMotionLogger</span> <span class="o">:=</span> <span class="n">iMotionLogger</span><span class="p">);</span>
    <span class="o">//</span> <span class="n">stage</span> <span class="k">with</span> <span class="n">Limit</span> <span class="n">switches</span>
    <span class="n">fbLimSwStatus</span> <span class="p">:</span> <span class="n">FB_LimSwStatus</span><span class="p">();</span>
    <span class="n">fbMotionInterlocksLimSw</span> <span class="p">:</span> <span class="n">FB_MotionInterlocksLimSw</span> <span class="p">(</span> <span class="n">iMotionInterlocksCommon</span><span class="o">:=</span><span class="n">fbMotionInterlocksCommon</span><span class="p">,</span> <span class="n">iLimSwStatus</span><span class="o">:=</span><span class="n">fbLimSwStatus</span><span class="p">);</span>

    <span class="n">fbHome</span> <span class="p">:</span> <span class="n">FB_HomeNC</span><span class="p">(</span><span class="n">AxisRef</span><span class="o">:=</span><span class="n">AxisRef</span><span class="p">,</span> <span class="n">iMotionLogger</span><span class="o">:=</span><span class="n">iMotionLogger</span><span class="p">,</span> <span class="n">iLimSwStatus</span><span class="o">:=</span><span class="n">fbLimSwStatus</span><span class="p">);;</span>
    <span class="n">fbHalt</span> <span class="p">:</span> <span class="n">FB_HaltNC</span><span class="p">(</span><span class="n">AxisRef</span><span class="o">:=</span><span class="n">AxisRef</span><span class="p">);</span>
    <span class="n">fbPower</span> <span class="p">:</span> <span class="n">FB_PowerNC</span><span class="p">(</span><span class="n">AxisRef</span><span class="o">:=</span><span class="n">AxisRef</span><span class="p">);</span>
    <span class="n">fbReset</span> <span class="p">:</span> <span class="n">FB_ResetNC</span><span class="p">(</span><span class="n">AxisRef</span><span class="o">:=</span><span class="n">AxisRef</span><span class="p">);</span>
    <span class="n">fbMoveAbsolute</span> <span class="p">:</span> <span class="n">FB_MoveAbsoluteNC</span><span class="p">(</span><span class="n">AxisRef</span><span class="o">:=</span><span class="n">AxisRef</span><span class="p">);</span>
    <span class="n">fbAxisStatus</span> <span class="p">:</span> <span class="n">FB_AxisStatusNC</span><span class="p">(</span><span class="n">AxisRef</span><span class="o">:=</span><span class="n">AxisRef</span><span class="p">);</span>

    <span class="n">fbReadParameter</span> <span class="p">:</span> <span class="n">FB_ReadParameterNC</span><span class="p">(</span><span class="n">AxisRef</span><span class="o">:=</span><span class="n">AxisRef</span><span class="p">);</span>
    <span class="n">fbWriteParameter</span>  <span class="p">:</span> <span class="n">FB_WriteParameterNC</span><span class="p">(</span><span class="n">AxisRef</span><span class="o">:=</span><span class="n">AxisRef</span><span class="p">);</span>
    <span class="n">fbParamsSaveRestore</span><span class="p">:</span> <span class="n">FB_ParamsSaveRestoreNC</span><span class="p">(</span><span class="n">AxisRef</span><span class="o">:=</span><span class="n">AxisRef</span><span class="p">,</span> <span class="n">iPersistentDataStorage</span> <span class="o">:=</span> <span class="n">iPersistentDataStorage</span><span class="p">);</span>
    <span class="n">fbEncoderScaling</span> <span class="p">:</span> <span class="n">FB_EncoderScaling</span><span class="p">();</span>

    <span class="n">fbBacklashCompensation</span> <span class="p">:</span> <span class="n">FB_BacklashCompensationNC</span><span class="p">(</span><span class="n">AxisRef</span><span class="o">:=</span><span class="n">AxisRef</span><span class="p">);</span>
    <span class="p">(</span><span class="o">*</span><span class="n">The</span> <span class="n">axis</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">a</span> <span class="n">interlock</span> <span class="n">reference</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">instance</span><span class="p">:</span> <span class="n">this</span> <span class="n">would</span> <span class="n">make</span> <span class="n">calling</span> <span class="n">method</span>
      <span class="n">to</span> <span class="n">transfer</span> <span class="n">power</span> <span class="n">status</span> <span class="kn">from</span><span class="w"> </span><span class="nn">interlock</span> <span class="n">interface</span> <span class="n">override</span> <span class="n">the</span> <span class="n">internal</span> <span class="n">passing</span> <span class="n">of</span> <span class="n">power</span> <span class="n">enable</span> <span class="n">status</span>
      <span class="n">the</span> <span class="n">powerenables</span><span class="p">()</span> <span class="ow">is</span> <span class="n">provided</span> <span class="ow">in</span> <span class="n">case</span> <span class="n">the</span> <span class="n">interlock</span> <span class="n">status</span> <span class="n">were</span> <span class="n">passed</span> <span class="n">via</span> <span class="n">the</span> <span class="n">drive</span>
      <span class="n">nonetheless</span> <span class="n">passing</span> <span class="n">via</span> <span class="n">this</span> <span class="nb">object</span> <span class="ow">is</span> <span class="n">more</span> <span class="n">flexible</span>
    <span class="o">*</span><span class="p">)</span>
    <span class="n">fbMotionAxis</span> <span class="p">:</span> <span class="n">FB_MotionAxisNC</span><span class="p">(</span>         <span class="n">iHome</span> <span class="o">:=</span> <span class="n">fbHome</span><span class="p">,</span>
                                        <span class="n">iHalt</span> <span class="o">:=</span> <span class="n">fbHalt</span><span class="p">,</span>
                                        <span class="n">iPower</span> <span class="o">:=</span> <span class="n">fbPower</span><span class="p">,</span>
                                        <span class="n">iReset</span> <span class="o">:=</span> <span class="n">fbReset</span><span class="p">,</span>
                                        <span class="n">iMoveAbsolute</span> <span class="o">:=</span> <span class="n">fbMoveAbsolute</span><span class="p">,</span>
                                        <span class="n">iReadParameter</span> <span class="o">:=</span> <span class="n">fbReadParameter</span><span class="p">,</span>
                                        <span class="n">iWriteParameter</span>  <span class="o">:=</span> <span class="n">fbWriteParameter</span><span class="p">,</span>
                                        <span class="n">iParamSaveRestore</span><span class="o">:=</span> <span class="n">fbParamsSaveRestore</span><span class="p">,</span>
                                        <span class="n">iEncoderScaling</span> <span class="o">:=</span> <span class="n">fbEncoderScaling</span><span class="p">,</span>
                                        <span class="n">iAxisStatus</span> <span class="o">:=</span> <span class="n">fbAxisStatus</span><span class="p">,</span>
                                        <span class="n">iBacklashCompensation</span> <span class="o">:=</span><span class="n">fbBacklashCompensation</span><span class="p">,</span>
                                    <span class="p">);</span>
  <span class="o">//</span>
  <span class="n">fbMotionDrive</span><span class="p">:</span> <span class="n">FB_MotionDrive</span> <span class="p">(</span>   <span class="n">stMotionEpicsItf</span> <span class="o">:=</span> <span class="n">stMotionEpicsItf</span><span class="p">,</span>
                                       <span class="n">iBrake</span><span class="o">:=</span><span class="n">fbBrake</span><span class="p">,</span>
                                       <span class="n">iMotionLogger</span><span class="o">:=</span><span class="n">iMotionLogger</span><span class="p">,</span>
                                       <span class="n">iMotionInterlocks</span><span class="o">:=</span><span class="n">fbMotionInterlocksLimSw</span><span class="p">,</span>
                                       <span class="n">iMotionAxis</span> <span class="o">:=</span> <span class="n">fbMotionAxis</span>
                                   <span class="p">)</span> <span class="p">;</span>
    <span class="o">//</span> <span class="n">Drive</span> <span class="n">Name</span>
    <span class="n">sName</span> <span class="p">:</span> <span class="n">T_MaxString</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbMotionInterlocksCommon</span><span class="p">();</span>
<span class="n">fbLimSwStatus</span><span class="p">();</span>
<span class="n">fbMotionInterlocksLimSw</span><span class="p">();</span>
<span class="n">fbReset</span><span class="p">();</span>
<span class="n">fbHalt</span><span class="p">();</span>
<span class="n">fbPower</span><span class="p">();</span>
<span class="n">fbHome</span><span class="p">();</span>
<span class="n">fbBacklashCompensation</span><span class="p">();</span>
<span class="n">fbMoveAbsolute</span><span class="p">();</span>
<span class="n">fbReadParameter</span><span class="p">();</span>
<span class="n">fbWriteParameter</span><span class="p">();</span>
<span class="n">fbParamsSaveRestore</span><span class="p">();</span>
<span class="n">fbAxisStatus</span><span class="p">();</span>
<span class="n">fbMotionAxis</span><span class="p">();</span>
<span class="n">fbMotionDrive</span><span class="p">();</span>
<span class="n">fbEncoderScaling</span><span class="p">();</span>
<span class="n">fbBrake</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">CallAfterInit</span>
<span class="n">fbMotionInterlocksCommon</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">iMotionLogger</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span><span class="p">);</span>
<span class="o">//</span><span class="n">fbLimSwStatus</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">iMotionLogger</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span><span class="p">);</span>
<span class="n">fbMotionInterlocksLimSw</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">iMotionInterlocksCommon</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMotionInterlocksCommon</span><span class="p">,</span>
                                      <span class="n">iLimSwStatus</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbLimSwStatus</span><span class="p">);</span>
<span class="n">fbHome</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">,</span>
                       <span class="n">iMotionLogger</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span><span class="p">,</span>
                       <span class="n">iLimSwStatus</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbLimSwStatus</span><span class="p">);</span>
<span class="n">fbHalt</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">);</span>
<span class="n">fbPower</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">);</span>
<span class="n">fbReset</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">);</span>
<span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">);</span>


<span class="n">fbReadParameter</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">AxisRef</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">);</span>
<span class="n">fbWriteParameter</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">AxisRef</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">);</span>
<span class="n">fbParamsSaveRestore</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span>  <span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">,</span>
                                     <span class="n">iPersistentDataStorage</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iPersistentDataStorage</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Pass</span> <span class="n">correctly</span> <span class="n">initialized</span> <span class="n">Motion</span> <span class="n">axis</span> <span class="n">status</span> <span class="n">dependencies</span>
<span class="n">fbAxisStatus</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">);</span>
<span class="n">fbBacklashCompensation</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Pass</span> <span class="n">correctly</span> <span class="n">initialized</span> <span class="n">Motion</span> <span class="n">axis</span> <span class="n">dependencies</span>
<span class="n">fbMotionAxis</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span><span class="n">iHome</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbHome</span><span class="p">,</span>
                             <span class="n">iHalt</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbHalt</span><span class="p">,</span>
                             <span class="n">iPower</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbPower</span><span class="p">,</span>
                             <span class="n">iReset</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbReset</span><span class="p">,</span>
                             <span class="n">iMoveAbsolute</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMoveAbsolute</span><span class="p">,</span>
                             <span class="n">iReadParameter</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbReadParameter</span><span class="p">,</span>
                             <span class="n">iWriteParameter</span>  <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbWriteParameter</span><span class="p">,</span>
                             <span class="n">iParamSaveRestore</span><span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbParamsSaveRestore</span><span class="p">,</span>
                             <span class="n">iEncoderScaling</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbEncoderScaling</span><span class="p">,</span>
                             <span class="n">iAxisStatus</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbAxisStatus</span><span class="p">,</span>
                             <span class="n">iBacklashCompensation</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbBacklashCompensation</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Pass</span> <span class="n">correctly</span> <span class="n">initialized</span> <span class="n">drive</span> <span class="n">dependencies</span>
<span class="n">fbMotionDrive</span><span class="o">.</span><span class="n">CallAfterInit</span><span class="p">(</span> <span class="n">stMotionEpicsItf</span><span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stMotionEpicsItf</span><span class="p">,</span>
                             <span class="n">iBrake</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">fbBrake</span><span class="p">,</span>
                             <span class="n">iMotionInterlocks</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">fbMotionInterlocksLimSw</span><span class="p">,</span>
                             <span class="n">iMotionLogger</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span><span class="p">,</span>
                             <span class="n">iMotionAxis</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">fbMotionAxis</span> <span class="p">);</span>

<span class="n">THIS</span><span class="o">^.</span><span class="n">stMotionEpicsItf</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">sName</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">iMotionLogger</span> <span class="p">:</span> <span class="n">I_MotionLogger</span><span class="p">;</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">stMotionEpicsItf</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">ST_MotionEpicsInterface</span><span class="p">;</span>
    <span class="n">iPersistentDataStorage</span> <span class="p">:</span> <span class="n">I_PersistentDataStorage</span><span class="p">;</span>
    <span class="n">sName</span> <span class="p">:</span> <span class="n">T_MaxString</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iMotionLogger</span> <span class="o">:=</span> <span class="n">iMotionLogger</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iPersistentDataStorage</span> <span class="o">:=</span> <span class="n">iPersistentDataStorage</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">stMotionEpicsItf</span> <span class="n">REF</span><span class="o">=</span><span class="n">stMotionEpicsItf</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">sName</span> <span class="o">:=</span> <span class="n">sName</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">BrakeMode</span> <span class="p">:</span> <span class="n">E_StageBrakeMode</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">BrakeMode</span> <span class="o">:=</span> <span class="n">fbBrake</span><span class="o">.</span><span class="n">BrakeMode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">BrakeMode</span> <span class="p">:</span> <span class="n">E_StageBrakeMode</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">fbBrake</span><span class="o">.</span><span class="n">BrakeMode</span> <span class="o">:=</span> <span class="n">BrakeMode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">EnableMode</span> <span class="p">:</span> <span class="n">E_StageEnableMode</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">EnableMode</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMotionDrive</span><span class="o">.</span><span class="n">EnableMode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">EnableMode</span> <span class="p">:</span> <span class="n">E_StageEnableMode</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">fbMotionDrive</span><span class="o">.</span><span class="n">EnableMode</span> <span class="o">:=</span> <span class="n">EnableMode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">HomeMode</span> <span class="p">:</span> <span class="n">E_EpicsHomeCmd</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">HomeMode</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Mode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">HomeMode</span> <span class="p">:</span> <span class="n">E_EpicsHomeCmd</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Mode</span> <span class="o">:=</span> <span class="n">HomeMode</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#e-stagebrakemode">E_StageBrakeMode</a></p></li>
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#fb-axisstatusnc">FB_AxisStatusNC</a></p></li>
<li><p><a class="reference internal" href="#fb-backlashcompensationnc">FB_BacklashCompensationNC</a></p></li>
<li><p><a class="reference internal" href="#fb-brakenc">FB_BrakeNC</a></p></li>
<li><p><a class="reference internal" href="#fb-encoderscaling">FB_EncoderScaling</a></p></li>
<li><p><a class="reference internal" href="#fb-haltnc">FB_HaltNC</a></p></li>
<li><p><a class="reference internal" href="#fb-homenc">FB_HomeNC</a></p></li>
<li><p><a class="reference internal" href="#fb-limswstatus">FB_LimSwStatus</a></p></li>
<li><p><a class="reference internal" href="#fb-motionaxisnc">FB_MotionAxisNC</a></p></li>
<li><p><a class="reference internal" href="#fb-motiondrive">FB_MotionDrive</a></p></li>
<li><p><a class="reference internal" href="#fb-motioninterlockscommon">FB_MotionInterlocksCommon</a></p></li>
<li><p><a class="reference internal" href="#fb-motioninterlockslimsw">FB_MotionInterlocksLimSw</a></p></li>
<li><p><a class="reference internal" href="#fb-moveabsolutenc">FB_MoveAbsoluteNC</a></p></li>
<li><p><a class="reference internal" href="#fb-paramssaverestorenc">FB_ParamsSaveRestoreNC</a></p></li>
<li><p><a class="reference internal" href="#fb-powernc">FB_PowerNC</a></p></li>
<li><p><a class="reference internal" href="#fb-readparameternc">FB_ReadParameterNC</a></p></li>
<li><p><a class="reference internal" href="#fb-resetnc">FB_ResetNC</a></p></li>
<li><p><a class="reference internal" href="#fb-writeparameternc">FB_WriteParameterNC</a></p></li>
<li><p><a class="reference internal" href="#st-motionepicsinterface">ST_MotionEpicsInterface</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionstagencparams">
<h2>FB_MotionStageNCParams<a class="headerlink" href="#fb-motionstagencparams" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionStageNCParams</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Read</span> <span class="ow">and</span> <span class="n">refresh</span> <span class="n">axis</span> <span class="n">parameters</span> <span class="n">struct</span> <span class="n">on</span> <span class="n">ST_MotionStage</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tRefreshDelay</span><span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">mcReadParams</span><span class="p">:</span> <span class="n">MC_ReadParameterSet</span><span class="p">;</span>
    <span class="n">timer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nLatchErrId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">timer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bEnable</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">tRefreshDelay</span><span class="p">);</span>
<span class="n">bExecute</span> <span class="n">S</span><span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">mcReadParams</span><span class="p">(</span>
    <span class="n">Parameter</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bEnable</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span><span class="n">bError</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Copy</span> <span class="n">axis</span> <span class="n">parameters</span> <span class="n">that</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">expose</span> <span class="n">to</span> <span class="n">the</span> <span class="n">EPICS</span> <span class="n">layer</span><span class="o">.</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">bCtrlEnablePosDiffControl</span>     <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bCtrlEnablePosDiffControl</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">bEncEnableSoftEndMaxControl</span>   <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bEncEnableSoftEndMaxControl</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">bEncEnableSoftEndMinControl</span>   <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bEncEnableSoftEndMinControl</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fAccelerationMax</span>              <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fAccelerationMax</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fCtrlPosDiffMax</span>               <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fCtrlPosDiffMax</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fCtrlPosDiffMaxTime</span>           <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fCtrlPosDiffMaxTime</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fDecelerationMax</span>              <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fDecelerationMax</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncSoftEndMax</span>                <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncSoftEndMax</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncSoftEndMin</span>                <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncSoftEndMin</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fVeloMaximum</span>                  <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fVeloMaximum</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncOffset</span>                            <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncOffset</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParametersExposed</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span>       <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">mcReadParams</span><span class="o">.</span><span class="n">ErrorID</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">nLatchErrId</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">bExecute</span> <span class="n">R</span><span class="o">=</span> <span class="n">mcReadParams</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">mcReadParams</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAxisParamsInit</span> <span class="n">S</span><span class="o">=</span> <span class="n">mcReadParams</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionstagesetandmovehelper">
<h2>FB_MotionStageSetAndMoveHelper<a class="headerlink" href="#fb-motionstagesetandmovehelper" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionStageSetAndMoveHelper</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Begin</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">stop</span> <span class="n">on</span> <span class="n">falling</span> <span class="n">edge</span><span class="o">.</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">position</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">to</span>
    <span class="n">fStartPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">goal</span> <span class="n">to</span> <span class="n">move</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">towards</span>
    <span class="n">fGoalPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">velocity</span> <span class="n">to</span> <span class="n">move</span> <span class="n">at</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">allowable</span> <span class="n">deviation</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">goal</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">considered</span> <span class="n">done</span> <span class="n">moving</span><span class="o">.</span>
    <span class="n">fDelta</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">no</span> <span class="n">errors</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">deactivated</span><span class="o">.</span>
    <span class="n">bResetDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="nb">set</span> <span class="n">position</span> <span class="n">completes</span><span class="o">.</span>
    <span class="n">bSetDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">begins</span> <span class="n">moving</span><span class="o">.</span>
    <span class="n">bMotionStarted</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">reaches</span> <span class="n">its</span> <span class="n">destination</span><span class="o">.</span>
    <span class="n">bMoveDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">mcSetPos</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">NEVER</span><span class="p">;</span>
    <span class="n">mcSetPos</span><span class="p">(</span>
        <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
        <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span>
    <span class="p">);</span>
    <span class="n">bResetDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bSetDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bMotionStarted</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bMoveDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bResetDone</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">bMoveDone</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span> <span class="o">&lt;=</span> <span class="n">fGoalPosition</span> <span class="o">+</span> <span class="n">fDelta</span> <span class="n">AND</span>
             <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span> <span class="o">&gt;=</span> <span class="n">fGoalPosition</span> <span class="o">-</span> <span class="n">fDelta</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&lt;&gt;</span> <span class="n">fStartPosition</span> <span class="n">THEN</span>
        <span class="n">mcSetPos</span><span class="p">(</span>
            <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">Execute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Execute</span><span class="p">,</span>
            <span class="n">Position</span><span class="o">:=</span><span class="n">fStartPosition</span><span class="p">,</span>
            <span class="n">Mode</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
            <span class="n">Done</span><span class="o">=&gt;</span>
        <span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">bSetDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMotionStarted</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Disabled</span> <span class="n">THEN</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fGoalPosition</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">fVelocity</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bMotionStarted</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bMoveDone</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">Reset</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>

<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">NEVER</span><span class="p">;</span>
<span class="n">mcSetPos</span><span class="p">(</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span>
<span class="p">);</span>
<span class="n">bResetDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">bSetDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">bMotionStarted</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">bMoveDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionstagesethelper">
<h2>FB_MotionStageSetHelper<a class="headerlink" href="#fb-motionstagesethelper" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionStageSetHelper</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Begin</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">stop</span> <span class="n">on</span> <span class="n">falling</span> <span class="n">edge</span><span class="o">.</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">position</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">to</span>
    <span class="n">fStartPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">no</span> <span class="n">errors</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">deactivated</span><span class="o">.</span>
    <span class="n">bResetDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="nb">set</span> <span class="n">position</span> <span class="n">completes</span><span class="o">.</span>
    <span class="n">bSetDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">mcSetPos</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">stSetPositionOptions</span> <span class="p">:</span> <span class="n">ST_SetPositionOptions</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">NEVER</span><span class="p">;</span>
    <span class="n">mcSetPos</span><span class="p">(</span>
        <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
        <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span>
    <span class="p">);</span>
    <span class="n">bResetDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bSetDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bResetDone</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bResetDone</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span> <span class="o">&lt;&gt;</span> <span class="n">fStartPosition</span> <span class="n">THEN</span>
        <span class="n">stSetPositionOptions</span><span class="o">.</span><span class="n">ClearPositionLag</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">mcSetPos</span><span class="p">(</span>
            <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">Execute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Execute</span><span class="p">,</span>
            <span class="n">Position</span><span class="o">:=</span><span class="n">fStartPosition</span><span class="p">,</span>
            <span class="n">Mode</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
            <span class="n">Options</span><span class="o">:=</span><span class="n">stSetPositionOptions</span><span class="p">,</span>
            <span class="n">Done</span><span class="o">=&gt;</span>
        <span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">bSetDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionstagesim">
<h2>FB_MotionStageSim<a class="headerlink" href="#fb-motionstagesim" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionStageSim</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Set</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">values</span> <span class="n">needed</span> <span class="k">for</span> <span class="n">a</span> <span class="n">fake</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">be</span> <span class="n">movable</span>
    <span class="n">via</span> <span class="n">the</span> <span class="n">IOC</span><span class="p">,</span> <span class="n">then</span> <span class="n">call</span> <span class="n">FB_MotionStage</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nEnableMode</span><span class="p">:</span> <span class="n">E_StageEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Stand</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">no</span> <span class="n">forward</span> <span class="n">limit</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Stand</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">no</span> <span class="n">reverse</span> <span class="n">limit</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Stand</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">no</span> <span class="n">STO</span> <span class="n">button</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Stand</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">no</span> <span class="n">PMPS</span> <span class="n">governer</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Always</span> <span class="n">keep</span> <span class="n">it</span> <span class="n">enabled</span> <span class="k">for</span> <span class="n">testing</span> <span class="n">ease</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">nEnableMode</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Call</span> <span class="n">FB_MotionStage</span> <span class="n">to</span> <span class="n">do</span> <span class="n">the</span> <span class="n">thing</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionvirtualframe">
<h2>FB_MotionVirtualFrame<a class="headerlink" href="#fb-motionvirtualframe" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionVirtualFrame</span>
<span class="p">(</span><span class="o">*</span>
<span class="n">Takes</span> <span class="mi">3</span> <span class="n">ST_MotionStages</span> <span class="n">representing</span> <span class="n">real</span> <span class="n">axes</span> <span class="n">that</span> <span class="n">are</span> <span class="n">orthogonal</span> <span class="n">to</span> <span class="n">each</span> <span class="n">other</span> <span class="ow">and</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">base</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span><span class="o">.</span>
<span class="n">Takes</span> <span class="mi">3</span> <span class="n">ST_MotionStages</span> <span class="n">representing</span> <span class="n">virtual</span> <span class="n">axes</span> <span class="n">that</span> <span class="n">are</span> <span class="n">orthogonal</span> <span class="n">to</span> <span class="n">each</span> <span class="n">other</span> <span class="ow">and</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">new</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span><span class="o">.</span>
<span class="n">Computes</span> <span class="n">the</span> <span class="n">transformation</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">base</span> <span class="n">to</span> <span class="n">the</span> <span class="n">new</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span> <span class="n">using</span> <span class="mi">3</span> <span class="n">euler</span> <span class="n">angles</span> <span class="ow">and</span> <span class="n">a</span> <span class="n">rotation</span> <span class="n">order</span>
<span class="k">as</span> <span class="n">inputs</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span><span class="p">,</span> <span class="n">the</span> <span class="n">order</span> <span class="ow">and</span> <span class="n">angles</span> <span class="n">are</span> <span class="n">interpreted</span> <span class="k">as</span> <span class="n">going</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">base</span> <span class="n">to</span> <span class="n">the</span> <span class="n">virtual</span> <span class="n">frame</span><span class="o">.</span> <span class="n">Can</span> <span class="n">be</span>
<span class="n">switched</span> <span class="n">to</span> <span class="n">go</span> <span class="kn">from</span><span class="w"> </span><span class="nn">virtual</span> <span class="n">to</span> <span class="n">base</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span><span class="o">.</span>
<span class="n">If</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">will</span> <span class="n">automatically</span> <span class="n">handle</span> <span class="n">commanding</span> <span class="n">the</span> <span class="n">real</span> <span class="n">axes</span> <span class="n">to</span> <span class="n">move</span> <span class="n">when</span> <span class="n">the</span> <span class="n">virtual</span> <span class="n">axes</span>
<span class="n">are</span> <span class="n">commanded</span> <span class="n">to</span> <span class="n">move</span><span class="o">.</span> <span class="n">If</span> <span class="ow">not</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">the</span> <span class="n">function</span> <span class="n">block</span> <span class="n">acts</span> <span class="k">as</span> <span class="n">a</span> <span class="n">calculator</span><span class="p">,</span> <span class="n">outputing</span> <span class="n">the</span> <span class="n">results</span> <span class="n">of</span>
<span class="n">calculating</span> <span class="n">motions</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">new</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span><span class="p">,</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">changing</span> <span class="nb">any</span> <span class="n">setpoints</span> <span class="ow">or</span> <span class="n">commanding</span> <span class="nb">any</span> <span class="n">moves</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStageRx</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span> <span class="o">//</span> <span class="n">Real</span> <span class="n">X</span> <span class="n">Axis</span> <span class="ow">in</span> <span class="n">base</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span>
    <span class="n">stMotionStageRy</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span> <span class="o">//</span> <span class="n">Real</span> <span class="n">Y</span> <span class="n">Axis</span> <span class="ow">in</span> <span class="n">base</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span>
    <span class="n">stMotionStageRz</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span> <span class="o">//</span> <span class="n">Real</span> <span class="n">Z</span> <span class="n">Axis</span> <span class="ow">in</span> <span class="n">base</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span>
    <span class="n">stMotionStageVx</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span> <span class="o">//</span> <span class="n">Virtual</span> <span class="n">X</span> <span class="n">Axis</span> <span class="ow">in</span> <span class="n">new</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span>
    <span class="n">stMotionStageVy</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span> <span class="o">//</span> <span class="n">Virtual</span> <span class="n">Y</span> <span class="n">Axis</span> <span class="ow">in</span> <span class="n">new</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span>
    <span class="n">stMotionStageVz</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span> <span class="o">//</span> <span class="n">Virtual</span> <span class="n">Z</span> <span class="n">Axis</span> <span class="ow">in</span> <span class="n">new</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="p">(</span><span class="o">*</span><span class="n">TRUE</span> <span class="n">to</span> <span class="n">automatically</span> <span class="n">overwrite</span> <span class="n">real</span> <span class="n">axis</span> <span class="n">setpoints</span> <span class="ow">and</span> <span class="n">command</span> <span class="n">moves</span><span class="o">.</span>
      <span class="n">FALSE</span> <span class="n">to</span> <span class="n">use</span> <span class="n">this</span> <span class="n">function</span> <span class="n">only</span> <span class="k">as</span> <span class="n">a</span> <span class="n">calculator</span><span class="o">.*</span><span class="p">)</span>
    <span class="n">bEnable</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fAlphaDegrees</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Angle</span> <span class="n">of</span> <span class="n">rotation</span> <span class="n">about</span> <span class="n">first</span> <span class="n">axis</span><span class="o">.</span>
    <span class="n">fBetaDegrees</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Angle</span> <span class="n">of</span> <span class="n">rotation</span> <span class="n">about</span> <span class="n">second</span> <span class="n">axis</span><span class="o">.</span>
    <span class="n">fGammaDegrees</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Angle</span> <span class="n">of</span> <span class="n">rotation</span> <span class="n">about</span> <span class="n">third</span> <span class="n">axis</span><span class="o">.</span>
    <span class="p">(</span><span class="o">*</span><span class="n">Rotation</span> <span class="n">Order</span><span class="o">.</span> <span class="n">E</span><span class="o">.</span><span class="n">g</span><span class="p">:</span> <span class="n">XYZ</span> <span class="n">to</span> <span class="n">rotate</span> <span class="n">alpha</span> <span class="n">degrees</span> <span class="n">around</span> <span class="n">X</span> <span class="n">axis</span><span class="p">,</span> <span class="n">beta</span> <span class="n">degrees</span> <span class="n">around</span> <span class="n">Y</span> <span class="n">axis</span><span class="p">,</span>
      <span class="ow">and</span> <span class="n">gamma</span> <span class="n">degrees</span> <span class="n">around</span> <span class="n">Z</span> <span class="n">axis</span><span class="o">.</span> <span class="n">Valid</span> <span class="n">rotation</span> <span class="n">orders</span> <span class="n">are</span><span class="p">:</span>
      <span class="n">YZY</span><span class="p">,</span> <span class="n">YXY</span><span class="p">,</span> <span class="n">ZYZ</span><span class="p">,</span> <span class="n">ZXZ</span><span class="p">,</span> <span class="n">XYX</span><span class="p">,</span> <span class="n">XZX</span><span class="p">,</span> <span class="n">XYZ</span><span class="p">,</span> <span class="n">YZX</span><span class="p">,</span> <span class="n">ZXY</span><span class="p">,</span> <span class="n">XZY</span><span class="p">,</span> <span class="n">ZYX</span><span class="p">,</span> <span class="n">YXZ</span><span class="o">.</span>
      <span class="n">Default</span> <span class="n">order</span> <span class="k">for</span> <span class="n">empty</span> <span class="ow">or</span> <span class="n">invalid</span> <span class="nb">input</span> <span class="ow">is</span><span class="p">:</span> <span class="n">ZYX</span><span class="o">.*</span><span class="p">)</span>
    <span class="n">sOrder</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">FALSE</span> <span class="n">to</span> <span class="n">define</span> <span class="n">inputs</span> <span class="k">as</span> <span class="n">rotating</span> <span class="n">the</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">new</span> <span class="n">frame</span> <span class="n">to</span> <span class="n">the</span> <span class="n">base</span> <span class="n">frame</span><span class="o">.</span>
      <span class="n">TRUE</span> <span class="n">to</span> <span class="n">define</span> <span class="n">the</span> <span class="n">inputs</span> <span class="k">as</span> <span class="n">rotating</span> <span class="n">the</span> <span class="n">frame</span> <span class="n">of</span> <span class="n">reference</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">base</span> <span class="kn">from</span><span class="w"> </span><span class="nn">to</span> <span class="n">the</span> <span class="n">new</span> <span class="n">frame</span><span class="o">.*</span><span class="p">)</span>
    <span class="n">bBaseToNew</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">fbVirtActPositionVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbVirtActVelocityVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbVirtActAcceleraVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>

    <span class="n">fbRealTarPositionVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbRealTarVelocityVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbRealTarAcceleraVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fAlphaRadians</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fBetaRadians</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fGammaRadians</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="n">rtExecuteVx</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtExecuteVy</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtExecuteVz</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="n">fbRealActPositionVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbRealActVelocityVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbRealActAcceleraVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>

    <span class="n">sOrderReversed</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">sLeft</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">sMid</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">sRight</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

    <span class="n">fbVirtTarPositionVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbVirtTarVelocityVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbVirtTarAcceleraVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fAlphaRadians</span> <span class="o">:=</span> <span class="n">DegToRad</span><span class="p">(</span><span class="n">fAlphaDegrees</span><span class="p">);</span>
<span class="n">fBetaRadians</span> <span class="o">:=</span> <span class="n">DegToRad</span><span class="p">(</span><span class="n">fBetaDegrees</span><span class="p">);</span>
<span class="n">fGammaRadians</span> <span class="o">:=</span> <span class="n">DegToRad</span><span class="p">(</span><span class="n">fGammaDegrees</span><span class="p">);</span>

<span class="n">rtExecuteVx</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>
<span class="n">rtExecuteVy</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>
<span class="n">rtExecuteVz</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>

<span class="n">fbRealActPositionVec3</span><span class="o">.</span><span class="n">x</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">;</span>
<span class="n">fbRealActPositionVec3</span><span class="o">.</span><span class="n">y</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">;</span>
<span class="n">fbRealActPositionVec3</span><span class="o">.</span><span class="n">z</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">;</span>

<span class="n">fbRealActVelocityVec3</span><span class="o">.</span><span class="n">x</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActVelo</span><span class="p">;</span>
<span class="n">fbRealActVelocityVec3</span><span class="o">.</span><span class="n">y</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActVelo</span><span class="p">;</span>
<span class="n">fbRealActVelocityVec3</span><span class="o">.</span><span class="n">z</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActVelo</span><span class="p">;</span>

<span class="n">fbRealActAcceleraVec3</span><span class="o">.</span><span class="n">x</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActAcc</span><span class="p">;</span>
<span class="n">fbRealActAcceleraVec3</span><span class="o">.</span><span class="n">y</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActAcc</span><span class="p">;</span>
<span class="n">fbRealActAcceleraVec3</span><span class="o">.</span><span class="n">z</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActAcc</span><span class="p">;</span>

<span class="n">sOrderReversed</span> <span class="o">:=</span> <span class="n">ReverseOrder</span><span class="p">(</span><span class="n">sOrder</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bBaseToNew</span> <span class="n">THEN</span>
    <span class="n">RotatePosVelAccFrame</span><span class="p">(</span>
        <span class="n">fbBaseFramePositionVec3</span> <span class="o">:=</span> <span class="n">fbRealActPositionVec3</span><span class="p">,</span>
        <span class="n">fbBaseFrameVelocityVec3</span> <span class="o">:=</span> <span class="n">fbRealActVelocityVec3</span><span class="p">,</span>
        <span class="n">fbBaseFrameAcceleraVec3</span> <span class="o">:=</span> <span class="n">fbRealActAcceleraVec3</span><span class="p">,</span>
        <span class="n">fbNewFramePositionVec3</span> <span class="o">=&gt;</span> <span class="n">fbVirtActPositionVec3</span><span class="p">,</span>
        <span class="n">fbNewFrameVelocityVec3</span> <span class="o">=&gt;</span> <span class="n">fbVirtActVelocityVec3</span><span class="p">,</span>
        <span class="n">fbNewFrameAcceleraVec3</span> <span class="o">=&gt;</span> <span class="n">fbVirtActAcceleraVec3</span><span class="p">,</span>
        <span class="n">fAlphaRadians</span> <span class="o">:=</span> <span class="n">fAlphaRadians</span><span class="p">,</span>
        <span class="n">fBetaRadians</span> <span class="o">:=</span> <span class="n">fBetaRadians</span><span class="p">,</span>
        <span class="n">fGammaRadians</span> <span class="o">:=</span> <span class="n">fGammaRadians</span><span class="p">,</span>
        <span class="n">sOrder</span> <span class="o">:=</span> <span class="n">sOrder</span>
    <span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">RotatePosVelAccFrame</span><span class="p">(</span>
        <span class="n">fbBaseFramePositionVec3</span> <span class="o">:=</span> <span class="n">fbRealActPositionVec3</span><span class="p">,</span>
        <span class="n">fbBaseFrameVelocityVec3</span> <span class="o">:=</span> <span class="n">fbRealActVelocityVec3</span><span class="p">,</span>
        <span class="n">fbBaseFrameAcceleraVec3</span> <span class="o">:=</span> <span class="n">fbRealActAcceleraVec3</span><span class="p">,</span>
        <span class="n">fbNewFramePositionVec3</span> <span class="o">=&gt;</span> <span class="n">fbVirtActPositionVec3</span><span class="p">,</span>
        <span class="n">fbNewFrameVelocityVec3</span> <span class="o">=&gt;</span> <span class="n">fbVirtActVelocityVec3</span><span class="p">,</span>
        <span class="n">fbNewFrameAcceleraVec3</span> <span class="o">=&gt;</span> <span class="n">fbVirtActAcceleraVec3</span><span class="p">,</span>
        <span class="n">fAlphaRadians</span> <span class="o">:=</span> <span class="o">-</span><span class="n">fGammaRadians</span><span class="p">,</span>
        <span class="n">fBetaRadians</span> <span class="o">:=</span> <span class="o">-</span><span class="n">fBetaRadians</span><span class="p">,</span>
        <span class="n">fGammaRadians</span> <span class="o">:=</span> <span class="o">-</span><span class="n">fAlphaRadians</span><span class="p">,</span>
        <span class="n">sOrder</span> <span class="o">:=</span> <span class="n">sOrderReversed</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">SetTargetPosVelAcc3D</span><span class="p">(</span>
    <span class="n">stMotionStageX</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">,</span>
    <span class="n">stMotionStageY</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">,</span>
    <span class="n">stMotionStageZ</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">,</span>
    <span class="n">fbActPosVec3</span> <span class="o">:=</span> <span class="n">fbVirtActPositionVec3</span><span class="p">,</span>
    <span class="n">fbTarPosVec3</span> <span class="o">=&gt;</span> <span class="n">fbVirtTarPositionVec3</span><span class="p">,</span>
    <span class="n">fbTarVelVec3</span> <span class="o">=&gt;</span> <span class="n">fbVirtTarVelocityVec3</span><span class="p">,</span>
    <span class="n">fbTarAccVec3</span> <span class="o">=&gt;</span> <span class="n">fbVirtTarAcceleraVec3</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">bBaseToNew</span> <span class="n">THEN</span>
    <span class="n">RotatePosVelAccFrame</span><span class="p">(</span>
        <span class="n">fbBaseFramePositionVec3</span> <span class="o">:=</span> <span class="n">fbVirtTarPositionVec3</span><span class="p">,</span>
        <span class="n">fbBaseFrameVelocityVec3</span> <span class="o">:=</span> <span class="n">fbVirtTarVelocityVec3</span><span class="p">,</span>
        <span class="n">fbBaseFrameAcceleraVec3</span> <span class="o">:=</span> <span class="n">fbVirtTarAcceleraVec3</span><span class="p">,</span>
        <span class="n">fbNewFramePositionVec3</span> <span class="o">=&gt;</span> <span class="n">fbRealTarPositionVec3</span><span class="p">,</span>
        <span class="n">fbNewFrameVelocityVec3</span> <span class="o">=&gt;</span> <span class="n">fbRealTarVelocityVec3</span><span class="p">,</span>
        <span class="n">fbNewFrameAcceleraVec3</span> <span class="o">=&gt;</span> <span class="n">fbRealTarAcceleraVec3</span><span class="p">,</span>
        <span class="n">fAlphaRadians</span> <span class="o">:=</span> <span class="o">-</span><span class="n">fGammaRadians</span><span class="p">,</span>
        <span class="n">fBetaRadians</span> <span class="o">:=</span> <span class="o">-</span><span class="n">fBetaRadians</span><span class="p">,</span>
        <span class="n">fGammaRadians</span> <span class="o">:=</span> <span class="o">-</span><span class="n">fAlphaRadians</span><span class="p">,</span>
        <span class="n">sOrder</span> <span class="o">:=</span> <span class="n">sOrderReversed</span>
    <span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">RotatePosVelAccFrame</span><span class="p">(</span>
        <span class="n">fbBaseFramePositionVec3</span> <span class="o">:=</span> <span class="n">fbVirtTarPositionVec3</span><span class="p">,</span>
        <span class="n">fbBaseFrameVelocityVec3</span> <span class="o">:=</span> <span class="n">fbVirtTarVelocityVec3</span><span class="p">,</span>
        <span class="n">fbBaseFrameAcceleraVec3</span> <span class="o">:=</span> <span class="n">fbVirtTarAcceleraVec3</span><span class="p">,</span>
        <span class="n">fbNewFramePositionVec3</span> <span class="o">=&gt;</span> <span class="n">fbRealTarPositionVec3</span><span class="p">,</span>
        <span class="n">fbNewFrameVelocityVec3</span> <span class="o">=&gt;</span> <span class="n">fbRealTarVelocityVec3</span><span class="p">,</span>
        <span class="n">fbNewFrameAcceleraVec3</span> <span class="o">=&gt;</span> <span class="n">fbRealTarAcceleraVec3</span><span class="p">,</span>
        <span class="n">fAlphaRadians</span> <span class="o">:=</span> <span class="n">fAlphaRadians</span><span class="p">,</span>
        <span class="n">fBetaRadians</span> <span class="o">:=</span> <span class="n">fBetaRadians</span><span class="p">,</span>
        <span class="n">fGammaRadians</span> <span class="o">:=</span> <span class="n">fGammaRadians</span><span class="p">,</span>
        <span class="n">sOrder</span> <span class="o">:=</span> <span class="n">sOrder</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">rtExecuteVx</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">rtExecuteVy</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">rtExecuteVz</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fbRealTarPositionVec3</span><span class="o">.</span><span class="n">x</span><span class="p">;</span>
        <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fbRealTarPositionVec3</span><span class="o">.</span><span class="n">y</span><span class="p">;</span>
        <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fbRealTarPositionVec3</span><span class="o">.</span><span class="n">z</span><span class="p">;</span>

        <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fbRealTarVelocityVec3</span><span class="o">.</span><span class="n">x</span><span class="p">);</span>
        <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fbRealTarVelocityVec3</span><span class="o">.</span><span class="n">y</span><span class="p">);</span>
        <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fbRealTarVelocityVec3</span><span class="o">.</span><span class="n">z</span><span class="p">);</span>

        <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fbRealTarAcceleraVec3</span><span class="o">.</span><span class="n">x</span><span class="p">);</span>
        <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fbRealTarAcceleraVec3</span><span class="o">.</span><span class="n">y</span><span class="p">);</span>
        <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fbRealTarAcceleraVec3</span><span class="o">.</span><span class="n">z</span><span class="p">);</span>

        <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">fDeceleration</span> <span class="o">:=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fbRealTarAcceleraVec3</span><span class="o">.</span><span class="n">x</span><span class="p">);</span>
        <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">fDeceleration</span> <span class="o">:=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fbRealTarAcceleraVec3</span><span class="o">.</span><span class="n">y</span><span class="p">);</span>
        <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">fDeceleration</span> <span class="o">:=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fbRealTarAcceleraVec3</span><span class="o">.</span><span class="n">z</span><span class="p">);</span>

        <span class="n">IF</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">&gt;=</span> <span class="mf">0.001</span> <span class="n">THEN</span>
            <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">ABS</span><span class="p">(</span><span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">)</span> <span class="o">&gt;</span>
                <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fTargetPosControlRange</span> <span class="n">THEN</span>
            <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">0.001</span><span class="p">;</span>
            <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>

        <span class="n">IF</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">&gt;=</span> <span class="mf">0.001</span> <span class="n">THEN</span>
            <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">ABS</span><span class="p">(</span><span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">)</span> <span class="o">&gt;</span>
                <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fTargetPosControlRange</span> <span class="n">THEN</span>
            <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">0.001</span><span class="p">;</span>
            <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>

        <span class="n">IF</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">&gt;=</span> <span class="mf">0.001</span> <span class="n">THEN</span>
            <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">ABS</span><span class="p">(</span><span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">)</span> <span class="o">&gt;</span>
                <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fTargetPosControlRange</span> <span class="n">THEN</span>
            <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">0.001</span><span class="p">;</span>
            <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="n">IF</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
        <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;An error occured in one of the real axes. All virtual axes stopped.&#39;</span><span class="p">;</span>
        <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;An error occured in one of the real axes. All virtual axes stopped.&#39;</span><span class="p">;</span>
        <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;An error occured in one of the real axes. All virtual axes stopped.&#39;</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">DegToRad</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fDeg</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">DegToRad</span> <span class="o">:=</span> <span class="n">fDeg</span>  <span class="o">/</span> <span class="mf">180.0</span> <span class="o">*</span> <span class="n">lcls_twincat_math</span><span class="o">.</span><span class="n">GVL_Constants</span><span class="o">.</span><span class="n">PI</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">ReverseOrder</span> <span class="p">:</span> <span class="n">STRING</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sOrder</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">sOrder</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">sOrder</span> <span class="o">:=</span> <span class="s1">&#39;ZYX&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">sLeft</span> <span class="o">:=</span> <span class="n">LEFT</span><span class="p">(</span><span class="n">sOrder</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">sMid</span> <span class="o">:=</span> <span class="n">MID</span><span class="p">(</span><span class="n">sOrder</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="n">sRight</span> <span class="o">:=</span> <span class="n">RIGHT</span><span class="p">(</span><span class="n">sOrder</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">ReverseOrder</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sRight</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sMid</span><span class="p">,</span> <span class="n">sLeft</span><span class="p">));</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">RotatePosVelAccFrame</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fbBaseFramePositionVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbBaseFrameVelocityVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbBaseFrameAcceleraVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>

    <span class="n">fAlphaRadians</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fBetaRadians</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fGammaRadians</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">sOrder</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">fbNewFramePositionVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbNewFrameVelocityVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbNewFrameAcceleraVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbNewFramePositionVec3</span> <span class="o">:=</span> <span class="n">F_EulerRotateVec3Frame</span><span class="p">(</span>
    <span class="n">iVec3</span> <span class="o">:=</span> <span class="n">fbBaseFramePositionVec3</span><span class="p">,</span>
    <span class="n">fAlphaRadians</span> <span class="o">:=</span> <span class="n">fAlphaRadians</span><span class="p">,</span>
    <span class="n">fBetaRadians</span> <span class="o">:=</span> <span class="n">fBetaRadians</span><span class="p">,</span>
    <span class="n">fGammaRadians</span> <span class="o">:=</span> <span class="n">fGammaRadians</span><span class="p">,</span>
    <span class="n">sOrder</span> <span class="o">:=</span> <span class="n">sOrder</span>
<span class="p">);</span>

<span class="n">fbNewFrameVelocityVec3</span> <span class="o">:=</span> <span class="n">F_EulerRotateVec3Frame</span><span class="p">(</span>
    <span class="n">iVec3</span> <span class="o">:=</span> <span class="n">fbBaseFrameVelocityVec3</span><span class="p">,</span>
    <span class="n">fAlphaRadians</span> <span class="o">:=</span> <span class="n">fAlphaRadians</span><span class="p">,</span>
    <span class="n">fBetaRadians</span> <span class="o">:=</span> <span class="n">fBetaRadians</span><span class="p">,</span>
    <span class="n">fGammaRadians</span> <span class="o">:=</span> <span class="n">fGammaRadians</span><span class="p">,</span>
    <span class="n">sOrder</span> <span class="o">:=</span> <span class="n">sOrder</span>
<span class="p">);</span>

<span class="n">fbNewFrameAcceleraVec3</span> <span class="o">:=</span> <span class="n">F_EulerRotateVec3Frame</span><span class="p">(</span>
    <span class="n">iVec3</span> <span class="o">:=</span> <span class="n">fbBaseFrameAcceleraVec3</span><span class="p">,</span>
    <span class="n">fAlphaRadians</span> <span class="o">:=</span> <span class="n">fAlphaRadians</span><span class="p">,</span>
    <span class="n">fBetaRadians</span> <span class="o">:=</span> <span class="n">fBetaRadians</span><span class="p">,</span>
    <span class="n">fGammaRadians</span> <span class="o">:=</span> <span class="n">fGammaRadians</span><span class="p">,</span>
    <span class="n">sOrder</span> <span class="o">:=</span> <span class="n">sOrder</span>
<span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">SetTargetPosVelAcc1D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">stMotionStage</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fActPos</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">fTarPos</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fTarVel</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fTarAcc</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">fTarPos</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">fTarPos</span> <span class="o">&gt;=</span> <span class="n">fActPos</span> <span class="n">THEN</span>
        <span class="n">fTarVel</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
        <span class="n">fTarAcc</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">fTarVel</span> <span class="o">:=</span> <span class="o">-</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
        <span class="n">fTarAcc</span> <span class="o">:=</span> <span class="o">-</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">fTarPos</span> <span class="o">:=</span> <span class="n">fActPos</span><span class="p">;</span>
    <span class="n">fTarVel</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">fTarAcc</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">SetTargetPosVelAcc3D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">stMotionStageX</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStageY</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStageZ</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbActPosVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">fbTarPosVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbTarVelVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
    <span class="n">fbTarAccVec3</span> <span class="p">:</span> <span class="n">FB_Vec3</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fTarPosX</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fTarPosY</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fTarPosZ</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="n">fTarVelX</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fTarVelY</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fTarVelZ</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="n">fTarAccX</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fTarAccY</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fTarAccZ</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">SetTargetPosVelAcc1D</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageX</span><span class="p">,</span>
    <span class="n">fActPos</span> <span class="o">:=</span> <span class="n">fbActPosVec3</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
    <span class="n">fTarPos</span> <span class="o">=&gt;</span> <span class="n">fTarPosX</span><span class="p">,</span>
    <span class="n">fTarVel</span> <span class="o">=&gt;</span> <span class="n">fTarVelX</span><span class="p">,</span>
    <span class="n">fTarAcc</span> <span class="o">=&gt;</span> <span class="n">fTarAccX</span>
<span class="p">);</span>

<span class="n">SetTargetPosVelAcc1D</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageY</span><span class="p">,</span>
    <span class="n">fActPos</span> <span class="o">:=</span> <span class="n">fbActPosVec3</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
    <span class="n">fTarPos</span> <span class="o">=&gt;</span> <span class="n">fTarPosY</span><span class="p">,</span>
    <span class="n">fTarVel</span> <span class="o">=&gt;</span> <span class="n">fTarVelY</span><span class="p">,</span>
    <span class="n">fTarAcc</span> <span class="o">=&gt;</span> <span class="n">fTarAccY</span>
<span class="p">);</span>

<span class="n">SetTargetPosVelAcc1D</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageZ</span><span class="p">,</span>
    <span class="n">fActPos</span> <span class="o">:=</span> <span class="n">fbActPosVec3</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
    <span class="n">fTarPos</span> <span class="o">=&gt;</span> <span class="n">fTarPosZ</span><span class="p">,</span>
    <span class="n">fTarVel</span> <span class="o">=&gt;</span> <span class="n">fTarVelZ</span><span class="p">,</span>
    <span class="n">fTarAcc</span> <span class="o">=&gt;</span> <span class="n">fTarAccZ</span>
<span class="p">);</span>

<span class="n">fbTarPosVec3</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">fTarPosX</span><span class="p">,</span> <span class="n">fTarPosY</span><span class="p">,</span> <span class="n">fTarPosZ</span><span class="p">);</span>
<span class="n">fbTarVelVec3</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">fTarVelX</span><span class="p">,</span> <span class="n">fTarVelY</span><span class="p">,</span> <span class="n">fTarVelZ</span><span class="p">);</span>
<span class="n">fbTarAccVec3</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">fTarAccX</span><span class="p">,</span> <span class="n">fTarAccY</span><span class="p">,</span> <span class="n">fTarAccZ</span><span class="p">);</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionvirtualframe-test">
<h2>FB_MotionVirtualFrame_Test<a class="headerlink" href="#fb-motionvirtualframe-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionVirtualFrame_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR</span>
    <span class="n">nTestIDAssigner</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">nTestID</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tonTimeout</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">tonStart</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>

    <span class="n">stMotionStageRx</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStageRy</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStageRz</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>

    <span class="n">stMotionStageVx</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStageVy</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStageVz</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>

    <span class="n">fbMotionStageRx</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStageRy</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStageRz</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="n">fbMotionStageVx</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStageVy</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStageVz</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="n">nPositionCountsVx</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nPositionCountsVy</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nPositionCountsVz</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="n">fbMotorTestSuite</span> <span class="p">:</span> <span class="n">FB_MotorTestSuite</span><span class="p">;</span>
    <span class="n">fbMotionStageSetAndMoveHelper</span> <span class="p">:</span> <span class="n">FB_MotionStageSetAndMoveHelper</span><span class="p">;</span>
    <span class="n">fbMotionStageSetHelperRx</span> <span class="p">:</span> <span class="n">FB_MotionStageSetHelper</span><span class="p">;</span>
    <span class="n">fbMotionStageSetHelperRy</span> <span class="p">:</span> <span class="n">FB_MotionStageSetHelper</span><span class="p">;</span>
    <span class="n">fbMotionStageSetHelperRz</span> <span class="p">:</span> <span class="n">FB_MotionStageSetHelper</span><span class="p">;</span>
    <span class="n">fbMotionStageSetHelperVx</span> <span class="p">:</span> <span class="n">FB_MotionStageSetHelper</span><span class="p">;</span>
    <span class="n">fbMotionStageSetHelperVy</span> <span class="p">:</span> <span class="n">FB_MotionStageSetHelper</span><span class="p">;</span>
    <span class="n">fbMotionStageSetHelperVz</span> <span class="p">:</span> <span class="n">FB_MotionStageSetHelper</span><span class="p">;</span>
    <span class="n">fbMotionVirtualFrame</span> <span class="p">:</span> <span class="n">FB_MotionVirtualFrame</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">nTestIDAssigner</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">tonStart</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1s);</span>

<span class="n">TestEnabled000045XYZMoveVxExpectNoErrorsCorrectPosVelAcc</span><span class="p">();</span>

<span class="n">TestEnabled000090XYZMoveVxExpectNoErrorsCorrectPosVelAcc</span><span class="p">();</span>

<span class="n">TestEnabled009090XYZMoveVxExpectNoErrorsCorrectPosVelAcc</span><span class="p">();</span>

<span class="n">TestEnabled909090XYZMoveVxExpectNoErrorsCorrectPosVelAcc</span><span class="p">();</span>

<span class="n">TestEnabledN22N21P4XYZMoveVxVyVzExpectNoErrorsCorrectPosVelAcc</span><span class="p">();</span>

<span class="n">TestEnabledN22N21P4XYZMoveVyExpectNoErrorsCorrectPosVelAcc</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">AssertNoErrors</span><span class="p">:</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span> <span class="o">:=</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Timeout timer ended the test because it took longer than expected.&#39;</span>
<span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Rx axis error detected when it should not have an error.&#39;</span>
<span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Ry axis error detected when it should not have an error.&#39;</span>
<span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Rz axis error detected when it should not have an error.&#39;</span>
<span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Vx axis error detected when it should not have an error.&#39;</span>
<span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Vy axis error detected when it should not have an error.&#39;</span>
<span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Vz axis error detected when it should not have an error.&#39;</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">AssertPosVelAccCorrect</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fDelta</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="n">fRxPosExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fRyPosExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fRzPosExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVxPosExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVyPosExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVzPosExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="n">fRxVelExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fRyVelExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fRzVelExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVxVelExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVyVelExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVzVelExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="n">fRxAccExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fRyAccExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fRzAccExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVxAccExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVyAccExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVzAccExpected</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Position</span>
<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fRxPosExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Rx did not end at expected position.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fRyPosExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Ry did not end at expected position.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fRzPosExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Rz did not end at expected position.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fVxPosExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Vx did not end at expected position.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fVyPosExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Vy did not end at expected position.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fVzPosExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Vz did not end at expected position.&#39;</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Velocity</span>
<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fRxVelExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Rx did not use the expected velocity.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fRyVelExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Ry did not use the expected velocity.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fRzVelExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Rz did not use the expected velocity.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fVxVelExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Vx did not use the expected velocity.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fVyVelExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Vy did not use the expected velocity.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fVzVelExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Vz did not use the expected velocity.&#39;</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Acceleration</span>
<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fRxAccExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Rx did not use the expected acceleration.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fRyAccExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Ry did not use the expected acceleration.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fRzAccExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Rz did not use the expected acceleration.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fVxAccExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Vx did not use the expected acceleration.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fVyAccExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Vy did not use the expected acceleration.&#39;</span>
<span class="p">);</span>

<span class="n">AssertEquals_LREAL</span><span class="p">(</span>
    <span class="n">Expected</span> <span class="o">:=</span> <span class="n">fVzAccExpected</span><span class="p">,</span>
    <span class="n">Actual</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Delta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Vz did not use the expected acceleration.&#39;</span>
<span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">InitMotors</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">fbMotorTestSuite</span><span class="o">.</span><span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">);</span>
<span class="n">fbMotorTestSuite</span><span class="o">.</span><span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">);</span>
<span class="n">fbMotorTestSuite</span><span class="o">.</span><span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">);</span>
<span class="n">fbMotorTestSuite</span><span class="o">.</span><span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">);</span>
<span class="n">fbMotorTestSuite</span><span class="o">.</span><span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">);</span>
<span class="n">fbMotorTestSuite</span><span class="o">.</span><span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">);</span>

<span class="n">SetTar0</span><span class="p">();</span>

<span class="n">fbMotionStageSetHelperRx</span><span class="p">(</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">,</span>
    <span class="n">bResetDone</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">bSetDone</span> <span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">fbMotionStageSetHelperRy</span><span class="p">(</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">,</span>
    <span class="n">bResetDone</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">bSetDone</span> <span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">fbMotionStageSetHelperRz</span><span class="p">(</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">,</span>
    <span class="n">bResetDone</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">bSetDone</span> <span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">fbMotionStageSetHelperVx</span><span class="p">(</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">,</span>
    <span class="n">bResetDone</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">bSetDone</span> <span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">fbMotionStageSetHelperVy</span><span class="p">(</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">,</span>
    <span class="n">bResetDone</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">bSetDone</span> <span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">fbMotionStageSetHelperVz</span><span class="p">(</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">,</span>
    <span class="n">bResetDone</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">bSetDone</span> <span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">fbMotionStageSetHelperRx</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">AND</span>
   <span class="n">fbMotionStageSetHelperRy</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">AND</span>
   <span class="n">fbMotionStageSetHelperRz</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">AND</span>
   <span class="n">fbMotionStageSetHelperVx</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">AND</span>
   <span class="n">fbMotionStageSetHelperVy</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">AND</span>
   <span class="n">fbMotionStageSetHelperVz</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>

    <span class="n">fbMotionStageSetHelperRx</span><span class="p">(</span>
        <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">,</span>
        <span class="n">bResetDone</span> <span class="o">=&gt;</span> <span class="p">,</span>
        <span class="n">bSetDone</span> <span class="o">=&gt;</span>
    <span class="p">);</span>

    <span class="n">fbMotionStageSetHelperRy</span><span class="p">(</span>
        <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">,</span>
        <span class="n">bResetDone</span> <span class="o">=&gt;</span> <span class="p">,</span>
        <span class="n">bSetDone</span> <span class="o">=&gt;</span>
    <span class="p">);</span>

    <span class="n">fbMotionStageSetHelperRz</span><span class="p">(</span>
        <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">,</span>
        <span class="n">bResetDone</span> <span class="o">=&gt;</span> <span class="p">,</span>
        <span class="n">bSetDone</span> <span class="o">=&gt;</span>
    <span class="p">);</span>

    <span class="n">fbMotionStageSetHelperVx</span><span class="p">(</span>
        <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">,</span>
        <span class="n">bResetDone</span> <span class="o">=&gt;</span> <span class="p">,</span>
        <span class="n">bSetDone</span> <span class="o">=&gt;</span>
    <span class="p">);</span>

    <span class="n">fbMotionStageSetHelperVy</span><span class="p">(</span>
        <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">,</span>
        <span class="n">bResetDone</span> <span class="o">=&gt;</span> <span class="p">,</span>
        <span class="n">bSetDone</span> <span class="o">=&gt;</span>
    <span class="p">);</span>

    <span class="n">fbMotionStageSetHelperVz</span><span class="p">(</span>
        <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">,</span>
        <span class="n">bResetDone</span> <span class="o">=&gt;</span> <span class="p">,</span>
        <span class="n">bSetDone</span> <span class="o">=&gt;</span>
    <span class="p">);</span>

    <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
    <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
    <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
    <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
    <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>

    <span class="n">IF</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="n">AND</span>
        <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="n">AND</span>
        <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="n">AND</span>
        <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="n">AND</span>
        <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="n">AND</span>
        <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="n">THEN</span>

        <span class="n">InitMotors</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">SetTar0</span>
<span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>

<span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>

<span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>

<span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>

<span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>

<span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestEnabled000045XYZMoveVxExpectNoErrorsCorrectPosVelAcc</span>
<span class="n">VAR_INST</span>
    <span class="n">bInit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bComplete</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusyReached</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtMoveCmdOnce</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fDelta</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">1e-9</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestEnabled000045XYZMoveVxExpectNoErrorsCorrectPosVelAcc&#39;</span><span class="p">);</span>

<span class="n">nTestIDAssigner</span> <span class="o">:=</span> <span class="n">nTestIDAssigner</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">nTestID</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIDAssigner</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">tonStart</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#3s);</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">InitMotors</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">15.0</span><span class="p">;</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">;</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">;</span>
    <span class="n">rtMoveCmdOnce</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">rtMoveCmdOnce</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionVirtualFrame</span><span class="p">(</span>
    <span class="n">stMotionStageRx</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">,</span>
    <span class="n">stMotionStageRy</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">,</span>
    <span class="n">stMotionStageRz</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">,</span>
    <span class="n">stMotionStageVx</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">,</span>
    <span class="n">stMotionStageVy</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">,</span>
    <span class="n">stMotionStageVz</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">,</span>
    <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fAlphaDegrees</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">fBetaDegrees</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">fGammaDegrees</span> <span class="o">:=</span> <span class="mf">45.0</span><span class="p">,</span>
    <span class="n">sOrder</span> <span class="o">:=</span> <span class="s1">&#39;XYZ&#39;</span><span class="p">,</span>
    <span class="n">bBaseToNew</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fbVirtActPositionVec3</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">fbVirtActVelocityVec3</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">fbVirtActAcceleraVec3</span> <span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bBusyReached</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bBusyReached</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bComplete</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">bComplete</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">bBusy</span><span class="p">)</span>
    <span class="n">OR</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>

    <span class="n">AssertNoErrors</span><span class="p">();</span>

    <span class="n">AssertPosVelAccCorrect</span><span class="p">(</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
        <span class="n">fRxPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">*</span> <span class="n">SQRT</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">fRyPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">*</span> <span class="n">SQRT</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">fRzPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVxPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">fVyPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVzPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRxVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">*</span> <span class="n">SQRT</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">fRyVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">*</span> <span class="n">SQRT</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">fRzVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVxVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
        <span class="n">fVyVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVzVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRxAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">*</span> <span class="n">SQRT</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">fRyAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">*</span> <span class="n">SQRT</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">fRzAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVxAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
        <span class="n">fVyAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVzAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span>
    <span class="p">);</span>

    <span class="n">TEST_FINISHED</span><span class="p">();</span>

    <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="n">nTestID</span> <span class="o">:=</span> <span class="n">nTestID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionStageRx</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">);</span>
<span class="n">fbMotionStageRy</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">);</span>
<span class="n">fbMotionStageRz</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">);</span>

<span class="n">fbMotionStageVx</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">);</span>
<span class="n">fbMotionStageVy</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">);</span>
<span class="n">fbMotionStageVz</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">);</span>

<span class="n">nPositionCountsVx</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">nPositionCountsVy</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">nPositionCountsVz</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestEnabled000090XYZMoveVxExpectNoErrorsCorrectPosVelAcc</span>
<span class="n">VAR_INST</span>
    <span class="n">bInit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bComplete</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusyReached</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtMoveCmdOnce</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fDelta</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">1e-9</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestEnabled000090XYZMoveVxExpectNoErrorsCorrectPosVelAcc&#39;</span><span class="p">);</span>

<span class="n">nTestIDAssigner</span> <span class="o">:=</span> <span class="n">nTestIDAssigner</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">nTestID</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIDAssigner</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">tonStart</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#3s);</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">InitMotors</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">20.0</span><span class="p">;</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">;</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">;</span>
    <span class="n">rtMoveCmdOnce</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">rtMoveCmdOnce</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionVirtualFrame</span><span class="p">(</span>
    <span class="n">stMotionStageRx</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">,</span>
    <span class="n">stMotionStageRy</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">,</span>
    <span class="n">stMotionStageRz</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">,</span>
    <span class="n">stMotionStageVx</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">,</span>
    <span class="n">stMotionStageVy</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">,</span>
    <span class="n">stMotionStageVz</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">,</span>
    <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fAlphaDegrees</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">fBetaDegrees</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">fGammaDegrees</span> <span class="o">:=</span> <span class="mf">90.0</span><span class="p">,</span>
    <span class="n">sOrder</span> <span class="o">:=</span> <span class="s1">&#39;XYZ&#39;</span><span class="p">,</span>
    <span class="n">bBaseToNew</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fbVirtActPositionVec3</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">fbVirtActVelocityVec3</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">fbVirtActAcceleraVec3</span> <span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bBusyReached</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bBusyReached</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bComplete</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">bComplete</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">bBusy</span><span class="p">)</span>
    <span class="n">OR</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>

    <span class="n">AssertNoErrors</span><span class="p">();</span>

    <span class="n">AssertPosVelAccCorrect</span><span class="p">(</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
        <span class="n">fRxPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRyPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">fRzPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVxPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">fVyPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVzPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRxVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRyVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
        <span class="n">fRzVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVxVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
        <span class="n">fVyVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVzVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRxAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRyAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
        <span class="n">fRzAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVxAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
        <span class="n">fVyAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVzAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span>
    <span class="p">);</span>

    <span class="n">TEST_FINISHED</span><span class="p">();</span>

    <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="n">nTestID</span> <span class="o">:=</span> <span class="n">nTestID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionStageRx</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">);</span>
<span class="n">fbMotionStageRy</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">);</span>
<span class="n">fbMotionStageRz</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">);</span>

<span class="n">fbMotionStageVx</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">);</span>
<span class="n">fbMotionStageVy</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">);</span>
<span class="n">fbMotionStageVz</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">);</span>

<span class="n">nPositionCountsVx</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">nPositionCountsVy</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">nPositionCountsVz</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestEnabled009090XYZMoveVxExpectNoErrorsCorrectPosVelAcc</span>
<span class="n">VAR_INST</span>
    <span class="n">bInit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bComplete</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusyReached</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtMoveCmdOnce</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fDelta</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">1e-9</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestEnabled009090XYZMoveVxExpectNoErrorsCorrectPosVelAcc&#39;</span><span class="p">);</span>

<span class="n">nTestIDAssigner</span> <span class="o">:=</span> <span class="n">nTestIDAssigner</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">nTestID</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIDAssigner</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">tonStart</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#3s);</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">InitMotors</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">25.0</span><span class="p">;</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">;</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">;</span>
    <span class="n">rtMoveCmdOnce</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">rtMoveCmdOnce</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionVirtualFrame</span><span class="p">(</span>
    <span class="n">stMotionStageRx</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">,</span>
    <span class="n">stMotionStageRy</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">,</span>
    <span class="n">stMotionStageRz</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">,</span>
    <span class="n">stMotionStageVx</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">,</span>
    <span class="n">stMotionStageVy</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">,</span>
    <span class="n">stMotionStageVz</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">,</span>
    <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fAlphaDegrees</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">fBetaDegrees</span> <span class="o">:=</span> <span class="mf">90.0</span><span class="p">,</span>
    <span class="n">fGammaDegrees</span> <span class="o">:=</span> <span class="mf">90.0</span><span class="p">,</span>
    <span class="n">sOrder</span> <span class="o">:=</span> <span class="s1">&#39;XYZ&#39;</span><span class="p">,</span>
    <span class="n">bBaseToNew</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fbVirtActPositionVec3</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">fbVirtActVelocityVec3</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">fbVirtActAcceleraVec3</span> <span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bBusyReached</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bBusyReached</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bComplete</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">bComplete</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">bBusy</span><span class="p">)</span>
    <span class="n">OR</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>

    <span class="n">AssertNoErrors</span><span class="p">();</span>

    <span class="n">AssertPosVelAccCorrect</span><span class="p">(</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
        <span class="n">fRxPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRyPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">fRzPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVxPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">fVyPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVzPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRxVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRyVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
        <span class="n">fRzVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVxVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
        <span class="n">fVyVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVzVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRxAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRyAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
        <span class="n">fRzAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVxAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
        <span class="n">fVyAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVzAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span>
    <span class="p">);</span>

    <span class="n">TEST_FINISHED</span><span class="p">();</span>

    <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="n">nTestID</span> <span class="o">:=</span> <span class="n">nTestID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionStageRx</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">);</span>
<span class="n">fbMotionStageRy</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">);</span>
<span class="n">fbMotionStageRz</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">);</span>

<span class="n">fbMotionStageVx</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">);</span>
<span class="n">fbMotionStageVy</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">);</span>
<span class="n">fbMotionStageVz</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">);</span>

<span class="n">nPositionCountsVx</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">nPositionCountsVy</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">nPositionCountsVz</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestEnabled909090XYZMoveVxExpectNoErrorsCorrectPosVelAcc</span>
<span class="n">VAR_INST</span>
    <span class="n">bInit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bComplete</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusyReached</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtMoveCmdOnce</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fDelta</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">1e-9</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestEnabled909090XYZMoveVxExpectNoErrorsCorrectPosVelAcc&#39;</span><span class="p">);</span>

<span class="n">nTestIDAssigner</span> <span class="o">:=</span> <span class="n">nTestIDAssigner</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">nTestID</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIDAssigner</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">tonStart</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#3s);</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">InitMotors</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">35.0</span><span class="p">;</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">;</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">;</span>
    <span class="n">rtMoveCmdOnce</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">rtMoveCmdOnce</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionVirtualFrame</span><span class="p">(</span>
    <span class="n">stMotionStageRx</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">,</span>
    <span class="n">stMotionStageRy</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">,</span>
    <span class="n">stMotionStageRz</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">,</span>
    <span class="n">stMotionStageVx</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">,</span>
    <span class="n">stMotionStageVy</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">,</span>
    <span class="n">stMotionStageVz</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">,</span>
    <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fAlphaDegrees</span> <span class="o">:=</span> <span class="mf">90.0</span><span class="p">,</span>
    <span class="n">fBetaDegrees</span> <span class="o">:=</span> <span class="mf">90.0</span><span class="p">,</span>
    <span class="n">fGammaDegrees</span> <span class="o">:=</span> <span class="mf">90.0</span><span class="p">,</span>
    <span class="n">sOrder</span> <span class="o">:=</span> <span class="s1">&#39;XYZ&#39;</span><span class="p">,</span>
    <span class="n">bBaseToNew</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fbVirtActPositionVec3</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">fbVirtActVelocityVec3</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">fbVirtActAcceleraVec3</span> <span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bBusyReached</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bBusyReached</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bComplete</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">bComplete</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">bBusy</span><span class="p">)</span>
    <span class="n">OR</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>

    <span class="n">AssertNoErrors</span><span class="p">();</span>

    <span class="n">AssertPosVelAccCorrect</span><span class="p">(</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
        <span class="n">fRxPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRyPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRzPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">fVxPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">fVyPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVzPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRxVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRyVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRzVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
        <span class="n">fVxVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
        <span class="n">fVyVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVzVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRxAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRyAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRzAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
        <span class="n">fVxAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
        <span class="n">fVyAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVzAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span>
    <span class="p">);</span>

    <span class="n">TEST_FINISHED</span><span class="p">();</span>

    <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="n">nTestID</span> <span class="o">:=</span> <span class="n">nTestID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionStageRx</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">);</span>
<span class="n">fbMotionStageRy</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">);</span>
<span class="n">fbMotionStageRz</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">);</span>

<span class="n">fbMotionStageVx</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">);</span>
<span class="n">fbMotionStageVy</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">);</span>
<span class="n">fbMotionStageVz</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">);</span>

<span class="n">nPositionCountsVx</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">nPositionCountsVy</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">nPositionCountsVz</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestEnabledN22N21P4XYZMoveVxVyVzExpectNoErrorsCorrectPosVelAcc</span>
<span class="n">VAR_INST</span>
    <span class="n">bInit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bComplete</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusyReached</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtMoveCmdOnce</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fDelta</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">1e-9</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestEnabledN22N21P4XYZMoveVxVyVzExpectNoErrorsCorrectPosVelAcc&#39;</span><span class="p">);</span>

<span class="n">nTestIDAssigner</span> <span class="o">:=</span> <span class="n">nTestIDAssigner</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">nTestID</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIDAssigner</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">tonStart</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#3s);</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">InitMotors</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">rtMoveCmdOnce</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>

    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">15.0</span><span class="p">;</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">;</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">;</span>
    <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">rtMoveCmdOnce</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

    <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="o">-</span><span class="mf">30.0</span><span class="p">;</span>
    <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">);</span>
    <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">);</span>
    <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">rtMoveCmdOnce</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

    <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">45.0</span><span class="p">;</span>
    <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">;</span>
    <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">;</span>
    <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">rtMoveCmdOnce</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionVirtualFrame</span><span class="p">(</span>
    <span class="n">stMotionStageRx</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">,</span>
    <span class="n">stMotionStageRy</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">,</span>
    <span class="n">stMotionStageRz</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">,</span>
    <span class="n">stMotionStageVx</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">,</span>
    <span class="n">stMotionStageVy</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">,</span>
    <span class="n">stMotionStageVz</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">,</span>
    <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fAlphaDegrees</span> <span class="o">:=</span> <span class="o">-</span><span class="mf">22.21</span><span class="p">,</span>
    <span class="n">fBetaDegrees</span> <span class="o">:=</span> <span class="o">-</span><span class="mf">20.7</span><span class="p">,</span>
    <span class="n">fGammaDegrees</span> <span class="o">:=</span> <span class="mf">3.793</span><span class="p">,</span>
    <span class="n">sOrder</span> <span class="o">:=</span> <span class="s1">&#39;XYZ&#39;</span><span class="p">,</span>
    <span class="n">bBaseToNew</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
    <span class="n">fbVirtActPositionVec3</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">fbVirtActVelocityVec3</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">fbVirtActAcceleraVec3</span> <span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bBusyReached</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bBusyReached</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bComplete</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">bComplete</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">bBusy</span><span class="p">)</span>
    <span class="n">OR</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>

    <span class="n">AssertNoErrors</span><span class="p">();</span>

    <span class="n">AssertPosVelAccCorrect</span><span class="p">(</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
        <span class="n">fRxPosExpected</span> <span class="o">:=</span> <span class="mf">21.732640182123049</span><span class="p">,</span>
        <span class="n">fRyPosExpected</span> <span class="o">:=</span> <span class="o">-</span><span class="mf">46.323371856381527</span><span class="p">,</span>
        <span class="n">fRzPosExpected</span> <span class="o">:=</span> <span class="mf">23.061603816078627</span><span class="p">,</span>
        <span class="n">fVxPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">fVyPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">fVzPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">fRxVelExpected</span> <span class="o">:=</span> <span class="mf">14.488426788082032</span><span class="p">,</span>
        <span class="n">fRyVelExpected</span> <span class="o">:=</span> <span class="mf">30.882247904254346</span><span class="p">,</span>
        <span class="n">fRzVelExpected</span> <span class="o">:=</span> <span class="mf">15.374402544052412</span><span class="p">,</span>
        <span class="n">fVxVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
        <span class="n">fVyVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
        <span class="n">fVzVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
        <span class="n">fRxAccExpected</span> <span class="o">:=</span> <span class="mf">0.724421339404102</span> <span class="o">*</span> <span class="mf">1e2</span><span class="p">,</span>
        <span class="n">fRyAccExpected</span> <span class="o">:=</span> <span class="mf">1.544112395212718</span> <span class="o">*</span> <span class="mf">1e2</span><span class="p">,</span>
        <span class="n">fRzAccExpected</span> <span class="o">:=</span> <span class="mf">0.768720127202621</span> <span class="o">*</span> <span class="mf">1e2</span><span class="p">,</span>
        <span class="n">fVxAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
        <span class="n">fVyAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
        <span class="n">fVzAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">fAcceleration</span>
    <span class="p">);</span>

    <span class="n">TEST_FINISHED</span><span class="p">();</span>

    <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="n">nTestID</span> <span class="o">:=</span> <span class="n">nTestID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionStageRx</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">);</span>
<span class="n">fbMotionStageRy</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">);</span>
<span class="n">fbMotionStageRz</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">);</span>

<span class="n">fbMotionStageVx</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">);</span>
<span class="n">fbMotionStageVy</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">);</span>
<span class="n">fbMotionStageVz</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">);</span>

<span class="n">nPositionCountsVx</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">nPositionCountsVy</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">nPositionCountsVz</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestEnabledN22N21P4XYZMoveVyExpectNoErrorsCorrectPosVelAcc</span>
<span class="n">VAR_INST</span>
    <span class="n">bInit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bComplete</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusyReached</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtMoveCmdOnce</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fDelta</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">1e-9</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestEnabledN22N21P4XYZMoveVyExpectNoErrorsCorrectPosVelAcc&#39;</span><span class="p">);</span>

<span class="n">nTestIDAssigner</span> <span class="o">:=</span> <span class="n">nTestIDAssigner</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">nTestID</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIDAssigner</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">tonStart</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#3s);</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">InitMotors</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">30.0</span><span class="p">;</span>
    <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">;</span>
    <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">;</span>
    <span class="n">rtMoveCmdOnce</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">rtMoveCmdOnce</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionVirtualFrame</span><span class="p">(</span>
    <span class="n">stMotionStageRx</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">,</span>
    <span class="n">stMotionStageRy</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">,</span>
    <span class="n">stMotionStageRz</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">,</span>
    <span class="n">stMotionStageVx</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">,</span>
    <span class="n">stMotionStageVy</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">,</span>
    <span class="n">stMotionStageVz</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">,</span>
    <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fAlphaDegrees</span> <span class="o">:=</span> <span class="o">-</span><span class="mf">22.21</span><span class="p">,</span>
    <span class="n">fBetaDegrees</span> <span class="o">:=</span> <span class="o">-</span><span class="mf">20.7</span><span class="p">,</span>
    <span class="n">fGammaDegrees</span> <span class="o">:=</span> <span class="mf">3.793</span><span class="p">,</span>
    <span class="n">sOrder</span> <span class="o">:=</span> <span class="s1">&#39;XYZ&#39;</span><span class="p">,</span>
    <span class="n">bBaseToNew</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
    <span class="n">fbVirtActPositionVec3</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">fbVirtActVelocityVec3</span> <span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">fbVirtActAcceleraVec3</span> <span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bBusyReached</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bBusyReached</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bComplete</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">bComplete</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageVz</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRx</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRy</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span>
    <span class="n">NOT</span> <span class="n">stMotionStageRz</span><span class="o">.</span><span class="n">bBusy</span><span class="p">)</span>
    <span class="n">OR</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>

    <span class="n">AssertNoErrors</span><span class="p">();</span>

    <span class="n">AssertPosVelAccCorrect</span><span class="p">(</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">,</span>
        <span class="n">fRxPosExpected</span> <span class="o">:=</span> <span class="mf">5.836964390001455</span><span class="p">,</span>
        <span class="n">fRyPosExpected</span> <span class="o">:=</span> <span class="mf">27.448135465863341</span><span class="p">,</span>
        <span class="n">fRzPosExpected</span> <span class="o">:=</span> <span class="mf">10.608001987060069</span><span class="p">,</span>
        <span class="n">fVxPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVyPosExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">fVzPosExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRxVelExpected</span> <span class="o">:=</span> <span class="mf">5.836964390001455</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">fRyVelExpected</span> <span class="o">:=</span> <span class="mf">27.448135465863341</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">fRzVelExpected</span> <span class="o">:=</span> <span class="mf">10.608001987060069</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">fVxVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVyVelExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
        <span class="n">fVzVelExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fRxAccExpected</span> <span class="o">:=</span> <span class="mf">5.836964390001455</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">fRyAccExpected</span> <span class="o">:=</span> <span class="mf">27.448135465863341</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">fRzAccExpected</span> <span class="o">:=</span> <span class="mf">10.608001987060069</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">fVxAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fVyAccExpected</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
        <span class="n">fVzAccExpected</span> <span class="o">:=</span> <span class="mf">0.0</span>
    <span class="p">);</span>

    <span class="n">TEST_FINISHED</span><span class="p">();</span>

    <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="n">nTestID</span> <span class="o">:=</span> <span class="n">nTestID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionStageRx</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRx</span><span class="p">);</span>
<span class="n">fbMotionStageRy</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRy</span><span class="p">);</span>
<span class="n">fbMotionStageRz</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageRz</span><span class="p">);</span>

<span class="n">fbMotionStageVx</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVx</span><span class="p">);</span>
<span class="n">fbMotionStageVy</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVy</span><span class="p">);</span>
<span class="n">fbMotionStageVz</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStageVz</span><span class="p">);</span>

<span class="n">nPositionCountsVx</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">nPositionCountsVy</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">nPositionCountsVz</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fbMotionVirtualFrame</span><span class="o">.</span><span class="n">fbVirtActPositionVec3</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">);</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstagesetandmovehelper">FB_MotionStageSetAndMoveHelper</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstagesethelper">FB_MotionStageSetHelper</a></p></li>
<li><p><a class="reference internal" href="#fb-motionvirtualframe">FB_MotionVirtualFrame</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motortestsuite">
<h2>FB_MotorTestSuite<a class="headerlink" href="#fb-motortestsuite" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotorTestSuite</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Base</span> <span class="k">class</span><span class="w"> </span><span class="nc">for</span> <span class="n">motion</span> <span class="n">tests</span><span class="o">.</span>

    <span class="n">Contains</span> <span class="n">some</span> <span class="n">helper</span> <span class="n">methods</span> <span class="n">that</span> <span class="n">would</span> <span class="n">otherwise</span> <span class="n">need</span> <span class="n">to</span> <span class="n">be</span> <span class="n">instantiated</span> <span class="n">many</span> <span class="n">times</span><span class="p">,</span>
    <span class="n">but</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">form</span> <span class="n">can</span> <span class="n">be</span> <span class="n">accessed</span> <span class="n">quickly</span> <span class="ow">and</span> <span class="n">succinctly</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>


<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">SetEnables</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Set</span> <span class="n">a</span> <span class="n">motion</span> <span class="n">stage</span><span class="s1">&#39;s enables such that it is fully allowed to move.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">SetEnablesPMPS</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Set</span> <span class="n">a</span> <span class="n">motion</span> <span class="n">stage</span><span class="s1">&#39;s enables such that only PMPS would be preventing a move.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">SetGoodState</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Mark</span> <span class="n">a</span> <span class="n">state</span> <span class="k">as</span> <span class="n">valid</span> <span class="ow">and</span> <span class="n">ready</span> <span class="n">to</span> <span class="n">use</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-moveabsolutenc">
<h2>FB_MoveAbsoluteNC<a class="headerlink" href="#fb-moveabsolutenc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MoveAbsoluteNC</span> <span class="n">IMPLEMENTS</span> <span class="n">I_MoveAbsolute</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_copy&#39;</span><span class="p">}</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">fbMcMoveAbsolute</span> <span class="p">:</span> <span class="n">MC_MoveAbsolute</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span><span class="p">;</span>
    <span class="n">eMoveAbsoluteState</span> <span class="p">:</span> <span class="p">(</span><span class="n">WaitingMoveAbsolute</span><span class="p">,</span> <span class="n">MovingAbsolute</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">__ISVALIDREF</span><span class="p">(</span><span class="n">AxisRef</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">AxisRef</span><span class="o">.</span><span class="n">ReadStatus</span><span class="p">();</span>

<span class="n">CASE</span> <span class="n">eMoveAbsoluteState</span> <span class="n">OF</span>
    <span class="n">WaitingMoveAbsolute</span> <span class="p">:</span>
        <span class="n">fbMcMoveAbsolute</span><span class="p">(</span>
        <span class="n">Axis</span> <span class="o">:=</span> <span class="n">AxisRef</span><span class="p">,</span>
        <span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="n">MovingAbsolute</span> <span class="p">:</span>
        <span class="n">fbMcMoveAbsolute</span><span class="p">(</span>
        <span class="n">Axis</span> <span class="o">:=</span> <span class="n">AxisRef</span><span class="p">,</span>
        <span class="n">Execute</span> <span class="o">:=</span> <span class="n">TRUE</span>
        <span class="p">);</span>
<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">FB_Init</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">warm</span> <span class="n">start</span> <span class="o">/</span> <span class="n">cold</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">bInCopyCode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">afterwards</span> <span class="n">gets</span> <span class="n">moved</span> <span class="n">into</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">MoveAbsolute</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Position</span>        <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">Velocity</span>        <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">Acceleration</span>    <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">Deceleration</span>    <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">Jerk</span>    <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">BufferMode</span>      <span class="p">:</span> <span class="n">MC_BufferMode</span> <span class="o">:=</span> <span class="n">MC_BufferMode</span><span class="o">.</span><span class="n">MC_Aborting</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbMcMoveAbsolute</span><span class="p">(</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
                 <span class="n">Axis</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">);</span>

<span class="n">fbMcMoveAbsolute</span><span class="p">(</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">Axis</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">,</span>
    <span class="n">Position</span> <span class="o">:=</span> <span class="n">Position</span><span class="p">,</span>
    <span class="n">Velocity</span> <span class="o">:=</span> <span class="n">Velocity</span><span class="p">,</span>
    <span class="n">Acceleration</span> <span class="o">:=</span> <span class="n">Acceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span> <span class="o">:=</span> <span class="n">Deceleration</span><span class="p">,</span>
    <span class="n">Jerk</span> <span class="o">:=</span> <span class="n">Jerk</span><span class="p">,</span>
    <span class="n">BufferMode</span> <span class="o">:=</span> <span class="n">BufferMode</span><span class="p">);</span>
<span class="n">eMoveAbsoluteState</span> <span class="o">:=</span> <span class="n">MovingAbsolute</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Aborted</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcMoveAbsolute</span><span class="o">.</span><span class="n">CommandAborted</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Active</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcMoveAbsolute</span><span class="o">.</span><span class="n">Active</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcMoveAbsolute</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">CommandMoveAbsolute</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcMoveAbsolute</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">CommandMoveAbsolute</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Done</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcMoveAbsolute</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcMoveAbsolute</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcMoveAbsolute</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Message</span> <span class="o">:=</span> <span class="n">sMessage</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
</section>
<section id="fb-ncaxis">
<h2>FB_NcAxis<a class="headerlink" href="#fb-ncaxis" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="c1">#########################################################</span>
<span class="o">///</span><span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">communicate</span> <span class="n">between</span> <span class="n">Nc</span> <span class="ow">and</span> <span class="n">Plc</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Library</span><span class="p">:</span>
<span class="o">///</span> <span class="n">Tc2_MC2</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Global</span> <span class="n">Variables</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Data</span> <span class="n">types</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">External</span> <span class="n">functions</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span><span class="c1">###########################################################</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_NcAxis</span>
<span class="n">VAR</span>
    <span class="n">sVersion</span><span class="p">:</span> <span class="n">STRING</span><span class="o">:=</span><span class="s1">&#39;1.0.0&#39;</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Status</span><span class="p">:</span> <span class="n">ST_AxisStatus</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">AND</span> <span class="n">InfoData_State</span><span class="o">&lt;&gt;</span><span class="mi">16</span><span class="c1">#8 THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">Axis</span><span class="o">.</span><span class="n">ReadStatus</span><span class="p">();</span>
    <span class="n">Status</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-ncerrorffo">
<h2>FB_NCErrorFFO<a class="headerlink" href="#fb-ncerrorffo" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_NCErrorFFO</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Configure</span> <span class="n">a</span> <span class="n">ST_MotionStage</span> <span class="n">to</span> <span class="n">trigger</span> <span class="n">an</span> <span class="n">FFO</span> <span class="n">when</span> <span class="n">we</span> <span class="n">have</span> <span class="n">an</span> <span class="n">error</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">can</span> <span class="n">be</span> <span class="n">configured</span> <span class="n">to</span> <span class="n">only</span> <span class="n">apply</span> <span class="n">to</span> <span class="n">specific</span> <span class="n">error</span> <span class="n">ranges</span><span class="p">,</span>
    <span class="n">though</span> <span class="n">the</span> <span class="n">default</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">normal</span> <span class="mi">16</span><span class="c1">#4XXX NC error range. The error</span>
    <span class="n">ranges</span> <span class="n">are</span><span class="p">:</span>
    <span class="mi">16</span><span class="c1">#40XX General Errors</span>
    <span class="mi">16</span><span class="c1">#41XX Channel Errors</span>
    <span class="mi">16</span><span class="c1">#42XX Group Errors</span>
    <span class="mi">16</span><span class="c1">#43XX Axis Errors</span>
    <span class="mi">16</span><span class="c1">#44XX Encoder Errors</span>
    <span class="mi">16</span><span class="c1">#45XX Controller Errors</span>
    <span class="mi">16</span><span class="c1">#46XX Drive Errors</span>
    <span class="mi">16</span><span class="c1">#4AXX Table Errors</span>
    <span class="mi">16</span><span class="c1">#4BXX NC PLC Errors</span>
    <span class="mi">16</span><span class="c1">#4CXX Kinematic Transformation</span>

    <span class="n">There</span> <span class="ow">is</span> <span class="n">also</span> <span class="n">a</span> <span class="n">new</span> <span class="n">extended</span> <span class="n">NC</span> <span class="n">error</span> <span class="nb">range</span><span class="p">,</span> <span class="n">but</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">sparsely</span> <span class="n">populated</span><span class="o">.</span>
    <span class="n">This</span> <span class="nb">range</span> <span class="ow">is</span> <span class="mi">16</span><span class="c1">#8XXX:</span>
    <span class="mi">16</span><span class="c1">#8100 - 16#811F: Bode plot (diagnosis)</span>
    <span class="mi">16</span><span class="c1">#8120 - 16#8FFF: Further errors</span>

    <span class="n">To</span> <span class="n">configure</span> <span class="n">multiple</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">simply</span> <span class="n">use</span> <span class="n">multiple</span> <span class="n">instances</span> <span class="n">of</span> <span class="n">this</span>
    <span class="n">function</span> <span class="n">block</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motion</span> <span class="n">stage</span> <span class="n">to</span> <span class="n">monitor</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">FFO</span> <span class="n">to</span> <span class="n">trip</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">fault</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Auto</span><span class="o">-</span><span class="n">reset</span> <span class="n">the</span> <span class="n">fault</span>
    <span class="n">bAutoReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">lowest</span> <span class="n">error</span> <span class="n">code</span> <span class="n">that</span> <span class="n">will</span> <span class="n">trip</span> <span class="n">the</span> <span class="n">FFO</span>
    <span class="n">nLowErrorId</span><span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#4000;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">highest</span> <span class="n">error</span> <span class="n">code</span> <span class="n">that</span> <span class="n">will</span> <span class="n">trip</span> <span class="n">the</span> <span class="n">FFO</span>
    <span class="n">nHighErrorId</span><span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#4FFF;</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">description</span> <span class="n">of</span> <span class="n">the</span> <span class="n">fault</span>
    <span class="n">sDesc</span><span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;Motor error&#39;</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Quick</span> <span class="n">way</span> <span class="k">for</span> <span class="n">nearby</span> <span class="n">code</span> <span class="n">to</span> <span class="n">check</span> <span class="k">if</span> <span class="n">this</span> <span class="n">block</span> <span class="n">has</span> <span class="n">tripped</span> <span class="n">the</span> <span class="n">FFO</span><span class="o">.</span>
    <span class="n">bTripped</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">PMPS</span><span class="o">.</span> <span class="n">Is</span> <span class="n">always</span> <span class="mi">16</span><span class="c1">#20XX, where XX is the first two hex in the NC error.</span>
    <span class="n">nErrorTypeCode</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">stBeamParams</span><span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">fbFF</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">rtTrip</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">fbFF</span><span class="o">.</span><span class="n">i_Desc</span> <span class="o">:=</span> <span class="n">sDesc</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">LEN</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">sName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">fbFF</span><span class="o">.</span><span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sName</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">fbFF</span><span class="o">.</span><span class="n">i_DevName</span> <span class="o">:=</span> <span class="s1">&#39;Unnamed Motor&#39;</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bTripped</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">&gt;=</span> <span class="n">nLowErrorId</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">&lt;=</span> <span class="n">nHighErrorId</span><span class="p">;</span>
<span class="n">rtTrip</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bTripped</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtTrip</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">nErrorTypeCode</span> <span class="o">:=</span> <span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">LOW_RESERVED_NC</span> <span class="o">+</span> <span class="n">UDINT_TO_UINT</span><span class="p">(</span><span class="n">SHR</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
    <span class="n">nErrorTypeCode</span> <span class="o">:=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">nErrorTypeCode</span><span class="p">,</span> <span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">HIGH_RESERVED_NC</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">fbFF</span><span class="p">(</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bTripped</span><span class="p">,</span>
     <span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">bReset</span><span class="p">,</span>
     <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">bAutoReset</span><span class="p">,</span>
     <span class="n">i_TypeCode</span><span class="o">:=</span> <span class="n">nErrorTypeCode</span><span class="p">,</span>
     <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFHWO</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ncerrorffo-test">
<h2>FB_NCErrorFFO_Test<a class="headerlink" href="#fb-ncerrorffo-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_NCErrorFFO_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">the</span> <span class="n">following</span> <span class="n">related</span> <span class="n">FBs</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">FB_NCErrorFFO</span>
    <span class="o">-</span> <span class="n">FB_EncErrorFFO</span>

    <span class="n">These</span> <span class="n">function</span> <span class="n">blocks</span> <span class="n">are</span> <span class="n">designed</span> <span class="n">to</span> <span class="n">trip</span> <span class="n">the</span> <span class="n">beam</span> <span class="n">when</span> <span class="n">there</span>
    <span class="ow">is</span> <span class="n">an</span> <span class="n">NC</span> <span class="n">error</span> <span class="n">reported</span> <span class="n">by</span> <span class="n">stMotionStage</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbCauseNCError</span><span class="p">:</span> <span class="n">FB_CauseNCError</span><span class="p">;</span>

    <span class="n">fbNCErrorFFO</span><span class="p">:</span> <span class="n">FB_NCErrorFFO</span><span class="p">;</span>
    <span class="n">fbEncErrorFFO</span><span class="p">:</span> <span class="n">FB_EncErrorFFO</span><span class="p">;</span>

    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Limit</span> <span class="n">to</span> <span class="n">drive</span> <span class="n">errors</span> <span class="n">so</span> <span class="n">I</span> <span class="n">can</span> <span class="n">isolate</span> <span class="n">it</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">enc</span> <span class="n">error</span>
<span class="n">fbNCErrorFFO</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nLowErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4500,</span>
    <span class="n">nHighErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#45FF,</span>
<span class="p">);</span>
<span class="n">fbEncErrorFFO</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">Fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">there</span> <span class="n">are</span> <span class="n">no</span> <span class="n">issues</span> <span class="ow">and</span> <span class="n">FALSE</span> <span class="n">when</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">issue</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="n">TestNC</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">TestEnc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">fbCauseNCError</span><span class="p">(</span>
        <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestEnc</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestEncError&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">First</span> <span class="n">cycle</span><span class="p">:</span> <span class="n">no</span> <span class="n">error</span><span class="p">,</span> <span class="n">no</span> <span class="n">fault</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
            <span class="s1">&#39;Should have had no error before running this test&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
            <span class="s1">&#39;Should have had no fault with no error&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">nState</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="mi">1</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Next</span> <span class="n">time</span><span class="p">:</span> <span class="n">cause</span> <span class="n">an</span> <span class="n">error</span>
        <span class="n">fbCauseNCError</span><span class="p">(</span>
            <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">nErrorCode</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4467, // Invalid encoder position data</span>
        <span class="p">);</span>
<span class="n">END_CASE</span>

<span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">the</span> <span class="n">fault</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">then</span> <span class="n">check</span> <span class="n">everything</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorID</span> <span class="o">=</span> <span class="mi">16</span><span class="c1">#4467) THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="s1">&#39;Did not get motor error in error test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UDINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4467,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error causer is broken&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not cause a fast fault&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbNCErrorFFO</span><span class="o">.</span><span class="n">bTripped</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Drive error FB tripped with an enc error&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbEncErrorFFO</span><span class="o">.</span><span class="n">bTripped</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Enc error fb did not trip with an enc error&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestNC</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestNCError&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">First</span> <span class="n">cycle</span><span class="p">:</span> <span class="n">no</span> <span class="n">error</span><span class="p">,</span> <span class="n">no</span> <span class="n">fault</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
            <span class="s1">&#39;Should have had no error before running this test&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
            <span class="s1">&#39;Should have had no fault with no error&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">nState</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="mi">1</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Next</span> <span class="n">time</span><span class="p">:</span> <span class="n">cause</span> <span class="n">an</span> <span class="n">error</span>
        <span class="n">fbCauseNCError</span><span class="p">(</span>
            <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">nErrorCode</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4550, // Position lag monitoring error code</span>
        <span class="p">);</span>
<span class="n">END_CASE</span>

<span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">the</span> <span class="n">fault</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">then</span> <span class="n">check</span> <span class="n">everything</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">=</span> <span class="mi">16</span><span class="c1">#4550) THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="s1">&#39;Did not get motor error in error test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UDINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4550,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error causer is broken&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not cause a fast fault&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbNCErrorFFO</span><span class="o">.</span><span class="n">bTripped</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;NC error FB did not trip with a drive error&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbEncErrorFFO</span><span class="o">.</span><span class="n">bTripped</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Enc error tripped with a drive error&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-causencerror">FB_CauseNCError</a></p></li>
<li><p><a class="reference internal" href="#fb-encerrorffo">FB_EncErrorFFO</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-ncerrorffo">FB_NCErrorFFO</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-newarchmcmotionblocks-test">
<h2>FB_NewArchMcMotionBlocks_Test<a class="headerlink" href="#fb-newarchmcmotionblocks-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_NewArchMcMotionBlocks_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_TestSuite</span>
<span class="n">VAR</span>

    <span class="n">fbMyAxisRef_Test1</span> <span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Common</span> <span class="n">tests</span> <span class="nb">vars</span>
    <span class="n">fbPower</span> <span class="p">:</span> <span class="n">MC_Power</span><span class="p">;</span>
    <span class="n">eMCUnderTest</span> <span class="p">:</span> <span class="p">(</span><span class="n">MoveAbsolute</span><span class="p">,</span> <span class="n">MoveAbsoluteAndHalt</span><span class="p">,</span> <span class="n">MoveAbsoluteAndReset</span><span class="p">,</span> <span class="n">BacklashCompensation</span><span class="p">);</span>
    <span class="n">fbTestTimer</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#2S, IN := TRUE);</span>
    <span class="n">fbInMotionTimer</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#250MS, IN := FALSE);</span>
    <span class="n">nTestStateStep</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Common</span> <span class="n">Subjects</span> <span class="n">under</span> <span class="n">test</span>
    <span class="n">fbMoveAbsoluteNC</span> <span class="p">:</span> <span class="n">FB_MoveAbsoluteNC</span><span class="p">(</span><span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">fbMyAxisRef_Test1</span><span class="p">);</span>
    <span class="o">//</span> <span class="n">To</span> <span class="n">do</span>
    <span class="o">//</span><span class="n">fbBacklashCompensationNC</span> <span class="p">:</span> <span class="n">FB_BacklashCompensationNC</span><span class="p">(</span><span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">fbMyAxisRef_Test1</span><span class="p">);</span>

<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">All</span> <span class="n">tests</span> <span class="n">need</span> <span class="n">this</span> <span class="n">call</span>
<span class="n">fbMoveAbsoluteNC</span><span class="p">();</span>
<span class="n">fbPower</span><span class="p">(</span><span class="n">Axis</span> <span class="o">:=</span> <span class="n">fbMyAxisRef_Test1</span><span class="p">,</span>  <span class="n">Override</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">Add</span> <span class="nb">all</span> <span class="n">MoveAbslute</span> <span class="n">test</span> <span class="n">here</span> <span class="ow">and</span> <span class="n">then</span> <span class="n">define</span> <span class="n">the</span> <span class="n">condition</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span> <span class="nb">next</span> <span class="n">subject</span> <span class="n">under</span> <span class="n">test</span><span class="o">*</span><span class="p">)</span>
<span class="n">GivenThatWeStartMoveAbsoluteExpectToBeDoneAndRetainDone</span><span class="p">(</span><span class="n">eMCUnderTest</span><span class="o">=</span><span class="n">MoveAbsolute</span><span class="p">);</span>
<span class="n">GivenThatWeStartMoveAbsoluteAndHaltExpectToBeAbortedAndRetainHaltDone</span><span class="p">(</span><span class="n">eMCUnderTest</span><span class="o">=</span><span class="n">MoveAbsoluteAndHalt</span><span class="p">);</span>
<span class="n">GivenThatWeStartMoveAbsoluteAndResetExpectToBeAbortedAndRetainResetDone</span><span class="p">(</span><span class="n">eMCUnderTest</span><span class="o">=</span><span class="n">MoveAbsoluteAndReset</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">GivenThatWeStartMoveAbsoluteAndHaltExpectToBeAbortedAndRetainHaltDone</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Ready</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="o">//</span> <span class="n">Subject</span> <span class="n">under</span> <span class="n">test</span>
    <span class="n">fbHaltNC</span> <span class="p">:</span> <span class="n">FB_HaltNC</span><span class="p">(</span><span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">fbMyAxisRef_Test1</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">Ready</span> <span class="n">THEN</span>

    <span class="n">TEST</span><span class="p">(</span><span class="n">__POUNAME</span><span class="p">());</span>

    <span class="n">fbTestTimer</span><span class="p">();</span>

    <span class="n">CASE</span> <span class="n">nTestStateStep</span> <span class="n">OF</span>
        <span class="mi">0</span> <span class="p">:</span>
            <span class="n">fbMoveAbsoluteNC</span><span class="o">.</span><span class="n">MoveAbsolute</span><span class="p">(</span><span class="n">Position</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">,</span>
                                          <span class="n">Velocity</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">,</span>
                                          <span class="n">Acceleration</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">,</span>
                                      <span class="n">Deceleration</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">);</span>
            <span class="n">fbTestTimer</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">fbInMotionTimer</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">nTestStateStep</span> <span class="o">:=</span> <span class="n">nTestStateStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="mi">1</span> <span class="p">:</span>

            <span class="n">IF</span> <span class="n">fbInMotionTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
                <span class="n">fbHaltNC</span><span class="o">.</span><span class="n">Halt</span><span class="p">(</span>    <span class="n">Deceleration</span><span class="o">:=</span><span class="mi">100</span><span class="p">,</span> <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span> <span class="p">);</span>
                <span class="n">fbInMotionTimer</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">nTestStateStep</span> <span class="o">:=</span> <span class="n">nTestStateStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="mi">2</span> <span class="p">:</span>
            <span class="o">//</span> <span class="n">Do</span> <span class="n">nothing</span>
    <span class="n">END_CASE</span>

    <span class="n">fbInMotionTimer</span><span class="p">();</span>
    <span class="n">fbHaltNC</span><span class="p">();</span>
    <span class="n">IF</span> <span class="n">fbTestTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbMoveAbsoluteNC</span><span class="o">.</span><span class="n">Aborted</span><span class="p">,</span>
                   <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Expected CommandAborted&#39;</span><span class="p">);</span>
        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbHaltNC</span><span class="o">.</span><span class="n">Done</span><span class="p">,</span>
                    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Expected Done&#39;</span><span class="p">);</span>
        <span class="n">AssertFalse</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbHaltNC</span><span class="o">.</span><span class="n">Busy</span><span class="p">,</span>
                    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Expected not busy&#39;</span><span class="p">);</span>
        <span class="n">fbTestTimer</span><span class="o">.</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">put</span> <span class="n">this</span> <span class="n">line</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">the</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">Moveabsolute</span> <span class="n">test</span> <span class="n">to</span> <span class="n">start</span> <span class="n">halt</span> <span class="n">tests</span>
        <span class="n">eMCUnderTest</span> <span class="o">:=</span> <span class="n">MoveAbsoluteAndReset</span><span class="p">;</span>
        <span class="n">fbTestTimer</span><span class="o">.</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="n">fbInMotionTimer</span><span class="o">.</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nTestStateStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">TEST_FINISHED</span><span class="p">();</span>
    <span class="n">END_IF</span>

<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">GivenThatWeStartMoveAbsoluteAndResetExpectToBeAbortedAndRetainResetDone</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Ready</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="o">//</span> <span class="n">Subject</span> <span class="n">under</span> <span class="n">test</span>
    <span class="n">fbResetNC</span> <span class="p">:</span> <span class="n">FB_ResetNC</span><span class="p">(</span><span class="n">AxisRef</span> <span class="o">:=</span> <span class="n">fbMyAxisRef_Test1</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">Ready</span> <span class="n">THEN</span>

    <span class="n">TEST</span><span class="p">(</span><span class="n">__POUNAME</span><span class="p">());</span>

    <span class="n">fbTestTimer</span><span class="p">();</span>
    <span class="n">fbInMotionTimer</span><span class="p">();</span>
    <span class="n">CASE</span> <span class="n">nTestStateStep</span> <span class="n">OF</span>
        <span class="mi">0</span> <span class="p">:</span>
            <span class="n">fbMoveAbsoluteNC</span><span class="o">.</span><span class="n">MoveAbsolute</span><span class="p">(</span><span class="n">Position</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">,</span>
                                          <span class="n">Velocity</span> <span class="o">:=</span> <span class="mi">400</span><span class="p">,</span>
                                          <span class="n">Acceleration</span> <span class="o">:=</span> <span class="mi">400</span><span class="p">,</span>
                                      <span class="n">Deceleration</span> <span class="o">:=</span> <span class="mi">400</span><span class="p">);</span>
            <span class="n">fbTestTimer</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">fbInMotionTimer</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">nTestStateStep</span> <span class="o">:=</span> <span class="n">nTestStateStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="mi">1</span> <span class="p">:</span>
            <span class="n">IF</span> <span class="n">fbInMotionTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
                <span class="n">fbResetNC</span><span class="o">.</span><span class="n">Reset</span><span class="p">(</span> <span class="p">);</span>
                <span class="n">fbInMotionTimer</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">nTestStateStep</span> <span class="o">:=</span> <span class="n">nTestStateStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="mi">2</span> <span class="p">:</span>
            <span class="o">//</span> <span class="n">Do</span> <span class="n">nothing</span>
    <span class="n">END_CASE</span>

    <span class="n">fbResetNC</span><span class="p">();</span>

    <span class="n">IF</span> <span class="n">fbTestTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbMoveAbsoluteNC</span><span class="o">.</span><span class="n">Aborted</span><span class="p">,</span>
                   <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Expected CommandAborted&#39;</span><span class="p">);</span>
        <span class="n">AssertTrue</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbResetNC</span><span class="o">.</span><span class="n">Done</span><span class="p">,</span>
                    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Expected Done&#39;</span><span class="p">);</span>
        <span class="n">AssertFalse</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbResetNC</span><span class="o">.</span><span class="n">Busy</span><span class="p">,</span>
                    <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Expected not busy&#39;</span><span class="p">);</span>
        <span class="n">fbTestTimer</span><span class="o">.</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">put</span> <span class="n">this</span> <span class="n">line</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">the</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">Moveabsolute</span> <span class="n">test</span> <span class="n">to</span> <span class="n">start</span> <span class="n">Reset</span> <span class="n">tests</span>
        <span class="n">eMCUnderTest</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">TEST_FINISHED</span><span class="p">();</span>
    <span class="n">END_IF</span>

<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">GivenThatWeStartMoveAbsoluteExpectToBeDoneAndRetainDone</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Ready</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">Ready</span> <span class="n">THEN</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">__POUNAME</span><span class="p">());</span>

<span class="n">CASE</span> <span class="n">nTestStateStep</span> <span class="n">OF</span>
    <span class="mi">0</span> <span class="p">:</span>
        <span class="n">fbPower</span><span class="p">(</span><span class="n">Axis</span> <span class="o">:=</span> <span class="n">fbMyAxisRef_Test1</span><span class="p">,</span>
                <span class="n">Enable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
                <span class="n">Enable_Positive</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
                <span class="n">Enable_Negative</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
                <span class="n">Override</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">);</span>
        <span class="n">IF</span> <span class="n">fbPower</span><span class="o">.</span><span class="n">Status</span> <span class="n">THEN</span>
            <span class="n">nTestStateStep</span> <span class="o">:=</span> <span class="n">nTestStateStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">1</span> <span class="p">:</span>
        <span class="n">fbMoveAbsoluteNC</span><span class="o">.</span><span class="n">MoveAbsolute</span><span class="p">(</span><span class="n">Position</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">,</span>
                                      <span class="n">Velocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">,</span>
                                      <span class="n">Acceleration</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">,</span>
                                      <span class="n">Deceleration</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">);</span>
        <span class="n">nTestStateStep</span> <span class="o">:=</span> <span class="n">nTestStateStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

    <span class="mi">2</span> <span class="p">:</span>
        <span class="o">//</span> <span class="n">Do</span> <span class="n">nothing</span>
<span class="n">END_CASE</span>

<span class="n">fbTestTimer</span><span class="p">();</span>

<span class="n">IF</span> <span class="n">fbTestTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">put</span> <span class="n">this</span> <span class="n">line</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">the</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">Moveabsolute</span> <span class="n">test</span> <span class="n">to</span> <span class="n">start</span> <span class="n">halt</span> <span class="n">tests</span>
    <span class="n">fbTestTimer</span><span class="o">.</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestStateStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">eMCUnderTest</span> <span class="o">:=</span> <span class="n">MoveAbsoluteAndHalt</span><span class="p">;</span>

    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbMoveAbsoluteNC</span><span class="o">.</span><span class="n">Done</span><span class="p">,</span>
               <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Expected done&#39;</span><span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span><span class="n">Condition</span> <span class="o">:=</span> <span class="n">fbMoveAbsoluteNC</span><span class="o">.</span><span class="n">Busy</span><span class="p">,</span>
                <span class="n">Message</span> <span class="o">:=</span> <span class="s1">&#39;Expected not busy&#39;</span><span class="p">);</span>

    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-backlashcompensationnc">FB_BacklashCompensationNC</a></p></li>
<li><p><a class="reference internal" href="#fb-haltnc">FB_HaltNC</a></p></li>
<li><p><a class="reference internal" href="#fb-moveabsolutenc">FB_MoveAbsoluteNC</a></p></li>
<li><p><a class="reference internal" href="#fb-resetnc">FB_ResetNC</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-paramssaverestorenc">
<h2>FB_ParamsSaveRestoreNC<a class="headerlink" href="#fb-paramssaverestorenc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ParamsSaveRestoreNC</span> <span class="n">IMPLEMENTS</span> <span class="n">I_ParamSaveRestore</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_copy&#39;</span><span class="p">}</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">iPersistentDataStorage</span> <span class="p">:</span> <span class="n">I_PersistentDataStorage</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">save</span> <span class="ow">and</span> <span class="n">restore</span>
    <span class="n">fbSetPos</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">bClearPositionLag</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">nLatchErrId</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bRestoreDone</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bRestoreError</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nRestoreErrorID</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">save</span> <span class="ow">and</span> <span class="n">Restore</span>
    <span class="n">RestoreTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bRestoreInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bRestoreLoad</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nLatchError</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">bEncError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tRetryDelay</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1S;</span>
    <span class="n">tRefreshDelay</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1S;</span>
    <span class="n">bUpdateEnable</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nMaxRetries</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">nCurrTries</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bRestoreWaitRetry</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tonRestoreRetry</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">tRefreshTime</span> <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1S;</span>
    <span class="n">bError</span>                          <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span>                        <span class="p">:</span> <span class="n">UDINT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span><span class="p">;</span>

    <span class="n">bSaveEnabled</span>    <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span> <span class="n">PERSISTENT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;conditionalshow&#39;</span><span class="p">}</span>
    <span class="n">bSaved</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;conditionalshow&#39;</span><span class="p">}</span>
    <span class="n">fSavedPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">iPersistentDataStorage</span> <span class="p">:</span> <span class="n">I_PersistentDataStorage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iPersistentDataStorage</span> <span class="o">:=</span> <span class="n">iPersistentDataStorage</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">iPersistentDataStorage</span> <span class="p">:</span> <span class="n">I_PersistentDataStorage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">iPersistentDataStorage</span> <span class="o">:=</span> <span class="n">iPersistentDataStorage</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">METHOD</span> <span class="n">RestoreAxisParams</span>
<span class="o">//</span> <span class="n">Trigger</span> <span class="n">a</span> <span class="n">load</span> <span class="k">if</span> <span class="n">anything</span> <span class="n">was</span> <span class="n">saved</span> <span class="n">at</span> <span class="nb">all</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bRestoreInit</span> <span class="n">THEN</span>
    <span class="n">bRestoreInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bRestoreLoad</span> <span class="n">S</span><span class="o">=</span> <span class="n">bSaved</span><span class="p">;</span>
    <span class="n">fbSetPos</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">ClearPositionLag</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">our</span> <span class="n">position</span> <span class="k">if</span> <span class="n">bRestoreLoad</span> <span class="ow">is</span> <span class="n">true</span>
<span class="n">fbSetPos</span><span class="p">(</span> <span class="n">Axis</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">,</span> <span class="n">Execute</span><span class="o">:=</span><span class="n">bRestoreLoad</span><span class="p">,</span> <span class="n">Position</span><span class="o">:=</span><span class="n">fSavedPosition</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Only</span> <span class="n">load</span> <span class="n">once</span><span class="p">,</span> <span class="n">at</span> <span class="n">startup</span>
<span class="n">bRestoreLoad</span> <span class="n">R</span><span class="o">=</span> <span class="n">fbSetPos</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">fbSetPos</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">fbSetPos</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Keep</span> <span class="n">the</span> <span class="n">error</span> <span class="n">latched</span><span class="p">,</span> <span class="n">it</span> <span class="n">can</span> <span class="n">disappear</span> <span class="k">if</span> <span class="n">Execute</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">FALSE</span>
    <span class="n">nLatchError</span> <span class="o">:=</span> <span class="n">fbSetPos</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
    <span class="n">nCurrTries</span> <span class="o">:=</span> <span class="n">nCurrTries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">nCurrTries</span> <span class="o">&gt;=</span> <span class="n">nMaxRetries</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Alert</span> <span class="n">the</span> <span class="n">user</span> <span class="n">that</span> <span class="n">something</span> <span class="n">has</span> <span class="n">gone</span> <span class="n">wrong</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">nLatchError</span><span class="p">;</span>
        <span class="n">sMessage</span> <span class="o">:=</span> <span class="s1">&#39;Error loading previously saved position.&#39;</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">FB</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">retry</span>
        <span class="n">fbSetPos</span><span class="p">(</span> <span class="n">Axis</span><span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">,</span> <span class="n">Execute</span><span class="o">:=</span><span class="n">bRestoreLoad</span><span class="p">,</span> <span class="n">Position</span><span class="o">:=</span><span class="n">fSavedPosition</span><span class="p">);</span>
        <span class="o">//</span> <span class="n">Try</span> <span class="n">again</span>
        <span class="n">bRestoreWaitRetry</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">THIS</span><span class="o">^.</span><span class="n">bRestoreDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">tonRestoreRetry</span><span class="p">(</span> <span class="n">IN</span> <span class="o">:=</span> <span class="n">bRestoreWaitRetry</span><span class="p">,</span> <span class="n">PT</span> <span class="o">:=</span> <span class="n">tRetryDelay</span><span class="p">);</span>
<span class="n">bRestoreLoad</span> <span class="n">S</span><span class="o">=</span> <span class="n">tonRestoreRetry</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bRestoreWaitRetry</span> <span class="n">R</span><span class="o">=</span> <span class="n">tonRestoreRetry</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">SaveAxisParams</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Enable</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bSaveEnabled</span> <span class="o">:=</span> <span class="n">Enable</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Done</span> <span class="o">:=</span> <span class="n">bRestoreDone</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">bError</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">nErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Message</span> <span class="o">:=</span> <span class="n">sMessage</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">SavedPosition</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">SavedPosition</span> <span class="o">:=</span> <span class="n">fSavedPosition</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
</section>
<section id="fb-permotorffond">
<h2>FB_PerMotorFFOND<a class="headerlink" href="#fb-permotorffond" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PerMotorFFOND</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">PMPS</span> <span class="n">fast</span> <span class="n">faults</span> <span class="n">that</span> <span class="n">must</span> <span class="n">be</span> <span class="n">done</span> <span class="n">per</span> <span class="n">motor</span><span class="p">,</span> <span class="n">rather</span> <span class="n">than</span> <span class="n">per</span> <span class="n">state</span><span class="p">,</span> <span class="n">based</span> <span class="n">purely</span>
    <span class="n">on</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">status</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other</span> <span class="n">PMPS</span> <span class="n">considerations</span><span class="o">.</span>

    <span class="n">These</span> <span class="n">currently</span> <span class="n">include</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Fault</span> <span class="k">if</span> <span class="n">the</span> <span class="n">encoder</span> <span class="n">has</span> <span class="n">an</span> <span class="n">error</span><span class="o">.</span> <span class="n">Every</span> <span class="n">other</span> <span class="n">protection</span> <span class="ow">is</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">encoder</span><span class="p">,</span>
      <span class="n">so</span> <span class="n">we</span> <span class="n">can</span><span class="s1">&#39;t trust anything if the encoder is faulting.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">motors</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">state</span> <span class="n">mover</span><span class="o">.</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">we</span><span class="s1">&#39;re actually using</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Identifying</span> <span class="n">name</span> <span class="n">to</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">group</span> <span class="n">fast</span> <span class="n">faults</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">arrays</span> <span class="n">don</span><span class="s1">&#39;t have the same bounds. In this FB, that&#39;</span><span class="n">s</span> <span class="n">an</span> <span class="n">automatic</span> <span class="n">fault</span><span class="o">.</span>
    <span class="n">bMotorCountError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">afbEncError</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_EncErrorFFO</span><span class="p">;</span>
    <span class="n">ffProgrammerError</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CheckCount</span><span class="p">();</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMotorCountError</span> <span class="n">THEN</span>
    <span class="n">HandleLoops</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">HandleFFO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">CheckCount</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">valid</span> <span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">,</span> <span class="n">less</span> <span class="ow">or</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">max</span><span class="p">)</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&gt;</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandleFFO</span><span class="p">:</span>
<span class="n">ffProgrammerError</span><span class="p">(</span>
    <span class="n">i_xOK</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bMotorCountError</span><span class="p">,</span>
    <span class="n">i_xAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_DevName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">i_Desc</span><span class="o">:=</span><span class="s1">&#39;Programmer error picking motor count&#39;</span><span class="p">,</span>
    <span class="n">i_TypeCode</span><span class="o">:=</span><span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">INTERNAL_ERROR</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandleLoops</span><span class="p">:</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">afbEncError</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span>
        <span class="n">stMotionstage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
        <span class="n">bAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#fb-encerrorffo">FB_EncErrorFFO</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-permotorffond-test">
<h2>FB_PerMotorFFOND_Test<a class="headerlink" href="#fb-permotorffond-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PerMotorFFOND_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">FFO</span> <span class="k">if</span> <span class="n">an</span> <span class="n">illogical</span> <span class="n">motor</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">passed</span>
    <span class="n">FFO</span> <span class="k">if</span> <span class="nb">any</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">what</span> <span class="n">looks</span> <span class="n">like</span> <span class="n">an</span> <span class="n">encoder</span> <span class="n">error</span>
       <span class="o">-</span> <span class="n">We</span><span class="s1">&#39;ll just simulate this without doing it legit</span>
       <span class="o">-</span> <span class="n">The</span> <span class="n">legit</span> <span class="n">test</span> <span class="ow">is</span> <span class="n">done</span> <span class="n">elsewhere</span>
    <span class="n">More</span> <span class="n">FFOs</span> <span class="n">may</span> <span class="n">be</span> <span class="n">added</span> <span class="n">later</span> <span class="ow">and</span> <span class="n">these</span> <span class="n">will</span> <span class="n">need</span> <span class="n">to</span> <span class="n">be</span> <span class="n">tested</span> <span class="n">too</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TestBlankCount</span><span class="p">();</span>
<span class="n">TestTwoMotorEncError</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestBlankCount</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFO</span><span class="p">:</span> <span class="n">FB_PerMotorFFOND</span><span class="p">;</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestBlankCount&#39;</span><span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Started with a fault&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFO</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Blank count did not fault&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFO</span><span class="o">.</span><span class="n">bMotorCountError</span><span class="p">,</span>
    <span class="s1">&#39;Blank count did not error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestTwoMotorEncError</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFO</span><span class="p">:</span> <span class="n">FB_PerMotorFFOND</span><span class="p">;</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestTwoMotorEncError&#39;</span><span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Started with a fault&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#4467; // Invalid encoder position data</span>
<span class="n">fbFFO</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Encoder error did not fault&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-permotorffond">FB_PerMotorFFOND</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-persistentdatastorage">
<h2>FB_PersistentDataStorage<a class="headerlink" href="#fb-persistentdatastorage" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{attribute &#39;reflection&#39;}
FUNCTION_BLOCK FB_PersistentDataStorage IMPLEMENTS I_PersistentDataStorage
VAR
    nNumberOfFails : LINT := 0;
    bTriggerWriteOfPersistentData : BOOL;
    fbWritePersistentData : WritePersistentData := (NETID := &#39;127.0.0.1.1.1&#39;, PORT := 851, TMOUT := T#20S);
    eWritePersistentDataState : (WAITING, TRIGGER_WRITE, CONFIRM_WRITE);
END_VAR
VAR_TEMP
    sConcatString : T_MaxString;
END_VAR
CASE eWritePersistentDataState OF
    WAITING :
        IF bTriggerWriteOfPersistentData THEN
            eWritePersistentDataState := TRIGGER_WRITE;
        END_IF

    TRIGGER_WRITE :
        fbWritePersistentData(START := TRUE);
        eWritePersistentDataState := CONFIRM_WRITE;

    CONFIRM_WRITE :
        fbWritePersistentData(START := FALSE);
        IF fbWritePersistentData.ERR THEN
            IF nNumberOfFails &lt; 3 THEN
                nNumberOfFails := nNumberOfFails + 1;
            ELSE
                sConcatString := CONCAT(STR1 := &#39;Not possible to write persistent data, got the following ErrorId from the function block $&#39;WritePersistentData$&#39;: &#39;,
                                        STR2 := TO_STRING(fbWritePersistentData.ERRID));
                GVL_Logger.fbRootLogger(sMsg := sConcatString,
                                        eSevr := TcEventSeverity.Warning,
                                        eSubsystem := E_SubSystem.MOTION);
                nNumberOfFails := 0;
            END_IF
            eWritePersistentDataState := WAITING;
        ELSIF NOT fbWritePersistentData.BUSY THEN
            nNumberOfFails := 0;
            eWritePersistentDataState := WAITING;
        END_IF
END_CASE

IF bTriggerWriteOfPersistentData AND nNumberOfFails = 0 THEN
    bTriggerWriteOfPersistentData := FALSE;
END_IF

END_FUNCTION_BLOCK

PROPERTY TriggerWriteOfPersistentData : BOOL
VAR
END_VAR
TriggerWriteOfPersistentData := bTriggerWriteOfPersistentData;
END_PROPERTY

PROPERTY TriggerWriteOfPersistentData : BOOL
VAR
END_VAR
bTriggerWriteOfPersistentData := TriggerWriteOfPersistentData;
END_PROPERTY
</pre></div>
</div>
</section>
<section id="fb-pmpsjsontesthelper">
<h2>FB_PMPSJsonTestHelper<a class="headerlink" href="#fb-pmpsjsontesthelper" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PMPSJsonTestHelper</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Create</span> <span class="n">a</span> <span class="n">JSON</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">memory</span> <span class="n">to</span> <span class="n">match</span> <span class="n">the</span> <span class="nb">input</span> <span class="n">structs</span>
    <span class="n">Assumes</span> <span class="mi">1</span> <span class="n">device</span> <span class="k">for</span> <span class="n">simplicity</span>
    <span class="n">Writes</span> <span class="n">to</span> <span class="n">the</span> <span class="k">global</span> <span class="n">pmps</span> <span class="n">json</span> <span class="n">doc</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">astBeamParams</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sDevName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">jsonRoot</span><span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">jsonDevice</span><span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">ajsonState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">fbJson</span><span class="p">:</span> <span class="n">FB_JsonDomParser</span><span class="p">;</span>

    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nId</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>

    <span class="n">aseVRange</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">asRate</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">asBCRange</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">asTran</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">jsonRoot</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">NewDocument</span><span class="p">();</span>
<span class="n">jsonDevice</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">AddObjectMember</span><span class="p">(</span><span class="n">jsonRoot</span><span class="p">,</span> <span class="n">sDevName</span><span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="n">LOWER_BOUND</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">TO</span> <span class="n">UPPER_BOUND</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">DO</span>
    <span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">AddObjectMember</span><span class="p">(</span><span class="n">jsonDevice</span><span class="p">,</span> <span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">);</span>

    <span class="n">nId</span> <span class="o">:=</span> <span class="n">nId</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddIntMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">nId</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;beamline&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;tst&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">aseVRange</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">bitmaskToString</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;neVRange&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">aseVRange</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">asRate</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">UDINT_TO_STRING</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nRate</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;nRate&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">asRate</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_ygap&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_xgap&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;damage_limit&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;notes&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;reactive_temp&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;reactive_pressure&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">asBCRange</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">bitmaskToString</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;nBeamClassRange&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">asBCRange</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">asTran</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">REAL_TO_STRING</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nTran</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;nTran&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">asTran</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_name&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_ycenter&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_xcenter&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;pulse_energy&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddBoolMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;special&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">BP_jsonDoc</span> <span class="o">:=</span> <span class="n">jsonRoot</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">bitmaskToString</span> <span class="p">:</span> <span class="n">STRING</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nBitmask</span><span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="n">nBits</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bitmaskToString</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nBits</span> <span class="n">DO</span>
    <span class="n">bitmaskToString</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">DWORD_TO_STRING</span><span class="p">(</span><span class="n">SHR</span><span class="p">(</span><span class="n">nBitmask</span><span class="p">,</span> <span class="n">nIter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AND</span> <span class="mi">1</span><span class="p">),</span> <span class="n">bitmaskToString</span><span class="p">);</span>
<span class="n">END_FOR</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
</section>
<section id="fb-positionstate1d">
<h2>FB_PositionState1D<a class="headerlink" href="#fb-positionstate1d" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionState1D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="mi">1</span><span class="o">-</span><span class="n">Dimensional</span> <span class="n">position</span> <span class="n">state</span> <span class="n">function</span> <span class="n">block</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">move</span> <span class="n">a</span> <span class="n">motor</span> <span class="n">among</span> <span class="n">some</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">use</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">state</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">give</span> <span class="n">them</span> <span class="n">pytmc</span> <span class="n">pragmas</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">FB_PositionState1D_InOut</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">example</span><span class="o">.</span>
    <span class="n">These</span> <span class="n">enums</span> <span class="n">must</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="ow">and</span> <span class="n">eEnumGet</span> <span class="n">VAR_IN_OUT</span> <span class="n">variables</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">enum</span> <span class="n">values</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">array</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">astPositionState</span><span class="o">.</span>

    <span class="n">A</span> <span class="n">move</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">when</span> <span class="n">eEnumSet</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span> <span class="n">value</span><span class="o">.</span> <span class="n">eEnumSet</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">allowing</span> <span class="n">us</span>
    <span class="n">to</span> <span class="n">accept</span> <span class="n">a</span> <span class="n">new</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">move</span> <span class="n">request</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="n">the</span> <span class="n">first</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motor</span> <span class="n">must</span> <span class="n">already</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">point</span> <span class="n">motion</span> <span class="n">via</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">,</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">work</span> <span class="n">properly</span><span class="o">.</span>

    <span class="n">With</span> <span class="n">no</span> <span class="n">PMPS</span> <span class="n">handling</span><span class="p">,</span> <span class="n">this</span> <span class="n">FB</span> <span class="n">basically</span> <span class="n">just</span> <span class="n">links</span> <span class="n">the</span> <span class="n">state</span> <span class="n">names</span> <span class="k">with</span> <span class="n">positions</span> <span class="ow">in</span> <span class="n">both</span> <span class="n">directions</span> <span class="k">for</span> <span class="nb">set</span> <span class="ow">and</span> <span class="n">readback</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span><span class="o">.</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">;</span>

<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">astPositionState</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstate1d-inout">
<h2>FB_PositionState1D_InOut<a class="headerlink" href="#fb-positionstate1d-inout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionState1D_InOut</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">An</span> <span class="n">example</span> <span class="ow">and</span> <span class="n">usable</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="n">instance</span> <span class="k">for</span> <span class="n">a</span> <span class="mi">1</span><span class="n">D</span> <span class="n">state</span> <span class="n">device</span> <span class="k">with</span> <span class="n">just</span> <span class="n">an</span> <span class="n">IN</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">a</span> <span class="n">stage</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">into</span> <span class="n">the</span> <span class="n">FB</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Simplify</span> <span class="n">the</span> <span class="n">interface</span><span class="p">,</span> <span class="n">the</span> <span class="n">user</span> <span class="n">just</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">construct</span> <span class="ow">and</span> <span class="k">pass</span> <span class="ow">in</span> <span class="ow">and</span> <span class="n">out</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">a</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">expected</span> <span class="n">this</span> <span class="n">will</span> <span class="n">be</span> <span class="n">written</span> <span class="n">to</span> <span class="n">during</span> <span class="n">one</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">so</span> <span class="n">don</span><span class="s1">&#39;t continually apply a value here in the PLC code.</span>
    <span class="o">//</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">exposed</span> <span class="k">as</span> <span class="n">an</span> <span class="nb">input</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">test</span> <span class="n">it</span> <span class="n">using</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateReq</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="n">report</span> <span class="n">the</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateGet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">fb</span> <span class="k">with</span> <span class="n">blank</span> <span class="n">pv</span> <span class="n">pragma</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">fbPositionState1D</span><span class="p">:</span> <span class="n">FB_PositionState1D</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">standard</span> <span class="n">fb</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">full</span> <span class="n">array</span> <span class="n">of</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Optional</span><span class="p">:</span> <span class="n">default</span> <span class="n">state</span> <span class="n">names</span>
<span class="n">IF</span> <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Assemble</span> <span class="n">the</span> <span class="n">states</span> <span class="n">array</span><span class="p">,</span> <span class="n">matching</span> <span class="n">the</span> <span class="n">enum</span> <span class="n">values</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">main</span> <span class="n">function</span> <span class="n">block</span><span class="p">,</span> <span class="n">passing</span> <span class="n">our</span> <span class="n">motors</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">enums</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">enable</span>
<span class="n">fbPositionState1D</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eStateReq</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eStateGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Send</span> <span class="n">updates</span> <span class="n">made</span> <span class="n">on</span> <span class="n">the</span> <span class="n">array</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">inputs</span> <span class="p">(</span><span class="n">VAR_IN_OUT</span><span class="p">)</span> <span class="k">for</span> <span class="n">maximum</span> <span class="n">clarity</span>
<span class="n">stOut</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">stIn</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsinout">E_EpicsInOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstate2d">
<h2>FB_PositionState2D<a class="headerlink" href="#fb-positionstate2d" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionState2D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="mi">2</span><span class="o">-</span><span class="n">Dimensional</span> <span class="n">position</span> <span class="n">state</span> <span class="n">function</span> <span class="n">block</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">move</span> <span class="mi">2</span> <span class="n">motors</span> <span class="n">among</span> <span class="n">some</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">use</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">state</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">give</span> <span class="n">them</span> <span class="n">pytmc</span> <span class="n">pragmas</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">FB_PositionState1D_InOut</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">example</span><span class="o">.</span>
    <span class="n">These</span> <span class="n">enums</span> <span class="n">must</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="ow">and</span> <span class="n">eEnumGet</span> <span class="n">VAR_IN_OUT</span> <span class="n">variables</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">enum</span> <span class="n">values</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">array</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">astPositionState1</span> <span class="ow">and</span> <span class="n">astPositionState2</span><span class="o">.</span>

    <span class="n">A</span> <span class="n">move</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">when</span> <span class="n">eEnumSet</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span> <span class="n">value</span><span class="o">.</span> <span class="n">eEnumSet</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">allowing</span> <span class="n">us</span>
    <span class="n">to</span> <span class="n">accept</span> <span class="n">a</span> <span class="n">new</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">move</span> <span class="n">request</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="n">the</span> <span class="n">first</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motors</span> <span class="n">must</span> <span class="n">already</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">point</span> <span class="n">motion</span> <span class="n">via</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">,</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">work</span> <span class="n">properly</span><span class="o">.</span>

    <span class="n">With</span> <span class="n">no</span> <span class="n">PMPS</span> <span class="n">handling</span><span class="p">,</span> <span class="n">this</span> <span class="n">FB</span> <span class="n">basically</span> <span class="n">just</span> <span class="n">links</span> <span class="n">the</span> <span class="n">state</span> <span class="n">names</span> <span class="k">with</span> <span class="n">positions</span> <span class="ow">in</span> <span class="n">both</span> <span class="n">directions</span> <span class="k">for</span> <span class="nb">set</span> <span class="ow">and</span> <span class="n">readback</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">1</span><span class="n">st</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">1</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="mi">01</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">2</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="mi">02</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage1</span><span class="p">;</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage2</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">;</span>

<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stMotionStage1</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stMotionStage2</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">astPositionState1</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">astPositionState2</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstate2d-inout">
<h2>FB_PositionState2D_InOut<a class="headerlink" href="#fb-positionstate2d-inout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionState2D_InOut</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">An</span> <span class="n">example</span> <span class="ow">and</span> <span class="n">usable</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="n">instance</span> <span class="k">for</span> <span class="n">a</span> <span class="mi">2</span><span class="n">D</span> <span class="n">state</span> <span class="n">device</span> <span class="k">with</span> <span class="n">just</span> <span class="n">an</span> <span class="n">IN</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">stages</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">into</span> <span class="n">the</span> <span class="n">FB</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Simplify</span> <span class="n">the</span> <span class="n">interface</span><span class="p">,</span> <span class="n">the</span> <span class="n">user</span> <span class="n">just</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">construct</span> <span class="ow">and</span> <span class="k">pass</span> <span class="ow">in</span> <span class="ow">and</span> <span class="n">out</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">stIn1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stOut1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stIn2</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stOut2</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">a</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">expected</span> <span class="n">this</span> <span class="n">will</span> <span class="n">be</span> <span class="n">written</span> <span class="n">to</span> <span class="n">during</span> <span class="n">one</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">so</span> <span class="n">don</span><span class="s1">&#39;t continually apply a value here in the PLC code.</span>
    <span class="o">//</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">exposed</span> <span class="k">as</span> <span class="n">an</span> <span class="nb">input</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">test</span> <span class="n">it</span> <span class="n">using</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateSet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="n">report</span> <span class="n">the</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateGet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">fb</span> <span class="k">with</span> <span class="n">blank</span> <span class="n">pv</span> <span class="n">pragma</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">fbPositionState2D</span><span class="p">:</span> <span class="n">FB_PositionState2D</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">standard</span> <span class="n">fb</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">full</span> <span class="n">array</span> <span class="n">of</span> <span class="n">position</span> <span class="n">states</span> <span class="n">per</span> <span class="n">motor</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Optional</span><span class="p">:</span> <span class="n">default</span> <span class="n">state</span> <span class="n">names</span>
<span class="n">IF</span> <span class="n">stIn1</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stIn1</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stOut1</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stOut1</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stIn2</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stIn2</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stOut2</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stOut2</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Assemble</span> <span class="n">the</span> <span class="n">states</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">matching</span> <span class="n">the</span> <span class="n">enum</span> <span class="n">values</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut1</span><span class="p">;</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn1</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut2</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn2</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">main</span> <span class="n">function</span> <span class="n">block</span><span class="p">,</span> <span class="n">passing</span> <span class="n">our</span> <span class="n">motors</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">enable</span>
<span class="n">fbPositionState2D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eStateSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eStateGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Send</span> <span class="n">updates</span> <span class="n">made</span> <span class="n">on</span> <span class="n">the</span> <span class="n">array</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">inputs</span> <span class="p">(</span><span class="n">VAR_IN_OUT</span><span class="p">)</span> <span class="k">for</span> <span class="n">maximum</span> <span class="n">clarity</span>
<span class="n">stOut1</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">stIn1</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">];</span>
<span class="n">stOut2</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">stIn2</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsinout">E_EpicsInOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate2d">FB_PositionState2D</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstate3d">
<h2>FB_PositionState3D<a class="headerlink" href="#fb-positionstate3d" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionState3D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="mi">3</span><span class="o">-</span><span class="n">Dimensional</span> <span class="n">position</span> <span class="n">state</span> <span class="n">function</span> <span class="n">block</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">move</span> <span class="mi">3</span> <span class="n">motors</span> <span class="n">among</span> <span class="n">some</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">use</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">state</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">give</span> <span class="n">them</span> <span class="n">pytmc</span> <span class="n">pragmas</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">FB_PositionState1D_InOut</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">example</span><span class="o">.</span>
    <span class="n">These</span> <span class="n">enums</span> <span class="n">must</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="ow">and</span> <span class="n">eEnumGet</span> <span class="n">VAR_IN_OUT</span> <span class="n">variables</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">enum</span> <span class="n">values</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">array</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">astPositionState1</span><span class="p">,</span> <span class="n">astPositionState2</span><span class="p">,</span> <span class="ow">and</span> <span class="n">astPositionState3</span><span class="o">.</span>

    <span class="n">A</span> <span class="n">move</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">when</span> <span class="n">eEnumSet</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span> <span class="n">value</span><span class="o">.</span> <span class="n">eEnumSet</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">allowing</span> <span class="n">us</span>
    <span class="n">to</span> <span class="n">accept</span> <span class="n">a</span> <span class="n">new</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">move</span> <span class="n">request</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="n">the</span> <span class="n">first</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motors</span> <span class="n">must</span> <span class="n">already</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">point</span> <span class="n">motion</span> <span class="n">via</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">,</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">work</span> <span class="n">properly</span><span class="o">.</span>

    <span class="n">With</span> <span class="n">no</span> <span class="n">PMPS</span> <span class="n">handling</span><span class="p">,</span> <span class="n">this</span> <span class="n">FB</span> <span class="n">basically</span> <span class="n">just</span> <span class="n">links</span> <span class="n">the</span> <span class="n">state</span> <span class="n">names</span> <span class="k">with</span> <span class="n">positions</span> <span class="ow">in</span> <span class="n">both</span> <span class="n">directions</span> <span class="k">for</span> <span class="nb">set</span> <span class="ow">and</span> <span class="n">readback</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">1</span><span class="n">st</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">3</span><span class="n">rd</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage3</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">1</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="mi">01</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">2</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="mi">02</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">3</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="mi">03</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState3</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage1</span><span class="p">;</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage2</span><span class="p">;</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage3</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState3</span><span class="p">;</span>

<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stMotionStage1</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stMotionStage2</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">stMotionStage3</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="n">astPositionState1</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">astPositionState2</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">astPositionState3</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatebase">
<h2>FB_PositionStateBase<a class="headerlink" href="#fb-positionstatebase" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionState1D instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateBase</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Handles</span> <span class="n">EPICS</span> <span class="n">moves</span> <span class="n">between</span> <span class="n">multiple</span> <span class="n">states</span> <span class="k">for</span> <span class="n">a</span> <span class="n">single</span> <span class="n">axis</span>
    <span class="n">Should</span> <span class="n">be</span> <span class="n">subclassed</span> <span class="k">for</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">enumSet</span> <span class="ow">and</span> <span class="n">enumGet</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">body</span> <span class="n">comment</span>  <span class="ow">or</span> <span class="n">FB_PositionStateInOut</span> <span class="k">for</span> <span class="n">an</span> <span class="n">implementation</span> <span class="n">example</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">start</span> <span class="n">a</span> <span class="n">move</span> <span class="n">when</span> <span class="n">setState</span> <span class="n">transitions</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">number</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">On</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">reset</span> <span class="n">this</span> <span class="n">FB</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RESET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">error</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">ID</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRID</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">error</span> <span class="n">that</span> <span class="n">caused</span> <span class="n">bError</span> <span class="n">to</span> <span class="n">flip</span> <span class="n">TRUE</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRMSG</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">motor</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BUSY</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">last</span> <span class="n">move</span> <span class="n">completed</span> <span class="n">successfully</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DONE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Pre</span><span class="o">-</span><span class="n">allocated</span> <span class="n">array</span> <span class="n">of</span> <span class="n">states</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">arrStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Corresponding</span> <span class="n">arrStates</span> <span class="n">index</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span><span class="p">,</span> <span class="ow">or</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">no</span> <span class="n">move</span> <span class="n">selected</span>
    <span class="n">setState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">we</span> <span class="n">are</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">reach</span><span class="p">,</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="n">goalState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">readback</span> <span class="n">position</span>
    <span class="n">getState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">stUnknown</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stGoal</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbStateMove</span><span class="p">:</span> <span class="n">FB_PositionStateMove</span><span class="p">;</span>
    <span class="n">fbStateInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bNewGoal</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInnerExec</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInnerReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bMoveRequested</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Subclass</span> <span class="n">me</span><span class="p">,</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">to</span> <span class="n">translate</span> <span class="n">setState</span> <span class="ow">and</span> <span class="n">getState</span><span class="p">,</span> <span class="n">call</span> <span class="n">Exec</span>

    <span class="n">Example</span><span class="p">:</span>

    <span class="o">&lt;</span><span class="n">something</span> <span class="n">to</span> <span class="n">fill</span> <span class="n">arrStates</span><span class="o">&gt;</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
    <span class="n">Exec</span><span class="p">();</span>
    <span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
    <span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">Exec</span><span class="p">:</span>
<span class="n">StateHandler</span><span class="p">();</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">StateHandler</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Reset</span> <span class="n">just</span> <span class="n">goes</span> <span class="n">through</span> <span class="n">the</span> <span class="n">first</span><span class="o">-</span><span class="n">cycle</span> <span class="n">init</span> <span class="n">again</span>
<span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bReset</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">First</span><span class="o">-</span><span class="n">cycle</span> <span class="n">init</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorID</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bNewGoal</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goalState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">All</span> <span class="n">state</span> <span class="n">internal</span> <span class="n">handlers</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
        <span class="n">fbStateInternal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">](</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">arrStates</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]);</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">Check</span> <span class="n">where</span> <span class="n">we</span> <span class="n">are</span> <span class="n">by</span> <span class="n">going</span> <span class="n">through</span> <span class="nb">all</span> <span class="n">possible</span> <span class="n">states</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Note</span> <span class="n">this</span> <span class="n">favors</span> <span class="n">the</span> <span class="n">highest</span><span class="o">-</span><span class="n">number</span> <span class="n">state</span> <span class="n">that</span> <span class="n">we</span><span class="s1">&#39;re at, it&#39;</span><span class="n">s</span> <span class="n">up</span> <span class="n">to</span> <span class="n">you</span> <span class="n">to</span> <span class="n">make</span> <span class="n">your</span> <span class="n">states</span> <span class="n">mutually</span> <span class="n">exclusive</span><span class="o">.</span>
<span class="n">getState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">F_AtPositionState</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span> <span class="n">stPositionState</span><span class="o">:=</span><span class="n">arrStates</span><span class="p">[</span><span class="n">nIndex</span><span class="p">])</span> <span class="n">THEN</span>
        <span class="n">getState</span> <span class="o">:=</span> <span class="n">nIndex</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">changing</span> <span class="nb">set</span> <span class="n">pv</span> <span class="k">as</span> <span class="n">a</span> <span class="n">rising</span><span class="o">-</span><span class="n">edge</span> <span class="n">trigger</span>
<span class="n">IF</span> <span class="n">setState</span> <span class="o">&lt;&gt;</span> <span class="n">goalState</span> <span class="n">THEN</span>
    <span class="n">goalState</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>
    <span class="n">bNewGoal</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Special</span> <span class="n">move</span> <span class="n">handling</span> <span class="k">for</span> <span class="n">error</span><span class="o">/</span><span class="n">enable</span> <span class="n">state</span>
<span class="n">IF</span> <span class="n">bError</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">bNewGoal</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="o">//</span> <span class="n">Stop</span> <span class="n">previous</span> <span class="n">move</span> <span class="k">if</span> <span class="n">we</span> <span class="n">were</span> <span class="n">already</span> <span class="n">moving</span> <span class="n">but</span> <span class="n">want</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span>
        <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="o">//</span> <span class="n">If</span> <span class="n">we</span> <span class="n">hit</span> <span class="n">this</span> <span class="n">branch</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;re ready to start a new move</span>
        <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bNewGoal</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Pick</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">goal</span> <span class="n">structure</span> <span class="ow">or</span> <span class="n">Unknown</span>
<span class="n">IF</span> <span class="n">goalState</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stGoal</span> <span class="o">:=</span> <span class="n">stUnknown</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">stGoal</span> <span class="o">:=</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">goalState</span><span class="p">];</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Do</span> <span class="n">the</span> <span class="n">move</span>
<span class="n">fbStateMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span> <span class="o">:=</span> <span class="n">stGoal</span><span class="p">,</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bInnerExec</span><span class="p">,</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">bInnerReset</span><span class="p">,</span>
    <span class="n">enumMotionRequest</span> <span class="o">:=</span> <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="p">,</span>
    <span class="n">bBusy</span> <span class="o">=&gt;</span> <span class="n">bBusy</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Only</span> <span class="k">pass</span> <span class="n">up</span> <span class="n">bDone</span> <span class="n">information</span> <span class="k">if</span> <span class="n">this</span> <span class="n">FB</span> <span class="ow">is</span> <span class="n">active</span>
<span class="n">IF</span> <span class="n">bInnerExec</span> <span class="n">THEN</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">bDone</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Pick</span> <span class="n">up</span> <span class="nb">any</span> <span class="n">new</span> <span class="n">errors</span><span class="p">,</span> <span class="n">but</span> <span class="n">don</span><span class="s1">&#39;t override uncleared existing errors</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">bError</span> <span class="n">THEN</span>
        <span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
        <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">setpoint</span> <span class="ow">and</span> <span class="n">goal</span> <span class="n">to</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re not doing anything</span>
<span class="o">//</span> <span class="n">because</span> <span class="n">FB</span> <span class="ow">is</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">a</span> <span class="n">change</span> <span class="kn">from</span><span class="w"> </span><span class="mi">0</span> <span class="n">to</span> <span class="s2">&quot;something&quot;</span>
<span class="n">bMoveRequested</span> <span class="o">:=</span> <span class="n">bInnerExec</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bDone</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bNewGoal</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bMoveRequested</span> <span class="n">THEN</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goalState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Bring</span> <span class="n">inner</span> <span class="n">reset</span> <span class="n">back</span> <span class="n">low</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">the</span> <span class="n">init</span> <span class="n">cycle</span> <span class="n">so</span> <span class="n">that</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span> <span class="n">triggered</span> <span class="n">again</span> <span class="n">later</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinout">FB_PositionStateInOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemove">FB_PositionStateMove</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatebase-withpmps">
<h2>FB_PositionStateBase_WithPMPS<a class="headerlink" href="#fb-positionstatebase-withpmps" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionStatePMPS1D instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateBase_WithPMPS</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStateBase</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Handles</span> <span class="n">EPICS</span> <span class="n">moves</span> <span class="n">between</span> <span class="n">multiple</span> <span class="n">states</span> <span class="k">for</span> <span class="n">a</span> <span class="n">single</span> <span class="n">axis</span> <span class="k">with</span> <span class="n">PMPS</span><span class="o">.</span>
    <span class="n">Should</span> <span class="n">be</span> <span class="n">subclassed</span> <span class="k">for</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">enumSet</span> <span class="ow">and</span> <span class="n">enumGet</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">body</span> <span class="n">comment</span>  <span class="ow">or</span> <span class="n">FB_PositionStateInOut_WithPMPS</span> <span class="k">for</span> <span class="n">an</span> <span class="n">implementation</span> <span class="n">example</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sPmpsDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PMPS</span><span class="p">:</span><span class="n">ARB</span><span class="p">:</span><span class="n">ENABLE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">bArbiterEnabled</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">tArbiterTimeout</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1s;</span>
    <span class="n">bMoveOnArbiterTimeout</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fStateBoundaryDeadband</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bBPOKAutoReset</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="kc">False</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: PMPS&#39;</span><span class="p">}</span>
    <span class="n">fbStatePMPS</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS</span><span class="p">;</span>
    <span class="n">fbEncErrFFO</span><span class="p">:</span> <span class="n">FB_EncErrorFFO</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Subclass</span> <span class="n">me</span><span class="p">,</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">to</span> <span class="n">translate</span> <span class="n">setState</span> <span class="ow">and</span> <span class="n">getState</span><span class="p">,</span> <span class="n">call</span> <span class="n">Exec</span>

    <span class="n">Example</span><span class="p">:</span>

    <span class="o">&lt;</span><span class="n">something</span> <span class="n">to</span> <span class="n">fill</span> <span class="n">arrStates</span><span class="o">&gt;</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
    <span class="n">Exec</span><span class="p">();</span>
    <span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
    <span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">Exec</span><span class="p">:</span>
<span class="n">StateHandler</span><span class="p">();</span>
<span class="n">PMPSHandler</span><span class="p">();</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">PMPSHandler</span><span class="p">:</span>
<span class="n">fbStatePMPS</span><span class="p">(</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">arrStates</span><span class="o">:=</span><span class="n">arrStates</span><span class="p">,</span>
    <span class="n">sPmpsDeviceName</span><span class="o">:=</span><span class="n">sPmpsDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">stPmpsDoc</span><span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">BP_jsonDoc</span><span class="p">,</span>
    <span class="n">bRequestTransition</span><span class="o">:=</span><span class="n">setState</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">setState</span><span class="o">:=</span><span class="n">setState</span><span class="p">,</span>
    <span class="n">getState</span><span class="o">:=</span><span class="n">getState</span><span class="p">,</span>
    <span class="n">bArbiterEnabled</span><span class="o">:=</span><span class="n">bArbiterEnabled</span><span class="p">,</span>
    <span class="n">tArbiterTimeout</span><span class="o">:=</span><span class="n">tArbiterTimeout</span><span class="p">,</span>
    <span class="n">bMoveOnArbiterTimeout</span><span class="o">:=</span><span class="n">bMoveOnArbiterTimeout</span><span class="p">,</span>
    <span class="n">fStateBoundaryDeadband</span><span class="o">:=</span><span class="n">fStateBoundaryDeadband</span><span class="p">,</span>
    <span class="n">bBPOKAutoReset</span><span class="o">:=</span><span class="n">bBPOKAutoReset</span><span class="p">);</span>

<span class="n">fbEncErrFFO</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-encerrorffo">FB_EncErrorFFO</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatebase">FB_PositionStateBase</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinout-withpmps">FB_PositionStateInOut_WithPMPS</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps">FB_PositionStatePMPS</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatebase-withpmps-test">
<h2>FB_PositionStateBase_WithPMPS_Test<a class="headerlink" href="#fb-positionstatebase-withpmps-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;No longer any reason to use this, all state classes can have unit tests.&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateBase_WithPMPS_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStateBase</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Handles</span> <span class="n">EPICS</span> <span class="n">moves</span> <span class="n">between</span> <span class="n">multiple</span> <span class="n">states</span> <span class="k">for</span> <span class="n">a</span> <span class="n">single</span> <span class="n">axis</span> <span class="k">with</span> <span class="n">fake</span> <span class="n">PMPS</span><span class="o">.</span>
    <span class="n">Should</span> <span class="n">be</span> <span class="n">subclassed</span> <span class="k">for</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">enumSet</span> <span class="ow">and</span> <span class="n">enumGet</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">body</span> <span class="n">comment</span>  <span class="ow">or</span> <span class="n">FB_PositionStateInOut_WithPMPS_Test</span> <span class="k">for</span> <span class="n">an</span> <span class="n">implementation</span> <span class="n">example</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">stTransitionBeam</span><span class="p">:</span> <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">;</span>
    <span class="n">nTransitionAssertionID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbStatePMPS</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS_Test</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Subclass</span> <span class="n">me</span><span class="p">,</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">to</span> <span class="n">translate</span> <span class="n">setState</span> <span class="ow">and</span> <span class="n">getState</span><span class="p">,</span> <span class="n">call</span> <span class="n">Exec</span>

    <span class="n">Example</span><span class="p">:</span>

    <span class="o">&lt;</span><span class="n">something</span> <span class="n">to</span> <span class="n">fill</span> <span class="n">arrStates</span><span class="o">&gt;</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
    <span class="n">Exec</span><span class="p">();</span>
    <span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
    <span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">Exec</span><span class="p">:</span>
<span class="n">StateHandler</span><span class="p">();</span>
<span class="n">PMPSHandler</span><span class="p">();</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">PMPSHandler</span><span class="p">:</span>
<span class="n">fbStatePMPS</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">arrStates</span><span class="o">:=</span><span class="n">arrStates</span><span class="p">,</span>
    <span class="n">bRequestTransition</span><span class="o">:=</span><span class="n">setState</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">setState</span><span class="o">:=</span><span class="n">setState</span><span class="p">,</span>
    <span class="n">getState</span><span class="o">:=</span><span class="n">getState</span><span class="p">);</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstatebase">FB_PositionStateBase</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinout-withpmps-test">FB_PositionStateInOut_WithPMPS_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps-test">FB_PositionStatePMPS_Test</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateinout">
<h2>FB_PositionStateInOut<a class="headerlink" href="#fb-positionstateinout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionState1D_InOut instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateInOut</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStateBase</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Example</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">FB_PositionStateBase</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">IN</span><span class="o">/</span><span class="n">OUT</span> <span class="n">axis</span><span class="o">.</span> <span class="n">See</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">comments</span><span class="o">.</span>
    <span class="n">Also</span> <span class="n">usable</span> <span class="k">as</span> <span class="n">a</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">these</span> <span class="n">cases</span> <span class="p">(</span><span class="n">no</span> <span class="n">need</span> <span class="n">to</span> <span class="n">roll</span> <span class="n">your</span> <span class="n">own</span> <span class="ow">in</span><span class="o">/</span><span class="n">out</span><span class="p">)</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enum</span> <span class="n">position</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumSet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumSet</span>

    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">position</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">pragma</span> <span class="n">these</span><span class="p">,</span> <span class="n">let</span> <span class="n">it</span> <span class="n">happen</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">manager</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">IN</span> <span class="n">position</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enum</span> <span class="n">state</span> <span class="n">readback</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumGet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumGet</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInOutInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInOutInit</span> <span class="n">THEN</span>
    <span class="n">bInOutInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>
    <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
    <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
<span class="n">Exec</span><span class="p">();</span>
<span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
<span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-epicsinout-int">ENUM_EpicsInOut_INT</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatebase">FB_PositionStateBase</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateinout-withpmps">
<h2>FB_PositionStateInOut_WithPMPS<a class="headerlink" href="#fb-positionstateinout-withpmps" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionStatePMPS1D_InOut instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateInOut_WithPMPS</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStateBase_WithPMPS</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Example</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">FB_PositionStateBase_WithPMPS</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">IN</span><span class="o">/</span><span class="n">OUT</span> <span class="n">axis</span><span class="o">.</span> <span class="n">See</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">comments</span><span class="o">.</span>
    <span class="n">Also</span> <span class="n">usable</span> <span class="k">as</span> <span class="n">a</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">these</span> <span class="n">cases</span> <span class="p">(</span><span class="n">no</span> <span class="n">need</span> <span class="n">to</span> <span class="n">roll</span> <span class="n">your</span> <span class="n">own</span> <span class="ow">in</span><span class="o">/</span><span class="n">out</span><span class="p">)</span>

    <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">version</span><span class="o">.</span> <span class="n">Note</span> <span class="n">that</span> <span class="n">the</span> <span class="n">only</span> <span class="n">difference</span> <span class="ow">is</span> <span class="n">that</span> <span class="n">we</span> <span class="n">extend</span> <span class="n">the</span> <span class="n">_WithPMPS</span> <span class="n">FB</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enum</span> <span class="n">position</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumSet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumSet</span>

    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">position</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">pragma</span> <span class="n">these</span><span class="p">,</span> <span class="n">let</span> <span class="n">it</span> <span class="n">happen</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">manager</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">IN</span> <span class="n">position</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enum</span> <span class="n">state</span> <span class="n">readback</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumGet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumGet</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInOutInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInOutInit</span> <span class="n">THEN</span>
    <span class="n">bInOutInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>
    <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
    <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
<span class="n">Exec</span><span class="p">();</span>
<span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
<span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-epicsinout-int">ENUM_EpicsInOut_INT</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatebase-withpmps">FB_PositionStateBase_WithPMPS</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d-inout">FB_PositionStatePMPS1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateinout-withpmps-test">
<h2>FB_PositionStateInOut_WithPMPS_Test<a class="headerlink" href="#fb-positionstateinout-withpmps-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;No longer any reason to use this, all state classes can have unit tests.&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateInOut_WithPMPS_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStateBase_WithPMPS_Test</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Example</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">FB_PositionStateBase_WithPMPS_Test</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">IN</span><span class="o">/</span><span class="n">OUT</span> <span class="n">axis</span><span class="o">.</span> <span class="n">See</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">comments</span><span class="o">.</span>
    <span class="n">Also</span> <span class="n">usable</span> <span class="k">as</span> <span class="n">a</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">these</span> <span class="n">cases</span> <span class="p">(</span><span class="n">no</span> <span class="n">need</span> <span class="n">to</span> <span class="n">roll</span> <span class="n">your</span> <span class="n">own</span> <span class="ow">in</span><span class="o">/</span><span class="n">out</span><span class="p">)</span>

    <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">version</span><span class="o">.</span> <span class="n">Note</span> <span class="n">that</span> <span class="n">the</span> <span class="n">only</span> <span class="n">difference</span> <span class="ow">is</span> <span class="n">that</span> <span class="n">we</span> <span class="n">extend</span> <span class="n">the</span> <span class="n">_WithPMPS_Test</span> <span class="n">FB</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enum</span> <span class="n">position</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumSet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumSet</span>

    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">position</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">pragma</span> <span class="n">these</span><span class="p">,</span> <span class="n">let</span> <span class="n">it</span> <span class="n">happen</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">manager</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">IN</span> <span class="n">position</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enum</span> <span class="n">state</span> <span class="n">readback</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumGet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumGet</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInOutInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInOutInit</span> <span class="n">THEN</span>
    <span class="n">bInOutInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>
    <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
    <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
<span class="n">Exec</span><span class="p">();</span>
<span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
<span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-epicsinout-int">ENUM_EpicsInOut_INT</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatebase-withpmps-test">FB_PositionStateBase_WithPMPS_Test</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateinternal">
<h2>FB_PositionStateInternal<a class="headerlink" href="#fb-positionstateinternal" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateInternal</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Routines</span> <span class="n">that</span> <span class="n">must</span> <span class="n">be</span> <span class="n">called</span> <span class="n">on</span> <span class="nb">all</span> <span class="n">ST_PositionState</span>

    <span class="n">Currently</span><span class="p">,</span> <span class="n">this</span> <span class="n">FB</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">ensures</span> <span class="n">that</span> <span class="n">a</span> <span class="n">position</span> <span class="n">state</span> <span class="n">has</span> <span class="n">both</span> <span class="n">a</span> <span class="n">proper</span> <span class="n">encoder</span> <span class="n">count</span>
      <span class="ow">and</span> <span class="n">a</span> <span class="n">proper</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">engineering</span> <span class="n">units</span> <span class="k">with</span> <span class="n">both</span> <span class="n">of</span> <span class="n">these</span> <span class="n">quantities</span> <span class="n">matching</span>
    <span class="o">-</span> <span class="n">handles</span> <span class="n">the</span> <span class="n">parameter</span> <span class="n">locking</span> <span class="n">feature</span><span class="p">,</span> <span class="n">which</span> <span class="n">nominally</span> <span class="n">prevents</span> <span class="n">the</span> <span class="n">user</span> <span class="kn">from</span><span class="w"> </span><span class="nn">changing</span>
      <span class="n">details</span> <span class="n">about</span> <span class="n">a</span> <span class="n">locked</span> <span class="n">state</span> <span class="n">via</span> <span class="n">EPICS</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbEncConverter</span><span class="p">:</span> <span class="n">FB_RawCountConverter</span><span class="p">;</span>
    <span class="n">fbLock</span><span class="p">:</span> <span class="n">FB_PositionStateLock</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Mark</span> <span class="n">that</span> <span class="n">we</span><span class="s1">&#39;ve been here</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">bUpdated</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Update</span> <span class="n">pos</span> <span class="n">state</span><span class="s1">&#39;s count or egu position as appropriate</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAxisParamsInit</span> <span class="n">THEN</span>
    <span class="n">fbEncConverter</span><span class="p">(</span>
        <span class="n">stParameters</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="p">,</span>
        <span class="n">nCountCheck</span><span class="o">:=</span><span class="n">stPositionState</span><span class="o">.</span><span class="n">nEncoderCount</span><span class="p">,</span>
        <span class="n">fPosCheck</span><span class="o">:=</span><span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="n">THEN</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fbEncConverter</span><span class="o">.</span><span class="n">fPosGet</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">fbEncConverter</span><span class="o">.</span><span class="n">nCountGet</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Handle</span> <span class="n">state</span> <span class="n">parameter</span> <span class="n">locking</span>
<span class="n">fbLock</span><span class="p">(</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAxisParamsInit</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstatelock">FB_PositionStateLock</a></p></li>
<li><p><a class="reference internal" href="#fb-rawcountconverter">FB_RawCountConverter</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateinternalnd">
<h2>FB_PositionStateInternalND<a class="headerlink" href="#fb-positionstateinternalnd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateInternalND</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Given</span> <span class="n">a</span> <span class="n">standard</span> <span class="n">ND</span> <span class="n">state</span> <span class="n">setup</span><span class="p">,</span> <span class="n">call</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">required</span> <span class="n">state</span> <span class="n">management</span> <span class="n">FBs</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">apply</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">routines</span> <span class="n">to</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Each</span> <span class="n">motor</span><span class="s1">&#39;s respective position states along its direction</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">individual</span> <span class="n">instantiated</span> <span class="n">internal</span> <span class="n">FBs</span><span class="o">.</span> <span class="n">Must</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">bounds</span> <span class="k">as</span> <span class="n">astPositionState</span><span class="o">.</span>
    <span class="n">afbStateInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">nIterMotors</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nIterStates</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">FOR</span> <span class="n">nIterMotors</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span> <span class="n">DO</span>
    <span class="n">FOR</span> <span class="n">nIterStates</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
        <span class="n">afbStateInternal</span><span class="p">[</span><span class="n">nIterMotors</span><span class="p">][</span><span class="n">nIterStates</span><span class="p">](</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIterMotors</span><span class="p">],</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIterMotors</span><span class="p">][</span><span class="n">nIterStates</span><span class="p">],</span>
        <span class="p">);</span>
    <span class="n">END_FOR</span>
<span class="n">END_FOR</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatelock">
<h2>FB_PositionStateLock<a class="headerlink" href="#fb-positionstatelock" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateLock</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Implements</span> <span class="n">immutability</span> <span class="k">for</span> <span class="n">a</span> <span class="n">locked</span> <span class="n">ST_PositionState</span>
    <span class="n">Once</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">called</span> <span class="n">the</span> <span class="n">first</span> <span class="n">time</span><span class="p">,</span> <span class="n">the</span> <span class="n">parameters</span> <span class="n">at</span> <span class="n">the</span> <span class="n">time</span> <span class="n">of</span> <span class="n">the</span> <span class="n">call</span> <span class="n">will</span> <span class="n">be</span> <span class="n">restored</span> <span class="n">on</span> <span class="nb">all</span> <span class="n">subsequent</span> <span class="n">calls</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">stCachedPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Force</span> <span class="n">values</span> <span class="n">to</span> <span class="n">be</span> <span class="n">cached</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;ve cached something</span>
    <span class="n">IF</span> <span class="n">bInit</span> <span class="n">AND</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bLocked</span> <span class="n">THEN</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">sName</span><span class="p">;</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fAccel</span><span class="p">;</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">:=</span> <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fDecel</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">we</span> <span class="n">haven</span><span class="s1">&#39;t cached and we should, make the cache. Note that we skip bLocked, bValid, and bMoveOk</span>
    <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">AND</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bLocked</span> <span class="n">THEN</span>
        <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">sName</span><span class="p">;</span>
        <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
        <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
        <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fAccel</span><span class="p">;</span>
        <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDecel</span><span class="p">;</span>
        <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Do</span> <span class="n">nothing</span><span class="p">,</span> <span class="ow">or</span> <span class="n">unlock</span> <span class="n">the</span> <span class="n">state</span> <span class="k">if</span> <span class="n">bLocked</span> <span class="n">goes</span> <span class="n">FALSE</span>
    <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bLocked</span> <span class="n">THEN</span>
        <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatemanager">
<h2>FB_PositionStateManager<a class="headerlink" href="#fb-positionstatemanager" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionState1D instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateManager</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Handles</span> <span class="n">EPICS</span> <span class="n">moves</span> <span class="n">between</span> <span class="n">multiple</span> <span class="n">states</span> <span class="k">for</span> <span class="n">a</span> <span class="n">single</span> <span class="n">axis</span>
    <span class="n">Should</span> <span class="n">be</span> <span class="n">wrapped</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">block</span> <span class="k">with</span> <span class="n">enums</span> <span class="k">for</span> <span class="n">states</span><span class="p">,</span>
    <span class="n">see</span> <span class="n">FB_EpicsInOut</span> <span class="k">for</span> <span class="n">an</span> <span class="n">example</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Allocated</span> <span class="n">space</span> <span class="k">for</span> <span class="mi">15</span> <span class="n">states</span> <span class="n">besides</span> <span class="n">Unknown</span> <span class="p">(</span><span class="mi">16</span> <span class="ow">is</span> <span class="n">the</span> <span class="nb">max</span> <span class="k">for</span> <span class="n">an</span> <span class="n">EPICS</span> <span class="n">MBBI</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">arrStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..15</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Corresponding</span> <span class="n">arrStates</span> <span class="n">index</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span><span class="p">,</span> <span class="ow">or</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">no</span> <span class="n">move</span> <span class="n">selected</span>
    <span class="n">setState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">start</span> <span class="n">a</span> <span class="n">move</span> <span class="n">when</span> <span class="n">setState</span> <span class="n">transitions</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">number</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">On</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">reset</span> <span class="n">this</span> <span class="n">FB</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RESET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">error</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">ID</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRID</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">error</span> <span class="n">that</span> <span class="n">caused</span> <span class="n">bError</span> <span class="n">to</span> <span class="n">flip</span> <span class="n">TRUE</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRMSG</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">motor</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BUSY</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">last</span> <span class="n">move</span> <span class="n">completed</span> <span class="n">successfully</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DONE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">we</span> <span class="n">are</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">reach</span><span class="p">,</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="n">goalState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">readback</span> <span class="n">position</span>
    <span class="n">getState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">stUnknown</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stGoal</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbStateMove</span><span class="p">:</span> <span class="n">FB_PositionStateMove</span><span class="p">;</span>
    <span class="n">fbStateInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..15</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bNewGoal</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInnerExec</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInnerReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bMoveRequested</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Reset</span> <span class="n">just</span> <span class="n">goes</span> <span class="n">through</span> <span class="n">the</span> <span class="n">first</span><span class="o">-</span><span class="n">cycle</span> <span class="n">init</span> <span class="n">again</span>
<span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bReset</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">First</span><span class="o">-</span><span class="n">cycle</span> <span class="n">init</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bNewGoal</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goalState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">All</span> <span class="n">state</span> <span class="n">internal</span> <span class="n">handlers</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">15</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
        <span class="n">fbStateInternal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">](</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">arrStates</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]);</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">Check</span> <span class="n">where</span> <span class="n">we</span> <span class="n">are</span> <span class="n">by</span> <span class="n">going</span> <span class="n">through</span> <span class="nb">all</span> <span class="n">possible</span> <span class="n">states</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Note</span> <span class="n">this</span> <span class="n">favors</span> <span class="n">the</span> <span class="n">highest</span><span class="o">-</span><span class="n">number</span> <span class="n">state</span> <span class="n">that</span> <span class="n">we</span><span class="s1">&#39;re at, it&#39;</span><span class="n">s</span> <span class="n">up</span> <span class="n">to</span> <span class="n">you</span> <span class="n">to</span> <span class="n">make</span> <span class="n">your</span> <span class="n">states</span> <span class="n">mutually</span> <span class="n">exclusive</span><span class="o">.</span>
<span class="n">getState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">15</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">F_AtPositionState</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span> <span class="n">stPositionState</span><span class="o">:=</span><span class="n">arrStates</span><span class="p">[</span><span class="n">nIndex</span><span class="p">])</span> <span class="n">THEN</span>
        <span class="n">getState</span> <span class="o">:=</span> <span class="n">nIndex</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">changing</span> <span class="nb">set</span> <span class="n">pv</span> <span class="k">as</span> <span class="n">a</span> <span class="n">rising</span><span class="o">-</span><span class="n">edge</span> <span class="n">trigger</span>
<span class="n">IF</span> <span class="n">setState</span> <span class="o">&lt;&gt;</span> <span class="n">goalState</span> <span class="n">THEN</span>
    <span class="n">goalState</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>
    <span class="n">bNewGoal</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Special</span> <span class="n">move</span> <span class="n">handling</span> <span class="k">for</span> <span class="n">error</span><span class="o">/</span><span class="n">enable</span> <span class="n">state</span>
<span class="n">IF</span> <span class="n">bError</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Reset</span> <span class="n">inner</span> <span class="n">block</span> <span class="n">this</span> <span class="n">cycle</span> <span class="k">if</span> <span class="n">we</span> <span class="n">were</span> <span class="n">already</span> <span class="n">moving</span> <span class="n">but</span> <span class="n">want</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span>
<span class="n">ELSIF</span> <span class="n">bInnerExec</span> <span class="n">AND</span> <span class="n">bNewGoal</span> <span class="n">THEN</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">we</span> <span class="n">hit</span> <span class="n">this</span> <span class="n">branch</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;re starting a new move</span>
<span class="n">ELSIF</span> <span class="n">bNewGoal</span> <span class="n">THEN</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bNewGoal</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Pick</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">goal</span> <span class="n">structure</span> <span class="ow">or</span> <span class="n">Unknown</span>
<span class="n">IF</span> <span class="n">goalState</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stGoal</span> <span class="o">:=</span> <span class="n">stUnknown</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">stGoal</span> <span class="o">:=</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">goalState</span><span class="p">];</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Do</span> <span class="n">the</span> <span class="n">move</span>
<span class="n">fbStateMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span> <span class="o">:=</span> <span class="n">stGoal</span><span class="p">,</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bInnerExec</span><span class="p">,</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">bInnerReset</span><span class="p">,</span>
    <span class="n">enumMotionRequest</span> <span class="o">:=</span> <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="p">,</span>
    <span class="n">bBusy</span> <span class="o">=&gt;</span> <span class="n">bBusy</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Only</span> <span class="k">pass</span> <span class="n">up</span> <span class="n">bDone</span> <span class="n">information</span> <span class="k">if</span> <span class="n">this</span> <span class="n">FB</span> <span class="ow">is</span> <span class="n">active</span>
<span class="n">IF</span> <span class="n">bInnerExec</span> <span class="n">THEN</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">bDone</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Pick</span> <span class="n">up</span> <span class="nb">any</span> <span class="n">new</span> <span class="n">errors</span><span class="p">,</span> <span class="n">but</span> <span class="n">don</span><span class="s1">&#39;t override uncleared existing errors</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">setpoint</span> <span class="ow">and</span> <span class="n">goal</span> <span class="n">to</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re not doing anything</span>
<span class="o">//</span> <span class="n">because</span> <span class="n">FB</span> <span class="ow">is</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">a</span> <span class="n">change</span> <span class="kn">from</span><span class="w"> </span><span class="mi">0</span> <span class="n">to</span> <span class="s2">&quot;something&quot;</span>
<span class="n">bMoveRequested</span> <span class="o">:=</span> <span class="n">bInnerExec</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bDone</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bNewGoal</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bMoveRequested</span> <span class="n">THEN</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goalState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Bring</span> <span class="n">inner</span> <span class="n">reset</span> <span class="n">back</span> <span class="n">low</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">the</span> <span class="n">init</span> <span class="n">cycle</span> <span class="n">so</span> <span class="n">that</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span> <span class="n">triggered</span> <span class="n">again</span> <span class="n">later</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-epicsinout">FB_EpicsInOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemove">FB_PositionStateMove</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatemove">
<h2>FB_PositionStateMove<a class="headerlink" href="#fb-positionstatemove" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateMove</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Request</span> <span class="n">a</span> <span class="n">move</span> <span class="n">to</span> <span class="n">a</span> <span class="n">particular</span> <span class="n">state</span> <span class="kn">from</span><span class="w"> </span><span class="nn">an</span> <span class="n">axis</span> <span class="n">controlled</span> <span class="n">via</span> <span class="n">EPICS</span>
    <span class="n">pytmc</span> <span class="n">PVs</span> <span class="n">here</span> <span class="n">only</span> <span class="n">exposed</span> <span class="k">if</span> <span class="n">using</span> <span class="n">directly</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">through</span> <span class="n">another</span> <span class="n">states</span> <span class="n">function</span> <span class="n">block</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">State</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">move</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">stop</span> <span class="n">move</span> <span class="n">on</span> <span class="n">falling</span> <span class="n">edge</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GO</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Rising</span> <span class="n">edge</span> <span class="n">error</span> <span class="n">reset</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RESET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Define</span> <span class="n">behavior</span> <span class="k">for</span> <span class="n">when</span> <span class="n">a</span> <span class="n">move</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">active</span>
    <span class="n">enumMotionRequest</span><span class="p">:</span> <span class="n">E_MotionRequest</span> <span class="o">:=</span> <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">WAIT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">at</span> <span class="n">this</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">AT_STATE</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bAtState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span> <span class="n">have</span> <span class="n">an</span> <span class="n">error</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRID</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">nErrorID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Error</span> <span class="n">description</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRMSG</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="n">moving</span> <span class="n">to</span> <span class="n">a</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BUSY</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">moving</span> <span class="ow">and</span> <span class="n">we</span> <span class="n">reached</span> <span class="n">a</span> <span class="n">state</span> <span class="n">successfully</span> <span class="n">on</span> <span class="n">our</span> <span class="n">last</span> <span class="n">move</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DONE</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbMotionRequest</span><span class="p">:</span> <span class="n">FB_MotionRequest</span><span class="p">;</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bInnerExec</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bAllowMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nLatchAllowErrorID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Veto</span> <span class="n">the</span> <span class="n">move</span> <span class="k">for</span> <span class="n">uninitialized</span> <span class="ow">and</span> <span class="n">unsafe</span> <span class="n">states</span>
<span class="n">bAllowMove</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="n">AND</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>

<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">bInnerExec</span> <span class="n">S</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">bAllowMove</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span><span class="p">;</span>
<span class="n">bInnerExec</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bExecute</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Do</span> <span class="n">the</span> <span class="n">move</span>
<span class="n">fbMotionRequest</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bInnerExec</span><span class="p">,</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">bReset</span><span class="p">,</span>
    <span class="n">enumMotionRequest</span> <span class="o">:=</span> <span class="n">enumMotionRequest</span><span class="p">,</span>
    <span class="n">fPos</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fVel</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="n">fAcc</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fAccel</span><span class="p">,</span>
    <span class="n">fDec</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDecel</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
    <span class="n">nErrorId</span> <span class="o">=&gt;</span> <span class="n">nErrorId</span><span class="p">,</span>
    <span class="n">sErrorMessage</span> <span class="o">=&gt;</span> <span class="n">sErrorMessage</span><span class="p">,</span>
    <span class="n">bBusy</span> <span class="o">=&gt;</span> <span class="n">bBusy</span><span class="p">,</span>
    <span class="n">bDone</span> <span class="o">=&gt;</span> <span class="n">bDone</span><span class="p">);</span>

<span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bReset</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">nLatchAllowErrorID</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Inject</span> <span class="n">custom</span> <span class="n">error</span> <span class="k">if</span> <span class="n">we</span> <span class="n">can</span><span class="s1">&#39;t move because of bMoveOk or bValid</span>
<span class="n">IF</span> <span class="n">nLatchAllowErrorID</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bAllowMove</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">nLatchAllowErrorID</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">nErrorID</span> <span class="o">:=</span> <span class="n">nLatchAllowErrorID</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
        <span class="n">nErrorID</span> <span class="o">:=</span> <span class="n">E_LCLSMotionError</span><span class="o">.</span><span class="n">UNSAFE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">nErrorID</span> <span class="o">:=</span> <span class="n">E_LCLSMotionError</span><span class="o">.</span><span class="n">INVALID</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Keep</span> <span class="n">error</span> <span class="n">latched</span> <span class="n">until</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">cleared</span><span class="p">,</span> <span class="n">otherwise</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span> <span class="n">lost</span> <span class="n">early</span>
    <span class="n">nLatchAllowErrorID</span> <span class="o">:=</span> <span class="n">nErrorID</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">F_MotionErrorCodeLookup</span><span class="p">(</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">nErrorID</span><span class="p">),</span> <span class="s1">&#39; for &#39;</span><span class="p">),</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">sName</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">This</span> <span class="n">can</span> <span class="n">be</span> <span class="n">useful</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re running this FB standalone for some reason</span>
<span class="n">bAtState</span> <span class="o">:=</span> <span class="n">F_AtPositionState</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span> <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-lclsmotionerror">E_LCLSMotionError</a></p></li>
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-motionrequest">FB_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#f-motionerrorcodelookup">F_MotionErrorCodeLookup</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatemove-test">
<h2>FB_PositionStateMove_Test<a class="headerlink" href="#fb-positionstatemove-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateMove_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">that</span> <span class="n">FB_PositionStateMove</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">move</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span>
    <span class="n">And</span> <span class="n">that</span> <span class="n">the</span> <span class="n">API</span> <span class="n">behaves</span> <span class="n">exactly</span> <span class="k">as</span> <span class="n">described</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">stDummyPos</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stInvalid</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stNotUpdated</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stUnsafe</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_PositionStateMove</span><span class="p">;</span>

    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fTestStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">tonCleanup</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bStatesReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;UNO&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;DOS&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TRES&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

<span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="n">stInvalid</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">stInvalid</span><span class="o">.</span><span class="n">bUpdated</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stInvalid</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stNotUpdated</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stNotUpdated</span><span class="o">.</span><span class="n">bUpdated</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">stNotUpdated</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stUnsafe</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stUnsafe</span><span class="o">.</span><span class="n">bUpdated</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stUnsafe</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">nTestCounter</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t run any tests until the states are ready</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Warm</span> <span class="n">up</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">FB</span> <span class="k">with</span> <span class="n">a</span> <span class="n">exec</span> <span class="n">false</span> <span class="n">runthrough</span>
    <span class="n">fbMove</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Test</span> <span class="n">that</span> <span class="n">we</span> <span class="n">can</span> <span class="n">move</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">outputs</span> <span class="n">are</span> <span class="n">correct</span> <span class="k">as</span> <span class="n">we</span> <span class="n">go</span>
<span class="n">TestMove</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Test</span> <span class="n">that</span> <span class="n">we</span> <span class="n">can</span> <span class="n">move</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">outputs</span> <span class="n">are</span> <span class="n">correct</span> <span class="k">as</span> <span class="n">we</span> <span class="n">go</span>
<span class="n">TestMove</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Test</span> <span class="n">that</span> <span class="n">we</span> <span class="n">can</span> <span class="n">interrupt</span> <span class="n">a</span> <span class="n">move</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">3</span> <span class="n">by</span> <span class="n">dropping</span> <span class="n">bExecute</span>
<span class="n">TestMove</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Test</span> <span class="n">that</span> <span class="n">we</span> <span class="n">cannot</span> <span class="n">move</span> <span class="n">to</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">state</span>
<span class="n">TestBadStates</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Test</span> <span class="n">that</span> <span class="n">we</span> <span class="n">need</span> <span class="n">a</span> <span class="n">new</span> <span class="n">bExecute</span> <span class="n">to</span> <span class="n">start</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span> <span class="k">if</span> <span class="n">a</span> <span class="n">move</span> <span class="n">goes</span> <span class="kn">from</span><span class="w"> </span><span class="nn">unsafe</span> <span class="n">to</span> <span class="n">safe</span>
<span class="n">TestMoveOk</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Wait</span> <span class="n">a</span> <span class="n">few</span> <span class="n">cycles</span> <span class="k">for</span> <span class="n">remaining</span> <span class="n">errors</span> <span class="n">to</span> <span class="n">propagate</span>
<span class="n">tonCleanup</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">bOneTestDone</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1s);</span>
<span class="n">IF</span> <span class="n">tonCleanup</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">fbMove</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
            <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
            <span class="n">bReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="n">ELSIF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
        <span class="n">fbMove</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
            <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
            <span class="n">bReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="n">ELSIF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
       <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">fbMove</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
            <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
            <span class="n">bReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

        <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bStatesReady</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestBadStates</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;TestInvalid&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nTestIndex</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIndex</span> <span class="n">OR</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Started with an error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stInvalid</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Invalid should have given an error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stInvalid</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Started with an error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stNotUpdated</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Not updated should have given an error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stNotUpdated</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Started with an error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stUnsafe</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Unsafe should have given an error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestMove</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nStateIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bInterrupt</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">bLocalInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInterruptStarted</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tonBusy</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;TestMove&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nTestIndex</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIndex</span> <span class="n">OR</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLocalInit</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Starting</span> <span class="n">output</span> <span class="n">checks</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Tried to start test with busy motor&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Tried to start test with errored motor&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bLocalInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Simulate</span> <span class="n">waiting</span> <span class="n">a</span> <span class="n">moment</span> <span class="n">before</span> <span class="n">stopping</span>
<span class="n">tonBusy</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#100ms);</span>
<span class="n">bInterruptStarted</span> <span class="n">S</span><span class="o">=</span> <span class="n">bInterrupt</span> <span class="n">AND</span> <span class="n">tonBusy</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nStateIndex</span><span class="p">],</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInterruptStarted</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bDone</span> <span class="n">OR</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bInterruptStarted</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Test timed out&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">IF</span> <span class="n">bInterrupt</span> <span class="n">THEN</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">fbMove</span><span class="o">.</span><span class="n">bAtState</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Should have been interrupted, but made it to the goal&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbMove</span><span class="o">.</span><span class="n">bAtState</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not end at the state&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
            <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not reach the goal state&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="n">END_IF</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Was busy while done&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Should not end in error: &#39;</span><span class="p">,</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">),</span>
    <span class="p">);</span>

    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bLocalInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInterruptStarted</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestMoveOk</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">nStep</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">stState</span><span class="p">:</span> <span class="n">ST_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;GOAL&#39;</span><span class="p">,</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mi">135</span><span class="p">,</span>
        <span class="n">fDelta</span><span class="o">:=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">bValid</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bMoveOk</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="n">bUpdated</span><span class="o">:=</span><span class="n">TRUE</span>
    <span class="p">);</span>
    <span class="n">tonInternal</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bLocalExec</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLocalReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">END</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">999</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestMoveOk&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIndex</span> <span class="n">OR</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">nStep</span> <span class="n">OF</span>
    <span class="o">//</span> <span class="n">Initial</span> <span class="n">setup</span> <span class="ow">and</span> <span class="n">checks</span>
    <span class="mi">0</span><span class="p">:</span>
        <span class="n">fStartPos</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
            <span class="s1">&#39;Started with a fbMove error&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
            <span class="s1">&#39;Started with a motor error&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">bLocalExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bLocalReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Move</span> <span class="n">to</span> <span class="n">a</span> <span class="n">state</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">bad</span>
    <span class="mi">1</span><span class="p">:</span>
        <span class="n">stState</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bLocalExec</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">move</span> <span class="n">should</span> <span class="n">have</span> <span class="n">failed</span> <span class="k">with</span> <span class="n">an</span> <span class="n">error</span> <span class="n">on</span> <span class="n">the</span> <span class="n">FB</span> <span class="n">that</span> <span class="n">never</span> <span class="n">propagated</span> <span class="n">to</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">itself</span><span class="o">-</span> <span class="n">we</span> <span class="n">shouldn</span><span class="s1">&#39;t have attempted the move at all</span>
    <span class="mi">2</span><span class="p">:</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
            <span class="s1">&#39;Did not have the expected move not ok error&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
            <span class="s1">&#39;Had a motion error, but we never should have asked for a move?&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Make</span> <span class="n">the</span> <span class="n">state</span> <span class="n">no</span> <span class="n">longer</span> <span class="n">bad</span><span class="p">,</span> <span class="ow">and</span> <span class="n">wait</span> <span class="n">a</span> <span class="n">bit</span>
    <span class="mi">3</span><span class="p">:</span>
        <span class="n">stState</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">tonInternal</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#500ms);</span>
        <span class="n">IF</span> <span class="n">tonInternal</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">tonInternal</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">There</span> <span class="n">should</span> <span class="n">be</span> <span class="n">no</span> <span class="n">movement</span> <span class="n">still</span>
    <span class="mi">4</span><span class="p">:</span>
        <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="n">fStartPos</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
            <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Motor moved without bReset or a new bExecute!&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">error</span> <span class="p">(</span><span class="n">rising</span> <span class="n">edge</span><span class="p">)</span>
        <span class="n">bLocalReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">After</span> <span class="n">we</span> <span class="n">reset</span> <span class="n">the</span> <span class="n">error</span><span class="p">,</span> <span class="n">wait</span> <span class="n">a</span> <span class="n">bit</span>
    <span class="mi">5</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Drop</span> <span class="k">for</span> <span class="n">rising</span> <span class="n">edges</span> <span class="n">later</span>
        <span class="n">bLocalReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">tonInternal</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#500ms);</span>
        <span class="n">IF</span> <span class="n">tonInternal</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">tonInternal</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">There</span> <span class="n">should</span> <span class="n">be</span> <span class="n">no</span> <span class="n">error</span><span class="p">,</span> <span class="ow">and</span> <span class="n">STILL</span> <span class="n">be</span> <span class="n">no</span> <span class="n">movement</span>
    <span class="mi">6</span><span class="p">:</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
            <span class="s1">&#39;The error should be reset&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="n">fStartPos</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
            <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Motor moved without a new bExecute!&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="o">//</span> <span class="n">Set</span> <span class="n">bExecute</span> <span class="n">to</span> <span class="n">FALSE</span> <span class="k">for</span> <span class="n">an</span> <span class="n">upcoming</span> <span class="n">rising</span> <span class="n">edge</span><span class="o">.</span> <span class="n">It</span> <span class="n">should</span> <span class="n">be</span> <span class="n">TRUE</span> <span class="n">at</span> <span class="n">this</span> <span class="n">point</span><span class="o">.</span>
        <span class="n">bLocalExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">start</span> <span class="n">a</span> <span class="n">move</span> <span class="n">via</span> <span class="n">bExecute</span> <span class="n">now</span>
    <span class="mi">7</span><span class="p">:</span>
        <span class="n">stState</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">2000</span><span class="p">;</span>
        <span class="n">stState</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="mi">15000</span><span class="p">;</span>
        <span class="n">stState</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">:=</span> <span class="mi">15000</span><span class="p">;</span>
        <span class="n">bLocalExec</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bAtState</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
            <span class="n">nStep</span> <span class="o">:=</span> <span class="n">END</span><span class="p">;</span>
        <span class="n">END_IF</span>
<span class="n">END_CASE</span>

<span class="o">//</span> <span class="n">Run</span> <span class="n">fbMove</span> <span class="n">exactly</span> <span class="n">once</span> <span class="n">every</span> <span class="n">cycle</span> <span class="n">no</span> <span class="n">matter</span> <span class="n">what</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stState</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bLocalExec</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bLocalReset</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">nStep</span> <span class="o">=</span> <span class="n">END</span> <span class="n">OR</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Test timed out&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">Check</span> <span class="n">that</span> <span class="n">we</span><span class="s1">&#39;ve reached the goal</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">stState</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Motor did not reach the goal.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemove">FB_PositionStateMove</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatemovend">
<h2>FB_PositionStateMoveND<a class="headerlink" href="#fb-positionstatemovend" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateMoveND</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">coordinates</span> <span class="n">multidimensional</span> <span class="n">state</span> <span class="n">moves</span> <span class="k">for</span> <span class="n">groups</span> <span class="n">of</span> <span class="n">motors</span><span class="o">.</span>
    <span class="n">It</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">building</span> <span class="n">block</span> <span class="ow">not</span> <span class="n">meant</span> <span class="k">for</span> <span class="n">use</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">lcls</span><span class="o">-</span><span class="n">twintcat</span><span class="o">-</span><span class="n">motion</span><span class="o">.</span>

    <span class="n">Use</span> <span class="n">FB_PositionState1D</span><span class="p">,</span> <span class="n">FB_PositionState2D</span><span class="p">,</span> <span class="o">...</span> <span class="n">etc</span><span class="o">.</span> <span class="n">instead</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Array</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">move</span> <span class="n">together</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="mi">1</span><span class="n">D</span> <span class="n">Position</span> <span class="n">states</span><span class="p">:</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">to</span> <span class="n">send</span> <span class="n">each</span> <span class="n">axis</span> <span class="n">to</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">we</span><span class="s1">&#39;re actually using</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="nb">all</span> <span class="n">moves</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">stop</span> <span class="nb">all</span> <span class="n">moves</span> <span class="n">on</span> <span class="n">falling</span> <span class="n">edge</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Reset</span> <span class="nb">any</span> <span class="n">errors</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">behavior</span> <span class="k">for</span> <span class="n">when</span> <span class="n">a</span> <span class="n">move</span> <span class="n">request</span> <span class="ow">is</span> <span class="n">interrupted</span> <span class="k">with</span> <span class="n">a</span> <span class="n">new</span> <span class="n">request</span>
    <span class="n">enumMotionRequest</span><span class="p">:</span> <span class="n">E_MotionRequest</span> <span class="o">:=</span> <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">WAIT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ALL</span> <span class="n">of</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">at</span> <span class="n">their</span> <span class="n">goal</span> <span class="n">states</span>
    <span class="n">bAtState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ANY</span> <span class="n">of</span> <span class="n">this</span> <span class="n">FB</span><span class="s1">&#39;s moves are in progress</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ALL</span> <span class="n">motors</span> <span class="n">have</span> <span class="n">completed</span> <span class="n">the</span> <span class="n">last</span> <span class="n">move</span> <span class="n">request</span> <span class="kn">from</span><span class="w"> </span><span class="nn">this</span> <span class="n">FB</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ANY</span> <span class="n">of</span> <span class="n">this</span> <span class="n">FB</span><span class="s1">&#39;s moves had an error</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">How</span> <span class="n">many</span> <span class="n">FBs</span> <span class="n">are</span> <span class="n">erroring</span>
    <span class="n">nErrorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Which</span> <span class="n">component</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">source</span> <span class="n">of</span> <span class="n">the</span> <span class="n">example</span><span class="o">/</span><span class="n">summarized</span> <span class="n">error</span>
    <span class="n">nShownError</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">One</span> <span class="n">of</span> <span class="n">the</span> <span class="n">error</span> <span class="n">ids</span>
    <span class="n">nErrorID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">error</span> <span class="n">error</span> <span class="n">message</span> <span class="n">matching</span> <span class="n">the</span> <span class="n">ID</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="mi">1</span><span class="n">D</span> <span class="n">State</span> <span class="n">movers</span><span class="p">:</span> <span class="n">FBs</span> <span class="n">to</span> <span class="n">move</span> <span class="n">the</span> <span class="n">motors</span>
    <span class="n">afbPositionStateMove</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateMove</span><span class="p">;</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bMotorCountError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nLowerBound</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nUpperBound</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CheckCount</span><span class="p">();</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMotorCountError</span> <span class="n">THEN</span>
    <span class="n">DoStateMoves</span><span class="p">();</span>
    <span class="n">CombineOutputs</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">CheckCount</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">valid</span> <span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">,</span> <span class="n">less</span> <span class="ow">or</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">max</span><span class="p">)</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&gt;</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bMotorCountError</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Internal Error: invalid motor count&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">CombineOutputs</span><span class="p">:</span>
<span class="o">//</span> <span class="n">bAtState</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ALL</span> <span class="n">entries</span> <span class="n">are</span> <span class="n">TRUE</span>
<span class="n">bAtState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bAtState</span> <span class="o">:=</span> <span class="n">bAtState</span> <span class="n">AND</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bAtState</span><span class="p">;</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">bBusy</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ANY</span> <span class="n">entry</span> <span class="ow">is</span> <span class="n">TRUE</span>
<span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">bBusy</span> <span class="n">OR</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">bDone</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ALL</span> <span class="n">entries</span> <span class="n">are</span> <span class="n">TRUE</span>
<span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">bDone</span> <span class="n">AND</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bDone</span><span class="p">;</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">bError</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ANY</span> <span class="n">entry</span> <span class="ow">is</span> <span class="n">TRUE</span>
<span class="o">//</span> <span class="n">also</span> <span class="nb">set</span> <span class="n">nShownError</span> <span class="ow">and</span> <span class="n">increment</span> <span class="n">nErrorCount</span>
<span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">nErrorCount</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">bError</span> <span class="n">OR</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
        <span class="n">nShownError</span> <span class="o">:=</span> <span class="n">nIndex</span><span class="p">;</span>
        <span class="n">nErrorCount</span> <span class="o">:=</span> <span class="n">nErrorCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">Pick</span> <span class="n">error</span> <span class="nb">id</span> <span class="ow">and</span> <span class="n">message</span> <span class="n">using</span> <span class="n">nShownError</span>
<span class="n">IF</span> <span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">nErrorID</span> <span class="o">:=</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nShownError</span><span class="p">]</span><span class="o">.</span><span class="n">nErrorID</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nShownError</span><span class="p">]</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">nErrorID</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">DoStateMoves</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Do</span> <span class="n">the</span> <span class="n">individual</span> <span class="n">moves</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nIndex</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">],</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">],</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
        <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
        <span class="n">enumMotionRequest</span><span class="o">:=</span><span class="n">enumMotionRequest</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate2d">FB_PositionState2D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemove">FB_PositionStateMove</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatemovend-test">
<h2>FB_PositionStateMoveND_Test<a class="headerlink" href="#fb-positionstatemovend-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateMoveND_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">that</span> <span class="n">FB_PositionStateMoveND</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">move</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span>
    <span class="n">And</span> <span class="n">that</span> <span class="n">the</span> <span class="n">API</span> <span class="n">behaves</span> <span class="n">exactly</span> <span class="k">as</span> <span class="n">described</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">afbMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">astGoalPositions</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">stDummyPos</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_PositionStateMoveND</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fTestStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bStatesReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">ResetGoals</span><span class="p">();</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astGoalPositions</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astGoalPositions</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
    <span class="n">SetEnables</span><span class="p">(</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">afbMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
<span class="n">END_FOR</span>

<span class="n">IF</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">nTestCounter</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t run any tests until the states are ready</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Warm</span> <span class="n">up</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">FB</span> <span class="k">with</span> <span class="n">a</span> <span class="n">exec</span> <span class="n">false</span> <span class="n">runthrough</span>
    <span class="n">fbMove</span><span class="p">(</span>
        <span class="n">astMotionStage</span> <span class="o">:=</span> <span class="n">astMotionStage</span><span class="p">,</span>
        <span class="n">astPositionState</span> <span class="o">:=</span> <span class="n">astGoalPositions</span><span class="p">,</span>
        <span class="n">nActiveMotorCount</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Move</span> <span class="n">to</span> <span class="n">somewhere</span>
<span class="n">TestMove</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Somewhere</span> <span class="k">else</span>
<span class="n">TestMove</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Interrupt</span> <span class="n">on</span> <span class="n">the</span> <span class="n">way</span> <span class="n">to</span> <span class="n">the</span> <span class="n">last</span> <span class="n">place</span>
<span class="n">TestMove</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ResetGoals</span><span class="p">();</span>
    <span class="n">fbMove</span><span class="p">(</span>
        <span class="n">astMotionStage</span> <span class="o">:=</span> <span class="n">astMotionStage</span><span class="p">,</span>
        <span class="n">astPositionState</span> <span class="o">:=</span> <span class="n">astGoalPositions</span><span class="p">,</span>
        <span class="n">nActiveMotorCount</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
        <span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bStatesReady</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">ResetGoals</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Goal1&#39;</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Goal2&#39;</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Goal3&#39;</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestMove</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fMotor1Pos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMotor3Pos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bInterrupt</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">bLocalInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInterruptStarted</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;TestMove&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nTestIndex</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIndex</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLocalInit</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Starting</span> <span class="n">output</span> <span class="n">checks</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Tried to start test with busy motor&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Tried to start test with errored motor&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bLocalInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fMotor1Pos</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fMotor2Pos</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fMotor3Pos</span><span class="p">;</span>

<span class="n">bInterruptStarted</span> <span class="n">S</span><span class="o">=</span> <span class="n">bInterrupt</span> <span class="n">AND</span> <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astGoalPositions</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInterruptStarted</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bDone</span> <span class="n">OR</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bInterruptStarted</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bInterrupt</span> <span class="n">THEN</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">fbMove</span><span class="o">.</span><span class="n">bAtState</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Should have been interrupted, but made it to the goal&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbMove</span><span class="o">.</span><span class="n">bAtState</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not end at the state&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span>
            <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
                <span class="n">Expected</span><span class="o">:=</span><span class="n">astGoalPositions</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
                <span class="n">Actual</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
                <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.01</span><span class="p">,</span>
                <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not reach the goal state&#39;</span><span class="p">,</span>
            <span class="p">);</span>
        <span class="n">END_FOR</span>

    <span class="n">END_IF</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Was busy while done&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Should not end in error&#39;</span><span class="p">,</span>
    <span class="p">);</span>

    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemovend">FB_PositionStateMoveND</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatend-core">
<h2>FB_PositionStateND_Core<a class="headerlink" href="#fb-positionstatend-core" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateND_Core</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Collection</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">actions</span> <span class="n">shared</span> <span class="n">between</span> <span class="nb">all</span> <span class="n">states</span> <span class="n">FBs</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">FB_PositionState1D</span>
    <span class="o">-</span> <span class="n">FB_PositionState2D</span>
    <span class="o">-</span> <span class="o">...</span> <span class="n">etc</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS1D</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS2D</span>
    <span class="o">-</span> <span class="o">...</span> <span class="n">etc</span><span class="o">.</span>

    <span class="n">This</span> <span class="ow">is</span> <span class="n">essentially</span> <span class="nb">input</span> <span class="n">handling</span><span class="p">,</span> <span class="n">position</span> <span class="n">state</span> <span class="n">reading</span><span class="p">,</span> <span class="n">standard</span> <span class="n">management</span> <span class="n">blocks</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">state</span> <span class="n">machine</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">be</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">states</span> <span class="n">move</span><span class="p">,</span> <span class="n">including</span> <span class="n">blank</span><span class="o">/</span><span class="n">uninitialized</span> <span class="n">structs</span><span class="o">.</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">motors</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">be</span> <span class="n">included</span> <span class="ow">in</span> <span class="n">astMotionStageMax</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">index</span> <span class="n">goal</span><span class="p">,</span> <span class="n">where</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">supposed</span> <span class="n">to</span> <span class="n">be</span> <span class="n">moving</span> <span class="n">towards</span><span class="o">.</span>
    <span class="n">nCurrGoal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbInput</span><span class="p">:</span> <span class="n">FB_StatesInputHandler</span><span class="p">;</span>
    <span class="n">fbInternal</span><span class="p">:</span> <span class="n">FB_PositionStateInternalND</span><span class="p">;</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_PositionStateMoveND</span><span class="p">;</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_PositionStateReadND</span><span class="p">;</span>
    <span class="n">astMoveGoals</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stInvalidPos</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">nIterMotor</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">nSetValue</span> <span class="o">:=</span> <span class="n">eEnumSet</span><span class="p">;</span>

<span class="n">fbInternal</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="n">nActiveMotorCount</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">=&gt;</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbInput</span><span class="p">(</span>
    <span class="n">stUserInput</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">bMoveBusy</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
    <span class="n">nStartingState</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">nPositionIndex</span><span class="p">,</span>
    <span class="n">bMoveError</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">=&gt;</span><span class="n">nCurrGoal</span><span class="p">,</span>
    <span class="n">bExecMove</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bResetMove</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">FOR</span> <span class="n">nIterMotor</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">nCurrGoal</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">astMoveGoals</span><span class="p">[</span><span class="n">nIterMotor</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="n">nIterMotor</span><span class="p">][</span><span class="n">nCurrGoal</span><span class="p">];</span>
    <span class="n">ELSE</span>
        <span class="n">astMoveGoals</span><span class="p">[</span><span class="n">nIterMotor</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stInvalidPos</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astMoveGoals</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="n">nActiveMotorCount</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">fbInput</span><span class="o">.</span><span class="n">bExecMove</span> <span class="n">AND</span> <span class="n">bEnable</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">fbInput</span><span class="o">.</span><span class="n">bResetMove</span><span class="p">,</span>
    <span class="n">enumMotionRequest</span><span class="o">:=</span><span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="p">,</span>
    <span class="n">bAtState</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bError</span><span class="o">=&gt;</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="n">nErrorID</span><span class="o">=&gt;</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nErrorID</span><span class="p">,</span>
    <span class="n">sErrorMessage</span><span class="o">=&gt;</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">sErrorMsg</span><span class="p">,</span>
    <span class="n">bBusy</span><span class="o">=&gt;</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
    <span class="n">bDone</span><span class="o">=&gt;</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">eEnumSet</span> <span class="o">:=</span> <span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">nSetValue</span><span class="p">;</span>
<span class="n">eEnumGet</span> <span class="o">:=</span> <span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate2d">FB_PositionState2D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternalnd">FB_PositionStateInternalND</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemovend">FB_PositionStateMoveND</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps2d">FB_PositionStatePMPS2D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatereadnd">FB_PositionStateReadND</a></p></li>
<li><p><a class="reference internal" href="#fb-statesinputhandler">FB_StatesInputHandler</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatend-test">
<h2>FB_PositionStateND_Test<a class="headerlink" href="#fb-positionstatend-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateND_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Sanity</span> <span class="n">checks</span> <span class="k">for</span> <span class="n">the</span> <span class="n">following</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">FB_PositionState1D</span>
    <span class="o">-</span> <span class="n">FB_PositionState2D</span>
    <span class="o">-</span> <span class="n">FB_PositionState3D</span>
    <span class="n">The</span> <span class="n">internals</span> <span class="n">have</span> <span class="n">already</span> <span class="n">been</span> <span class="n">tested</span><span class="p">,</span> <span class="n">but</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">that</span>
    <span class="n">they</span><span class="s1">&#39;ve been put together at least somewhat sensibly.</span>
    <span class="n">This</span> <span class="n">FB</span> <span class="n">will</span> <span class="n">simply</span> <span class="n">use</span> <span class="n">each</span> <span class="n">FB</span> <span class="n">to</span> <span class="n">move</span> <span class="ow">and</span> <span class="n">check</span> <span class="n">the</span> <span class="n">results</span><span class="o">.</span>

    <span class="n">Additional</span> <span class="n">tests</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Regression</span> <span class="n">test</span> <span class="k">for</span> <span class="n">issue</span> <span class="c1">#197 (input deadlock)</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStage3</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">afbMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="n">fb_Move1D</span><span class="p">:</span> <span class="n">FB_PositionState1D</span><span class="p">;</span>
    <span class="n">fb_Move2D</span><span class="p">:</span> <span class="n">FB_PositionState2D</span><span class="p">;</span>
    <span class="n">fb_Move3D</span><span class="p">:</span> <span class="n">FB_PositionState3D</span><span class="p">;</span>

    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fTestStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bStatesReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">eSetPos</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
    <span class="n">eGetPos</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">][</span><span class="mi">3</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage1</span><span class="p">);</span>
<span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage2</span><span class="p">);</span>
<span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage3</span><span class="p">);</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">);</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">);</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="mi">3</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">nTestCounter</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t run any tests until the states are ready</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Run</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">FBs</span> <span class="k">for</span> <span class="n">one</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">warm</span> <span class="n">them</span> <span class="n">up</span>
    <span class="n">fb_Move1D</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move2D</span><span class="p">(</span>
        <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move3D</span><span class="p">(</span>
        <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">stMotionStage3</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
        <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
        <span class="n">astPositionState3</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">Test1D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">);</span>
<span class="n">Test1D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">);</span>
<span class="n">Test1D</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">);</span>
<span class="n">Test2D</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">);</span>
<span class="n">Test2D</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">);</span>
<span class="n">Test2D</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">);</span>
<span class="n">Test3D</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">);</span>
<span class="n">Test3D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">);</span>
<span class="n">Test3D</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">);</span>
<span class="n">TestInputDeadlock</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bStatesReady</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">Test1D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">nLocalInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Test1D_state&#39;</span><span class="p">,</span> <span class="n">DINT_TO_STRING</span><span class="p">(</span><span class="n">nState</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">nLocalInit</span> <span class="n">THEN</span>
    <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">nState</span><span class="p">;</span>
    <span class="n">nLocalInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fb_Move1D</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be True after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_DINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">nState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move1D</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nLocalInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Test2D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">nLocalInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Test2D_state&#39;</span><span class="p">,</span> <span class="n">DINT_TO_STRING</span><span class="p">(</span><span class="n">nState</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">nLocalInit</span> <span class="n">THEN</span>
    <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">nState</span><span class="p">;</span>
    <span class="n">nLocalInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fb_Move2D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be True after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_DINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">nState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position for stage 1&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">nState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position for stage 2&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move2D</span><span class="p">(</span>
        <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nLocalInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Test3D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">nLocalInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Test3D_state&#39;</span><span class="p">,</span> <span class="n">DINT_TO_STRING</span><span class="p">(</span><span class="n">nState</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">nLocalInit</span> <span class="n">THEN</span>
    <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">nState</span><span class="p">;</span>
    <span class="n">nLocalInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fb_Move3D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">stMotionStage3</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">astPositionState3</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be True after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_DINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">nState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position for stage 1&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">nState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position for stage 2&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">[</span><span class="n">nState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position for stage 3&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move3D</span><span class="p">(</span>
        <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">stMotionStage3</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
        <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
        <span class="n">astPositionState3</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nLocalInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestInputDeadlock</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Regression</span> <span class="n">test</span> <span class="k">for</span> <span class="n">issue</span> <span class="c1">#197</span>

    <span class="n">How</span> <span class="n">to</span> <span class="n">reproduce</span> <span class="n">the</span> <span class="n">issue</span><span class="p">:</span>
    <span class="mf">1.</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">function</span> <span class="n">block</span> <span class="n">into</span> <span class="nb">any</span> <span class="n">motion</span> <span class="n">error</span>
    <span class="mf">2.</span> <span class="n">Ask</span> <span class="k">for</span> <span class="n">a</span> <span class="n">move</span> <span class="k">while</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">error</span> <span class="n">state</span>

    <span class="n">Then</span><span class="p">,</span> <span class="n">the</span> <span class="n">state</span> <span class="n">mover</span> <span class="n">never</span> <span class="n">moves</span> <span class="n">again</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">test</span> <span class="n">we</span> <span class="n">will</span> <span class="n">follow</span> <span class="n">steps</span> <span class="mi">1</span> <span class="ow">and</span> <span class="mi">2</span><span class="p">,</span> <span class="n">then</span> <span class="n">reset</span> <span class="n">the</span> <span class="n">error</span><span class="p">,</span> <span class="n">then</span> <span class="n">move</span><span class="o">.</span>

    <span class="n">With</span> <span class="n">our</span> <span class="n">fix</span><span class="p">,</span> <span class="n">our</span> <span class="n">second</span> <span class="n">attempt</span> <span class="n">at</span> <span class="n">the</span> <span class="n">move</span> <span class="p">(</span><span class="n">after</span> <span class="n">an</span> <span class="n">error</span> <span class="n">reset</span><span class="p">)</span> <span class="n">will</span> <span class="n">succeed</span><span class="o">.</span>
    <span class="n">Our</span> <span class="n">first</span> <span class="n">attempt</span> <span class="n">will</span> <span class="n">fail</span> <span class="n">regardless</span><span class="p">,</span> <span class="n">since</span> <span class="n">you</span> <span class="n">cannot</span> <span class="n">move</span> <span class="n">a</span> <span class="n">motor</span> <span class="n">that</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">error</span> <span class="n">state</span><span class="o">.</span>

    <span class="n">Without</span> <span class="n">our</span> <span class="n">fix</span><span class="p">,</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">could</span> <span class="n">never</span> <span class="n">be</span> <span class="n">moved</span> <span class="n">ever</span> <span class="n">again</span> <span class="ow">and</span> <span class="n">this</span> <span class="n">move</span> <span class="n">will</span> <span class="n">time</span> <span class="n">out</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">nTestStep</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">eNewGoal</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestInputDeadlock&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">nTestStep</span> <span class="n">OF</span>
    <span class="o">//</span> <span class="n">Step</span> <span class="mi">1</span><span class="p">:</span> <span class="n">Normal</span> <span class="n">move</span>
    <span class="mi">1</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Normal</span> <span class="n">move</span><span class="p">:</span> <span class="n">pick</span> <span class="nb">any</span> <span class="n">other</span> <span class="n">state</span>
        <span class="n">IF</span> <span class="n">eGetPos</span> <span class="o">=</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span> <span class="n">THEN</span>
            <span class="n">eNewGoal</span> <span class="o">:=</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">eNewGoal</span> <span class="o">:=</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">eNewGoal</span><span class="p">;</span>
        <span class="n">nTestStep</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Step</span> <span class="mi">2</span><span class="p">:</span> <span class="n">Cause</span> <span class="n">a</span> <span class="n">motion</span> <span class="n">error</span><span class="o">.</span> <span class="n">Easiest</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">just</span> <span class="nb">set</span> <span class="n">bError</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">during</span> <span class="n">a</span> <span class="n">move</span><span class="o">.</span>
    <span class="mi">2</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Cause</span> <span class="n">the</span> <span class="n">error</span> <span class="k">if</span> <span class="n">it</span><span class="s1">&#39;s time</span>
        <span class="n">IF</span> <span class="n">stMotionStage1</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
            <span class="n">stMotionStage1</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">stMotionStage1</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#4FFF;</span>
        <span class="n">ELSIF</span> <span class="n">stMotionStage1</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">nTestStep</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">END_IF</span>
     <span class="o">//</span> <span class="n">Step</span> <span class="mi">3</span><span class="p">:</span> <span class="n">another</span> <span class="n">normal</span> <span class="n">move</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">get</span> <span class="n">us</span> <span class="n">into</span> <span class="n">the</span> <span class="n">potential</span> <span class="n">bugged</span> <span class="n">state</span><span class="o">.</span>
     <span class="mi">3</span><span class="p">:</span>
        <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">eNewGoal</span><span class="p">;</span>
        <span class="n">nTestStep</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Step</span> <span class="mi">4</span><span class="p">:</span> <span class="n">reset</span> <span class="n">the</span> <span class="n">error</span><span class="p">,</span> <span class="n">which</span> <span class="n">will</span> <span class="n">allow</span> <span class="n">fixed</span> <span class="n">versions</span> <span class="n">of</span> <span class="n">the</span> <span class="n">code</span> <span class="n">to</span> <span class="n">resume</span> <span class="n">normal</span> <span class="n">operations</span><span class="o">.</span>
    <span class="mi">4</span><span class="p">:</span>
        <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage1</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">nTestStep</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Step</span> <span class="mi">5</span><span class="p">:</span> <span class="n">last</span> <span class="n">normal</span> <span class="n">move</span><span class="p">,</span> <span class="n">which</span> <span class="n">will</span> <span class="n">succeed</span> <span class="k">if</span> <span class="n">we</span> <span class="n">fixed</span> <span class="n">the</span> <span class="n">bug</span><span class="o">.</span>
    <span class="mi">5</span><span class="p">:</span>
        <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">eNewGoal</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">eGetPos</span> <span class="o">=</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span> <span class="n">THEN</span>
            <span class="n">nTestStep</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Step</span> <span class="mi">6</span><span class="p">:</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">the</span> <span class="n">move</span> <span class="n">to</span> <span class="n">finish</span>
    <span class="mi">6</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">eGetPos</span> <span class="o">=</span> <span class="n">eNewGoal</span> <span class="n">THEN</span>
            <span class="n">nTestStep</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">;</span>
        <span class="n">END_IF</span>
<span class="n">END_CASE</span>

<span class="n">fb_Move1D</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Timeout</span> <span class="ow">and</span> <span class="n">checks</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">nTestStep</span> <span class="o">=</span> <span class="mi">7</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in deadlock test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">eNewGoal</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="s1">&#39;Did not reach a goal state in deadlock test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move1D</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-teststates">E_TestStates</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate2d">FB_PositionState2D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate3d">FB_PositionState3D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps">
<h2>FB_PositionStatePMPS<a class="headerlink" href="#fb-positionstatepmps" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{attribute &#39;obsolete&#39; := &#39;Use FB_PositionStatePMPS1D instead&#39;}
FUNCTION_BLOCK FB_PositionStatePMPS EXTENDS FB_PositionStatePMPS_Base
(*
    Hooks up a position state to an arbiter and an FFO
        Use BeamParameterTransitionManager to manage transition requests between states
        Hook up to the inputs/outputs of the state function block
        Raises FFO if beam parameters are worse than required for current state
*)
VAR_IN_OUT
    fbArbiter: FB_Arbiter;
    fbFFHWO: FB_HardwareFFOutput;
END_VAR
VAR_INPUT
    bReadPmpsDb: BOOL;
    sPmpsDeviceName: STRING;
    sTransitionKey: STRING;
    stPmpsDoc: SJsonValue;
    stHighBeamThreshold: ST_BeamParams := PMPS_GVL.cstFullBeam;
    bBPOKAutoReset: BOOL := False;
END_VAR
VAR
    arrPMPS: ARRAY[0..GeneralConstants.MAX_STATES] OF ST_DbStateParams;
    nBPIndex: UINT;
    nTransitionAssertionID: UDINT;
    nLastReqAssertionID: UDINT;
    fbReadPmpsDb: FB_JsonDocToSafeBP;
    ftDbBusy: F_TRIG;
    rtReadDBExec: R_TRIG;
    ftRead: F_TRIG;
    bptm: BeamParameterTransitionManager;
    ffBeamParamsOk: FB_FastFault;
    ffZeroRate: FB_FastFault;
    ffBPTMTimeoutAndMove: FB_FastFault;
    ffBPTMError: FB_FastFault;
    ffMaint: FB_FastFault;
    ffUnknown: FB_FastFault;
    bFFOxOk: BOOL;
    bAtSafeState: BOOL;
    nIter: UINT;
END_VAR
Exec();

END_FUNCTION_BLOCK

ACTION AssertHere:
fbArbiter.AddRequest(
    sDevName := stMotionStage.sName,
    nReqID := stStateReq.stPMPS.nRequestAssertionID,
    stReqBP := stStateReq.stPMPS.stBeamParams);
END_ACTION

ACTION ClearAsserts:
fbArbiter.RemoveRequest(nTransitionAssertionID);
FOR nIter := 1 TO GeneralConstants.MAX_STATES DO
    fbArbiter.RemoveRequest(arrStates[nIter].stPMPS.nRequestAssertionID);
END_FOR
END_ACTION

ACTION HandleBPTM:
(*
  Handle finishing the bptm late if timed out
  bptm needs a rising edge of bTransDone after authorizing transition
  If we fall into this block, bTransDone would otherwise be stuck at TRUE forever
  so the BPTM would never see a rising edge and therefore stay stuck
  We set to FALSE here to reset the BPTM, then gets set to TRUE again if really done.
*)
rtDoLateFinish(CLK:=bLateFinish AND bInternalAuth);
IF rtDoLateFinish.Q THEN
    bTransDone := FALSE;
    bLateFinish := FALSE;
END_IF

IF stStateReq.stPMPS.nRequestAssertionID &lt;&gt; nTransitionAssertionID THEN
    (*
        Edge case: the request is swapped out without a move
        Same as above: we need a rising edge of bTransDone, so cause a falling edge and the let the rising edge happen next cycle
        This will already be false when we request a positional move
    *)
    bTransDone R= stStateReq.stPMPS.nRequestAssertionID &lt;&gt; nLastReqAssertionID;
    // Just normal bptm call
    bptm(fbArbiter:=fbArbiter,
         i_sDeviceName:=stMotionStage.sName,
         i_TransitionAssertionID:=nTransitionAssertionID,
         i_stTransitionAssertion:=stTransitionBeam,
         i_nRequestedAssertionID:=stStateReq.stPMPS.nRequestAssertionID,
         i_stRequestedAssertion:=stStateReq.stPMPS.stBeamParams,
         i_xDoneMoving:=bTransDone,
         stCurrentBeamParameters:=PMPS_GVL.stCurrentBeamParameters,
         q_xTransitionAuthorized=&gt;bInternalAuth,
         bDone=&gt;bBPTMDone);
    nLastReqAssertionID := stStateReq.stPMPS.nRequestAssertionID;
END_IF
END_ACTION

ACTION HandleFFO:
// stBeamNeeded will point to Unknown/No beam if we are out of state bounds or in motion
// Otherwise we&#39;ll have the current state&#39;s beam parameters

// Check for bad conditions
bFFOxOk := F_SafeBPCompare(PMPS_GVL.stCurrentBeamParameters, stBeamNeeded);
// It is safe to reset automatically if our current state can take full beam.
// Otherwise we&#39;ll have to ask for a user acknowledgement to clear.
// This avoids rapidly cycling the FFOs on/off
// You can pass in a different stHighBeamThreshold as an input parameter to customize this behavior
bAtSafeState := F_SafeBPCompare(stHighBeamThreshold, stBeamNeeded);

// If the beam parameters are wrong, it is a fault! This encompasses all unknown arbiter-related errors.
ffBeamParamsOk.i_xOK := bFFOxOk;
ffBeamParamsOk.i_xReset S= bFFOxOk AND bAtSafeState;
ffBeamParamsOk.i_xReset R= NOT ffBeamParamsOk.i_xOK;
ffBeamParamsOk.i_xAutoReset := bBPOKAutoReset;

ffBeamParamsOk(
    i_DevName:=stMotionStage.sName,
    i_Desc:=&#39;Beam parameter mismatch&#39;,
    i_TypeCode:=16#1000,
    io_fbFFHWO:=fbFFHWO);

// Trip the beam for zero-rate states. This is a PMPS training wheel and should ultimately be removed.
// Note: I think this is already redundant
ffZeroRate(
    i_xOk := stBeamNeeded.nRate &gt; 0,
    i_xAutoReset := TRUE,
    i_DevName := stMotionStage.sName,
    i_Desc := &#39;Device requesting zero rate&#39;,
    i_TypeCode := 16#1001,
    io_fbFFHWO := fbFFHWO);

// Trip the beam for BPTM timeouts if we want to move
// Only reset at safe beam OR at no bptm errors (some other FF should catch additional issues)
ffBPTMTimeoutAndMove.i_xOK := NOT (bArbiterTimeout AND bMoveOnArbiterTimeout);
ffBPTMTimeoutAndMove.i_xReset S= bAtSafeState OR (bptm.bDone AND NOT bptm.bError);
ffBPTMTimeoutAndMove.i_xReset R= NOT ffBPTMTimeoutAndMove.i_xOK;
ffBPTMTimeoutAndMove(
    i_DevName := stMotionStage.sName,
    i_Desc := &#39;BPTM Timeout&#39;,
    i_TypeCode := 16#1002,
    io_fbFFHWO := fbFFHWO);

// Trip the beam for BPTM Errors
ffBPTMError.i_xOK := NOT bptm.bError;
ffBPTMError.i_xReset S= bptm.bDone AND NOT bptm.bError;
ffBPTMError.i_xReset R= NOT ffBPTMError.i_xOK;
ffBPTMError(
    i_DevName := stMotionStage.sName,
    i_Desc := &#39;BPTM error, state transition failed&#39;,
    i_TypeCode := 16#1003,
    io_fbFFHWO := fbFFHWO);

// Trip the beam for maintenance mode
ffMaint(
    i_xOK := NOT bMaintMode,
    i_xAutoReset := TRUE,
    i_DevName := stMotionStage.sName,
    i_Desc := &#39;Device is in maintenance mode&#39;,
    i_TypeCode := 16#1004,
    io_fbFFHWO := fbFFHWO);

// Trip the beam for unknown state
ffUnknown(
    i_xOK := getState &gt; 0 OR bInTransition,
    i_xAutoReset := TRUE,
    i_DevName := stMotionStage.sName,
    i_Desc := &#39;Unknown position between moves&#39;,
    i_TypeCode := 16#1005,
    io_fbFFHWO := fbFFHWO);
END_ACTION

ACTION HandlePmpsDb:
// Automatically read from the pmps db when it updates
// Assume update if no longer busy and no errors

ftDbBusy(CLK:=MOTION_GVL.fbPmpsFileReader.bBusy);
IF ftDbBusy.Q THEN
    bReadPmpsDb S= NOT MOTION_GVL.fbPmpsFileReader.bError;
END_IF

rtReadDBExec(CLK:=bReadPmpsDb);
IF rtReadDBExec.Q THEN
    arrPMPS[0].sPmpsState := sTransitionKey;
    FOR nBPIndex := 1 TO GeneralConstants.MAX_STATES BY 1 DO
        arrPMPS[nBPIndex] := arrStates[nBPIndex].stPMPS;
    END_FOR
END_IF

fbReadPmpsDb(
    bExecute:=bReadPmpsDb,
    jsonDoc:=stPmpsDoc,
    sDeviceName:=sPmpsDeviceName,
    io_fbFFHWO:=fbFFHWO,
    arrStates:=arrPMPS,
);
bReadPmpsDb R= NOT fbReadPmpsDb.bBusy;

ftRead(CLK:=fbReadPmpsDb.bBusy);

stTransitionState.sName := &#39;Transition&#39;;
IF ftRead.Q AND NOT fbReadPmpsDb.bError THEN
    stTransitionDb := arrPMPS[0];
    stTransitionBeam := arrPMPS[0].stBeamParams;
    nTransitionAssertionID := arrPMPS[0].nRequestAssertionID;
    stTransitionState.stPMPS := arrPMPS[0];
    FOR nBPIndex := 1 TO GeneralConstants.MAX_STATES BY 1 DO
        arrStates[nBPIndex].stPMPS := arrPMPS[nBPIndex];
    END_FOR
END_IF
END_ACTION
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps-base">FB_PositionStatePMPS_Base</a></p></li>
<li><p><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps1d">
<h2>FB_PositionStatePMPS1D<a class="headerlink" href="#fb-positionstatepmps1d" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS1D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="mi">1</span><span class="o">-</span><span class="n">Dimensional</span> <span class="n">position</span> <span class="n">state</span> <span class="n">function</span> <span class="n">block</span> <span class="k">with</span> <span class="n">PMPS</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">move</span> <span class="n">a</span> <span class="n">motor</span> <span class="n">among</span> <span class="n">some</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span> <span class="k">with</span> <span class="n">PMPS</span> <span class="n">protection</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">use</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">state</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">give</span> <span class="n">them</span> <span class="n">pytmc</span> <span class="n">pragmas</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">FB_PositionState1D_InOut</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">example</span><span class="o">.</span>
    <span class="n">These</span> <span class="n">enums</span> <span class="n">must</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="ow">and</span> <span class="n">eEnumGet</span> <span class="n">VAR_IN_OUT</span> <span class="n">variables</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">enum</span> <span class="n">values</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">array</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">astPositionState</span><span class="o">.</span>

    <span class="n">A</span> <span class="n">move</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">when</span> <span class="n">eEnumSet</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span> <span class="n">value</span><span class="o">.</span> <span class="n">eEnumSet</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">allowing</span> <span class="n">us</span>
    <span class="n">to</span> <span class="n">accept</span> <span class="n">a</span> <span class="n">new</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">move</span> <span class="n">request</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="n">the</span> <span class="n">first</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motor</span> <span class="n">must</span> <span class="n">already</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">point</span> <span class="n">motion</span> <span class="n">via</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">,</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">work</span> <span class="n">properly</span><span class="o">.</span>

    <span class="n">PMPS</span> <span class="n">handling</span> <span class="ow">is</span> <span class="n">done</span> <span class="n">via</span> <span class="n">database</span> <span class="n">lookups</span> <span class="n">by</span> <span class="n">setting</span> <span class="n">sPmpsState</span> <span class="n">on</span> <span class="n">each</span> <span class="n">position</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">on</span>
    <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="nb">input</span> <span class="n">appropriately</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span><span class="o">.</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableMotion</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StatePMPSEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPMPSPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePMPSPlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">fbPMPSCore</span><span class="p">:</span> <span class="n">FB_PositionStatePMPSND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">;</span>

<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnableMotion</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbPMPSCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="o">:=</span><span class="n">stPMPSEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">stPMPSPlcToEpics</span><span class="o">:=</span><span class="n">stPMPSPlcToEpics</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">:=</span><span class="n">fbCore</span><span class="o">.</span><span class="n">nCurrGoal</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">stDbStateParams</span><span class="o">=&gt;</span><span class="n">stDbStateParams</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">astPositionState</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmpsnd-core">FB_PositionStatePMPSND_Core</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsepicstoplc">ST_StatePMPSEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsplctoepics">ST_StatePMPSPlcToEpics</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps1d-inout">
<h2>FB_PositionStatePMPS1D_InOut<a class="headerlink" href="#fb-positionstatepmps1d-inout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS1D_InOut</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">An</span> <span class="n">example</span> <span class="ow">and</span> <span class="n">usable</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="n">instance</span> <span class="k">for</span> <span class="n">a</span> <span class="mi">1</span><span class="n">D</span> <span class="n">pmps</span> <span class="n">state</span> <span class="n">device</span> <span class="k">with</span> <span class="n">just</span> <span class="n">an</span> <span class="n">IN</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">Note</span> <span class="n">that</span> <span class="n">the</span> <span class="n">outward</span><span class="o">-</span><span class="n">facing</span> <span class="n">API</span> <span class="ow">is</span> <span class="n">nearly</span> <span class="n">identical</span> <span class="n">to</span> <span class="n">the</span> <span class="n">non</span><span class="o">-</span><span class="n">PMPS</span> <span class="n">version</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">a</span> <span class="n">stage</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">into</span> <span class="n">the</span> <span class="n">FB</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Simplify</span> <span class="n">the</span> <span class="n">interface</span><span class="p">,</span> <span class="n">the</span> <span class="n">user</span> <span class="n">just</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">construct</span> <span class="ow">and</span> <span class="k">pass</span> <span class="ow">in</span> <span class="ow">and</span> <span class="n">out</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">PMPS</span> <span class="n">output</span> <span class="n">helpers</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">a</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">expected</span> <span class="n">this</span> <span class="n">will</span> <span class="n">be</span> <span class="n">written</span> <span class="n">to</span> <span class="n">during</span> <span class="n">one</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">so</span> <span class="n">don</span><span class="s1">&#39;t continually apply a value here in the PLC code.</span>
    <span class="o">//</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">exposed</span> <span class="k">as</span> <span class="n">an</span> <span class="nb">input</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">test</span> <span class="n">it</span> <span class="n">using</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateSet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="n">report</span> <span class="n">the</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateGet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">fb</span> <span class="k">with</span> <span class="n">blank</span> <span class="n">pv</span> <span class="n">pragma</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">fbPositionStatePMPS1D</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS1D</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">standard</span> <span class="n">fb</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">full</span> <span class="n">array</span> <span class="n">of</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Optional</span><span class="p">:</span> <span class="n">default</span> <span class="n">state</span> <span class="n">names</span>
<span class="n">IF</span> <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Assemble</span> <span class="n">the</span> <span class="n">states</span> <span class="n">array</span><span class="p">,</span> <span class="n">matching</span> <span class="n">the</span> <span class="n">enum</span> <span class="n">values</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">main</span> <span class="n">function</span> <span class="n">block</span><span class="p">,</span> <span class="n">passing</span> <span class="n">our</span> <span class="n">motors</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">enable</span>
<span class="n">fbPositionStatePMPS1D</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eStateSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eStateGet</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Send</span> <span class="n">updates</span> <span class="n">made</span> <span class="n">on</span> <span class="n">the</span> <span class="n">array</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">inputs</span> <span class="p">(</span><span class="n">VAR_IN_OUT</span><span class="p">)</span> <span class="k">for</span> <span class="n">maximum</span> <span class="n">clarity</span>
<span class="n">stOut</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">stIn</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsinout">E_EpicsInOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps2d">
<h2>FB_PositionStatePMPS2D<a class="headerlink" href="#fb-positionstatepmps2d" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS2D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="mi">2</span><span class="o">-</span><span class="n">Dimensional</span> <span class="n">position</span> <span class="n">state</span> <span class="n">function</span> <span class="n">block</span> <span class="k">with</span> <span class="n">PMPS</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">move</span> <span class="mi">2</span> <span class="n">motors</span> <span class="n">among</span> <span class="n">some</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span> <span class="k">with</span> <span class="n">PMPS</span> <span class="n">protection</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">use</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">state</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">give</span> <span class="n">them</span> <span class="n">pytmc</span> <span class="n">pragmas</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">FB_PositionState1D_InOut</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">example</span><span class="o">.</span>
    <span class="n">These</span> <span class="n">enums</span> <span class="n">must</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="ow">and</span> <span class="n">eEnumGet</span> <span class="n">VAR_IN_OUT</span> <span class="n">variables</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">enum</span> <span class="n">values</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">array</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">astPositionState1</span> <span class="ow">and</span> <span class="n">astPositionState2</span><span class="o">.</span>

    <span class="n">A</span> <span class="n">move</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">when</span> <span class="n">eEnumSet</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span> <span class="n">value</span><span class="o">.</span> <span class="n">eEnumSet</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">allowing</span> <span class="n">us</span>
    <span class="n">to</span> <span class="n">accept</span> <span class="n">a</span> <span class="n">new</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">move</span> <span class="n">request</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="n">the</span> <span class="n">first</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motors</span> <span class="n">must</span> <span class="n">already</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">point</span> <span class="n">motion</span> <span class="n">via</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">,</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">work</span> <span class="n">properly</span><span class="o">.</span>

    <span class="n">PMPS</span> <span class="n">handling</span> <span class="ow">is</span> <span class="n">done</span> <span class="n">via</span> <span class="n">database</span> <span class="n">lookups</span> <span class="n">by</span> <span class="n">setting</span> <span class="n">sPmpsState</span> <span class="n">on</span> <span class="n">each</span> <span class="n">position</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">on</span>
    <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="nb">input</span> <span class="n">appropriately</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">1</span><span class="n">st</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">1</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">M1</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">2</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">M2</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableMotion</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StatePMPSEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPMPSPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePMPSPlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">fbPMPSCore</span><span class="p">:</span> <span class="n">FB_PositionStatePMPSND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage1</span><span class="p">;</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage2</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">;</span>

<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnableMotion</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbPMPSCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="o">:=</span><span class="n">stPMPSEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">stPMPSPlcToEpics</span><span class="o">:=</span><span class="n">stPMPSPlcToEpics</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">:=</span><span class="n">fbCore</span><span class="o">.</span><span class="n">nCurrGoal</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">stDbStateParams</span><span class="o">=&gt;</span><span class="n">stDbStateParams</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stMotionStage1</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stMotionStage2</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">astPositionState1</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">astPositionState2</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmpsnd-core">FB_PositionStatePMPSND_Core</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsepicstoplc">ST_StatePMPSEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsplctoepics">ST_StatePMPSPlcToEpics</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps2d-inout">
<h2>FB_PositionStatePMPS2D_InOut<a class="headerlink" href="#fb-positionstatepmps2d-inout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS2D_InOut</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">An</span> <span class="n">example</span> <span class="ow">and</span> <span class="n">usable</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="n">instance</span> <span class="k">for</span> <span class="n">a</span> <span class="mi">2</span><span class="n">D</span> <span class="n">state</span> <span class="n">device</span> <span class="k">with</span> <span class="n">just</span> <span class="n">an</span> <span class="n">IN</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">Note</span> <span class="n">that</span> <span class="n">the</span> <span class="n">outward</span><span class="o">-</span><span class="n">facing</span> <span class="n">API</span> <span class="ow">is</span> <span class="n">nearly</span> <span class="n">identical</span> <span class="n">to</span> <span class="n">the</span> <span class="n">non</span><span class="o">-</span><span class="n">PMPS</span> <span class="n">version</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">stages</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">into</span> <span class="n">the</span> <span class="n">FB</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Simplify</span> <span class="n">the</span> <span class="n">interface</span><span class="p">,</span> <span class="n">the</span> <span class="n">user</span> <span class="n">just</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">construct</span> <span class="ow">and</span> <span class="k">pass</span> <span class="ow">in</span> <span class="ow">and</span> <span class="n">out</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">stIn1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stOut1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stIn2</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stOut2</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">PMPS</span> <span class="n">output</span> <span class="n">helpers</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">a</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">expected</span> <span class="n">this</span> <span class="n">will</span> <span class="n">be</span> <span class="n">written</span> <span class="n">to</span> <span class="n">during</span> <span class="n">one</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">so</span> <span class="n">don</span><span class="s1">&#39;t continually apply a value here in the PLC code.</span>
    <span class="o">//</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">exposed</span> <span class="k">as</span> <span class="n">an</span> <span class="nb">input</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">test</span> <span class="n">it</span> <span class="n">using</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateSet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="n">report</span> <span class="n">the</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateGet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">fb</span> <span class="k">with</span> <span class="n">blank</span> <span class="n">pv</span> <span class="n">pragma</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">fbPositionStatePMPS2D</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS2D</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">standard</span> <span class="n">fb</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">full</span> <span class="n">array</span> <span class="n">of</span> <span class="n">position</span> <span class="n">states</span> <span class="n">per</span> <span class="n">motor</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Optional</span><span class="p">:</span> <span class="n">default</span> <span class="n">state</span> <span class="n">names</span>
<span class="n">IF</span> <span class="n">stIn1</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stIn1</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stOut1</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stOut1</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stIn2</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stIn2</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stOut2</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stOut2</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Assemble</span> <span class="n">the</span> <span class="n">states</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">matching</span> <span class="n">the</span> <span class="n">enum</span> <span class="n">values</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut1</span><span class="p">;</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn1</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut2</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn2</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">main</span> <span class="n">function</span> <span class="n">block</span><span class="p">,</span> <span class="n">passing</span> <span class="n">our</span> <span class="n">motors</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">enable</span>
<span class="n">fbPositionStatePMPS2D</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eStateSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eStateGet</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Send</span> <span class="n">updates</span> <span class="n">made</span> <span class="n">on</span> <span class="n">the</span> <span class="n">array</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">inputs</span> <span class="p">(</span><span class="n">VAR_IN_OUT</span><span class="p">)</span> <span class="k">for</span> <span class="n">maximum</span> <span class="n">clarity</span>
<span class="n">stOut1</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">stIn1</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">];</span>
<span class="n">stOut2</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">stIn2</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsinout">E_EpicsInOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps2d">FB_PositionStatePMPS2D</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps3d">
<h2>FB_PositionStatePMPS3D<a class="headerlink" href="#fb-positionstatepmps3d" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS3D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="mi">3</span><span class="o">-</span><span class="n">Dimensional</span> <span class="n">position</span> <span class="n">state</span> <span class="n">function</span> <span class="n">block</span> <span class="k">with</span> <span class="n">PMPS</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">move</span> <span class="mi">3</span> <span class="n">motors</span> <span class="n">among</span> <span class="n">some</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span> <span class="k">with</span> <span class="n">PMPS</span> <span class="n">protection</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">use</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">state</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">give</span> <span class="n">them</span> <span class="n">pytmc</span> <span class="n">pragmas</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">FB_PositionState1D_InOut</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">example</span><span class="o">.</span>
    <span class="n">These</span> <span class="n">enums</span> <span class="n">must</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="ow">and</span> <span class="n">eEnumGet</span> <span class="n">VAR_IN_OUT</span> <span class="n">variables</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">enum</span> <span class="n">values</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">array</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">astPositionState1</span><span class="p">,</span> <span class="n">astPositionState2</span><span class="p">,</span> <span class="ow">and</span> <span class="n">astPositionState3</span><span class="o">.</span>

    <span class="n">A</span> <span class="n">move</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">when</span> <span class="n">eEnumSet</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span> <span class="n">value</span><span class="o">.</span> <span class="n">eEnumSet</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">allowing</span> <span class="n">us</span>
    <span class="n">to</span> <span class="n">accept</span> <span class="n">a</span> <span class="n">new</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">move</span> <span class="n">request</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="n">the</span> <span class="n">first</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motors</span> <span class="n">must</span> <span class="n">already</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">point</span> <span class="n">motion</span> <span class="n">via</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">,</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">work</span> <span class="n">properly</span><span class="o">.</span>

    <span class="n">PMPS</span> <span class="n">handling</span> <span class="ow">is</span> <span class="n">done</span> <span class="n">via</span> <span class="n">database</span> <span class="n">lookups</span> <span class="n">by</span> <span class="n">setting</span> <span class="n">sPmpsState</span> <span class="n">on</span> <span class="n">each</span> <span class="n">position</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">on</span>
    <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="nb">input</span> <span class="n">appropriately</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">1</span><span class="n">st</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">3</span><span class="n">rd</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage3</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">1</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">M1</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">2</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">M2</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">3</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">M3</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState3</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableMotion</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StatePMPSEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPMPSPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePMPSPlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">fbPMPSCore</span><span class="p">:</span> <span class="n">FB_PositionStatePMPSND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage1</span><span class="p">;</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage2</span><span class="p">;</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage3</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState3</span><span class="p">;</span>

<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnableMotion</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbPMPSCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="o">:=</span><span class="n">stPMPSEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">stPMPSPlcToEpics</span><span class="o">:=</span><span class="n">stPMPSPlcToEpics</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">:=</span><span class="n">fbCore</span><span class="o">.</span><span class="n">nCurrGoal</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">stDbStateParams</span><span class="o">=&gt;</span><span class="n">stDbStateParams</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stMotionStage1</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stMotionStage2</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">stMotionStage3</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="n">astPositionState1</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">astPositionState2</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">astPositionState3</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmpsnd-core">FB_PositionStatePMPSND_Core</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsepicstoplc">ST_StatePMPSEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsplctoepics">ST_StatePMPSPlcToEpics</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps-base">
<h2>FB_PositionStatePMPS_Base<a class="headerlink" href="#fb-positionstatepmps-base" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionStatePMPS1D instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS_Base</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">FB_PositionStatePMPS</span> <span class="n">without</span> <span class="n">Arbiter</span><span class="p">,</span> <span class="n">BPTM</span><span class="p">,</span> <span class="n">FFO</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">me</span> <span class="n">to</span> <span class="n">test</span> <span class="n">most</span> <span class="n">of</span> <span class="n">the</span> <span class="n">code</span> <span class="n">without</span> <span class="n">an</span> <span class="n">arbiter</span> <span class="n">plc</span> <span class="n">setup</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bArbiterEnabled</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MAINT</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">bMaintMode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bRequestTransition</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">setState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">getState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">fStateBoundaryDeadband</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">tArbiterTimeout</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1s;</span>
    <span class="n">bMoveOnArbiterTimeout</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bTransitionAuthorized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bForwardAuthorized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBackwardAuthorized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bArbiterTimeout</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">TRANS</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">stTransitionDb</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
    <span class="n">stTransitionBeam</span><span class="p">:</span> <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">;</span>
    <span class="n">stTransitionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bTransDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtTransReq</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bBPTMDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtBPTMDone</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftMotorExec</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">rtTransDone</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtDoLateFinish</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tonDone</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">stStateReq</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">mcPower</span><span class="p">:</span> <span class="n">MC_POWER</span><span class="p">;</span>
    <span class="n">fUpperBound</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fLowerBound</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nGoalState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">stGoalState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fActPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fReqPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bInTransition</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">stBeamNeeded</span><span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">bFwdOk</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBwdOk</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tonArbiter</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bLateFinish</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInternalAuth</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">meant</span> <span class="n">to</span> <span class="n">be</span> <span class="n">subclassed</span><span class="o">.</span> <span class="n">The</span> <span class="n">parent</span> <span class="k">class</span><span class="w"> </span><span class="nc">body</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">Exec</span> <span class="n">action</span><span class="o">.</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">AssertHere</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ClearAsserts</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">Exec</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Load</span> <span class="n">the</span> <span class="n">pmps</span> <span class="n">parameters</span> <span class="k">as</span> <span class="n">needed</span>
<span class="n">HandlePmpsDb</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Initialize</span> <span class="ow">or</span> <span class="n">reinitialize</span> <span class="n">to</span> <span class="n">the</span> <span class="n">current</span> <span class="n">state</span> <span class="n">value</span>
<span class="n">rtBPTMDone</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bBPTMDone</span><span class="p">);</span>
<span class="n">ftMotorExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">tonDone</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bTransDone</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#100ms</span>
    <span class="p">);</span>
<span class="n">IF</span> <span class="n">rtBPTMDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">ftMotorExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">tonDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">bInit</span> <span class="n">OR</span> <span class="n">nGoalState</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">OR</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="n">R</span><span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAxisParamsInit</span><span class="p">;</span>
    <span class="n">nGoalState</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
    <span class="n">stStateReq</span> <span class="o">:=</span> <span class="n">GetStateStruct</span><span class="p">(</span><span class="n">getState</span><span class="p">);</span>
    <span class="n">bInTransition</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">rtTransReq</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">bTransitionAuthorized</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bArbiterTimeout</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Request</span> <span class="n">transition</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span>
<span class="n">rtTransReq</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bRequestTransition</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtTransReq</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">nGoalState</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>
    <span class="n">stStateReq</span> <span class="o">:=</span> <span class="n">GetStateStruct</span><span class="p">(</span><span class="n">setState</span><span class="p">);</span>
    <span class="n">bInTransition</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bTransDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bTransDone</span> <span class="o">:=</span> <span class="n">F_AtPositionState</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span> <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stStateReq</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Mark</span> <span class="n">late</span> <span class="n">finish</span> <span class="k">if</span> <span class="n">bTransDone</span> <span class="o">-&gt;</span> <span class="n">true</span> <span class="n">before</span> <span class="n">the</span> <span class="n">bptm</span> <span class="ow">is</span> <span class="n">done</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">means</span> <span class="n">that</span> <span class="n">we</span> <span class="n">finished</span> <span class="n">the</span> <span class="n">move</span> <span class="n">so</span> <span class="n">fast</span> <span class="n">that</span> <span class="n">the</span> <span class="n">bptm</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">unstuck</span> <span class="n">via</span> <span class="n">toggling</span> <span class="n">bTransDone</span>
<span class="n">rtTransDone</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bTransDone</span><span class="p">);</span>
<span class="n">bLateFinish</span> <span class="n">S</span><span class="o">=</span> <span class="n">rtTransDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bBPTMDone</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bArbiterEnabled</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Handles</span> <span class="n">getting</span> <span class="n">the</span> <span class="n">request</span> <span class="n">to</span> <span class="n">the</span> <span class="n">arbiter</span> <span class="ow">and</span> <span class="n">back</span>
    <span class="n">HandleBPTM</span><span class="p">();</span>
    <span class="o">//</span> <span class="n">Handle</span> <span class="n">arbiter</span> <span class="n">timeouts</span>
    <span class="n">IF</span> <span class="n">tArbiterTimeout</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#0s THEN</span>
        <span class="n">tonArbiter</span><span class="p">(</span>
            <span class="n">IN</span><span class="o">:=</span><span class="n">bInTransition</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bInternalAuth</span><span class="p">,</span>
            <span class="n">PT</span><span class="o">:=</span><span class="n">tArbiterTimeout</span><span class="p">,</span>
            <span class="n">Q</span><span class="o">=&gt;</span><span class="n">bArbiterTimeout</span><span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">bArbiterTimeout</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">bTransitionAuthorized</span> <span class="n">S</span><span class="o">=</span> <span class="n">bInternalAuth</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bArbiterTimeout</span> <span class="n">AND</span> <span class="n">bMoveOnArbiterTimeout</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="o">//</span> <span class="n">Clear</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">our</span> <span class="n">assertions</span> <span class="k">if</span> <span class="n">we</span> <span class="n">decide</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">the</span> <span class="n">arbiter</span>
    <span class="n">ClearAsserts</span><span class="p">();</span>
    <span class="o">//</span> <span class="n">Do</span> <span class="n">some</span> <span class="n">dummy</span> <span class="n">request</span> <span class="n">handling</span>
    <span class="n">bTransitionAuthorized</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">bArbiterTimeout</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">up</span> <span class="n">MPS</span> <span class="n">virtual</span> <span class="n">limit</span> <span class="k">for</span> <span class="n">moves</span> <span class="n">at</span> <span class="ow">and</span> <span class="n">between</span> <span class="n">states</span>
<span class="n">stGoalState</span> <span class="o">:=</span> <span class="n">GetStateStruct</span><span class="p">(</span><span class="n">nGoalState</span><span class="p">);</span>
<span class="n">fActPos</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">fReqPos</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">fReqPos</span> <span class="o">:=</span> <span class="n">fActPos</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Start</span> <span class="k">with</span> <span class="n">no</span> <span class="n">move</span> <span class="n">authority</span>
<span class="n">bForwardAuthorized</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">bBackwardAuthorized</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">it</span> <span class="n">would</span> <span class="n">be</span> <span class="n">OK</span> <span class="n">to</span> <span class="n">move</span> <span class="n">without</span> <span class="n">granting</span> <span class="n">auth</span>
<span class="n">bFwdOk</span> <span class="o">:=</span> <span class="n">F_PosUnderUpperBound</span><span class="p">(</span><span class="n">MAX</span><span class="p">(</span><span class="n">fActPos</span><span class="p">,</span> <span class="n">fReqPos</span><span class="p">)</span> <span class="o">+</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fStateBoundaryDeadband</span><span class="p">),</span> <span class="n">stGoalState</span><span class="p">);</span>
<span class="n">bBwdOk</span> <span class="o">:=</span> <span class="n">F_PosOverLowerBound</span><span class="p">(</span><span class="n">MIN</span><span class="p">(</span><span class="n">fActPos</span><span class="p">,</span> <span class="n">fReqPos</span><span class="p">)</span> <span class="o">-</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fStateBoundaryDeadband</span><span class="p">),</span> <span class="n">stGoalState</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Grant</span> <span class="n">auth</span> <span class="n">during</span> <span class="n">moves</span> <span class="n">based</span> <span class="n">on</span> <span class="n">goal</span> <span class="n">state</span><span class="p">,</span> <span class="n">current</span> <span class="n">position</span><span class="p">,</span> <span class="ow">and</span> <span class="n">goal</span> <span class="n">position</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">stGoalState</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
    <span class="n">bForwardAuthorized</span> <span class="o">:=</span> <span class="n">bFwdOk</span><span class="p">;</span>
    <span class="n">bBackwardAuthorized</span> <span class="o">:=</span> <span class="n">bBwdOk</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bInTransition</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Deny</span> <span class="n">auth</span> <span class="n">during</span> <span class="n">a</span> <span class="n">transition</span> <span class="n">request</span> <span class="n">until</span> <span class="n">transition</span> <span class="ow">is</span> <span class="n">authorized</span>
    <span class="n">bForwardAuthorized</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bTransitionAuthorized</span><span class="p">;</span>
    <span class="n">bBackwardAuthorized</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bTransitionAuthorized</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Have</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">permission</span> <span class="n">to</span> <span class="n">start</span> <span class="n">move</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">immediately</span> <span class="n">erroring</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">bTransitionAuthorized</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="o">//</span> <span class="n">If</span> <span class="ow">not</span> <span class="n">transitioning</span><span class="p">,</span> <span class="n">no</span> <span class="n">need</span> <span class="n">to</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">safety</span><span class="p">:</span> <span class="n">immediately</span> <span class="k">try</span> <span class="n">to</span> <span class="n">move</span> <span class="ow">and</span> <span class="n">error</span> <span class="k">if</span> <span class="n">no</span> <span class="n">auth</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">an</span> <span class="n">error</span> <span class="n">message</span> <span class="n">override</span> <span class="ow">in</span> <span class="n">case</span> <span class="n">this</span> <span class="n">causes</span> <span class="n">an</span> <span class="n">error</span>
    <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">bArbiterEnabled</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bMaintMode</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">fReqPos</span> <span class="o">&gt;</span> <span class="n">fActPos</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bFwdOk</span> <span class="n">THEN</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Unsafe tweak forward blocked by PMPS&#39;</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fReqPos</span> <span class="o">&lt;</span> <span class="n">fActPos</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bBwdOk</span> <span class="n">THEN</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Unsafe tweak backward blocked by PMPS&#39;</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bArbiterEnabled</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bMaintMode</span> <span class="n">THEN</span>
<span class="o">//</span> <span class="n">Only</span> <span class="n">let</span> <span class="n">us</span> <span class="n">move</span> <span class="k">if</span> <span class="n">the</span> <span class="n">transition</span> <span class="ow">is</span> <span class="n">allowed</span><span class="p">,</span> <span class="ow">or</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="n">moving</span> <span class="n">within</span> <span class="n">a</span> <span class="n">state</span><span class="s1">&#39;s bounds</span>
    <span class="n">mcPower</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">Enable</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span><span class="p">,</span>
            <span class="n">Enable_Positive</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllForwardEnable</span> <span class="n">AND</span> <span class="n">bForwardAuthorized</span><span class="p">,</span>
            <span class="n">Enable_Negative</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllBackwardEnable</span> <span class="n">AND</span> <span class="n">bBackwardAuthorized</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">mcPower</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">Enable</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span><span class="p">,</span>
            <span class="n">Enable_Positive</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">,</span>
            <span class="n">Enable_Negative</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllBackwardEnable</span><span class="p">);</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Raise</span> <span class="n">fast</span> <span class="n">faults</span> <span class="k">as</span> <span class="n">needed</span>
<span class="n">stBeamNeeded</span> <span class="o">:=</span> <span class="n">GetBeamFromState</span><span class="p">(</span><span class="n">getState</span><span class="p">);</span>
<span class="n">HandleFFO</span><span class="p">();</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandleBPTM</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandleFFO</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandlePmpsDb</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">METHOD</span> <span class="n">GetBeamFromState</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">stState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stState</span> <span class="o">:=</span> <span class="n">GetStateStruct</span><span class="p">(</span><span class="n">nState</span><span class="p">);</span>
<span class="n">GetBeamFromState</span> <span class="o">:=</span> <span class="n">stState</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">stBeamParams</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">GetStateCode</span> <span class="p">:</span> <span class="n">INT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">nState</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">OR</span> <span class="n">nState</span> <span class="o">&gt;</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">THEN</span>
    <span class="n">GetStateCode</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">GetStateCode</span> <span class="o">:=</span> <span class="n">nState</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">GetStateStruct</span> <span class="p">:</span> <span class="n">ST_PositionState</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">{</span><span class="n">warning</span> <span class="n">disable</span> <span class="n">C0371</span><span class="p">}</span>
<span class="o">//</span> <span class="n">Implicit</span> <span class="n">VAR_IN_OUT</span> <span class="n">reference</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">method</span> <span class="n">needs</span> <span class="n">special</span> <span class="n">handling</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">__ISVALIDREF</span><span class="p">(</span><span class="n">arrStates</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">GetStateStruct</span> <span class="o">:=</span> <span class="n">stTransitionState</span><span class="p">;</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">CASE</span> <span class="n">GetStateCode</span><span class="p">(</span><span class="n">nState</span><span class="p">)</span> <span class="n">OF</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">GetStateStruct</span> <span class="o">:=</span> <span class="n">stTransitionState</span><span class="p">;</span>
    <span class="mi">0</span><span class="p">:</span> <span class="n">GetStateStruct</span> <span class="o">:=</span> <span class="n">stTransitionState</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">GetStateStruct</span> <span class="o">:=</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">nState</span><span class="p">];</span>
<span class="n">END_CASE</span>
<span class="p">{</span><span class="n">warning</span> <span class="n">restore</span> <span class="n">C0371</span><span class="p">}</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstatepmps">FB_PositionStatePMPS</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#f-posoverlowerbound">F_PosOverLowerBound</a></p></li>
<li><p><a class="reference internal" href="#f-posunderupperbound">F_PosUnderUpperBound</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps-test">
<h2>FB_PositionStatePMPS_Test<a class="headerlink" href="#fb-positionstatepmps-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;No longer any reason to use this, all state classes can have unit tests.&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStatePMPS_Base</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Implement</span> <span class="n">position</span> <span class="n">state</span> <span class="n">pmps</span> <span class="k">with</span> <span class="n">no</span> <span class="n">FFO</span> <span class="ow">and</span> <span class="n">auto</span><span class="o">-</span><span class="n">accept</span> <span class="n">transition</span> <span class="n">after</span> <span class="mi">3</span><span class="n">s</span>
    <span class="n">Use</span> <span class="k">for</span> <span class="n">offline</span> <span class="n">testing</span> <span class="n">of</span> <span class="n">everything</span> <span class="k">except</span> <span class="n">the</span> <span class="n">explicit</span> <span class="n">interface</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">tonReq</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">Exec</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">HandleBPTM</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Send</span> <span class="n">the</span> <span class="n">fake</span> <span class="n">BPTM</span> <span class="n">our</span> <span class="n">assertion</span> <span class="n">request</span> <span class="n">by</span> <span class="n">changing</span> <span class="n">stStateReq</span><span class="o">.</span><span class="n">stBeamParams</span>
<span class="o">//</span> <span class="n">We</span> <span class="n">expect</span> <span class="n">to</span> <span class="n">recieve</span> <span class="n">bTransitionAuthorized</span> <span class="n">TRUE</span> <span class="n">after</span> <span class="n">some</span> <span class="n">delta</span> <span class="n">T</span>
<span class="o">//</span> <span class="n">We</span> <span class="n">expect</span> <span class="n">bTransitionAuthorized</span> <span class="n">to</span> <span class="n">go</span> <span class="n">FALSE</span> <span class="n">after</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">goes</span> <span class="n">FALSE</span>
<span class="n">tonReq</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bInTransition</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#3s);</span>
<span class="n">bTransitionAuthorized</span> <span class="o">:=</span> <span class="n">tonReq</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandleFFO</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Skip</span> <span class="n">implementing</span> <span class="n">this</span> <span class="k">for</span> <span class="n">offline</span> <span class="n">testing</span>
<span class="o">//</span> <span class="n">We</span> <span class="n">won</span><span class="s1">&#39;t be able to tell if it worked anyway</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstatepmps-base">FB_PositionStatePMPS_Base</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmpsnd-core">
<h2>FB_PositionStatePMPSND_Core<a class="headerlink" href="#fb-positionstatepmpsnd-core" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPSND_Core</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Collection</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">core</span> <span class="n">actions</span> <span class="n">shared</span> <span class="n">between</span> <span class="nb">all</span> <span class="n">PMPS</span> <span class="n">states</span> <span class="n">FBs</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS1D</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS2D</span>
    <span class="o">-</span> <span class="o">...</span> <span class="n">etc</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">handles</span> <span class="n">database</span> <span class="n">reading</span><span class="p">,</span> <span class="n">BPTM</span><span class="p">,</span> <span class="n">motor</span> <span class="n">enables</span><span class="p">,</span> <span class="n">virtual</span> <span class="n">limits</span><span class="p">,</span> <span class="ow">and</span> <span class="nb">all</span> <span class="n">FFOS</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">be</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">states</span> <span class="n">move</span><span class="p">,</span> <span class="n">including</span> <span class="n">blank</span><span class="o">/</span><span class="n">uninitialized</span> <span class="n">structs</span><span class="o">.</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">motors</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StatePMPSEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stPMPSPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePMPSPlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">be</span> <span class="n">included</span> <span class="ow">in</span> <span class="n">astMotionStageMax</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">index</span> <span class="n">goal</span><span class="p">,</span> <span class="n">where</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">supposed</span> <span class="n">to</span> <span class="n">be</span> <span class="n">moving</span> <span class="n">towards</span><span class="o">.</span>
    <span class="n">nCurrGoal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbMotionReadPMPSDB</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">fbMotionBPTM</span><span class="p">:</span> <span class="n">FB_MotionBPTM</span><span class="p">;</span>
    <span class="n">fbMotionClearAsserts</span><span class="p">:</span> <span class="n">FB_MotionClearAsserts</span><span class="p">;</span>
    <span class="n">fbStatePMPSEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnablesND</span><span class="p">;</span>
    <span class="n">fbMiscStatesErrorFFO</span><span class="p">:</span> <span class="n">FB_MiscStatesErrorFFO</span><span class="p">;</span>
    <span class="n">fbPerMotorFFO</span><span class="p">:</span> <span class="n">FB_PerMotorFFOND</span><span class="p">;</span>

    <span class="n">eStatePMPSStatus</span><span class="p">:</span> <span class="n">E_StatePMPSStatus</span><span class="p">;</span>

    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nGoalAtClear</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">rtEnable</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">stPMPSEpicsToPlc</span><span class="o">.</span><span class="n">bMaintMode</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">stPMPSEpicsToPlc</span><span class="o">.</span><span class="n">bArbiterEnabled</span> <span class="n">THEN</span>
    <span class="n">eStatePMPSStatus</span> <span class="o">:=</span> <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">nCurrGoal</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">eStatePMPSStatus</span> <span class="o">:=</span> <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span> <span class="o">=</span> <span class="n">nCurrGoal</span> <span class="n">THEN</span>
    <span class="n">eStatePMPSStatus</span> <span class="o">:=</span> <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">AT_STATE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">eStatePMPSStatus</span> <span class="o">:=</span> <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">TRANSITION</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionReadPMPSDB</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">bReadNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">astDbStateParams</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bError</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bEnable</span> <span class="o">:=</span> <span class="n">stPMPSEpicsToPlc</span><span class="o">.</span><span class="n">bArbiterEnabled</span> <span class="n">AND</span> <span class="n">bEnableBeamParams</span><span class="p">;</span>
<span class="n">rtEnable</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">);</span>
<span class="n">fbMotionBPTM</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">stGoalParams</span><span class="o">:=</span><span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nCurrGoal</span><span class="p">],</span>
    <span class="n">stTransParams</span><span class="o">:=</span><span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="n">nActiveMotorCount</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">,</span>
    <span class="n">bAtState</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span> <span class="o">=</span> <span class="n">nCurrGoal</span> <span class="n">AND</span> <span class="n">nCurrGoal</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">bRetry</span><span class="o">:=</span><span class="n">rtEnable</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">nGoalAtClear</span> <span class="o">=</span> <span class="n">nCurrGoal</span><span class="p">,</span>
    <span class="n">bTransitionAuthorized</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bDone</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bMotorCountError</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMotionClearAsserts</span><span class="p">(</span>
    <span class="n">astDbStateParams</span><span class="o">:=</span><span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">fbMotionBPTM</span><span class="o">.</span><span class="n">bEnable</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbMotionClearAsserts</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">nGoalAtClear</span> <span class="o">:=</span> <span class="n">nCurrGoal</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbStatePMPSEnables</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="n">nActiveMotorCount</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nCurrGoal</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">bMaintMode</span><span class="o">:=</span><span class="n">stPMPSEpicsToPlc</span><span class="o">.</span><span class="n">bMaintMode</span><span class="p">,</span>
    <span class="n">eStatePMPSStatus</span><span class="o">:=</span><span class="n">eStatePMPSStatus</span><span class="p">,</span>
    <span class="n">bTransitionAuthorized</span><span class="o">:=</span><span class="n">fbMotionBPTM</span><span class="o">.</span><span class="n">bTransitionAuthorized</span><span class="p">,</span>
    <span class="n">abEnabled</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">abForwardEnabled</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">abBackwardEnabled</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">abValidGoal</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bMotorCountError</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">bEnableBeamParams</span> <span class="n">THEN</span>
    <span class="n">fbMiscStatesErrorFFO</span><span class="o">.</span><span class="n">stCurrentBeamReq</span> <span class="o">:=</span> <span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">fbMiscStatesErrorFFO</span><span class="o">.</span><span class="n">stCurrentBeamReq</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">fbMiscStatesErrorFFO</span><span class="p">(</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">nTransitionID</span><span class="o">:=</span><span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbPerMotorFFO</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="n">nActiveMotorCount</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">bMotorCountError</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stPMPSPlcToEpics</span><span class="o">.</span><span class="n">stTransitionDb</span> <span class="o">:=</span> <span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">stDbStateParams</span> <span class="o">:=</span> <span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-statepmpsstatus">E_StatePMPSStatus</a></p></li>
<li><p><a class="reference internal" href="#fb-miscstateserrorffo">FB_MiscStatesErrorFFO</a></p></li>
<li><p><a class="reference internal" href="#fb-motionbptm">FB_MotionBPTM</a></p></li>
<li><p><a class="reference internal" href="#fb-motionclearasserts">FB_MotionClearAsserts</a></p></li>
<li><p><a class="reference internal" href="#fb-motionreadpmpsdbnd">FB_MotionReadPMPSDBND</a></p></li>
<li><p><a class="reference internal" href="#fb-permotorffond">FB_PerMotorFFOND</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps2d">FB_PositionStatePMPS2D</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenablesnd">FB_StatePMPSEnablesND</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsepicstoplc">ST_StatePMPSEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsplctoepics">ST_StatePMPSPlcToEpics</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmpsnd-test">
<h2>FB_PositionStatePMPSND_Test<a class="headerlink" href="#fb-positionstatepmpsnd-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPSND_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Sanity</span> <span class="n">checks</span> <span class="k">for</span> <span class="n">the</span> <span class="n">following</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS1D</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS2D</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS3D</span>
    <span class="n">The</span> <span class="n">internals</span> <span class="n">have</span> <span class="n">already</span> <span class="n">been</span> <span class="n">tested</span><span class="p">,</span> <span class="n">but</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">that</span>
    <span class="n">they</span><span class="s1">&#39;ve been put together at least somewhat sensibly.</span>
    <span class="n">This</span> <span class="n">FB</span> <span class="n">will</span> <span class="n">simply</span> <span class="n">use</span> <span class="n">each</span> <span class="n">FB</span> <span class="n">to</span> <span class="n">move</span> <span class="ow">and</span> <span class="n">check</span> <span class="n">the</span> <span class="n">results</span><span class="o">.</span>
    <span class="n">In</span> <span class="n">addition</span> <span class="n">to</span> <span class="n">reaching</span> <span class="n">the</span> <span class="n">goals</span><span class="p">,</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">check</span> <span class="n">the</span> <span class="n">beam</span> <span class="n">assertions</span>
    <span class="ow">and</span> <span class="n">the</span> <span class="n">pmps</span> <span class="n">limit</span> <span class="n">enables</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStage3</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">afbMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="n">astBeam</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>

    <span class="n">fb_Move1D</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS1D</span><span class="p">;</span>
    <span class="n">fb_Move2D</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS2D</span><span class="p">;</span>
    <span class="n">fb_Move3D</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS3D</span><span class="p">;</span>

    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fTestStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bStatesReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">eSetPos</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
    <span class="n">eGetPos</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>

    <span class="n">fbArbiter1D</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">fbArbiter2D</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">fbArbiter3D</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

    <span class="n">fbSubSysIO1D</span><span class="p">:</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>
    <span class="n">fbSubSysIO2D</span><span class="p">:</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>
    <span class="n">fbSubSysIO3D</span><span class="p">:</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>

    <span class="n">jsonHelper</span><span class="p">:</span> <span class="n">FB_PMPSJsonTestHelper</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">0.5</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">0.5</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">0.5</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">][</span><span class="mi">3</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage1</span><span class="p">);</span>
<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage2</span><span class="p">);</span>
<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage3</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Startup</span> <span class="n">tests</span><span class="p">,</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">enabled</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">inspect</span> <span class="n">MC_Power</span><span class="s1">&#39;s output</span>
    <span class="o">//</span> <span class="n">Otherwise</span> <span class="n">we</span> <span class="n">can</span><span class="s1">&#39;t snoop on the PlcToNc control DWORD since this is all 0&#39;</span><span class="n">s</span> <span class="k">if</span> <span class="n">disabled</span>
    <span class="o">//</span> <span class="n">When</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">some</span> <span class="n">of</span> <span class="n">the</span> <span class="n">other</span> <span class="n">bits</span> <span class="n">go</span> <span class="n">to</span> <span class="mi">1</span> <span class="n">to</span> <span class="n">represent</span> <span class="n">directional</span> <span class="n">enables</span>
    <span class="n">stMotionStage1</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
    <span class="n">stMotionStage2</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
    <span class="n">stMotionStage3</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="o">//</span> <span class="n">Otherwise</span><span class="p">,</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">most</span> <span class="n">complicated</span> <span class="n">mode</span> <span class="p">(</span><span class="ow">and</span> <span class="n">the</span> <span class="n">default</span><span class="p">)</span> <span class="n">works</span>
    <span class="n">stMotionStage1</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>
    <span class="n">stMotionStage2</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>
    <span class="n">stMotionStage3</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">);</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">);</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="mi">3</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">);</span>

<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="s1">&#39;trans&#39;</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="s1">&#39;out&#39;</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="s1">&#39;target1&#39;</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mf">0.01</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="s1">&#39;target2&#39;</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Assign</span> <span class="n">beam</span> <span class="n">params</span> <span class="n">to</span> <span class="n">states</span> <span class="mi">1</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span> <span class="o">:=</span> <span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span> <span class="o">:=</span> <span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">];</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span> <span class="o">:=</span> <span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">];</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">some</span> <span class="n">names</span> <span class="k">for</span> <span class="n">maybe</span> <span class="n">help</span> <span class="ow">in</span> <span class="n">debug</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TARGET1&#39;</span><span class="p">;</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TARGET2&#39;</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TARGET1&#39;</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TARGET2&#39;</span><span class="p">;</span>
<span class="n">astPositionState3</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">astPositionState3</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TARGET1&#39;</span><span class="p">;</span>
<span class="n">astPositionState3</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TARGET2&#39;</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Load</span> <span class="n">a</span> <span class="n">fake</span> <span class="n">json</span> <span class="n">doc</span> <span class="n">to</span> <span class="n">be</span> <span class="n">consumed</span> <span class="n">by</span> <span class="n">our</span> <span class="n">FB</span>
<span class="n">jsonHelper</span><span class="p">(</span>
    <span class="n">astBeamParams</span><span class="o">:=</span><span class="n">astBeam</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">nTestCounter</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t run any tests until the states are ready</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">TestStartup1D</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">TestStartup2D</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">TestStartup3D</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">Test1D</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">);</span>
<span class="n">Test1D</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">);</span>
<span class="n">Test1D</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">);</span>
<span class="n">Test2D</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">);</span>
<span class="n">Test2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">);</span>
<span class="n">Test2D</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">);</span>
<span class="n">Test3D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">);</span>
<span class="n">Test3D</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">);</span>
<span class="n">Test3D</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">);</span>
<span class="n">TestToggleBPTM</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bStatesReady</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">AssertMotionLims</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">eState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
    <span class="n">sID</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nExpected</span><span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">F_AtPositionState</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">,</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">eState</span><span class="p">])</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Both</span> <span class="n">allowed</span>
    <span class="n">nExpected</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#111;</span>
<span class="n">ELSIF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&lt;</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Only</span> <span class="o">+</span> <span class="n">allowed</span>
    <span class="n">nExpected</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#011;</span>
<span class="n">ELSE</span>
    <span class="o">//</span> <span class="n">Only</span> <span class="o">-</span> <span class="n">allowed</span>
    <span class="n">nExpected</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#101;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">nExpected</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Wrong control dword in test &#39;</span><span class="p">,</span> <span class="n">sID</span><span class="p">),</span>
    <span class="p">);</span>
    <span class="n">AssertMotionLims</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Test1D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">eState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimAsserted</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Test1D_state&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">eState</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbSubSysIO1D</span><span class="p">(</span>
    <span class="n">LA</span><span class="o">:=</span><span class="n">fbArbiter1D</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fb_Move1D</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter1D</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInit</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">When</span> <span class="n">ready</span><span class="p">:</span> <span class="n">check</span> <span class="n">that</span> <span class="n">directonal</span> <span class="n">enables</span> <span class="n">are</span> <span class="n">correct</span>
<span class="n">bLimAsserted</span> <span class="n">S</span><span class="o">=</span> <span class="n">AssertMotionLims</span><span class="p">(</span><span class="n">stMotionStage1</span><span class="p">,</span> <span class="n">astPositionState1</span><span class="p">,</span> <span class="n">eState</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;1D mot 1 state &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>


<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">bLimAsserted</span><span class="p">,</span>
        <span class="s1">&#39;Skipped limit assert test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be True after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">eState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter1D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;Destination bp should have been in the arbiter&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move1D</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
        <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter1D</span><span class="p">,</span>
        <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bLimAsserted</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Test2D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">eState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimAsserted1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimAsserted2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Test2D_state&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">eState</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbSubSysIO2D</span><span class="p">(</span>
    <span class="n">LA</span><span class="o">:=</span><span class="n">fbArbiter2D</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fb_Move2D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter2D</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInit</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">When</span> <span class="n">ready</span><span class="p">:</span> <span class="n">check</span> <span class="n">that</span> <span class="n">directonal</span> <span class="n">enables</span> <span class="n">are</span> <span class="n">correct</span>
<span class="n">bLimAsserted1</span> <span class="n">S</span><span class="o">=</span> <span class="n">AssertMotionLims</span><span class="p">(</span><span class="n">stMotionStage1</span><span class="p">,</span> <span class="n">astPositionState1</span><span class="p">,</span> <span class="n">eState</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;2D mot 1 state &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>
<span class="n">bLimAsserted2</span> <span class="n">S</span><span class="o">=</span> <span class="n">AssertMotionLims</span><span class="p">(</span><span class="n">stMotionStage2</span><span class="p">,</span> <span class="n">astPositionState2</span><span class="p">,</span> <span class="n">eState</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;2D mot 2 state &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">bLimAsserted1</span> <span class="n">AND</span> <span class="n">bLimAsserted2</span><span class="p">,</span>
        <span class="s1">&#39;Skipped limit assert test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be True after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">eState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter2D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;Destination bp should have been in the arbiter&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move2D</span><span class="p">(</span>
        <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
        <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter2D</span><span class="p">,</span>
        <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bLimAsserted1</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bLimAsserted2</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Test3D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">eState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimAsserted1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimAsserted2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimAsserted3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Test3D_state&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">eState</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbSubSysIO3D</span><span class="p">(</span>
    <span class="n">LA</span><span class="o">:=</span><span class="n">fbArbiter3D</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fb_Move3D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">stMotionStage3</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">astPositionState3</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter3D</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInit</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">When</span> <span class="n">ready</span><span class="p">:</span> <span class="n">check</span> <span class="n">that</span> <span class="n">directonal</span> <span class="n">enables</span> <span class="n">are</span> <span class="n">correct</span>
<span class="n">bLimAsserted1</span> <span class="n">S</span><span class="o">=</span> <span class="n">AssertMotionLims</span><span class="p">(</span><span class="n">stMotionStage1</span><span class="p">,</span> <span class="n">astPositionState1</span><span class="p">,</span> <span class="n">eState</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;3D mot 1 state &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>
<span class="n">bLimAsserted2</span> <span class="n">S</span><span class="o">=</span> <span class="n">AssertMotionLims</span><span class="p">(</span><span class="n">stMotionStage2</span><span class="p">,</span> <span class="n">astPositionState2</span><span class="p">,</span> <span class="n">eState</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;3D mot 2 state &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>
<span class="n">bLimAsserted3</span> <span class="n">S</span><span class="o">=</span> <span class="n">AssertMotionLims</span><span class="p">(</span><span class="n">stMotionStage3</span><span class="p">,</span> <span class="n">astPositionState3</span><span class="p">,</span> <span class="n">eState</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;3D mot 3 state &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">bLimAsserted1</span> <span class="n">AND</span> <span class="n">bLimAsserted2</span> <span class="n">AND</span> <span class="n">bLimAsserted3</span><span class="p">,</span>
        <span class="s1">&#39;Skipped limit assert test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be True after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">eState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter3D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;Destination bp should have been in the arbiter&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move3D</span><span class="p">(</span>
        <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">stMotionStage3</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
        <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
        <span class="n">astPositionState3</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
        <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter3D</span><span class="p">,</span>
        <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bLimAsserted1</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bLimAsserted2</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bLimAsserted3</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestStartup1D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="o">-</span> <span class="n">On</span> <span class="n">startup</span><span class="p">,</span> <span class="n">there</span> <span class="n">should</span> <span class="n">be</span> <span class="n">no</span> <span class="n">move</span> <span class="n">request</span>
    <span class="o">-</span> <span class="n">In</span> <span class="n">this</span> <span class="n">case</span><span class="p">,</span> <span class="n">we</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">unknown</span> <span class="n">state</span> <span class="n">since</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">matching</span> <span class="nb">any</span> <span class="n">state</span> <span class="k">for</span> <span class="nb">any</span> <span class="n">motor</span>
    <span class="o">-</span> <span class="n">Movement</span> <span class="n">should</span> <span class="n">be</span> <span class="n">free</span> <span class="n">but</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">assertion</span> <span class="n">must</span> <span class="n">be</span> <span class="n">active</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestStartup1D&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fb_Move1D</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter1D</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInit</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">sit</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">fb</span> <span class="k">for</span> <span class="n">some</span> <span class="n">timeout</span> <span class="n">number</span> <span class="n">of</span> <span class="n">seconds</span> <span class="n">on</span> <span class="n">purpose</span><span class="p">,</span> <span class="ow">not</span> <span class="n">an</span> <span class="n">error</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">neither</span> <span class="n">be</span> <span class="n">busy</span> <span class="n">nor</span> <span class="n">done</span> <span class="p">(</span><span class="n">we</span> <span class="n">didn</span><span class="s1">&#39;t do anything)</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be False with no move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False with no move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">still</span> <span class="n">be</span> <span class="n">at</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Why did we move? motor1 should have default position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">move</span> <span class="n">both</span> <span class="n">directions</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">control</span> <span class="n">word</span> <span class="mi">7</span> <span class="p">(</span><span class="mi">2</span><span class="c1">#111)</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#111,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Expected full +/- enables&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter1D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;Transition assertion ID not in pool&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestStartup2D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="o">-</span> <span class="n">On</span> <span class="n">startup</span><span class="p">,</span> <span class="n">there</span> <span class="n">should</span> <span class="n">be</span> <span class="n">no</span> <span class="n">move</span> <span class="n">request</span>
    <span class="o">-</span> <span class="n">Starting</span> <span class="kn">from</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">all</span> <span class="n">motors</span> <span class="n">should</span> <span class="n">only</span> <span class="n">be</span> <span class="n">allowed</span> <span class="n">to</span> <span class="n">move</span> <span class="o">+</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestStartup2D&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fb_Move2D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter2D</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInit</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">sit</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">fb</span> <span class="k">for</span> <span class="n">some</span> <span class="n">timeout</span> <span class="n">number</span> <span class="n">of</span> <span class="n">seconds</span> <span class="n">on</span> <span class="n">purpose</span><span class="p">,</span> <span class="ow">not</span> <span class="n">an</span> <span class="n">error</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">neither</span> <span class="n">be</span> <span class="n">busy</span> <span class="n">nor</span> <span class="n">done</span> <span class="p">(</span><span class="n">we</span> <span class="n">didn</span><span class="s1">&#39;t do anything)</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be False with no move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False with no move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">still</span> <span class="n">be</span> <span class="n">at</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Why did we move? motor1 should have default position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Why did we move? motor2 should have default position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">move</span> <span class="n">both</span> <span class="n">directions</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">control</span> <span class="n">word</span> <span class="mi">7</span> <span class="p">(</span><span class="mi">2</span><span class="c1">#111)</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#111,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Expected full +/- enables&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#111,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Expected full +/- enables&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter2D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;Transition assertion ID not in pool&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestStartup3D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="o">-</span> <span class="n">On</span> <span class="n">startup</span><span class="p">,</span> <span class="n">there</span> <span class="n">should</span> <span class="n">be</span> <span class="n">no</span> <span class="n">move</span> <span class="n">request</span>
    <span class="o">-</span> <span class="n">Starting</span> <span class="kn">from</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">all</span> <span class="n">motors</span> <span class="n">should</span> <span class="n">only</span> <span class="n">be</span> <span class="n">allowed</span> <span class="n">to</span> <span class="n">move</span> <span class="o">+</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestStartup3D&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fb_Move3D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">stMotionStage3</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">astPositionState3</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter3D</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInit</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">sit</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">fb</span> <span class="k">for</span> <span class="n">some</span> <span class="n">timeout</span> <span class="n">number</span> <span class="n">of</span> <span class="n">seconds</span> <span class="n">on</span> <span class="n">purpose</span><span class="p">,</span> <span class="ow">not</span> <span class="n">an</span> <span class="n">error</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">neither</span> <span class="n">be</span> <span class="n">busy</span> <span class="n">nor</span> <span class="n">done</span> <span class="p">(</span><span class="n">we</span> <span class="n">didn</span><span class="s1">&#39;t do anything)</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be False with no move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False with no move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">still</span> <span class="n">be</span> <span class="n">at</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Why did we move? motor1 should have default position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Why did we move? motor2 should have default position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Why did we move? motor3 should have default position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">move</span> <span class="n">both</span> <span class="n">directions</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">control</span> <span class="n">word</span> <span class="mi">7</span> <span class="p">(</span><span class="mi">2</span><span class="c1">#111)</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#111,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Expected full +/- enables&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#111,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Expected full +/- enables&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#111,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Expected full +/- enables&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter3D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;Transition assertion ID not in pool&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestToggleBPTM</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestToggleBPTM&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbSubSysIO1D</span><span class="p">(</span>
    <span class="n">LA</span><span class="o">:=</span><span class="n">fbArbiter1D</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">nState</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">eSetPos</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>

<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>
        <span class="n">fb_Move1D</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
            <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
            <span class="n">eEnumSet</span><span class="o">:=</span> <span class="n">eSetPos</span><span class="p">,</span>
            <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
            <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
            <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter1D</span><span class="p">,</span>
            <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">IF</span> <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
            <span class="n">AssertTrue</span><span class="p">(</span>
                <span class="n">fbArbiter1D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
                <span class="s1">&#39;Destination bp should have been in the arbiter1&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="mi">1</span><span class="p">:</span>
        <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPMPSEpicsToPlc</span><span class="o">.</span><span class="n">bArbiterEnabled</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">fb_Move1D</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
            <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
            <span class="n">eEnumSet</span><span class="o">:=</span> <span class="n">eSetPos</span><span class="p">,</span>
            <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
            <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
            <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter1D</span><span class="p">,</span>
            <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
            <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">IF</span> <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
            <span class="n">AssertFalse</span><span class="p">(</span>
                <span class="n">fbArbiter1D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
                <span class="s1">&#39;Destination bp should not have been in the arbiter2&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="mi">2</span><span class="p">:</span>
        <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPMPSEpicsToPlc</span><span class="o">.</span><span class="n">bArbiterEnabled</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">fb_Move1D</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
            <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
            <span class="n">eEnumSet</span><span class="o">:=</span> <span class="n">eSetPos</span><span class="p">,</span>
            <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
            <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
            <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter1D</span><span class="p">,</span>
            <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
            <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">IF</span> <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">fbPMPSCore</span><span class="o">.</span><span class="n">fbMotionBPTM</span><span class="o">.</span><span class="n">bptm</span><span class="o">.</span><span class="n">eBPTMState</span> <span class="o">=</span> <span class="n">E_BPTMState</span><span class="o">.</span><span class="n">WaitForBP</span> <span class="n">THEN</span>
            <span class="n">AssertTrue</span><span class="p">(</span>
                <span class="n">fbArbiter1D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
                <span class="s1">&#39;Destination bp should have been in the arbiter3&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="mi">3</span><span class="p">:</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
            <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_CASE</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#e-teststates">E_TestStates</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-pmpsjsontesthelper">FB_PMPSJsonTestHelper</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps2d">FB_PositionStatePMPS2D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps3d">FB_PositionStatePMPS3D</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateread">
<h2>FB_PositionStateRead<a class="headerlink" href="#fb-positionstateread" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateRead</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">tells</span> <span class="n">us</span> <span class="n">what</span> <span class="n">state</span> <span class="n">a</span> <span class="n">single</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">at</span><span class="o">.</span>
    <span class="n">In</span> <span class="n">the</span> <span class="n">case</span> <span class="n">of</span> <span class="n">multiple</span> <span class="n">valid</span> <span class="n">overlapping</span> <span class="n">states</span><span class="p">,</span> <span class="n">one</span> <span class="n">will</span> <span class="n">be</span> <span class="n">picked</span> <span class="n">arbitrarily</span><span class="p">,</span>
    <span class="n">but</span> <span class="n">we</span> <span class="n">can</span> <span class="n">see</span> <span class="n">a</span> <span class="n">full</span> <span class="n">description</span> <span class="n">of</span> <span class="n">which</span> <span class="n">overlapping</span> <span class="n">states</span> <span class="n">are</span> <span class="n">present</span> <span class="n">using</span> <span class="n">the</span> <span class="n">abAtPosition</span> <span class="n">array</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">will</span> <span class="n">only</span> <span class="n">run</span> <span class="n">properly</span> <span class="k">if</span> <span class="n">FB_PositionStateInternal</span> <span class="n">has</span> <span class="n">been</span> <span class="n">called</span> <span class="n">on</span> <span class="n">each</span> <span class="n">position</span> <span class="n">state</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">it</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">check</span> <span class="n">the</span> <span class="n">state</span> <span class="n">of</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">allowed</span> <span class="n">states</span> <span class="k">for</span> <span class="n">this</span> <span class="n">motor</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re standing still at a known state, or moving within the bounds of a state to another location in the bounds.</span>
    <span class="n">bKnownState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re moving to some other state or to another non-state position.</span>
    <span class="n">bMovingState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;re at a known state, this will be the index in the astPositionState array that matches the state. Otherwise, this will be 0, which is below the bounds of the array, so it cannot be confused with a valid output.</span>
    <span class="n">nPositionIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">copy</span> <span class="n">of</span> <span class="n">the</span> <span class="n">details</span> <span class="n">of</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="p">,</span> <span class="k">for</span> <span class="n">convenience</span><span class="o">.</span> <span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="n">moving</span> <span class="n">state</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">unknown</span> <span class="n">state</span> <span class="k">as</span> <span class="n">a</span> <span class="n">placeholder</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">known</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stCurrentPosition</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">full</span> <span class="n">description</span> <span class="n">of</span> <span class="n">whether</span> <span class="n">we</span><span class="s1">&#39;re at each of our states. This is used in 2D, 3D, etc. to clarify cases where states may overlap in 1D.</span>
    <span class="n">abAtPosition</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">bMovingState</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
        <span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">nMaxStates</span> <span class="o">:=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">nMaxStates</span><span class="p">,</span> <span class="n">nIter</span><span class="p">);</span>
    <span class="n">END_IF</span>
    <span class="n">IF</span> <span class="n">F_AtPositionState</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span> <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">])</span> <span class="n">THEN</span>
        <span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">nPositionIndex</span> <span class="o">:=</span> <span class="n">nIter</span><span class="p">;</span>
        <span class="n">stCurrentPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">];</span>
        <span class="n">abAtPosition</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">abAtPosition</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bKnownState</span> <span class="n">THEN</span>
    <span class="n">nPositionIndex</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">bMovingState</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">bMovingState</span> <span class="n">THEN</span>
        <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Moving&#39;</span><span class="p">;</span>
        <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
        <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateread-test">
<h2>FB_PositionStateRead_Test<a class="headerlink" href="#fb-positionstateread-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateRead_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">that</span> <span class="n">FB_PositionStateRead</span> <span class="n">works</span> <span class="n">exactly</span> <span class="n">how</span> <span class="n">it</span> <span class="n">should</span>
    <span class="n">according</span> <span class="n">to</span> <span class="n">its</span> <span class="n">API</span> <span class="n">during</span> <span class="n">normal</span> <span class="ow">and</span> <span class="n">failure</span> <span class="n">states</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">stDummyPos</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbTestMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_PositionStateRead</span><span class="p">;</span>

    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fTestStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bStatesReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;UNO&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;DOS&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TRES&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;QUATRO&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">4</span> <span class="n">DO</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">At</span> <span class="n">position</span> <span class="mi">1</span> <span class="n">check</span>
<span class="n">TestStaticPosition</span><span class="p">(</span>
    <span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">sTestName</span><span class="o">:=</span><span class="s1">&#39;AtPos1&#39;</span><span class="p">,</span>
    <span class="n">fPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">Outside</span> <span class="n">the</span> <span class="n">deltas</span> <span class="n">check</span>
<span class="n">TestStaticPosition</span><span class="p">(</span>
    <span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sTestName</span><span class="o">:=</span><span class="s1">&#39;OutsidePos1Delta&#39;</span><span class="p">,</span>
    <span class="n">fPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">At</span> <span class="n">invalid</span> <span class="n">state</span> <span class="mi">2</span> <span class="n">check</span>
<span class="n">TestStaticPosition</span><span class="p">(</span>
    <span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">sTestName</span><span class="o">:=</span><span class="s1">&#39;AtInvalidPos&#39;</span><span class="p">,</span>
    <span class="n">fPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">At</span> <span class="n">position</span> <span class="mi">3</span> <span class="n">check</span>
<span class="n">TestStaticPosition</span><span class="p">(</span>
    <span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">sTestName</span><span class="o">:=</span><span class="s1">&#39;AtPos3&#39;</span><span class="p">,</span>
    <span class="n">fPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">At</span> <span class="n">position</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">moving</span> <span class="n">within</span> <span class="n">bounds</span> <span class="n">check</span>
<span class="n">TestMovingPosition</span><span class="p">(</span>
    <span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">sTestName</span><span class="o">:=</span><span class="s1">&#39;MovingAt3&#39;</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">At</span> <span class="n">position</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">moving</span> <span class="n">away</span> <span class="n">check</span>
<span class="n">TestMovingPosition</span><span class="p">(</span>
    <span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">sTestName</span><span class="o">:=</span><span class="s1">&#39;MovingFrom3&#39;</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TestDupe</span><span class="p">(</span><span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">6</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fbTestMove</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">Asserts</span>
<span class="n">VAR_INPUT</span>
    <span class="n">tTimeout</span><span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
    <span class="n">bKnownState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMovingState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nPositionIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">abExpected</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionstate</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">tTimeout</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Test timed out&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">bKnownState</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">bKnownState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Incorrect bKnownState&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">bMovingState</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">bMovingState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Incorrect bMovingState&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_DINT</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">nPositionIndex</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">nPositionIndex</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Incorrect nPositionIndex&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">nPositionIndex</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">nPositionIndex</span> <span class="o">&lt;=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">THEN</span>
        <span class="n">abExpected</span><span class="p">[</span><span class="n">nPositionIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
 <span class="n">END_IF</span>
<span class="n">AssertArrayEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expecteds</span><span class="o">:=</span><span class="n">abExpected</span><span class="p">,</span>
    <span class="n">Actuals</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">abAtPosition</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Wrong at position array&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">bKnownState</span> <span class="n">THEN</span>
    <span class="n">AssertEquals_STRING</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">sName</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">sName</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not provide correct current position struct&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestDupe</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">abExpected</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestDupe&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestIndex</span> <span class="o">&lt;&gt;</span> <span class="n">nTestCounter</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">In</span> <span class="n">this</span> <span class="n">test</span><span class="p">,</span> <span class="ow">and</span> <span class="n">only</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">test</span><span class="p">,</span> <span class="n">we</span> <span class="n">must</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">state</span> <span class="mi">4</span> <span class="ow">is</span> <span class="n">valid</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">abExpected</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">abExpected</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (fbTestMove.bSetDone AND bStatesReady) THEN</span>
    <span class="n">fbRead</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionstate</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_BOOL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Test timed out&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_BOOL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">bKnownState</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Incorrect bKnownState&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertArrayEquals_BOOL</span><span class="p">(</span>
        <span class="n">Expecteds</span><span class="o">:=</span><span class="n">abExpected</span><span class="p">,</span>
        <span class="n">Actuals</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">abAtPosition</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Wrong at position array&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestMovingPosition</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">sTestName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fStartPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fGoalPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bKnownState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMovingState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nPositionIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">sTestName</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestIndex</span> <span class="o">&lt;&gt;</span> <span class="n">nTestCounter</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fStartPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fGoalPosition</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s OR (fbTestMove.bMotionStarted AND bStatesReady) THEN</span>
    <span class="n">Asserts</span><span class="p">(</span>
        <span class="n">tTimeout</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
        <span class="n">bKnownState</span><span class="o">:=</span><span class="n">bKnownState</span><span class="p">,</span>
        <span class="n">bMovingState</span><span class="o">:=</span><span class="n">bMovingState</span><span class="p">,</span>
        <span class="n">nPositionIndex</span><span class="o">:=</span><span class="n">nPositionIndex</span><span class="p">,</span>
        <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">stCurrentPosition</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestStaticPosition</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">sTestName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bKnownState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMovingState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nPositionIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">sTestName</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestIndex</span> <span class="o">&lt;&gt;</span> <span class="n">nTestCounter</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (fbTestMove.bSetDone AND bStatesReady) THEN</span>
    <span class="n">Asserts</span><span class="p">(</span>
        <span class="n">tTimeout</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">bKnownState</span><span class="o">:=</span><span class="n">bKnownState</span><span class="p">,</span>
        <span class="n">bMovingState</span><span class="o">:=</span><span class="n">bMovingState</span><span class="p">,</span>
        <span class="n">nPositionIndex</span><span class="o">:=</span><span class="n">nPositionIndex</span><span class="p">,</span>
        <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">stCurrentPosition</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateread">FB_PositionStateRead</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove">FB_TestHelperSetAndMove</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatereadnd">
<h2>FB_PositionStateReadND<a class="headerlink" href="#fb-positionstatereadnd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateReadND</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">get</span> <span class="n">the</span> <span class="n">combined</span> <span class="n">N</span><span class="o">-</span><span class="n">dimensional</span> <span class="n">state</span> <span class="n">of</span> <span class="n">a</span> <span class="n">group</span> <span class="n">of</span> <span class="n">motors</span><span class="o">.</span>
    <span class="n">It</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">building</span> <span class="n">block</span> <span class="ow">not</span> <span class="n">meant</span> <span class="k">for</span> <span class="n">use</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">lcls</span><span class="o">-</span><span class="n">twintcat</span><span class="o">-</span><span class="n">motion</span><span class="o">.</span>

    <span class="n">Use</span> <span class="n">FB_PositionStateRead1D</span><span class="p">,</span> <span class="n">FB_PositionStateRead2D</span><span class="p">,</span> <span class="o">...</span> <span class="n">etc</span><span class="o">.</span> <span class="n">instead</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motors</span> <span class="k">with</span> <span class="n">a</span> <span class="n">combined</span> <span class="n">N</span><span class="o">-</span><span class="n">dimensional</span> <span class="n">state</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Each</span> <span class="n">motor</span><span class="s1">&#39;s respective position states along its direction</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">we</span><span class="s1">&#39;re actually using</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re standing still at a known state.</span>
    <span class="n">bKnownState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re moving, there can be no valid state if we are moving.</span>
    <span class="n">bMovingState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;re at a known state, this will be the state index along the enclosed states arrays. Otherwise, it will be zero, which is below the bounds of the states array.</span>
    <span class="n">nPositionIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">active</span> <span class="n">motor</span> <span class="n">count</span> <span class="n">was</span> <span class="n">invalid</span>
    <span class="n">bMotorCountError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">full</span> <span class="n">description</span> <span class="n">of</span> <span class="n">whether</span> <span class="n">we</span><span class="s1">&#39;re at each of our states. This is used to clarify cases where states may overlap.</span>
    <span class="n">abAtPosition</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">individual</span> <span class="n">position</span> <span class="n">state</span> <span class="n">reader</span> <span class="n">function</span> <span class="n">blocks</span>
    <span class="n">afbPositionStateRead</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateRead</span><span class="p">;</span>

    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nIter2</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CheckCount</span><span class="p">();</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMotorCountError</span> <span class="n">THEN</span>
    <span class="n">DoStateReads</span><span class="p">();</span>
    <span class="n">CombineOutputs</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">CheckCount</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">valid</span> <span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">,</span> <span class="n">less</span> <span class="ow">or</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">max</span><span class="p">)</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&gt;</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">CombineOutputs</span><span class="p">:</span>
<span class="o">//</span> <span class="n">bKnownState</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ALL</span> <span class="n">motors</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">known</span> <span class="n">state</span>
<span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">bKnownState</span> <span class="n">AND</span> <span class="n">afbPositionStateRead</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bKnownState</span><span class="p">;</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">bMovingState</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ANY</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">moving</span>
<span class="n">bMovingState</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bMovingState</span> <span class="o">:=</span> <span class="n">bMovingState</span> <span class="n">OR</span> <span class="n">afbPositionStateRead</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bMovingState</span><span class="p">;</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">To</span> <span class="n">account</span> <span class="k">for</span> <span class="n">redundant</span> <span class="mi">1</span><span class="n">D</span> <span class="n">states</span><span class="p">,</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">check</span> <span class="n">the</span> <span class="n">full</span> <span class="n">output</span> <span class="n">arrays</span><span class="o">.</span>
<span class="n">nPositionIndex</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">abAtPosition</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">FOR</span> <span class="n">nIter2</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
        <span class="n">abAtPosition</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">afbPositionStateRead</span><span class="p">[</span><span class="n">nIter2</span><span class="p">]</span><span class="o">.</span><span class="n">abAtPosition</span><span class="p">[</span><span class="n">nIter</span><span class="p">];</span>
    <span class="n">END_FOR</span>
    <span class="n">IF</span> <span class="n">abAtPosition</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="n">THEN</span>
        <span class="n">nPositionIndex</span> <span class="o">:=</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">Position</span> <span class="n">index</span> <span class="mi">0</span> <span class="n">means</span> <span class="n">different</span> <span class="n">positions</span>
<span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">bKnownState</span> <span class="n">AND</span> <span class="n">nPositionIndex</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">DoStateReads</span><span class="p">:</span>
<span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">nMaxStateMotorCount</span> <span class="o">:=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">nMaxStateMotorCount</span><span class="p">,</span> <span class="n">nActiveMotorCount</span><span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">afbPositionStateRead</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstateread">FB_PositionStateRead</a></p></li>
<li><p><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatereadnd-test">
<h2>FB_PositionStateReadND_Test<a class="headerlink" href="#fb-positionstatereadnd-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateReadND_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">that</span> <span class="n">FB_PositionStateReadND</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">read</span> <span class="ow">and</span> <span class="n">summarize</span>
    <span class="n">N</span><span class="o">-</span><span class="n">dimensional</span> <span class="n">state</span> <span class="n">positions</span> <span class="n">where</span> <span class="n">multiple</span> <span class="n">motors</span> <span class="n">must</span> <span class="n">move</span> <span class="ow">in</span>
    <span class="n">sync</span> <span class="n">to</span> <span class="n">a</span> <span class="n">shared</span> <span class="n">named</span> <span class="n">state</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">afbMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>

    <span class="n">afbTestMove</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_PositionStateReadND</span><span class="p">;</span>
    <span class="n">bOneAssertDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nAssertCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nIter1</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nIter2</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nIter3</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="n">fbMisRead</span><span class="p">:</span> <span class="n">FB_PositionStateReadND</span><span class="p">;</span>
    <span class="n">astGoodStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astGoodStateShape</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>

    <span class="n">astSqMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">afbSqMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">astSquareStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbSqInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..4</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>

    <span class="n">afbSqTestMove</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>
    <span class="n">fbSqRead</span><span class="p">:</span> <span class="n">FB_PositionStateReadND</span><span class="p">;</span>
    <span class="n">bSqAssertDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nSqAssertCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">NO_STATE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">OUT_STATE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">IN_STATE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">IN_TWEAK</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">AWAY</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">LAST_TEST</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="n">AWAY</span><span class="p">;</span>
    <span class="n">TEST_COUNT</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">PerMotor</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">PerMotor</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">PerMotor</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">SquareSetup</span><span class="p">();</span>

<span class="o">//</span> <span class="n">First</span> <span class="n">check</span> <span class="n">the</span> <span class="n">case</span> <span class="n">of</span> <span class="n">mismatched</span> <span class="n">arrays</span>
<span class="n">TestForgot</span><span class="p">();</span>
<span class="n">TestCombos</span><span class="p">(</span><span class="n">nAssertCounter</span><span class="p">);</span>
<span class="n">TestSquare</span><span class="p">(</span><span class="n">nSqAssertCounter</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneAssertDone</span> <span class="n">THEN</span>
    <span class="n">afbTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">afbTestMove</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">afbTestMove</span><span class="p">[</span><span class="mi">3</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">IF</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bResetDone</span> <span class="n">AND</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bResetDone</span> <span class="n">AND</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bResetDone</span> <span class="n">THEN</span>
        <span class="n">bOneAssertDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nAssertCounter</span> <span class="o">:=</span> <span class="n">nAssertCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bSqAssertDone</span> <span class="n">THEN</span>
    <span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">IF</span> <span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bResetDone</span> <span class="n">AND</span> <span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bResetDone</span> <span class="n">THEN</span>
        <span class="n">bSqAssertDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nSqAssertCounter</span> <span class="o">:=</span> <span class="n">nSqAssertCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">DoAssert</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nMotorCase1</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nMotorCase2</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nMotorCase3</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bReady1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReady2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReady3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bKnownState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMovingState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nPositionIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">sTestCase</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">sTestCase</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nMotorCase1</span><span class="p">),</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nMotorCase2</span><span class="p">)),</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nMotorCase3</span><span class="p">));</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">bReady1</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Timeout for motor 1 during test case &#39;</span><span class="p">,</span> <span class="n">sTestCase</span><span class="p">),</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">bReady2</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Timeout for motor 2 during test case &#39;</span><span class="p">,</span> <span class="n">sTestCase</span><span class="p">),</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">bReady3</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Timeout for motor 3 during test case &#39;</span><span class="p">,</span> <span class="n">sTestCase</span><span class="p">),</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">All</span> <span class="n">at</span> <span class="n">OUT</span> <span class="ow">or</span> <span class="nb">all</span> <span class="n">at</span> <span class="n">IN</span> <span class="n">should</span> <span class="n">be</span> <span class="n">OUT</span> <span class="ow">and</span> <span class="n">IN</span> <span class="n">respectively</span><span class="p">,</span> <span class="n">even</span> <span class="k">if</span> <span class="n">doing</span> <span class="n">a</span> <span class="n">tweak</span> <span class="n">move</span>
<span class="o">//</span> <span class="n">Any</span> <span class="n">other</span> <span class="n">combination</span> <span class="ow">is</span> <span class="n">at</span> <span class="n">no</span> <span class="n">state</span>
<span class="n">IF</span> <span class="n">nMotorCase1</span> <span class="o">=</span> <span class="n">OUT_STATE</span> <span class="n">AND</span> <span class="n">nMotorCase2</span> <span class="o">=</span> <span class="n">OUT_STATE</span> <span class="n">AND</span> <span class="n">nMotorCase3</span> <span class="o">=</span> <span class="n">OUT_STATE</span> <span class="n">THEN</span>
    <span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nPositionIndex</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="p">(</span><span class="n">nMotorCase1</span> <span class="o">=</span> <span class="n">IN_STATE</span> <span class="n">OR</span> <span class="n">nMotorCase1</span> <span class="o">=</span> <span class="n">IN_TWEAK</span><span class="p">)</span> <span class="n">AND</span>
      <span class="p">(</span><span class="n">nMotorCase2</span> <span class="o">=</span> <span class="n">IN_STATE</span> <span class="n">OR</span> <span class="n">nMotorCase2</span> <span class="o">=</span> <span class="n">IN_TWEAK</span><span class="p">)</span> <span class="n">AND</span>
      <span class="p">(</span><span class="n">nMotorCase3</span> <span class="o">=</span> <span class="n">IN_STATE</span> <span class="n">OR</span> <span class="n">nMotorCase3</span> <span class="o">=</span> <span class="n">IN_TWEAK</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nPositionIndex</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">In</span> <span class="n">addition</span><span class="p">,</span> <span class="n">bMovingState</span> <span class="n">must</span> <span class="n">be</span> <span class="nb">set</span> <span class="k">if</span> <span class="nb">any</span> <span class="ow">is</span> <span class="n">moving</span> <span class="n">away</span> <span class="kn">from</span><span class="w"> </span><span class="nn">a</span> <span class="n">state</span>
<span class="n">IF</span> <span class="n">nMotorCase1</span> <span class="o">=</span> <span class="n">AWAY</span> <span class="n">OR</span> <span class="n">nMotorCase2</span> <span class="o">=</span> <span class="n">AWAY</span> <span class="n">OR</span> <span class="n">nMotorCase3</span> <span class="o">=</span> <span class="n">AWAY</span> <span class="n">THEN</span>
    <span class="n">bMovingState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">AssertEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">bKnownState</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">bKnownState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Wrong bKnownState for test case &#39;</span><span class="p">,</span> <span class="n">sTestCase</span><span class="p">),</span>
<span class="p">);</span>
<span class="n">AssertEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">bMovingState</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">bMovingState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Wrong bMovingState for test case &#39;</span><span class="p">,</span> <span class="n">sTestCase</span><span class="p">),</span>
<span class="p">);</span>
<span class="n">AssertEquals_DINT</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">nPositionIndex</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">nPositionIndex</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Wrong nPositionIndex for test case &#39;</span><span class="p">,</span> <span class="n">sTestCase</span><span class="p">),</span>
<span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">DoMove</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nMotorIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nMotorCase</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fStartPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fGoalPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CASE</span> <span class="n">nMotorCase</span> <span class="n">OF</span>
    <span class="o">//</span> <span class="n">Somewhere</span> <span class="n">smaller</span> <span class="n">than</span> <span class="n">OUT</span><span class="p">,</span> <span class="n">static</span>
    <span class="n">NO_STATE</span><span class="p">:</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
        <span class="n">fGoalPosition</span> <span class="o">:=</span> <span class="n">fStartPosition</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Exactly</span> <span class="n">at</span> <span class="n">OUT</span><span class="p">,</span> <span class="n">static</span>
    <span class="n">OUT_STATE</span><span class="p">:</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">fGoalPosition</span> <span class="o">:=</span> <span class="n">fStartPosition</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Exactly</span> <span class="n">at</span> <span class="n">IN</span><span class="p">,</span> <span class="n">static</span>
    <span class="n">IN_STATE</span><span class="p">:</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">fGoalPosition</span> <span class="o">:=</span> <span class="n">fStartPosition</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">at</span> <span class="n">IN</span><span class="p">,</span> <span class="n">do</span> <span class="n">a</span> <span class="n">small</span> <span class="n">tweak</span>
    <span class="n">IN_TWEAK</span><span class="p">:</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">fGoalPosition</span> <span class="o">:=</span> <span class="n">fStartPosition</span> <span class="o">+</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">at</span> <span class="n">IN</span><span class="p">,</span> <span class="n">move</span> <span class="n">positive</span> <span class="n">a</span> <span class="n">lot</span>
    <span class="n">AWAY</span><span class="p">:</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">fGoalPosition</span> <span class="o">:=</span> <span class="n">fStartPosition</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">],</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fStartPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fGoalPosition</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">CASE</span> <span class="n">nMotorCase</span> <span class="n">OF</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">static</span> <span class="n">states</span><span class="p">:</span> <span class="n">report</span> <span class="n">ready</span> <span class="n">when</span> <span class="nb">set</span> <span class="ow">is</span> <span class="n">done</span>
    <span class="n">NO_STATE</span><span class="p">:</span>
        <span class="n">DoMove</span> <span class="o">:=</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bSetDone</span><span class="p">;</span>
    <span class="n">OUT_STATE</span><span class="p">:</span>
        <span class="n">DoMove</span> <span class="o">:=</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bSetDone</span><span class="p">;</span>
    <span class="n">IN_STATE</span><span class="p">:</span>
        <span class="n">DoMove</span> <span class="o">:=</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bSetDone</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">moving</span> <span class="n">states</span><span class="p">:</span> <span class="n">report</span> <span class="n">ready</span> <span class="n">when</span> <span class="n">move</span> <span class="n">starts</span>
    <span class="n">IN_TWEAK</span><span class="p">:</span>
        <span class="n">DoMove</span> <span class="o">:=</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bMotionStarted</span><span class="p">;</span>
    <span class="n">AWAY</span><span class="p">:</span>
        <span class="n">DoMove</span> <span class="o">:=</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bMotionStarted</span><span class="p">;</span>
<span class="n">END_CASE</span>
<span class="o">//</span> <span class="n">Universal</span> <span class="mi">5</span><span class="n">s</span> <span class="n">timeout</span>
<span class="n">DoMove</span> <span class="n">S</span><span class="o">=</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">]</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">DoRead</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">PerMotor</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">nIndex</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">afbInternal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">nIndex</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
<span class="n">afbInternal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
<span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">SquareSetup</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="mi">2</span> <span class="n">motors</span><span class="p">,</span> <span class="mi">4</span> <span class="n">positions</span> <span class="n">per</span> <span class="n">motor</span><span class="p">,</span> <span class="n">square</span> <span class="n">geometry</span>
<span class="o">//</span> <span class="n">Motor</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">X</span><span class="p">,</span> <span class="n">motor</span> <span class="mi">2</span> <span class="ow">is</span> <span class="n">Y</span>
<span class="o">//</span> <span class="n">Corners</span> <span class="n">at</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="o">//</span> <span class="n">So</span> <span class="n">motor</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">either</span> <span class="n">LEFT</span><span class="o">=</span><span class="mi">10</span> <span class="ow">or</span> <span class="n">RIGHT</span><span class="o">=</span><span class="mi">20</span>
<span class="o">//</span> <span class="n">motor</span> <span class="mi">2</span> <span class="ow">is</span> <span class="n">either</span> <span class="n">BOT</span><span class="o">=</span><span class="mi">10</span> <span class="ow">or</span> <span class="n">TOP</span><span class="o">=</span><span class="mi">20</span>

<span class="n">afbSqMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astSqMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">afbSqMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astSqMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Top Left&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Top Right&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Bot Left&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Bot Right&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Top Left&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Top Right&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Bot Left&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Bot Right&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span>
<span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestCombos</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nAssertID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nMotor1Case</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nMotor2Case</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nMotor3Case</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bReady1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReady2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReady3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">tonTimeout</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">one</span> <span class="n">big</span> <span class="n">test</span> <span class="n">case</span> <span class="k">with</span> <span class="mi">125</span> <span class="n">asserts</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAllCombos&#39;</span><span class="p">);</span>

<span class="n">nMotor1Case</span> <span class="o">:=</span> <span class="n">nAssertID</span> <span class="n">MOD</span> <span class="n">TEST_COUNT</span><span class="p">;</span>
<span class="n">nMotor2Case</span> <span class="o">:=</span> <span class="n">LREAL_TO_UINT</span><span class="p">(</span><span class="n">FLOOR</span><span class="p">(</span><span class="n">nAssertID</span> <span class="o">/</span> <span class="n">TEST_COUNT</span><span class="p">))</span> <span class="n">MOD</span> <span class="n">TEST_COUNT</span><span class="p">;</span>
<span class="n">nMotor3Case</span> <span class="o">:=</span> <span class="n">LREAL_TO_UINT</span><span class="p">(</span><span class="n">FLOOR</span><span class="p">(</span><span class="n">nAssertID</span> <span class="o">/</span> <span class="n">TEST_COUNT</span> <span class="o">/</span> <span class="n">TEST_COUNT</span><span class="p">))</span> <span class="n">MOD</span> <span class="n">TEST_COUNT</span><span class="p">;</span>

<span class="n">bReady1</span> <span class="o">:=</span> <span class="n">DoMove</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nMotor1Case</span><span class="p">);</span>
<span class="n">bReady2</span> <span class="o">:=</span> <span class="n">DoMove</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">nMotor2Case</span><span class="p">);</span>
<span class="n">bReady3</span> <span class="o">:=</span> <span class="n">DoMove</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">nMotor3Case</span><span class="p">);</span>

<span class="o">//</span> <span class="n">There</span> <span class="ow">is</span> <span class="n">a</span> <span class="mi">5</span><span class="n">s</span> <span class="n">timeout</span> <span class="n">at</span> <span class="n">a</span> <span class="n">lower</span> <span class="n">level</span><span class="p">,</span> <span class="n">but</span> <span class="n">that</span> <span class="n">timeout</span> <span class="n">could</span> <span class="n">fail</span>
<span class="n">tonTimeout</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#7s,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bReady1</span> <span class="n">AND</span> <span class="n">bReady2</span> <span class="n">AND</span> <span class="n">bReady3</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">DoRead</span><span class="p">();</span>
    <span class="n">DoAssert</span><span class="p">(</span><span class="n">nMotor1Case</span><span class="p">,</span> <span class="n">nMotor2Case</span><span class="p">,</span> <span class="n">nMotor3Case</span><span class="p">,</span> <span class="n">bReady1</span><span class="p">,</span> <span class="n">bReady2</span><span class="p">,</span> <span class="n">bReady3</span><span class="p">);</span>
    <span class="n">bOneAssertDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">final</span> <span class="k">assert</span> <span class="n">case</span> <span class="n">marks</span> <span class="n">test</span> <span class="k">as</span> <span class="n">finished</span>
    <span class="n">IF</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">nMotor1Case</span> <span class="o">=</span> <span class="n">LAST_TEST</span> <span class="n">AND</span> <span class="n">nMotor2Case</span> <span class="o">=</span> <span class="n">LAST_TEST</span> <span class="n">AND</span> <span class="n">nMotor3Case</span> <span class="o">=</span> <span class="n">LAST_TEST</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="o">//</span> <span class="mi">11</span> <span class="n">extra</span> <span class="n">tests</span>
        <span class="o">//</span> <span class="mi">1</span> <span class="kn">from</span><span class="w"> </span><span class="nn">TestForgot</span>
        <span class="o">//</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">TestSquare</span>
        <span class="n">AssertEquals_UINT</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">6</span> <span class="o">*</span> <span class="n">TEST_COUNT</span> <span class="o">*</span> <span class="n">TEST_COUNT</span> <span class="o">*</span> <span class="n">TEST_COUNT</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">AssertResults</span><span class="o">.</span><span class="n">TotalAsserts</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Some of the asserts were not run&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
            <span class="s1">&#39;Level 2 timeout in test&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">TEST_FINISHED</span><span class="p">();</span>
    <span class="n">END_IF</span>
    <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestForgot</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;ForgotCount&#39;</span><span class="p">);</span>

<span class="n">fbMisRead</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astGoodStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astGoodStateShape</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">fbMisRead</span><span class="o">.</span><span class="n">bMotorCountError</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Failed to notice missing count&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestSquare</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nAssertID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fMotor1Pos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nGoal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">tonTimeout</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">We</span><span class="s1">&#39;ll do 5 tests, one at each square point and one more in the middle</span>
<span class="n">Test</span><span class="p">(</span><span class="s1">&#39;TestSquare&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nAssertID</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">nAssertID</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">fMotor1Pos</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">nGoal</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">nAssertID</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">THEN</span>
    <span class="n">fMotor1Pos</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">nGoal</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">nAssertID</span> <span class="o">=</span> <span class="mi">2</span> <span class="n">THEN</span>
    <span class="n">fMotor1Pos</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="n">nGoal</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">nAssertID</span> <span class="o">=</span> <span class="mi">3</span> <span class="n">THEN</span>
    <span class="n">fMotor1Pos</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="n">nGoal</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">nAssertID</span> <span class="o">=</span> <span class="mi">4</span> <span class="n">THEN</span>
    <span class="n">fMotor1Pos</span> <span class="o">:=</span> <span class="mi">15</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span> <span class="o">:=</span> <span class="mi">15</span><span class="p">;</span>
    <span class="n">nGoal</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astSqMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fMotor1Pos</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fMotor1Pos</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astSqMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fMotor2Pos</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fMotor2Pos</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">tonTimeout</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">AND</span> <span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">fbSqRead</span><span class="p">(</span>
        <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astSqMotionStage</span><span class="p">,</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">,</span>
        <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Timeout in square test &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nAssertID</span><span class="p">)),</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">nGoal</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbSqRead</span><span class="o">.</span><span class="n">nPositionIndex</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Wrong read in square test &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nAssertID</span><span class="p">)),</span>
    <span class="p">);</span>

    <span class="n">bSqAssertDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">nAssertID</span> <span class="o">=</span> <span class="mi">4</span> <span class="n">THEN</span>
        <span class="n">TEST_FINISHED</span><span class="p">();</span>
    <span class="n">END_IF</span>
    <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatereadnd">FB_PositionStateReadND</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove">FB_TestHelperSetAndMove</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-powerenablemode-test">
<h2>FB_PowerEnableMode_Test<a class="headerlink" href="#fb-powerenablemode-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PowerEnableMode_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">that</span> <span class="n">FB_MotionStage</span> <span class="n">drive</span> <span class="n">power</span> <span class="n">enable</span> <span class="n">mode</span> <span class="n">bug</span> <span class="ow">is</span> <span class="n">fixed</span>
    <span class="n">switching</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ALWAYS</span> <span class="n">to</span> <span class="n">DURING_MOTION</span> <span class="n">mode</span><span class="o">.</span> <span class="n">the</span> <span class="n">mode</span> <span class="n">switch</span> <span class="n">should</span> <span class="n">first</span> <span class="n">disable</span> <span class="n">power</span>
    <span class="n">then</span> <span class="n">reanable</span> <span class="n">power</span> <span class="n">to</span> <span class="n">the</span> <span class="n">drive</span> <span class="k">with</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">absolution</span> <span class="n">move</span> <span class="n">cmd</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">fbMotorTestSuite</span>        <span class="p">:</span> <span class="n">FB_MotorTestSuite</span><span class="p">;</span>
    <span class="n">stMotionStage</span>           <span class="p">:</span> <span class="n">ST_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;SIM:PEM&#39;</span><span class="p">);</span>
    <span class="n">fbMotionStage</span>           <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbSetPos</span>            <span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">TestModeEnableSwitchAndAbsoluteMove</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestModeEnableSwitchAndAbsoluteMove</span>
<span class="n">VAR_INST</span>

<span class="n">tonModeTimer</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">tonTestTimer</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">bCompleted</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">fActualPosition</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">fExpectedPosition</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">10.0</span><span class="p">;</span>

<span class="n">bPowAlwaysModeSw</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">bPowDuringMotionSw</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">bPowDuringMotion</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">bExpectedAlwaysModeSw</span>               <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">bExpectedPowDuringMotionSw</span>  <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">bExpectedPowDuringMotion</span>    <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">uMoveID</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">//</span> <span class="n">always</span> <span class="n">default</span>
<span class="n">uStates</span>     <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">btimerOn</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">bPowerStatus</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestModeEnableSwitchAndAbsoluteMove&#39;</span><span class="p">);</span>

<span class="n">CASE</span> <span class="n">uStates</span> <span class="n">OF</span>
    <span class="o">//</span><span class="n">init</span>
    <span class="mi">10</span><span class="p">:</span>
        <span class="n">fbMotorTestSuite</span><span class="o">.</span><span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">);</span>
        <span class="o">//</span> <span class="nb">set</span> <span class="n">initial</span> <span class="n">position</span>
        <span class="n">fbSetPos</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span> <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">Position</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Mode</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
        <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="mi">20</span><span class="p">:</span>
        <span class="o">//</span> <span class="nb">set</span> <span class="n">mode</span> <span class="p">(</span><span class="n">always</span><span class="o">|</span><span class="n">during_motion</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">uMoveID</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">THEN</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">uMoveID</span> <span class="o">=</span> <span class="mi">2</span> <span class="n">THEN</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="o">//</span><span class="n">start</span> <span class="n">a</span> <span class="n">mode</span> <span class="n">change</span> <span class="n">timer</span>
        <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
        <span class="n">bTimerOn</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">mode</span> <span class="n">change</span> <span class="n">timeout</span>
    <span class="mi">30</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">tonModeTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">uMoveID</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">THEN</span>
                <span class="o">//</span> <span class="n">power</span> <span class="n">should</span> <span class="n">enable</span>
                <span class="n">bPowAlwaysModeSw</span> <span class="o">:=</span> <span class="n">bPowerStatus</span><span class="p">;</span>
                <span class="n">uMoveID</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
                <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
            <span class="n">ELSIF</span> <span class="n">uMoveID</span> <span class="o">=</span> <span class="mi">2</span> <span class="n">THEN</span>
                <span class="o">//</span> <span class="n">power</span> <span class="n">should</span> <span class="n">be</span> <span class="n">disabled</span>
                <span class="n">bPowDuringMotionSw</span> <span class="o">:=</span> <span class="n">bPowerStatus</span><span class="p">;</span>
                <span class="o">//</span> <span class="n">prepare</span> <span class="n">an</span> <span class="n">absolute</span> <span class="n">move</span>
                <span class="n">uMoveID</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="o">//</span> <span class="n">completed</span>
                <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">40</span><span class="p">;</span>
            <span class="n">END_IF</span>
            <span class="n">btimerOn</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">40</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fDeceleration</span><span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bMoveCmd</span>      <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">wait</span> <span class="n">to</span> <span class="n">ensure</span> <span class="n">power</span> <span class="n">been</span> <span class="n">enabled</span>
        <span class="n">btimerOn</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>

    <span class="mi">50</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">power</span> <span class="n">must</span> <span class="n">be</span> <span class="n">enabled</span> <span class="n">to</span> <span class="n">the</span> <span class="n">drive</span> <span class="n">at</span> <span class="n">this</span> <span class="n">point</span>
        <span class="n">IF</span> <span class="n">tonModeTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
          <span class="n">bPowDuringMotion</span> <span class="o">:=</span> <span class="n">bPowerStatus</span><span class="p">;</span>
          <span class="n">btimerOn</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
            <span class="n">fActualPosition</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NCtoPLC</span><span class="o">.</span><span class="n">ActPos</span><span class="p">;</span>
            <span class="n">uStates</span> <span class="o">:=</span> <span class="mi">60</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="mi">60</span><span class="p">:;</span>
    <span class="o">//</span><span class="n">completed</span>
    <span class="n">ELSE</span>
        <span class="p">;</span>
<span class="n">END_CASE</span>


<span class="n">tonTestTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5S);</span>
<span class="n">tonModeTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">btimerOn</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#0.2S);</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">bPowerStatus</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span><span class="p">;</span>

<span class="o">//</span> <span class="n">watchdog</span> <span class="n">timer</span><span class="p">:</span> <span class="n">override</span> <span class="n">state</span> <span class="n">machine</span> <span class="ow">and</span> <span class="n">complete</span> <span class="n">tests</span>
<span class="n">IF</span> <span class="n">tonTestTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">uStates</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span><span class="n">THEN</span>
        <span class="n">AssertEquals</span> <span class="p">(</span> <span class="n">Expected</span><span class="o">:=</span><span class="n">bExpectedAlwaysModeSw</span><span class="p">,</span> <span class="n">Actual</span><span class="o">:=</span><span class="n">bPowAlwaysModeSw</span> <span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Power must be enable after ALWAYS mode switch&#39;</span><span class="p">);</span>
        <span class="n">AssertEquals</span> <span class="p">(</span> <span class="n">Expected</span><span class="o">:=</span><span class="n">bExpectedPowDuringMotionSw</span><span class="p">,</span> <span class="n">Actual</span><span class="o">:=</span><span class="n">bPowDuringMotionSw</span> <span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Power must be reset after a DURING_MOTION mode switch&#39;</span><span class="p">);</span>
        <span class="n">AssertEquals</span> <span class="p">(</span> <span class="n">Expected</span><span class="o">:=</span><span class="n">bExpectedPowDuringMotion</span><span class="p">,</span> <span class="n">Actual</span><span class="o">:=</span><span class="n">bPowDuringMotion</span> <span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Power must be enable after a DURING_MOTION motion mode switch&#39;</span><span class="p">);</span>
        <span class="n">AssertEquals_LREAL</span> <span class="p">(</span> <span class="n">Expected</span><span class="o">:=</span> <span class="n">fExpectedPosition</span><span class="p">,</span> <span class="n">Actual</span><span class="o">:=</span><span class="n">fActualPosition</span> <span class="p">,</span> <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Drive must have done a 100 units absolute move in DURING_MOTION mode&#39;</span><span class="p">);</span>

        <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-stageenablemode">ENUM_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-powernc">
<h2>FB_PowerNC<a class="headerlink" href="#fb-powernc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PowerNC</span> <span class="n">IMPLEMENTS</span> <span class="n">I_Power</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_copy&#39;</span><span class="p">}</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">fbMcPower</span> <span class="p">:</span> <span class="n">MC_Power</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">__ISVALIDREF</span><span class="p">(</span><span class="n">AxisRef</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">AxisRef</span><span class="o">.</span><span class="n">ReadStatus</span><span class="p">();</span>

<span class="n">fbMcPower</span><span class="p">(</span>
    <span class="n">Axis</span> <span class="o">:=</span> <span class="n">AxisRef</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="p">(</span><span class="o">*</span><span class="n">When</span> <span class="n">the</span> <span class="n">enable</span> <span class="n">flags</span> <span class="n">are</span> <span class="n">updated</span> <span class="n">externally</span> <span class="n">this</span> <span class="n">must</span> <span class="n">be</span> <span class="n">called</span> <span class="n">cyclicly</span><span class="o">*</span><span class="p">)</span>
<span class="n">METHOD</span> <span class="n">Power</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Enable</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Enable_Positive</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Enable_Negative</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Override</span>        <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">100.0</span><span class="p">;</span>
    <span class="n">BufferMode</span>      <span class="p">:</span> <span class="n">MC_BufferMode</span> <span class="o">:=</span> <span class="n">MC_BufferMode</span><span class="o">.</span><span class="n">MC_Aborting</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcPower</span><span class="p">(</span>
    <span class="n">Axis</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">,</span>
    <span class="n">Enable</span> <span class="o">:=</span> <span class="n">Enable</span><span class="p">,</span>
    <span class="n">Enable_Positive</span> <span class="o">:=</span> <span class="n">Enable_Positive</span><span class="p">,</span>
    <span class="n">Enable_Negative</span> <span class="o">:=</span> <span class="n">Enable_Negative</span><span class="p">,</span>
    <span class="n">BufferMode</span> <span class="o">:=</span> <span class="n">BufferMode</span><span class="p">,</span>
    <span class="n">Override</span> <span class="o">:=</span><span class="n">Override</span>
<span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Active</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcPower</span><span class="o">.</span><span class="n">Status</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcPower</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcPower</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcPower</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Override</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Override</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcPower</span><span class="o">.</span><span class="n">Override</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">PowerIsEnabled</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">PowerIsEnabled</span> <span class="o">:=</span><span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcPower</span><span class="o">.</span><span class="n">Status</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
</section>
<section id="fb-rawcountconverter">
<h2>FB_RawCountConverter<a class="headerlink" href="#fb-rawcountconverter" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_RawCountConverter</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Utility</span> <span class="n">function</span> <span class="n">block</span> <span class="k">for</span> <span class="n">converting</span> <span class="n">raw</span> <span class="n">counts</span> <span class="n">to</span> <span class="n">EGU</span> <span class="ow">and</span> <span class="n">back</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Parameters</span> <span class="n">to</span> <span class="n">check</span> <span class="n">against</span>
    <span class="n">stParameters</span><span class="p">:</span> <span class="n">ST_AxisParameterSet</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Optional</span> <span class="n">count</span> <span class="n">to</span> <span class="n">convert</span> <span class="n">to</span> <span class="n">a</span> <span class="n">real</span> <span class="n">position</span>
    <span class="n">nCountCheck</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Optional</span> <span class="n">position</span> <span class="n">to</span> <span class="n">convert</span> <span class="n">to</span> <span class="n">encoder</span> <span class="n">counts</span>
    <span class="n">fPosCheck</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">converting</span> <span class="n">position</span><span class="p">,</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">counts</span>
    <span class="n">nCountGet</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">converting</span> <span class="n">counts</span><span class="p">,</span> <span class="n">the</span> <span class="n">position</span>
    <span class="n">fPosGet</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="kc">True</span> <span class="n">during</span> <span class="n">a</span> <span class="n">parameter</span> <span class="n">get</span><span class="o">/</span><span class="n">calc</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="kc">True</span> <span class="n">after</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">get</span><span class="o">/</span><span class="n">calc</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">calculation</span> <span class="n">errored</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">stParameters</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">nCountGet</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fPosCheck</span> <span class="o">-</span> <span class="n">stParameters</span><span class="o">.</span><span class="n">fEncOffset</span><span class="p">)</span> <span class="o">/</span> <span class="n">stParameters</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span><span class="p">);</span>
    <span class="n">fPosGet</span> <span class="o">:=</span> <span class="n">nCountCheck</span> <span class="o">*</span> <span class="n">stParameters</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span> <span class="o">+</span> <span class="n">stParameters</span><span class="o">.</span><span class="n">fEncOffset</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-readfloatparameter">
<h2>FB_ReadFloatParameter<a class="headerlink" href="#fb-readfloatparameter" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ReadFloatParameter</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="mi">16</span><span class="c1">#4000=Axisdata, 16#5000=Encoderdata, 16#6000=Controldata, 16#7000=Drivedata</span>
    <span class="n">nDeviceGroup</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndexOffset</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">nData</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fbADSREAD</span><span class="p">:</span> <span class="n">ADSREAD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">Sequence</span> <span class="n">to</span> <span class="n">read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="mi">0</span><span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">Start</span> <span class="n">sequence</span><span class="o">.</span> <span class="n">Wait</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">TRUE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bBusy</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fbADSREAD</span><span class="p">(</span>
            <span class="n">PORT</span><span class="o">:=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">IDXGRP</span><span class="o">:=</span><span class="n">nDeviceGroup</span><span class="o">+</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">,</span>
            <span class="n">IDXOFFS</span><span class="o">:=</span><span class="n">nIndexOffset</span><span class="p">,</span>
            <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">DESTADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">READ</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Wait</span> <span class="n">until</span> <span class="n">it</span><span class="s1">&#39;s done or if an error occurs*)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSREAD</span><span class="o">.</span><span class="n">ERR</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSREAD</span><span class="o">.</span><span class="n">BUSY</span> <span class="n">THEN</span>
                    <span class="n">fbADSREAD</span><span class="p">(</span><span class="n">READ</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                    <span class="n">nState</span><span class="o">:=</span><span class="mi">20</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">ELSE</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbADSREAD</span><span class="o">.</span><span class="n">ERRID</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">999</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Sequense</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span> <span class="n">Waits</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">999</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbADSREAD</span><span class="p">(</span><span class="n">READ</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-readparameterinnc-v1-00">
<h2>FB_ReadParameterInNc_v1_00<a class="headerlink" href="#fb-readparameterinnc-v1-00" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="c1">#########################################################</span>
<span class="o">///</span><span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Library</span><span class="p">:</span>
<span class="o">///</span> <span class="n">Tc2_MC2</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span> <span class="n">Tc2_System</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Global</span> <span class="n">Variables</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Data</span> <span class="n">types</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">External</span> <span class="n">functions</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">History</span><span class="p">:</span>
<span class="o">///</span> <span class="mi">2014</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">05</span>      <span class="n">v1</span><span class="mf">.00</span>   <span class="n">NB</span>      <span class="n">Release</span> <span class="n">code</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Known</span> <span class="n">bugs</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span>
<span class="o">///</span>
<span class="o">///</span><span class="c1">###########################################################</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ReadParameterInNc_v1_00</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="mi">16</span><span class="c1">#4000=Axisdata, 16#5000=Encoderdata, 16#6000=Controldata, 16#7000=Drivedata</span>
    <span class="n">nDeviceGroup</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndexOffset</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">nData</span><span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fbADSREAD</span><span class="p">:</span> <span class="n">ADSREAD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">Sequence</span> <span class="n">to</span> <span class="n">read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="mi">0</span><span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">Start</span> <span class="n">sequence</span><span class="o">.</span> <span class="n">Wait</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">TRUE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bBusy</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fbADSREAD</span><span class="p">(</span>
            <span class="n">PORT</span><span class="o">:=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">IDXGRP</span><span class="o">:=</span><span class="n">nDeviceGroup</span><span class="o">+</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">,</span>
            <span class="n">IDXOFFS</span><span class="o">:=</span><span class="n">nIndexOffset</span><span class="p">,</span>
            <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">DESTADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">READ</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Wait</span> <span class="n">until</span> <span class="n">it</span><span class="s1">&#39;s done or if an error occurs*)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSREAD</span><span class="o">.</span><span class="n">ERR</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSREAD</span><span class="o">.</span><span class="n">BUSY</span> <span class="n">THEN</span>
                    <span class="n">fbADSREAD</span><span class="p">(</span><span class="n">READ</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                    <span class="n">nState</span><span class="o">:=</span><span class="mi">20</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">ELSE</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbADSREAD</span><span class="o">.</span><span class="n">ERRID</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">999</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Sequense</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span> <span class="n">Waits</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">999</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbADSREAD</span><span class="p">(</span><span class="n">READ</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-readparameternc">
<h2>FB_ReadParameterNC<a class="headerlink" href="#fb-readparameternc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ReadParameterNC</span> <span class="n">IMPLEMENTS</span> <span class="n">I_ReadParameter</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Read</span> <span class="ow">and</span> <span class="n">refresh</span> <span class="n">axis</span> <span class="n">parameters</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_copy&#39;</span><span class="p">}</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="o">//</span> <span class="n">NC</span> <span class="n">parameters</span> <span class="n">that</span> <span class="n">are</span> <span class="n">exposed</span> <span class="k">with</span> <span class="n">pytmc</span> <span class="n">pragmas</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">AxisPar</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Axis</span> <span class="n">configuration</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">numerical</span> <span class="n">controller</span><span class="o">.</span>
    <span class="s1">&#39;}</span>
    <span class="n">stAxisParametersExposed</span> <span class="p">:</span> <span class="n">ST_AxisParameterSetExposed</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">MC_ReadParameterSet</span> <span class="n">Output</span>
    <span class="n">fbMcReadParams</span><span class="p">:</span> <span class="n">MC_ReadParameterSet</span><span class="p">;</span>
    <span class="o">//</span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;hide&#39;</span><span class="p">}</span>
    <span class="n">stAxisParameters</span><span class="p">:</span> <span class="n">ST_AxisParameterSet</span><span class="p">;</span>
    <span class="n">bNcParamsReadInit</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">NCParamsTimer</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bAxisParametersInit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tRefreshDelay</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1S;</span>
    <span class="n">bEnable</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span>                          <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span>                        <span class="p">:</span> <span class="n">UDINT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span><span class="p">;</span>
    <span class="n">bDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">ReadParameters</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Enable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">RefreshDelay</span><span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bEnable</span><span class="o">:=</span> <span class="n">Enable</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">tRefreshDelay</span><span class="o">:=</span> <span class="n">RefreshDelay</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">AmsNetID</span> <span class="p">:</span> <span class="n">T_AmsNetId</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">AmsNetID</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">sAmsNetId</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">AxisReadParamsInit</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">AxisReadParamsInit</span> <span class="o">:=</span> <span class="n">bAxisParametersInit</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Done</span> <span class="o">:=</span> <span class="n">bDone</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">EnInTargetTimeout</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">EnInTargetTimeout</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bEnablePEHTimeControl</span><span class="mf">.0</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">EnMaxSoftPosLimit</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">EnMaxSoftPosLimit</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bEncEnableSoftEndMaxControl</span><span class="mf">.0</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">EnMinSoftPosLimit</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">EnMinSoftPosLimit</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bEncEnableSoftEndMinControl</span><span class="mf">.0</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">EnPositionLagMonitoring</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">EnPositionLagMonitoring</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bCtrlEnablePosDiffControl</span><span class="mf">.0</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">EnPositionRangeMonitoring</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">EnScaleFactorInternal</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">EnScaleFactorInternal</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">EnTargetPositionMonitoring</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">EnTargetPositionMonitoring</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">bEnableTargetPosControl</span><span class="mf">.0</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">bError</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">nErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">InTargetTimeout</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">InTargetTimeout</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fPEHControlTime</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MaxPosLagFilterTime</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MaxPosLagFilterTime</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fCtrlPosDiffMaxTime</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MaxPosLagValue</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MaxPosLagValue</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fCtrlPosDiffMax</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MaxSoftPosLimit</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MaxSoftPosLimit</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncSoftEndMax</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Message</span> <span class="o">:=</span> <span class="n">sMessage</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">MinSoftPosLimit</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">MinSoftPosLimit</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncSoftEndMin</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Port</span> <span class="p">:</span> <span class="n">WORD</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Port</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">nPort</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">PositionRangeWindow</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">RefVeloSearch</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">RefVeloSearch</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fRefVeloSearch</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">RefVeloSync</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">RefVeloSync</span><span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fRefVeloSync</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">TargetPositionMonitoringTime</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TargetPositionMonitoringTime</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fTargetPosControlTime</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">TargetPositionWindow</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TargetPositionWindow</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fTargetPosControlRange</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-axisparametersetexposed">ST_AxisParameterSetExposed</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-resetnc">
<h2>FB_ResetNC<a class="headerlink" href="#fb-resetnc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ResetNC</span> <span class="n">IMPLEMENTS</span> <span class="n">I_Reset</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_copy&#39;</span><span class="p">}</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">fbMcReset</span>       <span class="p">:</span> <span class="n">MC_Reset</span><span class="p">;</span>
    <span class="n">eResetState</span> <span class="p">:</span> <span class="p">(</span><span class="n">WaitingReset</span><span class="p">,</span> <span class="n">Resetting</span><span class="p">);</span>

<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">__ISVALIDREF</span><span class="p">(</span><span class="n">AxisRef</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">AxisRef</span><span class="o">.</span><span class="n">ReadStatus</span><span class="p">();</span>

<span class="n">CASE</span> <span class="n">eResetState</span> <span class="n">OF</span>
    <span class="n">WaitingReset</span> <span class="p">:</span>
        <span class="n">fbMcReset</span><span class="p">(</span>
        <span class="n">Axis</span> <span class="o">:=</span> <span class="n">AxisRef</span><span class="p">,</span>
        <span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="n">Resetting</span> <span class="p">:</span>
        <span class="n">fbMcReset</span><span class="p">(</span>
        <span class="n">Axis</span> <span class="o">:=</span> <span class="n">AxisRef</span><span class="p">,</span>
        <span class="n">Execute</span> <span class="o">:=</span> <span class="n">TRUE</span>
        <span class="p">);</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">FB_Init</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">warm</span> <span class="n">start</span> <span class="o">/</span> <span class="n">cold</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">bInCopyCode</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">afterwards</span> <span class="n">gets</span> <span class="n">moved</span> <span class="n">into</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Reset</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Clear</span> <span class="n">previous</span> <span class="n">status</span>
<span class="n">fbMcReset</span><span class="p">(</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>  <span class="n">Axis</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">);</span>
<span class="o">//</span> <span class="n">initiate</span> <span class="n">a</span> <span class="n">new</span> <span class="n">Resetting</span> <span class="n">request</span>
<span class="n">fbMcReset</span><span class="p">(</span>   <span class="n">Axis</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span><span class="p">,</span>
             <span class="n">Execute</span> <span class="o">:=</span> <span class="n">TRUE</span> <span class="p">);</span>

<span class="n">eResetState</span> <span class="o">:=</span> <span class="n">Resetting</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcReset</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Done</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcReset</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcReset</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">fbMcReset</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>
</pre></div>
</div>
</section>
<section id="fb-setenables">
<h2>FB_SetEnables<a class="headerlink" href="#fb-setenables" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SetEnables</span>
<span class="o">//</span> <span class="n">Update</span> <span class="n">the</span> <span class="nb">all</span> <span class="n">enable</span> <span class="n">booleans</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">booleans</span> <span class="n">that</span> <span class="n">make</span> <span class="n">them</span> <span class="n">up</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllForwardEnable</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="n">AND</span> <span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bGantryForwardEnable</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bGantryAxis</span><span class="p">)</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stEPSForwardEnable</span><span class="o">.</span><span class="n">bEPS_OK</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllBackwardEnable</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="n">AND</span> <span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bGantryAxis</span><span class="p">)</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stEPSBackwardEnable</span><span class="o">.</span><span class="n">bEPS_OK</span><span class="p">;</span>

<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stEPSPowerEnable</span><span class="o">.</span><span class="n">bEPS_OK</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bUserEnable</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-standard-pmpsdb">
<h2>FB_Standard_PMPSDB<a class="headerlink" href="#fb-standard-pmpsdb" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Standard_PMPSDB</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">FB</span> <span class="n">should</span> <span class="n">be</span> <span class="n">run</span> <span class="n">on</span> <span class="n">every</span> <span class="n">motion</span> <span class="n">PLC</span> <span class="n">to</span> <span class="n">encapsulate</span> <span class="n">the</span> <span class="n">pmps</span> <span class="n">file</span> <span class="n">reader</span><span class="o">.</span>
    <span class="n">It</span> <span class="ow">is</span> <span class="n">pre</span><span class="o">-</span><span class="n">instantiated</span> <span class="n">at</span> <span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">fbStandardPMPSDB</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">io_fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">FB</span> <span class="n">will</span> <span class="n">run</span><span class="o">.</span> <span class="n">Reads</span> <span class="n">when</span> <span class="n">enable</span> <span class="n">goes</span> <span class="n">TRUE</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">E</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">lfe</span><span class="o">-</span><span class="n">motion</span>
    <span class="n">sPlcName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">REFRESH</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">cause</span> <span class="n">an</span> <span class="n">extra</span> <span class="n">read</span><span class="o">.</span>
    <span class="n">bRefresh</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Directory</span> <span class="n">where</span> <span class="n">the</span> <span class="n">DB</span> <span class="ow">is</span> <span class="n">stored</span><span class="o">.</span>
    <span class="n">sDirectory</span><span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">LAST_REFRESH</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nLastRefreshTime</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bReadPmpsDb</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtEnable</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtRefresh</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftBusy</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Time</span> <span class="n">tracking</span> <span class="n">liften</span> <span class="kn">from</span><span class="w"> </span><span class="nn">Arbiter</span> <span class="n">PLCs</span>
    <span class="n">fbTime</span> <span class="p">:</span> <span class="n">FB_LocalSystemTime</span> <span class="o">:=</span> <span class="p">(</span> <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">dwCycle</span> <span class="o">:=</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="n">fbTime_to_UTC</span><span class="p">:</span> <span class="n">FB_TzSpecificLocalTimeToSystemTime</span><span class="p">;</span>
    <span class="n">fbGetTimeZone</span><span class="p">:</span> <span class="n">FB_GetTimeZoneInformation</span><span class="p">;</span>

    <span class="n">fbIPCReg</span><span class="p">:</span> <span class="n">FB_IPCDiag_Register</span><span class="p">;</span>
    <span class="n">fbCheckOS</span><span class="p">:</span> <span class="n">FB_IPCDiag_ReadParameter</span><span class="p">;</span>
    <span class="n">sOSName</span><span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">nCheckOSTries</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">rtEnable</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">);</span>
<span class="n">rtRefresh</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bRefresh</span><span class="p">);</span>
<span class="n">bRefresh</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">rtEnable</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">rtRefresh</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">file</span> <span class="n">reader</span> <span class="n">gets</span> <span class="n">a</span> <span class="n">rising</span> <span class="n">edge</span>
    <span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">fbPmpsFileReader</span><span class="p">(</span>
        <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">sDirectory</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Check</span> <span class="n">OS</span> <span class="k">for</span> <span class="n">default</span> <span class="n">directory</span>
    <span class="n">fbIPCReg</span><span class="p">(</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">tTimeout</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1s,</span>
    <span class="p">);</span>
    <span class="n">fbCheckOS</span><span class="p">(</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">fbIPCReg</span><span class="o">.</span><span class="n">bValid</span><span class="p">,</span>
        <span class="n">eParameterKey</span><span class="o">:=</span><span class="n">E_IPCDiag_ParameterKey</span><span class="o">.</span><span class="n">OS_Name</span><span class="p">,</span>
        <span class="n">fbRegister</span><span class="o">:=</span><span class="n">fbIPCReg</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbIPCReg</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbCheckOS</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">nCheckOSTries</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">Retry</span> <span class="n">counter</span> <span class="n">down</span> <span class="n">to</span> <span class="n">zero</span><span class="p">:</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">error</span> <span class="n">name</span> <span class="n">to</span> <span class="k">try</span> <span class="n">old</span> <span class="n">default</span>
            <span class="n">sOSName</span> <span class="o">:=</span> <span class="s1">&#39;Error&#39;</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="o">//</span> <span class="n">Decrement</span> <span class="n">retry</span> <span class="n">counter</span>
            <span class="n">nCheckOSTries</span> <span class="o">:=</span> <span class="n">nCheckOSTries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="o">//</span> <span class="n">Reset</span> <span class="n">FBs</span>
            <span class="n">fbCheckOS</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span> <span class="n">fbRegister</span><span class="o">:=</span><span class="n">fbIPCReg</span><span class="p">);</span>
            <span class="n">fbIPCReg</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
        <span class="n">END_IF</span>
    <span class="n">ELSIF</span> <span class="n">fbCheckOS</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
        <span class="n">fbCheckOS</span><span class="o">.</span><span class="n">GetParameter</span><span class="p">(</span>
            <span class="n">pBuffer</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">sOSName</span><span class="p">),</span>
            <span class="n">nBufferSize</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">sOSName</span><span class="p">),</span>
        <span class="p">);</span>
    <span class="n">END_IF</span>
    <span class="n">IF</span> <span class="n">sOSName</span> <span class="o">=</span> <span class="s1">&#39;TwinCAT/BSD&#39;</span> <span class="n">THEN</span>
        <span class="n">sDirectory</span> <span class="o">:=</span> <span class="s1">&#39;/home/ecs-user/pmpsdb/&#39;</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">sOSName</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
        <span class="n">sDirectory</span> <span class="o">:=</span> <span class="s1">&#39;/Hard Disk/ftp/PMPS/&#39;</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">fbPmpsFileReader</span><span class="p">(</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">sDirectory</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">sSrcPathName</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">sDirectory</span><span class="p">,</span> <span class="n">sPlcName</span><span class="p">),</span> <span class="s1">&#39;.json&#39;</span><span class="p">),</span>
    <span class="n">sPLCName</span><span class="o">:=</span><span class="n">sPLCName</span><span class="p">,</span>
    <span class="n">PMPS_jsonDoc</span><span class="o">=&gt;</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">BP_jsonDoc</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">ftBusy</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">fbPmpsFileReader</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">ftBusy</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bReadPmpsDb</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bReadPmpsDb</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Lifted</span> <span class="kn">from</span><span class="w"> </span><span class="nn">Arbiter</span> <span class="n">PLCs</span><span class="p">:</span> <span class="n">keep</span> <span class="n">track</span> <span class="n">of</span> <span class="n">the</span> <span class="n">time</span>
<span class="n">fbTime</span><span class="p">(</span><span class="n">sNetID</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="n">fbGetTimeZone</span><span class="p">(</span><span class="n">sNetID</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">tTimeout</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>
<span class="n">fbTime_to_UTC</span><span class="p">(</span><span class="ow">in</span><span class="o">:=</span> <span class="n">fbTime</span><span class="o">.</span><span class="n">systemTime</span> <span class="p">,</span> <span class="n">tzInfo</span><span class="o">:=</span><span class="n">fbGetTimeZone</span><span class="o">.</span><span class="n">tzInfo</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Update</span> <span class="n">the</span> <span class="n">refresh</span> <span class="n">time</span> <span class="n">on</span> <span class="n">successful</span> <span class="n">read</span>
<span class="n">IF</span> <span class="n">ftBusy</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">fbPmpsFileReader</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
   <span class="n">nLastRefreshTime</span> <span class="o">:=</span> <span class="n">TO_DINT</span><span class="p">(</span><span class="n">TO_DT</span><span class="p">(</span><span class="n">SystemTime_TO_DT</span><span class="p">(</span><span class="n">fbTime_to_UTC</span><span class="o">.</span><span class="n">out</span><span class="p">)));</span>
<span class="n">END_IF</span>

<span class="n">bExecute</span> <span class="n">R</span><span class="o">=</span> <span class="n">ftBusy</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statepmpsenables">
<h2>FB_StatePMPSEnables<a class="headerlink" href="#fb-statepmpsenables" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StatePMPSEnables</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">virtual</span> <span class="n">limit</span> <span class="n">enables</span> <span class="n">using</span> <span class="n">MC_POWER</span> <span class="k">for</span> <span class="n">single</span> <span class="n">dimensional</span> <span class="n">state</span> <span class="n">movers</span><span class="o">.</span>
    <span class="n">It</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">building</span> <span class="n">block</span> <span class="ow">not</span> <span class="n">meant</span> <span class="k">for</span> <span class="n">use</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">lcls</span><span class="o">-</span><span class="n">twintcat</span><span class="o">-</span><span class="n">motion</span><span class="o">.</span>

    <span class="n">Each</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">a</span> <span class="n">virtual</span> <span class="s2">&quot;allowed&quot;</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">motion</span> <span class="n">based</span> <span class="n">on</span> <span class="n">its</span> <span class="n">goal</span> <span class="n">position</span><span class="o">.</span>
    <span class="n">When</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">the</span> <span class="n">goal</span><span class="p">,</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">can</span> <span class="n">only</span> <span class="n">move</span> <span class="n">toward</span> <span class="n">the</span> <span class="n">goal</span><span class="o">.</span>
    <span class="n">When</span> <span class="n">at</span> <span class="n">the</span> <span class="n">goal</span><span class="p">,</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">can</span> <span class="n">move</span> <span class="n">within</span> <span class="n">the</span> <span class="n">position</span><span class="s1">&#39;s delta.</span>

    <span class="n">With</span> <span class="n">no</span> <span class="n">goals</span> <span class="ow">or</span> <span class="n">other</span> <span class="n">strange</span> <span class="n">states</span><span class="p">,</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">permitted</span> <span class="n">to</span> <span class="n">move</span> <span class="ow">in</span> <span class="n">either</span> <span class="n">direction</span>
    <span class="n">to</span> <span class="n">help</span> <span class="n">restore</span> <span class="n">it</span> <span class="n">to</span> <span class="n">a</span> <span class="n">known</span> <span class="n">position</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motor</span> <span class="k">with</span> <span class="n">a</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">this</span> <span class="n">motor</span><span class="o">.</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Hardware</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">problem</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">do</span> <span class="n">the</span> <span class="n">limits</span> <span class="k">as</span> <span class="n">normal</span><span class="o">.</span> <span class="n">If</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">allow</span> <span class="nb">all</span> <span class="n">moves</span> <span class="n">regardless</span> <span class="n">of</span> <span class="n">the</span> <span class="n">limits</span> <span class="n">defined</span> <span class="n">here</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">state</span> <span class="n">that</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">moving</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">nGoalStateIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">overal</span> <span class="n">PMPS</span> <span class="n">FB</span> <span class="n">state</span>
    <span class="n">eStatePMPSStatus</span><span class="p">:</span> <span class="n">E_StatePMPSStatus</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Connect</span> <span class="n">to</span> <span class="n">the</span> <span class="n">BPTM</span>
    <span class="n">bTransitionAuthorized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enable</span> <span class="n">state</span> <span class="n">we</span> <span class="n">send</span> <span class="n">to</span> <span class="n">MC_Power</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="k">pass</span><span class="o">-</span><span class="n">through</span> <span class="kn">from</span><span class="w"> </span><span class="nn">stMotionStage.</span>
    <span class="n">bEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">forward</span> <span class="n">enable</span> <span class="n">state</span> <span class="n">we</span> <span class="n">send</span> <span class="n">to</span> <span class="n">MC_Power</span><span class="o">.</span> <span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="k">pass</span><span class="o">-</span><span class="n">through</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">override</span> <span class="n">to</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">bForwardEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">backwards</span> <span class="n">enable</span> <span class="n">state</span> <span class="n">we</span> <span class="n">send</span> <span class="n">to</span> <span class="n">MC_Power</span><span class="o">.</span> <span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="k">pass</span><span class="o">-</span><span class="n">through</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">override</span> <span class="n">to</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">bBackwardEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">goal</span> <span class="n">position</span> <span class="ow">and</span> <span class="n">FALSE</span> <span class="n">otherwise</span><span class="o">.</span> <span class="n">This</span> <span class="n">makes</span> <span class="n">a</span> <span class="n">fast</span> <span class="n">fault</span> <span class="k">if</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">bValidGoal</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">mc_power</span><span class="p">:</span> <span class="n">MC_POWER</span><span class="p">;</span>
    <span class="n">nPrevStateIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">fLowerPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fUpperPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">ffNoGoal</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">bLockBounds</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bErrorMsg</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">GetBounds</span><span class="p">();</span>
<span class="n">SetEnables</span><span class="p">();</span>
<span class="n">ApplyEnables</span><span class="p">();</span>
<span class="n">RunFastFaults</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ApplyEnables</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">action</span> <span class="n">runs</span> <span class="n">MC_POWER</span> <span class="n">appropriately</span>
    <span class="n">given</span> <span class="n">the</span> <span class="n">motor</span><span class="s1">&#39;s own enables and the results of this FB&#39;</span><span class="n">s</span> <span class="n">checks</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">bEnabled</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span><span class="p">;</span>
<span class="n">bForwardEnabled</span> <span class="o">:=</span> <span class="n">bForwardEnabled</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">;</span>
<span class="n">bBackwardEnabled</span> <span class="o">:=</span> <span class="n">bBackwardEnabled</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllBackwardEnable</span><span class="p">;</span>

<span class="n">CASE</span> <span class="n">eStatePMPSStatus</span> <span class="n">OF</span>
    <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">TRANSITION</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">bTransitionAuthorized</span><span class="p">;</span>
        <span class="n">bForwardEnabled</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bTransitionAuthorized</span><span class="p">;</span>
        <span class="n">bBackwardEnabled</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bTransitionAuthorized</span><span class="p">;</span>
    <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">AT_STATE</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="o">//</span> <span class="n">bPowerSelf</span> <span class="n">MUST</span> <span class="n">be</span> <span class="n">false</span> <span class="n">to</span> <span class="n">use</span> <span class="n">this</span> <span class="n">function</span> <span class="k">with</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">so</span>
<span class="o">//</span> <span class="n">automatically</span> <span class="nb">set</span> <span class="n">it</span> <span class="n">false</span> <span class="n">here</span> <span class="n">otherwise</span> <span class="n">it</span> <span class="n">will</span> <span class="n">conflict</span> <span class="k">with</span> <span class="n">the</span>
<span class="o">//</span> <span class="n">MC_POWER</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">FB_MotionStage</span><span class="o">.</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">mc_power</span><span class="p">(</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Enable</span><span class="o">:=</span><span class="n">bEnabled</span><span class="p">,</span>
    <span class="n">Enable_Positive</span><span class="o">:=</span><span class="n">bForwardEnabled</span><span class="p">,</span>
    <span class="n">Enable_Negative</span><span class="o">:=</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">GetBounds</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">action</span> <span class="n">sets</span> <span class="n">fLowerPos</span> <span class="ow">and</span> <span class="n">fUpperPos</span> <span class="n">based</span> <span class="n">on</span> <span class="n">our</span> <span class="n">goal</span> <span class="n">position</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">nGoalStateIndex</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">nGoalStateIndex</span> <span class="o">&lt;=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span> <span class="n">THEN</span>
        <span class="n">bValidGoal</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bLockBounds</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">fLowerPos</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="n">ABS</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">);</span>
        <span class="n">fUpperPos</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">ABS</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">bValidGoal</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">bValidGoal</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="n">bLockBounds</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">RunFastFaults</span><span class="p">:</span>
<span class="n">ffNoGoal</span><span class="p">(</span>
    <span class="n">i_xOK</span><span class="o">:=</span><span class="n">bValidGoal</span><span class="p">,</span>
    <span class="n">i_xAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_DevName</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">sName</span><span class="p">,</span>
    <span class="n">i_Desc</span><span class="o">:=</span><span class="s1">&#39;Invalid goal position in state move&#39;</span><span class="p">,</span>
    <span class="n">i_TypeCode</span><span class="o">:=</span><span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">INVALID_GOAL</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">SetEnables</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">action</span> <span class="n">sets</span> <span class="n">bForwardEnable</span> <span class="ow">and</span> <span class="n">bBackwardEnable</span> <span class="n">based</span> <span class="n">on</span>
    <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">calculated</span> <span class="n">bounds</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">bLockBounds</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Prevent</span> <span class="n">forward</span><span class="o">/</span><span class="n">backward</span> <span class="n">motion</span> <span class="k">if</span> <span class="n">the</span> <span class="n">position</span> <span class="n">of</span> <span class="n">the</span> <span class="n">axis</span> <span class="ow">is</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">the</span> <span class="n">upper</span><span class="o">/</span><span class="n">lower</span> <span class="n">bounds</span> <span class="n">respectively</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">Prevent</span> <span class="n">forward</span><span class="o">/</span><span class="n">backward</span> <span class="n">motion</span> <span class="k">if</span> <span class="n">the</span> <span class="n">command</span> <span class="n">to</span> <span class="n">the</span> <span class="n">axis</span> <span class="ow">is</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">the</span> <span class="n">upper</span><span class="o">/</span><span class="n">lower</span> <span class="n">bounds</span> <span class="n">respectively</span><span class="o">.</span>
    <span class="n">bForwardEnabled</span>  <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span> <span class="o">&lt;</span> <span class="n">fUpperPos</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">&lt;</span> <span class="n">fUpperPos</span><span class="p">;</span>
    <span class="n">bBackwardEnabled</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span> <span class="o">&gt;</span> <span class="n">fLowerPos</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">&gt;</span> <span class="n">fLowerPos</span><span class="p">;</span>

    <span class="n">IF</span> <span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">=</span> <span class="mi">16</span><span class="c1">#4223 OR stMotionStage.nErrorId = 16#4260) AND</span>
        <span class="p">((</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllForwardEnable</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bForwardEnabled</span><span class="p">)</span> <span class="n">OR</span>
        <span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllBackwardEnable</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bBackwardEnabled</span><span class="p">))</span> <span class="n">THEN</span>
        <span class="o">//</span> <span class="n">Cannot</span> <span class="n">move</span> <span class="n">forward</span><span class="o">/</span><span class="n">backward</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">triggered</span> <span class="n">by</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">stMotionStage</span> <span class="n">disables</span> <span class="n">so</span> <span class="n">overwrite</span> <span class="n">the</span> <span class="n">error</span> <span class="k">with</span> <span class="n">a</span> <span class="n">custom</span> <span class="n">error</span> <span class="n">message</span> <span class="n">to</span> <span class="n">give</span> <span class="n">more</span> <span class="n">context</span><span class="o">.</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span>
            <span class="s1">&#39;Limits exceeded for most recent PMPS position state: &#39;</span><span class="p">,</span> <span class="n">LREAL_TO_FMTSTR</span><span class="p">(</span><span class="n">fLowerPos</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">TRUE</span><span class="p">)),</span> <span class="s1">&#39; &lt; pos &lt; &#39;</span><span class="p">),</span> <span class="n">LREAL_TO_FMTSTR</span><span class="p">(</span><span class="n">fUpperPos</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">TRUE</span><span class="p">));</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="o">//</span> <span class="n">Either</span> <span class="n">invalid</span> <span class="n">state</span> <span class="k">with</span> <span class="n">a</span> <span class="n">fault</span> <span class="ow">or</span> <span class="n">FB</span> <span class="ow">not</span> <span class="n">enabled</span>
    <span class="n">bForwardEnabled</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBackwardEnabled</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#e-statepmpsstatus">E_StatePMPSStatus</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statepmpsenables-test">
<h2>FB_StatePMPSEnables_Test<a class="headerlink" href="#fb-statepmpsenables-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StatePMPSEnables_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Tests</span> <span class="k">for</span> <span class="n">FB_StatePMPSEnables</span>

    <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">ensures</span> <span class="n">that</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">When</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">our</span> <span class="n">goal</span> <span class="n">state</span><span class="p">,</span> <span class="n">we</span> <span class="n">cannot</span> <span class="n">move</span> <span class="n">away</span> <span class="kn">from</span><span class="w"> </span><span class="nn">our</span> <span class="n">goal</span> <span class="n">state</span>
    <span class="o">-</span> <span class="n">When</span> <span class="n">at</span> <span class="n">our</span> <span class="n">goal</span> <span class="n">state</span><span class="p">,</span> <span class="n">we</span> <span class="n">must</span> <span class="n">stay</span> <span class="n">within</span> <span class="n">the</span> <span class="n">state</span> <span class="n">bounds</span>
    <span class="o">-</span> <span class="n">When</span> <span class="n">at</span> <span class="n">our</span> <span class="n">goal</span> <span class="n">state</span><span class="p">,</span> <span class="n">we</span> <span class="n">still</span> <span class="n">obey</span> <span class="n">other</span> <span class="n">constraints</span> <span class="n">like</span> <span class="n">limit</span> <span class="n">switches</span>

    <span class="n">We</span> <span class="n">also</span> <span class="n">include</span> <span class="n">a</span> <span class="nb">super</span> <span class="n">basic</span> <span class="n">real</span> <span class="n">move</span> <span class="n">test</span> <span class="k">with</span> <span class="n">our</span> <span class="n">simulator</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">enables</span> <span class="n">are</span> <span class="nb">set</span> <span class="n">properly</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbInternal1</span><span class="p">:</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">fbInternal2</span><span class="p">:</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">nInvalidState</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">nGoalState</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">nNotUpdatedState</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fTestStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bStatesReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]);</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nInvalidState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nInvalidState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nNotUpdatedState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nNotUpdatedState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nNotUpdatedState</span><span class="p">]);</span>
<span class="n">fbInternal1</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">],</span>
<span class="p">);</span>
<span class="n">fbInternal2</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nInvalidState</span><span class="p">],</span>
<span class="p">);</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">bStatesReady</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span> <span class="n">AND</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nInvalidState</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">nTestCounter</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t run any tests until the states are ready</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">TestInvalid</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">TestNotUpdated</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">TestBelow</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">TestAbove</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="n">TestAt</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="n">TestDisabled</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
<span class="n">TestLimits</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
<span class="n">TestMoveTo</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="n">TestMoveAt</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
<span class="n">TestBoundsAfterFallingIntoUnknownState</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="o">-</span><span class="mi">40</span><span class="p">);</span>
<span class="n">TestBoundsAfterFallingIntoUnknownState</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">40</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bStatesReady</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestAbove</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAbove&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">above</span> <span class="n">the</span> <span class="n">goal</span><span class="s1">&#39;s range</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve set the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Position was not set correctly&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward enabled when above goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward disabled when above goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestAt</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAt&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">at</span> <span class="n">the</span> <span class="n">goal</span> <span class="n">state</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve set the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Position was not set correctly&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward disabled when at goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward disabled when at goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestBelow</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestBelow&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">below</span> <span class="n">the</span> <span class="n">goal</span><span class="s1">&#39;s range</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve set the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Position was not set correctly&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward enabled when below goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward disabled when below goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestBoundsAfterFallingIntoUnknownState</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fStartPosDelta</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">fGoalPosDelta</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbMotionStageSetAndMove</span><span class="p">:</span> <span class="n">FB_MotionStageSetAndMoveHelper</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">mcSetPos</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bSetPos</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bCommandedMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nGoalStateIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;TestBoundsAfterFallingIntoUnknownState&#39;</span><span class="p">,</span><span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nTestID</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">On</span> <span class="n">first</span> <span class="k">pass</span><span class="p">,</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">goal</span> <span class="n">state</span> <span class="n">index</span> <span class="n">to</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">state</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">the</span> <span class="n">bounds</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Then</span><span class="p">,</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">goal</span> <span class="n">state</span> <span class="n">index</span> <span class="n">to</span> <span class="n">an</span> <span class="n">unknown</span> <span class="n">state</span> <span class="n">to</span> <span class="n">ensure</span> <span class="n">the</span> <span class="n">bounds</span> <span class="n">remain</span>
<span class="o">//</span> <span class="n">active</span><span class="o">.</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">nGoalStateIndex</span> <span class="o">:=</span> <span class="n">nGoalState</span><span class="p">;</span>
    <span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">nGoalStateIndex</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span> <span class="n">which</span> <span class="n">should</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">real</span> <span class="n">move</span> <span class="k">while</span> <span class="n">within</span> <span class="n">the</span> <span class="n">allowable</span> <span class="n">bounds</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Once</span> <span class="n">the</span> <span class="n">position</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">out</span> <span class="n">of</span> <span class="n">the</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">the</span> <span class="n">bounds</span> <span class="n">should</span> <span class="n">persist</span> <span class="ow">and</span> <span class="n">prevent</span>
<span class="o">//</span> <span class="n">further</span> <span class="n">movement</span> <span class="n">away</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">goal</span> <span class="n">state</span><span class="o">.</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalStateIndex</span><span class="p">,</span>
    <span class="n">eStatePMPSStatus</span><span class="o">:=</span><span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">TRANSITION</span><span class="p">,</span>
    <span class="n">bTransitionAuthorized</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">out</span> <span class="n">of</span> <span class="n">the</span> <span class="n">goal</span><span class="s1">&#39;s range, and try to move away from the goal</span>
<span class="n">fbMotionStageSetAndMove</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">fStartPosDelta</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">fGoalPosDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">fDelta</span><span class="o">:=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">bResetDone</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bSetDone</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bMotionStarted</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bMoveDone</span><span class="o">=&gt;</span>
<span class="p">);</span>

<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve reached the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMotionStageSetAndMove</span><span class="o">.</span><span class="n">bMoveDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout should have occurred. Move should have been unable to complete.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbMotionStageSetAndMove</span><span class="o">.</span><span class="n">bSetDone</span><span class="p">,</span>
        <span class="s1">&#39;Position was never set.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbMotionStageSetAndMove</span><span class="o">.</span><span class="n">bMotionStarted</span><span class="p">,</span>
        <span class="s1">&#39;Move was never commanded.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">fStartPosDelta</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Bounds failed to persist after falling out of state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault should have triggered with unknown state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fStartPosDelta</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">AND</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fStartPosDelta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="n">THEN</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
            <span class="s1">&#39;Backward should be disabled.&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
            <span class="s1">&#39;Forward should be enabled.&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="n">ELSIF</span> <span class="n">fStartPosDelta</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">AND</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fStartPosDelta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="n">THEN</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
            <span class="s1">&#39;Backward should be enabled.&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
            <span class="s1">&#39;Forward should be disabled.&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
            <span class="s1">&#39;Forward should be enabled.&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
            <span class="s1">&#39;Backward should be enabled.&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="n">END_IF</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestDisabled</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestDisabled&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">below</span> <span class="n">the</span> <span class="n">goal</span><span class="s1">&#39;s range</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve set the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Position was not set correctly&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward disabled when fb is supposed to be disabled&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward disabled when fb is supposed to be disabled&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestInvalid</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestInvalid&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Faulted prior to test&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">The</span> <span class="n">invalid</span> <span class="n">state</span> <span class="n">should</span> <span class="n">give</span> <span class="n">us</span> <span class="n">a</span> <span class="n">fault</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nInvalidState</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Invalid state did not fault&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestLimits</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestLimits&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Kill</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">switches</span> <span class="k">for</span> <span class="n">this</span> <span class="n">test</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">at</span> <span class="n">the</span> <span class="n">goal</span> <span class="n">state</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve set the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Position was not set correctly&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward enabled with limit hit&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward enabled with limit hit&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestMoveAt</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestMoveAt&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span> <span class="n">which</span> <span class="n">should</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">real</span> <span class="n">move</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
    <span class="n">eStatePMPSStatus</span><span class="o">:=</span><span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">AT_STATE</span><span class="p">,</span>
    <span class="n">bTransitionAuthorized</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">below</span> <span class="n">the</span> <span class="n">goal</span><span class="s1">&#39;s range, and move to the goal</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve reached the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bMoveDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not reach the goal position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward disabled when at goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward disabled when at goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestMoveTo</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestMoveTo&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span> <span class="n">which</span> <span class="n">should</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">real</span> <span class="n">move</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
    <span class="n">eStatePMPSStatus</span><span class="o">:=</span><span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">TRANSITION</span><span class="p">,</span>
    <span class="n">bTransitionAuthorized</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">below</span> <span class="n">the</span> <span class="n">goal</span><span class="s1">&#39;s range, and move to the goal</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve reached the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bMoveDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not reach the goal position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward disabled when at goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward disabled when at goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestNotUpdated</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestNotUpdated&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Faulted prior to test&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">The</span> <span class="n">invalid</span> <span class="n">state</span> <span class="n">should</span> <span class="n">give</span> <span class="n">us</span> <span class="n">a</span> <span class="n">fault</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nNotUpdatedState</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Not updated state did not fault&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-statepmpsstatus">E_StatePMPSStatus</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstagesetandmovehelper">FB_MotionStageSetAndMoveHelper</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenables">FB_StatePMPSEnables</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove">FB_TestHelperSetAndMove</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statepmpsenablesnd">
<h2>FB_StatePMPSEnablesND<a class="headerlink" href="#fb-statepmpsenablesnd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StatePMPSEnablesND</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">virtual</span> <span class="n">limit</span> <span class="n">enables</span> <span class="n">using</span> <span class="n">MC_POWER</span> <span class="k">for</span> <span class="n">multidimensional</span> <span class="n">state</span> <span class="n">movers</span><span class="o">.</span>
    <span class="n">It</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">building</span> <span class="n">block</span> <span class="ow">not</span> <span class="n">meant</span> <span class="k">for</span> <span class="n">use</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">lcls</span><span class="o">-</span><span class="n">twintcat</span><span class="o">-</span><span class="n">motion</span><span class="o">.</span>

    <span class="n">Each</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">a</span> <span class="n">virtual</span> <span class="s2">&quot;allowed&quot;</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">motion</span> <span class="n">based</span> <span class="n">on</span> <span class="n">its</span> <span class="n">goal</span> <span class="n">position</span><span class="o">.</span>
    <span class="n">Motors</span> <span class="n">can</span> <span class="n">move</span> <span class="n">toward</span> <span class="n">their</span> <span class="n">goal</span> <span class="n">delta</span> <span class="n">ranges</span> <span class="ow">or</span> <span class="n">within</span> <span class="n">them</span><span class="p">,</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">away</span> <span class="kn">from</span><span class="w"> </span><span class="nn">these</span> <span class="n">ranges</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motors</span> <span class="k">with</span> <span class="n">a</span> <span class="n">combined</span> <span class="n">N</span><span class="o">-</span><span class="n">dimensional</span> <span class="n">state</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Each</span> <span class="n">motor</span><span class="s1">&#39;s respective position states along its direction</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Hardware</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">problem</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Whether</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">to</span> <span class="n">do</span> <span class="n">anything</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">we</span><span class="s1">&#39;re actually using</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">state</span> <span class="n">that</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">moving</span> <span class="n">to</span><span class="p">,</span> <span class="n">along</span> <span class="n">dimension</span> <span class="mi">2</span> <span class="n">of</span> <span class="n">the</span> <span class="n">position</span> <span class="n">state</span> <span class="n">array</span><span class="o">.</span> <span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="n">the</span> <span class="n">same</span> <span class="k">as</span> <span class="n">the</span> <span class="n">current</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">nGoalStateIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">name</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="n">this</span> <span class="n">state</span> <span class="n">mover</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">case</span> <span class="n">of</span> <span class="n">fast</span> <span class="n">faults</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">put</span> <span class="n">motors</span> <span class="n">into</span> <span class="n">maintenance</span> <span class="n">mode</span><span class="o">.</span> <span class="n">This</span> <span class="n">allows</span> <span class="n">us</span> <span class="n">to</span> <span class="n">freely</span> <span class="n">move</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">at</span> <span class="n">the</span> <span class="n">cost</span> <span class="n">of</span> <span class="n">a</span> <span class="n">fast</span> <span class="n">fault</span><span class="o">.</span>
    <span class="n">bMaintMode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">overal</span> <span class="n">PMPS</span> <span class="n">FB</span> <span class="n">state</span>
    <span class="n">eStatePMPSStatus</span><span class="p">:</span> <span class="n">E_StatePMPSStatus</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Connect</span> <span class="kn">from</span><span class="w"> </span><span class="nn">bptm</span> <span class="n">bTransitionAuthorized</span>
    <span class="n">bTransitionAuthorized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Per</span><span class="o">-</span><span class="n">motor</span> <span class="n">enable</span> <span class="n">state</span> <span class="n">we</span> <span class="n">send</span> <span class="n">to</span> <span class="n">MC_Power</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="k">pass</span><span class="o">-</span><span class="n">through</span> <span class="kn">from</span><span class="w"> </span><span class="nn">stMotionStage.</span>
    <span class="n">abEnabled</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Per</span><span class="o">-</span><span class="n">motor</span> <span class="n">forward</span> <span class="n">enable</span> <span class="n">state</span> <span class="n">we</span> <span class="n">send</span> <span class="n">to</span> <span class="n">MC_Power</span><span class="o">.</span> <span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="k">pass</span><span class="o">-</span><span class="n">through</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">override</span> <span class="n">to</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">abForwardEnabled</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Per</span><span class="o">-</span><span class="n">motor</span> <span class="n">backwards</span> <span class="n">enable</span> <span class="n">state</span> <span class="n">we</span> <span class="n">send</span> <span class="n">to</span> <span class="n">MC_Power</span><span class="o">.</span> <span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="k">pass</span><span class="o">-</span><span class="n">through</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">override</span> <span class="n">to</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">abBackwardEnabled</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Per</span><span class="o">-</span><span class="n">motor</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">goal</span> <span class="n">position</span> <span class="ow">and</span> <span class="n">FALSE</span> <span class="n">otherwise</span><span class="o">.</span> <span class="n">This</span> <span class="n">makes</span> <span class="n">a</span> <span class="n">fast</span> <span class="n">fault</span> <span class="k">if</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">abValidGoal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">arrays</span> <span class="n">have</span> <span class="n">mismatched</span> <span class="n">sizing</span><span class="o">.</span> <span class="n">For</span> <span class="n">this</span> <span class="n">FB</span><span class="p">,</span> <span class="n">this</span> <span class="n">means</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">won</span><span class="s1">&#39;t ever get an enable.</span>
    <span class="n">bMotorCountError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">individual</span> <span class="n">state</span> <span class="n">limit</span> <span class="n">function</span> <span class="n">blocks</span>
    <span class="n">afbStateEnables</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">ffMaint</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">ffProgrammerError</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CheckCount</span><span class="p">();</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMotorCountError</span> <span class="n">THEN</span>
    <span class="n">DoLimits</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">RunFastFaults</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">CheckCount</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">valid</span> <span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">,</span> <span class="n">less</span> <span class="ow">or</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">max</span><span class="p">)</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&gt;</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">DoLimits</span><span class="p">:</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">afbStateEnables</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnable</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bMaintMode</span><span class="p">,</span>
        <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalStateIndex</span><span class="p">,</span>
        <span class="n">eStatePMPSStatus</span><span class="o">:=</span><span class="n">eStatePMPSStatus</span><span class="p">,</span>
        <span class="n">bTransitionAuthorized</span><span class="o">:=</span><span class="n">bTransitionAuthorized</span><span class="p">,</span>
        <span class="n">bEnabled</span><span class="o">=&gt;</span><span class="n">abEnabled</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">bForwardEnabled</span><span class="o">=&gt;</span><span class="n">abForwardEnabled</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">bBackwardEnabled</span><span class="o">=&gt;</span><span class="n">abBackwardEnabled</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">bValidGoal</span><span class="o">=&gt;</span><span class="n">abValidGoal</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">RunFastFaults</span><span class="p">:</span>
<span class="n">ffMaint</span><span class="p">(</span>
    <span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bMaintMode</span><span class="p">,</span>
    <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Device is in maintenance mode&#39;</span><span class="p">,</span>
    <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">MAINT_MODE</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">ffProgrammerError</span><span class="p">(</span>
    <span class="n">i_xOK</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bMotorCountError</span><span class="p">,</span>
    <span class="n">i_xAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_DevName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">i_Desc</span><span class="o">:=</span><span class="s1">&#39;Programmer error picking motor count&#39;</span><span class="p">,</span>
    <span class="n">i_TypeCode</span><span class="o">:=</span><span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">INTERNAL_ERROR</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#e-statepmpsstatus">E_StatePMPSStatus</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenables">FB_StatePMPSEnables</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statepmpsenablesnd-test">
<h2>FB_StatePMPSEnablesND_Test<a class="headerlink" href="#fb-statepmpsenablesnd-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StatePMPSEnablesND_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Unit</span> <span class="n">tests</span> <span class="k">for</span> <span class="n">FB_StatePMPSEnablesND</span>
    <span class="n">I</span><span class="s1">&#39;m confident that FB_StatePMPSEnables was tested in FB_StatePMPSEnables_Test</span>
    <span class="n">There</span> <span class="n">will</span> <span class="n">be</span> <span class="n">one</span> <span class="n">core</span> <span class="n">functionality</span> <span class="n">check</span>
    <span class="n">Then</span><span class="p">,</span> <span class="n">the</span> <span class="n">rest</span> <span class="n">will</span> <span class="n">be</span> <span class="n">about</span> <span class="n">the</span> <span class="n">ND</span> <span class="n">feature</span> <span class="n">adds</span><span class="o">.</span>
    <span class="n">Full</span> <span class="n">checks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Core</span> <span class="n">motors</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">goal</span> <span class="n">can</span><span class="s1">&#39;t move away check</span>
    <span class="o">-</span> <span class="n">bMaintMode</span> <span class="o">=</span> <span class="n">no</span> <span class="n">move</span> <span class="n">restrictions</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">motors</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">bMaintMode</span> <span class="o">=</span> <span class="n">fast</span> <span class="n">fault</span>
    <span class="o">-</span> <span class="n">Wrong</span> <span class="n">count</span> <span class="o">=</span> <span class="n">fast</span> <span class="n">fault</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Spoof</span> <span class="n">motor</span> <span class="n">enables</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bAllForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bAllBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="o">//</span> <span class="n">Note</span><span class="p">:</span> <span class="n">the</span> <span class="n">fake</span> <span class="n">motors</span> <span class="n">show</span> <span class="k">as</span> <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">so</span> <span class="n">they</span> <span class="n">will</span> <span class="n">be</span> <span class="n">over</span><span class="o">/</span><span class="n">under</span> <span class="n">the</span> <span class="n">goals</span> <span class="n">here</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">afbInternal</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
<span class="p">);</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">10</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">afbInternal</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
<span class="p">);</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>

<span class="n">TestUnderOverGoals</span><span class="p">();</span>
<span class="n">TestMaint</span><span class="p">();</span>
<span class="n">TestCount</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestCount</span>
<span class="n">VAR_INST</span>
    <span class="n">fbEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnablesND</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestCount&#39;</span><span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">No</span> <span class="n">faults</span> <span class="n">please</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Had faults prior to test&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbEnables</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestUnderOverGoals&#39;</span><span class="p">,</span>
    <span class="n">bMaintMode</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Must</span> <span class="n">fault</span> <span class="k">with</span> <span class="n">bad</span> <span class="n">count</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Had no fault with bad count&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestMaint</span>
<span class="n">VAR_INST</span>
    <span class="n">fbEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnablesND</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestMaint&#39;</span><span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">No</span> <span class="n">faults</span> <span class="n">please</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Had faults prior to test&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbEnables</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestUnderOverGoals&#39;</span><span class="p">,</span>
    <span class="n">bMaintMode</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Must</span> <span class="n">fault</span> <span class="ow">in</span> <span class="n">maint</span> <span class="n">mode</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Had no fault in maintenance mode&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">All</span> <span class="n">overrides</span> <span class="n">should</span> <span class="n">be</span> <span class="n">relaxed</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abForwardEnabled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;In maintenance mode, we should be able to move anywhere&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abBackwardEnabled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;In maintenance mode, we should be able to move anywhere&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abForwardEnabled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;In maintenance mode, we should be able to move anywhere&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abBackwardEnabled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;In maintenance mode, we should be able to move anywhere&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestUnderOverGoals</span>
<span class="n">VAR_INST</span>
    <span class="n">fbEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnablesND</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestUnderOverGoals&#39;</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Cannot</span> <span class="n">run</span> <span class="n">this</span> <span class="n">test</span> <span class="n">until</span> <span class="n">the</span> <span class="n">one</span><span class="o">-</span><span class="n">time</span><span class="o">-</span><span class="n">setup</span> <span class="n">runs</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbEnables</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestUnderOverGoals&#39;</span><span class="p">,</span>
    <span class="n">bMaintMode</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">No</span> <span class="n">faults</span> <span class="n">please</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Had faults in normal situation&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">All</span> <span class="n">core</span> <span class="n">enables</span> <span class="n">are</span> <span class="n">true</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">,</span>
    <span class="s1">&#39;Core enables should be TRUE&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bAllBackwardEnable</span><span class="p">,</span>
    <span class="s1">&#39;Core enables should be TRUE&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">,</span>
    <span class="s1">&#39;Core enables should be TRUE&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bAllBackwardEnable</span><span class="p">,</span>
    <span class="s1">&#39;Core enables should be TRUE&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">But</span> <span class="n">the</span> <span class="n">overrides</span> <span class="n">force</span> <span class="n">us</span> <span class="n">to</span> <span class="n">move</span> <span class="n">toward</span> <span class="n">the</span> <span class="n">goal</span>
<span class="o">//</span> <span class="n">Motor</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">below</span> <span class="n">the</span> <span class="n">goal</span><span class="p">,</span> <span class="n">Motor</span> <span class="mi">2</span> <span class="ow">is</span> <span class="n">above</span> <span class="n">the</span> <span class="n">goal</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abForwardEnabled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;Motor 1 should be able to move up to the goal&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abBackwardEnabled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;Motor 1 should not be able to move down away from the goal&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abForwardEnabled</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="s1">&#39;Motor 2 should not be able to move up away from the goal&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abBackwardEnabled</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="s1">&#39;Motor 2 should be able to move down to the goal&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenables">FB_StatePMPSEnables</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenablesnd">FB_StatePMPSEnablesND</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenables-test">FB_StatePMPSEnables_Test</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-stateptpmove">
<h2>FB_StatePTPMove<a class="headerlink" href="#fb-stateptpmove" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionStateMove instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StatePTPMove</span>
<span class="o">//</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span><span class="p">,</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">deprecated</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GO</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">bMoveOk</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">AT_STATE</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bAtState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DMOV</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BUSY</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRMSG</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">sError</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bExecTrig</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bExecEnd</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">fActPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fLowPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fHighPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bExecTrig</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">bExecTrig</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">bMoveOk</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCommand</span> <span class="o">:=</span> <span class="n">E_EpicsMotorCmd</span><span class="o">.</span><span class="n">MOVE_ABSOLUTE</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fAccel</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fDeceleration</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDecel</span><span class="p">;</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>
<span class="n">bError</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">sError</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">;</span>

<span class="n">fActPosition</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
<span class="n">fLowPos</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">fHighPos</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">fLowPos</span> <span class="o">&lt;</span> <span class="n">fActPosition</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">fHighPos</span> <span class="o">&gt;</span> <span class="n">fActPosition</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bAtState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">bAtState</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bExecEnd</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">bExecEnd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemove">FB_PositionStateMove</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statesetuphelper">
<h2>FB_StateSetupHelper<a class="headerlink" href="#fb-statesetuphelper" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StateSetupHelper</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">helper</span> <span class="k">for</span> <span class="n">setting</span> <span class="n">up</span> <span class="n">large</span> <span class="n">numbers</span> <span class="n">of</span> <span class="n">ST_PositionState</span> <span class="n">instances</span><span class="o">.</span>

    <span class="n">This</span> <span class="ow">is</span> <span class="n">typically</span> <span class="n">verbose</span> <span class="n">to</span> <span class="n">do</span> <span class="n">by</span> <span class="n">hand</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">normal</span> <span class="n">ways</span> <span class="ow">and</span> <span class="n">can</span> <span class="n">be</span> <span class="n">error</span><span class="o">-</span><span class="n">prone</span><span class="o">.</span>

    <span class="n">Calling</span> <span class="k">with</span> <span class="n">bSetDefault</span><span class="o">:=</span><span class="n">TRUE</span> <span class="n">will</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">default</span> <span class="n">values</span> <span class="n">to</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">values</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="nb">input</span> <span class="n">stPositionState</span><span class="o">.</span> <span class="n">Note</span> <span class="n">that</span> <span class="n">the</span> <span class="n">other</span> <span class="n">args</span> <span class="n">will</span> <span class="n">be</span> <span class="n">ignored</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">case</span><span class="o">.</span>
    <span class="n">This</span> <span class="n">must</span> <span class="n">be</span> <span class="n">done</span> <span class="n">at</span> <span class="n">least</span> <span class="n">once</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">forget</span> <span class="n">to</span> <span class="n">do</span> <span class="n">this</span><span class="p">,</span> <span class="n">there</span> <span class="n">will</span> <span class="n">be</span> <span class="n">a</span> <span class="n">warning</span> <span class="ow">and</span>
    <span class="n">bValid</span> <span class="n">will</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">making</span> <span class="n">it</span> <span class="n">so</span> <span class="n">we</span> <span class="n">cannot</span> <span class="n">move</span> <span class="n">to</span> <span class="n">that</span> <span class="n">state</span><span class="o">.</span>

    <span class="n">Calling</span> <span class="n">without</span> <span class="n">bSetDefault</span> <span class="ow">or</span> <span class="k">with</span> <span class="n">it</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">FALSE</span> <span class="n">will</span> <span class="n">apply</span> <span class="n">values</span> <span class="n">to</span> <span class="n">the</span>
    <span class="nb">input</span> <span class="n">stPositionState</span> <span class="k">with</span> <span class="n">the</span> <span class="n">following</span> <span class="n">priority</span> <span class="n">order</span><span class="p">:</span>

    <span class="mf">1.</span> <span class="n">The</span> <span class="n">value</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">function</span> <span class="n">block</span> <span class="n">call</span>
    <span class="mf">2.</span> <span class="n">The</span> <span class="n">value</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">template</span> <span class="n">stPositionState</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">most</span> <span class="n">recent</span>
       <span class="n">call</span> <span class="k">with</span> <span class="n">bSetDefault</span><span class="o">:=</span><span class="n">TRUE</span>
    <span class="mf">3.</span> <span class="n">The</span> <span class="n">original</span> <span class="n">default</span> <span class="n">value</span> <span class="k">as</span> <span class="n">defined</span> <span class="n">on</span> <span class="n">ST_PositionState</span>

    <span class="n">For</span> <span class="n">ease</span> <span class="n">of</span> <span class="n">use</span><span class="p">,</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">EPICS</span> <span class="n">writes</span> <span class="k">if</span> <span class="n">unlocked</span><span class="p">,</span> <span class="ow">and</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">repeated</span>
    <span class="bp">self</span><span class="o">-</span><span class="n">overwrites</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">encoder</span> <span class="n">count</span> <span class="n">use</span> <span class="n">case</span><span class="p">,</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">will</span> <span class="ow">not</span>
    <span class="n">reapply</span> <span class="n">the</span> <span class="n">values</span> <span class="n">to</span> <span class="n">the</span> <span class="n">same</span> <span class="n">state</span> <span class="n">again</span> <span class="n">after</span> <span class="n">the</span> <span class="n">state</span> <span class="n">has</span> <span class="n">been</span> <span class="n">fully</span>
    <span class="n">initialized</span> <span class="n">by</span> <span class="n">the</span> <span class="n">states</span> <span class="n">function</span> <span class="n">blocks</span><span class="p">,</span> <span class="k">as</span> <span class="n">determined</span> <span class="n">by</span> <span class="n">the</span> <span class="n">bUpdated</span> <span class="n">struct</span>
    <span class="n">member</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">reapply</span> <span class="n">every</span> <span class="n">cycle</span> <span class="n">you</span> <span class="n">can</span>
    <span class="nb">set</span> <span class="n">bForceUpdate</span> <span class="n">to</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">but</span> <span class="n">it</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">recommended</span><span class="o">.</span> <span class="n">Without</span> <span class="n">this</span> <span class="n">feature</span><span class="p">,</span>
    <span class="n">you</span> <span class="n">would</span> <span class="n">be</span> <span class="n">required</span> <span class="n">to</span> <span class="n">wrap</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">guard</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">it</span>
    <span class="n">was</span> <span class="n">only</span> <span class="n">called</span> <span class="n">once</span> <span class="n">per</span> <span class="n">state</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">fairly</span> <span class="n">annoying</span><span class="o">.</span>

    <span class="n">Example</span> <span class="n">expected</span> <span class="n">usage</span><span class="p">:</span>
    <span class="n">VAR</span>
        <span class="n">fbStateSetup</span><span class="p">:</span> <span class="n">FB_StateSetupHelper</span><span class="p">;</span>
        <span class="n">stDefault</span><span class="p">:</span> <span class="n">ST_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
            <span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
            <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span>
        <span class="p">);</span>
        <span class="n">astStates1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
        <span class="n">astStates2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
        <span class="n">astStates2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">END_VAR</span>

    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stDefault</span><span class="p">,</span> <span class="n">bSetDefault</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;YAG&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mi">20</span><span class="p">);</span>
    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;TT&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mi">30</span><span class="p">);</span>

    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=-</span><span class="mi">30</span><span class="p">);</span>
    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;YAG&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mi">35</span><span class="p">);</span>
    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates2</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;TT&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mi">70</span><span class="p">);</span>

    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">fDelta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">);</span>
    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates3</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;YAG&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mf">2.3</span><span class="p">,</span> <span class="n">fDelta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">);</span>
    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates3</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;TT&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mf">5.6</span><span class="p">,</span> <span class="n">fDelta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">;</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bSetDefault</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bForceUpdate</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nEncoderCount</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">fDelta</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fAccel</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fDecel</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bMoveOk</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLocked</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bValid</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bUseRawCounts</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sPmpsState</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">stDefault</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbWarning</span><span class="p">:</span> <span class="n">FB_LogMessage</span><span class="p">;</span>
    <span class="n">bHasDefault</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHasWarned</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sJson</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bSetDefault</span> <span class="n">THEN</span>
    <span class="n">bSetDefault</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bHasDefault</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stDefault</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">bForceUpdate</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bUpdated</span> <span class="n">THEN</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="n">sName</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fPosition</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">nEncoderCount</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">fVelocity</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">fAccel</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">:=</span> <span class="n">fDecel</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">bMoveOk</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">bLocked</span> <span class="o">:=</span> <span class="n">bLocked</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">bValid</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">bUseRawCounts</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="n">sPmpsState</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bHasDefault</span> <span class="n">THEN</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bHasWarned</span> <span class="n">THEN</span>
            <span class="n">bHasWarned</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">sJson</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;{&quot;sName&quot;: &quot;&#39;</span><span class="p">,</span> <span class="n">sName</span><span class="p">),</span> <span class="s1">&#39;&quot;, &quot;sPmpsState&quot;: &quot;&#39;</span><span class="p">),</span> <span class="n">sPmpsState</span><span class="p">),</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">);</span>
            <span class="n">fbWarning</span><span class="p">(</span>
                <span class="n">sMsg</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Did not initialize any defaults in FB_StateSetupHelper! Some states are disabled, check your code! &#39;</span><span class="p">,</span> <span class="n">sJson</span><span class="p">),</span>
                <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">,</span>
                <span class="n">eSubSystem</span><span class="o">:=</span><span class="n">E_Subsystem</span><span class="o">.</span><span class="n">MOTION</span><span class="p">,</span>
                <span class="n">sJson</span><span class="o">:=</span><span class="n">sJson</span><span class="p">,</span>
            <span class="p">);</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Overwrite</span> <span class="n">the</span> <span class="nb">input</span> <span class="n">args</span> <span class="n">so</span> <span class="n">that</span> <span class="n">unset</span> <span class="n">args</span> <span class="n">are</span> <span class="n">the</span> <span class="n">defaults</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">call</span>
<span class="n">sName</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">sName</span><span class="p">;</span>
<span class="n">fPosition</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
<span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">nEncoderCount</span><span class="p">;</span>
<span class="n">fDelta</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
<span class="n">fAccel</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">fAccel</span><span class="p">;</span>
<span class="n">fDecel</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">fDecel</span><span class="p">;</span>
<span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">bMoveOk</span><span class="p">;</span>
<span class="n">bLocked</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">bLocked</span><span class="p">;</span>
<span class="n">bValid</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">bValid</span><span class="p">;</span>
<span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">bUseRawCounts</span><span class="p">;</span>
<span class="n">sPmpsState</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statesetuphelper-test">
<h2>FB_StateSetupHelper_Test<a class="headerlink" href="#fb-statesetuphelper-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_StateSetupHelper_Test EXTENDS FB_TestSuite
VAR
    astStates: ARRAY[1..10] OF ST_PositionState;
    stDefaultDefault: ST_PositionState;
END_VAR
TestNormalCase();
TestDefaultOnly();
TestManyOverrides();
TestNoDefault();
TestOnlyOnce();

END_FUNCTION_BLOCK

METHOD TestDefaultOnly
VAR
    fbStateSetup: FB_StateSetupHelper;
    stDefault: ST_PositionState := (
        sName := &#39;DEFAULT&#39;,
        fPosition := 100,
        nEncoderCount := 200,
        fDelta := 0.5,
        fVelocity := 10,
        fAccel := 12,
        fDecel := 24,
        bMoveOk := TRUE,
        bLocked := TRUE,
        bValid := TRUE,
        bUseRawCounts := TRUE
    );
    stOriginal: ST_PositionState;
    stTarget: ST_PositionState;
END_VAR
TEST(&#39;TestDefaultOnly&#39;);

// Add a pmps key
stDefault.stPMPS.sPmpsState := &#39;KEY&#39;;
// Cache the defaults to use as the check in case stDefault gets mutated by a bug
stOriginal := stDefault;
// Apply only defaults
fbStateSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbStateSetup(stPositionState:=stTarget);
// Check everything
AssertEquals_STRING(stOriginal.sName, stTarget.sName, &#39;Wrong sName&#39;);
AssertEquals_LREAL(stOriginal.fPosition, stTarget.fPosition, 0, &#39;Wrong fPosition&#39;);
AssertEquals_UDINT(stOriginal.nEncoderCount, stTarget.nEncoderCount, &#39;Wrong nEncoderCount&#39;);
AssertEquals_LREAL(stOriginal.fDelta, stTarget.fDelta, 0, &#39;Wrong fDelta&#39;);
AssertEquals_LREAL(stOriginal.fVelocity, stTarget.fVelocity, 0, &#39;Wrong fVelocity&#39;);
AssertEquals_LREAL(stOriginal.fAccel, stTarget.fAccel, 0, &#39;Wrong fAccel&#39;);
AssertEquals_LREAL(stOriginal.fDecel, stTarget.fDecel, 0, &#39;Wrong fDecel&#39;);
AssertEquals_BOOL(stOriginal.bMoveOk, stTarget.bMoveOk, &#39;Wrong bMoveOk&#39;);
AssertEquals_BOOL(stOriginal.bLocked, stTarget.bLocked, &#39;Wrong bLocked&#39;);
AssertEquals_BOOL(stOriginal.bValid, stTarget.bValid, &#39;Wrong bValid&#39;);
AssertEquals_BOOL(stOriginal.bUseRawCounts, stTarget.bUseRawCounts, &#39;Wrong bUseRawCounts&#39;);
AssertEquals_STRING(stOriginal.stPMPS.sPmpsState, stTarget.stPMPS.sPmpsState, &#39;Wrong sPmpsState&#39;);

TEST_FINISHED();
END_METHOD

METHOD TestManyOverrides
VAR
    fbStateSetup: FB_StateSetupHelper;
    stDefault: ST_PositionState := (
        sName := &#39;POTATO&#39;,
        fPosition := 23,
        fDelta := 0.5,
        fVelocity := 10
    );
    stOne: ST_PositionState;
    stTwo: ST_PositionState;
END_VAR
TEST(&#39;TestManyOverrides&#39;);
// This is the case where the defaults are always overriden

fbStateSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbStateSetup(stPositionState:=stOne, sName:=&#39;ONE&#39;, fPosition:=10, fDelta:=0.1, fVelocity:=20);
fbStateSetup(stPositionState:=stTWO, sName:=&#39;TWO&#39;, fPosition:=30, fDelta:=0.23, fVelocity:=4);

// Check Everything
AssertEquals_STRING(&#39;ONE&#39;, stOne.sName, &#39;Wrong sName in state 1&#39;);
AssertEquals_LREAL(10, stOne.fPosition, 0, &#39;Wrong fPosition in state 1&#39;);
AssertEquals_UDINT(stDefaultDefault.nEncoderCount, stOne.nEncoderCount, &#39;Wrong nEncoderCount in state 1&#39;);
AssertEquals_LREAL(0.1, stOne.fDelta, 0, &#39;Wrong fDelta in state 1&#39;);
AssertEquals_LREAL(20, stOne.fVelocity, 0, &#39;Wrong fVelocity in state 1&#39;);
AssertEquals_LREAL(stDefaultDefault.fAccel, stOne.fAccel, 0, &#39;Wrong fAccel in state 1&#39;);
AssertEquals_LREAL(stDefaultDefault.fDecel, stOne.fDecel, 0, &#39;Wrong fDecel in state 1&#39;);
AssertEquals_BOOL(stDefaultDefault.bMoveOk, stOne.bMoveOk, &#39;Wrong bMoveOk in state 1&#39;);
AssertEquals_BOOL(stDefaultDefault.bLocked, stOne.bLocked, &#39;Wrong bLocked in state 1&#39;);
AssertEquals_BOOL(stDefaultDefault.bValid, stOne.bValid, &#39;Wrong bValid in state 1&#39;);
AssertEquals_BOOL(stDefaultDefault.bUseRawCounts, stOne.bUseRawCounts, &#39;Wrong bUseRawCounts in state 1&#39;);
AssertEquals_STRING(stDefaultDefault.stPMPS.sPmpsState, stOne.stPMPS.sPmpsState, &#39;Wrong sPmpsState in state 1&#39;);

AssertEquals_STRING(&#39;TWO&#39;, stTwo.sName, &#39;Wrong sName in state 2&#39;);
AssertEquals_LREAL(30, stTwo.fPosition, 0, &#39;Wrong fPosition in state 2&#39;);
AssertEquals_UDINT(stDefaultDefault.nEncoderCount, stTwo.nEncoderCount, &#39;Wrong nEncoderCount in state 2&#39;);
AssertEquals_LREAL(0.23, stTwo.fDelta, 0, &#39;Wrong fDelta in state 2&#39;);
AssertEquals_LREAL(4, stTwo.fVelocity, 0, &#39;Wrong fVelocity in state 2&#39;);
AssertEquals_LREAL(stDefaultDefault.fAccel, stTwo.fAccel, 0, &#39;Wrong fAccel in state 2&#39;);
AssertEquals_LREAL(stDefaultDefault.fDecel, stTwo.fDecel, 0, &#39;Wrong fDecel in state 2&#39;);
AssertEquals_BOOL(stDefaultDefault.bMoveOk, stTwo.bMoveOk, &#39;Wrong bMoveOk in state 2&#39;);
AssertEquals_BOOL(stDefaultDefault.bLocked, stTwo.bLocked, &#39;Wrong bLocked in state 2&#39;);
AssertEquals_BOOL(stDefaultDefault.bValid, stTwo.bValid, &#39;Wrong bValid in state 2&#39;);
AssertEquals_BOOL(stDefaultDefault.bUseRawCounts, stTwo.bUseRawCounts, &#39;Wrong bUseRawCounts in state 2&#39;);
AssertEquals_STRING(stDefaultDefault.stPMPS.sPmpsState, stTwo.stPMPS.sPmpsState, &#39;Wrong sPmpsState in state 2&#39;);

TEST_FINISHED();
END_METHOD

METHOD TestNoDefault
VAR
    fbStateSetup: FB_StateSetupHelper;
    stTarget: ST_PositionState;
END_VAR
TEST(&#39;TestNoDefault&#39;);
// No default = invalid state + warning log message

fbStateSetup(stPositionState:=stTarget, sName:=&#39;TestNoDefault&#39;, sPmpsState:=&#39;TestPMPS&#39;, bValid:=TRUE);
// Only bValid matters, it must not be valid!
AssertFalse(stTarget.bValid, &#39;bValid should be FALSE with no default set.&#39;);

TEST_FINISHED();
END_METHOD

METHOD TestNormalCase
VAR
    fbStateSetup: FB_StateSetupHelper;
    stDefault: ST_PositionState;
END_VAR
VAR CONSTANT
    cDelta: LREAL := 0.5;
    cVelocity: LREAL := 10;
    cMoveOk: BOOL := TRUE;
    cValid: BOOL := TRUE;
END_VAR
TEST(&#39;TestNormalCase&#39;);
// Mimic what I might do in a real project

stDefault.fDelta := cDelta;
stDefault.fVelocity := cVelocity;
stDefault.bMoveOk := cMoveOk;
stDefault.bValid := cValid;

fbStateSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbStateSetup(stPositionState:=astStates[1], sName:=&#39;OUT&#39;, fPosition:=10, sPmpsState:=&#39;FAKE_OUT&#39;);
fbStateSetup(stPositionState:=astStates[2], sName:=&#39;YAG&#39;, fPosition:=20, sPmpsState:=&#39;FAKE_YAG&#39;);
fbStateSetup(stPositionState:=astStates[3], sName:=&#39;TT&#39;, fPosition:=30, sPmpsState:=&#39;FAKE_TT&#39;);

// Check everything
AssertEquals_STRING(&#39;OUT&#39;, astStates[1].sName, &#39;Wrong sName in state 1&#39;);
AssertEquals_LREAL(10, astStates[1].fPosition, 0, &#39;Wrong fPosition in state 1&#39;);
AssertEquals_UDINT(stDefaultDefault.nEncoderCount, astStates[1].nEncoderCount, &#39;Wrong nEncoderCount in state 1&#39;);
AssertEquals_LREAL(cDelta, astStates[1].fDelta, 0, &#39;Wrong fDelta in state 1&#39;);
AssertEquals_LREAL(cVelocity, astStates[1].fVelocity, 0, &#39;Wrong fVelocity in state 1&#39;);
AssertEquals_LREAL(stDefaultDefault.fAccel, astStates[1].fAccel, 0, &#39;Wrong fAccel in state 1&#39;);
AssertEquals_LREAL(stDefaultDefault.fDecel, astStates[1].fDecel, 0, &#39;Wrong fDecel in state 1&#39;);
AssertEquals_BOOL(cMoveOk, astStates[1].bMoveOk, &#39;Wrong bMoveOk in state 1&#39;);
AssertEquals_BOOL(stDefaultDefault.bLocked, astStates[1].bLocked, &#39;Wrong bLocked in state 1&#39;);
AssertEquals_BOOL(cValid, astStates[1].bValid, &#39;Wrong bValid in state 1&#39;);
AssertEquals_BOOL(stDefaultDefault.bUseRawCounts, astStates[1].bUseRawCounts, &#39;Wrong bUseRawCounts in state 1&#39;);
AssertEquals_STRING(&#39;FAKE_OUT&#39;, astStates[1].stPMPS.sPmpsState, &#39;Wrong sPmpsState in state 1&#39;);

AssertEquals_STRING(&#39;YAG&#39;, astStates[2].sName, &#39;Wrong sName in state 2&#39;);
AssertEquals_LREAL(20, astStates[2].fPosition, 0, &#39;Wrong fPosition in state 2&#39;);
AssertEquals_UDINT(stDefaultDefault.nEncoderCount, astStates[2].nEncoderCount, &#39;Wrong nEncoderCount in state 2&#39;);
AssertEquals_LREAL(cDelta, astStates[2].fDelta, 0, &#39;Wrong fDelta in state 2&#39;);
AssertEquals_LREAL(cVelocity, astStates[2].fVelocity, 0, &#39;Wrong fVelocity in state 2&#39;);
AssertEquals_LREAL(stDefaultDefault.fAccel, astStates[2].fAccel, 0, &#39;Wrong fAccel in state 2&#39;);
AssertEquals_LREAL(stDefaultDefault.fDecel, astStates[2].fDecel, 0, &#39;Wrong fDecel in state 2&#39;);
AssertEquals_BOOL(cMoveOk, astStates[2].bMoveOk, &#39;Wrong bMoveOk in state 2&#39;);
AssertEquals_BOOL(stDefaultDefault.bLocked, astStates[2].bLocked, &#39;Wrong bLocked in state 2&#39;);
AssertEquals_BOOL(cValid, astStates[2].bValid, &#39;Wrong bValid in state 2&#39;);
AssertEquals_BOOL(stDefaultDefault.bUseRawCounts, astStates[2].bUseRawCounts, &#39;Wrong bUseRawCounts in state 2&#39;);
AssertEquals_STRING(&#39;FAKE_YAG&#39;, astStates[2].stPMPS.sPmpsState, &#39;Wrong sPmpsState in state 2&#39;);

AssertEquals_STRING(&#39;TT&#39;, astStates[3].sName, &#39;Wrong sName in state 3&#39;);
AssertEquals_LREAL(30, astStates[3].fPosition, 0, &#39;Wrong fPosition in state 3&#39;);
AssertEquals_UDINT(stDefaultDefault.nEncoderCount, astStates[3].nEncoderCount, &#39;Wrong nEncoderCount in state 3&#39;);
AssertEquals_LREAL(cDelta, astStates[3].fDelta, 0, &#39;Wrong fDelta in state 3&#39;);
AssertEquals_LREAL(cVelocity, astStates[3].fVelocity, 0, &#39;Wrong fVelocity in state 3&#39;);
AssertEquals_LREAL(stDefaultDefault.fAccel, astStates[3].fAccel, 0, &#39;Wrong fAccel in state 3&#39;);
AssertEquals_LREAL(stDefaultDefault.fDecel, astStates[3].fDecel, 0, &#39;Wrong fDecel in state 3&#39;);
AssertEquals_BOOL(cMoveOk, astStates[3].bMoveOk, &#39;Wrong bMoveOk in state 3&#39;);
AssertEquals_BOOL(stDefaultDefault.bLocked, astStates[3].bLocked, &#39;Wrong bLocked in state 3&#39;);
AssertEquals_BOOL(cValid, astStates[3].bValid, &#39;Wrong bValid in state 3&#39;);
AssertEquals_BOOL(stDefaultDefault.bUseRawCounts, astStates[3].bUseRawCounts, &#39;Wrong bUseRawCounts in state 3&#39;);
AssertEquals_STRING(&#39;FAKE_TT&#39;, astStates[3].stPMPS.sPmpsState, &#39;Wrong sPmpsState in state 3&#39;);

TEST_FINISHED();
END_METHOD

METHOD TestOnlyOnce
VAR
    fbStateSetup: FB_StateSetupHelper;
    stDefault: ST_PositionState;
    stTarget: ST_PositionState;
END_VAR
TEST(&#39;TestOnlyOnce&#39;);

// Required call, even though we don&#39;t need anything here
fbStateSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
// Start with no position
AssertEquals_LREAL(stTarget.fPosition, 0, 0, &#39;Start position sanity check failed&#39;);
// Apply a new position
fbStateSetup(stPositionState:=stTarget, fPosition:=10);
AssertEquals_LREAL(stTarget.fPosition, 10, 0, &#39;Basic set position failed&#39;);
// Simulate the position state being used and updated via EPICS or otherwise
stTarget.bUpdated := TRUE; // Set by FB_PositionStateInternal
stTarget.fPosition := 12; // Someone tweaked the value in EPICS
// Run through the state setup again
fbStateSetup(stPositionState:=stTarget, fPosition:=10);
// But we should still be at position 12
AssertEquals_LREAL(stTarget.fPosition, 12, 0, &#39;FB_StateSetupHelper ran twice!&#39;);
// Unless we override the behavior
fbStateSetup(stPositionState:=stTarget, bForceUpdate:=TRUE, fPosition:=10);
AssertEquals_LREAL(stTarget.fPosition, 10, 0, &#39;bForceUpdate failed&#39;);

TEST_FINISHED();
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-statesetuphelper">FB_StateSetupHelper</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statesinputhandler">
<h2>FB_StatesInputHandler<a class="headerlink" href="#fb-statesinputhandler" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StatesInputHandler</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Handle</span> <span class="n">the</span> <span class="n">state</span> <span class="n">enum</span> <span class="n">EPICS</span> <span class="nb">input</span> <span class="k">for</span> <span class="nb">any</span> <span class="n">of</span> <span class="n">the</span> <span class="n">ND</span> <span class="n">state</span> <span class="n">function</span> <span class="n">blocks</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">desired</span> <span class="n">behavior</span> <span class="ow">is</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Trigger</span> <span class="n">a</span> <span class="n">move</span> <span class="n">to</span> <span class="n">a</span> <span class="n">new</span> <span class="n">state</span> <span class="n">when</span> <span class="n">the</span> <span class="n">enum</span> <span class="n">PV</span> <span class="ow">is</span> <span class="n">written</span> <span class="n">to</span>
    <span class="o">-</span> <span class="n">Interrupt</span> <span class="n">an</span> <span class="n">ongoing</span> <span class="n">move</span> <span class="k">with</span> <span class="n">a</span> <span class="n">new</span> <span class="n">one</span> <span class="k">if</span> <span class="n">the</span> <span class="n">enum</span> <span class="n">changes</span> <span class="n">mid</span><span class="o">-</span><span class="n">move</span>
    <span class="o">-</span> <span class="n">Stop</span> <span class="n">the</span> <span class="n">move</span> <span class="k">if</span> <span class="n">the</span> <span class="n">enum</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">value</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">user</span><span class="s1">&#39;s inputs from EPICS. This is an IN_OUT variable because we will write values back to this to help us detect when the same value is re-caput</span>
    <span class="n">stUserInput</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">bBusy</span> <span class="n">boolean</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">motion</span> <span class="n">FB</span>
    <span class="n">bMoveBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">starting</span> <span class="n">state</span> <span class="n">number</span> <span class="n">to</span> <span class="n">seed</span> <span class="n">nCurrGoal</span> <span class="k">with</span>
    <span class="n">nStartingState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span> <span class="n">have</span> <span class="n">a</span> <span class="n">move</span> <span class="n">error</span><span class="p">,</span> <span class="n">to</span> <span class="n">prevent</span> <span class="n">moves</span>
    <span class="n">bMoveError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">goal</span> <span class="n">index</span> <span class="n">to</span> <span class="nb">input</span> <span class="n">to</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">FB</span><span class="o">.</span> <span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="n">clamped</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">range</span> <span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span>
    <span class="n">nCurrGoal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">bExecute</span> <span class="n">boolean</span> <span class="n">to</span> <span class="nb">input</span> <span class="n">to</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">FB</span>
    <span class="n">bExecMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">bReset</span> <span class="n">boolean</span> <span class="n">to</span> <span class="nb">input</span> <span class="n">to</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">FB</span>
    <span class="n">bResetMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nQueuedGoal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bNewMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nCachedStart</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">IDLE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">GOING</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">WAIT_STOP</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bResetMove</span> <span class="o">:=</span> <span class="n">stUserInput</span><span class="o">.</span><span class="n">bReset</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bResetMove</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stUserInput</span><span class="o">.</span><span class="n">nSetValue</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nCurrGoal</span> <span class="o">:=</span> <span class="n">nStartingState</span><span class="p">;</span>
    <span class="n">nCachedStart</span> <span class="o">:=</span> <span class="n">nStartingState</span><span class="p">;</span>
    <span class="n">bExecMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nState</span> <span class="o">:=</span> <span class="n">IDLE</span><span class="p">;</span>
    <span class="n">bNewMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">stUserInput</span><span class="o">.</span><span class="n">nSetValue</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">nQueuedGoal</span> <span class="o">:=</span> <span class="n">stUserInput</span><span class="o">.</span><span class="n">nSetValue</span><span class="p">;</span>
    <span class="n">bNewMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
    <span class="n">IDLE</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">bNewMove</span> <span class="n">AND</span> <span class="n">nQueuedGoal</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">nQueuedGoal</span> <span class="o">&lt;=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">New</span> <span class="n">request</span><span class="p">,</span> <span class="n">currently</span> <span class="n">idle</span> <span class="o">-&gt;</span> <span class="n">ask</span> <span class="k">for</span> <span class="n">a</span> <span class="n">move</span>
            <span class="n">nCurrGoal</span> <span class="o">:=</span> <span class="n">nQueuedGoal</span><span class="p">;</span>
            <span class="n">bExecMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">bNewMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">bMoveBusy</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">We</span><span class="s1">&#39;re moving but used to be idle -&gt; switch to GOING</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">GOING</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">nStartingState</span> <span class="o">&lt;&gt;</span> <span class="n">nCachedStart</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">Usually</span> <span class="n">a</span> <span class="n">late</span> <span class="n">position</span> <span class="n">init</span><span class="p">,</span> <span class="n">sometimes</span> <span class="n">a</span> <span class="n">live</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">encoder</span> <span class="n">offset</span>
            <span class="o">//</span> <span class="n">The</span> <span class="n">state</span> <span class="n">changed</span> <span class="n">without</span> <span class="n">a</span> <span class="n">move</span><span class="p">,</span> <span class="n">so</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">partially</span> <span class="n">reinitialize</span><span class="o">.</span>
            <span class="n">nCurrGoal</span> <span class="o">:=</span> <span class="n">nStartingState</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">GOING</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">bNewMove</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">New</span> <span class="n">request</span><span class="p">,</span> <span class="n">currently</span> <span class="n">moving</span> <span class="o">-&gt;</span> <span class="n">ask</span> <span class="k">for</span> <span class="n">a</span> <span class="n">stop</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">WAIT_STOP</span><span class="p">;</span>
            <span class="n">bExecMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">bMoveBusy</span> <span class="n">THEN</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">IDLE</span><span class="p">;</span>
            <span class="n">nQueuedGoal</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">bExecMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">WAIT_STOP</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMoveBusy</span> <span class="n">THEN</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">IDLE</span><span class="p">;</span>
        <span class="n">END_IF</span>
<span class="n">END_CASE</span>

<span class="n">IF</span> <span class="n">bMoveError</span> <span class="n">THEN</span>
    <span class="n">bExecMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Detect</span> <span class="k">if</span> <span class="n">the</span> <span class="nb">set</span><span class="o">/</span><span class="n">start</span> <span class="n">position</span> <span class="n">updates</span> <span class="n">without</span> <span class="n">a</span> <span class="n">move</span>
<span class="n">nCachedStart</span> <span class="o">:=</span> <span class="n">nStartingState</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Help</span> <span class="n">us</span> <span class="n">detect</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">EPICS</span> <span class="n">put</span> <span class="n">before</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span>
<span class="n">stUserInput</span><span class="o">.</span><span class="n">nSetValue</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">stUserInput</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-terminalerror">
<h2>FB_TerminalError<a class="headerlink" href="#fb-terminalerror" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TerminalError</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span>                                      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span>            <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bWcState</span>                        <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">uiInfoData_State</span>        <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">pErrorSystem</span>            <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>                                    <span class="o">//</span><span class="n">Pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">error</span> <span class="n">system</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">iStateError</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">iOtherError</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">ErrorData</span>       <span class="p">:</span> <span class="n">DUT_TerminalError</span><span class="p">;</span>
    <span class="n">nErrSysCNT</span>      <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">testing</span>
    <span class="n">bStateChanged</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                           <span class="o">//</span><span class="n">Indicate</span> <span class="k">if</span> <span class="n">state</span> <span class="n">change</span> <span class="n">happened</span>
    <span class="n">uiInfoData_State_Prev</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#8;           //Previous value of Infodata.State</span>
    <span class="n">bWcState_Prev</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>                          <span class="o">//</span><span class="n">Previous</span> <span class="n">state</span> <span class="n">of</span> <span class="n">WcState</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="n">Currently</span><span class="p">:</span>

<span class="n">Problem</span><span class="p">:</span>

<span class="n">TODO</span><span class="p">:</span>

<span class="o">*</span><span class="p">)</span>

<span class="o">//</span><span class="n">Connect</span> <span class="n">EN</span> <span class="n">to</span> <span class="n">EnO</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Check</span> <span class="k">if</span> <span class="n">pointer</span> <span class="ow">is</span> <span class="n">OK</span>
<span class="n">IF</span> <span class="n">pErrorSystem</span><span class="o">=</span><span class="mi">0</span> <span class="n">THEN</span> <span class="n">RETURN</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="o">//</span><span class="n">Any</span> <span class="n">difference</span> <span class="kn">from</span><span class="w"> </span><span class="nn">normal</span> <span class="n">state</span> <span class="n">creates</span> <span class="n">an</span> <span class="n">error</span>
<span class="n">IF</span> <span class="n">En</span> <span class="n">AND</span> <span class="p">(</span><span class="n">bWcState</span> <span class="n">OR</span> <span class="n">uiInfoData_State</span><span class="o">&lt;&gt;</span><span class="mi">16</span><span class="c1">#8) THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Change</span> <span class="n">detection</span>
<span class="n">IF</span> <span class="n">uiInfoData_State</span> <span class="o">&lt;&gt;</span> <span class="n">uiInfoData_State_Prev</span> <span class="n">OR</span> <span class="n">bWcState</span> <span class="o">&lt;&gt;</span> <span class="n">bWcState_Prev</span> <span class="n">THEN</span>
    <span class="n">bStateChanged</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bStateChanged</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Update</span> <span class="n">previous</span> <span class="n">values</span>
<span class="n">uiInfoData_State_Prev</span> <span class="o">:=</span> <span class="n">uiInfoData_State</span><span class="p">;</span>
<span class="n">bWcState_Prev</span> <span class="o">:=</span> <span class="n">bWcState</span><span class="p">;</span>

<span class="o">//</span><span class="n">Decision</span> <span class="n">tree</span>
<span class="n">IF</span> <span class="n">bStateChanged</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Active</span> <span class="n">THEN</span>
                    <span class="o">//</span><span class="n">Close</span> <span class="n">active</span> <span class="n">error</span>
                    <span class="o">//</span><span class="n">Read</span> <span class="n">system</span> <span class="n">time</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOff</span> <span class="o">:=</span> <span class="n">Tc2_EtherCAT</span><span class="o">.</span><span class="n">F_GetActualDcTime64</span><span class="p">();</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sDateTimeOff</span> <span class="o">:=</span> <span class="n">Tc2_EtherCat</span><span class="o">.</span><span class="n">DCTIME64_TO_STRING</span><span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOff</span><span class="p">);</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">:=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Inactive</span><span class="p">;</span>
                    <span class="o">//</span><span class="n">Write</span> <span class="n">Off</span><span class="o">-</span><span class="n">time</span> <span class="n">to</span> <span class="n">Error</span> <span class="n">System</span>
                    <span class="n">FOR</span> <span class="n">nErrSysCNT</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">DO</span>
                            <span class="n">IF</span> <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">Error_ID</span> <span class="o">=</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">Error_ID</span> <span class="n">THEN</span>
                                    <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">nDateTimeOff</span> <span class="o">:=</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOff</span><span class="p">;</span>
                                    <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">sDateTimeOff</span> <span class="o">:=</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">sDateTimeOff</span><span class="p">;</span>
                                    <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">:=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Inactive</span><span class="p">;</span>
                                    <span class="n">EXIT</span><span class="p">;</span>
                            <span class="n">END_IF</span>
                    <span class="n">END_FOR</span>

                    <span class="o">//</span><span class="n">Clear</span> <span class="n">ErrorData</span>
                    <span class="n">MEMSET</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">ErrorData</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">ErrorData</span><span class="p">));</span>
            <span class="n">END_IF</span>

            <span class="o">//</span><span class="n">Open</span> <span class="n">a</span> <span class="n">new</span> <span class="n">error</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">:=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Active</span><span class="p">;</span>                                                                                          <span class="o">//</span><span class="n">Set</span> <span class="n">Error</span> <span class="n">State</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOn</span> <span class="o">:=</span> <span class="n">Tc2_EtherCAT</span><span class="o">.</span><span class="n">F_GetActualDcTime64</span><span class="p">();</span>                                                            <span class="o">//</span><span class="n">Get</span> <span class="n">system</span> <span class="n">time</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">sDateTimeOn</span> <span class="o">:=</span> <span class="n">Tc2_EtherCat</span><span class="o">.</span><span class="n">DCTIME64_TO_STRING</span><span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOn</span><span class="p">);</span>                        <span class="o">//</span><span class="n">Convert</span> <span class="n">to</span> <span class="n">string</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">iTerminalID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">;</span>                                                                                                          <span class="o">//</span><span class="n">Terminal_ID</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">bWcState</span> <span class="o">:=</span> <span class="n">bWcState</span><span class="p">;</span>                                                                                                                         <span class="o">//</span><span class="n">WcState</span> <span class="n">bit</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">uiInfoDataState</span> <span class="o">:=</span> <span class="n">uiInfoData_State</span><span class="p">;</span>                                                                                          <span class="o">//</span><span class="n">uiInfoData_State</span>

            <span class="o">//</span><span class="n">Error</span> <span class="n">message</span> <span class="n">according</span> <span class="n">to</span> <span class="n">uiInfoData_State</span> <span class="ow">and</span> <span class="n">WcState</span>
            <span class="n">iStateError</span> <span class="o">:=</span> <span class="p">(</span><span class="n">uiInfoData_State</span> <span class="n">AND</span> <span class="mi">16</span><span class="c1">#000F);                                                                                          //Mask for operation state</span>
            <span class="n">iOtherError</span> <span class="o">:=</span> <span class="p">(</span><span class="n">uiInfoData_State</span> <span class="n">AND</span> <span class="mi">16</span><span class="c1">#00F0);                                                                                          //Mask for the other 3 kind of errors</span>
            <span class="o">//</span><span class="n">Error</span> <span class="n">messages</span> <span class="n">according</span> <span class="n">to</span> <span class="n">the</span> <span class="n">least</span> <span class="n">significant</span> <span class="n">digit</span>
            <span class="n">CASE</span> <span class="n">iStateError</span> <span class="n">OF</span>
                    <span class="mi">16</span><span class="c1">#0001 : ErrorData.sErrorMessage := &#39;Slave in INIT state;   &#39;;</span>
                    <span class="mi">16</span><span class="c1">#0002 : ErrorData.sErrorMessage := &#39;Slave in PREOP state;   &#39;;</span>
                    <span class="mi">16</span><span class="c1">#0003 : ErrorData.sErrorMessage := &#39;Slave in BOOT state;   &#39;;</span>
                    <span class="mi">16</span><span class="c1">#0004 : ErrorData.sErrorMessage := &#39;Slave in SAFEOP state;   &#39;;</span>
                    <span class="mi">16</span><span class="c1">#0008 : ;                                                                                                                                                     //Normal operation state</span>
            <span class="n">ELSE</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Undefined State of operation;   &#39;</span><span class="p">;</span>                                          <span class="o">//</span><span class="n">I</span> <span class="n">hope</span> <span class="n">we</span> <span class="n">will</span> <span class="n">never</span> <span class="n">see</span> <span class="n">this</span> <span class="n">message</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">iStateError</span><span class="p">));</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="s1">&#39;   &#39;</span><span class="p">);</span>
            <span class="n">END_CASE</span>

            <span class="o">//</span><span class="n">Error</span> <span class="n">messages</span> <span class="n">according</span> <span class="n">to</span> <span class="n">the</span> <span class="n">second</span> <span class="n">least</span> <span class="n">significant</span> <span class="n">digit</span>
            <span class="n">CASE</span> <span class="n">iOtherError</span> <span class="n">OF</span>
                    <span class="mi">16</span><span class="c1">#0000 : ;                                                                                                                                                     //No error case</span>
                    <span class="mi">16</span><span class="c1">#0010 : ErrorData.sErrorMessage := CONCAT (ErrorData.sErrorMessage, &#39;Slave signals error;   &#39;);</span>
                    <span class="mi">16</span><span class="c1">#0020 : ErrorData.sErrorMessage := CONCAT (ErrorData.sErrorMessage, &#39;Invalid vendorID/productCode read;   &#39;);</span>
                    <span class="mi">16</span><span class="c1">#0040 : ErrorData.sErrorMessage := CONCAT (ErrorData.sErrorMessage, &#39;Initialisation error occured;   &#39;);</span>
            <span class="n">ELSE</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="s1">&#39;Undefined Error ID: &#39;</span><span class="p">);</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">iOtherError</span><span class="p">));</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="s1">&#39;   &#39;</span><span class="p">);</span>
            <span class="n">END_CASE</span>

            <span class="o">//</span><span class="n">Errormessage</span> <span class="n">according</span> <span class="n">to</span> <span class="n">WcState</span> <span class="n">bit</span>
            <span class="n">IF</span> <span class="n">bWcState</span> <span class="n">THEN</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="s1">&#39;Invalid Data;&#39;</span><span class="p">);</span>
            <span class="n">END_IF</span>

            <span class="o">//</span><span class="n">Check</span> <span class="k">for</span> <span class="n">overflow</span>
            <span class="n">IF</span> <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">nNoErrors</span> <span class="o">=</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="n">THEN</span>
                    <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">nNoOverflows</span> <span class="o">:=</span> <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">nNoOverflows</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>

            <span class="o">//</span><span class="n">Write</span> <span class="n">Error</span> <span class="n">Data</span> <span class="n">into</span> <span class="n">Error</span> <span class="n">System</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">Error_ID</span> <span class="o">:=</span> <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">lNextErrorID</span> <span class="p">;</span>
            <span class="n">MEMMOVE</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span><span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">ADR</span><span class="p">(</span><span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">DUT_TerminalError</span><span class="p">));</span>
            <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ErrorData</span><span class="p">;</span>
            <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">lNextErrorID</span> <span class="o">:=</span> <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">lNextErrorID</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">ELSE</span>
            <span class="o">//</span><span class="n">Close</span> <span class="n">Active</span> <span class="n">Error</span>
            <span class="o">//</span><span class="n">Read</span> <span class="n">system</span> <span class="n">time</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOff</span> <span class="o">:=</span> <span class="n">Tc2_EtherCAT</span><span class="o">.</span><span class="n">F_GetActualDcTime64</span><span class="p">();</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">sDateTimeOff</span> <span class="o">:=</span> <span class="n">Tc2_EtherCat</span><span class="o">.</span><span class="n">DCTIME64_TO_STRING</span><span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOff</span><span class="p">);</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">:=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Inactive</span><span class="p">;</span>

            <span class="o">//</span><span class="n">Write</span> <span class="n">Off</span> <span class="n">time</span> <span class="n">to</span> <span class="n">Error</span> <span class="n">System</span>
            <span class="n">FOR</span> <span class="n">nErrSysCNT</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">DO</span>
                    <span class="n">IF</span> <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">Error_ID</span> <span class="o">=</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">Error_ID</span> <span class="n">THEN</span>
                            <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">nDateTimeOff</span> <span class="o">:=</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOff</span><span class="p">;</span>
                            <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">sDateTimeOff</span> <span class="o">:=</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">sDateTimeOff</span><span class="p">;</span>
                            <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">:=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Inactive</span><span class="p">;</span>
                            <span class="n">EXIT</span><span class="p">;</span>
                    <span class="n">END_IF</span>
            <span class="n">END_FOR</span>

            <span class="o">//</span><span class="n">Clear</span> <span class="n">ErrorData</span>
            <span class="n">MEMSET</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">ErrorData</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">ErrorData</span><span class="p">));</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-errorstate">DUT_ErrorState</a></p></li>
<li><p><a class="reference internal" href="#dut-terminalerror">DUT_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#gvl-errorsystem">GVL_ErrorSystem</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-testhelpersetandmove">
<h2>FB_TestHelperSetAndMove<a class="headerlink" href="#fb-testhelpersetandmove" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TestHelperSetAndMove</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Set</span> <span class="n">an</span> <span class="n">stMotionStage</span> <span class="n">to</span> <span class="n">a</span> <span class="n">start</span> <span class="n">position</span><span class="p">,</span> <span class="n">then</span> <span class="n">cause</span> <span class="n">a</span> <span class="n">move</span><span class="o">.</span>
    <span class="n">On</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">of</span> <span class="n">bExecute</span><span class="p">,</span> <span class="n">errors</span> <span class="n">are</span> <span class="n">cleared</span><span class="p">,</span> <span class="n">the</span> <span class="n">user</span> <span class="n">enable</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">FALSE</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">position</span> <span class="ow">is</span> <span class="nb">set</span><span class="o">.</span>
    <span class="n">After</span> <span class="n">the</span> <span class="n">position</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">,</span> <span class="n">user</span> <span class="n">enable</span> <span class="ow">is</span> <span class="n">re</span><span class="o">-</span><span class="n">introduced</span> <span class="ow">and</span> <span class="n">a</span> <span class="n">move</span> <span class="n">begins</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">progress</span> <span class="n">of</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="k">for</span> <span class="n">the</span> <span class="n">purposes</span> <span class="n">of</span> <span class="n">a</span> <span class="n">unit</span> <span class="n">test</span> <span class="n">can</span> <span class="n">be</span> <span class="n">monitored</span> <span class="n">via</span> <span class="n">the</span> <span class="n">outputs</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motion</span> <span class="n">stage</span> <span class="n">should</span> <span class="n">have</span> <span class="n">its</span> <span class="n">own</span> <span class="n">FB_MotionStage</span> <span class="ow">or</span> <span class="n">some</span> <span class="n">stand</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">it</span> <span class="n">running</span> <span class="n">on</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">the</span> <span class="n">FB</span><span class="o">.</span>

    <span class="n">This</span> <span class="ow">is</span><span class="p">,</span> <span class="ow">in</span> <span class="n">itself</span><span class="p">,</span> <span class="n">tested</span> <span class="ow">in</span> <span class="n">FB_TestHelperSetAndMove_Test</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motion</span> <span class="n">state</span> <span class="n">to</span> <span class="n">test</span> <span class="k">with</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Begin</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">stop</span> <span class="n">on</span> <span class="n">falling</span> <span class="n">edge</span><span class="o">.</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">position</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">to</span>
    <span class="n">fStartPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">goal</span> <span class="n">to</span> <span class="n">move</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">towards</span>
    <span class="n">fGoalPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">velocity</span> <span class="n">to</span> <span class="n">move</span> <span class="n">at</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;ll set all the hardware enable signals. Leave this as FALSE if your testing involves any of the hardware enables.</span>
    <span class="n">bHWEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">no</span> <span class="n">errors</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">deactivated</span><span class="o">.</span>
    <span class="n">bResetDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="nb">set</span> <span class="n">position</span> <span class="n">completes</span><span class="o">.</span>
    <span class="n">bSetDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">begins</span> <span class="n">moving</span><span class="o">.</span>
    <span class="n">bMotionStarted</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">reaches</span> <span class="n">its</span> <span class="n">destination</span><span class="o">.</span>
    <span class="n">bMoveDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">bBusy</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">the</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">ready</span> <span class="k">for</span> <span class="n">a</span> <span class="n">new</span> <span class="n">request</span><span class="o">.</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">after</span> <span class="n">bExecute</span> <span class="n">rises</span> <span class="ow">and</span> <span class="n">back</span> <span class="n">to</span> <span class="n">FALSE</span> <span class="n">after</span> <span class="n">bMoveDone</span> <span class="ow">or</span> <span class="n">bError</span> <span class="n">rises</span><span class="o">.</span> <span class="n">Also</span> <span class="n">goes</span> <span class="n">to</span> <span class="n">FALSE</span> <span class="n">after</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">stops</span> <span class="n">following</span> <span class="n">bExecute</span> <span class="n">being</span> <span class="n">dropped</span> <span class="n">to</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="ow">in</span> <span class="n">case</span> <span class="n">of</span> <span class="n">an</span> <span class="n">error</span> <span class="kn">from</span><span class="w"> </span><span class="nn">FB_MotionRequest</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Counts</span> <span class="n">up</span> <span class="kn">from</span><span class="w"> </span><span class="nn">bExecute</span><span class="s1">&#39;s rising trigger. Can be used to implement a timeout.</span>
    <span class="n">tElapsed</span><span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Current</span> <span class="n">motor</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">case</span> <span class="n">you</span><span class="s1">&#39;re looking for it</span>
    <span class="n">fActPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re trying to stop a move. We&#39;</span><span class="n">ll</span> <span class="n">stop</span> <span class="n">an</span> <span class="ow">in</span><span class="o">-</span><span class="n">progress</span> <span class="n">move</span> <span class="n">when</span> <span class="n">bExecute</span> <span class="n">goes</span> <span class="n">to</span> <span class="n">FALSE</span><span class="p">,</span> <span class="ow">and</span> <span class="n">we</span><span class="s1">&#39;ll make sure the motor fully stops before responding to the next bExecute rising edge.</span>
    <span class="n">bStoppingMotor</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbMoveRequest</span><span class="p">:</span> <span class="n">FB_MotionRequest</span><span class="p">;</span>
    <span class="n">mcSetPos</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">tonTimeout</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftExec</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">bExecQueued</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nLatchError</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">tonTimeout</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1h,</span>
    <span class="n">ET</span><span class="o">=&gt;</span><span class="n">tElapsed</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">ftExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">outputs</span> <span class="n">to</span> <span class="n">known</span> <span class="n">values</span> <span class="n">on</span> <span class="n">exec</span>
<span class="n">bResetDone</span> <span class="n">R</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bSetDone</span> <span class="n">R</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bMotionStarted</span> <span class="n">R</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bMoveDone</span> <span class="n">R</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bBusy</span> <span class="n">S</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bError</span> <span class="n">R</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="n">bExecQueued</span> <span class="n">S</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bExecQueued</span> <span class="n">R</span><span class="o">=</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bStoppingMotor</span> <span class="n">S</span><span class="o">=</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">hardware</span> <span class="n">enables</span> <span class="k">if</span> <span class="n">asked</span>
<span class="n">IF</span> <span class="n">bHWEnable</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Note</span> <span class="n">that</span> <span class="n">we</span> <span class="n">only</span> <span class="n">reset</span> <span class="k">if</span> <span class="n">it</span><span class="s1">&#39;s needed, e.g. the motor has an error or is enabled or moving etc. etc.</span>
<span class="n">bResetDone</span> <span class="n">S</span><span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">All</span> <span class="n">uses</span> <span class="n">of</span> <span class="n">fbMoveRequest</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">IF</span><span class="o">/</span><span class="n">ELSE</span> <span class="n">tree</span>
<span class="n">IF</span> <span class="n">bStoppingMotor</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Continue</span> <span class="n">stopping</span> <span class="n">the</span> <span class="n">motor</span> <span class="kn">from</span><span class="w"> </span><span class="nn">previous</span> <span class="n">cycles</span>
    <span class="n">fbMoveRequest</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bStoppingMotor</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ControlLoopClosed</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMoveRequest</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">bExecQueued</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">First</span> <span class="n">exec</span> <span class="n">cycle</span><span class="p">:</span> <span class="n">bring</span> <span class="n">these</span> <span class="n">to</span> <span class="n">FALSE</span> <span class="k">for</span> <span class="n">later</span> <span class="n">use</span>
    <span class="n">bExecQueued</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bUserEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbMoveRequest</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="n">bReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">bResetDone</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Other</span> <span class="n">cycles</span><span class="p">:</span> <span class="n">reset</span> <span class="n">until</span> <span class="n">we</span><span class="s1">&#39;re done resetting</span>
    <span class="n">fbMoveRequest</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">bReset</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">ELSIF</span> <span class="n">fStartPosition</span> <span class="o">&lt;&gt;</span> <span class="n">fGoalPosition</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Later</span><span class="p">:</span> <span class="n">do</span> <span class="n">the</span> <span class="n">move</span>
    <span class="o">//</span> <span class="n">Important</span> <span class="n">to</span> <span class="ow">not</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">until</span> <span class="n">the</span> <span class="nb">set</span> <span class="n">position</span> <span class="ow">is</span> <span class="n">done</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bUserEnable</span> <span class="o">:=</span> <span class="n">bSetDone</span><span class="p">;</span>
    <span class="n">fbMoveRequest</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">bSetDone</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bMoveDone</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span><span class="p">,</span>
        <span class="n">bReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="n">enumMotionRequest</span><span class="o">:=</span><span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="p">,</span>
        <span class="n">fPos</span><span class="o">:=</span><span class="n">fGoalPosition</span><span class="p">,</span>
        <span class="n">fVel</span><span class="o">:=</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bMotionStarted</span> <span class="n">S</span><span class="o">=</span> <span class="n">bSetDone</span> <span class="n">AND</span> <span class="n">fbMoveRequest</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&lt;&gt;</span> <span class="n">fStartPosition</span><span class="p">;</span>
    <span class="n">bMoveDone</span> <span class="n">S</span><span class="o">=</span> <span class="n">bMotionStarted</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">=</span> <span class="n">fGoalPosition</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fStartPosition</span> <span class="o">=</span> <span class="n">fGoalPosition</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="k">if</span> <span class="n">the</span> <span class="n">start</span> <span class="n">position</span> <span class="n">matches</span> <span class="n">the</span> <span class="n">goal</span> <span class="n">position</span><span class="p">,</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">commanded</span> <span class="n">position</span> <span class="ow">is</span>
    <span class="o">//</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span><span class="o">.</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fGoalPosition</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">position</span> <span class="n">prior</span> <span class="n">to</span> <span class="n">the</span> <span class="n">move</span> <span class="n">but</span> <span class="n">after</span> <span class="n">the</span> <span class="n">reset</span><span class="o">.</span>
<span class="n">mcSetPos</span><span class="p">(</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bResetDone</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bSetDone</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span><span class="p">,</span>
    <span class="n">Position</span><span class="o">:=</span><span class="n">fStartPosition</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">nLatchError</span> <span class="o">:=</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">bSetDone</span> <span class="n">S</span><span class="o">=</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Done</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">=</span> <span class="n">fStartPosition</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Any</span> <span class="n">sub</span><span class="o">-</span><span class="n">error</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">error</span> <span class="n">here</span>
<span class="n">bError</span> <span class="o">:=</span> <span class="n">fbMoveRequest</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Reset</span> <span class="n">bBusy</span> <span class="n">when</span> <span class="n">appropriate</span>
<span class="n">bBusy</span> <span class="n">R</span><span class="o">=</span> <span class="p">(</span><span class="n">bMoveDone</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bStoppingMotor</span><span class="p">)</span> <span class="n">OR</span> <span class="n">bError</span> <span class="n">OR</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Extract</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">position</span>
<span class="n">fActPosition</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-motionrequest">FB_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove-test">FB_TestHelperSetAndMove_Test</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-testhelpersetandmove-test">
<h2>FB_TestHelperSetAndMove_Test<a class="headerlink" href="#fb-testhelpersetandmove-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TestHelperSetAndMove_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Ensure</span> <span class="n">that</span> <span class="n">the</span> <span class="n">test</span> <span class="n">helper</span> <span class="n">function</span> <span class="n">block</span> <span class="n">works</span> <span class="k">as</span> <span class="n">needed</span><span class="o">.</span>
    <span class="n">Without</span> <span class="n">this</span><span class="p">,</span> <span class="nb">all</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">need</span> <span class="n">motion</span> <span class="n">cannot</span> <span class="k">pass</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbTestMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>
    <span class="n">rtResetDone</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtSetDone</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtMotionStart</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtMoveDone</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">);</span>
<span class="n">BasicMotion</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">BasicMotion</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BasicMotion&#39;</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="mf">15.0</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="mf">17.0</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">rtResetDone</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">bResetDone</span><span class="p">);</span>
<span class="n">rtSetDone</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">bSetDone</span><span class="p">);</span>
<span class="n">rtMotionStart</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">bMotionStarted</span><span class="p">);</span>
<span class="n">rtMoveDone</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">bMoveDone</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtResetDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Reset did not clear error&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Real position output does not match real position.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">rtSetDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Was not set to start position after set done&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">rtMotionStart</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;stMotionStage is not busy, but motion is said to have started.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&gt;</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;stMotionStage has not moved, but motion is said to have started.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">rtMoveDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fGoalPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not reach destination at move done&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s OR (fbTestMove.bResetDone AND fbTestMove.bSetDone AND fbTestMove.bMotionStarted AND fbTestMove.bMoveDone) THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error in fbTestMove&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in basic motion test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove">FB_TestHelperSetAndMove</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-teststateinittiming">
<h2>FB_TestStateInitTiming<a class="headerlink" href="#fb-teststateinittiming" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TestStateInitTiming</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStageSim</span><span class="p">:</span> <span class="n">FB_MotionStageSim</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbMotionStageSim</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">PassiveReinit</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PassiveReinit</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateSetup</span><span class="p">:</span> <span class="n">FB_StateSetupHelper</span><span class="p">;</span>
    <span class="n">stDefault</span><span class="p">:</span> <span class="n">ST_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span>
    <span class="p">);</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>

    <span class="n">mcSetPos</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">nCheckStep</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nFurthestStep</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="n">nLastState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nTransitionState</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">99</span><span class="p">;</span>
    <span class="n">nDoneState</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">99</span><span class="p">;</span>
    <span class="n">timer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>

    <span class="n">nSetPosErrCount</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nSetPosErrorID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;PassiveReinit&#39;</span><span class="p">);</span>

<span class="o">//</span> <span class="n">State</span> <span class="n">setup</span>
<span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stDefault</span><span class="p">,</span> <span class="n">bSetDefault</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
<span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;ONE&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mi">10</span><span class="p">);</span>
<span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;TWO&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mi">20</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Run</span> <span class="n">the</span> <span class="n">state</span> <span class="n">FB</span> <span class="n">every</span> <span class="n">cycle</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">;</span>
<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="o">//</span> <span class="n">Check</span> <span class="ow">and</span> <span class="n">adjust</span> <span class="n">different</span> <span class="n">things</span> <span class="k">as</span> <span class="n">we</span> <span class="n">go</span>
<span class="n">CASE</span> <span class="n">nCheckStep</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>  <span class="o">//</span> <span class="n">State</span> <span class="n">begins</span> <span class="n">at</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span> <span class="n">nCurrGoal</span> <span class="n">begins</span> <span class="n">at</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="n">AssertEquals_UINT</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not start in unknown state&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertEquals_UINT</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">fbCore</span><span class="o">.</span><span class="n">nCurrGoal</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not start with nCurrGoal unknown&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">mcSetPos</span><span class="p">(</span>
            <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">nCheckStep</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="mi">1</span><span class="p">:</span>  <span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">to</span> <span class="n">ONE</span><span class="o">/</span><span class="mi">10</span>
        <span class="n">mcSetPos</span><span class="p">(</span>
            <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">Position</span><span class="o">:=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">IF</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Done</span> <span class="n">THEN</span>
            <span class="n">mcSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">nCheckStep</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
            <span class="n">nSetPosErrCount</span> <span class="o">:=</span> <span class="n">nSetPosErrCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">nSetPosErrorID</span> <span class="o">:=</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
            <span class="n">nCheckStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="mi">2</span><span class="p">:</span>  <span class="o">//</span> <span class="n">Without</span> <span class="n">a</span> <span class="n">move</span><span class="p">,</span> <span class="n">the</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">goal</span> <span class="n">should</span> <span class="n">both</span> <span class="n">change</span> <span class="n">to</span> <span class="s2">&quot;ONE&quot;</span> <span class="k">if</span> <span class="n">the</span> <span class="n">position</span> <span class="n">updates</span>
        <span class="n">AssertEquals_UINT</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Read state did not change to ONE after setpos&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertEquals_UINT</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">fbCore</span><span class="o">.</span><span class="n">nCurrGoal</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;nCurrGoal did not change to ONE after setpos&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="o">//</span> <span class="n">Verify</span><span class="p">:</span> <span class="n">no</span> <span class="n">move</span> <span class="n">requested</span>
        <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
            <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Set pos routine 1 actually gave us a move!&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">nCheckStep</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="mi">3</span><span class="p">:</span>  <span class="o">//</span> <span class="n">Same</span> <span class="k">as</span> <span class="n">before</span><span class="p">,</span> <span class="n">but</span> <span class="n">to</span> <span class="mi">20</span><span class="o">/</span><span class="n">TWO</span>
        <span class="n">mcSetPos</span><span class="p">(</span>
            <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">Position</span><span class="o">:=</span><span class="mi">20</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">IF</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Done</span> <span class="n">THEN</span>
            <span class="n">mcSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">nCheckStep</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="mi">4</span><span class="p">:</span>
        <span class="n">AssertEquals_UINT</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Read state did not change to TWO after setpos&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertEquals_UINT</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">fbCore</span><span class="o">.</span><span class="n">nCurrGoal</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;nCurrGoal did not change to TWO after setpos&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="o">//</span> <span class="n">Verify</span><span class="p">:</span> <span class="n">no</span> <span class="n">move</span> <span class="n">requested</span>
        <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
            <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Set pos routine 2 actually gave us a move!&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">nCheckStep</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="mi">5</span><span class="p">:</span>  <span class="o">//</span> <span class="n">Triggering</span> <span class="n">a</span> <span class="n">move</span> <span class="n">should</span> <span class="n">change</span> <span class="n">the</span> <span class="n">goal</span> <span class="n">to</span> <span class="n">the</span> <span class="n">new</span> <span class="n">state</span><span class="p">,</span> <span class="n">without</span> <span class="n">updating</span> <span class="n">the</span> <span class="n">readback</span>
        <span class="n">eEnumSet</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">nLastState</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">nCheckStep</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="mi">6</span><span class="p">:</span>
        <span class="n">AssertEquals_UINT</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">fbCore</span><span class="o">.</span><span class="n">nCurrGoal</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;nCurrGoal did not change to ONE in move&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="o">//</span> <span class="n">Looking</span> <span class="k">for</span> <span class="n">a</span> <span class="n">readback</span> <span class="n">transition</span> <span class="mi">2</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="mi">1</span>
        <span class="o">//</span> <span class="n">Record</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">two</span> <span class="n">transitions</span>
        <span class="n">IF</span> <span class="n">eEnumGet</span> <span class="o">&lt;&gt;</span> <span class="n">nLastState</span> <span class="ow">and</span> <span class="n">nTransitionState</span> <span class="o">=</span> <span class="mi">99</span> <span class="n">THEN</span>
            <span class="n">nTransitionState</span> <span class="o">:=</span> <span class="n">eEnumGet</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">eEnumGet</span> <span class="o">&lt;&gt;</span> <span class="n">nLastState</span> <span class="ow">and</span> <span class="n">nDoneState</span> <span class="o">=</span> <span class="mi">99</span> <span class="n">THEN</span>
            <span class="n">nDoneState</span> <span class="o">:=</span> <span class="n">eEnumGet</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="n">nLastState</span> <span class="o">:=</span> <span class="n">eEnumGet</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
            <span class="n">AssertEquals_UINT</span><span class="p">(</span>
                <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">Actual</span><span class="o">:=</span><span class="n">nTransitionState</span><span class="p">,</span>
                <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;State did not transition 2 -&gt; 0 in move&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">AssertEquals_UINT</span><span class="p">(</span>
                <span class="n">Expected</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">Actual</span><span class="o">:=</span><span class="n">nDoneState</span><span class="p">,</span>
                <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;State did not transition 2 -&gt; 0 -&gt; 1 in move&#39;</span><span class="p">,</span>
            <span class="p">);</span>
            <span class="n">nCheckStep</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="mi">7</span><span class="p">:</span> <span class="o">//</span> <span class="n">The</span> <span class="n">readback</span> <span class="ow">and</span> <span class="n">curr</span> <span class="n">goal</span> <span class="n">should</span> <span class="n">match</span> <span class="n">after</span> <span class="n">the</span> <span class="n">move</span><span class="p">,</span> <span class="n">then</span> <span class="n">end</span> <span class="n">test</span> <span class="n">suite</span>
        <span class="n">AssertEquals_UINT</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Read state did not change to ONE after move&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertEquals_UINT</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">fbCore</span><span class="o">.</span><span class="n">nCurrGoal</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;nCurrGoal did not stay at ONE after move&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">Condition</span><span class="o">:=</span><span class="n">timer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_CASE</span>

<span class="n">timer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s);</span>
<span class="n">IF</span> <span class="n">timer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">nCheckStep</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">nCheckStep</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="n">AND</span> <span class="n">nFurthestStep</span> <span class="o">&lt;</span> <span class="n">nCheckStep</span> <span class="n">THEN</span>
    <span class="n">nFurthestStep</span> <span class="o">:=</span> <span class="n">nCheckStep</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstagesim">FB_MotionStageSim</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#fb-statesetuphelper">FB_StateSetupHelper</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-writefloatparameter">
<h2>FB_WriteFloatParameter<a class="headerlink" href="#fb-writefloatparameter" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="c1">#########################################################</span>
<span class="o">///</span><span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Library</span><span class="p">:</span>
<span class="o">///</span> <span class="n">Tc2_MC2</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span> <span class="n">Tc2_System</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Global</span> <span class="n">Variables</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Data</span> <span class="n">types</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">External</span> <span class="n">functions</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">History</span><span class="p">:</span>
<span class="o">///</span> <span class="mi">2014</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">05</span>      <span class="n">v1</span><span class="mf">.00</span>   <span class="n">NB</span>      <span class="n">Release</span> <span class="n">code</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Known</span> <span class="n">bugs</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span>
<span class="o">///</span>
<span class="o">///</span><span class="c1">###########################################################</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_WriteFloatParameter</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="mi">16</span><span class="c1">#4000=Axisdata, 16#5000=Encoderdata, 16#6000=Controldata, 16#7000=Drivedata</span>
    <span class="n">nDeviceGroup</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndexOffset</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nData</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fbADSWRITE</span><span class="p">:</span> <span class="n">ADSWRITE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">Sequence</span> <span class="n">to</span> <span class="n">write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="mi">0</span><span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">Start</span> <span class="n">sequence</span><span class="o">.</span> <span class="n">Wait</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">TRUE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bBusy</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fbADSWRITE</span><span class="p">(</span>
            <span class="n">PORT</span><span class="o">:=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">IDXGRP</span><span class="o">:=</span><span class="n">nDeviceGroup</span><span class="o">+</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">,</span>
            <span class="n">IDXOFFS</span><span class="o">:=</span><span class="n">nIndexOffset</span><span class="p">,</span>
            <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">SRCADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">WRITE</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Wait</span> <span class="n">until</span> <span class="n">it</span><span class="s1">&#39;s done or if an error occurs*)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">ERR</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">BUSY</span> <span class="n">THEN</span>
                    <span class="n">fbADSWRITE</span><span class="p">(</span><span class="n">WRITE</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                    <span class="n">nState</span><span class="o">:=</span><span class="mi">20</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">ELSE</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">ERRID</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">999</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Sequense</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span> <span class="n">Waits</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">999</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbADSWRITE</span><span class="p">(</span><span class="n">WRITE</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-writeparameterinnc-v1-00">
<h2>FB_WriteParameterInNc_v1_00<a class="headerlink" href="#fb-writeparameterinnc-v1-00" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="c1">#########################################################</span>
<span class="o">///</span><span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Library</span><span class="p">:</span>
<span class="o">///</span> <span class="n">Tc2_MC2</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span> <span class="n">Tc2_System</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Global</span> <span class="n">Variables</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Data</span> <span class="n">types</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">External</span> <span class="n">functions</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">History</span><span class="p">:</span>
<span class="o">///</span> <span class="mi">2014</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">05</span>      <span class="n">v1</span><span class="mf">.00</span>   <span class="n">NB</span>      <span class="n">Release</span> <span class="n">code</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Known</span> <span class="n">bugs</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span>
<span class="o">///</span>
<span class="o">///</span><span class="c1">###########################################################</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_WriteParameterInNc_v1_00</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="mi">16</span><span class="c1">#4000=Axisdata, 16#5000=Encoderdata, 16#6000=Controldata, 16#7000=Drivedata</span>
    <span class="n">nDeviceGroup</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndexOffset</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nData</span><span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fbADSWRITE</span><span class="p">:</span> <span class="n">ADSWRITE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">Sequence</span> <span class="n">to</span> <span class="n">write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="mi">0</span><span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">Start</span> <span class="n">sequence</span><span class="o">.</span> <span class="n">Wait</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">TRUE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bBusy</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fbADSWRITE</span><span class="p">(</span>
            <span class="n">PORT</span><span class="o">:=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">IDXGRP</span><span class="o">:=</span><span class="n">nDeviceGroup</span><span class="o">+</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">,</span>
            <span class="n">IDXOFFS</span><span class="o">:=</span><span class="n">nIndexOffset</span><span class="p">,</span>
            <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">SRCADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">WRITE</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Wait</span> <span class="n">until</span> <span class="n">it</span><span class="s1">&#39;s done or if an error occurs*)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">ERR</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">BUSY</span> <span class="n">THEN</span>
                    <span class="n">fbADSWRITE</span><span class="p">(</span><span class="n">WRITE</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                    <span class="n">nState</span><span class="o">:=</span><span class="mi">20</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">ELSE</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">ERRID</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">999</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Sequense</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span> <span class="n">Waits</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">999</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbADSWRITE</span><span class="p">(</span><span class="n">WRITE</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-writeparameternc">
<h2>FB_WriteParameterNC<a class="headerlink" href="#fb-writeparameternc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_WriteParameterNC</span> <span class="n">IMPLEMENTS</span> <span class="n">I_WriteParameter</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no_copy&#39;</span><span class="p">}</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">fbMcWriteParameter</span> <span class="p">:</span> <span class="n">MC_WriteParameter</span><span class="p">;</span>
    <span class="n">bExecute</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span> <span class="p">:</span> <span class="n">UDINT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">sMessage</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span><span class="p">;</span>
    <span class="n">bDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span>    <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nParameterNumber</span> <span class="p">:</span> <span class="n">MC_AxisParameter</span><span class="p">;</span>
    <span class="n">fParameterValue</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">rtDone</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PUBLIC</span> <span class="n">CallAfterInit</span>
<span class="n">VAR_INPUT</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="o">//</span><span class="n">FB_Init</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">available</span> <span class="n">implicitly</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">initialization</span><span class="o">.</span>
<span class="o">//</span><span class="n">The</span> <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">evaluated</span><span class="o">.</span> <span class="n">For</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">influence</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">declare</span> <span class="n">the</span>
<span class="o">//</span><span class="n">methods</span> <span class="n">explicitly</span> <span class="ow">and</span> <span class="n">provide</span> <span class="n">additional</span> <span class="n">code</span> <span class="n">there</span> <span class="k">with</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">initialization</span>
<span class="o">//</span><span class="n">code</span><span class="o">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="k">return</span> <span class="n">value</span><span class="o">.</span>
<span class="n">METHOD</span> <span class="n">FB_Init</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bInitRetains</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">retain</span> <span class="n">variables</span> <span class="n">are</span> <span class="n">initialized</span> <span class="p">(</span><span class="n">reset</span> <span class="n">warm</span> <span class="o">/</span> <span class="n">reset</span> <span class="n">cold</span><span class="p">)</span>
    <span class="n">bInCopyCode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>  <span class="o">//</span> <span class="n">TRUE</span><span class="p">:</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">will</span> <span class="n">be</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">copy</span> <span class="n">code</span> <span class="n">afterward</span> <span class="p">(</span><span class="n">online</span> <span class="n">change</span><span class="p">)</span>
    <span class="n">AxisRef</span> <span class="p">:</span> <span class="n">REFERENCE</span> <span class="n">TO</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">AxisRef</span> <span class="n">REF</span><span class="o">=</span> <span class="n">AxisRef</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">WriteParameter</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Execute</span>         <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ParameterNumber</span> <span class="p">:</span> <span class="n">MC_AxisParameter</span><span class="p">;</span>
    <span class="n">ParameterValue</span>  <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">Execute</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">nParameterNumber</span> <span class="o">:=</span> <span class="n">ParameterNumber</span><span class="p">;</span>
<span class="n">THIS</span><span class="o">^.</span><span class="n">fParameterValue</span>       <span class="o">:=</span> <span class="n">ParameterValue</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">PROPERTY</span> <span class="n">Aborted</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Active</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>

<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Busy</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Done</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Done</span> <span class="o">:=</span> <span class="n">bDone</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Error</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Error</span> <span class="o">:=</span> <span class="n">bError</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">ErrorID</span> <span class="p">:</span> <span class="n">UDINT</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">ErrorID</span> <span class="o">:=</span> <span class="n">nErrorID</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>

<span class="n">PROPERTY</span> <span class="n">Message</span> <span class="p">:</span> <span class="n">T_MAXSTRING</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">Message</span> <span class="o">:=</span> <span class="n">sMessage</span><span class="p">;</span>
<span class="n">END_PROPERTY</span>
</pre></div>
</div>
</section>
<section id="prg-test">
<h2>PRG_TEST<a class="headerlink" href="#prg-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">PRG_TEST</span>
<span class="n">VAR</span>
    <span class="n">fb_AtPositionState_Test</span><span class="p">:</span> <span class="n">FB_AtPositionState_Test</span><span class="p">;</span>
    <span class="n">fb_AxisParameterSetExposed_Test</span><span class="p">:</span> <span class="n">FB_AxisParameterSetExposed_Test</span><span class="p">;</span>
    <span class="n">fb_MiscStatesErrorFFO_Test</span><span class="p">:</span> <span class="n">FB_MiscStatesErrorFFO_Test</span><span class="p">;</span>
    <span class="n">fb_MotionBPTM_Test</span><span class="p">:</span> <span class="n">FB_MotionBPTM_Test</span><span class="p">;</span>
    <span class="n">fb_MotionClearAsserts_Test</span><span class="p">:</span> <span class="n">FB_MotionClearAsserts_Test</span><span class="p">;</span>
    <span class="n">fb_MotionReadPMPSDBND_Test</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND_Test</span><span class="p">;</span>
    <span class="n">fbMotionVirtualFrameTest</span><span class="p">:</span> <span class="n">FB_MotionVirtualFrame_Test</span><span class="p">;</span>
    <span class="n">fb_TestHelperSetAndMove_Test</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove_Test</span><span class="p">;</span>
    <span class="n">fb_PositionStateRead_Test</span><span class="p">:</span> <span class="n">FB_PositionStateRead_Test</span><span class="p">;</span>
    <span class="n">fb_PositionStateReadND_Test</span><span class="p">:</span> <span class="n">FB_PositionStateReadND_Test</span><span class="p">;</span>
    <span class="n">fb_PositionStateMove_Test</span><span class="p">:</span> <span class="n">FB_PositionStateMove_Test</span><span class="p">;</span>
    <span class="n">fb_PositionStateMoveND_Test</span><span class="p">:</span> <span class="n">FB_PositionStateMoveND_Test</span><span class="p">;</span>
    <span class="n">fb_PositionStateND_Test</span><span class="p">:</span> <span class="n">FB_PositionStateND_Test</span><span class="p">;</span>
    <span class="n">fb_NCErrorFFO_Test</span><span class="p">:</span> <span class="n">FB_NCErrorFFO_Test</span><span class="p">;</span>
    <span class="n">fb_StatePMPSEnables_Test</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables_Test</span><span class="p">;</span>
    <span class="n">fb_PerMotorFFOND_Test</span><span class="p">:</span> <span class="n">FB_PerMotorFFOND_Test</span><span class="p">;</span>
    <span class="n">fb_StatePMPSEnablesND_Test</span><span class="p">:</span> <span class="n">FB_StatePMPSEnablesND_Test</span><span class="p">;</span>
    <span class="n">fb_PositionStatePMPSND_Test</span><span class="p">:</span> <span class="n">FB_PositionStatePMPSND_Test</span><span class="p">;</span>
    <span class="n">fb_StateSetupHelper_Test</span><span class="p">:</span> <span class="n">FB_StateSetupHelper_Test</span><span class="p">;</span>
    <span class="n">fb_TestStateInitTiming</span><span class="p">:</span> <span class="n">FB_TestStateInitTiming</span><span class="p">;</span>
    <span class="n">fb_PowerEnableMode_Test</span><span class="p">:</span> <span class="n">FB_PowerEnableMode_Test</span><span class="p">;</span>
    <span class="n">fb_MotionBacklashCompensation_Test</span><span class="p">:</span> <span class="n">FB_MotionBacklashCompensation_Test</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">New</span> <span class="n">Motion</span> <span class="n">Architecture</span> <span class="n">tests</span>
    <span class="n">fb_BrakeNC_Test</span><span class="p">:</span> <span class="n">FB_BrakeNC_Test</span><span class="p">;</span>
    <span class="n">fb_McMotionBlocks_Test</span><span class="p">:</span> <span class="n">FB_NewArchMcMotionBlocks_Test</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TcUnit</span><span class="o">.</span><span class="n">RUN</span><span class="p">();</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-atpositionstate-test">FB_AtPositionState_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-axisparametersetexposed-test">FB_AxisParameterSetExposed_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-brakenc-test">FB_BrakeNC_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-miscstateserrorffo-test">FB_MiscStatesErrorFFO_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-motionbptm-test">FB_MotionBPTM_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-motionbacklashcompensation-test">FB_MotionBacklashCompensation_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-motionclearasserts-test">FB_MotionClearAsserts_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-motionreadpmpsdbnd-test">FB_MotionReadPMPSDBND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-motionvirtualframe-test">FB_MotionVirtualFrame_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-ncerrorffo-test">FB_NCErrorFFO_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-newarchmcmotionblocks-test">FB_NewArchMcMotionBlocks_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-permotorffond-test">FB_PerMotorFFOND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemovend-test">FB_PositionStateMoveND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemove-test">FB_PositionStateMove_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-test">FB_PositionStateND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmpsnd-test">FB_PositionStatePMPSND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatereadnd-test">FB_PositionStateReadND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateread-test">FB_PositionStateRead_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-powerenablemode-test">FB_PowerEnableMode_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenablesnd-test">FB_StatePMPSEnablesND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenables-test">FB_StatePMPSEnables_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-statesetuphelper-test">FB_StateSetupHelper_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove-test">FB_TestHelperSetAndMove_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-teststateinittiming">FB_TestStateInitTiming</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="lcls-twincat-motion_Library_epics.html" class="btn btn-neutral float-left" title="Data Types" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, SLAC National Accelerator Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>