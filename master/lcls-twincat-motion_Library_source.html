<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUTs &mdash; pcdshub/lcls-twincat-motion  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/docs-versions-menu.js?v=3d6a1aea"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Data Types" href="lcls-twincat-motion_Library_epics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pcdshub/lcls-twincat-motion
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">lcls-twincat-motion</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_pragmas.html">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_nc.html">NC Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_ethercat.html">Box Hierarchy</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_boxes.html">Boxes</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_links.html">Links</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Library</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_Library_summary.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_Library_summary.html#pragmas">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_Library_summary.html#libraries">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_Library_summary.html#symbols">Symbols</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_Library_epics.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-motion_Library_epics.html#database-records">Database Records</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DUTs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dut-axisstatus-v0-01">DUT_AxisStatus_v0_01</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-errorstate">DUT_ErrorState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-motionpneumaticactuator">DUT_MotionPneumaticActuator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-motionstage">DUT_MotionStage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-positionstate">DUT_PositionState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dut-terminalerror">DUT_TerminalError</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dutel2521-ctrl">dutEL2521_Ctrl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dutel2521-status">dutEL2521_Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-epicsinout">E_EpicsInOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-pnuematicactuatorpositionstate">E_PnuematicActuatorPositionState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-stagebrakemode">E_StageBrakeMode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-statepmpsstatus">E_StatePMPSStatus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-teststates">E_TestStates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el5042-status">EL5042_Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-epicshomecmd">ENUM_EpicsHomeCmd</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-epicsinout">ENUM_EpicsInOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-epicsinout-int">ENUM_EpicsInOut_INT</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-epicsmotorcmd">ENUM_EpicsMotorCmd</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-motionfftype">ENUM_MotionFFType</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-motionrequest">ENUM_MotionRequest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-pnuematicactuatorpositionstate">ENUM_PnuematicActuatorPositionState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-stagebrakemode">ENUM_StageBrakeMode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-stageenablemode">ENUM_StageEnableMode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-statepmpsstatus">ENUM_StatePMPSStatus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-el5042-status">ST_EL5042_Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-motionpneumaticactuator">ST_MotionPneumaticActuator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-positionstate">ST_PositionState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-renishawabsenc">ST_RenishawAbsEnc</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-statepmpsepicstoplc">ST_StatePMPSEpicsToPlc</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-statepmpsplctoepics">ST_StatePMPSPlcToEpics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#gvls">GVLs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#global-version">Global_Version</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl">GVL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-errorsystem">GVL_ErrorSystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#motionconstants">MotionConstants</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#pous">POUs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#checkbounds">CheckBounds</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkdivdint">CheckDivDInt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkdivlint">CheckDivLInt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkdivlreal">CheckDivLReal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#checkdivreal">CheckDivReal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ek1200">EK1200</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el1008">EL1008</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el1018">EL1018</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el1808">EL1808</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el1809">EL1809</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el1819">EL1819</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el2014">EL2014</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el2252">EL2252</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el2808">EL2808</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el2819">EL2819</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el3174-0002">EL3174_0002</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el3214">EL3214</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el3255">EL3255</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el5002">EL5002</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el5021">EL5021</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el5042">EL5042</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el5101">EL5101</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el7211-v1-00">EL7211_v1_00</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el9410">EL9410</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el9505">EL9505</a></li>
<li class="toctree-l2"><a class="reference internal" href="#el9576-v1-00">EL9576_v1_00</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-motionerrorcodelookup">F_MotionErrorCodeLookup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-posoverlowerbound">F_PosOverLowerBound</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-posunderupperbound">F_PosUnderUpperBound</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-poswithindelta">F_PosWithinDelta</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-atpositionstate-test">FB_AtPositionState_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-calculatefrequency-3702-v0-01">FB_CalculateFrequency_3702_v0_01</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-causencerror">FB_CauseNCError</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-drivevirtual">FB_DriveVirtual</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-el1252asm-v1-00">FB_EL1252ASM_v1_00</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-encerrorffo">FB_EncErrorFFO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-encodervalue">FB_EncoderValue</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-encsaverestore">FB_EncSaveRestore</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-epicsinout">FB_EpicsInOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-errorlist">FB_ErrorList</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gantryautocoupling">FB_GantryAutoCoupling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gantrydiffvirtuallimitswitch">FB_GantryDiffVirtualLimitSwitch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homedirect">FB_HomeDirect</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homefinish">FB_HomeFinish</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homeprepare">FB_HomePrepare</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homereadncvelocities">FB_HomeReadNcVelocities</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homereadsoftlimenable">FB_HomeReadSoftLimEnable</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-hometoswitch">FB_HomeToSwitch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homevirtual">FB_HomeVirtual</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homewritencvelocities">FB_HomeWriteNcVelocities</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homewritesoftlimenable">FB_HomeWriteSoftLimEnable</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-logmotionerror">FB_LogMotionError</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-microstepcounttest">FB_MicroStepCountTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-miscstateserrorffo">FB_MiscStatesErrorFFO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-miscstateserrorffo-test">FB_MiscStatesErrorFFO_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionbptm">FB_MotionBPTM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionbptm-test">FB_MotionBPTM_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionclearasserts">FB_MotionClearAsserts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionclearasserts-test">FB_MotionClearAsserts_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionhoming">FB_MotionHoming</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionpneumaticactuator">FB_MotionPneumaticActuator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionreadpmpsdbnd">FB_MotionReadPMPSDBND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionreadpmpsdbnd-test">FB_MotionReadPMPSDBND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionrequest">FB_MotionRequest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionstagencparams">FB_MotionStageNCParams</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motionstagesim">FB_MotionStageSim</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ncaxis">FB_NcAxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ncerrorffo">FB_NCErrorFFO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ncerrorffo-test">FB_NCErrorFFO_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-permotorffond">FB_PerMotorFFOND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-permotorffond-test">FB_PerMotorFFOND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pmpsjsontesthelper">FB_PMPSJsonTestHelper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstate2d">FB_PositionState2D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstate2d-inout">FB_PositionState2D_InOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstate3d">FB_PositionState3D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatebase">FB_PositionStateBase</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatebase-withpmps">FB_PositionStateBase_WithPMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatebase-withpmps-test">FB_PositionStateBase_WithPMPS_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateinout">FB_PositionStateInOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateinout-withpmps">FB_PositionStateInOut_WithPMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateinout-withpmps-test">FB_PositionStateInOut_WithPMPS_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateinternalnd">FB_PositionStateInternalND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatelock">FB_PositionStateLock</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatemanager">FB_PositionStateManager</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatemove">FB_PositionStateMove</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatemove-test">FB_PositionStateMove_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatemovend">FB_PositionStateMoveND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatemovend-test">FB_PositionStateMoveND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatend-test">FB_PositionStateND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps">FB_PositionStatePMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps1d-inout">FB_PositionStatePMPS1D_InOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps2d">FB_PositionStatePMPS2D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps2d-inout">FB_PositionStatePMPS2D_InOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps3d">FB_PositionStatePMPS3D</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps-base">FB_PositionStatePMPS_Base</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmps-test">FB_PositionStatePMPS_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmpsnd-core">FB_PositionStatePMPSND_Core</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatepmpsnd-test">FB_PositionStatePMPSND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateread">FB_PositionStateRead</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstateread-test">FB_PositionStateRead_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatereadnd">FB_PositionStateReadND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstatereadnd-test">FB_PositionStateReadND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-rawcountconverter">FB_RawCountConverter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-readfloatparameter">FB_ReadFloatParameter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-readparameterinnc-v1-00">FB_ReadParameterInNc_v1_00</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-setenables">FB_SetEnables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-standard-pmpsdb">FB_Standard_PMPSDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statepmpsenables">FB_StatePMPSEnables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statepmpsenables-test">FB_StatePMPSEnables_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statepmpsenablesnd">FB_StatePMPSEnablesND</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statepmpsenablesnd-test">FB_StatePMPSEnablesND_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-stateptpmove">FB_StatePTPMove</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statesetuphelper">FB_StateSetupHelper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statesetuphelper-test">FB_StateSetupHelper_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-statesinputhandler">FB_StatesInputHandler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-testhelpersetandmove">FB_TestHelperSetAndMove</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-testhelpersetandmove-test">FB_TestHelperSetAndMove_Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-writefloatparameter">FB_WriteFloatParameter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-writeparameterinnc-v1-00">FB_WriteParameterInNc_v1_00</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prg-test">PRG_TEST</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pcdshub/lcls-twincat-motion</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">DUTs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/lcls-twincat-motion_Library_source.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="duts">
<h1>DUTs<a class="headerlink" href="#duts" title="Link to this heading"></a></h1>
<section id="dut-axisstatus-v0-01">
<h2>DUT_AxisStatus_v0_01<a class="headerlink" href="#dut-axisstatus-v0-01" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">DUT_AxisStatus_v0_01</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nCommand</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fAcceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fDeceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bJogFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bJogBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fOverride</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">bHomeSensor</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">fActVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fActPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fActDiff</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bHomed</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-axisstatus-v0-01">DUT_AxisStatus_v0_01</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="dut-errorstate">
<h2>DUT_ErrorState<a class="headerlink" href="#dut-errorstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">DUT_ErrorState</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="kc">None</span><span class="p">,</span>
    <span class="n">Active</span><span class="p">,</span>
    <span class="n">Inactive</span><span class="p">,</span>
    <span class="n">Acknowledged</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="dut-motionpneumaticactuator">
<h2>DUT_MotionPneumaticActuator<a class="headerlink" href="#dut-motionpneumaticactuator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;DUT_MotionPneumaticActuator has been renamed to ST_MotionPneumaticActuator&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">DUT_MotionPneumaticActuator</span> <span class="p">:</span> <span class="n">ST_MotionPneumaticActuator</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionpneumaticactuator">ST_MotionPneumaticActuator</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="dut-motionstage">
<h2>DUT_MotionStage<a class="headerlink" href="#dut-motionstage" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;DUT_MotionStage has been renamed to ST_MotionStage&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">DUT_MotionStage</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="dut-positionstate">
<h2>DUT_PositionState<a class="headerlink" href="#dut-positionstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;DUT_PositionState has been renamed to ST_PositionState&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">DUT_PositionState</span> <span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="dut-terminalerror">
<h2>DUT_TerminalError<a class="headerlink" href="#dut-terminalerror" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">DUT_TerminalError</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">//</span><span class="n">Error</span> <span class="n">system</span> <span class="n">related</span>
    <span class="n">iTerminalID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>                                      <span class="o">//</span><span class="n">ID</span> <span class="n">of</span> <span class="n">the</span> <span class="n">terminal</span>
    <span class="n">Error_ID</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>                          <span class="o">//</span><span class="n">ID</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Error</span> <span class="n">entry</span>
    <span class="n">ErrorState</span> <span class="p">:</span> <span class="n">DUT_ErrorState</span><span class="p">;</span>            <span class="o">//</span><span class="n">State</span> <span class="n">of</span> <span class="n">the</span> <span class="n">error</span>

    <span class="o">//</span><span class="n">Error</span> <span class="n">related</span>
    <span class="n">nDateTimeOn</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>                            <span class="o">//</span><span class="n">Date</span> <span class="ow">and</span> <span class="n">time</span> <span class="n">when</span> <span class="n">the</span> <span class="n">error</span> <span class="n">occured</span><span class="o">.</span> <span class="n">Raw</span> <span class="n">data</span>
    <span class="n">sDateTimeOn</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>                       <span class="o">//</span><span class="n">Date</span> <span class="ow">and</span> <span class="n">time</span> <span class="n">when</span> <span class="n">the</span> <span class="n">error</span> <span class="n">occured</span><span class="o">.</span> <span class="n">Readable</span> <span class="nb">format</span>
    <span class="n">nDateTimeOff</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>                           <span class="o">//</span><span class="n">Date</span> <span class="ow">and</span> <span class="n">time</span> <span class="n">when</span> <span class="n">the</span> <span class="n">error</span> <span class="n">disapeared</span><span class="o">.</span> <span class="n">Raw</span> <span class="n">data</span>
    <span class="n">sDateTimeOff</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>                      <span class="o">//</span><span class="n">Date</span> <span class="ow">and</span> <span class="n">time</span> <span class="n">when</span> <span class="n">the</span> <span class="n">error</span> <span class="n">disapeared</span><span class="o">.</span> <span class="n">Readable</span> <span class="nb">format</span>
    <span class="n">bWcState</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                        <span class="o">//</span><span class="n">WcState</span> <span class="n">variable</span> <span class="n">of</span> <span class="n">the</span> <span class="n">terminal</span>
    <span class="n">uiInfoDataState</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                         <span class="o">//</span><span class="n">InfoData</span><span class="o">.</span><span class="n">State</span> <span class="n">variable</span> <span class="n">of</span> <span class="n">the</span> <span class="n">terminal</span>
    <span class="n">sErrorMessage</span> <span class="p">:</span> <span class="n">STRING</span> <span class="p">(</span><span class="mi">128</span><span class="p">);</span>           <span class="o">//</span><span class="n">Error</span> <span class="n">message</span> <span class="n">corresponding</span> <span class="n">to</span> <span class="n">WcState</span> <span class="ow">and</span> <span class="n">InfoData</span><span class="o">.</span><span class="n">State</span>
    <span class="n">ErrorType</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>                                        <span class="o">//</span><span class="n">Error</span> <span class="n">types</span> <span class="p">(</span><span class="n">priorities</span><span class="p">)</span> <span class="n">need</span> <span class="n">to</span> <span class="n">be</span> <span class="n">developed</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-errorstate">DUT_ErrorState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="dutel2521-ctrl">
<h2>dutEL2521_Ctrl<a class="headerlink" href="#dutel2521-ctrl" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">dutEL2521_Ctrl</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">///</span><span class="n">The</span> <span class="n">control</span> <span class="n">word</span> <span class="p">(</span><span class="n">CW</span><span class="p">)</span> <span class="ow">is</span> <span class="n">located</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">output</span> <span class="n">process</span> <span class="n">image</span><span class="p">,</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">transmitted</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">controller</span> <span class="n">to</span> <span class="n">the</span> <span class="n">terminal</span><span class="o">.</span>
    <span class="o">///</span><span class="n">CW</span><span class="mf">.0</span> <span class="n">FREQ_SEL</span> <span class="mi">0</span><span class="nb">bin</span> <span class="o">/</span> <span class="mi">1</span><span class="nb">bin</span>  <span class="n">Rapid</span> <span class="n">change</span> <span class="n">of</span> <span class="n">the</span> <span class="n">base</span> <span class="n">frequency</span> <span class="p">(</span><span class="n">only</span> <span class="k">if</span> <span class="n">the</span> <span class="n">ramp</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">inactive</span><span class="p">):</span>
    <span class="o">///</span><span class="mi">0</span><span class="nb">bin</span> <span class="o">=</span> <span class="n">Base</span> <span class="n">frequency</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">object</span> <span class="mi">8001</span><span class="p">:</span><span class="mi">02</span><span class="p">)</span>
    <span class="o">///</span><span class="mi">1</span><span class="nb">bin</span> <span class="o">=</span> <span class="n">Base</span> <span class="n">frequency</span> <span class="mi">2</span> <span class="p">(</span><span class="nb">object</span> <span class="mi">8001</span><span class="p">:</span><span class="mi">03</span><span class="p">)</span>
    <span class="n">FREQ_SEL</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">CW</span><span class="mf">.1</span> <span class="n">RAMP_DIS</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">Operation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">ramp</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">cancelled</span><span class="p">,</span> <span class="ow">in</span> <span class="n">spite</span> <span class="n">of</span> <span class="nb">object</span> <span class="mi">8000</span><span class="p">:</span><span class="mi">06</span> <span class="n">being</span> <span class="n">active</span><span class="p">;</span> <span class="k">if</span> <span class="n">travel</span> <span class="n">distance</span> <span class="n">control</span> <span class="ow">is</span> <span class="n">active</span><span class="p">,</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">interrupted</span> <span class="n">by</span> <span class="n">this</span> <span class="n">bit</span>
    <span class="n">RAMP_DIS</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">CW</span><span class="mf">.2</span> <span class="n">GO_COUNTER</span> <span class="mi">1</span><span class="nb">bin</span>  <span class="n">If</span> <span class="n">travel</span> <span class="n">distance</span> <span class="n">control</span> <span class="ow">is</span> <span class="n">active</span> <span class="p">(</span><span class="nb">object</span> <span class="mi">8000</span><span class="p">:</span><span class="mi">0</span><span class="n">A</span><span class="p">),</span> <span class="n">then</span> <span class="n">a</span> <span class="n">pre</span><span class="o">-</span><span class="nb">set</span> <span class="n">counter</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">approached</span> <span class="n">when</span> <span class="n">the</span> <span class="n">bit</span> <span class="ow">is</span> <span class="nb">set</span>
    <span class="n">GO_COUNTER</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">CW</span><span class="mf">.5</span> <span class="n">CNT_CLR</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">The</span> <span class="n">contents</span> <span class="n">of</span> <span class="n">the</span> <span class="n">counter</span> <span class="ow">is</span> <span class="n">cleared</span> <span class="ow">or</span> <span class="nb">set</span> <span class="p">(</span><span class="nb">object</span> <span class="mi">8000</span><span class="p">:</span><span class="mi">0</span><span class="n">B</span><span class="p">)</span> <span class="n">by</span> <span class="n">this</span> <span class="n">bit</span><span class="o">.</span>
    <span class="o">///</span><span class="n">Any</span> <span class="n">overflow</span> <span class="ow">or</span> <span class="n">underflow</span> <span class="n">bits</span> <span class="n">that</span> <span class="n">might</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">are</span> <span class="n">also</span> <span class="n">cleared</span> <span class="n">by</span> <span class="n">this</span> <span class="n">bit</span><span class="o">.</span>
    <span class="o">///</span><span class="n">The</span> <span class="n">process</span> <span class="n">can</span> <span class="n">be</span> <span class="n">edge</span> <span class="n">triggered</span> <span class="ow">or</span> <span class="n">level</span> <span class="n">triggered</span> <span class="p">(</span><span class="nb">object</span> <span class="mi">8000</span><span class="p">:</span><span class="mi">05</span><span class="p">)</span><span class="o">.</span>
    <span class="n">CNT_CLR</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="dutel2521-status">
<h2>dutEL2521_Status<a class="headerlink" href="#dutel2521-status" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">dutEL2521_Status</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">///</span><span class="n">The</span> <span class="n">status</span> <span class="n">word</span> <span class="p">(</span><span class="n">SW</span><span class="p">)</span> <span class="ow">is</span> <span class="n">located</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">input</span> <span class="n">process</span> <span class="n">image</span><span class="p">,</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">transmitted</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">terminal</span> <span class="n">to</span> <span class="n">the</span> <span class="n">controller</span><span class="o">.</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.0</span> <span class="n">SEL_ACK</span><span class="o">/</span><span class="n">END_COUNTER</span> <span class="mi">1</span><span class="nb">bin</span>  <span class="n">Confirms</span> <span class="n">the</span> <span class="n">change</span> <span class="n">of</span> <span class="n">base</span> <span class="n">frequency</span><span class="o">.</span> <span class="n">At</span> <span class="n">activated</span> <span class="n">travel</span> <span class="n">distance</span> <span class="n">control</span><span class="p">:</span> <span class="n">target</span> <span class="n">counter</span> <span class="n">value</span> <span class="n">reached</span>
    <span class="n">SEL_ACK</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.1</span> <span class="n">RAMP_ACTIVE</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">Ramp</span> <span class="ow">is</span> <span class="n">currently</span> <span class="n">being</span> <span class="n">followed</span>
    <span class="n">RAMP_ACTIVE</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.2</span> <span class="n">UNDERFLOW</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">This</span> <span class="n">bit</span> <span class="ow">is</span> <span class="nb">set</span> <span class="k">if</span> <span class="n">the</span> <span class="mi">16</span><span class="o">-</span><span class="n">bit</span> <span class="n">counter</span> <span class="n">underflows</span> <span class="p">(</span><span class="mi">0</span> <span class="o">-&gt;</span> <span class="mi">65535</span><span class="p">)</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">reset</span> <span class="n">when</span> <span class="n">the</span> <span class="n">counter</span> <span class="n">drops</span> <span class="n">below</span> <span class="n">two</span> <span class="n">thirds</span> <span class="n">of</span> <span class="n">its</span> <span class="n">measuring</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">43690</span> <span class="o">-&gt;</span> <span class="mi">43689</span><span class="p">)</span> <span class="ow">or</span> <span class="n">immediately</span> <span class="n">an</span> <span class="n">overflow</span> <span class="n">occurs</span><span class="o">.</span>
    <span class="n">UNDERFLOW</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.3</span> <span class="n">OVERFLOW</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">This</span> <span class="n">bit</span> <span class="ow">is</span> <span class="nb">set</span> <span class="k">if</span> <span class="n">the</span> <span class="mi">16</span><span class="o">-</span><span class="n">bit</span> <span class="n">counter</span> <span class="n">overflows</span> <span class="p">(</span><span class="mi">65535</span> <span class="o">-&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">reset</span> <span class="n">when</span> <span class="n">the</span> <span class="n">counter</span> <span class="n">exceeds</span> <span class="n">one</span> <span class="n">third</span> <span class="n">of</span> <span class="n">its</span> <span class="n">measuring</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">21845</span> <span class="o">-&gt;</span> <span class="mi">21846</span><span class="p">)</span> <span class="ow">or</span> <span class="n">immediately</span> <span class="n">an</span> <span class="n">underflow</span> <span class="n">occurs</span>
    <span class="n">OVERFLOW</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.4</span> <span class="n">INPUT_T</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">Status</span> <span class="n">of</span> <span class="n">INPUT_T</span>
    <span class="n">INPUT_T</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.5</span> <span class="n">INPUT_Z</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">Status</span> <span class="n">of</span> <span class="n">INPUT_Z</span>
    <span class="n">INPUT_Z</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="n">SW</span><span class="mf">.6</span> <span class="n">ERROR</span> <span class="mi">1</span><span class="nb">bin</span> <span class="n">General</span> <span class="n">error</span> <span class="n">bit</span><span class="p">,</span> <span class="n">included</span> <span class="k">with</span> <span class="n">overflow</span><span class="o">/</span><span class="n">underflow</span>
    <span class="n">ERROR</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-epicshomecmd">
<h2>E_EpicsHomeCmd<a class="headerlink" href="#e-epicshomecmd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_EpicsHomeCmd</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">the</span> <span class="n">valid</span> <span class="n">options</span> <span class="k">for</span> <span class="n">homing</span> <span class="ow">in</span> <span class="n">FB_MotionStage</span>
<span class="p">(</span>
    <span class="n">LOW_LIMIT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">Low</span> <span class="n">limit</span> <span class="n">switch</span>
    <span class="n">HIGH_LIMIT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">//</span> <span class="n">High</span> <span class="n">limit</span> <span class="n">switch</span>
    <span class="n">HOME_VIA_LOW</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span> <span class="o">//</span> <span class="n">Home</span> <span class="n">switch</span> <span class="n">via</span> <span class="n">low</span> <span class="n">switch</span>
    <span class="n">HOME_VIA_HIGH</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span> <span class="o">//</span> <span class="n">Home</span> <span class="n">switch</span> <span class="n">via</span> <span class="n">high</span> <span class="n">switch</span>
    <span class="n">ABSOLUTE_SET</span> <span class="o">:=</span> <span class="mi">15</span><span class="p">,</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">here</span> <span class="n">to</span> <span class="n">be</span> <span class="n">fHomePosition</span>
    <span class="n">NONE</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">//</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">home</span><span class="p">,</span> <span class="n">ever</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-epicsinout">
<h2>E_EpicsInOut<a class="headerlink" href="#e-epicsinout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">Example</span> <span class="n">EPICS</span> <span class="n">states</span> <span class="n">enum</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="nb">all</span> <span class="n">versions</span> <span class="n">of</span> <span class="n">the</span> <span class="n">states</span> <span class="n">FBs</span>
<span class="o">//</span> <span class="n">Remove</span> <span class="n">strict</span> <span class="n">attribute</span> <span class="k">for</span> <span class="n">easier</span> <span class="n">handling</span>
<span class="n">TYPE</span> <span class="n">E_EpicsInOut</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">UNKNOWN</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">UNKNOWN</span> <span class="n">must</span> <span class="n">be</span> <span class="ow">in</span> <span class="n">slot</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">FB</span> <span class="n">breaks</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">OUT</span> <span class="n">at</span> <span class="n">slot</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">convention</span>
    <span class="n">IN</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-epicsmotorcmd">
<h2>E_EpicsMotorCmd<a class="headerlink" href="#e-epicsmotorcmd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_EpicsMotorCmd</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">valid</span> <span class="n">EPICS</span> <span class="n">commands</span> <span class="k">for</span> <span class="n">nCommand</span>
<span class="p">(</span>
    <span class="n">JOG</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">MOVE_VELOCITY</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">MOVE_RELATIVE</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">MOVE_ABSOLUTE</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">MOVE_MODULO</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">HOME</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">GEAR</span> <span class="o">:=</span> <span class="mi">30</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-motionfftype">
<h2>E_MotionFFType<a class="headerlink" href="#e-motionfftype" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_MotionFFType</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">STOPPER_FAULT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1000,</span>
    <span class="n">ZERO_RATE</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1001,</span>
    <span class="n">BPTM_TIMEOUT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1002,</span>
    <span class="n">BPTM_ERROR</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1003,</span>
    <span class="n">MAINT_MODE</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1004,</span>
    <span class="n">NOT_A_STATE</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1005,</span>
    <span class="n">INVALID_GOAL</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1006,</span>
    <span class="n">TOO_MANY_TRIPS</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1007,</span>
    <span class="n">BP_MISMATCH</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1008,</span>
    <span class="n">INTERNAL_ERROR</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1009,</span>
    <span class="n">PNEUMATIC_MOVE</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1010,</span>
    <span class="n">MOT_GENERIC</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#1011,</span>
    <span class="n">LOW_RESERVED_NC</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#2000,</span>
    <span class="n">HIGH_RESERVED_NC</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#20FF,</span>
    <span class="n">DEVICE_MOVE</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#2100</span>
<span class="p">)</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="n">MOT_GENERIC</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-motionrequest">
<h2>E_MotionRequest<a class="headerlink" href="#e-motionrequest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_MotionRequest</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">behavior</span> <span class="n">options</span> <span class="k">for</span> <span class="n">when</span> <span class="n">FB_MotionRequest</span> <span class="ow">is</span> <span class="n">run</span> <span class="n">during</span> <span class="n">an</span> <span class="n">active</span> <span class="n">move</span> <span class="kn">from</span> <span class="nn">another</span> <span class="n">source</span>
<span class="p">(</span>
    <span class="n">WAIT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">INTERRUPT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">ABORT</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionrequest">FB_MotionRequest</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-pnuematicactuatorpositionstate">
<h2>E_PnuematicActuatorPositionState<a class="headerlink" href="#e-pnuematicactuatorpositionstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">Defines</span> <span class="n">the</span> <span class="n">positions</span> <span class="k">for</span> <span class="n">a</span> <span class="n">pnuematic</span> <span class="n">actuator</span>
<span class="n">TYPE</span> <span class="n">E_PnuematicActuatorPositionState</span> <span class="p">:</span>
<span class="p">(</span>
   <span class="n">RETRACTED</span>    <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">Out</span> <span class="n">limit</span> <span class="n">switch</span> <span class="ow">is</span> <span class="n">active</span>
   <span class="n">INSERTED</span>    <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">In</span> <span class="n">limit</span> <span class="n">switch</span> <span class="ow">is</span> <span class="n">active</span>
   <span class="n">MOVING</span>    <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">//</span> <span class="n">Neither</span> <span class="n">limit</span> <span class="n">switches</span> <span class="ow">is</span> <span class="n">Active</span>
   <span class="n">INVALID</span> <span class="o">:=</span><span class="mi">3</span> <span class="o">//</span> <span class="n">Invalid</span> <span class="n">state</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-stagebrakemode">
<h2>E_StageBrakeMode<a class="headerlink" href="#e-stagebrakemode" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_StageBrakeMode</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">when</span> <span class="n">to</span> <span class="n">send</span> <span class="n">the</span> <span class="n">brake</span> <span class="n">disengage</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">FB_MotionStage</span>
<span class="p">(</span>
    <span class="n">IF_ENABLED</span><span class="p">,</span> <span class="o">//</span> <span class="n">Disengage</span> <span class="n">brake</span> <span class="n">when</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">enabled</span>
    <span class="n">IF_MOVING</span><span class="p">,</span> <span class="o">//</span> <span class="n">Disengage</span> <span class="n">brake</span> <span class="n">when</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">moving</span>
    <span class="n">NO_BRAKE</span> <span class="o">//</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">change</span> <span class="n">the</span> <span class="n">brake</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">FB_MotionStage</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-stageenablemode">
<h2>E_StageEnableMode<a class="headerlink" href="#e-stageenablemode" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_StageEnableMode</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">conditions</span> <span class="n">when</span> <span class="n">FB_MotionStage</span> <span class="n">automatically</span> <span class="n">sets</span> <span class="n">bEnable</span>
<span class="p">(</span>
    <span class="n">ALWAYS</span><span class="p">,</span> <span class="o">//</span> <span class="n">Always</span> <span class="nb">set</span> <span class="n">bEnable</span> <span class="n">to</span> <span class="n">TRUE</span>
    <span class="n">NEVER</span><span class="p">,</span>  <span class="o">//</span> <span class="n">Only</span> <span class="n">change</span> <span class="n">bEnable</span> <span class="n">on</span> <span class="n">errors</span>
    <span class="n">DURING_MOTION</span>  <span class="o">//</span> <span class="n">Enable</span> <span class="n">before</span> <span class="n">motion</span><span class="p">,</span> <span class="n">disable</span> <span class="n">after</span> <span class="n">motion</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-statepmpsstatus">
<h2>E_StatePMPSStatus<a class="headerlink" href="#e-statepmpsstatus" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_StatePMPSStatus</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="o">//</span> <span class="n">No</span> <span class="n">other</span> <span class="n">enum</span> <span class="n">state</span> <span class="n">describes</span> <span class="n">it</span>
    <span class="n">UNKNOWN</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="o">//</span> <span class="n">Moving</span> <span class="n">toward</span> <span class="n">a</span> <span class="n">known</span> <span class="n">state</span>
    <span class="n">TRANSITION</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">//</span> <span class="n">Within</span> <span class="n">a</span> <span class="n">known</span> <span class="n">state</span><span class="p">,</span> <span class="ow">not</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">leave</span>
    <span class="n">AT_STATE</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">some</span> <span class="n">way</span> <span class="n">disabled</span><span class="p">,</span> <span class="n">either</span> <span class="k">with</span> <span class="n">maint</span> <span class="n">mode</span> <span class="ow">or</span> <span class="n">arbiter</span> <span class="n">disable</span>
    <span class="n">DISABLED</span> <span class="o">:=</span> <span class="mi">3</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-teststates">
<h2>E_TestStates<a class="headerlink" href="#e-teststates" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_TestStates</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Unknown</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">TARGET1</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">TARGET2</span> <span class="o">:=</span> <span class="mi">3</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="el5042-status">
<h2>EL5042_Status<a class="headerlink" href="#el5042-status" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;EL5042_Status has been renamed to ST_EL5042_Status&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">EL5042_Status</span> <span class="p">:</span> <span class="n">ST_EL5042_Status</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-el5042-status">ST_EL5042_Status</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-epicshomecmd">
<h2>ENUM_EpicsHomeCmd<a class="headerlink" href="#enum-epicshomecmd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_EpicsHomeCmd&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_EpicsHomeCmd</span> <span class="p">:</span> <span class="n">E_EpicsHomeCmd</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-epicsinout">
<h2>ENUM_EpicsInOut<a class="headerlink" href="#enum-epicsinout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_EpicsInOut&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_EpicsInOut</span> <span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsinout">E_EpicsInOut</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-epicsinout-int">
<h2>ENUM_EpicsInOut_INT<a class="headerlink" href="#enum-epicsinout-int" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use ENUM_EpicsInOut&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">Example</span> <span class="n">EPICS</span> <span class="n">states</span> <span class="n">enum</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="nb">all</span> <span class="n">versions</span> <span class="n">of</span> <span class="n">the</span> <span class="n">states</span> <span class="n">FBs</span>
<span class="o">//</span> <span class="n">Remove</span> <span class="n">strict</span> <span class="n">attribute</span> <span class="k">for</span> <span class="n">easier</span> <span class="n">handling</span>
<span class="n">TYPE</span> <span class="n">ENUM_EpicsInOut_INT</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">UNKNOWN</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">UNKNOWN</span> <span class="n">must</span> <span class="n">be</span> <span class="ow">in</span> <span class="n">slot</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">FB</span> <span class="n">breaks</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">OUT</span> <span class="n">at</span> <span class="n">slot</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">convention</span>
    <span class="n">IN</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="p">)</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-epicsinout">ENUM_EpicsInOut</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-epicsmotorcmd">
<h2>ENUM_EpicsMotorCmd<a class="headerlink" href="#enum-epicsmotorcmd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_EpicsMotorCmd&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_EpicsMotorCmd</span> <span class="p">:</span> <span class="n">E_EpicsMotorCmd</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-motionfftype">
<h2>ENUM_MotionFFType<a class="headerlink" href="#enum-motionfftype" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_MotionFFType&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_MotionFFType</span> <span class="p">:</span> <span class="n">E_MotionFFType</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-motionrequest">
<h2>ENUM_MotionRequest<a class="headerlink" href="#enum-motionrequest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_MotionRequest&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_MotionRequest</span> <span class="p">:</span> <span class="n">E_MotionRequest</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-pnuematicactuatorpositionstate">
<h2>ENUM_PnuematicActuatorPositionState<a class="headerlink" href="#enum-pnuematicactuatorpositionstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_PnuematicActuatorPositionState&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_PnuematicActuatorPositionState</span> <span class="p">:</span> <span class="n">E_PnuematicActuatorPositionState</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-pnuematicactuatorpositionstate">E_PnuematicActuatorPositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-stagebrakemode">
<h2>ENUM_StageBrakeMode<a class="headerlink" href="#enum-stagebrakemode" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_StageBrakeMode&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_StageBrakeMode</span> <span class="p">:</span> <span class="n">E_StageBrakeMode</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stagebrakemode">E_StageBrakeMode</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-stageenablemode">
<h2>ENUM_StageEnableMode<a class="headerlink" href="#enum-stageenablemode" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_StageEnableMode&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_StageEnableMode</span> <span class="p">:</span> <span class="n">E_StageEnableMode</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="enum-statepmpsstatus">
<h2>ENUM_StatePMPSStatus<a class="headerlink" href="#enum-statepmpsstatus" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use E_StatePMPSStatus&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_StatePMPSStatus</span> <span class="p">:</span> <span class="n">E_StatePMPSStatus</span><span class="p">;</span> <span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-statepmpsstatus">E_StatePMPSStatus</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-el5042-status">
<h2>ST_EL5042_Status<a class="headerlink" href="#st-el5042-status" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_EL5042_Status</span> <span class="p">:</span>
<span class="n">STRUCT</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-errorsystem">
<h2>ST_ErrorSystem<a class="headerlink" href="#st-errorsystem" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_ErrorSystem</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">//</span><span class="n">Array</span> <span class="n">of</span> <span class="n">error</span> <span class="n">data</span><span class="o">.</span> <span class="n">Size</span> <span class="o">=</span> <span class="n">cSizeOfErrorData</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">GVL</span>
    <span class="n">aErrorData</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="n">OF</span> <span class="n">DUT_TerminalError</span><span class="p">;</span>
    <span class="n">lNextErrorID</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>                                      <span class="o">//</span><span class="n">ErrorID</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">error</span> <span class="n">entry</span>
    <span class="n">nNoErrors</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                                                       <span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">errors</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">list</span>
    <span class="n">nNoOverflows</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>                                        <span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">overflows</span><span class="o">.</span> <span class="n">How</span> <span class="n">many</span> <span class="n">error</span> <span class="n">entries</span> <span class="n">have</span> <span class="n">been</span> <span class="n">lost</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-terminalerror">DUT_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#gvl">GVL</a></p></li>
<li><p><a class="reference internal" href="#gvl-errorsystem">GVL_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-motionpneumaticactuator">
<h2>ST_MotionPneumaticActuator<a class="headerlink" href="#st-motionpneumaticactuator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ST_MotionPneumaticActuator</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">the</span> <span class="n">EPICS</span> <span class="n">interface</span> <span class="n">to</span> <span class="n">actuating</span> <span class="n">a</span> <span class="n">pneumatic</span> <span class="n">stage</span>
<span class="n">STRUCT</span>
     <span class="p">(</span><span class="o">*</span> <span class="n">Hardware</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span><span class="n">Readbacks</span>
    <span class="o">//</span><span class="n">Limit</span> <span class="n">Switch</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bInLimitSwitch</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">IN</span> <span class="n">limit</span> <span class="ow">is</span> <span class="n">reached</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_bInLimitSwitch</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bOutLimitSwitch</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">OUT</span> <span class="n">limit</span> <span class="ow">is</span> <span class="n">reached</span>
    <span class="s1">&#39;}</span>
    <span class="n">i_bOutLimitSwitch</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Controls</span>
    <span class="o">//</span><span class="n">Digital</span> <span class="n">outputs</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">bRetractDigitalOutput</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FALSE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">TRUE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">Retract</span> <span class="n">digital</span> <span class="n">output</span> <span class="ow">is</span> <span class="n">active</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_bRetract</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">bInsertDigitalOutput</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FALSE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">TRUE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">Insert</span> <span class="n">digital</span> <span class="n">output</span> <span class="ow">is</span> <span class="n">active</span>
    <span class="s1">&#39;}</span>
    <span class="n">q_bInsert</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>


    <span class="o">//</span><span class="n">Logic</span> <span class="ow">and</span> <span class="n">supervisory</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">bInterlockOK</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">actuator</span> <span class="n">has</span> <span class="n">permission</span> <span class="n">to</span> <span class="n">move</span> <span class="ow">in</span> <span class="n">either</span> <span class="n">direction</span>
    <span class="s1">&#39;}</span>
    <span class="n">bILK_OK</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">bInsertEnable</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">actuator</span> <span class="n">had</span> <span class="n">permission</span> <span class="n">to</span> <span class="n">be</span> <span class="n">retracted</span>
    <span class="s1">&#39;}</span>
    <span class="n">bInsertOK</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">bRetractEnable</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">actuator</span> <span class="n">had</span> <span class="n">permission</span> <span class="n">to</span> <span class="n">be</span> <span class="n">inserted</span>
    <span class="s1">&#39;}</span>
    <span class="n">bRetractOK</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Commands</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="kn">from</span> <span class="nn">Epics</span> <span class="n">to</span> <span class="n">comand</span> <span class="n">the</span> <span class="n">actuator</span> <span class="n">to</span>  <span class="n">move</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">CMD</span><span class="p">:</span><span class="n">IN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">by</span> <span class="n">EPICS</span> <span class="ow">and</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">request</span> <span class="n">Insert</span> <span class="n">motion</span>
    <span class="s1">&#39;}</span>
    <span class="n">bInsert_SW</span>        <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">CMD</span><span class="p">:</span><span class="n">OUT</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">by</span> <span class="n">EPICS</span> <span class="ow">and</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">request</span> <span class="n">retract</span> <span class="n">motion</span>
    <span class="s1">&#39;}</span>
    <span class="n">bRetract_SW</span>    <span class="p">:</span>    <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Returns</span><span class="o">*</span><span class="p">)</span>
     <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">a</span> <span class="n">command</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">bBusy</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FALSE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">TRUE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">a</span> <span class="n">command</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;ve done a command and it has finished</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">bDone</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FALSE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">TRUE</span>
      <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">command</span> <span class="n">finished</span> <span class="n">successfully</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">bReset</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">errors</span>
    <span class="s1">&#39;}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re in an error state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bError</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">FALSE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">TRUE</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re in an error state</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

     <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span> <span class="k">if</span> <span class="n">nonzero</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">nErrorId</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Error</span> <span class="n">code</span> <span class="k">if</span> <span class="n">nonzero</span>
    <span class="s1">&#39;}</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Message</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">the</span> <span class="n">error</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
     <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">sErrorMessage</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Message</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">the</span> <span class="n">error</span> <span class="n">state</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">nPositionState</span> <span class="p">;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">mbbi</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZRST</span> <span class="n">RETRACTED</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONST</span> <span class="n">INSERTED</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">TWST</span> <span class="n">MOVING</span> <span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">THST</span> <span class="n">INVALID</span> <span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Pneumatic</span> <span class="n">actuator</span> <span class="n">position</span>
    <span class="s1">&#39;}</span>

    <span class="n">eState</span>    <span class="p">:</span>    <span class="n">E_PnuematicActuatorPositionState</span> <span class="o">:=</span> <span class="n">E_PnuematicActuatorPositionState</span><span class="o">.</span><span class="n">INVALID</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-pnuematicactuatorpositionstate">E_PnuematicActuatorPositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-motionstage">
<h2>ST_MotionStage<a class="headerlink" href="#st-motionstage" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_MotionStage</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">the</span> <span class="n">EPICS</span> <span class="n">interface</span> <span class="n">to</span> <span class="n">moving</span> <span class="n">a</span> <span class="n">motor</span> <span class="ow">in</span> <span class="n">TwinCAT</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Hardware</span> <span class="o">*</span><span class="p">)</span>

    <span class="o">//</span> <span class="n">PLC</span> <span class="n">Axis</span> <span class="n">Reference</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">NC</span> <span class="n">Forward</span> <span class="n">Limit</span> <span class="n">Switch</span><span class="p">:</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ok</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">bLimitForwardEnable</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">NC</span> <span class="n">Backward</span> <span class="n">Limit</span> <span class="n">Switch</span><span class="p">:</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ok</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">bLimitBackwardEnable</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">NO</span> <span class="n">Home</span> <span class="n">Switch</span><span class="p">:</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">at</span> <span class="n">home</span>
    <span class="n">bHome</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">NC</span> <span class="n">Brake</span> <span class="n">Output</span><span class="p">:</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">release</span> <span class="n">brake</span>
    <span class="n">bBrakeRelease</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">NC</span> <span class="n">STO</span> <span class="n">Input</span><span class="p">:</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ok</span> <span class="n">to</span> <span class="n">move</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bHardwareEnable</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">STO</span> <span class="ow">not</span> <span class="n">hit</span>
    <span class="s1">&#39;}</span>
    <span class="n">bHardwareEnable</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Raw</span> <span class="n">encoder</span> <span class="n">IO</span> <span class="k">for</span> <span class="n">ULINT</span> <span class="p">(</span><span class="n">Biss</span><span class="o">-</span><span class="n">C</span><span class="p">)</span>
    <span class="n">nRawEncoderULINT</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Raw</span> <span class="n">encoder</span> <span class="n">IO</span> <span class="k">for</span> <span class="n">UINT</span> <span class="p">(</span><span class="n">Relative</span> <span class="n">Encoders</span><span class="p">)</span>
    <span class="n">nRawEncoderUINT</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Raw</span> <span class="n">encoder</span> <span class="n">IO</span> <span class="k">for</span> <span class="n">INT</span> <span class="p">(</span><span class="n">LVDT</span><span class="p">)</span>
    <span class="n">nRawEncoderINT</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Psuedo</span><span class="o">-</span><span class="n">hardware</span> <span class="o">*</span><span class="p">)</span>

    <span class="o">//</span> <span class="n">Forward</span> <span class="n">enable</span> <span class="n">EPS</span> <span class="n">summary</span>
    <span class="n">bAllForwardEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Backward</span> <span class="n">enable</span> <span class="n">EPS</span> <span class="n">summary</span>
    <span class="n">bAllBackwardEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Enable</span> <span class="n">EPS</span> <span class="n">summary</span> <span class="n">encapsulating</span> <span class="n">emergency</span> <span class="n">stop</span> <span class="n">button</span> <span class="ow">and</span> <span class="nb">any</span> <span class="n">additional</span> <span class="n">motion</span> <span class="n">preventive</span> <span class="n">hardware</span>
    <span class="n">bAllEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Forward</span> <span class="n">virtual</span> <span class="n">gantry</span> <span class="n">limit</span> <span class="n">switch</span>
    <span class="n">bGantryForwardEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Backward</span> <span class="n">virtual</span> <span class="n">gantry</span> <span class="n">limit</span> <span class="n">switch</span>
    <span class="n">bGantryBackwardEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">count</span> <span class="n">summary</span><span class="p">,</span> <span class="k">if</span> <span class="n">linked</span> <span class="n">above</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">nEncoderCount</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Count</span> <span class="kn">from</span> <span class="nn">encoder</span> <span class="n">hardware</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncoderCount</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Forward</span> <span class="n">Enable</span> <span class="n">EPS</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">stEPSF</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Forward</span> <span class="n">Enable</span> <span class="n">Interlocks</span>
    <span class="s1">&#39;}</span>
    <span class="n">stEPSForwardEnable</span><span class="p">:</span> <span class="n">DUT_EPS</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Backward</span> <span class="n">Enable</span> <span class="n">EPS</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">stEPSB</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Backward</span> <span class="n">Enable</span> <span class="n">Interlocks</span>
    <span class="s1">&#39;}</span>
    <span class="n">stEPSBackwardEnable</span><span class="p">:</span> <span class="n">DUT_EPS</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Power</span> <span class="n">Enable</span> <span class="n">EPS</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">stEPSP</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Power</span> <span class="n">Interlocks</span>
    <span class="s1">&#39;}</span>
    <span class="n">stEPSPowerEnable</span><span class="p">:</span> <span class="n">DUT_EPS</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Settings</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Name</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="n">log</span> <span class="n">messages</span><span class="p">,</span> <span class="n">fast</span> <span class="n">faults</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span>
    <span class="n">sName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">independently</span> <span class="n">of</span> <span class="n">PMPS</span> <span class="ow">or</span> <span class="n">other</span> <span class="n">safety</span> <span class="n">systems</span><span class="o">.</span>
    <span class="n">bPowerSelf</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Determines</span> <span class="n">when</span> <span class="n">we</span> <span class="n">automatically</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">motor</span>
    <span class="n">nEnableMode</span><span class="p">:</span> <span class="n">E_StageEnableMode</span><span class="o">:=</span><span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Determines</span> <span class="n">when</span> <span class="n">we</span> <span class="n">automatically</span> <span class="n">disengage</span> <span class="n">the</span> <span class="n">brake</span>
    <span class="n">nBrakeMode</span><span class="p">:</span> <span class="n">E_StageBrakeMode</span><span class="o">:=</span><span class="n">E_StageBrakeMode</span><span class="o">.</span><span class="n">IF_ENABLED</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Determines</span> <span class="n">our</span> <span class="n">encoder</span> <span class="n">homing</span> <span class="n">strategy</span>
    <span class="n">nHomingMode</span><span class="p">:</span> <span class="n">E_EpicsHomeCmd</span><span class="o">:=</span><span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">NONE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">true</span> <span class="n">to</span> <span class="n">activate</span> <span class="n">gantry</span> <span class="n">EPS</span>
    <span class="n">bGantryAxis</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">gantry</span> <span class="n">difference</span> <span class="n">tolerance</span>
    <span class="n">nGantryTol</span><span class="p">:</span> <span class="n">LINT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">count</span> <span class="n">at</span> <span class="n">which</span> <span class="n">this</span> <span class="n">axis</span> <span class="ow">is</span> <span class="n">aligned</span> <span class="k">with</span> <span class="n">other</span> <span class="n">axis</span>
    <span class="n">nEncRef</span><span class="p">:</span> <span class="n">ULINT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Commands</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">request</span> <span class="n">enables</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">errors</span> <span class="ow">and</span> <span class="n">other</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bReset</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">internally</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">errors</span>
    <span class="s1">&#39;}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">start</span> <span class="ow">or</span> <span class="n">stop</span> <span class="n">a</span> <span class="n">move</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">an</span> <span class="n">axis</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bUserEnable</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">DISABLE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ENABLE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">power</span> <span class="n">entirely</span> <span class="k">for</span> <span class="n">an</span> <span class="n">axis</span>
    <span class="s1">&#39;}</span>
    <span class="n">bUserEnable</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Shortcut</span> <span class="n">Commands</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">a</span> <span class="n">move</span> <span class="n">to</span> <span class="n">fPosition</span> <span class="k">with</span> <span class="n">fVelocity</span>
    <span class="n">bMoveCmd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">the</span> <span class="n">homing</span> <span class="n">routine</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bHomeCmd</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Start</span> <span class="n">the</span> <span class="n">homing</span> <span class="n">routine</span>
    <span class="s1">&#39;}</span>
    <span class="n">bHomeCmd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Command</span> <span class="n">Args</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">what</span> <span class="n">kind</span> <span class="n">of</span> <span class="n">move</span> <span class="n">to</span> <span class="n">do</span>
    <span class="n">nCommand</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="k">pass</span> <span class="n">additional</span> <span class="n">data</span> <span class="n">to</span> <span class="n">some</span> <span class="n">commands</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">a</span> <span class="n">destination</span> <span class="k">for</span> <span class="n">the</span> <span class="n">move</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">a</span> <span class="n">move</span> <span class="n">velocity</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">a</span> <span class="n">move</span> <span class="n">acceleration</span>
    <span class="n">fAcceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">a</span> <span class="n">move</span> <span class="n">deceleration</span>
    <span class="n">fDeceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">a</span> <span class="n">home</span> <span class="n">position</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">fHomePosition</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Used</span> <span class="n">internally</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">home</span> <span class="n">position</span>
    <span class="s1">&#39;}</span>
    <span class="n">fHomePosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Info</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Unique</span> <span class="n">ID</span> <span class="n">assigned</span> <span class="n">to</span> <span class="n">each</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">NC</span>
    <span class="n">nMotionAxisID</span><span class="p">:</span> <span class="n">UDINT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Returns</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">done</span> <span class="n">enabling</span>
    <span class="n">bEnableDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">a</span> <span class="n">command</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;ve done a command and it has finished</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">been</span> <span class="n">homed</span><span class="p">,</span> <span class="ow">or</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">need</span> <span class="n">to</span> <span class="n">be</span> <span class="n">homed</span>
    <span class="n">bHomed</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span> <span class="n">have</span> <span class="n">safety</span> <span class="n">permission</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">bSafetyReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re in an error state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">bError</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">error</span> <span class="n">state</span>
        <span class="n">update</span><span class="p">:</span> <span class="mi">100</span><span class="n">Hz</span> <span class="n">notify</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span> <span class="k">if</span> <span class="n">nonzero</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">nErrorId</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Error</span> <span class="n">code</span> <span class="k">if</span> <span class="n">nonzero</span>
        <span class="n">update</span><span class="p">:</span> <span class="mi">100</span><span class="n">Hz</span> <span class="n">notify</span>
    <span class="s1">&#39;}</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Message</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">the</span> <span class="n">error</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">sErrorMessage</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Message</span> <span class="n">to</span> <span class="n">identify</span> <span class="n">the</span> <span class="n">error</span> <span class="n">state</span>
        <span class="n">update</span><span class="p">:</span> <span class="mi">100</span><span class="n">Hz</span> <span class="n">notify</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Internal</span> <span class="n">hook</span> <span class="k">for</span> <span class="n">custom</span> <span class="n">error</span> <span class="n">messages</span>
    <span class="n">sCustomErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">MC_ReadParameterSet</span> <span class="n">Output</span>
    <span class="n">stAxisParameters</span><span class="p">:</span> <span class="n">ST_AxisParameterSet</span><span class="p">;</span>
    <span class="o">//</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;ve updated stAxisParameters at least once</span>
    <span class="n">bAxisParamsInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Misc</span> <span class="n">axis</span> <span class="n">status</span> <span class="n">information</span> <span class="k">for</span> <span class="n">the</span> <span class="n">IOC</span>
    <span class="n">stAxisStatus</span><span class="p">:</span> <span class="n">DUT_AxisStatus_v0_01</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Other</span> <span class="n">status</span> <span class="n">information</span> <span class="k">for</span> <span class="n">users</span> <span class="n">of</span> <span class="n">the</span> <span class="n">IOC</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Position</span> <span class="n">lag</span> <span class="n">difference</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">fPosDiff</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Position</span> <span class="n">lag</span> <span class="n">difference</span>
    <span class="s1">&#39;}</span>
    <span class="n">fPosDiff</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-axisstatus-v0-01">DUT_AxisStatus_v0_01</a></p></li>
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#e-stagebrakemode">E_StageBrakeMode</a></p></li>
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-positionstate">
<h2>ST_PositionState<a class="headerlink" href="#st-positionstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PositionState</span> <span class="p">:</span>
    <span class="o">//</span> <span class="n">Defines</span> <span class="n">settings</span> <span class="ow">and</span> <span class="n">current</span> <span class="n">safety</span> <span class="n">status</span> <span class="k">for</span> <span class="n">moves</span> <span class="n">to</span> <span class="n">specific</span> <span class="n">positions</span> <span class="k">for</span> <span class="n">an</span> <span class="n">axis</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">Name</span> <span class="k">as</span> <span class="n">queried</span> <span class="n">via</span> <span class="n">the</span> <span class="n">NAME</span> <span class="n">PV</span> <span class="ow">in</span> <span class="n">EPICS</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">NAME</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Name</span> <span class="n">of</span> <span class="n">this</span> <span class="n">position</span> <span class="n">state</span>
    <span class="s1">&#39;}</span>
    <span class="n">sName</span><span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Position</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">this</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SETPOINT</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Axis</span> <span class="n">position</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">this</span> <span class="n">state</span>
    <span class="s1">&#39;}</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ENCODER</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Encoder</span> <span class="n">count</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">this</span> <span class="n">state</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncoderCount</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Maximum</span> <span class="n">allowable</span> <span class="n">deviation</span> <span class="kn">from</span> <span class="nn">fPosition</span> <span class="k">while</span> <span class="n">at</span> <span class="n">the</span> <span class="n">state</span>
    <span class="n">fDelta</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Speed</span> <span class="n">at</span> <span class="n">which</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span> <span class="n">this</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">VELO</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Speed</span> <span class="n">at</span> <span class="n">which</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span> <span class="n">this</span> <span class="n">state</span>
    <span class="s1">&#39;}</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="o">//</span> <span class="p">(</span><span class="n">optional</span><span class="p">)</span> <span class="n">Acceleration</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="n">moves</span> <span class="n">to</span> <span class="n">this</span> <span class="n">state</span>
    <span class="n">fAccel</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="o">//</span> <span class="p">(</span><span class="n">optional</span><span class="p">)</span> <span class="n">Deceleration</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="n">moves</span> <span class="n">to</span> <span class="n">this</span> <span class="n">state</span>
    <span class="n">fDecel</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Safety</span> <span class="n">parameter</span><span class="o">.</span> <span class="n">This</span> <span class="n">must</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">by</span> <span class="n">the</span> <span class="n">PLC</span> <span class="n">program</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">moves</span> <span class="n">to</span> <span class="n">this</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="n">change</span> <span class="k">as</span> <span class="n">conditions</span> <span class="n">change</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MOVE_OK</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">FALSE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">TRUE</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">move</span> <span class="n">would</span> <span class="n">be</span> <span class="n">safe</span>
    <span class="s1">&#39;}</span>
    <span class="n">bMoveOk</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Signifies</span> <span class="n">to</span> <span class="n">FB_PositionStateLock</span> <span class="n">that</span> <span class="n">this</span> <span class="n">state</span> <span class="n">should</span> <span class="n">be</span> <span class="n">immutable</span>
    <span class="n">bLocked</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">you</span> <span class="n">make</span> <span class="n">your</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">defaults</span> <span class="n">to</span> <span class="n">FALSE</span> <span class="n">so</span> <span class="n">that</span> <span class="n">uninitialized</span> <span class="n">states</span> <span class="n">can</span> <span class="n">never</span> <span class="n">be</span> <span class="n">moved</span> <span class="n">to</span>
    <span class="n">bValid</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span> <span class="n">the</span> <span class="n">raw</span> <span class="n">encoder</span> <span class="n">counts</span> <span class="n">to</span> <span class="n">define</span> <span class="n">the</span> <span class="n">state</span>
    <span class="n">bUseRawCounts</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">by</span> <span class="n">FB_PositionStateInternal</span> <span class="n">when</span> <span class="n">called</span>
    <span class="n">bUpdated</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">We</span> <span class="n">give</span> <span class="n">this</span> <span class="n">a</span> <span class="n">state</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">load</span> <span class="n">parameters</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">pmps</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">stPMPS</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatelock">FB_PositionStateLock</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-renishawabsenc">
<h2>ST_RenishawAbsEnc<a class="headerlink" href="#st-renishawabsenc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Renishaw</span> <span class="n">BiSS</span><span class="o">-</span><span class="n">C</span> <span class="n">absolute</span> <span class="n">encoder</span> <span class="n">used</span> <span class="k">with</span> <span class="n">an</span> <span class="n">EL5042</span>
<span class="n">TYPE</span> <span class="n">ST_RenishawAbsEnc</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">Count</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Connect</span> <span class="n">to</span> <span class="n">encoder</span> <span class="s2">&quot;Position&quot;</span> <span class="nb">input</span>
    <span class="n">Status</span><span class="p">:</span> <span class="n">ST_EL5042_Status</span><span class="p">;</span> <span class="o">//</span> <span class="n">Status</span> <span class="n">struct</span> <span class="n">placeholder</span>
    <span class="n">Ref</span><span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Encoder</span> <span class="n">zero</span> <span class="n">position</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">aligned</span> <span class="n">position</span> <span class="k">with</span> <span class="n">gantries</span><span class="p">)</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#el5042">EL5042</a></p></li>
<li><p><a class="reference internal" href="#st-el5042-status">ST_EL5042_Status</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-stateepicstoplc">
<h2>ST_StateEpicsToPlc<a class="headerlink" href="#st-stateepicstoplc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_StateEpicsToPlc</span> <span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">data</span> <span class="n">structure</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">EPICS</span> <span class="nb">input</span> <span class="n">connection</span> <span class="n">points</span> <span class="k">for</span> <span class="n">the</span> <span class="n">state</span> <span class="n">movers</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">struct</span> <span class="n">flows</span> <span class="kn">from</span> <span class="nn">EPICS</span> <span class="n">to</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>

    <span class="n">It</span> <span class="n">includes</span> <span class="n">everything</span> <span class="k">except</span> <span class="n">the</span> <span class="n">SET</span> <span class="n">PV</span><span class="p">,</span> <span class="n">which</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">included</span> <span class="n">here</span>
    <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">sourced</span> <span class="kn">from</span> <span class="nn">enum</span> <span class="n">values</span> <span class="n">unique</span> <span class="n">to</span> <span class="n">the</span> <span class="n">application</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">PVs</span><span class="p">,</span> <span class="n">which</span> <span class="n">are</span>
    <span class="n">gathered</span> <span class="ow">in</span> <span class="n">their</span> <span class="n">own</span> <span class="n">data</span> <span class="nb">type</span><span class="p">,</span> <span class="n">ST_StatePMPSEpicsToPlc</span><span class="o">.</span> <span class="n">That</span> <span class="n">actually</span> <span class="n">means</span> <span class="n">that</span> <span class="n">this</span> <span class="n">only</span>
    <span class="n">holds</span> <span class="n">the</span> <span class="n">RESET</span> <span class="n">PV</span><span class="p">,</span> <span class="k">for</span> <span class="n">now</span><span class="o">.</span>

    <span class="n">nSetValue</span> <span class="n">here</span> <span class="ow">is</span> <span class="n">actively</span> <span class="n">used</span> <span class="n">by</span> <span class="n">state</span> <span class="n">blocks</span> <span class="n">even</span> <span class="n">though</span> <span class="n">it</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">exposed</span>
    <span class="n">directly</span> <span class="n">to</span> <span class="n">EPICS</span><span class="o">.</span> <span class="n">You</span> <span class="n">should</span> <span class="n">avoid</span> <span class="n">manually</span> <span class="n">modifying</span> <span class="n">it</span> <span class="ow">or</span> <span class="k">else</span>
    <span class="n">you</span> <span class="n">may</span> <span class="n">interfere</span> <span class="k">with</span> <span class="n">normal</span> <span class="n">operations</span> <span class="n">of</span> <span class="n">the</span> <span class="n">state</span> <span class="n">function</span> <span class="n">blocks</span><span class="o">.</span>

    <span class="n">For</span> <span class="n">including</span> <span class="n">your</span> <span class="n">own</span> <span class="n">ENUM</span> <span class="nb">input</span><span class="p">,</span> <span class="n">you</span> <span class="n">should</span> <span class="n">pytmc</span> <span class="n">pragma</span> <span class="n">the</span> <span class="n">PV</span> <span class="n">name</span> <span class="n">to</span> <span class="n">end</span> <span class="ow">in</span> <span class="s2">&quot;SET&quot;</span><span class="p">,</span>
    <span class="ow">and</span> <span class="n">match</span> <span class="n">the</span> <span class="n">prefix</span> <span class="n">of</span> <span class="n">this</span> <span class="n">FB</span><span class="s1">&#39;s &quot;RESET&quot; PV. Then, you can include your enum</span>
    <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="n">IN_OUT</span> <span class="n">var</span> <span class="ow">and</span> <span class="n">let</span> <span class="n">the</span> <span class="n">EPICS</span> <span class="n">IOC</span> <span class="n">handle</span> <span class="n">it</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">For</span> <span class="n">internal</span> <span class="n">use</span> <span class="n">only</span><span class="o">.</span> <span class="n">This</span> <span class="n">holds</span> <span class="n">new</span> <span class="n">goal</span> <span class="n">positions</span> <span class="k">as</span> <span class="n">an</span> <span class="n">integer</span><span class="p">,</span> <span class="k">else</span> <span class="n">it</span> <span class="ow">is</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">new</span> <span class="n">state</span> <span class="n">move</span> <span class="n">request</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">written</span> <span class="n">to</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">user</span><span class="s1">&#39;s input enum.</span>
    <span class="n">nSetValue</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">acknowledge</span> <span class="ow">and</span> <span class="n">clear</span> <span class="n">an</span> <span class="n">error</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RESET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-statepmpsepicstoplc">ST_StatePMPSEpicsToPlc</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-stateplctoepics">
<h2>ST_StatePlcToEpics<a class="headerlink" href="#st-stateplctoepics" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_StatePlcToEpics</span> <span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">data</span> <span class="n">structure</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">EPICS</span> <span class="n">connection</span> <span class="n">points</span> <span class="k">for</span> <span class="n">the</span> <span class="n">state</span> <span class="n">movers</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">struct</span> <span class="n">flows</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">PLC</span> <span class="n">to</span> <span class="n">EPICS</span><span class="o">.</span>

    <span class="n">It</span> <span class="n">includes</span> <span class="n">everything</span> <span class="k">except</span> <span class="n">the</span> <span class="n">GET</span> <span class="n">PV</span><span class="p">,</span> <span class="n">which</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">included</span> <span class="n">here</span>
    <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">sourced</span> <span class="kn">from</span> <span class="nn">enum</span> <span class="n">values</span> <span class="n">unique</span> <span class="n">to</span> <span class="n">the</span> <span class="n">application</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">PVs</span><span class="p">,</span> <span class="n">which</span> <span class="n">are</span>
    <span class="n">gathered</span> <span class="ow">in</span> <span class="n">their</span> <span class="n">own</span> <span class="n">data</span> <span class="nb">type</span><span class="p">,</span> <span class="n">ST_StatePMPSPlcToEpics</span><span class="o">.</span>

    <span class="n">nGetValue</span> <span class="n">here</span> <span class="ow">is</span> <span class="n">actively</span> <span class="n">used</span> <span class="n">by</span> <span class="n">state</span> <span class="n">blocks</span> <span class="n">even</span> <span class="n">though</span> <span class="n">it</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">exposed</span> <span class="n">directly</span>
    <span class="n">to</span> <span class="n">EPICS</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">safe</span> <span class="n">to</span> <span class="n">read</span> <span class="n">this</span> <span class="n">value</span><span class="p">,</span> <span class="n">but</span> <span class="n">you</span> <span class="n">should</span> <span class="n">avoid</span> <span class="n">modifying</span> <span class="n">it</span><span class="p">,</span> <span class="n">which</span> <span class="n">may</span>
    <span class="n">interfere</span> <span class="k">with</span> <span class="n">normal</span> <span class="n">operations</span> <span class="n">of</span> <span class="n">the</span> <span class="n">state</span> <span class="n">function</span> <span class="n">blocks</span><span class="o">.</span>

    <span class="n">For</span> <span class="n">including</span> <span class="n">your</span> <span class="n">own</span> <span class="n">ENUM</span> <span class="nb">input</span><span class="p">,</span> <span class="n">you</span> <span class="n">should</span> <span class="n">pytmc</span> <span class="n">pragma</span> <span class="n">the</span> <span class="n">PV</span> <span class="n">name</span> <span class="n">to</span> <span class="n">end</span> <span class="ow">in</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
    <span class="ow">and</span> <span class="n">match</span> <span class="n">the</span> <span class="n">prefix</span> <span class="n">of</span> <span class="n">this</span> <span class="n">FB</span><span class="s1">&#39;s &quot;DONE&quot; PV. Then, you can include your enum</span>
    <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumGet</span> <span class="n">IN_OUT</span> <span class="n">var</span> <span class="ow">and</span> <span class="n">let</span> <span class="n">the</span> <span class="n">EPICS</span> <span class="n">IOC</span> <span class="n">handle</span> <span class="n">it</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">For</span> <span class="n">internal</span> <span class="n">use</span> <span class="n">only</span><span class="o">.</span> <span class="n">This</span> <span class="n">holds</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">index</span> <span class="k">as</span> <span class="n">an</span> <span class="n">integer</span><span class="p">,</span> <span class="k">else</span> <span class="n">it</span> <span class="ow">is</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="n">changing</span> <span class="n">states</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">at</span> <span class="nb">any</span> <span class="n">particular</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">nGetValue</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">active</span> <span class="n">state</span> <span class="n">move</span> <span class="ow">and</span> <span class="n">FALSE</span> <span class="n">otherwise</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BUSY</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="n">TRUE</span> <span class="n">after</span> <span class="n">a</span> <span class="n">move</span> <span class="n">completes</span> <span class="ow">and</span> <span class="n">FALSE</span> <span class="n">otherwise</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DONE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">most</span> <span class="n">recent</span> <span class="n">move</span> <span class="n">had</span> <span class="n">an</span> <span class="n">error</span> <span class="ow">and</span> <span class="n">FALSE</span> <span class="n">otherwise</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">an</span> <span class="n">NC</span> <span class="n">error</span> <span class="n">code</span> <span class="n">during</span> <span class="n">an</span> <span class="n">error</span> <span class="k">if</span> <span class="n">one</span> <span class="n">exists</span> <span class="ow">or</span> <span class="n">left</span> <span class="n">at</span> <span class="mi">0</span> <span class="n">otherwise</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRID</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nErrorID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">an</span> <span class="n">appropriate</span> <span class="n">error</span> <span class="n">message</span> <span class="n">during</span> <span class="n">an</span> <span class="n">error</span> <span class="k">if</span> <span class="n">one</span> <span class="n">exists</span> <span class="ow">or</span> <span class="n">left</span> <span class="k">as</span> <span class="n">an</span> <span class="n">empty</span> <span class="n">string</span> <span class="n">otherwise</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRMSG</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMsg</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-statepmpsplctoepics">ST_StatePMPSPlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-statepmpsepicstoplc">
<h2>ST_StatePMPSEpicsToPlc<a class="headerlink" href="#st-statepmpsepicstoplc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_StatePMPSEpicsToPlc</span> <span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">data</span> <span class="n">structure</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">connection</span> <span class="n">points</span> <span class="k">for</span> <span class="n">the</span> <span class="n">state</span> <span class="n">movers</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">struct</span> <span class="n">flows</span> <span class="kn">from</span> <span class="nn">EPICS</span> <span class="n">to</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">User</span> <span class="n">setting</span><span class="p">:</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">arbiter</span><span class="p">,</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">it</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PMPS</span><span class="p">:</span><span class="n">ARB</span><span class="p">:</span><span class="n">ENABLE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">bArbiterEnabled</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">User</span> <span class="n">setting</span><span class="p">:</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">maintenance</span> <span class="n">mode</span> <span class="p">(</span><span class="n">Fast</span> <span class="n">fault</span><span class="p">,</span> <span class="n">free</span> <span class="n">motion</span><span class="p">),</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">it</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PMPS</span><span class="p">:</span><span class="n">MAINT</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">bMaintMode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-statepmpsplctoepics">
<h2>ST_StatePMPSPlcToEpics<a class="headerlink" href="#st-statepmpsplctoepics" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_StatePMPSPlcToEpics</span> <span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">data</span> <span class="n">structure</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">connection</span> <span class="n">points</span> <span class="k">for</span> <span class="n">the</span> <span class="n">state</span> <span class="n">movers</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">struct</span> <span class="n">flows</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">PLC</span> <span class="n">to</span> <span class="n">EPICS</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">database</span> <span class="n">entry</span> <span class="k">for</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">always</span> <span class="n">be</span> <span class="n">present</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PMPS</span><span class="p">:</span><span class="n">TRANS</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">stTransitionDb</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
</section>
<section id="gvls">
<h1>GVLs<a class="headerlink" href="#gvls" title="Link to this heading"></a></h1>
<section id="global-version">
<h2>Global_Version<a class="headerlink" href="#global-version" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcGenerated&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no-analysis&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;linkalways&#39;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">function</span> <span class="n">has</span> <span class="n">been</span> <span class="n">automatically</span> <span class="n">generated</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">project</span> <span class="n">information</span><span class="o">.</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;const_non_replaced&#39;</span><span class="p">}</span>
    <span class="n">stLibVersion_lcls_twincat_motion</span> <span class="p">:</span> <span class="n">ST_LibVersion</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iMajor</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iMinor</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iBuild</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iRevision</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nFlags</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sVersion</span> <span class="o">:=</span> <span class="s1">&#39;0.0.0&#39;</span><span class="p">);</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl">
<h2>GVL<a class="headerlink" href="#gvl" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span>
    <span class="n">nHomingError</span><span class="p">:</span><span class="n">UDINT</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#14D00;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-errorsystem">
<h2>GVL_ErrorSystem<a class="headerlink" href="#gvl-errorsystem" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="n">cSizeOfErrorData</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">128</span><span class="p">;</span>

<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="motion-gvl">
<h2>MOTION_GVL<a class="headerlink" href="#motion-gvl" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span>
    <span class="o">//</span> <span class="n">Global</span> <span class="n">file</span> <span class="n">reader</span> <span class="n">instance</span><span class="p">,</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">fbStandardPMPSDB</span>
    <span class="n">fbPmpsFileReader</span><span class="p">:</span> <span class="n">FB_JsonFileToJsonDoc</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">)</span><span class="n">DB</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="o">//</span> <span class="n">Global</span> <span class="n">DB</span> <span class="n">handler</span><span class="p">,</span> <span class="n">Must</span> <span class="n">be</span> <span class="n">called</span> <span class="ow">in</span> <span class="n">PLC</span> <span class="n">project</span> <span class="n">to</span> <span class="n">use</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="k">for</span> <span class="n">a</span> <span class="n">motion</span> <span class="n">project</span>
    <span class="n">fbStandardPMPSDB</span><span class="p">:</span> <span class="n">FB_Standard_PMPSDB</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Debug</span><span class="p">,</span> <span class="n">records</span> <span class="n">the</span> <span class="n">highest</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">ND</span> <span class="n">states</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span> <span class="n">Can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">limit</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span> <span class="n">to</span> <span class="n">save</span> <span class="n">on</span> <span class="n">memory</span> <span class="n">usage</span> <span class="ow">and</span> <span class="n">PV</span> <span class="n">count</span><span class="o">.</span>
    <span class="n">nMaxStateMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Debug</span><span class="p">,</span> <span class="n">records</span> <span class="n">the</span> <span class="n">highest</span> <span class="n">state</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span> <span class="n">Can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">limit</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">to</span> <span class="n">save</span> <span class="n">on</span> <span class="n">memory</span> <span class="n">usage</span> <span class="ow">and</span> <span class="n">PV</span> <span class="n">count</span><span class="o">.</span>
    <span class="n">nMaxStates</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-standard-pmpsdb">FB_Standard_PMPSDB</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="motionconstants">
<h2>MotionConstants<a class="headerlink" href="#motionconstants" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Global</span> <span class="n">Configurable</span> <span class="n">Motion</span> <span class="n">Constants</span>

    <span class="n">These</span> <span class="n">are</span> <span class="n">reconfigurable</span> <span class="n">at</span> <span class="n">the</span> <span class="n">project</span> <span class="n">level</span><span class="o">.</span>
    <span class="n">When</span> <span class="n">reconfigured</span> <span class="n">they</span> <span class="n">are</span> <span class="nb">set</span> <span class="n">prior</span> <span class="n">to</span> <span class="n">compilation</span> <span class="ow">and</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">changed</span> <span class="n">at</span> <span class="n">runtime</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="p">(</span><span class="o">*</span>
    <span class="n">Arbitary</span> <span class="n">cap</span> <span class="n">on</span> <span class="n">multidimensional</span> <span class="n">states</span> <span class="n">to</span> <span class="n">simplify</span> <span class="n">statements</span> <span class="k">for</span> <span class="n">the</span> <span class="n">compiler</span><span class="o">.</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">reconfigurable</span> <span class="n">at</span> <span class="n">the</span> <span class="n">project</span> <span class="n">level</span> <span class="ow">and</span> <span class="n">should</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">highest</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="o">.</span>
    <span class="n">If</span> <span class="n">you</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">sure</span> <span class="n">how</span> <span class="n">many</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">used</span> <span class="n">per</span> <span class="n">state</span> <span class="n">block</span><span class="p">,</span> <span class="n">check</span> <span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">nMaxStateMotorCount</span>
    <span class="o">*</span><span class="p">)</span>
    <span class="n">MAX_STATE_MOTORS</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>
<section id="pous">
<h1>POUs<a class="headerlink" href="#pous" title="Link to this heading"></a></h1>
<section id="checkbounds">
<h2>CheckBounds<a class="headerlink" href="#checkbounds" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckBounds</span> <span class="p">:</span> <span class="n">DINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">index</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span>  <span class="n">index</span> <span class="o">&lt;</span> <span class="n">lower</span> <span class="n">THEN</span>
    <span class="n">CheckBounds</span> <span class="o">:=</span> <span class="n">lower</span><span class="p">;</span>
<span class="n">ELSIF</span>  <span class="n">index</span> <span class="o">&gt;</span> <span class="n">upper</span> <span class="n">THEN</span>
    <span class="n">CheckBounds</span> <span class="o">:=</span> <span class="n">upper</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckBounds</span> <span class="o">:=</span> <span class="n">index</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkdivdint">
<h2>CheckDivDInt<a class="headerlink" href="#checkdivdint" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckDivDInt</span> <span class="p">:</span> <span class="n">DINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">divisor</span><span class="p">:</span><span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">CheckDivDInt</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckDivDInt</span><span class="o">:=</span><span class="n">divisor</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkdivlint">
<h2>CheckDivLInt<a class="headerlink" href="#checkdivlint" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckDivLInt</span> <span class="p">:</span> <span class="n">LINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">divisor</span><span class="p">:</span><span class="n">LINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">CheckDivLInt</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckDivLInt</span><span class="o">:=</span><span class="n">divisor</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkdivlreal">
<h2>CheckDivLReal<a class="headerlink" href="#checkdivlreal" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckDivLReal</span> <span class="p">:</span> <span class="n">LREAL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">divisor</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">CheckDivLReal</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckDivLReal</span><span class="o">:=</span><span class="n">divisor</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="checkdivreal">
<h2>CheckDivReal<a class="headerlink" href="#checkdivreal" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span>
<span class="n">FUNCTION</span> <span class="n">CheckDivReal</span> <span class="p">:</span> <span class="n">REAL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">divisor</span><span class="p">:</span><span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Implicitly</span> <span class="n">generated</span> <span class="n">code</span> <span class="p">:</span> <span class="n">Only</span> <span class="n">an</span> <span class="n">Implementation</span> <span class="n">suggestion</span>
<span class="p">{</span><span class="n">noflow</span><span class="p">}</span>
<span class="n">IF</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">CheckDivReal</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">CheckDivReal</span><span class="o">:=</span><span class="n">divisor</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>
<span class="p">{</span><span class="n">flow</span><span class="p">}</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="ek1200">
<h2>EK1200<a class="headerlink" href="#ek1200" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">EK1200</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="el1008">
<h2>EL1008<a class="headerlink" href="#el1008" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL1008</span> <span class="o">|</span> <span class="mi">8</span><span class="o">-</span><span class="n">channel</span> <span class="n">digital</span> <span class="nb">input</span> <span class="n">terminal</span> <span class="mi">24</span> <span class="n">V</span> <span class="n">DC</span><span class="p">,</span> <span class="mi">3</span> <span class="n">ms</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL1008</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL1008_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL1008_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">Channel_1_Input</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">Channel_2_Input</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">Channel_3_Input</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">Channel_4_Input</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">Channel_5_Input</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">Channel_6_Input</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">Channel_7_Input</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">Channel_8_Input</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el1018">
<h2>EL1018<a class="headerlink" href="#el1018" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL1018</span> <span class="o">|</span> <span class="mi">8</span><span class="o">-</span><span class="n">channel</span> <span class="n">digital</span> <span class="nb">input</span> <span class="n">terminal</span> <span class="mi">24</span> <span class="n">V</span> <span class="n">DC</span><span class="p">,</span> <span class="mi">10</span> <span class="n">µs</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL1018</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span>  <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL1018_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL1018_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">Channel_1_Input</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">Channel_2_Input</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">Channel_3_Input</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">Channel_4_Input</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">Channel_5_Input</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">Channel_6_Input</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">Channel_7_Input</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">Channel_8_Input</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el1808">
<h2>EL1808<a class="headerlink" href="#el1808" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL1808</span> <span class="o">|</span> <span class="n">HD</span> <span class="n">EtherCAT</span> <span class="n">Terminals</span><span class="p">,</span> <span class="mi">8</span><span class="o">-</span><span class="n">channel</span> <span class="n">digital</span> <span class="nb">input</span> <span class="mi">24</span> <span class="n">V</span> <span class="n">DC</span><span class="p">,</span> <span class="mi">3</span> <span class="n">ms</span><span class="p">,</span> <span class="mi">2</span><span class="o">-</span><span class="n">wire</span> <span class="n">connection</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL1808</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL1808_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL1808_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">Channel_1_Input</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">Channel_2_Input</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">Channel_3_Input</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">Channel_4_Input</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">Channel_5_Input</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">Channel_6_Input</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">Channel_7_Input</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">Channel_8_Input</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el1809">
<h2>EL1809<a class="headerlink" href="#el1809" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL1809</span> <span class="o">|</span> <span class="n">HD</span> <span class="n">EtherCAT</span> <span class="n">Terminals</span><span class="p">,</span> <span class="mi">16</span><span class="o">-</span><span class="n">channel</span> <span class="n">digital</span> <span class="nb">input</span> <span class="mi">24</span> <span class="n">V</span> <span class="n">DC</span><span class="p">,</span> <span class="mi">3</span> <span class="n">ms</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL1809</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_9</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_10</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_11</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_12</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_13</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_14</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_15</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_16</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_9_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_10_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_11_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_12_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_13_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_14_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_15_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_16_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL1809_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL1809_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">Channel_1_Input</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">Channel_2_Input</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">Channel_3_Input</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">Channel_4_Input</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">Channel_5_Input</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">Channel_6_Input</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">Channel_7_Input</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">Channel_8_Input</span><span class="p">;</span>
            <span class="n">bDi_9</span><span class="o">:=</span><span class="n">Channel_9_Input</span><span class="p">;</span>
            <span class="n">bDi_10</span><span class="o">:=</span><span class="n">Channel_10_Input</span><span class="p">;</span>
            <span class="n">bDi_11</span><span class="o">:=</span><span class="n">Channel_11_Input</span><span class="p">;</span>
            <span class="n">bDi_12</span><span class="o">:=</span><span class="n">Channel_12_Input</span><span class="p">;</span>
            <span class="n">bDi_13</span><span class="o">:=</span><span class="n">Channel_13_Input</span><span class="p">;</span>
            <span class="n">bDi_14</span><span class="o">:=</span><span class="n">Channel_14_Input</span><span class="p">;</span>
            <span class="n">bDi_15</span><span class="o">:=</span><span class="n">Channel_15_Input</span><span class="p">;</span>
            <span class="n">bDi_16</span><span class="o">:=</span><span class="n">Channel_16_Input</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_9</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_10</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_11</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_12</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_13</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_14</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_15</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_16</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el1819">
<h2>EL1819<a class="headerlink" href="#el1819" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL1819</span> <span class="o">|</span> <span class="n">HD</span> <span class="n">EtherCAT</span> <span class="n">Terminals</span><span class="p">,</span> <span class="mi">16</span><span class="o">-</span><span class="n">channel</span> <span class="n">digital</span> <span class="nb">input</span> <span class="mi">24</span> <span class="n">V</span> <span class="n">DC</span><span class="p">,</span> <span class="mi">10</span> <span class="n">µs</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL1819</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_9</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_10</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_11</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_12</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_13</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_14</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_15</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDi_16</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_9_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_10_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_11_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_12_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_13_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_14_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_15_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_16_Input</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL1819_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL1819_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">Channel_1_Input</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">Channel_2_Input</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">Channel_3_Input</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">Channel_4_Input</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">Channel_5_Input</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">Channel_6_Input</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">Channel_7_Input</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">Channel_8_Input</span><span class="p">;</span>
            <span class="n">bDi_9</span><span class="o">:=</span><span class="n">Channel_9_Input</span><span class="p">;</span>
            <span class="n">bDi_10</span><span class="o">:=</span><span class="n">Channel_10_Input</span><span class="p">;</span>
            <span class="n">bDi_11</span><span class="o">:=</span><span class="n">Channel_11_Input</span><span class="p">;</span>
            <span class="n">bDi_12</span><span class="o">:=</span><span class="n">Channel_12_Input</span><span class="p">;</span>
            <span class="n">bDi_13</span><span class="o">:=</span><span class="n">Channel_13_Input</span><span class="p">;</span>
            <span class="n">bDi_14</span><span class="o">:=</span><span class="n">Channel_14_Input</span><span class="p">;</span>
            <span class="n">bDi_15</span><span class="o">:=</span><span class="n">Channel_15_Input</span><span class="p">;</span>
            <span class="n">bDi_16</span><span class="o">:=</span><span class="n">Channel_16_Input</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">bDi_1</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_2</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_3</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_4</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_5</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_6</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_7</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_8</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_9</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_10</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_11</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_12</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_13</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_14</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_15</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDi_16</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el2014">
<h2>EL2014<a class="headerlink" href="#el2014" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">EL2014</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bDo_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL2014_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">diagnostic</span> <span class="n">variables</span> <span class="ow">and</span> <span class="n">device</span> <span class="n">diag</span> <span class="n">variables</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">EL2014_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">bDo_1</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">bDo_2</span><span class="p">;</span>
            <span class="n">Channel_3_Output</span><span class="o">:=</span><span class="n">bDo_3</span><span class="p">;</span>
            <span class="n">Channel_4_Output</span><span class="o">:=</span><span class="n">bDo_4</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_3_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_4_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el2252">
<h2>EL2252<a class="headerlink" href="#el2252" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL2252</span> <span class="o">|</span> <span class="n">XFC</span><span class="p">,</span> <span class="mi">2</span><span class="o">-</span><span class="n">channel</span> <span class="n">digital</span> <span class="n">output</span> <span class="n">terminal</span> <span class="k">with</span> <span class="n">time</span> <span class="n">stamp</span><span class="p">,</span> <span class="n">tri</span><span class="o">-</span><span class="n">state</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL2252</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bDo_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL2252_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Add</span> <span class="n">the</span> <span class="n">DC</span> <span class="n">sync</span> <span class="n">variables</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EL2252_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">bDo_1</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">bDo_2</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el2808">
<h2>EL2808<a class="headerlink" href="#el2808" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">EL2808</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bDo_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL2808_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">EL2808_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">bDo_1</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">bDo_2</span><span class="p">;</span>
            <span class="n">Channel_3_Output</span><span class="o">:=</span><span class="n">bDo_3</span><span class="p">;</span>
            <span class="n">Channel_4_Output</span><span class="o">:=</span><span class="n">bDo_4</span><span class="p">;</span>
            <span class="n">Channel_5_Output</span><span class="o">:=</span><span class="n">bDo_5</span><span class="p">;</span>
            <span class="n">Channel_6_Output</span><span class="o">:=</span><span class="n">bDo_6</span><span class="p">;</span>
            <span class="n">Channel_7_Output</span><span class="o">:=</span><span class="n">bDo_7</span><span class="p">;</span>
            <span class="n">Channel_8_Output</span><span class="o">:=</span><span class="n">bDo_8</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_3_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_4_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_5_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_6_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_7_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_8_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el2819">
<h2>EL2819<a class="headerlink" href="#el2819" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">EL2819</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bDo_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_4</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_5</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_6</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_7</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_8</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_9</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_10</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_11</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_12</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_13</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_14</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_15</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDo_16</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">Channel_1_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_2_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_3_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_4_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_5_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_6_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_7_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_8_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_9_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_10_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_11_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_12_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_13_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_14_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_15_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Channel_16_Output</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL2819_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">diagnostic</span> <span class="n">variables</span> <span class="ow">and</span> <span class="n">device</span> <span class="n">diag</span> <span class="n">variables</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">EL2819_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span><span class="o">=</span><span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">bDo_1</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">bDo_2</span><span class="p">;</span>
            <span class="n">Channel_3_Output</span><span class="o">:=</span><span class="n">bDo_3</span><span class="p">;</span>
            <span class="n">Channel_4_Output</span><span class="o">:=</span><span class="n">bDo_4</span><span class="p">;</span>
            <span class="n">Channel_5_Output</span><span class="o">:=</span><span class="n">bDo_5</span><span class="p">;</span>
            <span class="n">Channel_6_Output</span><span class="o">:=</span><span class="n">bDo_6</span><span class="p">;</span>
            <span class="n">Channel_7_Output</span><span class="o">:=</span><span class="n">bDo_7</span><span class="p">;</span>
            <span class="n">Channel_8_Output</span><span class="o">:=</span><span class="n">bDo_8</span><span class="p">;</span>
            <span class="n">Channel_9_Output</span><span class="o">:=</span><span class="n">bDo_9</span><span class="p">;</span>
            <span class="n">Channel_10_Output</span><span class="o">:=</span><span class="n">bDo_10</span><span class="p">;</span>
            <span class="n">Channel_11_Output</span><span class="o">:=</span><span class="n">bDo_11</span><span class="p">;</span>
            <span class="n">Channel_12_Output</span><span class="o">:=</span><span class="n">bDo_12</span><span class="p">;</span>
            <span class="n">Channel_13_Output</span><span class="o">:=</span><span class="n">bDo_13</span><span class="p">;</span>
            <span class="n">Channel_14_Output</span><span class="o">:=</span><span class="n">bDo_14</span><span class="p">;</span>
            <span class="n">Channel_15_Output</span><span class="o">:=</span><span class="n">bDo_15</span><span class="p">;</span>
            <span class="n">Channel_16_Output</span><span class="o">:=</span><span class="n">bDo_16</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Channel_1_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_2_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_3_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_4_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_5_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_6_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_7_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_8_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_9_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_10_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_11_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_12_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_13_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_14_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_15_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">Channel_16_Output</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el3174-0002">
<h2>EL3174_0002<a class="headerlink" href="#el3174-0002" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL3174</span><span class="o">-</span><span class="mi">0002</span> <span class="o">|</span> <span class="mi">4</span><span class="o">-</span><span class="n">channel</span> <span class="n">analog</span> <span class="nb">input</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="o">/</span><span class="mf">0.</span><span class="o">..+</span><span class="mi">10</span><span class="n">V</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="o">/</span><span class="mi">0</span><span class="o">/+</span><span class="mf">4.</span><span class="o">.</span><span class="mf">.20</span><span class="n">mA</span><span class="p">,</span> <span class="mi">16</span> <span class="n">bit</span><span class="p">,</span> <span class="n">differential</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL3174_0002</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iAi_Ch1_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iAi_Ch2_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iAi_Ch3_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iAi_Ch4_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="o">//</span><span class="n">Channels</span>
    <span class="n">AI_Std_Ch_1_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_1_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_2_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_2_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_3_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_3_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_4_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_Std_Ch_4_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Terminal</span> <span class="n">status</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL3174_0002_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Status</span> <span class="n">words</span> <span class="n">of</span> <span class="n">the</span> <span class="n">channels</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span> <span class="o">:=</span> <span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL3174_0002_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">iAi_Ch1_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch_1_Value</span><span class="p">;</span>
            <span class="n">iAi_Ch2_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch_2_Value</span><span class="p">;</span>
            <span class="n">iAi_Ch3_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch_3_Value</span><span class="p">;</span>
            <span class="n">iAi_Ch4_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch_4_Value</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">iAi_Ch1_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">iAi_Ch2_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">iAi_Ch3_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">iAi_Ch4_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el3214">
<h2>EL3214<a class="headerlink" href="#el3214" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL3214</span> <span class="o">|</span> <span class="mi">4</span><span class="o">-</span><span class="n">channel</span> <span class="n">analog</span> <span class="nb">input</span> <span class="n">terminal</span><span class="p">,</span> <span class="n">PT100</span> <span class="p">(</span><span class="n">RTD</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL3214</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iAi_Ch1_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iAi_Ch2_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iAi_Ch3_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iAi_Ch4_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="o">//</span><span class="n">Channels</span>
    <span class="n">AI_RTD_Ch_1_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_1_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_2_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_2_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_3_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_3_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_4_Status</span>      <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">AI_RTD_Ch_4_Value</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Terminal</span> <span class="n">status</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL3214_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Status</span> <span class="n">words</span> <span class="n">of</span> <span class="n">the</span> <span class="n">channels</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span> <span class="o">:=</span> <span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL3214_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">iAi_Ch1_Value</span> <span class="o">:=</span> <span class="n">AI_RTD_Ch_1_Value</span><span class="p">;</span>
            <span class="n">iAi_Ch2_Value</span> <span class="o">:=</span> <span class="n">AI_RTD_Ch_2_Value</span><span class="p">;</span>
            <span class="n">iAi_Ch3_Value</span> <span class="o">:=</span> <span class="n">AI_RTD_Ch_3_Value</span><span class="p">;</span>
            <span class="n">iAi_Ch4_Value</span> <span class="o">:=</span> <span class="n">AI_RTD_Ch_4_Value</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">iAi_Ch1_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">iAi_Ch2_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">iAi_Ch3_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">iAi_Ch4_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el3255">
<h2>EL3255<a class="headerlink" href="#el3255" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL3255</span> <span class="o">|</span> <span class="mi">5</span><span class="o">-</span><span class="n">channel</span> <span class="n">potentiometer</span> <span class="n">measurement</span> <span class="k">with</span> <span class="n">sensor</span> <span class="n">supply</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL3255</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Ch1_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">Ch2_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">Ch3_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">Ch4_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">Ch5_Value</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">AI_Std_Ch1_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch2_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch3_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch4_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">AI_Std_Ch5_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL3255_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">Status</span> <span class="n">words</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL3255_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">EN</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">Ch1_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch1_Value</span><span class="p">;</span>
            <span class="n">Ch2_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch2_Value</span><span class="p">;</span>
            <span class="n">Ch3_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch3_Value</span><span class="p">;</span>
            <span class="n">Ch4_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch4_Value</span><span class="p">;</span>
            <span class="n">Ch5_Value</span> <span class="o">:=</span> <span class="n">AI_Std_Ch5_Value</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Ch1_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Ch2_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Ch3_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Ch4_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Ch5_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el5002">
<h2>EL5002<a class="headerlink" href="#el5002" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL5002</span> <span class="o">|</span> <span class="mi">2</span><span class="o">-</span><span class="n">chennel</span> <span class="n">SSI</span> <span class="n">absolute</span> <span class="n">encoder</span> <span class="n">terminal</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL5002</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Ch1_Counter_Value</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">Ch2_Counter_Value</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">udi_Ch1_Cnt_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">udi_Ch2_Cnt_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL5002_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">Status</span> <span class="n">words</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL5002_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">EN</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">Ch1_Counter_Value</span> <span class="o">:=</span> <span class="n">udi_Ch1_Cnt_Value</span><span class="p">;</span>
            <span class="n">Ch2_Counter_Value</span> <span class="o">:=</span> <span class="n">udi_Ch2_Cnt_Value</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Ch1_Counter_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Ch2_Counter_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el5021">
<h2>EL5021<a class="headerlink" href="#el5021" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL5021</span> <span class="o">|</span> <span class="mi">1</span><span class="o">-</span><span class="n">channel</span> <span class="n">Sin</span><span class="o">/</span><span class="n">Cos</span> <span class="n">encoder</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL5021</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Counter_Value</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">Latch_Value</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">udiCounter_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">udiLatch_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL5021_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">Status</span> <span class="n">words</span><span class="p">,</span> <span class="n">control</span> <span class="n">words</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL5021_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">EN</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">Counter_Value</span> <span class="o">:=</span> <span class="n">udiCounter_Value</span><span class="p">;</span>
            <span class="n">Latch_Value</span> <span class="o">:=</span> <span class="n">udiLatch_Value</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Counter_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Latch_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el5042">
<h2>EL5042<a class="headerlink" href="#el5042" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL5042</span> <span class="o">|</span> <span class="mi">2</span><span class="o">-</span><span class="n">channel</span> <span class="n">BiSS</span><span class="o">-</span><span class="n">C</span> <span class="n">absolute</span> <span class="n">encoder</span> <span class="n">terminal</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL5042</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Ch1_Position</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="n">Ch2_Position</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">FB_Inputs_ch1_Position</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="n">FB_Inputs_ch2_Position</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL5042_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">Status</span> <span class="n">words</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL5042_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">EN</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">Ch1_Position</span> <span class="o">:=</span> <span class="n">FB_Inputs_ch1_Position</span><span class="p">;</span>
            <span class="n">Ch2_Position</span> <span class="o">:=</span> <span class="n">FB_Inputs_ch2_Position</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Ch1_Position</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Ch2_Position</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el5101">
<h2>EL5101<a class="headerlink" href="#el5101" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">EL5101</span> <span class="o">|</span> <span class="mi">1</span><span class="o">-</span><span class="n">channel</span> <span class="n">incremental</span> <span class="n">encoder</span> <span class="n">terminal</span><span class="p">,</span> <span class="mi">5</span><span class="n">V</span><span class="p">,</span> <span class="n">RS422</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL5101</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Counter_Value</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">Latch_Value</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">uiCounter_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">uiLatch_Value</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL5101_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Channel</span> <span class="n">Status</span> <span class="n">word</span><span class="p">,</span> <span class="n">control</span> <span class="n">words</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL5101_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">EN</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">Counter_Value</span> <span class="o">:=</span> <span class="n">uiCounter_Value</span><span class="p">;</span>
            <span class="n">Latch_Value</span> <span class="o">:=</span> <span class="n">uiLatch_Value</span><span class="p">;</span>
    <span class="n">ELSE</span>
            <span class="n">Counter_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">Latch_Value</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el7211-v1-00">
<h2>EL7211_v1_00<a class="headerlink" href="#el7211-v1-00" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL7211</span> <span class="o">|</span> <span class="n">Servo</span> <span class="n">motor</span> <span class="n">termional</span> <span class="mi">5</span> <span class="n">A</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL7211_v1_00</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">AND</span> <span class="p">(</span><span class="n">WcState_WcState</span> <span class="n">OR</span> <span class="n">InfoData_State</span><span class="o">&lt;&gt;</span><span class="mi">16</span><span class="c1">#8) THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="el9410">
<h2>EL9410<a class="headerlink" href="#el9410" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL9410</span> <span class="o">|</span> <span class="n">E</span><span class="o">-</span><span class="n">Bus</span> <span class="n">power</span> <span class="n">supplier</span> <span class="ow">and</span> <span class="n">refresher</span><span class="p">,</span> <span class="n">diagnostics</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL9410</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">bStatus_Us_UV</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bStatus_Up_UV</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL9410_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Status</span> <span class="n">bits</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL9410_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el9505">
<h2>EL9505<a class="headerlink" href="#el9505" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">EL9505</span> <span class="o">|</span> <span class="n">Power</span> <span class="n">supply</span> <span class="n">terminal</span> <span class="mi">5</span><span class="n">V</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL9505</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">bStatus_Uo_Power_OK</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bStatus_Uo_Overload</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>
    <span class="n">EL9505_Error</span> <span class="p">:</span> <span class="n">FB_TerminalError</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="n">TODO</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Status</span> <span class="n">bits</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Error</span> <span class="n">FB</span> <span class="n">instance</span>
<span class="n">EL9505_Error</span><span class="p">(</span>
    <span class="n">En</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">iTerminal_ID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">,</span>
    <span class="n">bWcState</span> <span class="o">:=</span> <span class="n">WcState_WcState</span><span class="p">,</span>
    <span class="n">uiInfoData_State</span> <span class="o">:=</span> <span class="n">InfoData_State</span><span class="p">,</span>
    <span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-terminalerror">FB_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="el9576-v1-00">
<h2>EL9576_v1_00<a class="headerlink" href="#el9576-v1-00" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="n">EL9576</span> <span class="o">|</span> <span class="n">Brake</span> <span class="n">terminal</span> <span class="p">(</span><span class="n">vap</span> <span class="ow">and</span> <span class="n">resistor</span><span class="p">)</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">EL9576_v1_00</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">OverTemperature</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">I2TError</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">I2TWarning</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">OverVoltage</span>  <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">UnderVoltage</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ChopperOn</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">DCLinkVoltage</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">DutyCycle</span>  <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">ResistorCurrent</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">BCTOverTemperature</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">BCTI2TError</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">BCTI2TWarning</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">BCTOverVoltage</span>  <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">BCTUnderVoltage</span>  <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">BCTChopperOn</span>  <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">BCTDCLinkVoltage</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">BCTDutyCycle</span>  <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">USINT</span><span class="p">;</span>
    <span class="n">BCTResistorCurrent</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">WcState_WcState</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">AND</span> <span class="p">(</span><span class="n">WcState_WcState</span> <span class="n">OR</span> <span class="n">InfoData_State</span><span class="o">&lt;&gt;</span><span class="mi">16</span><span class="c1">#8 OR BCTI2TError OR BCTI2TWarning OR BCTOverTemperature OR BCTOverVoltage OR BCTUnderVoltage) THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">OverTemperature</span><span class="o">:=</span><span class="n">BCTOverTemperature</span><span class="p">;</span>
<span class="n">I2TError</span><span class="o">:=</span><span class="n">BCTI2TError</span><span class="p">;</span>
<span class="n">I2TWarning</span><span class="o">:=</span><span class="n">BCTI2TWarning</span><span class="p">;</span>
<span class="n">OverVoltage</span><span class="o">:=</span><span class="n">BCTOverVoltage</span><span class="p">;</span>
<span class="n">UnderVoltage</span><span class="o">:=</span><span class="n">bctUnderVoltage</span><span class="p">;</span>
<span class="n">ChopperOn</span><span class="o">:=</span><span class="n">bctChopperOn</span><span class="p">;</span>
<span class="n">DCLinkVoltage</span><span class="o">:=</span><span class="n">UDINT_TO_LREAL</span><span class="p">(</span><span class="n">bctDCLinkVoltage</span><span class="p">);</span>
<span class="n">DutyCycle</span><span class="o">:=</span><span class="n">USINT_TO_LREAL</span><span class="p">(</span><span class="n">BCTDutyCycle</span><span class="p">);</span>
<span class="n">ResistorCurrent</span><span class="o">:=</span><span class="n">UDINT_TO_LREAL</span><span class="p">(</span><span class="n">BCTResistorCurrent</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="f-atpositionstate">
<h2>F_AtPositionState<a class="headerlink" href="#f-atpositionstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_AtPositionState</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Check</span> <span class="k">if</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">within</span> <span class="n">the</span> <span class="n">state</span> <span class="n">bounds</span>
    <span class="n">This</span> <span class="n">will</span> <span class="n">only</span> <span class="n">run</span> <span class="n">properly</span> <span class="k">if</span> <span class="n">FB_PositionStateInternal</span> <span class="n">has</span> <span class="n">been</span> <span class="n">called</span> <span class="n">on</span> <span class="n">the</span> <span class="n">position</span> <span class="n">state</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">it</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">defined</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="n">within</span> <span class="n">the</span> <span class="n">delta</span><span class="p">,</span> <span class="ow">and</span> <span class="n">we</span> <span class="n">are</span> <span class="n">either</span> <span class="ow">not</span> <span class="n">moving</span> <span class="ow">or</span> <span class="n">our</span> <span class="n">destination</span> <span class="ow">is</span> <span class="n">within</span> <span class="n">the</span> <span class="n">delta</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="n">at</span> <span class="n">the</span> <span class="n">state</span>
<span class="n">F_AtPositionState</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bUpdated</span>
                     <span class="n">AND</span> <span class="n">F_PosWithinDelta</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span> <span class="n">stPositionState</span><span class="p">)</span>
                     <span class="n">AND</span> <span class="p">((</span><span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">)</span> <span class="n">OR</span> <span class="n">F_PosWithinDelta</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span> <span class="n">stPositionState</span><span class="p">));</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#f-poswithindelta">F_PosWithinDelta</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-motionerrorcodelookup">
<h2>F_MotionErrorCodeLookup<a class="headerlink" href="#f-motionerrorcodelookup" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_MotionErrorCodeLookup</span> <span class="p">:</span> <span class="n">STRING</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">msg</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CASE</span> <span class="n">nErrorId</span> <span class="n">OF</span>
    <span class="o">//</span> <span class="n">Common</span> <span class="n">NC</span> <span class="n">errors</span>
    <span class="mi">16</span><span class="c1">#4221: msg:=&#39;Requested set velocity is not allowed&#39;;</span>
    <span class="mi">16</span><span class="c1">#4222: msg:=&#39;Requested set position is not allowed&#39;;</span>
    <span class="mi">16</span><span class="c1">#4223: msg:=&#39;No enable for controller and/or feed&#39;;</span>
    <span class="mi">16</span><span class="c1">#4225: msg:=&#39;Drive not ready during axis start&#39;;</span>
    <span class="mi">16</span><span class="c1">#4260: msg:=&#39;Drive disabled&#39;;</span>
    <span class="mi">16</span><span class="c1">#4357: msg:=&#39;Negative limit hit&#39;;</span>
    <span class="mi">16</span><span class="c1">#4358: msg:=&#39;Positive limit hit&#39;;</span>
    <span class="mi">16</span><span class="c1">#4550: msg:=&#39;Stall: position lag monitoring error&#39;;</span>
    <span class="mi">16</span><span class="c1">#4650: msg:=&#39;Drive hardware not ready to operate&#39;;</span>
    <span class="mi">16</span><span class="c1">#4655: msg:=&#39;Invalid IO data&#39;;</span>
    <span class="mi">16</span><span class="c1">#4467: msg:=&#39;Encoder error: invalid actual position data&#39;;</span>
    <span class="mi">16</span><span class="c1">#4B07: msg:=&#39;Timeout axis function block after 6 seconds&#39;;</span>
    <span class="mi">16</span><span class="c1">#4FFF: msg:=&#39;Unknown NC error (not in manual)&#39;;</span>

    <span class="o">//</span> <span class="n">Custom</span> <span class="n">error</span> <span class="n">definitions</span>
    <span class="mi">16</span><span class="c1">#7900: msg:=&#39;Aborted move request with active move in progress&#39;;</span>
    <span class="mi">16</span><span class="c1">#7901: msg:=&#39;Position state unsafe&#39;;</span>
    <span class="mi">16</span><span class="c1">#7902: msg:=&#39;Position state invalid&#39;;</span>

    <span class="o">//</span> <span class="n">Fallbacks</span>
    <span class="mi">0</span><span class="p">:</span> <span class="n">msg</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">msg</span><span class="o">:=</span><span class="s1">&#39;Contact PCDS to add new message&#39;</span><span class="p">;</span>
<span class="n">END_CASE</span>
<span class="n">F_MotionErrorCodeLookup</span> <span class="o">:=</span> <span class="n">msg</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="f-posoverlowerbound">
<h2>F_PosOverLowerBound<a class="headerlink" href="#f-posoverlowerbound" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_PosOverLowerBound</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">F_PosOverLowerBound</span> <span class="o">:=</span> <span class="n">fPosition</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="n">ABS</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span><span class="p">));</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-posunderupperbound">
<h2>F_PosUnderUpperBound<a class="headerlink" href="#f-posunderupperbound" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_PosUnderUpperBound</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">F_PosUnderUpperBound</span> <span class="o">:=</span> <span class="n">fPosition</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">ABS</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span><span class="p">));</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-poswithindelta">
<h2>F_PosWithinDelta<a class="headerlink" href="#f-poswithindelta" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_PosWithinDelta</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">F_PosWithinDelta</span> <span class="o">:=</span> <span class="n">F_PosOverLowerBound</span><span class="p">(</span><span class="n">fPosition</span><span class="p">,</span> <span class="n">stPositionState</span><span class="p">)</span> <span class="n">AND</span>
                    <span class="n">F_PosUnderUpperBound</span><span class="p">(</span><span class="n">fPosition</span><span class="p">,</span> <span class="n">stPositionState</span><span class="p">);</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-posoverlowerbound">F_PosOverLowerBound</a></p></li>
<li><p><a class="reference internal" href="#f-posunderupperbound">F_PosUnderUpperBound</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-atpositionstate-test">
<h2>FB_AtPositionState_Test<a class="headerlink" href="#fb-atpositionstate-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_AtPositionState_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">the</span> <span class="n">following</span> <span class="n">related</span> <span class="n">helper</span> <span class="n">functions</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">F_PosOverLowerBound</span>
    <span class="o">-</span> <span class="n">F_PosUnderUpperBound</span>
    <span class="o">-</span> <span class="n">F_PosWithinDelta</span>
    <span class="o">-</span> <span class="n">F_AtPositionState</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">For</span> <span class="n">the</span> <span class="n">multi</span><span class="o">-</span><span class="n">cycle</span> <span class="n">tests</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbTestMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>
    <span class="n">stPositionStateInactive</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stPositionStateInvalid</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stPositionStateGood</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">tonInactive</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">fbInternalGood</span><span class="p">:</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">fbInternalInvalid</span><span class="p">:</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Single</span> <span class="n">cycle</span> <span class="n">tests</span>
<span class="n">TestPosOverLowerBoundYes</span><span class="p">();</span>
<span class="n">TestPosOverLowerBoundNo</span><span class="p">();</span>
<span class="n">TestPosUnderUpperBoundYes</span><span class="p">();</span>
<span class="n">TestPosUnderUpperBoundNo</span><span class="p">();</span>
<span class="n">TestPosWithinDeltaTooLow</span><span class="p">();</span>
<span class="n">TestPosWithinDeltaTooHigh</span><span class="p">();</span>
<span class="n">TestPosWithinDeltaJustRight</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Multi</span> <span class="n">cycle</span> <span class="n">tests</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">stPositionStateInactive</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Inactive&#39;</span><span class="p">;</span>
<span class="n">stPositionStateInactive</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">30.0</span><span class="p">;</span>
<span class="n">stPositionStateInactive</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>
<span class="n">stPositionStateInactive</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">tonInactive</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1s,</span>
<span class="p">);</span>
<span class="n">TestAtPositionStateWithoutInternal</span><span class="p">();</span>

<span class="n">stPositionStateInvalid</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">;</span>
<span class="n">stPositionStateInvalid</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">40.0</span><span class="p">;</span>
<span class="n">stPositionStateInvalid</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>
<span class="n">stPositionStateInvalid</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">fbInternalInvalid</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateInvalid</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TestAtPositionStateInvalid</span><span class="p">();</span>

<span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Good&#39;</span><span class="p">;</span>
<span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mf">50.0</span><span class="p">;</span>
<span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>
<span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">fbInternalGood</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TestAtPositionStateTooLow</span><span class="p">();</span>
<span class="n">TestAtPositionStateTooHigh</span><span class="p">();</span>
<span class="n">TestAtPositionStateJustRight</span><span class="p">();</span>
<span class="n">TestAtPositionStateTweak</span><span class="p">();</span>
<span class="n">TestAtPositionStateLeave</span><span class="p">();</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fbTestMove</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateInvalid</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">If</span> <span class="n">a</span> <span class="n">position</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">invalid</span><span class="p">,</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">never</span> <span class="n">the</span> <span class="n">right</span> <span class="n">state</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateInvalid&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">1</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">stPositionStateInvalid</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">stPositionStateInvalid</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (stPositionStateInvalid.bUpdated AND fbTestMove.bSetDone) THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateInvalid</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Invalid state was marked OK&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateJustRight</span>
<span class="n">VAR</span>
    <span class="n">fLocalGoal</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateJustRight&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">4</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fLocalGoal</span> <span class="o">:=</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fLocalGoal</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fLocalGoal</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (stPositionStateGood.bUpdated AND fbTestMove.bSetDone) THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Within delta counted as outside range&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateLeave</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">A</span> <span class="n">move</span> <span class="n">away</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">state</span> <span class="n">should</span> <span class="n">be</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">the</span> <span class="n">state</span><span class="p">,</span> <span class="n">even</span> <span class="n">before</span> <span class="n">we</span><span class="s1">&#39;ve left</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateLeave&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">6</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s OR (stPositionStateGood.bUpdated AND fbTestMove.bMotionStarted) THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&lt;</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;We must be at the state location still to properly run this test.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Leaving state is not at state once the move starts&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateTooHigh</span>
<span class="n">VAR</span>
    <span class="n">fLocalGoal</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateTooHigh&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">3</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fLocalGoal</span> <span class="o">:=</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fLocalGoal</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fLocalGoal</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (stPositionStateGood.bUpdated AND fbTestMove.bSetDone) THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Above delta counted as in range&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateTooLow</span>
<span class="n">VAR</span>
    <span class="n">fLocalGoal</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateTooLow&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">2</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fLocalGoal</span> <span class="o">:=</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fLocalGoal</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fLocalGoal</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (stPositionStateGood.bUpdated AND fbTestMove.bSetDone) THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Below delta counted as in range&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateTweak</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">A</span> <span class="n">small</span> <span class="n">tweak</span> <span class="n">move</span> <span class="n">within</span> <span class="n">the</span> <span class="n">delta</span> <span class="n">of</span> <span class="n">a</span> <span class="n">position</span> <span class="n">state</span> <span class="n">should</span> <span class="n">be</span> <span class="n">OK</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateTweak&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">5</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">stPositionStateGood</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s OR (stPositionStateGood.bUpdated AND fbTestMove.bMotionStarted) THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateGood</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Small tweak in range should count as at state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestAtPositionStateWithoutInternal</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">If</span> <span class="n">a</span> <span class="n">position</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">never</span> <span class="n">updated</span> <span class="n">by</span> <span class="n">the</span> <span class="n">internal</span> <span class="n">FB</span><span class="p">,</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">never</span> <span class="n">the</span> <span class="n">right</span> <span class="n">state</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAtPositionStateWithoutInternal&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">stPositionStateInactive</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">stPositionStateInactive</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (stPositionStateInvalid.bUpdated AND fbTestMove.bSetDone) THEN</span>
    <span class="o">//</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">a</span> <span class="n">different</span> <span class="n">state</span> <span class="n">to</span> <span class="n">be</span> <span class="n">bUpdated</span> <span class="k">for</span> <span class="n">timing</span> <span class="n">purposes</span><span class="p">,</span> <span class="n">this</span> <span class="n">one</span> <span class="n">never</span> <span class="n">gets</span> <span class="n">bUpdated</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">F_AtPositionState</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionStateInactive</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;This is the control group, internal was not run so this should not work&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in multi cycle test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosOverLowerBoundNo</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosOverLowerBoundNo&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosOverLowerBound</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">8.5</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 8.5 &gt; 9.0&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosOverLowerBoundYes</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosOverLowerBoundYes&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosOverLowerBound</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">9.1</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 9.0 &gt; 9.1&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosUnderUpperBoundNo</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosUnderUpperBoundNo&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosUnderUpperBound</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">12.0</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 11.0 &gt; 12.0&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosUnderUpperBoundYes</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosUnderUpperBoundYes&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosUnderUpperBound</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">10.9</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 10.9 &gt; 11.0&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosWithinDeltaJustRight</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosWithinDeltaJustRight&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosWithinDelta</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">20.2</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 20.2 not within 19 to 21 bounds&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosWithinDeltaTooHigh</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosWithinDeltaTooHigh&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosWithinDelta</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">25.0</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 21.0 &gt; 25.0&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestPosWithinDeltaTooLow</span>
<span class="n">VAR</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestPosWithinDeltaTooLow&#39;</span><span class="p">);</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">F_PosWithinDelta</span><span class="p">(</span>
        <span class="n">fPosition</span><span class="o">:=</span><span class="mf">12.0</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Decided 12.0 &gt; 19.0&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove">FB_TestHelperSetAndMove</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#f-posoverlowerbound">F_PosOverLowerBound</a></p></li>
<li><p><a class="reference internal" href="#f-posunderupperbound">F_PosUnderUpperBound</a></p></li>
<li><p><a class="reference internal" href="#f-poswithindelta">F_PosWithinDelta</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-calculatefrequency-3702-v0-01">
<h2>FB_CalculateFrequency_3702_v0_01<a class="headerlink" href="#fb-calculatefrequency-3702-v0-01" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_CalculateFrequency_3702_v0_01</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="o">///</span><span class="mi">200</span> <span class="n">samples</span><span class="o">/</span><span class="n">period</span>
    <span class="n">cBufferSize</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bCalculate</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">aBufferValue</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="p">(</span><span class="n">cBuffersize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="n">OF</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">aBufferDcTime</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="p">(</span><span class="n">cBuffersize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="n">OF</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">///</span><span class="n">If</span> <span class="n">curve</span> <span class="n">has</span> <span class="n">a</span> <span class="n">DC</span> <span class="n">offset</span>
    <span class="n">nDCOffset</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fActFrequency</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">nFirstZeroCrossing</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">nLastZeroCrossing</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">rTimeFirst</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rTimeLast</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rTimeRes</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nCrossings</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_TEMP</span>
    <span class="n">rRange</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rTimeSpan</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>
<span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">nCrossings</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">En</span> <span class="n">AND</span> <span class="n">bCalculate</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">Serach</span> <span class="k">for</span> <span class="n">crossings</span> <span class="n">of</span> <span class="n">nDCOffset</span>
    <span class="n">FOR</span> <span class="n">nIndex</span><span class="o">:=</span><span class="mi">1</span> <span class="n">TO</span> <span class="n">cBuffersize</span><span class="o">-</span><span class="mi">1</span> <span class="n">DO</span>
            <span class="n">IF</span><span class="p">((</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">&gt;</span><span class="n">nDCOffset</span> <span class="n">AND</span> <span class="n">aBufferValue</span><span class="p">[</span><span class="n">nIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">nDCOffset</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">&lt;</span><span class="n">nDCOffset</span> <span class="n">AND</span> <span class="n">aBufferValue</span><span class="p">[</span><span class="n">nIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">nDCOffset</span><span class="p">))</span>    <span class="n">THEN</span>
                    <span class="n">IF</span><span class="p">(</span><span class="n">nCrossings</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span>
                            <span class="n">nFirstZeroCrossing</span><span class="o">:=</span><span class="n">nIndex</span><span class="p">;</span>
                    <span class="n">END_IF</span>
                    <span class="n">nLastZeroCrossing</span><span class="o">:=</span><span class="n">nIndex</span><span class="p">;</span>
                    <span class="n">nCrossings</span><span class="o">:=</span><span class="n">nCrossings</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">END_FOR</span>

    <span class="n">IF</span> <span class="n">nFirstZeroCrossing</span> <span class="o">&lt;</span> <span class="n">nLastZeroCrossing</span>  <span class="n">AND</span>  <span class="n">nCrossings</span><span class="o">&gt;</span><span class="mi">2</span> <span class="n">THEN</span>
            <span class="o">//</span><span class="n">interpolate</span> <span class="n">zero</span> <span class="n">crossings</span> <span class="k">for</span> <span class="n">higher</span> <span class="n">accuracy</span>
            <span class="n">rTimeRes</span><span class="o">:=</span><span class="n">UDINT_TO_REAL</span><span class="p">(</span><span class="n">aBufferDcTime</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">aBufferDcTime</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="o">//</span><span class="n">Buffer</span> <span class="n">must</span> <span class="n">contain</span> <span class="n">more</span> <span class="n">than</span> <span class="mi">2</span> <span class="n">values</span>
            <span class="n">rRange</span><span class="o">:=</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nFirstZeroCrossing</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nFirstZeroCrossing</span><span class="p">]));</span>
            <span class="n">rTimeFirst</span><span class="o">:=</span><span class="n">UDINT_TO_REAL</span><span class="p">(</span> <span class="n">aBufferDcTime</span><span class="p">[</span><span class="n">nFirstZeroCrossing</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">ABS</span><span class="p">(</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nFirstZeroCrossing</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">rRange</span><span class="o">*</span><span class="n">rTimeRes</span><span class="p">);</span>
            <span class="n">rRange</span><span class="o">:=</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nLastZeroCrossing</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nLastZeroCrossing</span><span class="p">]));</span>
            <span class="n">rTimeLast</span><span class="o">:=</span><span class="n">UDINT_TO_REAL</span><span class="p">(</span> <span class="n">aBufferDcTime</span><span class="p">[</span><span class="n">nLastZeroCrossing</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">ABS</span><span class="p">(</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">aBufferValue</span><span class="p">[</span><span class="n">nLastZeroCrossing</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">rRange</span><span class="o">*</span><span class="n">rTimeRes</span><span class="p">);</span>

            <span class="o">//</span><span class="n">Time</span> <span class="n">span</span> <span class="n">first</span> <span class="n">to</span> <span class="n">last</span> <span class="p">(</span><span class="n">considering</span> <span class="n">that</span> <span class="nb">max</span> <span class="n">one</span> <span class="n">time</span> <span class="n">counter</span> <span class="n">overflow</span> <span class="n">have</span> <span class="n">occured</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">total</span> <span class="n">time</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">the</span> <span class="n">time</span> <span class="n">buffer</span><span class="p">)</span>
            <span class="n">IF</span> <span class="n">rTimeFirst</span><span class="o">&lt;</span><span class="n">rTimeLast</span> <span class="n">THEN</span>
                    <span class="n">rTimeSpan</span><span class="o">:=</span><span class="n">rTimeLast</span><span class="o">-</span><span class="n">rTimeFirst</span><span class="p">;</span>
            <span class="n">ELSE</span> <span class="o">//</span><span class="n">overflow</span> <span class="n">of</span> <span class="n">counter</span> <span class="n">once</span> <span class="p">(</span><span class="n">only</span> <span class="mi">32</span><span class="n">bit</span> <span class="n">timestamp</span> <span class="o">=</span><span class="mf">4.29</span><span class="n">seconds</span><span class="p">)</span>
                    <span class="n">rTimeSpan</span><span class="o">:=</span><span class="mf">4294967296.0</span><span class="o">-</span><span class="n">rTimeFirst</span><span class="o">+</span><span class="n">rTimeLast</span><span class="p">;</span>
            <span class="n">END_IF</span>

            <span class="n">fActFrequency</span><span class="o">:=</span><span class="mf">1000000000.0</span><span class="o">/</span><span class="n">rTimeSpan</span><span class="o">*</span><span class="p">(</span><span class="n">nCrossings</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="o">//</span><span class="n">two</span> <span class="n">crossings</span> <span class="n">per</span> <span class="n">period</span> <span class="o">=&gt;</span> <span class="n">Average</span> <span class="n">frequency</span> <span class="n">over</span> <span class="n">buffer</span><span class="o">.</span>
    <span class="n">ELSE</span>
            <span class="n">fActFrequency</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-causencerror">
<h2>FB_CauseNCError<a class="headerlink" href="#fb-causencerror" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_CauseNCError</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Simulate</span> <span class="n">an</span> <span class="n">NC</span> <span class="n">error</span><span class="o">.</span>
    <span class="n">This</span> <span class="n">will</span> <span class="n">look</span> <span class="n">like</span> <span class="n">a</span> <span class="n">real</span> <span class="n">NC</span> <span class="n">error</span> <span class="k">for</span> <span class="n">everyone</span><span class="p">,</span> <span class="n">including</span> <span class="n">TwinCAT</span> <span class="n">itself</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorCode</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">adsWrite</span><span class="p">:</span> <span class="n">ADSWRITE</span><span class="p">;</span>
    <span class="n">mcReadDriveAddress</span><span class="p">:</span> <span class="n">MC_ReadDriveAddress</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">bBusy</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">mcReadDriveAddress</span><span class="o">.</span><span class="n">Done</span> <span class="n">THEN</span>
    <span class="n">mcReadDriveAddress</span><span class="p">(</span>
        <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
        <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">DriveAddress</span><span class="o">=&gt;</span><span class="n">Axis</span><span class="o">.</span><span class="n">DriveAddress</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">bBusy</span> <span class="n">AND</span> <span class="n">mcReadDriveAddress</span><span class="o">.</span><span class="n">Done</span> <span class="n">THEN</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">adsWrite</span><span class="p">(</span>
        <span class="n">PORT</span><span class="o">:=</span><span class="mi">501</span><span class="p">,</span>
        <span class="n">IDXGRP</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4200 + Axis.DriveAddress.NcDriveId,</span>
        <span class="n">IDXOFFS</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#0019,</span>
        <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nErrorCode</span><span class="p">),</span>
        <span class="n">SRCADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nErrorCode</span><span class="p">),</span>
        <span class="n">WRITE</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">BUSY</span><span class="o">=&gt;</span><span class="n">bBusy</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">adsWrite</span><span class="p">(</span><span class="n">WRITE</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-drivevirtual">
<h2>FB_DriveVirtual<a class="headerlink" href="#fb-drivevirtual" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="c1">#########################################################</span>
<span class="o">///</span><span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">run</span> <span class="n">a</span> <span class="n">virtual</span> <span class="n">drive</span> <span class="k">with</span> <span class="n">Nc</span>
<span class="o">///</span> <span class="n">Library</span><span class="p">:</span>
<span class="o">///</span> <span class="n">Tc2_MC2</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Global</span> <span class="n">Variables</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Data</span> <span class="n">types</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">External</span> <span class="n">functions</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span><span class="c1">###########################################################</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_DriveVirtual</span>
<span class="n">VAR</span>
    <span class="n">sVersion</span><span class="p">:</span> <span class="n">STRING</span><span class="o">:=</span><span class="s1">&#39;1.0.3&#39;</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">/////</span>   <span class="n">nCommandLocal</span><span class="o">...</span>
    <span class="o">/////</span>   <span class="mi">0</span> <span class="o">=</span> <span class="n">Jog</span>
    <span class="o">/////</span>   <span class="mi">1</span> <span class="o">=</span> <span class="n">MoveVelocity</span>
    <span class="o">/////</span>   <span class="mi">2</span> <span class="o">=</span> <span class="n">MoveRelative</span>
    <span class="o">/////</span>   <span class="mi">3</span> <span class="o">=</span> <span class="n">MoveAbsolut</span>
    <span class="o">/////</span>   <span class="mi">4</span> <span class="o">=</span> <span class="n">MoveModulo</span>
    <span class="o">/////</span>   <span class="mi">10</span> <span class="o">=</span> <span class="n">Homing</span>
    <span class="o">/////</span>   <span class="mi">20</span> <span class="o">=</span> <span class="n">SuperInp</span> <span class="o">&gt;&gt;&gt;</span><span class="n">ToBe</span>
    <span class="o">/////</span>   <span class="mi">30</span> <span class="o">=</span> <span class="n">Gear</span>
    <span class="n">nCommand</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fAcceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fDeceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bJogFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bJogBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fOverride</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">bHomeSensor</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fHomePosition</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nHomeRevOffset</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">MasterAxis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">bPowerSelf</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomed</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nMotionAxisID</span><span class="p">:</span><span class="n">UDINT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>  <span class="o">//</span><span class="n">Axis</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">Motion</span> <span class="p">(</span><span class="n">NC</span><span class="p">)</span>
    <span class="n">Status</span><span class="p">:</span> <span class="n">ST_AxisStatus</span><span class="p">;</span>
    <span class="n">fActVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fActPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fActDiff</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">sErrorMessage</span><span class="p">:</span><span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nCommandLocal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nCmdDataLocal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bFirstScan</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fbReset</span><span class="p">:</span> <span class="n">MC_Reset</span><span class="p">;</span>
    <span class="n">fbPower</span><span class="p">:</span> <span class="n">MC_Power</span><span class="p">;</span>
    <span class="n">fbHalt</span><span class="p">:</span> <span class="n">MC_Halt</span><span class="p">;</span>
    <span class="n">fbJog</span><span class="p">:</span> <span class="n">MC_Jog</span><span class="p">;</span>
    <span class="n">fbMoveVelocity</span><span class="p">:</span> <span class="n">MC_MoveVelocity</span><span class="p">;</span>
    <span class="n">fbMoveRelative</span><span class="p">:</span> <span class="n">MC_MoveRelative</span><span class="p">;</span>
    <span class="n">fbMoveAbsolute</span><span class="p">:</span> <span class="n">MC_MoveAbsolute</span><span class="p">;</span>
    <span class="n">fbMoveModulo</span><span class="p">:</span> <span class="n">MC_MoveModulo</span><span class="p">;</span>
    <span class="n">fbHomeVirtual</span><span class="p">:</span><span class="n">FB_HomeVirtual</span><span class="p">;</span>
    <span class="n">fbGearInDyn</span><span class="p">:</span> <span class="n">MC_GearInDyn</span><span class="p">;</span>
    <span class="n">fbGearOut</span><span class="p">:</span> <span class="n">MC_GearOut</span><span class="p">;</span>
    <span class="n">fbExecuteRiseEdge</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">stAxisStatus</span><span class="p">:</span> <span class="n">DUT_AxisStatus_v0_01</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Transfer</span> <span class="n">nCommand</span> <span class="ow">and</span> <span class="n">nCmdData</span> <span class="n">to</span> <span class="n">local</span> <span class="n">copies</span> <span class="n">at</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">of</span> <span class="n">bExecute</span> <span class="p">(</span><span class="n">avoid</span> <span class="n">issues</span> <span class="k">if</span> <span class="n">nCommand</span> <span class="ow">or</span> <span class="n">nCmdData</span> <span class="n">are</span> <span class="n">changed</span> <span class="n">during</span> <span class="n">a</span> <span class="n">command</span><span class="p">)</span>
<span class="n">fbExecuteRiseEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbExecuteRiseEdge</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
  <span class="n">nCmdDataLocal</span><span class="o">:=</span><span class="n">nCmdData</span><span class="p">;</span>
  <span class="n">nCommandLocal</span><span class="o">:=</span><span class="n">nCommand</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bHomed</span><span class="o">:=</span><span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bHomed</span><span class="p">;</span> <span class="o">//</span><span class="n">Add</span> <span class="ow">in</span> <span class="n">DUT_AxisStatus</span> <span class="n">later</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Reset</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbReset</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bReset</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">Power</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">bPowerSelf</span> <span class="n">THEN</span>
<span class="n">fbPower</span><span class="p">(</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Enable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">,</span>
    <span class="n">Enable_Positive</span><span class="o">:=</span><span class="n">bEnable</span> <span class="n">AND</span> <span class="n">bLimitFwd</span><span class="p">,</span>
    <span class="n">Enable_Negative</span><span class="o">:=</span><span class="n">bEnable</span> <span class="n">AND</span> <span class="n">bLimitBwd</span><span class="p">,</span>
    <span class="n">Override</span><span class="o">:=</span><span class="n">fOverride</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Status</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Halt</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbHalt</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bExecute</span>  <span class="n">AND</span> <span class="p">(((</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="n">fbPower</span><span class="o">.</span><span class="n">Busy</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">10</span><span class="p">))),</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span> <span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">Jog</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbJog</span><span class="p">(</span>
    <span class="n">JogForward</span><span class="o">:=</span><span class="n">bJogFwd</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">,</span>
    <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">bJogBwd</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">,</span>
    <span class="n">Mode</span><span class="o">:=</span><span class="n">UINT_TO_INT</span><span class="p">(</span><span class="n">nCmdDataLocal</span><span class="p">),</span>
    <span class="n">Position</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">MoveVelocity</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbMoveVelocity</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fVelocity</span><span class="p">),</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">Direction</span><span class="o">:=</span><span class="n">SEL</span><span class="p">(</span><span class="n">fVelocity</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">MC_Positive_Direction</span><span class="p">,</span> <span class="n">MC_Negative_Direction</span><span class="p">),</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">InVelocity</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">MoveRelative</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbMoveRelative</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">Distance</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fVelocity</span><span class="p">),</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="n">IF</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">2</span> <span class="n">THEN</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">MoveAbsolute</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbMoveAbsolute</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">Position</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fVelocity</span><span class="p">),</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="n">IF</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">3</span> <span class="n">THEN</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">MoveModulo</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbMoveModulo</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
    <span class="n">Position</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fVelocity</span><span class="p">),</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">Direction</span><span class="o">:=</span><span class="n">UINT_TO_INT</span><span class="p">(</span><span class="n">nCmdDataLocal</span><span class="p">),</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="n">IF</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">4</span> <span class="n">THEN</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Home</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbHomeVirtual</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">10</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">fHomePosition</span><span class="o">:=</span><span class="n">fHomePosition</span><span class="p">,</span>
    <span class="n">bHomeSensor</span><span class="o">:=</span><span class="n">bHomeSensor</span><span class="p">,</span>
    <span class="n">bLimitBwd</span><span class="o">:=</span><span class="n">bLimitBwd</span><span class="p">,</span>
    <span class="n">bLimitFwd</span><span class="o">:=</span><span class="n">bLimitFwd</span><span class="p">,</span>
    <span class="n">nCmdData</span><span class="o">:=</span><span class="n">nCmdDataLocal</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
    <span class="n">nHomeRevOffset</span><span class="o">:=</span><span class="n">nHomeRevOffset</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
    <span class="p">);</span>

<span class="n">IF</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">10</span> <span class="n">THEN</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bDone</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Gear</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbGearInDyn</span><span class="p">(</span>
    <span class="n">Enable</span><span class="o">:=</span><span class="n">bExecute</span>  <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
    <span class="n">GearRatio</span><span class="o">:=</span><span class="n">SEL</span><span class="p">(</span><span class="n">nCmdDataLocal</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">fVelocity</span><span class="p">),</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Master</span><span class="o">:=</span><span class="n">MasterAxis</span><span class="p">,</span>
    <span class="n">Slave</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">InGear</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="n">fbGearOut</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
    <span class="n">Slave</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span><span class="p">);</span>


<span class="n">IF</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">30</span> <span class="n">THEN</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Coupled</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Busy</span><span class="o">*</span><span class="p">)</span>
<span class="n">bBusy</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">HasJob</span> <span class="n">OR</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">HomingBusy</span> <span class="n">OR</span> <span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Enabled</span><span class="o">*</span><span class="p">)</span>
<span class="n">bEnabled</span><span class="o">:=</span><span class="n">fbPower</span><span class="o">.</span><span class="n">Status</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="kn">from</span> <span class="nn">functions</span> <span class="ow">and</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">fbPower</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">fbPower</span><span class="o">.</span><span class="n">Active</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbPower</span><span class="o">.</span><span class="n">Enable</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbPower</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbHalt</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">fbHalt</span><span class="o">.</span><span class="n">Active</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbHalt</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHalt</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">0</span> <span class="p">(</span><span class="o">*</span><span class="n">fbJog</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbJog</span><span class="o">.</span><span class="n">JogForward</span> <span class="n">OR</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">JogBackwards</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbJog</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">1</span><span class="p">(</span><span class="o">*</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">2</span> <span class="p">(</span><span class="o">*</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">3</span> <span class="p">(</span><span class="o">*</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">4</span> <span class="p">(</span><span class="o">*</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">10</span> <span class="p">(</span><span class="o">*</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">nErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbGearInDyn</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">30</span> <span class="p">(</span><span class="o">*</span><span class="n">fbGearInDyn</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbGearInDyn</span><span class="o">.</span><span class="n">Enable</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbGearInDyn</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbGearOut</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommandLocal</span><span class="o">=</span><span class="mi">30</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Coupled</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbGearOut</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbGearOut</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span>  <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeVirtual</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Converese</span> <span class="n">nErrorID</span> <span class="n">to</span> <span class="n">string</span><span class="o">*</span><span class="p">)</span>
<span class="n">sErrorMessage</span><span class="o">:=</span><span class="n">WORD_TO_HEXSTR</span><span class="p">(</span><span class="ow">in</span><span class="o">:=</span><span class="n">TO_WORD</span><span class="p">(</span><span class="n">nErrorID</span><span class="p">)</span> <span class="p">,</span> <span class="n">iPrecision</span><span class="o">:=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bLoCase</span><span class="o">:=</span><span class="mi">0</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">Status</span> <span class="kn">from</span> <span class="nn">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">Status</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Axis</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">motion</span> <span class="s2">&quot;motor&quot;</span><span class="o">*</span><span class="p">)</span>
<span class="n">nMotionAxisID</span><span class="o">:=</span><span class="n">axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Actual</span> <span class="n">Velocity</span><span class="o">*</span><span class="p">)</span>
<span class="n">fActVelocity</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActVelo</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Actual</span> <span class="n">Position</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">OpMode</span><span class="o">.</span><span class="n">Modulo</span> <span class="n">THEN</span>
    <span class="n">fActPosition</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ModuloActPos</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">fActPosition</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Actual</span> <span class="n">Position</span><span class="o">*</span><span class="p">)</span>
<span class="n">fActDiff</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">PosDiff</span><span class="p">;</span>


<span class="o">//</span><span class="n">Status</span> <span class="n">struct</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">communication</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bEnabled</span><span class="o">:=</span><span class="n">bEnabled</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bError</span><span class="o">:=</span><span class="n">bError</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bHomeSensor</span><span class="o">:=</span><span class="n">bHomeSensor</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bJogBwd</span><span class="o">:=</span><span class="n">bJogBwd</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bJogFwd</span><span class="o">:=</span><span class="n">bJogFwd</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bLimitBwd</span><span class="o">:=</span><span class="n">bLimitBwd</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bLimitFwd</span><span class="o">:=</span><span class="n">bLimitFwd</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fAcceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActDiff</span><span class="o">:=</span><span class="n">fActDiff</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="o">:=</span><span class="n">fActPosition</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActVelocity</span><span class="o">:=</span><span class="n">fActVelocity</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fDeceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fOverride</span><span class="o">:=</span><span class="n">fOverride</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fPosition</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fVelocity</span><span class="o">:=</span><span class="n">fVelocity</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">nCmdData</span><span class="o">:=</span><span class="n">nCmdData</span><span class="p">;</span>  <span class="o">//</span><span class="n">Or</span> <span class="n">nCmdDataLocal</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">nCommand</span><span class="o">:=</span><span class="n">nCommand</span><span class="p">;</span>  <span class="o">//</span><span class="n">Or</span> <span class="n">nCommandLocal</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">nErrorId</span><span class="o">:=</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bBusy</span><span class="o">:=</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bHomed</span><span class="o">:=</span><span class="n">bHomed</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bFirstScan</span> <span class="n">THEN</span>
    <span class="n">bFirstScan</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-axisstatus-v0-01">DUT_AxisStatus_v0_01</a></p></li>
<li><p><a class="reference internal" href="#fb-homevirtual">FB_HomeVirtual</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-el1252asm-v1-00">
<h2>FB_EL1252ASM_v1_00<a class="headerlink" href="#fb-el1252asm-v1-00" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_EL1252ASM_v1_00
VAR_INPUT
    En: BOOL;
END_VAR
VAR_OUTPUT
    EnO: BOOL;
    Di_1: BOOL;
    Di_2: BOOL;
    Di_1_LatchTimePos: ULINT;
    Di_2_LatchTimePos: ULINT;
    Di_1_LatchTimeNeg: ULINT;
    Di_2_LatchTimeNeg: ULINT;
    ///Below bits can be used but then they must be enabled in the COE of the card. Nicklas suggested to not use these (since something wss written that you then only were allowed to read the latch time onece (some kkind of auto reset??))
    ///Di_1_LatchNeg:BOOL;
    ///     Di_1_LatchPos:BOOL;
    ///     Di_2_LatchNeg:BOOL;
    ///     Di_2_LatchPos:BOOL;
    Error: BOOL;
END_VAR
VAR
    Channel_1_Input AT %I*: BOOL;
    Channel_2_Input AT %I*: BOOL;
    ///Latch_Status1 AT %I*: USINT;
    ///     Latch_Status2 AT %I*: USINT;
    Latch_LatchPos1 AT %I*: ULINT;
    Latch_LatchNeg1 AT %I*: ULINT;
    Latch_LatchPos2 AT %I*: ULINT;
    Latch_LatchNeg2 AT %I*: ULINT;
    WcState_WcState AT %I*: BOOL;
    InfoData_State AT %I*: UINT;
END_VAR
EnO:=En;

IF En AND (WcState_WcState OR InfoData_State&lt;&gt;16#8) THEN //InfoData_State==0 =&gt; in OP mode
    Error:=TRUE;
ELSE
    Error:=FALSE;
END_IF

IF En THEN
    IF Error=FALSE THEN
            Di_1:=Channel_1_Input;
            Di_2:=Channel_2_Input;
    (*      Di_1_LatchPos:=Latch_Status1.0;
            Di_1_LatchNeg:=Latch_Status1.1;
            Di_2_LatchPos:=Latch_Status2.0;
            Di_2_LatchNeg:=Latch_Status2.1;*)
            Di_1_LatchTimePos:=Latch_LatchPos1;
            Di_2_LatchTimePos:=Latch_LatchPos2;
            Di_1_LatchTimeNeg:=Latch_LatchNeg1;
            Di_2_LatchTimeNeg:=Latch_LatchNeg2;

    ELSE
            Di_1:=FALSE;
            Di_2:=FALSE;
    END_IF
END_IF

END_FUNCTION_BLOCK
</pre></div>
</div>
</section>
<section id="fb-encerrorffo">
<h2>FB_EncErrorFFO<a class="headerlink" href="#fb-encerrorffo" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EncErrorFFO</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Example</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">FB_NCErrorFFO</span> <span class="n">that</span> <span class="n">only</span> <span class="n">counts</span> <span class="n">encoder</span> <span class="n">errors</span> <span class="k">as</span> <span class="n">faults</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motion</span> <span class="n">stage</span> <span class="n">to</span> <span class="n">monitor</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">FFO</span> <span class="n">to</span> <span class="n">trip</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">fault</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Auto</span> <span class="n">reset</span> <span class="n">the</span> <span class="n">fault</span>
    <span class="n">bAutoReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Quick</span> <span class="n">way</span> <span class="k">for</span> <span class="n">nearby</span> <span class="n">code</span> <span class="n">to</span> <span class="n">check</span> <span class="k">if</span> <span class="n">this</span> <span class="n">block</span> <span class="n">has</span> <span class="n">tripped</span> <span class="n">the</span> <span class="n">FFO</span><span class="o">.</span>
    <span class="n">bTripped</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbNCErrorFFO</span><span class="p">:</span> <span class="n">FB_NCErrorFFO</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">nLowErrorId</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#4400,</span>
        <span class="n">nHighErrorId</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#44FF,</span>
        <span class="n">sDesc</span> <span class="o">:=</span> <span class="s1">&#39;Encoder error&#39;</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">fbNCErrorFFO</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">bReset</span><span class="p">,</span>
    <span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">bAutoReset</span><span class="p">,</span>
    <span class="n">bTripped</span> <span class="o">=&gt;</span> <span class="n">bTripped</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-ncerrorffo">FB_NCErrorFFO</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-encodervalue">
<h2>FB_EncoderValue<a class="headerlink" href="#fb-encodervalue" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EncoderValue</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Process</span> <span class="n">the</span> <span class="n">encoder</span> <span class="n">value</span> <span class="k">for</span> <span class="n">ST_MotionStage</span>

    <span class="n">A</span> <span class="n">few</span> <span class="n">different</span> <span class="n">problems</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">solve</span><span class="p">:</span>
        <span class="mf">1.</span> <span class="n">Different</span> <span class="n">encoders</span> <span class="n">show</span> <span class="k">as</span> <span class="n">different</span> <span class="n">types</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">IO</span><span class="p">,</span>
           <span class="n">but</span> <span class="n">we</span> <span class="n">want</span> <span class="n">a</span> <span class="n">consistent</span> <span class="nb">type</span> <span class="k">for</span> <span class="n">checks</span> <span class="ow">and</span> <span class="k">for</span> <span class="n">PVs</span>
        <span class="mf">2.</span> <span class="n">Some</span> <span class="n">inverted</span> <span class="n">encoders</span> <span class="n">display</span> <span class="k">as</span> <span class="n">very</span> <span class="n">high</span> <span class="n">numbers</span>
           <span class="k">as</span> <span class="n">they</span> <span class="n">count</span> <span class="n">down</span> <span class="kn">from</span> <span class="nn">max</span> <span class="nb">int</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">up</span> <span class="kn">from</span> <span class="mi">0</span>
        <span class="mf">3.</span> <span class="n">Some</span> <span class="n">encoders</span> <span class="n">have</span> <span class="n">raw</span> <span class="n">signed</span> <span class="n">values</span><span class="p">,</span> <span class="n">others</span> <span class="n">unsigned</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">this</span> <span class="n">end</span><span class="p">,</span> <span class="n">we</span> <span class="n">figure</span> <span class="n">out</span> <span class="n">which</span> <span class="n">encoder</span> <span class="ow">is</span> <span class="n">linked</span> <span class="ow">and</span> <span class="n">process</span>
    <span class="n">the</span> <span class="n">value</span> <span class="n">appropriately</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderULINT</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderULINT</span> <span class="o">&lt;</span> <span class="mi">4294967296</span> <span class="n">THEN</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="mi">18446744073709551615</span> <span class="o">-</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="p">);</span>
    <span class="n">END_IF</span>
<span class="n">ELSIF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderUINT</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">UINT_TO_UDINT</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderUINT</span><span class="p">);</span>
<span class="n">ELSIF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderINT</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">INT_TO_UDINT</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderINT</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-encsaverestore">
<h2>FB_EncSaveRestore<a class="headerlink" href="#fb-encsaverestore" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EncSaveRestore</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbSetPos</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">timer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLoad</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nLatchError</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">bEncError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tRetryDelay</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1s;</span>
    <span class="n">nMaxRetries</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">nCurrTries</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bWaitRetry</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tonRetry</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">PERSISTENT</span>
    <span class="n">bSaved</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Trigger</span> <span class="n">a</span> <span class="n">load</span> <span class="k">if</span> <span class="n">anything</span> <span class="n">was</span> <span class="n">saved</span> <span class="n">at</span> <span class="nb">all</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
        <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bLoad</span> <span class="n">S</span><span class="o">=</span> <span class="n">bSaved</span><span class="p">;</span>
        <span class="n">fbSetPos</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">ClearPositionLag</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="o">//</span> <span class="n">Set</span> <span class="n">our</span> <span class="n">position</span> <span class="k">if</span> <span class="n">bLoad</span> <span class="ow">is</span> <span class="n">true</span>
    <span class="n">fbSetPos</span><span class="p">(</span>
        <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
        <span class="n">Execute</span><span class="o">:=</span><span class="n">bLoad</span><span class="p">,</span>
        <span class="n">Position</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">Only</span> <span class="n">load</span> <span class="n">once</span><span class="p">,</span> <span class="n">at</span> <span class="n">startup</span>
    <span class="n">bLoad</span> <span class="n">R</span><span class="o">=</span> <span class="n">fbSetPos</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">fbSetPos</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>

    <span class="n">IF</span> <span class="n">fbSetPos</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
        <span class="o">//</span> <span class="n">Keep</span> <span class="n">the</span> <span class="n">error</span> <span class="n">latched</span><span class="p">,</span> <span class="n">it</span> <span class="n">can</span> <span class="n">disappear</span> <span class="k">if</span> <span class="n">Execute</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">FALSE</span>
        <span class="n">nLatchError</span> <span class="o">:=</span> <span class="n">fbSetPos</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
        <span class="n">nCurrTries</span> <span class="o">:=</span> <span class="n">nCurrTries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">nCurrTries</span> <span class="o">&gt;=</span> <span class="n">nMaxRetries</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">Alert</span> <span class="n">the</span> <span class="n">user</span> <span class="n">that</span> <span class="n">something</span> <span class="n">has</span> <span class="n">gone</span> <span class="n">wrong</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">nLatchError</span><span class="p">;</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Error loading previously saved position.&#39;</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">FB</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">retry</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                <span class="n">Position</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">);</span>
            <span class="o">//</span> <span class="n">Try</span> <span class="n">again</span>
            <span class="n">bWaitRetry</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="n">tonRetry</span><span class="p">(</span>
        <span class="n">IN</span> <span class="o">:=</span> <span class="n">bWaitRetry</span><span class="p">,</span>
        <span class="n">PT</span> <span class="o">:=</span> <span class="n">tRetryDelay</span><span class="p">);</span>

    <span class="n">bLoad</span> <span class="n">S</span><span class="o">=</span> <span class="n">tonRetry</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
    <span class="n">bWaitRetry</span> <span class="n">R</span><span class="o">=</span> <span class="n">tonRetry</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Check</span> <span class="n">ST_MotionStage</span> <span class="k">for</span> <span class="n">an</span> <span class="n">encoder</span> <span class="n">error</span> <span class="p">(</span><span class="nb">range</span> <span class="mh">0x44</span><span class="n">nn</span><span class="p">)</span>
    <span class="n">bEncError</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="c1">#4400 AND stMotionStage.nErrorId &lt;= 16#44FF;</span>

    <span class="o">//</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">save</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re currently loading or if there is an encoder error</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLoad</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bEncError</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bWaitRetry</span> <span class="n">THEN</span>
        <span class="n">fPosition</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">This</span> <span class="n">persistent</span> <span class="n">variable</span> <span class="n">lets</span> <span class="n">us</span> <span class="n">check</span> <span class="k">if</span> <span class="n">anything</span> <span class="n">was</span> <span class="n">saved</span>
        <span class="o">//</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">TRUE</span> <span class="n">at</span> <span class="n">startup</span> <span class="k">if</span> <span class="n">we</span> <span class="n">have</span> <span class="n">saved</span> <span class="n">values</span>
        <span class="n">bSaved</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-epicsinout">
<h2>FB_EpicsInOut<a class="headerlink" href="#fb-epicsinout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionState1D_InOut instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EpicsInOut</span>
<span class="o">//</span> <span class="n">Example</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">FB_PositionStateManager</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">IN</span><span class="o">/</span><span class="n">OUT</span> <span class="n">axis</span><span class="o">.</span> <span class="n">See</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">comments</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Also</span> <span class="n">usable</span> <span class="k">as</span> <span class="n">a</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">these</span> <span class="n">cases</span> <span class="p">(</span><span class="n">no</span> <span class="n">need</span> <span class="n">to</span> <span class="n">roll</span> <span class="n">your</span> <span class="n">own</span> <span class="ow">in</span><span class="o">/</span><span class="n">out</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motor</span> <span class="n">to</span> <span class="n">apply</span> <span class="n">states</span> <span class="n">to</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">position</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">pragma</span> <span class="n">these</span><span class="p">,</span> <span class="n">let</span> <span class="n">it</span> <span class="n">happen</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">manager</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">IN</span> <span class="n">parameter</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">will</span> <span class="n">be</span> <span class="n">moved</span> <span class="n">when</span> <span class="n">enumSet</span> <span class="ow">is</span> <span class="n">changed</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">When</span> <span class="n">changed</span><span class="p">,</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">destination</span> <span class="ow">and</span> <span class="n">starts</span> <span class="n">a</span> <span class="n">move</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumSet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumSet</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">error</span> <span class="n">state</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">pragma</span> <span class="n">these</span><span class="p">,</span> <span class="n">already</span> <span class="n">has</span> <span class="n">pragma</span> <span class="ow">in</span> <span class="n">manager</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Message</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">bError</span> <span class="o">=</span> <span class="n">TRUE</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="n">currently</span> <span class="n">moving</span> <span class="n">between</span> <span class="n">states</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">asked</span> <span class="k">for</span> <span class="n">a</span> <span class="n">move</span> <span class="n">between</span> <span class="n">states</span><span class="p">,</span> <span class="n">it</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">,</span> <span class="ow">and</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">ongoing</span> <span class="n">move</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">readback</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumGet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumGet</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..15</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbStateManager</span><span class="p">:</span> <span class="n">FB_PositionStateManager</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">up</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">PVs</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Fist</span> <span class="n">cycle</span> <span class="n">setup</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
    <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Stuff</span> <span class="n">first</span> <span class="n">two</span> <span class="n">values</span> <span class="n">of</span> <span class="n">the</span> <span class="mi">15</span> <span class="n">element</span> <span class="n">array</span> <span class="k">for</span> <span class="n">the</span> <span class="n">manager</span>
<span class="n">arrStates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
<span class="n">arrStates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">function</span> <span class="n">block</span> <span class="n">every</span> <span class="n">cycle</span>
<span class="n">fbStateManager</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">arrStates</span> <span class="o">:=</span> <span class="n">arrStates</span><span class="p">,</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">,</span>
    <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">bEnable</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
    <span class="n">nErrorId</span> <span class="o">=&gt;</span> <span class="n">nErrorId</span><span class="p">,</span>
    <span class="n">sErrorMessage</span> <span class="o">=&gt;</span> <span class="n">sErrorMessage</span><span class="p">,</span>
    <span class="n">bBusy</span> <span class="o">=&gt;</span> <span class="n">bBusy</span><span class="p">,</span>
    <span class="n">bDone</span> <span class="o">=&gt;</span> <span class="n">bDone</span><span class="p">,</span>
    <span class="n">getState</span> <span class="o">=&gt;</span> <span class="n">enumGet</span><span class="p">);</span> <span class="o">//</span> <span class="n">Cannot</span> <span class="n">do</span> <span class="n">this</span> <span class="n">assignment</span> <span class="k">if</span> <span class="n">enumGet</span> <span class="n">has</span> <span class="n">attribute</span> <span class="n">strict</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-epicsinout-int">ENUM_EpicsInOut_INT</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemanager">FB_PositionStateManager</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-errorlist">
<h2>FB_ErrorList<a class="headerlink" href="#fb-errorlist" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ErrorList</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                                                                      <span class="o">//</span><span class="n">Enable</span> <span class="nb">input</span>
    <span class="n">bReset</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                                                          <span class="o">//</span><span class="n">Delete</span> <span class="nb">all</span> <span class="n">Error</span> <span class="n">entry</span>
    <span class="n">lErrorID</span> <span class="p">:</span> <span class="n">ULINT</span><span class="p">;</span>                                                                       <span class="o">//</span><span class="n">ErrorID</span> <span class="n">to</span> <span class="n">be</span> <span class="n">acknoledged</span>
    <span class="n">bACK</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                                                            <span class="o">//</span><span class="n">Acknoledge</span> <span class="n">the</span> <span class="n">given</span> <span class="n">error</span> <span class="ow">and</span> <span class="n">delete</span> <span class="n">it</span> <span class="kn">from</span> <span class="nn">the</span> <span class="nb">list</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                                                                     <span class="o">//</span><span class="n">Enable</span> <span class="n">output</span>
    <span class="n">nNoError</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                                                                         <span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">Errors</span>
    <span class="n">nNoOverflow</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>                                                                      <span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">Overflows</span>
    <span class="n">pErrorSystem</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>                       <span class="o">//</span><span class="n">Pointer</span> <span class="n">to</span> <span class="n">ErrorSystem</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">nFreePos</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                                                                        <span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">free</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">list</span>
    <span class="n">nListCnt1</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>                                                                       <span class="o">//</span><span class="n">work</span> <span class="n">variable</span>
    <span class="n">ErrorSystem</span> <span class="p">:</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>                                           <span class="o">//</span><span class="n">Data</span> <span class="n">structure</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Error</span> <span class="nb">list</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">*</span> <span class="o">================================================================================</span>
<span class="o">*</span>                                   <span class="n">DESCRIPTION</span>
<span class="o">*</span> <span class="o">================================================================================</span>
<span class="o">*</span> <span class="n">This</span> <span class="n">Function</span> <span class="n">Block</span> <span class="n">implements</span> <span class="n">the</span> <span class="n">core</span> <span class="n">structure</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Error</span><span class="o">/</span><span class="ne">Warning</span> <span class="n">Handling</span>
<span class="o">*</span> <span class="n">system</span><span class="o">.</span> <span class="n">It</span> <span class="n">realizes</span> <span class="n">the</span> <span class="n">datastructure</span> <span class="n">containing</span> <span class="n">every</span> <span class="n">Error</span> <span class="n">Entry</span><span class="p">,</span> <span class="n">collect</span>
<span class="o">*</span> <span class="n">statistics</span> <span class="n">about</span> <span class="n">the</span> <span class="n">usage</span> <span class="ow">and</span> <span class="n">manage</span> <span class="n">the</span> <span class="n">Error</span> <span class="n">Entries</span><span class="o">.</span>
<span class="o">*</span> <span class="n">Note</span><span class="p">:</span> <span class="n">The</span> <span class="n">system</span> <span class="ow">is</span> <span class="n">under</span> <span class="n">development</span><span class="p">,</span> <span class="n">most</span> <span class="n">of</span> <span class="n">the</span> <span class="n">functionalities</span> <span class="n">are</span> <span class="ow">not</span>
<span class="o">*</span> <span class="n">implemented</span> <span class="ow">or</span> <span class="n">existing</span> <span class="n">functionalities</span> <span class="n">may</span> <span class="n">change</span> <span class="k">with</span> <span class="n">time</span><span class="o">.</span>
<span class="o">*</span> <span class="o">================================================================================</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">EnO</span> <span class="o">:=</span> <span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Ponter</span> <span class="n">to</span> <span class="n">ErrorSystem</span>
<span class="n">pErrorSystem</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">ErrorSystem</span><span class="p">);</span>

<span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">overflows</span>
<span class="n">nNoOverflow</span> <span class="o">:=</span> <span class="n">ErrorSystem</span><span class="o">.</span><span class="n">nNoOverflows</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">MEMSET</span> <span class="p">(</span> <span class="n">ADR</span><span class="p">(</span><span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">*</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">DUT_TerminalError</span><span class="p">));</span>
    <span class="n">ErrorSystem</span><span class="o">.</span><span class="n">lNextErrorID</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">errors</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">system</span>
<span class="n">nNoError</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nListCnt1</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nListCnt1</span><span class="p">]</span><span class="o">.</span><span class="n">Error_ID</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span>  <span class="n">THEN</span>
            <span class="n">nNoError</span> <span class="o">:=</span> <span class="n">nNoError</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>
<span class="n">ErrorSystem</span><span class="o">.</span><span class="n">nNoErrors</span> <span class="o">:=</span> <span class="n">nNoError</span><span class="p">;</span>

<span class="o">//</span><span class="n">Number</span> <span class="n">of</span> <span class="n">free</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">list</span>
<span class="n">nFreePos</span> <span class="o">:=</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="n">nNoError</span><span class="p">;</span>

<span class="o">//</span><span class="n">Acknoledge</span> <span class="n">specified</span> <span class="n">Error</span> <span class="n">entry</span>
<span class="n">IF</span> <span class="n">bACK</span> <span class="n">THEN</span>
    <span class="n">FOR</span> <span class="n">nListCnt1</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">DO</span>
            <span class="n">IF</span> <span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nListCnt1</span><span class="p">]</span><span class="o">.</span><span class="n">Error_ID</span> <span class="o">=</span> <span class="n">lErrorID</span> <span class="n">THEN</span>
                    <span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nListCnt1</span><span class="p">]</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">:=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Acknowledged</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">END_FOR</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Deleting</span> <span class="n">acknoledged</span> <span class="n">errors</span>
<span class="n">FOR</span> <span class="n">nListCnt1</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nListCnt1</span><span class="p">]</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Acknowledged</span> <span class="n">THEN</span>
            <span class="n">MEMMOVE</span> <span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nListCnt1</span><span class="p">]),</span> <span class="n">ADR</span><span class="p">(</span><span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nListCnt1</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">nListCnt1</span><span class="p">)</span> <span class="o">*</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">DUT_TerminalError</span><span class="p">));</span>
            <span class="n">MEMSET</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">ErrorSystem</span><span class="o">.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">DUT_TerminalError</span><span class="p">));</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-errorstate">DUT_ErrorState</a></p></li>
<li><p><a class="reference internal" href="#dut-terminalerror">DUT_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#gvl-errorsystem">GVL_ErrorSystem</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-gantryautocoupling">
<h2>FB_GantryAutoCoupling<a class="headerlink" href="#fb-gantryautocoupling" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GantryAutoCoupling</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nGantryTol</span> <span class="p">:</span> <span class="n">LINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bGantryAlreadyCoupled</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Master</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">MasterEnc</span> <span class="p">:</span> <span class="n">ST_RenishawAbsEnc</span><span class="p">;</span>
    <span class="n">Slave</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">SlaveEnc</span> <span class="p">:</span> <span class="n">ST_RenishawAbsEnc</span><span class="p">;</span>
    <span class="n">bExecuteCouple</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecuteDecouple</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">gantry_diff_limit</span> <span class="p">:</span> <span class="n">FB_GantryDiffVirtualLimitSwitch</span><span class="p">;</span>
    <span class="n">couple</span> <span class="p">:</span> <span class="n">MC_GEARIN</span><span class="p">;</span>
    <span class="n">decouple</span> <span class="p">:</span> <span class="n">MC_GEAROUT</span><span class="p">;</span>
    <span class="n">bInitComplete</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fbSetEnables</span> <span class="p">:</span> <span class="n">FB_SetEnables</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Designate</span> <span class="n">Master</span> <span class="ow">and</span> <span class="n">SLave</span> <span class="n">Axes</span>
<span class="n">Master</span><span class="o">.</span><span class="n">bGantryAxis</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">Slave</span><span class="o">.</span><span class="n">bGantryAxis</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">Master</span><span class="o">.</span><span class="n">nGantryTol</span> <span class="o">:=</span> <span class="n">nGantryTol</span><span class="p">;</span>
<span class="n">Slave</span><span class="o">.</span><span class="n">nGantryTol</span> <span class="o">:=</span> <span class="n">Master</span><span class="o">.</span><span class="n">nGantryTol</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Activate</span> <span class="n">Gantry</span> <span class="n">Virtual</span> <span class="n">Limit</span> <span class="n">Switch</span>
<span class="n">gantry_diff_limit</span><span class="p">(</span><span class="n">Penc</span><span class="o">:=</span><span class="n">MasterEnc</span><span class="p">,</span> <span class="n">SEnc</span><span class="o">:=</span><span class="n">SlaveEnc</span><span class="p">,</span> <span class="n">GantDiffTol</span><span class="o">:=</span><span class="n">Master</span><span class="o">.</span><span class="n">nGantryTol</span><span class="p">,</span>
                  <span class="n">PLimFwd</span><span class="o">=&gt;</span><span class="n">Master</span><span class="o">.</span><span class="n">bGantryForwardEnable</span><span class="p">,</span> <span class="n">PLimBwd</span><span class="o">=&gt;</span><span class="n">Master</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span><span class="p">,</span>
                  <span class="n">SLimFwd</span><span class="o">=&gt;</span><span class="n">Slave</span><span class="o">.</span><span class="n">bGantryForwardEnable</span><span class="p">,</span> <span class="n">SLimBwd</span><span class="o">=&gt;</span><span class="n">Slave</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Coupling</span> <span class="n">Status</span> <span class="n">Bit</span>
<span class="n">bGantryAlreadyCoupled</span> <span class="o">:=</span> <span class="n">Master</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">CoupleState</span><span class="o">=</span><span class="mi">1</span> <span class="n">AND</span> <span class="n">Slave</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">CoupleState</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>

<span class="n">fbSetEnables</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">Master</span><span class="p">);</span>
<span class="n">fbSetEnables</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">Slave</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bGantryAlreadyCoupled</span> <span class="n">THEN</span>
    <span class="n">Master</span><span class="o">.</span><span class="n">bGantryForwardEnable</span> <span class="o">:=</span> <span class="n">Master</span><span class="o">.</span><span class="n">bGantryForwardEnable</span> <span class="n">AND</span> <span class="n">Slave</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">;</span>
    <span class="n">Slave</span><span class="o">.</span><span class="n">bGantryForwardEnable</span> <span class="o">:=</span> <span class="n">Master</span><span class="o">.</span><span class="n">bAllForwardEnable</span> <span class="n">AND</span> <span class="n">Slave</span><span class="o">.</span><span class="n">bGantryForwardEnable</span><span class="p">;</span>

    <span class="n">Master</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span> <span class="o">:=</span> <span class="n">Master</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span> <span class="n">AND</span> <span class="n">Slave</span><span class="o">.</span><span class="n">bAllBackwardEnable</span><span class="p">;</span>
    <span class="n">Slave</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span> <span class="o">:=</span> <span class="n">Master</span><span class="o">.</span><span class="n">bAllBackwardEnable</span> <span class="n">AND</span> <span class="n">Slave</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Coupling</span> <span class="n">states</span>
<span class="o">//</span> <span class="n">Auto</span><span class="o">-</span><span class="n">coupling</span> <span class="n">at</span> <span class="n">init</span> <span class="ow">and</span> <span class="n">auto</span><span class="o">-</span><span class="n">reset</span> <span class="n">of</span> <span class="n">coupling</span> <span class="n">boolean</span>
<span class="n">bExecuteCouple</span> <span class="n">S</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bInitComplete</span><span class="p">;</span>

<span class="n">bExecuteCouple</span> <span class="n">R</span><span class="o">=</span> <span class="n">couple</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="n">bGantryAlreadyCoupled</span><span class="p">;</span>
<span class="n">couple</span><span class="p">(</span><span class="n">Master</span><span class="o">:=</span><span class="n">Master</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span> <span class="n">Slave</span><span class="o">:=</span><span class="n">Slave</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span> <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecuteCouple</span><span class="p">);</span>

<span class="n">bInitComplete</span> <span class="n">S</span><span class="o">=</span> <span class="n">bGantryAlreadyCoupled</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Decoupling</span> <span class="k">with</span> <span class="n">auto</span><span class="o">-</span><span class="n">reset</span> <span class="n">of</span> <span class="n">coupling</span> <span class="n">boolean</span>
<span class="n">bExecuteDecouple</span> <span class="n">R</span><span class="o">=</span> <span class="n">decouple</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bGantryAlreadyCoupled</span><span class="p">;</span>
<span class="n">decouple</span><span class="p">(</span><span class="n">Slave</span><span class="o">:=</span><span class="n">Slave</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span> <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecuteDecouple</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-gantrydiffvirtuallimitswitch">FB_GantryDiffVirtualLimitSwitch</a></p></li>
<li><p><a class="reference internal" href="#fb-setenables">FB_SetEnables</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-renishawabsenc">ST_RenishawAbsEnc</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-gantrydiffvirtuallimitswitch">
<h2>FB_GantryDiffVirtualLimitSwitch<a class="headerlink" href="#fb-gantrydiffvirtuallimitswitch" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GantryDiffVirtualLimitSwitch</span>
<span class="n">VAR_INPUT</span>
    <span class="n">PEnc</span><span class="p">:</span> <span class="n">ST_RenishawAbsEnc</span><span class="p">;</span> <span class="o">//</span> <span class="n">Primary</span> <span class="n">axis</span> <span class="n">encoder</span> <span class="p">(</span><span class="n">usually</span> <span class="n">the</span> <span class="n">upstream</span> <span class="n">one</span><span class="p">)</span>
    <span class="n">SEnc</span><span class="p">:</span> <span class="n">ST_RenishawAbsEnc</span><span class="p">;</span> <span class="o">//</span> <span class="n">Secondary</span> <span class="n">axis</span> <span class="n">encoder</span> <span class="p">(</span><span class="n">couples</span> <span class="n">to</span> <span class="n">the</span> <span class="n">primary</span><span class="p">)</span>

    <span class="n">GantDiffTol</span><span class="p">:</span> <span class="n">LINT</span><span class="p">;</span>        <span class="o">//</span> <span class="n">Gantry</span> <span class="n">differenace</span> <span class="n">tolerance</span> <span class="ow">in</span> <span class="n">encoder</span> <span class="n">counts</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">PLimFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Primary</span> <span class="n">axis</span> <span class="n">forward</span> <span class="n">direction</span> <span class="n">enable</span>
    <span class="n">PLimBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Primary</span> <span class="n">axis</span> <span class="n">reverse</span> <span class="n">direction</span> <span class="n">enable</span>
    <span class="n">SLimFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Secondary</span> <span class="n">axis</span> <span class="n">forward</span> <span class="n">direction</span> <span class="n">enable</span>
    <span class="n">SLimBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Secondary</span> <span class="n">axis</span> <span class="n">reverse</span> <span class="n">direction</span> <span class="n">enable</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">GantryDiff</span><span class="p">:</span> <span class="n">LINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Gantry</span> <span class="n">Difference</span> <span class="n">Virtual</span> <span class="n">Limit</span> <span class="n">Switch</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">15</span>

<span class="n">Determines</span> <span class="n">which</span> <span class="n">direction</span> <span class="ow">is</span> <span class="n">disabled</span> <span class="n">due</span> <span class="n">to</span> <span class="n">it</span> <span class="n">increasing</span> <span class="n">the</span> <span class="n">gantry</span> <span class="n">difference</span><span class="o">.</span>
<span class="n">Refer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ESD</span> <span class="k">for</span> <span class="n">actual</span> <span class="n">conventions</span><span class="o">.</span>

<span class="n">A</span> <span class="n">positive</span> <span class="n">gantry</span> <span class="n">error</span> <span class="n">refers</span> <span class="n">to</span> <span class="n">a</span> <span class="n">CCW</span> <span class="n">clocked</span> <span class="n">assembly</span><span class="p">:</span>
<span class="n">eg</span><span class="o">.</span> <span class="k">for</span> <span class="n">X</span>
<span class="n">X1</span> <span class="n">upstream</span><span class="p">,</span> <span class="n">X2</span> <span class="n">downstream</span><span class="o">.</span> <span class="n">Primary</span> <span class="n">axis</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">upstream</span><span class="o">.</span>
<span class="n">Gantry</span> <span class="n">difference</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">when</span>
<span class="n">X2</span><span class="o">&gt;</span><span class="n">X1</span>
<span class="n">Therefore</span>
<span class="n">X2</span> <span class="n">positive</span> <span class="n">direction</span> <span class="n">disabled</span>
<span class="n">X1</span> <span class="n">negative</span> <span class="n">direction</span> <span class="n">disabled</span>

<span class="n">Call</span> <span class="n">before</span> <span class="n">FB_MotionStage</span> <span class="n">fb</span> <span class="n">calls</span> <span class="k">for</span> <span class="n">the</span> <span class="n">gantry</span> <span class="n">axes</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">GantryDiff</span> <span class="o">:=</span> <span class="p">(</span> <span class="n">ULINT_TO_LINT</span><span class="p">(</span><span class="n">PEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">)</span> <span class="o">-</span> <span class="n">ULINT_TO_LINT</span><span class="p">(</span><span class="n">PEnc</span><span class="o">.</span><span class="n">Ref</span><span class="p">)</span> <span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">ULINT_TO_LINT</span><span class="p">(</span><span class="n">SEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">)</span> <span class="o">-</span> <span class="n">ULINT_TO_LINT</span><span class="p">(</span><span class="n">SEnc</span><span class="o">.</span><span class="n">Ref</span><span class="p">)</span> <span class="p">);</span>

<span class="n">IF</span> <span class="n">ABS</span><span class="p">(</span><span class="n">GantryDiff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">GantDiffTol</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">GantryDiff</span> <span class="o">&lt;</span> <span class="mi">0</span>  <span class="n">THEN</span>
        <span class="n">PLimBwd</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">SLimFwd</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">PLimBwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">SLimFwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">IF</span> <span class="n">GantryDiff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">PLimFwd</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">SLimBwd</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">PLimFwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">SLimBwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="o">//</span><span class="n">If</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">fault</span><span class="p">,</span> <span class="nb">all</span> <span class="n">directions</span> <span class="n">are</span> <span class="n">enabled</span>
    <span class="n">PLimFwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">PLimBwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">SLimFwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">SLimBwd</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-renishawabsenc">ST_RenishawAbsEnc</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homedirect">
<h2>FB_HomeDirect<a class="headerlink" href="#fb-homedirect" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeDirect</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fHomePosition</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomed</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbHome</span><span class="p">:</span> <span class="n">MC_Home</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbHome</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">Position</span><span class="o">:=</span><span class="n">fHomePosition</span><span class="p">,</span>
    <span class="n">HomingMode</span><span class="o">:=</span><span class="n">MC_Direct</span><span class="p">,</span>
    <span class="n">bCalibrationCam</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
    <span class="p">);</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">fbHome</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-homefinish">
<h2>FB_HomeFinish<a class="headerlink" href="#fb-homefinish" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeFinish</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bSofLimEnableLow</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSofLimEnableHigh</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbHomewriteSoftLimEnable</span><span class="p">:</span><span class="n">FB_HomeWriteSoftLimEnable</span><span class="p">;</span>
    <span class="n">fbExecuteRiseEdge</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bExecuteWriteNC</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span><span class="n">INT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
  <span class="n">bExecuteWriteNC</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">bSofLimEnableLow</span><span class="p">;</span>
  <span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">bSofLimEnableHigh</span><span class="p">;</span>
  <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbExecuteRiseEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbExecuteRiseEdge</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
  <span class="n">bExecuteWriteNC</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
  <span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">bSofLimEnableLow</span><span class="p">;</span>
  <span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">bSofLimEnableHigh</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Write</span> <span class="n">to</span> <span class="n">NC</span> <span class="p">(</span><span class="n">disable</span> <span class="n">soft</span> <span class="n">limits</span><span class="p">)</span>
<span class="n">fbHomewriteSoftLimEnable</span><span class="p">(</span>
    <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteWriteNC</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bDone</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomewriteSoftLimEnable</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-homewritesoftlimenable">FB_HomeWriteSoftLimEnable</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homeprepare">
<h2>FB_HomePrepare<a class="headerlink" href="#fb-homeprepare" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomePrepare</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">bSofLimEnableLowOriginal</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSofLimEnableHighOriginal</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fVelocityToCam</span><span class="p">:</span> <span class="n">LREAL</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">fVelocityFromCam</span><span class="p">:</span> <span class="n">LREAL</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbHomeReadSoftLimEnable</span><span class="p">:</span><span class="n">FB_HomeReadSoftLimEnable</span><span class="p">;</span>
    <span class="n">fbHomeDisableSoftLimEnable</span><span class="p">:</span><span class="n">FB_HomeWriteSoftLimEnable</span><span class="p">;</span>
    <span class="n">fbHomeReadNCVelocities</span><span class="p">:</span> <span class="n">FB_HomeReadNcVelocities</span><span class="p">;</span>
    <span class="n">fbHomeResetCalibrationFlag</span><span class="p">:</span><span class="n">MC_Home</span><span class="p">;</span>   <span class="o">//</span><span class="n">Only</span> <span class="n">used</span> <span class="k">for</span> <span class="n">reset</span> <span class="n">of</span> <span class="n">calibration</span> <span class="n">flag</span>
    <span class="n">fbExecuteRiseEdge</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bExecuteReadNC</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecuteWriteNC</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span><span class="n">INT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
  <span class="n">bExecuteReadNC</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bExecuteWriteNC</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbExecuteRiseEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbExecuteRiseEdge</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
  <span class="n">bExecuteReadNC</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Read</span> <span class="kn">from</span> <span class="nn">NC</span>
<span class="n">fbHomeReadNCVelocities</span><span class="p">(</span>
  <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
  <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteReadNC</span><span class="p">,</span> <span class="o">//</span> <span class="n">Actualy</span> <span class="ow">not</span> <span class="n">needed</span> <span class="k">for</span> <span class="n">sequence</span> <span class="mi">15</span> <span class="p">(</span><span class="nb">set</span> <span class="n">position</span> <span class="n">only</span><span class="p">,</span> <span class="n">no</span> <span class="n">movement</span><span class="p">))</span>
  <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
  <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbHomeReadSoftLimEnable</span><span class="p">(</span>
    <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteReadNC</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Reset</span> <span class="n">calibration</span> <span class="n">flag</span>
<span class="n">fbHomeResetCalibrationFlag</span><span class="p">(</span>
  <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecuteReadNC</span><span class="p">,</span>
  <span class="n">HomingMode</span><span class="o">:=</span><span class="n">MC_ResetCalibration</span><span class="p">,</span>
  <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
<span class="p">);</span>

<span class="n">bSofLimEnableLowOriginal</span><span class="o">:=</span><span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="p">;</span>
<span class="n">bSofLimEnableHighOriginal</span><span class="o">:=</span><span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="p">;</span>

<span class="n">fVelocityToCam</span><span class="o">:=</span><span class="n">fbHomeReadNCVelocities</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">;</span>
<span class="n">fVelocityFromCam</span><span class="o">:=</span><span class="n">fbHomeReadNCVelocities</span><span class="o">.</span><span class="n">fVelocityFromCam</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bExecuteReadNC</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecuteWriteNC</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span><span class="n">Always</span> <span class="n">write</span> <span class="p">(</span><span class="n">only</span> <span class="n">needed</span> <span class="k">if</span> <span class="n">enabled</span> <span class="n">actually</span><span class="p">)</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Write</span> <span class="n">to</span> <span class="n">NC</span> <span class="p">(</span><span class="n">disable</span> <span class="n">soft</span> <span class="n">limits</span><span class="p">)</span>
<span class="n">fbHomeDisableSoftLimEnable</span><span class="p">(</span>
    <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteWriteNC</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbHomeReadNCVelocities</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbHomeResetCalibrationFlag</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbHomeReadNCVelocities</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbHomeResetCalibrationFlag</span><span class="o">.</span><span class="n">Done</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbHomeReadNCVelocities</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbHomeResetCalibrationFlag</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeReadSoftLimEnable</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeDisableSoftLimEnable</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbHomeResetCalibrationFlag</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeResetCalibrationFlag</span><span class="o">.</span><span class="n">ErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-homereadncvelocities">FB_HomeReadNcVelocities</a></p></li>
<li><p><a class="reference internal" href="#fb-homereadsoftlimenable">FB_HomeReadSoftLimEnable</a></p></li>
<li><p><a class="reference internal" href="#fb-homewritesoftlimenable">FB_HomeWriteSoftLimEnable</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homereadncvelocities">
<h2>FB_HomeReadNcVelocities<a class="headerlink" href="#fb-homereadncvelocities" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeReadNcVelocities</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">fVelocityToCam</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVelocityFromCam</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbReadVelocityToCam</span><span class="p">:</span><span class="n">FB_ReadFloatParameter</span><span class="p">;</span>
    <span class="n">fbReadVelocityFromCam</span><span class="p">:</span><span class="n">FB_ReadFloatParameter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbReadVelocityToCam</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#4000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#6,</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">fbReadVelocityFromCam</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#4000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#7,</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">fVelocityToCam</span><span class="o">:=</span><span class="n">fbReadVelocityToCam</span><span class="o">.</span><span class="n">nData</span><span class="p">;</span>
<span class="n">fVelocityFromCam</span><span class="o">:=</span><span class="n">fbReadVelocityFromCam</span><span class="o">.</span><span class="n">nData</span><span class="p">;</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbReadVelocityFromCam</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbReadVelocityToCam</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbReadVelocityFromCam</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbReadVelocityToCam</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbReadVelocityToCam</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbReadVelocityFromCam</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">fbReadVelocityToCam</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbReadVelocityToCam</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbReadVelocityFromCam</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbReadVelocityFromCam</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-readfloatparameter">FB_ReadFloatParameter</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homereadsoftlimenable">
<h2>FB_HomeReadSoftLimEnable<a class="headerlink" href="#fb-homereadsoftlimenable" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeReadSoftLimEnable</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">bSofLimEnableLow</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSofLimEnableHigh</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbReadSoftLimEnableLow</span><span class="p">:</span><span class="n">FB_ReadParameterInNc_v1_00</span><span class="p">;</span>
    <span class="n">fbReadSoftLimEnableHigh</span><span class="p">:</span><span class="n">FB_ReadParameterInNc_v1_00</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbReadSoftLimEnableLow</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#5000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#B,</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">fbReadSoftLimEnableHigh</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#5000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#C,</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">DWORD_TO_BOOL</span><span class="p">(</span><span class="n">fbReadSoftLimEnableLow</span><span class="o">.</span><span class="n">nData</span><span class="p">);</span>
<span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">DWORD_TO_BOOL</span><span class="p">(</span><span class="n">fbReadSoftLimEnableHigh</span><span class="o">.</span><span class="n">nData</span><span class="p">);</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbReadSoftLimEnableLow</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbReadSoftLimEnableHigh</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbReadSoftLimEnableLow</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbReadSoftLimEnableHigh</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbReadSoftLimEnableLow</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbReadSoftLimEnableHigh</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">fbReadSoftLimEnableLow</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbReadSoftLimEnableLow</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbReadSoftLimEnableHigh</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbReadSoftLimEnableHigh</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-readparameterinnc-v1-00">FB_ReadParameterInNc_v1_00</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-hometoswitch">
<h2>FB_HomeToSwitch<a class="headerlink" href="#fb-hometoswitch" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeToSwitch</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bCamSensor</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nSearchDirTwoardsCam</span><span class="p">:</span> <span class="n">MC_Direction</span><span class="p">;</span>
    <span class="n">nSearchDirOffCam</span><span class="p">:</span> <span class="n">MC_Direction</span><span class="p">;</span>
    <span class="n">fHomePosition</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVelocityToCamNC</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Velcoity</span> <span class="n">when</span> <span class="n">searching</span> <span class="k">for</span> <span class="n">cam</span>
    <span class="n">fVelocityFromCamNC</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Velocity</span> <span class="n">after</span> <span class="n">found</span> <span class="n">cam</span> <span class="p">(</span><span class="n">searching</span> <span class="k">for</span> <span class="nb">next</span> <span class="n">signal</span> <span class="n">transition</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomed</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbHome</span><span class="p">:</span> <span class="n">MC_Home</span><span class="p">;</span>
    <span class="n">fbWriteHomeDirCamToNC</span><span class="p">:</span><span class="n">FB_WriteParameterInNc_v1_00</span><span class="p">;</span>
    <span class="n">fbWriteHomeDirSyncToNC</span><span class="p">:</span><span class="n">FB_WriteParameterInNc_v1_00</span><span class="p">;</span>
    <span class="n">fbWriteHomeModeToNC</span><span class="p">:</span><span class="n">FB_WriteParameterInNc_v1_00</span><span class="p">;</span>
    <span class="n">fbWriteHomeVelocitiesToNC</span><span class="p">:</span> <span class="n">FB_HomeWriteNcVelocities</span><span class="p">;</span>
    <span class="n">bConfigNCDone</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbRTrigg</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bConfigNCDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Start</span> <span class="n">preparation</span> <span class="n">of</span> <span class="n">NC</span> <span class="k">if</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">on</span> <span class="n">bExecute</span>
<span class="n">fbRTrigg</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbRTrigg</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bConfigNCDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="n">fbWriteHomeDirCamToNC</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bConfigNCDone</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#5000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#101,   //Direction for Calibration Cam Search</span>
    <span class="n">nData</span><span class="o">:=</span><span class="n">BOOL_TO_DWORD</span><span class="p">(</span><span class="n">nSearchDirTwoardsCam</span><span class="o">=</span><span class="n">MC_Negative_Direction</span><span class="p">),</span><span class="o">//</span><span class="n">BOOL_TO_DWORD</span><span class="p">(</span><span class="n">NOT</span> <span class="n">bSearchDirTwoardsCam</span><span class="p">),</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
<span class="p">);</span>

<span class="n">fbWriteHomeDirSyncToNC</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bConfigNCDone</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#5000 ,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#102 , //Direction for Sync Impuls Search</span>
    <span class="n">nData</span><span class="o">:=</span><span class="n">BOOL_TO_DWORD</span><span class="p">(</span><span class="n">nSearchDirOffCam</span><span class="o">=</span><span class="n">MC_Negative_Direction</span><span class="p">),</span><span class="o">//</span><span class="n">BOOL_TO_DWORD</span><span class="p">(</span><span class="n">NOT</span> <span class="n">bSearchDirOffCam</span><span class="p">),</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span>
<span class="p">);</span>

<span class="n">fbWriteHomeModeToNC</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bConfigNCDone</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#5000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#107,  //Reference Mode</span>
    <span class="n">nData</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">axis</span><span class="p">);</span>

<span class="n">fbWriteHomeVelocitiesToNC</span><span class="p">(</span>
  <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
  <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bConfigNCDone</span><span class="p">,</span>
  <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
  <span class="n">fVelocityFromCam</span><span class="o">:=</span><span class="n">fVelocityFromCamNC</span><span class="p">,</span>
  <span class="n">fVelocityToCam</span><span class="o">:=</span><span class="n">fVelocityToCamNC</span><span class="p">,</span>
  <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">);</span>

<span class="n">fbHome</span><span class="o">.</span><span class="n">bCalibrationCam</span><span class="o">:=</span><span class="n">bCamSensor</span><span class="p">;</span>

<span class="n">fbHome</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">bConfigNCDone</span><span class="p">(</span><span class="o">*</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span><span class="o">*</span><span class="p">),</span>
    <span class="n">Position</span><span class="o">:=</span><span class="n">fHomePosition</span><span class="p">,</span>
    <span class="n">HomingMode</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
    <span class="p">);</span>
<span class="n">bBusy</span><span class="o">:=</span><span class="p">(</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bConfigNCDone</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">));</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Done</span> <span class="n">AND</span> <span class="n">bConfigNCDone</span><span class="p">;</span>
<span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bConfigNCDone</span><span class="p">)</span> <span class="n">AND</span> <span class="n">fbWriteHomeDirCamToNC</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbWriteHomeDirSyncToNC</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbWriteHomeModeToNC</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbWriteHomeVelocitiesToNC</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
  <span class="n">bConfigNCDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">For</span> <span class="n">some</span> <span class="n">reason</span> <span class="n">MC_HOME</span> <span class="n">gives</span> <span class="n">an</span> <span class="n">Error</span> <span class="k">for</span> <span class="n">one</span> <span class="n">cycle</span> <span class="n">of</span> <span class="n">NC</span><span class="o">-</span><span class="n">Task</span> <span class="mi">1</span> <span class="n">SVB</span> <span class="p">(</span><span class="mi">10</span><span class="n">ms</span> <span class="n">default</span><span class="o">..</span><span class="p">)</span> <span class="n">so</span> <span class="nb">filter</span> <span class="k">with</span> <span class="n">bExecute</span>
<span class="n">bError</span><span class="o">:=</span><span class="p">(</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">)</span> <span class="n">OR</span> <span class="n">fbWriteHomeDirCamToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbWriteHomeDirSyncToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbWriteHomeModeToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbWriteHomeVelocitiesToNC</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">)</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteHomeDirCamToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteHomeDirCamToNC</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteHomeDirSyncToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteHomeDirSyncToNC</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteHomeModeToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteHomeModeToNC</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteHomeVelocitiesToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteHomeVelocitiesToNC</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-homewritencvelocities">FB_HomeWriteNcVelocities</a></p></li>
<li><p><a class="reference internal" href="#fb-writeparameterinnc-v1-00">FB_WriteParameterInNc_v1_00</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homevirtual">
<h2>FB_HomeVirtual<a class="headerlink" href="#fb-homevirtual" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeVirtual</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bLimitFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomeSensor</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fHomePosition</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nHomeRevOffset</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomed</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbHomeToSwitch</span><span class="p">:</span> <span class="n">FB_HomeToSwitch</span><span class="p">;</span>
    <span class="n">fbHomeDirect</span><span class="p">:</span> <span class="n">FB_HomeDirect</span><span class="p">;</span> <span class="o">//</span><span class="n">Only</span> <span class="n">used</span> <span class="k">for</span> <span class="n">direct</span> <span class="n">homing</span> <span class="p">(</span><span class="nb">set</span> <span class="n">of</span> <span class="n">position</span><span class="p">)</span>
    <span class="n">fbMoveVelocity</span><span class="p">:</span><span class="n">MC_MoveVelocity</span><span class="p">;</span>
    <span class="n">fbHomePrepare</span><span class="p">:</span><span class="n">FB_HomePrepare</span><span class="p">;</span>
    <span class="n">fbHomeFinish</span><span class="p">:</span><span class="n">FB_HomeFinish</span><span class="p">;</span>
    <span class="n">fbExecuteRiseEdge</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">nHomingState</span><span class="p">:</span><span class="n">INT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">bExecuteHomeToSwitch</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecuteMoveVelocity</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecutePrepare</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecuteFinish</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecuteHomeDirect</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nCmdDataLocal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>  <span class="o">//</span><span class="n">Ensure</span> <span class="n">that</span> <span class="n">nCmdData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">changed</span> <span class="n">during</span> <span class="n">sequence</span>
    <span class="n">bSequenceReady</span><span class="p">:</span><span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bRestoreNCDataNeeded</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Reset</span> <span class="n">when</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">low</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
  <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
  <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
  <span class="n">bExecuteHomeToSwitch</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bExecuteHomeDirect</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bExecutePrepare</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Reset</span> <span class="n">at</span> <span class="n">rinsing</span> <span class="n">edge</span> <span class="n">of</span> <span class="n">bExecute</span>
<span class="n">fbExecuteRiseEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fbExecuteRiseEdge</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
  <span class="n">nCmdDataLocal</span><span class="o">:=</span><span class="n">nCmdData</span><span class="p">;</span> <span class="o">//</span><span class="n">Ensure</span> <span class="n">that</span> <span class="n">nCmdData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">changed</span> <span class="n">during</span> <span class="n">sequence</span> <span class="p">(</span><span class="n">nCmdData</span> <span class="n">will</span> <span class="n">only</span> <span class="n">be</span> <span class="n">read</span> <span class="n">at</span> <span class="n">a</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">of</span> <span class="n">bExecute</span><span class="p">)</span>
  <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bExecutePrepare</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
  <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="o">//</span><span class="n">Check</span> <span class="k">if</span> <span class="n">valid</span> <span class="n">nCmdDataLocal</span>
  <span class="n">CASE</span> <span class="n">nCmdDataLocal</span> <span class="n">OF</span>
    <span class="mi">1</span><span class="p">:</span>
    <span class="mi">2</span><span class="p">:</span>
    <span class="mi">3</span><span class="p">:</span>
    <span class="mi">4</span><span class="p">:</span>
    <span class="mi">15</span><span class="p">:</span>
    <span class="n">ELSE</span> <span class="o">//</span><span class="n">nCmdData</span> <span class="ow">not</span> <span class="n">valid</span>
      <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
      <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4FFF;</span>
  <span class="n">END_CASE</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="c1">############# Prepare for homing (Read from NC and reset homed flag)</span>
<span class="n">fbHomePrepare</span><span class="p">(</span>
  <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
  <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecutePrepare</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span><span class="p">,</span> <span class="o">//</span> <span class="n">Not</span> <span class="n">needed</span> <span class="k">for</span> <span class="n">sequence</span> <span class="mi">15</span> <span class="p">(</span><span class="nb">set</span> <span class="n">position</span> <span class="n">only</span><span class="p">,</span> <span class="n">no</span> <span class="n">movement</span><span class="p">))</span>
  <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
  <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span><span class="c1">############# Homing Sequences:</span>
<span class="n">CASE</span> <span class="n">nCmdDataLocal</span> <span class="n">OF</span>

   <span class="mi">1</span><span class="p">:</span> <span class="o">//</span> <span class="n">Home</span> <span class="n">to</span> <span class="n">low</span> <span class="n">limit</span> <span class="n">switch</span>
       <span class="n">CASE</span> <span class="n">nHomingState</span> <span class="n">OF</span>
              <span class="mi">0</span><span class="p">:</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">read</span> <span class="n">of</span> <span class="n">velocities</span> <span class="kn">from</span> <span class="nn">NC</span> <span class="ow">and</span> <span class="n">reset</span> <span class="n">of</span> <span class="n">calibration</span> <span class="n">flag</span>
            <span class="n">IF</span> <span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bSequenceReady</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">IF</span> <span class="n">bLimitBwd</span> <span class="n">THEN</span>
                <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
              <span class="n">ELSE</span>
                            <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>  <span class="o">//</span><span class="n">Standing</span> <span class="n">on</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">go</span> <span class="n">direct</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">2</span>
              <span class="n">END_IF</span>
            <span class="n">END_IF</span>
              <span class="mi">1</span><span class="p">:</span> <span class="o">//</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">reach</span> <span class="n">low</span> <span class="n">limit</span> <span class="n">then</span> <span class="n">trigger</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">);</span>
            <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Direction</span><span class="o">:=</span><span class="n">MC_Negative_Direction</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Execute</span> <span class="n">MC_MoveVelocity</span>
                <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLimitBwd</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">MC_MoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">goes</span> <span class="n">down</span> <span class="n">when</span> <span class="n">ramp</span> <span class="n">down</span> <span class="n">initiates</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ends</span><span class="p">)</span><span class="o">.</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>
                <span class="n">END_IF</span>
              <span class="mi">2</span><span class="p">:</span> <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteHomeToSwitch</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirTwoardsCam</span><span class="o">:=</span><span class="n">MC_Positive_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirOffCam</span><span class="o">:=</span><span class="n">MC_Positive_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityToCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">;</span> <span class="o">//</span> <span class="n">High</span> <span class="n">speed</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityFromCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityFromCam</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Low</span> <span class="n">speed</span>
                <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bCamSensor</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bLimitBwd</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">3</span><span class="p">;</span>
                      <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableHighOriginal</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableLowOriginal</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
          <span class="mi">3</span><span class="p">:</span> <span class="o">//</span> <span class="n">restore</span> <span class="n">softlimit</span> <span class="n">enable</span>
            <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
              <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
                      <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
       <span class="n">END_CASE</span><span class="p">;</span>

   <span class="mi">2</span><span class="p">:</span> <span class="o">//</span> <span class="n">Home</span> <span class="n">to</span> <span class="n">high</span> <span class="n">limit</span> <span class="n">switch</span>
       <span class="n">CASE</span> <span class="n">nHomingState</span> <span class="n">OF</span>
              <span class="mi">0</span><span class="p">:</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">read</span> <span class="n">of</span> <span class="n">velocities</span> <span class="kn">from</span> <span class="nn">NC</span> <span class="ow">and</span> <span class="n">reset</span> <span class="n">of</span> <span class="n">calibration</span> <span class="n">flag</span>
            <span class="n">IF</span> <span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bSequenceReady</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">IF</span> <span class="n">bLimitFwd</span> <span class="n">THEN</span>
                <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
              <span class="n">ELSE</span>
                            <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>  <span class="o">//</span><span class="n">Standing</span> <span class="n">on</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">go</span> <span class="n">direct</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">2</span>
              <span class="n">END_IF</span>
            <span class="n">END_IF</span>
              <span class="mi">1</span><span class="p">:</span> <span class="o">//</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">reach</span> <span class="n">low</span> <span class="n">limit</span> <span class="n">then</span> <span class="n">trigger</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">);</span>
            <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Direction</span><span class="o">:=</span><span class="n">MC_Positive_Direction</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Execute</span> <span class="n">MC_MoveVelocity</span>
                <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLimitFwd</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">MC_MoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">goes</span> <span class="n">down</span> <span class="n">when</span> <span class="n">ramp</span> <span class="n">down</span> <span class="n">initiates</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ends</span><span class="p">)</span><span class="o">.</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>
                <span class="n">END_IF</span>
              <span class="mi">2</span><span class="p">:</span> <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteHomeToSwitch</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirTwoardsCam</span><span class="o">:=</span><span class="n">MC_Negative_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirOffCam</span><span class="o">:=</span><span class="n">MC_Negative_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityToCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">;</span> <span class="o">//</span> <span class="n">High</span> <span class="n">speed</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityFromCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityFromCam</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Low</span> <span class="n">speed</span>
                <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bCamSensor</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bLimitFwd</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">3</span><span class="p">;</span>
                      <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableHighOriginal</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableLowOriginal</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
          <span class="mi">3</span><span class="p">:</span> <span class="o">//</span> <span class="n">restore</span> <span class="n">softlimit</span> <span class="n">enable</span>
            <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
              <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
                      <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
       <span class="n">END_CASE</span><span class="p">;</span>

   <span class="mi">3</span><span class="p">:</span> <span class="o">//</span> <span class="n">Home</span> <span class="n">on</span> <span class="n">bHomeSensor</span> <span class="n">via</span> <span class="n">bLimitBwd</span>
       <span class="n">CASE</span> <span class="n">nHomingState</span> <span class="n">OF</span>
              <span class="mi">0</span><span class="p">:</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">read</span> <span class="n">of</span> <span class="n">velocities</span> <span class="kn">from</span> <span class="nn">NC</span> <span class="ow">and</span> <span class="n">reset</span> <span class="n">of</span> <span class="n">calibration</span> <span class="n">flag</span>
            <span class="n">IF</span> <span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bSequenceReady</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">IF</span> <span class="n">bLimitBwd</span> <span class="n">THEN</span>
                <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
              <span class="n">ELSE</span>
                            <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>  <span class="o">//</span><span class="n">Standing</span> <span class="n">on</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">go</span> <span class="n">direct</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">2</span>
              <span class="n">END_IF</span>
            <span class="n">END_IF</span>
              <span class="mi">1</span><span class="p">:</span> <span class="o">//</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">reach</span> <span class="n">low</span> <span class="n">limit</span> <span class="n">then</span> <span class="n">trigger</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">);</span>
            <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Direction</span><span class="o">:=</span><span class="n">MC_Negative_Direction</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Execute</span> <span class="n">MC_MoveVelocity</span>
                <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLimitBwd</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">MC_MoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">goes</span> <span class="n">down</span> <span class="n">when</span> <span class="n">ramp</span> <span class="n">down</span> <span class="n">initiates</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ends</span><span class="p">)</span><span class="o">.</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>
                <span class="n">END_IF</span>
              <span class="mi">2</span><span class="p">:</span> <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteHomeToSwitch</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirTwoardsCam</span><span class="o">:=</span><span class="n">MC_Positive_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirOffCam</span><span class="o">:=</span><span class="n">MC_Positive_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityToCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">;</span> <span class="o">//</span> <span class="n">High</span> <span class="n">speed</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityFromCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityFromCam</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Low</span> <span class="n">speed</span>
                <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bCamSensor</span><span class="o">:=</span><span class="n">bHomeSensor</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">3</span><span class="p">;</span>
                      <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableHighOriginal</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableLowOriginal</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
          <span class="mi">3</span><span class="p">:</span> <span class="o">//</span> <span class="n">restore</span> <span class="n">softlimit</span> <span class="n">enable</span>
            <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                  <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
              <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
                      <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
       <span class="n">END_CASE</span><span class="p">;</span>
    <span class="mi">4</span><span class="p">:</span>  <span class="o">//</span> <span class="n">Home</span> <span class="n">on</span> <span class="n">bHomeSensor</span> <span class="n">via</span> <span class="n">bLimitFwd</span>
       <span class="n">CASE</span> <span class="n">nHomingState</span> <span class="n">OF</span>
              <span class="mi">0</span><span class="p">:</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">read</span> <span class="n">of</span> <span class="n">velocities</span> <span class="kn">from</span> <span class="nn">NC</span> <span class="ow">and</span> <span class="n">reset</span> <span class="n">of</span> <span class="n">calibration</span> <span class="n">flag</span>
            <span class="n">IF</span> <span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bSequenceReady</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">IF</span> <span class="n">bLimitFwd</span> <span class="n">THEN</span>
                <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span>
              <span class="n">ELSE</span>
                            <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>  <span class="o">//</span><span class="n">Standing</span> <span class="n">on</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">go</span> <span class="n">direct</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">2</span>
              <span class="n">END_IF</span>
            <span class="n">END_IF</span>
              <span class="mi">1</span><span class="p">:</span> <span class="o">//</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">reach</span> <span class="n">low</span> <span class="n">limit</span> <span class="n">then</span> <span class="n">trigger</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                    <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">);</span>
            <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Direction</span><span class="o">:=</span><span class="n">MC_Positive_Direction</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Execute</span> <span class="n">MC_MoveVelocity</span>
                <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLimitFwd</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">MC_MoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">goes</span> <span class="n">down</span> <span class="n">when</span> <span class="n">ramp</span> <span class="n">down</span> <span class="n">initiates</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ends</span><span class="p">)</span><span class="o">.</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">2</span><span class="p">;</span>
                <span class="n">END_IF</span>
              <span class="mi">2</span><span class="p">:</span> <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">fbHomeToSwitch</span>
                <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteMoveVelocity</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bExecuteHomeToSwitch</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirTwoardsCam</span><span class="o">:=</span><span class="n">MC_Negative_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nSearchDirOffCam</span><span class="o">:=</span><span class="n">MC_Negative_Direction</span><span class="p">;</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityToCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityToCam</span><span class="p">;</span> <span class="o">//</span> <span class="n">High</span> <span class="n">speed</span>
            <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">fVelocityFromCamNC</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">fVelocityFromCam</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Low</span> <span class="n">speed</span>
                <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bCamSensor</span><span class="o">:=</span><span class="n">bHomeSensor</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">3</span><span class="p">;</span>
                      <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableHigh</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableHighOriginal</span><span class="p">;</span>
                      <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bSofLimEnableLow</span><span class="o">:=</span><span class="n">fbHomePrepare</span><span class="o">.</span><span class="n">bSofLimEnableLowOriginal</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
          <span class="mi">3</span><span class="p">:</span> <span class="o">//</span> <span class="n">Restore</span> <span class="n">softlimit</span> <span class="n">enable</span>
            <span class="n">bHomed</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
                      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
              <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
                      <span class="n">nHomingState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
                      <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
            <span class="n">END_IF</span><span class="p">;</span>
       <span class="n">END_CASE</span><span class="p">;</span>

   <span class="mi">15</span><span class="p">:</span> <span class="o">//</span><span class="n">Set</span> <span class="n">current</span> <span class="n">position</span> <span class="p">(</span><span class="n">simplest</span> <span class="n">homing</span> <span class="n">sequence</span><span class="p">)</span>
     <span class="n">bExecuteHomeDirect</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>
     <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
     <span class="n">IF</span> <span class="n">fbHomeDirect</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>  <span class="o">//</span><span class="n">Homing</span> <span class="n">ready</span>
       <span class="n">bExecuteHomeDirect</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
       <span class="n">bSequenceReady</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
     <span class="n">END_IF</span>

<span class="n">ELSE</span>
  <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bCamSensor</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
  <span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span>
<span class="n">END_CASE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Main</span> <span class="n">homing</span> <span class="n">block</span>
<span class="n">fbHomeToSwitch</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteHomeToSwitch</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecuteHomeDirect</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecuteMoveVelocity</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
    <span class="n">fHomePosition</span><span class="o">:=</span><span class="n">fHomePosition</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Approach</span> <span class="n">limit</span> <span class="n">switch</span> <span class="p">(</span><span class="n">error</span> <span class="k">if</span> <span class="n">MC_Home</span> <span class="ow">is</span> <span class="n">used</span><span class="p">)</span>
<span class="n">fbMoveVelocity</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span> <span class="n">bExecuteMoveVelocity</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecuteHomeToSwitch</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecuteHomeDirect</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">No</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">just</span> <span class="nb">set</span> <span class="n">position</span> <span class="n">value</span> <span class="p">(</span><span class="n">nCmdDataLocal</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span> <span class="n">Can</span> <span class="ow">not</span> <span class="n">run</span> <span class="k">if</span> <span class="n">fbHomeToSwitch</span> <span class="ow">is</span> <span class="n">executed</span>
<span class="n">fbHomeDirect</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteHomeDirect</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span>  <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecuteHomeToSwitch</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecuteMoveVelocity</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
    <span class="n">fHomePosition</span><span class="o">:=</span><span class="n">fHomePosition</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span>
<span class="p">);</span>


<span class="o">//</span><span class="c1">############# Finish homing</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bexecute</span> <span class="n">AND</span> <span class="n">bRestoreNCDataNeeded</span> <span class="n">THEN</span>  <span class="o">//</span><span class="n">If</span> <span class="n">homing</span> <span class="ow">is</span> <span class="n">aborted</span> <span class="n">restore</span> <span class="ow">is</span> <span class="n">needed</span>
    <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">fbHomeFinish</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
      <span class="n">bExecuteFinish</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
      <span class="n">bRestoreNCDataNeeded</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">fbHomeFinish</span><span class="p">(</span>
  <span class="n">En</span><span class="o">:=</span><span class="n">En</span><span class="p">,</span>
  <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteFinish</span><span class="p">,</span>
  <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
  <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Error</span> <span class="n">handling</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">IF</span> <span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeToSwitch</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
  <span class="n">ELSIF</span> <span class="n">fbHomeDirect</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbHomeDirect</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHomeDirect</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
  <span class="n">ELSIF</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">ErrorId</span><span class="p">;</span>
  <span class="n">END_IF</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Done</span> <span class="ow">and</span> <span class="n">busy</span> <span class="n">bit</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">bSequenceReady</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">;</span>
<span class="n">bBusy</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bSequenceReady</span><span class="p">;</span>

<span class="n">RETURN</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-homedirect">FB_HomeDirect</a></p></li>
<li><p><a class="reference internal" href="#fb-homefinish">FB_HomeFinish</a></p></li>
<li><p><a class="reference internal" href="#fb-homeprepare">FB_HomePrepare</a></p></li>
<li><p><a class="reference internal" href="#fb-hometoswitch">FB_HomeToSwitch</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homewritencvelocities">
<h2>FB_HomeWriteNcVelocities<a class="headerlink" href="#fb-homewritencvelocities" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeWriteNcVelocities</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fVelocityToCam</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVelocityFromCam</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbExecuteRiseEdge</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fbWriteVelocityToCam</span><span class="p">:</span><span class="n">FB_WriteFloatParameter</span><span class="p">;</span>
    <span class="n">fbWriteVelocityFromCam</span><span class="p">:</span><span class="n">FB_WriteFloatParameter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbExecuteRiseEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>

<span class="n">fbWriteVelocityToCam</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#4000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#6,</span>
    <span class="n">nData</span><span class="o">:=</span><span class="n">fVelocityToCam</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">fbWriteVelocityFromCam</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#4000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#7,</span>
    <span class="n">nData</span><span class="o">:=</span><span class="n">fVelocityFromCam</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbWriteVelocityFromCam</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbWriteVelocityToCam</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbWriteVelocityFromCam</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbWriteVelocityToCam</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbWriteVelocityToCam</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbWriteVelocityFromCam</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">fbWriteVelocityToCam</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteVelocityToCam</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteVelocityFromCam</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteVelocityFromCam</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-writefloatparameter">FB_WriteFloatParameter</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homewritesoftlimenable">
<h2>FB_HomeWriteSoftLimEnable<a class="headerlink" href="#fb-homewritesoftlimenable" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomeWriteSoftLimEnable</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bSofLimEnableLow</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSofLimEnableHigh</span><span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbExecuteRiseEdge</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fbWriteSoftLimEnableLow</span><span class="p">:</span><span class="n">FB_WriteParameterInNc_v1_00</span><span class="p">;</span>
    <span class="n">fbWriteSoftLimEnableHigh</span><span class="p">:</span><span class="n">FB_WriteParameterInNc_v1_00</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">En</span><span class="o">:=</span><span class="n">EnO</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbExecuteRiseEdge</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>

<span class="n">fbWriteSoftLimEnableLow</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#5000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#B,</span>
    <span class="n">nData</span><span class="o">:=</span><span class="n">BOOL_TO_DWORD</span><span class="p">(</span><span class="n">bSofLimEnableLow</span><span class="p">),</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">fbWriteSoftLimEnableHigh</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">nDeviceGroup</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#5000,</span>
    <span class="n">nIndexOffset</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#C,</span>
    <span class="n">nData</span><span class="o">:=</span><span class="n">BOOL_TO_DWORD</span><span class="p">(</span><span class="n">bSofLimEnableHigh</span><span class="p">),</span>
    <span class="n">Axis</span><span class="o">:=</span> <span class="n">Axis</span><span class="p">);</span>

<span class="n">bBusy</span><span class="o">:=</span><span class="n">fbWriteSoftLimEnableLow</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">fbWriteSoftLimEnableHigh</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">bDone</span><span class="o">:=</span><span class="n">fbWriteSoftLimEnableLow</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">fbWriteSoftLimEnableHigh</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">;</span>

<span class="n">bError</span><span class="o">:=</span><span class="n">fbWriteSoftLimEnableHigh</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbWriteSoftLimEnableLow</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">fbWriteSoftLimEnableHigh</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteSoftLimEnableHigh</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteSoftLimEnableLow</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
  <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteSoftLimEnableLow</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-writeparameterinnc-v1-00">FB_WriteParameterInNc_v1_00</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-logmotionerror">
<h2>FB_LogMotionError<a class="headerlink" href="#fb-logmotionerror" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LogMotionError</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">If</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">struct</span> <span class="n">has</span> <span class="n">an</span> <span class="n">error</span><span class="p">,</span> <span class="n">log</span> <span class="n">it</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">log</span> <span class="n">condition</span> <span class="ow">is</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">When</span> <span class="n">bError</span> <span class="n">goes</span> <span class="n">TRUE</span> <span class="p">(</span><span class="n">catch</span> <span class="n">transition</span> <span class="kn">from</span> <span class="nn">no</span> <span class="n">error</span> <span class="n">to</span> <span class="n">error</span><span class="p">)</span>
    <span class="o">-</span> <span class="n">When</span> <span class="n">the</span> <span class="n">error</span> <span class="n">message</span> <span class="n">changes</span> <span class="k">while</span> <span class="n">bError</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="p">(</span><span class="n">catch</span> <span class="n">transition</span> <span class="kn">from</span> <span class="nn">error</span> <span class="n">a</span> <span class="n">to</span> <span class="n">error</span> <span class="n">b</span><span class="p">)</span>

    <span class="n">Includes</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">NC</span> <span class="n">error</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">json</span> <span class="n">blob</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbLogMessage</span><span class="p">:</span> <span class="n">FB_LogMessage</span><span class="p">;</span>
    <span class="n">rtNewError</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bChangedError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sPrevErr</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fbJson</span><span class="p">:</span> <span class="n">FB_JsonSaxWriter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtNewError</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">);</span>
<span class="n">bChangedError</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;&#39;</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">&lt;&gt;</span> <span class="n">sPrevErr</span><span class="p">;</span>
<span class="n">sPrevErr</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bEnable</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rtNewError</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">bChangedError</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">StartObject</span><span class="p">();</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddString</span><span class="p">(</span><span class="s1">&#39;ST_MotionStage.bError&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;dut_name&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddString</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">sName</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;axis_name&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddString</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">sAxisName</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;axis_id&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddUdint</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">AxisId</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;err_id&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddUdint</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddLreal</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddKey</span><span class="p">(</span><span class="s1">&#39;position_lag&#39;</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddLreal</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActDiff</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">EndObject</span><span class="p">();</span>
    <span class="n">fbLogMessage</span><span class="o">.</span><span class="n">sJson</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">GetDocument</span><span class="p">();</span>
    <span class="n">fbLogMessage</span><span class="p">(</span>
        <span class="n">sMsg</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span>
        <span class="n">eSevr</span> <span class="o">:=</span> <span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span>
        <span class="n">eSubsystem</span> <span class="o">:=</span> <span class="n">E_Subsystem</span><span class="o">.</span><span class="n">MOTION</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">ResetDocument</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-microstepcounttest">
<h2>FB_MicroStepCountTest<a class="headerlink" href="#fb-microstepcounttest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MicroStepCountTest</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fStepSize</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nSteps</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fMicroStep</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tSettleTime</span><span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">nStepsCounted</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nTheorySteps</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fPercent</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fEstMicroSize</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbMoveRel</span><span class="p">:</span> <span class="n">MC_MoveRelative</span><span class="p">;</span>
    <span class="n">fbSettleTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bDoMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nStepCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="n">arrPosBuffer</span><span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">0..99</span><span class="p">]</span> <span class="n">OF</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fAvgPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nArrIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nLoopIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="n">fStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPrevPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fStepChange</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="n">fStepSum</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Motion</span> <span class="n">FB</span>
<span class="n">fbMoveRel</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bDoMove</span><span class="p">,</span>
    <span class="n">Distance</span><span class="o">:=</span><span class="n">fStepSize</span><span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">fVelocity</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Settle</span> <span class="n">time</span>
<span class="n">fbSettleTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">fbMoveRel</span><span class="o">.</span><span class="n">Done</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">tSettleTime</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Re</span><span class="o">-</span><span class="n">enable</span> <span class="n">the</span> <span class="n">move</span> <span class="k">for</span> <span class="nb">next</span> <span class="n">cycle</span>
<span class="n">bDoMove</span> <span class="o">:=</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">nStepCounter</span> <span class="o">&lt;</span> <span class="n">nSteps</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Calculate</span> <span class="n">rolling</span> <span class="n">average</span>
<span class="n">arrPosBuffer</span><span class="p">[</span><span class="n">nArrIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">;</span>
<span class="n">fAvgPos</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nLoopIndex</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="mi">99</span> <span class="n">DO</span>
    <span class="n">fAvgPos</span> <span class="o">:=</span> <span class="n">fAvgPos</span> <span class="o">+</span> <span class="n">arrPosBuffer</span><span class="p">[</span><span class="n">nLoopIndex</span><span class="p">];</span>
<span class="n">END_FOR</span><span class="p">;</span>
<span class="n">fAvgPos</span> <span class="o">:=</span> <span class="n">fAvgPos</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
<span class="n">nArrIndex</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nArrIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="n">MOD</span> <span class="mi">100</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Initialize</span> <span class="n">starting</span> <span class="n">variables</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">fStartPos</span> <span class="o">:=</span> <span class="n">fAvgPos</span><span class="p">;</span>
    <span class="n">fPrevPos</span> <span class="o">:=</span> <span class="n">fAvgPos</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Check</span> <span class="n">results</span>
<span class="n">IF</span> <span class="n">fbSettleTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">fStepChange</span> <span class="o">:=</span> <span class="n">fAvgPos</span> <span class="o">-</span> <span class="n">fPrevPos</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Invert</span> <span class="n">fStepChange</span> <span class="k">if</span> <span class="n">we</span> <span class="n">were</span> <span class="n">doing</span> <span class="n">negative</span> <span class="n">steps</span>
    <span class="n">IF</span> <span class="n">fStepSize</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">fStepChange</span> <span class="o">:=</span> <span class="n">fStepChange</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">IF</span> <span class="n">fStepChange</span> <span class="o">&gt;</span> <span class="n">fMicroStep</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="n">THEN</span>
        <span class="n">nStepsCounted</span> <span class="o">:=</span> <span class="n">nStepsCounted</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">fStepSum</span> <span class="o">:=</span> <span class="n">fStepSum</span> <span class="o">+</span> <span class="n">fStepChange</span><span class="p">;</span>
        <span class="n">fEstMicroSize</span> <span class="o">:=</span> <span class="n">fStepSum</span> <span class="o">/</span> <span class="n">nStepsCounted</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">nTheorySteps</span> <span class="o">:=</span> <span class="n">DINT_TO_UINT</span><span class="p">(</span><span class="n">TRUNC</span><span class="p">(</span><span class="n">ABS</span><span class="p">((</span><span class="n">fStartPos</span> <span class="o">-</span> <span class="n">fAvgPos</span><span class="p">)</span> <span class="o">/</span> <span class="n">fMicroStep</span><span class="p">)));</span>
    <span class="n">IF</span> <span class="n">nTheorySteps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">fPercent</span> <span class="o">:=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">nStepsCounted</span> <span class="o">/</span> <span class="n">nTheorySteps</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">fPrevPos</span> <span class="o">:=</span> <span class="n">fAvgPos</span><span class="p">;</span>
    <span class="n">nStepCounter</span> <span class="o">:=</span> <span class="n">nStepCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">move</span> <span class="n">block</span>
    <span class="n">bDoMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-miscstateserrorffo">
<h2>FB_MiscStatesErrorFFO<a class="headerlink" href="#fb-miscstateserrorffo" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_MiscStatesErrorFFO
(*
    A catch-all for miscellaneous state FFOs that are not better organized elsewhere.
    Contains the following fast faults:
    - ffBeamParamsOK: trip the beam if the beam parameters are not safe enough for our current (known) state
    - ffZeroRate: trip the beam if we&#39;ve asked for zero rate (as a shortcut)
    - ffUnknown: trip the beam if we&#39;re at an unknown state and our transition id is not asserted.
    - ffDebounce: trip the beam (no autoreset) if ffBeamParamsOK fast faults fault on and off multiple times too quickly.
      This solves an issue where ffBeamParamsOK might solve its own problem and creating a blinking fast fault issue.

    The inputs are mostly outputs of non-pmps function blocks and heavily-reused info like state details.
*)
VAR_IN_OUT
    // The arbiter to request beam states from
    fbArbiter: FB_Arbiter;
    // The fast fault output to fault to
    fbFFHWO: FB_HardwareFFOutput;
END_VAR
VAR_INPUT
    // A name to link to these fast faults
    sDeviceName: STRING;
    // Current requested beam details: either a known state or the transition beam
    stCurrentBeamReq: ST_BeamParams;
    // TRUE if we&#39;re at a known state (doesn&#39;t matter which)
    bKnownState: BOOL;
    // Lookup ID of the transition beam
    nTransitionID: DWORD;
END_VAR
VAR_OUTPUT
END_VAR
VAR CONSTANT
    // Number of consecutive trips before we debounce
    nMaxTrips: UINT := 5;
    // Decrease trip count by 1 after this much time has passed
    tTripReset: TIME := T#1s;
END_VAR
VAR
    // If the beam parameters are wrong, it is a fault! This encompasses all unknown arbiter-related errors.
    ffBeamParamsOk: FB_FastFault;
    // If we asked for zero rate (NC or SC) then we can cut the beam early. This is somewhat redundant.
    ffZeroRate: FB_FastFault;
    // Trip the beam for unknown state
    ffUnknown: FB_FastFault;
    // Trip the beam (no autoreset) if ffBeamParamsOK faults/resets multiple times too quickly.
    ffDebounce: FB_FastFault;

    // Number of consecutive trips so far
    nTripCount: UINT;
    // Increase by 1 whenever there is a fault (rising edge)
    ftTripCount: F_TRIG;
    // Decrease trip count by 1 each timeout
    tonTripCount: TON;
    // TRUE on only the first cycle
    bFirstCycle: BOOL := TRUE;
END_VAR
ffBeamParamsOk(
    i_xOK:=F_SafeBPCompare(PMPS_GVL.stCurrentBeamParameters, stCurrentBeamReq),
    i_xAutoReset:=TRUE,
    i_DevName:=sDeviceName,
    i_Desc:=&#39;Beam parameter mismatch&#39;,
    i_TypeCode:=E_MotionFFType.BP_MISMATCH,
    io_fbFFHWO:=fbFFHWO);

CASE PMPS_GVL.stCurrentBeamParameters.nMachineMode OF
    // NC mode
    1: ffZeroRate.i_xOK := stCurrentBeamReq.nRate &gt; 0;
    // SC mode
    2: ffZeroRate.i_xOK := stCurrentBeamReq.nBCRange &gt; 0;
ELSE
    // Ambiguous or new mode
    ffZeroRate.i_xOK := stCurrentBeamReq.nRate &gt; 0 AND stCurrentBeamReq.nBCRange &gt; 0;
END_CASE

ffZeroRate(
    i_xAutoReset := TRUE,
    i_DevName := sDeviceName,
    i_Desc := &#39;Device requesting zero rate&#39;,
    i_TypeCode := E_MotionFFType.ZERO_RATE,
    io_fbFFHWO := fbFFHWO,
);

ffUnknown(
    i_xOK := bknownState OR fbArbiter.CheckRequestInPool(nReqID:=nTransitionID),
    i_xAutoReset := TRUE,
    i_DevName := sDeviceName,
    i_Desc := &#39;Unknown position between moves&#39;,
    i_TypeCode := E_MotionFFType.NOT_A_STATE,
    io_fbFFHWO := fbFFHWO,
);

ftTripCount(CLK:=ffBeamParamsOk.i_xOK);

IF ftTripCount.Q THEN
    nTripCount := nTripCount + 1;
END_IF

tonTripCount(
    IN:=NOT tonTripCount.Q,
    PT:=tTripReset,
);
IF tonTripCount.Q AND nTripCount &gt; 0 THEN
    nTripCount := nTripCount - 1;
END_IF

// This is required for non-autoresetting FBs to come up in a beam permitted state
ffDebounce.i_xReset S= bFirstCycle;
ffDebounce(
    i_xOK := nTripCount &lt; 5,
    i_xAutoReset := FALSE,
    i_DevName := sDeviceName,
    i_Desc := &#39;Tripped beam parameter mismatch off/on too many times, hold off&#39;,
    i_TypeCode := E_MotionFFType.TOO_MANY_TRIPS,
    io_fbFFHWO := fbFFHWO,
);
ffDebounce.i_xReset R= bFirstCycle;
bFirstCycle := FALSE;

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-miscstateserrorffo-test">
<h2>FB_MiscStatesErrorFFO_Test<a class="headerlink" href="#fb-miscstateserrorffo-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_MiscStatesErrorFFO_Test EXTENDS TcUnit.FB_TestSuite
(*
    Unit tests for FB_MiscStatesErrorFFO
*)
VAR
END_VAR
TestBeamParamsNotOk();
TestZeroRate();
TestUnknownState();
TestTransitionState();
TestDebounce();

END_FUNCTION_BLOCK

METHOD TestBeamParamsNotOk
VAR_INST
    fbMiscFFO: FB_MiscStatesErrorFFO;
    fbArbiter: FB_Arbiter(1);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);

    stBeamReq: ST_BeamParams;
END_VAR
TEST(&#39;TestBeamParamsNotOk&#39;);

fbFFHWO.EvaluateOutput();
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Started with a fault&#39;,
);

// Trigger only a beam parameter mismatch
// Do not trip zero rate, unknown state, or debounce
PMPS_GVL.stCurrentBeamParameters := PMPS_GVL.cstFullBeam;
stBeamReq := PMPS_GVL.cstFullBeam;
stBeamReq.nTran := 0.5;
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=stBeamReq,
    bKnownState:=TRUE,
    nTransitionID:=1,
);

fbFFHWO.EvaluateOutput();
AssertFalse(
    fbFFHWO.q_xFastFaultOut,
    &#39;Did not fault with bad attenuator state&#39;,
);

TEST_FINISHED();
END_METHOD

METHOD TestDebounce
VAR_INST
    fbMiscFFO: FB_MiscStatesErrorFFO;
    fbArbiter: FB_Arbiter(5);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);
END_VAR
VAR
    nIter: DINT;
END_VAR
TEST(&#39;TestDebounce&#39;);

fbFFHWO.EvaluateOutput();
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Started with a fault prior to first FB run-through&#39;,
);
// Ask for full beam: there should be no faults of any kind
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=PMPS_GVL.cstFullBeam,
    bKnownState:=TRUE,
    nTransitionID:=5,
);
fbFFHWO.EvaluateOutput();

AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Started with a fault prior to trip checks&#39;,
);

// Trip and untrip the beam fast fault once, show no fault
TripUntrip(
    fbMiscFFO:=fbMiscFFO,
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
);
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Control group failed: one trip/untrip should not be enough to debounce&#39;,
);
// Trip and untrip the beam fast fault like 10 times, show fault
FOR nIter := 1 TO 10 DO
    TripUntrip(
        fbMiscFFO:=fbMiscFFO,
        fbArbiter:=fbArbiter,
        fbFFHWO:=fbFFHWO,
    );
END_FOR
AssertFalse(
    fbFFHWO.q_xFastFaultOut,
    &#39;Debouncer failed to debounce&#39;,
);

TEST_FINISHED();
END_METHOD

METHOD TestTransitionState
VAR_INST
    fbMiscFFO: FB_MiscStatesErrorFFO;
    fbArbiter: FB_Arbiter(4);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);
END_VAR
TEST(&#39;TestTransitionState&#39;);

fbFFHWO.EvaluateOutput();
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Started with a fault&#39;,
);

// Trigger no faults, we&#39;re at an unknown state but it&#39;s a transition state
// Do not trip bad beam, zero rate, or debounce
fbArbiter.AddRequest(
    nReqID:=4,
    stReqBP:=PMPS_GVL.cstFullBeam,
    sDevName:=&#39;UnitTest&#39;,
);
PMPS_GVL.stCurrentBeamParameters := PMPS_GVL.cstFullBeam;
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=PMPS_GVL.cstFullBeam,
    bKnownState:=FALSE,
    nTransitionID:=4,
);

fbFFHWO.EvaluateOutput();
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Faulted in unknown states even though we were moving normally&#39;,
);

TEST_FINISHED();
END_METHOD

METHOD TestUnknownState
VAR_INST
    fbMiscFFO: FB_MiscStatesErrorFFO;
    fbArbiter: FB_Arbiter(3);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);
END_VAR
TEST(&#39;TestUnknownState&#39;);

fbFFHWO.EvaluateOutput();
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Started with a fault&#39;,
);

// Trigger only an unknown states
// Do not trip bad beam, zero rate, or debounce
PMPS_GVL.stCurrentBeamParameters := PMPS_GVL.cstFullBeam;
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=PMPS_GVL.cstFullBeam,
    bKnownState:=FALSE,
    nTransitionID:=3,
);

fbFFHWO.EvaluateOutput();
AssertFalse(
    fbFFHWO.q_xFastFaultOut,
    &#39;Did not fault with unknown state&#39;,
);

TEST_FINISHED();
END_METHOD

METHOD TestZeroRate
VAR_INST
    fbMiscFFO: FB_MiscStatesErrorFFO;
    fbArbiter: FB_Arbiter(2);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);

    stNoBeam: ST_BeamParams;
END_VAR
TEST(&#39;TestBeamZeroRate&#39;);

fbFFHWO.EvaluateOutput();
AssertTrue(
    fbFFHWO.q_xFastFaultOut,
    &#39;Started with a fault&#39;,
);

// Trigger only a zero rate
// Do not trip beam parameter mismatch, unknown state, or debounce
PMPS_GVL.stCurrentBeamParameters := stNoBeam;
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=PMPS_GVL.cst0RateBeam,
    bKnownState:=TRUE,
    nTransitionID:=2
);

fbFFHWO.EvaluateOutput();
AssertFalse(
    fbFFHWO.q_xFastFaultOut,
    &#39;Did not fault with zero rate&#39;,
);

TEST_FINISHED();
END_METHOD

METHOD TripUntrip
VAR_IN_OUT
    fbMiscFFO: FB_MiscStatesErrorFFO;
    fbArbiter: FB_Arbiter;
    fbFFHWO: FB_HardwareFFOutput;
END_VAR
VAR
    stBeamReq: ST_BeamParams;
END_VAR
// Use anything other than 0 rate, which is its own check
stBeamReq := PMPS_GVL.cstFullBeam;
stBeamReq.nTran := 0.5;
// Trip: too much beam!
PMPS_GVL.stCurrentBeamParameters := PMPS_GVL.cstFullBeam;
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=stBeamReq,
    bKnownState:=TRUE,
    nTransitionID:=5,
);
fbFFHWO.EvaluateOutput();

// Untrip: correct beam!
PMPS_GVL.stCurrentBeamParameters := stBeamReq;
fbMiscFFO(
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stCurrentBeamReq:=stBeamReq,
    bKnownState:=TRUE,
    nTransitionID:=5,
);
fbFFHWO.EvaluateOutput();
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-miscstateserrorffo">FB_MiscStatesErrorFFO</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionbptm">
<h2>FB_MotionBPTM<a class="headerlink" href="#fb-motionbptm" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionBPTM</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">handles</span> <span class="n">the</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">transition</span> <span class="n">manager</span> <span class="k">for</span> <span class="n">a</span> <span class="n">group</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">moving</span> <span class="n">together</span> <span class="n">to</span> <span class="n">a</span> <span class="n">destination</span> <span class="k">with</span> <span class="n">shared</span> <span class="n">beam</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stGoalParams</span> <span class="ow">and</span> <span class="n">stTransParams</span> <span class="n">are</span> <span class="n">required</span> <span class="n">arguments</span> <span class="ow">and</span> <span class="n">must</span> <span class="ow">not</span> <span class="n">share</span> <span class="n">IDs</span> <span class="k">with</span> <span class="n">other</span> <span class="n">state</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>

    <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">building</span> <span class="n">block</span> <span class="ow">not</span> <span class="n">intended</span> <span class="k">for</span> <span class="n">use</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">lcls</span><span class="o">-</span><span class="n">twincat</span><span class="o">-</span><span class="n">motion</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Array</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">that</span> <span class="n">will</span> <span class="n">move</span> <span class="k">for</span> <span class="n">this</span> <span class="n">beam</span> <span class="n">transition</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">states</span> <span class="kn">from</span>
    <span class="nn">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">parameters</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">transition</span> <span class="n">to</span>
    <span class="n">stGoalParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">parameters</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span> <span class="n">during</span> <span class="n">the</span> <span class="n">transition</span>
    <span class="n">stTransParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">we</span><span class="s1">&#39;re actually using</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">use</span> <span class="n">the</span> <span class="n">BPTM</span><span class="p">,</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">stop</span> <span class="n">using</span> <span class="n">the</span> <span class="n">BPTM</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re at the physical state that matches the goal parameters</span>
    <span class="n">bAtState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">device</span> <span class="n">name</span> <span class="n">to</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">GUI</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">How</span> <span class="n">long</span> <span class="n">to</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">parameters</span> <span class="n">before</span> <span class="n">timing</span> <span class="n">out</span>
    <span class="n">tArbiterTimeout</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1s;</span>
    <span class="o">//</span> <span class="n">Whether</span> <span class="n">to</span> <span class="n">fault</span> <span class="ow">and</span> <span class="n">move</span> <span class="n">on</span> <span class="n">timeout</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="ow">or</span> <span class="n">to</span> <span class="n">wait</span> <span class="p">(</span><span class="n">FALSE</span><span class="p">)</span>
    <span class="n">bMoveOnArbiterTimeout</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">safe</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">the</span> <span class="n">BPTM</span> <span class="n">timeout</span> <span class="n">fast</span> <span class="n">fault</span><span class="p">,</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">it</span> <span class="n">early</span><span class="o">.</span>
    <span class="n">bResetBPTMTimeout</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">becomes</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">allowed</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span> <span class="n">their</span> <span class="n">destinations</span><span class="o">.</span>
    <span class="n">bTransitionAuthorized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">This</span> <span class="n">becomes</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">full</span> <span class="n">beam</span> <span class="n">transition</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re using a bad motor count</span>
    <span class="n">bMotorCountError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bptm</span><span class="p">:</span> <span class="n">BeamParameterTransitionManager</span><span class="p">;</span>
    <span class="n">bDoneMoving</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nPrevID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>

    <span class="n">bInternalAuth</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDoneResetQueued</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">tonArbiter</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bArbiterTimeout</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ffBPTMTimeoutAndMove</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">ffBPTMError</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CheckCount</span><span class="p">();</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMotorCountError</span> <span class="n">THEN</span>
    <span class="n">SetDoneMoving</span><span class="p">();</span>
    <span class="n">IF</span> <span class="n">bEnable</span> <span class="n">THEN</span>
        <span class="n">RunBPTM</span><span class="p">();</span>
        <span class="n">HandleTimeout</span><span class="p">();</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">CheckCount</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">valid</span> <span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">,</span> <span class="n">less</span> <span class="ow">or</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">max</span><span class="p">)</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&gt;</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandleTimeout</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Measure</span> <span class="n">the</span> <span class="n">time</span> <span class="n">that</span> <span class="n">the</span> <span class="n">bptm</span> <span class="ow">is</span> <span class="n">busy</span>
<span class="n">tonArbiter</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bptm</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">tArbiterTimeout</span><span class="p">,</span>
    <span class="n">Q</span><span class="o">=&gt;</span><span class="n">bArbiterTimeout</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bTransitionAuthorized</span> <span class="o">:=</span> <span class="n">bInternalAuth</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bArbiterTimeout</span> <span class="n">AND</span> <span class="n">bMoveOnArbiterTimeout</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Trip</span> <span class="n">the</span> <span class="n">beam</span> <span class="k">for</span> <span class="n">BPTM</span> <span class="n">timeouts</span> <span class="k">if</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">move</span>
<span class="o">//</span> <span class="n">Only</span> <span class="n">reset</span> <span class="n">at</span> <span class="n">safe</span> <span class="n">beam</span> <span class="n">OR</span> <span class="n">at</span> <span class="n">no</span> <span class="n">bptm</span> <span class="n">errors</span> <span class="p">(</span><span class="n">some</span> <span class="n">other</span> <span class="n">FF</span> <span class="n">should</span> <span class="n">catch</span> <span class="n">additional</span> <span class="n">issues</span><span class="p">)</span>
<span class="n">ffBPTMTimeoutAndMove</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">bArbiterTimeout</span> <span class="n">AND</span> <span class="n">bMoveOnArbiterTimeout</span><span class="p">);</span>
<span class="n">ffBPTMTimeoutAndMove</span><span class="o">.</span><span class="n">i_xReset</span> <span class="n">S</span><span class="o">=</span> <span class="n">bResetBPTMTimeout</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bptm</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bptm</span><span class="o">.</span><span class="n">bError</span><span class="p">);</span>
<span class="n">ffBPTMTimeoutAndMove</span><span class="p">(</span>
    <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;BPTM Timeout&#39;</span><span class="p">,</span>
    <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">BPTM_TIMEOUT</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">RunBPTM</span><span class="p">:</span>
<span class="n">bptm</span><span class="p">(</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">i_sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">i_TransitionAssertionID</span><span class="o">:=</span><span class="n">stTransParams</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">,</span>
    <span class="n">i_stTransitionAssertion</span><span class="o">:=</span><span class="n">stTransParams</span><span class="o">.</span><span class="n">stBeamParams</span><span class="p">,</span>
    <span class="n">i_nRequestedAssertionID</span><span class="o">:=</span><span class="n">stGoalParams</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">,</span>
    <span class="n">i_stRequestedAssertion</span><span class="o">:=</span><span class="n">stGoalParams</span><span class="o">.</span><span class="n">stBeamParams</span><span class="p">,</span>
    <span class="n">i_xDoneMoving</span><span class="o">:=</span><span class="n">bDoneMoving</span> <span class="n">AND</span> <span class="n">bAtState</span><span class="p">,</span>
    <span class="n">stCurrentBeamParameters</span><span class="o">:=</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="p">,</span>
    <span class="n">q_xTransitionAuthorized</span><span class="o">=&gt;</span><span class="n">bInternalAuth</span><span class="p">,</span>
    <span class="n">bDone</span><span class="o">=&gt;</span><span class="n">bDone</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Trip</span> <span class="n">the</span> <span class="n">beam</span> <span class="k">for</span> <span class="n">BPTM</span> <span class="n">Errors</span>
<span class="n">ffBPTMError</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bptm</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">ffBPTMError</span><span class="o">.</span><span class="n">i_xReset</span> <span class="n">S</span><span class="o">=</span> <span class="n">bptm</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bptm</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">ffBPTMError</span><span class="p">(</span>
    <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;BPTM error, state transition failed&#39;</span><span class="p">,</span>
    <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">BPTM_ERROR</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">SetDoneMoving</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Set</span> <span class="n">bDoneMoving</span> <span class="k">if</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">done</span>
<span class="n">bDoneMoving</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bDoneMoving</span> <span class="o">:=</span> <span class="n">bDoneMoving</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="o">//</span> <span class="n">Reset</span> <span class="n">bDoneMoving</span> <span class="k">if</span> <span class="n">the</span> <span class="n">goal</span> <span class="n">has</span> <span class="n">changed</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">bptm</span><span class="s1">&#39;s motor done for an in-place transition</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">allows</span> <span class="n">us</span> <span class="n">to</span> <span class="n">change</span> <span class="n">to</span> <span class="n">a</span> <span class="n">new</span> <span class="n">beam</span> <span class="n">state</span> <span class="n">without</span> <span class="n">requiring</span> <span class="n">a</span> <span class="n">motor</span> <span class="n">state</span> <span class="n">change</span>
<span class="o">//</span> <span class="n">BPTM</span> <span class="n">only</span> <span class="n">checks</span> <span class="k">for</span> <span class="n">this</span> <span class="s2">&quot;done&quot;</span> <span class="n">transition</span> <span class="n">after</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">has</span> <span class="n">been</span> <span class="n">authorized</span><span class="p">,</span> <span class="n">so</span> <span class="n">we</span> <span class="n">may</span> <span class="n">need</span> <span class="n">to</span> <span class="n">wait</span>
<span class="n">bDoneResetQueued</span> <span class="n">S</span><span class="o">=</span> <span class="n">nPrevID</span> <span class="o">&lt;&gt;</span> <span class="n">stGoalParams</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">;</span>
<span class="n">bDoneMoving</span> <span class="n">R</span><span class="o">=</span> <span class="n">bDoneResetQueued</span> <span class="n">AND</span> <span class="n">bptm</span><span class="o">.</span><span class="n">q_xTransitionAuthorized</span><span class="p">;</span>
<span class="n">bDoneResetQueued</span> <span class="n">R</span><span class="o">=</span> <span class="n">bptm</span><span class="o">.</span><span class="n">q_xTransitionAuthorized</span><span class="p">;</span>
<span class="n">nPrevID</span> <span class="o">:=</span> <span class="n">stGoalParams</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionbptm-test">
<h2>FB_MotionBPTM_Test<a class="headerlink" href="#fb-motionbptm-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_MotionBPTM_Test EXTENDS TcUnit.FB_TestSuite
(*
    Test the functionality of the motion bptm,
    Which is just a bptm wrapped up with a set of n motors.
    We&#39;re basically just making sure that we push the done button at the appropriate time.
    Direct tests of BPTM itself are reserved for the pmps library.

    The BPTM takes care of these executions across multiple cycles,
    so these tests must implement timeouts.
*)
VAR
    astMotionStage: ARRAY[1..MotionConstants.MAX_STATE_MOTORS] OF ST_MotionStage;
    stGoal1: ST_DbStateParams;
    stGoal2: ST_DbStateParams;
    stTrans: ST_DbStateParams;
    stNoBeam: ST_BeamParams;
END_VAR
stGoal1.stBeamParams := PMPS_GVL.cstFullBeam;
stGoal1.nRequestAssertionID := 1;
stGoal1.sPmpsState := &#39;stGoal1&#39;;
stGoal2.stBeamParams := PMPS_GVL.cstFullBeam;
stGoal2.stBeamParams.nTran := 0.5;
stGoal2.nRequestAssertionID := 2;
stGoal2.sPmpsState := &#39;stGoal2&#39;;
stTrans.stBeamParams := PMPS_GVL.cst0RateBeam;
stTrans.nRequestAssertionID := 3;
stTrans.sPmpsState := &#39;stTrans&#39;;

// Just put a blanket global no beam so these won&#39;t wait for any changes ever
PMPS_GVL.stCurrentBeamParameters := stNoBeam;
TestInit();
Test3dMove();
TestNoMove();
TestCount();

END_FUNCTION_BLOCK

METHOD AssertInPool
VAR_IN_OUT
    fbArbiter: FB_Arbiter;
    stDbStateParams: ST_DbStateParams;
END_VAR
VAR_INPUT
    bInPool: BOOL;
    sContext: STRING;
END_VAR
IF bInPool THEN
    AssertTrue(
        fbArbiter.CheckRequestInPool(stDbStateParams.nRequestAssertionID),
        CONCAT(CONCAT(stDbStateParams.sPmpsState, &#39; Beam parameters were not in the pool &#39;), sContext),
    );
ELSE
    AssertFalse(
        fbArbiter.CheckRequestInPool(stDbStateParams.nRequestAssertionID),
        CONCAT(CONCAT(stDbStateParams.sPmpsState, &#39; Beam parameters unexpectedly found in the pool &#39;), sContext),
    );
END_IF
END_METHOD

METHOD SetMotorDone
VAR_INPUT
END_VAR
// Force post-move state
astMotionStage[1].bBusy := FALSE;
astMotionStage[1].bDone := TRUE;
astMotionStage[2].bBusy := FALSE;
astMotionStage[2].bDone := TRUE;
astMotionStage[3].bBusy := FALSE;
astMotionStage[3].bDone := TRUE;
END_METHOD

METHOD SetMotorMoving
VAR_INPUT
END_VAR
// Force a moving but not done state
astMotionStage[1].bBusy := TRUE;
astMotionStage[1].bDone := FALSE;
astMotionStage[2].bBusy := TRUE;
astMotionStage[2].bDone := FALSE;
astMotionStage[3].bBusy := TRUE;
astMotionStage[3].bDone := FALSE;
END_METHOD

METHOD SetMotorStartup
VAR_INPUT
END_VAR
// Force some sort of default looking state
astMotionStage[1].bBusy := FALSE;
astMotionStage[1].bDone := FALSE;
astMotionStage[2].bBusy := FALSE;
astMotionStage[2].bDone := FALSE;
astMotionStage[3].bBusy := FALSE;
astMotionStage[3].bDone := FALSE;
END_METHOD

METHOD Test3dMove : BOOL
(*
    Can we safely do a 3d move?
*)
VAR_INST
    fbBptm: FB_MotionBPTM;
    fbArbiter: FB_Arbiter(2);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);
    fbSubSysIO : FB_DummyArbIO;

    nState: UINT;
    tonTimer: TON;
END_VAR
TEST(&#39;Test3DMove&#39;);

tonTimer(
    IN:=TRUE,
    PT:=T#5s,
);
IF tonTimer.Q THEN
    nState := 4;
END_IF

CASE nState OF
    0:
        // Establish baseline at Goal1
        SetMotorStartup();
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal1,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=TRUE,
            bAtState:=TRUE,
        );
        IF fbBptm.bDone THEN
            nState := 1;
        END_IF
    1:
        // Request a move
        SetMotorStartup();
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal2,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=TRUE,
            bAtState:=FALSE,
        );
        IF fbBptm.bTransitionAuthorized THEN
            // We should have transition and goal 2 asserts in
            AssertInPool(fbArbiter, stGoal1, FALSE, &#39;with trans auth&#39;);
            AssertInPool(fbArbiter, stGoal2, TRUE, &#39;with trans auth&#39;);
            AssertInPool(fbArbiter, stTrans, TRUE, &#39;with trans auth&#39;);
            nState := 2;
        END_IF
    2:
        // Simulate a move
        SetMotorMoving();
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal2,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=TRUE,
            bAtState:=FALSE,
        );
        // Same situation as before
        AssertInPool(fbArbiter, stGoal1, FALSE, &#39;after move started&#39;);
        AssertInPool(fbArbiter, stGoal2, TRUE, &#39;after move started&#39;);
        AssertInPool(fbArbiter, stTrans, TRUE, &#39;after move started&#39;);
        nState := 3;
    3:
        // Move is done
        SetMotorDone();
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal2,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=TRUE,
            bAtState:=TRUE,
        );
        IF fbBptm.bDone THEN
            // Dropped the transition assert
            AssertInPool(fbArbiter, stGoal1, FALSE, &#39;with move complete&#39;);
            AssertInPool(fbArbiter, stGoal2, TRUE, &#39;with move complete&#39;);
            AssertInPool(fbArbiter, stTrans, FALSE, &#39;with move complete&#39;);
            nState := 4;
        END_IF
    4:
        AssertFalse(
            tonTimer.Q,
            &#39;Timeout in test&#39;,
        );
        TEST_FINISHED();
END_CASE

fbSubSysIO(
    LA:=fbArbiter,
    FFO:=fbFFHWO,
);
END_METHOD

METHOD TestCount
(*
    FB Should just error out if we forgot to give a count
*)
VAR_INST
    fbBptm: FB_MotionBPTM;
    fbArbiter: FB_Arbiter(1);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);

    tonWait: TON;
END_VAR
TEST(&#39;TestCount&#39;);

SetMotorStartup();
fbBptm(
    astMotionStage:=astMotionStage,
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stGoalParams:=stGoal1,
    stTransParams:=stTrans,
    bEnable:=True,
    bAtState:=True,
);
AssertTrue(
    fbBptm.bMotorCountError,
    &#39;Did not properly error on missing motor count&#39;,
);

tonWait(
    IN:=TRUE,
    PT:=T#1s,
);
IF tonWait.Q THEN
    // Should have no arbiter activity at all
    AssertInPool(fbArbiter, stGoal1, FALSE, &#39;with bad count&#39;);
    AssertInPool(fbArbiter, stGoal2, FALSE, &#39;with bad count&#39;);
    AssertInPool(fbArbiter, stTrans, FALSE, &#39;with bad count&#39;);

    TEST_FINISHED();
END_IF
END_METHOD

METHOD TestInit : BOOL
(*
    If we initialize with still motors, do we get an arbiter request at the current goal? Hopefully we do.
*)
VAR_INST
    fbBptm: FB_MotionBPTM;
    fbArbiter: FB_Arbiter(1);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);
    fbSubSysIO : FB_DummyArbIO;

    tonTimer: TON;
END_VAR
TEST(&#39;TestInit&#39;);

SetMotorStartup();
fbBptm(
    astMotionStage:=astMotionStage,
    fbArbiter:=fbArbiter,
    fbFFHWO:=fbFFHWO,
    stGoalParams:=stGoal1,
    stTransParams:=stTrans,
    nActiveMotorCount:=3,
    bEnable:=True,
    bAtState:=True,
);
fbSubSysIO(
    LA:=fbArbiter,
    FFO:=fbFFHWO,
);

tonTimer(
    IN:=TRUE,
    PT:=T#5s,
);
IF tonTimer.Q OR fbBptm.bDone THEN
    AssertFalse(
        tonTimer.Q,
        &#39;Timeout in test&#39;,
    );
    // We should have a request in the pool for goal 1 but not for transition
    // If no request are in the pool, we may come up in a no protection state!
    // If both requests are in the pool, we may come up in a too much blocking beam state!
    AssertInPool(fbArbiter, stGoal1, TRUE, &#39;at startup&#39;);
    AssertInPool(fbArbiter, stTrans, FALSE, &#39;at startup&#39;);

    TEST_FINISHED();
END_IF
END_METHOD

METHOD TestNoMove
(*
    In place transitions should work at startup and also at done positions.
*)
VAR_INST
    fbBptm: FB_MotionBPTM;
    fbArbiter: FB_Arbiter(1);
    fbFFHWO: FB_HardwareFFOutput := (bAutoReset := TRUE);
    fbSubSysIO : FB_DummyArbIO;

    nState: UINT;
    tonTimer: TON;
END_VAR
TEST(&#39;TestNoMove&#39;);

tonTimer(
    IN:=TRUE,
    PT:=T#5s,
);
IF tonTimer.Q THEN
    nState := 3;
END_IF

CASE nState OF
    0:
        SetMotorStartup();
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal1,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=True,
            bAtState:=True,
        );
        IF fbBptm.bDone THEN
            nState := 1;
        END_IF
    1:
        SetMotorStartup();
        // NOTE: we kept bAtState TRUE the whole time, so this should be a completed in-place transition
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal2,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=True,
            bAtState:=True,
        );
        IF fbBptm.bDone THEN
            // Only Goal2 should be in the pool
            AssertInPool(fbArbiter, stGoal1, FALSE, &#39;after switching goals (1)&#39;);
            AssertInPool(fbArbiter, stGoal2, TRUE, &#39;after switching goals (1)&#39;);
            AssertInPool(fbArbiter, stTrans, FALSE, &#39;after switching goals (1)&#39;);
            nState := 2;
        END_IF
    2:
        // Repeat from a done position!
        SetMotorDone();
        fbBptm(
            astMotionStage:=astMotionStage,
            fbArbiter:=fbArbiter,
            fbFFHWO:=fbFFHWO,
            stGoalParams:=stGoal1,
            stTransParams:=stTrans,
            nActiveMotorCount:=3,
            bEnable:=True,
            bAtState:=True,
        );
        IF fbBptm.bDone THEN
            // Only Goal1 should be in the pool
            AssertInPool(fbArbiter, stGoal1, TRUE, &#39;after switching goals (2)&#39;);
            AssertInPool(fbArbiter, stGoal2, FALSE, &#39;after switching goals (2)&#39;);
            AssertInPool(fbArbiter, stTrans, FALSE, &#39;after switching goals (2)&#39;);
            nState := 3;
        END_IF
    3:
        AssertFalse(
            tonTimer.Q,
            &#39;Timeout in test&#39;,
        );
        TEST_FINISHED();
END_CASE

fbSubSysIO(
    LA:=fbArbiter,
    FFO:=fbFFHWO,
);
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionbptm">FB_MotionBPTM</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionclearasserts">
<h2>FB_MotionClearAsserts<a class="headerlink" href="#fb-motionclearasserts" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionClearAsserts</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Clear</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">asserts</span> <span class="n">related</span> <span class="n">to</span> <span class="n">a</span> <span class="n">states</span> <span class="n">mover</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">states</span> <span class="n">to</span> <span class="n">deactivate</span><span class="p">:</span> <span class="n">transition</span> <span class="o">+</span> <span class="n">the</span> <span class="n">static</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">astDbStateParams</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">who</span> <span class="n">made</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="k">assert</span> <span class="n">requests</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_ARBITER</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Clear</span> <span class="n">asserts</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
        <span class="n">fbArbiter</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">);</span>
    <span class="n">END_FOR</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-motionclearasserts-test">
<h2>FB_MotionClearAsserts_Test<a class="headerlink" href="#fb-motionclearasserts-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionClearAsserts_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TestBasic</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestBasic</span>
<span class="n">VAR</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbClear</span><span class="p">:</span> <span class="n">FB_MotionClearAsserts</span><span class="p">;</span>
    <span class="n">astDbStateParams</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestBasic&#39;</span><span class="p">);</span>

<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">fbArbiter</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span>
        <span class="n">nReqID</span><span class="o">:=</span><span class="mi">100</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">,</span>
        <span class="n">stReqBP</span><span class="o">:=</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">,</span>
        <span class="n">sDevName</span><span class="o">:=</span><span class="s1">&#39;UnitTest&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="mi">100</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">),</span>
        <span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;State &#39;</span><span class="p">,</span> <span class="n">UDINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">)),</span> <span class="s1">&#39; was not in the pool&#39;</span><span class="p">),</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">fbClear</span><span class="p">(</span>
    <span class="n">astDbStateParams</span><span class="o">:=</span><span class="n">astDbStateParams</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbArbiter</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="mi">100</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">),</span>
        <span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;State &#39;</span><span class="p">,</span> <span class="n">UDINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">)),</span> <span class="s1">&#39; was not cleared from the pool&#39;</span><span class="p">),</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionclearasserts">FB_MotionClearAsserts</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionhoming">
<h2>FB_MotionHoming<a class="headerlink" href="#fb-motionhoming" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionHoming</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbSetPos</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">fbJog</span><span class="p">:</span> <span class="n">MC_Jog</span><span class="p">;</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftExec</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">nHomeStateMachine</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="n">IDLE</span><span class="p">;</span>
    <span class="n">nStateAfterStop</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">nMoves</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bFirstDirection</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bAtHome</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrCount</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bInterrupted</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">IDLE</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">NEXT_MOVE</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">CHECK_FWD</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">CHECK_BWD</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">FINAL_MOVE</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">FINAL_SETPOS</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">ERROR</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">WAIT_STOP</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span>
        <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">simpler</span> <span class="n">way</span> <span class="n">of</span> <span class="n">disabling</span> <span class="n">the</span> <span class="n">soft</span> <span class="n">limits</span> <span class="n">that</span> <span class="n">ends</span> <span class="n">up</span> <span class="n">being</span> <span class="n">really</span> <span class="n">obvious</span> <span class="k">if</span> <span class="n">something</span> <span class="n">has</span> <span class="n">gone</span> <span class="n">wrong</span><span class="o">.</span>
        <span class="n">If</span> <span class="n">you</span> <span class="n">turn</span> <span class="n">the</span> <span class="n">limits</span> <span class="n">off</span><span class="o">/</span><span class="n">on</span><span class="p">,</span> <span class="ow">not</span> <span class="n">only</span> <span class="n">do</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">track</span> <span class="n">of</span> <span class="k">if</span> <span class="n">you</span> <span class="n">had</span> <span class="n">soft</span> <span class="n">limits</span> <span class="nb">set</span><span class="p">,</span>
        <span class="n">but</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">always</span> <span class="n">restore</span> <span class="n">this</span> <span class="n">properly</span> <span class="ow">or</span> <span class="n">risk</span> <span class="n">some</span> <span class="n">issue</span><span class="o">.</span>
        <span class="n">Instead</span><span class="p">,</span> <span class="n">I</span> <span class="nb">set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">a</span> <span class="n">ridiculous</span> <span class="n">value</span> <span class="n">that</span> <span class="n">can</span> <span class="n">always</span> <span class="n">move</span> <span class="n">forward</span> <span class="ow">or</span> <span class="n">backward</span><span class="o">.</span>
        <span class="n">If</span> <span class="n">this</span> <span class="n">gets</span> <span class="n">stuck</span> <span class="k">for</span> <span class="nb">any</span> <span class="n">reason</span> <span class="n">it</span><span class="s1">&#39;s very clear that something has gone wrong,</span>
        <span class="n">rather</span> <span class="n">than</span> <span class="n">a</span> <span class="n">silent</span> <span class="n">failure</span> <span class="n">of</span> <span class="n">the</span> <span class="n">soft</span> <span class="n">limit</span> <span class="n">marks</span><span class="o">.</span>
    <span class="o">*</span><span class="p">)</span>
    <span class="n">FWD_START</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">99999999</span><span class="p">;</span>
    <span class="n">BWD_START</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span>  <span class="mi">99999999</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbSetPos</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">ClearPositionLag</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">ftExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>

<span class="n">bError</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bExecute</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">nErrorID</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nHomingMode</span> <span class="n">OF</span>
    <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">LOW_LIMIT</span><span class="p">:</span>
        <span class="n">bFirstDirection</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bAtHome</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="p">;</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">HIGH_LIMIT</span><span class="p">:</span>
        <span class="n">bFirstDirection</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bAtHome</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span><span class="p">;</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">HOME_VIA_LOW</span><span class="p">:</span>
        <span class="n">bFirstDirection</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bAtHome</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHome</span><span class="p">;</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">HOME_VIA_HIGH</span><span class="p">:</span>
        <span class="n">bFirstDirection</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bAtHome</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHome</span><span class="p">;</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">ABSOLUTE_SET</span><span class="p">:</span>
        <span class="n">fbSetPos</span><span class="p">(</span>
            <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
            <span class="n">Position</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fHomePosition</span><span class="p">);</span>
        <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">NONE</span><span class="p">:</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">bMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">IF</span> <span class="n">bMove</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bBusy</span> <span class="n">AND</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
        <span class="n">bInterrupted</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">CASE</span> <span class="n">nHomeStateMachine</span> <span class="n">OF</span>
        <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">a</span> <span class="n">rising</span> <span class="n">edge</span>
        <span class="n">IDLE</span><span class="p">:</span>
            <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nErrCount</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">fbJog</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
                <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">NEXT_MOVE</span><span class="p">;</span>
                <span class="n">nMoves</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">nErrorID</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">bInterrupted</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="o">//</span> <span class="n">Figure</span> <span class="n">out</span> <span class="n">whether</span> <span class="n">to</span> <span class="n">move</span> <span class="n">forward</span><span class="p">,</span> <span class="n">move</span> <span class="n">backward</span><span class="p">,</span> <span class="ow">or</span> <span class="n">give</span> <span class="n">up</span>
        <span class="n">NEXT_MOVE</span><span class="p">:</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">fbJog</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">CASE</span> <span class="n">nMoves</span> <span class="n">OF</span>
                <span class="mi">0</span><span class="p">:</span>
                    <span class="n">IF</span> <span class="n">bFirstDirection</span> <span class="n">THEN</span>
                        <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">CHECK_FWD</span><span class="p">;</span>
                    <span class="n">ELSE</span>
                        <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">CHECK_BWD</span><span class="p">;</span>
                    <span class="n">END_IF</span>
                <span class="mi">1</span><span class="p">:</span>
                    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bFirstDirection</span> <span class="n">THEN</span>
                        <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">CHECK_FWD</span><span class="p">;</span>
                    <span class="n">ELSE</span>
                        <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">CHECK_BWD</span><span class="p">;</span>
                    <span class="n">END_IF</span>
                <span class="n">ELSE</span>
                    <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
            <span class="n">END_CASE</span>
            <span class="n">nMoves</span> <span class="o">:=</span> <span class="n">nMoves</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">bAtHome</span> <span class="n">THEN</span>
                <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">FINAL_MOVE</span><span class="p">;</span>
            <span class="n">END_IF</span>
            <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">WAIT_STOP</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">Move</span> <span class="n">forward</span> <span class="n">until</span> <span class="n">we</span> <span class="n">find</span> <span class="n">the</span> <span class="n">home</span> <span class="n">signal</span> <span class="ow">or</span> <span class="n">reach</span> <span class="n">end</span> <span class="n">of</span> <span class="n">travel</span>
        <span class="n">CHECK_FWD</span><span class="p">:</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
                <span class="n">Position</span><span class="o">:=</span><span class="n">FWD_START</span><span class="p">);</span>
            <span class="n">fbJog</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">JogForward</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bATHome</span><span class="p">,</span>
                <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                <span class="n">Mode</span><span class="o">:=</span><span class="n">E_JogMode</span><span class="o">.</span><span class="n">MC_JOGMODE_CONTINOUS</span><span class="p">,</span>
                <span class="n">Velocity</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fRefVeloSearch</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">JogForward</span> <span class="n">THEN</span>
                <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">NEXT_MOVE</span><span class="p">;</span>
            <span class="n">ELSIF</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
                <span class="n">fbJog</span><span class="p">(</span>
                    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                    <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                    <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                <span class="n">nErrCount</span> <span class="o">:=</span> <span class="n">nErrCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">IF</span> <span class="n">nErrCount</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="n">THEN</span>
                    <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
                <span class="n">END_IF</span>
            <span class="n">END_IF</span>
        <span class="o">//</span> <span class="n">Move</span> <span class="n">backward</span> <span class="n">until</span> <span class="n">we</span> <span class="n">find</span> <span class="n">the</span> <span class="n">home</span> <span class="n">signal</span> <span class="ow">or</span> <span class="n">reach</span> <span class="n">end</span> <span class="n">of</span> <span class="n">travel</span>
        <span class="n">CHECK_BWD</span><span class="p">:</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
                <span class="n">Position</span><span class="o">:=</span><span class="n">BWD_START</span><span class="p">);</span>
            <span class="n">fbJog</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bATHome</span><span class="p">,</span>
                <span class="n">Mode</span><span class="o">:=</span><span class="n">E_JogMode</span><span class="o">.</span><span class="n">MC_JOGMODE_CONTINOUS</span><span class="p">,</span>
                <span class="n">Velocity</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fRefVeloSearch</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">JogBackwards</span> <span class="n">THEN</span>
                <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">NEXT_MOVE</span><span class="p">;</span>
            <span class="n">ELSIF</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
                <span class="n">fbJog</span><span class="p">(</span>
                    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                    <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                    <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                <span class="n">nErrCount</span> <span class="o">:=</span> <span class="n">nErrCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">IF</span> <span class="n">nErrCount</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="n">THEN</span>
                    <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
                <span class="n">END_IF</span>
            <span class="n">END_IF</span>
        <span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">get</span> <span class="n">within</span> <span class="n">soft</span> <span class="n">lims</span><span class="p">,</span> <span class="n">move</span> <span class="n">slowly</span> <span class="n">off</span> <span class="n">signal</span>
        <span class="n">FINAL_MOVE</span><span class="p">:</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
                <span class="n">Position</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fHomePosition</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">bAtHome</span> <span class="n">THEN</span>
                <span class="n">fbJog</span><span class="p">(</span>
                    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                    <span class="n">JogForward</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bFirstDirection</span><span class="p">,</span>
                    <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">bFirstDirection</span><span class="p">,</span>
                    <span class="n">Mode</span><span class="o">:=</span><span class="n">E_JogMode</span><span class="o">.</span><span class="n">MC_JOGMODE_CONTINOUS</span><span class="p">,</span>
                    <span class="n">Velocity</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fRefVeloSync</span><span class="p">);</span>
            <span class="n">ELSIF</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
                <span class="n">fbJog</span><span class="p">(</span>
                    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                    <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                    <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                <span class="n">nErrCount</span> <span class="o">:=</span> <span class="n">nErrCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">IF</span> <span class="n">nErrCount</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="n">THEN</span>
                    <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
                <span class="n">END_IF</span>
            <span class="n">ELSE</span>
                <span class="n">fbJog</span><span class="p">(</span>
                    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                    <span class="n">JogForward</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
                    <span class="n">JogBackwards</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                <span class="n">fbSetPos</span><span class="p">(</span>
                    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                    <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">WAIT_STOP</span><span class="p">;</span>
                <span class="n">nStateAfterStop</span> <span class="o">:=</span> <span class="n">FINAL_SETPOS</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">FINAL_SETPOS</span><span class="p">:</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
                <span class="n">Position</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fHomePosition</span><span class="p">);</span>
            <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">IDLE</span><span class="p">;</span>
            <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">ERROR</span><span class="p">:</span>
            <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">nErrorID</span> <span class="o">:=</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
            <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">FINAL_SETPOS</span><span class="p">;</span>
            <span class="n">fbSetPos</span><span class="p">(</span>
                <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                <span class="n">Execute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">bInterrupted</span> <span class="n">THEN</span>
                <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Homing interrupted&#39;</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Homing failure&#39;</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">WAIT_STOP</span><span class="p">:</span>
            <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">THEN</span>
                <span class="n">nHomeStateMachine</span> <span class="o">:=</span> <span class="n">nStateAfterStop</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">END_CASE</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionpneumaticactuator">
<h2>FB_MotionPneumaticActuator<a class="headerlink" href="#fb-motionpneumaticactuator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(*This function blcok implements a pnuematic actuator. That can be signle or double acting by setting the ibSingleCntrl accordingly*)
(* with double acting ibCntrlHold signal should be false, while with single acting the signal should be true*)
FUNCTION_BLOCK FB_MotionPneumaticActuator
VAR_INPUT
    (*EPS Interlock Bits*)
    ibInsertOK: BOOL; (*Actuator can be Inserted*)
    ibRetractOK: BOOL; (*ACtuator can be retracted*)
    ibPMPS_OK:BOOL; (*to be linked the Arbiter bit*)
    ibSingleCntrl:BOOL;(* TRUE if Actuator requires one Output signal to be activated, FALSE if its double acting i.e two outputs are required*)
    ibCntrlHold:BOOL; (* Control Signal must retain its value, must be TRUE in the case of single acting*)
    ibOverrideInterlock:BOOL; (*if true interlocks are ignored*)
    // Reset fault
    {attribute &#39;pytmc&#39; := &#39;
    pv: FFO_Reset
    &#39;}
    i_xReset: BOOL;
    {attribute &#39;pytmc&#39; := &#39;
    pv: FFO_AutoReset
    &#39;}
    i_xAutoReset: BOOL;
END_VAR
VAR_OUTPUT
    {attribute &#39;pytmc&#39; := &#39;
    pv:
    &#39;}
    stPneumaticActuator    :    ST_MotionPneumaticActuator;
    {attribute &#39;pytmc&#39; := &#39;
     pv: MPS_OK
     field: ZNAM FALSE
     field: ONAM TRUE
     field: DESC TRUE if MPS signal is OK
    &#39;}
    xMPS_OK:BOOL;
END_VAR
VAR_IN_OUT
    io_fbFFHWO    :    FB_HardwareFFOutput;
END_VAR
VAR
    // PMPS
    fbFF    :    FB_FastFault :=(
        i_DevName := &#39;MPA&#39;,
        i_Desc := &#39;Fault occurs when the device is moving&#39;,
        i_TypeCode := E_MotionFFType.PNEUMATIC_MOVE);

    (*Init*)
    xFirstPass    :    BOOL;
    fbFSInit        :    R_TRIG;

    (* Timeouts*)
    tTimeOutDuration: TIME:= T#10S;
    tInserttimeout: TON;
    tRetracttimeout:TON;
    (*Limit switch latch timer*)
    tLimitSwitchLatchDuration: TIME:=T#1S;
    tInsertLimitSwitch:TON;
    tRetractLimitSwitch:TON;

    (*Logging*)
    fbLogger : FB_LogMessage := (eSubsystem:=E_SubSystem.MOTION);
    ePrevState : E_PnuematicActuatorPositionState;
    tAction : R_TRIG; // Primary action of this device (Insert_DO, Retract_DO, etc.)
    tOverrideActivated : R_TRIG;

    (*IO*)
    i_xInsertedLS    AT%I*: BOOL;
    i_xRetractedLS    AT%I*: BOOL;
    q_xInsert_DO    AT%Q*: BOOL;
    q_xRetract_DO    AT%Q*: BOOL;

END_VAR
(*Initialize*)
fbFSInit( CLK := TRUE, Q =&gt; xFirstPass);
IF xFirstPass THEN
    stPneumaticActuator.eState := E_PnuematicActuatorPositionState.INVALID;
    stPneumaticActuator.bRetract_SW := FALSE;
    stPneumaticActuator.bInsert_SW := FALSE;
END_IF

(*Soft IO Mapping to EPICS PVs*)
ACT_IO();

(* Manage States*)
IF stPneumaticActuator.i_bInLimitSwitch AND  stPneumaticActuator.i_bOutLimitSwitch THEN
    stPneumaticActuator.eState:=E_PnuematicActuatorPositionState.INVALID;
ELSIF NOT stPneumaticActuator.i_bInLimitSwitch AND stPneumaticActuator.i_bOutLimitSwitch THEN
    stPneumaticActuator.eState:=E_PnuematicActuatorPositionState.RETRACTED;
ELSIF stPneumaticActuator.i_bInLimitSwitch AND NOT stPneumaticActuator.i_bOutLimitSwitch THEN
    stPneumaticActuator.eState:=E_PnuematicActuatorPositionState.INSERTED;
ELSIF NOT stPneumaticActuator.i_bInLimitSwitch AND NOT stPneumaticActuator.i_bOutLimitSwitch THEN
    stPneumaticActuator.eState:=E_PnuematicActuatorPositionState.MOVING;
ELSE
    stPneumaticActuator.eState:=E_PnuematicActuatorPositionState.INVALID ;
END_IF

(*Set the Done/Busy signal*)
stPneumaticActuator.bDone := (stPneumaticActuator.bRetract_SW AND stPneumaticActuator.eState=E_PnuematicActuatorPositionState.RETRACTED)
                            OR (stPneumaticActuator.bInsert_SW AND stPneumaticActuator.eState=E_PnuematicActuatorPositionState.INSERTED);
stPneumaticActuator.bBusy := (stPneumaticActuator.bRetract_SW AND stPneumaticActuator.eState&lt;&gt;E_PnuematicActuatorPositionState.RETRACTED)
                            OR (stPneumaticActuator.bInsert_SW AND stPneumaticActuator.eState&lt;&gt;E_PnuematicActuatorPositionState.INSERTED);
(*MPS FAULT*)
(* MPS Faults when the actuator is in motion*)
xMPS_OK := (stPneumaticActuator.eState=E_PnuematicActuatorPositionState.RETRACTED) OR (stPneumaticActuator.eState=E_PnuematicActuatorPositionState.INSERTED);
(*PMPS PERMISSION*)
// yet to be implemented

(* Can&#39;t have bRetract_SW and  bInsert_SW both be true*)
If (stPneumaticActuator.bRetract_SW) AND (stPneumaticActuator.bInsert_SW) THEN
    stPneumaticActuator.bRetract_SW := FALSE;
    stPneumaticActuator.bInsert_SW := FALSE;
END_IF
//Redundant??
(*Check if both digital outputs active at the same time, and clear all*)
IF stPneumaticActuator.q_bInsert THEN
    stPneumaticActuator.q_bRetract := FALSE;
    stPneumaticActuator.bRetract_SW:= FALSE;
END_IF;
IF stPneumaticActuator.q_bRetract THEN
    stPneumaticActuator.q_bInsert := FALSE;
    stPneumaticActuator.bInsert_SW:= FALSE;
END_IF;

(*Actuate the device*)
stPneumaticActuator.q_bRetract := stPneumaticActuator.bRetractOK AND stPneumaticActuator.bRetract_SW AND NOT stPneumaticActuator.bInsert_SW ;
stPneumaticActuator.q_bInsert := stPneumaticActuator.bInsertOK AND stPneumaticActuator.bInsert_SW AND NOT stPneumaticActuator.bRetract_SW ;

(*Reset the Control signal when command has been executed and give time to ensure the actuator is fully seated in either direction*)
IF (NOT ibSingleCntrl AND NOT ibCntrlHold) THEN
   IF (stPneumaticActuator.bRetract_SW AND stPneumaticActuator.i_bOutLimitSwitch AND tRetractLimitSwitch.Q ) THEN stPneumaticActuator.q_bRetract := FALSE; END_IF
   IF (stPneumaticActuator.bInsert_SW AND stPneumaticActuator.i_bInLimitSwitch AND tInsertLimitSwitch.Q) THEN stPneumaticActuator.q_bInsert := FALSE; END_IF
END_IF

(*Timers*)
tInserttimeout(IN:= stPneumaticActuator.q_bInsert, PT := tTimeOutDuration );
tRetracttimeout(IN:= stPneumaticActuator.q_bRetract, PT := tTimeOutDuration);
tInsertLimitSwitch(IN:= stPneumaticActuator.i_bInLimitSwitch, PT := tLimitSwitchLatchDuration);
tRetractLimitSwitch(IN:= stPneumaticActuator.i_bOutLimitSwitch, PT := tLimitSwitchLatchDuration);


///Check moving postion timout
IF NOT stPneumaticActuator.i_bInLimitSwitch AND tInserttimeout.Q THEN
    stPneumaticActuator.bError := TRUE;
    stPneumaticActuator.sErrorMessage:= &#39;Actuator insert timeout&#39;;
ELSIF NOT stPneumaticActuator.i_bOutLimitSwitch AND tRetracttimeout.Q THEN
    stPneumaticActuator.bError := TRUE;
    stPneumaticActuator.sErrorMessage:= &#39;Actuator retract timeout&#39;;
END_IF
// Reset error
stPneumaticActuator.bError R= stPneumaticActuator.bReset;

(*FAST FAULT*)
fbFF(i_xOK := xMPS_OK,
    i_xReset := i_xReset,
    i_xAutoReset := i_xAutoReset,
    io_fbFFHWO := io_fbFFHWO);

(*Soft IO Mapping to Epics pvs*)
ACT_IO();

END_FUNCTION_BLOCK

ACTION ACT_IO:
(*Inputs*)
stPneumaticActuator.i_bInLimitSwitch :=  i_xInsertedLS;
stPneumaticActuator.i_bOutLimitSwitch := i_xRetractedLS;

(*outputs*)
q_xInsert_DO:=stPneumaticActuator.q_bInsert;
q_xRetract_DO:=stPneumaticActuator.q_bRetract;

(*EPICS*)
stPneumaticActuator.bRetractOK := ibRetractOK;
stPneumaticActuator.bInsertOK := ibInsertOK;
END_ACTION

ACTION ACT_Logger:
// Log Valve timeouts
IF (tInserttimeout.Q OR tRetracttimeout.Q) THEN fbLogger(sMsg:=stPneumaticActuator.sErrorMessage, eSevr:=TcEventSeverity.Warning); END_IF

// Log Actuator commands
// Log valve open
tAction(CLK:= (stPneumaticActuator.q_bRetract OR stPneumaticActuator.q_bInsert));
IF tAction.Q THEN
   IF(stPneumaticActuator.q_bRetract) THEN fbLogger(sMsg:=&#39;Actuator commanded retract&#39;, eSevr:=TcEventSeverity.Info); END_IF
   IF(stPneumaticActuator.q_bInsert) THEN fbLogger(sMsg:=&#39;Actuator commanded insert&#39;, eSevr:=TcEventSeverity.Info); END_IF
END_IF


// State Logging
IF ePrevState &lt;&gt; stPneumaticActuator.eState THEN
      CASE stPneumaticActuator.eState OF
        E_PnuematicActuatorPositionState.INVALID:
            fbLogger(sMsg:=&#39;Actuator invalid position.&#39;, eSevr:=TcEventSeverity.Critical);
          E_PnuematicActuatorPositionState.MOVING:
            fbLogger(sMsg:=&#39;Actuator moving&#39;, eSevr:=TcEventSeverity.Warning);
        E_PnuematicActuatorPositionState.RETRACTED:
            fbLogger(sMsg:=&#39;Actuator Retracted.&#39;, eSevr:=TcEventSeverity.Info);
        E_PnuematicActuatorPositionState.INSERTED:
            fbLogger(sMsg:=&#39;Actuator Inserted.&#39;, eSevr:=TcEventSeverity.Info);
      END_CASE
      ePrevState := stPneumaticActuator.eState;
  END_IF
END_ACTION
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#e-pnuematicactuatorpositionstate">E_PnuematicActuatorPositionState</a></p></li>
<li><p><a class="reference internal" href="#st-motionpneumaticactuator">ST_MotionPneumaticActuator</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionreadpmpsdbnd">
<h2>FB_MotionReadPMPSDBND<a class="headerlink" href="#fb-motionreadpmpsdbnd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_MotionReadPMPSDBND
(*
    When we read the JSON PMPS database file, update the lookup parameters for one state mover.
    It is a building block not meant for use outside of lcls-twincat-motion.

    This is intended to support one N-dimensional state motion function block.
    The keys for the database lookup can be set on any of the motor&#39;s position states.
    Each of them have an allocated state.stPMPS.sPmpsState STRING parameter.
    If there is a conflict and two of the motors disagree on parameter lookups, that will
    be a fast fault.

    When the global JSON read function block is no longer busy and has no errors,
    we will assume that the file has been read and we will update the parameters here.

    This will also re-read in the event that the input position state keys change in any way,
    provided that we&#39;ve read once before.
*)
VAR_IN_OUT
    // Each motor&#39;s respective position states along its direction. These will not be modified.
    astPositionState: ARRAY[1..MotionConstants.MAX_STATE_MOTORS] OF ARRAY[1..GeneralConstants.MAX_STATES] OF ST_PositionState;
    // Hardware output to fault to if there is a problem.
    fbFFHWO: FB_HardwareFFOutput;
END_VAR
VAR_INPUT
    // The database lookup key for the transition state. This has no corresponding ST_PositionState.
    sTransitionKey: STRING;
    // A name to use for fast faults, etc.
    sDeviceName: STRING;
    // For debug: set this to TRUE in online mode to read the database immediately.
    bReadNow: BOOL;
END_VAR
VAR_OUTPUT
    // The raw lookup results from this FB. Index 0 is the transition beam, the rest of the indices match the state positions.
    astDbStateParams: ARRAY[0..GeneralConstants.MAX_STATES] OF ST_DbStateParams;
    // TRUE if we&#39;ve had at least one successful read.
    bFirstReadDone: BOOL;
    // This will be set to TRUE if there was an error reading from the database.
    bError: BOOL;
END_VAR
VAR
    ffError: FB_FastFault;
    fbReadPmpsDb: FB_JsonDocToSafeBP;
    ftDbBusy: F_TRIG;
    ftRead: F_TRIG;
    bReadPmpsDb: BOOL;
    nIterMotor: DINT;
    nIterState: DINT;
    nIterState2: DINT;
    sLoopNewKey: STRING;
    sLoopPrevKey: STRING;
    abStateError: ARRAY[0..GeneralConstants.MAX_STATES] OF BOOL;
    asLookupKeys: ARRAY[0..GeneralConstants.MAX_STATES] OF STRING;
    asPrevLookupKeys: ARRAY[0..GeneralConstants.MAX_STATES] OF STRING;
    bNewKeys: BOOL;
    sTempBackfill: STRING;
END_VAR
SelectLookupKeys();
ReadDatabase();
RunFastFaults();
BackfillInfo();

END_FUNCTION_BLOCK

ACTION BackfillInfo:
// Put the results of the PMPS lookup back to the motion states
// This is purely for debugging purposes, as only the astDbStateParams output is used by the libraries.

// Copy everything except for the lookup key: avoid clobbering the user&#39;s original keys
// Do it this way instead of one element at a time to be forwards-compatible with any future additions to the db struct
FOR nIterState := 1 TO GeneralConstants.MAX_STATES DO
    FOR nIterMotor := 1 TO MotionConstants.MAX_STATE_MOTORS DO
        sTempBackfill := astPositionState[nIterMotor][nIterState].stPMPS.sPmpsState;
        astPositionState[nIterMotor][nIterState].stPMPS := astDbStateParams[nIterState];
        astPositionState[nIterMotor][nIterState].stPMPS.sPmpsState := sTempBackfill;
    END_FOR
END_FOR
END_ACTION

ACTION ReadDatabase:
// Read the database at the right timing
ftDbBusy(CLK:=MOTION_GVL.fbPmpsFileReader.bBusy);
IF ftDbBusy.Q THEN
    bReadPmpsDb S= NOT MOTION_GVL.fbPmpsFileReader.bError;
END_IF

bReadPmpsDb S= bFirstReadDone AND bNewKeys;
bReadPmpsDb S= bReadNow;
bReadNow := FALSE;

fbReadPmpsDb(
    bExecute:=bReadPmpsDb,
    jsonDoc:=PMPS_GVL.BP_jsonDoc,
    sDeviceName:=sDeviceName,
    io_fbFFHWO:=fbFFHWO,
    arrStates:=astDbStateParams,
);
bReadPmpsDb R= NOT fbReadPmpsDb.bBusy;

ftRead(CLK:=fbReadPmpsDb.bBusy);
bFirstReadDone S= ftRead.Q AND NOT fbReadPmpsDb.bError;
END_ACTION

ACTION RunFastFaults:
ffError(
    i_xOK:=NOT bError,
    i_xAutoReset:=TRUE,
    i_DevName:=sDeviceName,
    i_Desc:=&#39;Programmer error selecting state names in ND motion FB&#39;,
    i_TypeCode:=E_MotionFFType.INTERNAL_ERROR,
    io_fbFFHWO:=fbFFHWO,
);
END_ACTION

ACTION SelectLookupKeys:
// Fill the lookup key information in astDbStateParams based on the strings from astPositionState and sTransitionKey.

// Start by emptying any pre-existing values
FOR nIterState := 0 TO GeneralConstants.MAX_STATES DO
    asLookupKeys[nIterState] := &#39;&#39;;
    abStateError[nIterState] := FALSE;
END_FOR

// Transition key is simple
asLookupKeys[0] := sTransitionKey;

// The other keys might be at different points in the astPositionState array.
// Try all of the posibilities, set error if we end up overwriting something.

// Outer loop: index of each motor at this position state
FOR nIterMotor := 1 TO MotionConstants.MAX_STATE_MOTORS DO
    // Inner loop: index of each position state for this motor
    FOR nIterState := 1 TO GeneralConstants.MAX_STATES DO
        sLoopNewKey := astPositionState[nIterMotor][nIterState].stPMPS.sPmpsState;
        IF sLoopNewKey &lt;&gt; &#39;&#39; THEN
            // We have a new key, start doing things
            sLoopPrevKey := asLookupKeys[nIterState];
            IF sLoopPrevKey = &#39;&#39; OR sLoopPrevKey = sLoopNewKey THEN
                // No key yet, or exactly the same key (redudant programmer)
                asLookupKeys[nIterState] := sLoopNewKey;
            ELSE
                // We already had a different key! Don&#39;t just override it, have an error!
                bError := TRUE;
                abStateError[nIterState] := TRUE;
            END_IF
        END_IF
    END_FOR
END_FOR

// Check for duplicated sPmpsState strings
FOR nIterState := 0 TO GeneralConstants.MAX_STATES DO
    FOR nIterState2 := 0 TO nIterState DO
        IF nIterState &lt;&gt; nIterState2 THEN
            IF asLookupKeys[nIterState] = asLookupKeys[nIterState2] THEN
                // Duplicated key, we need an error and a flag in both spots
                bError := TRUE;
                abStateError[nIterState] := TRUE;
                abStateError[nIterState2] := TRUE;
            END_IF
        END_IF
    END_FOR
END_FOR

// Clear the erroneous states so they won&#39;t be used as lookups
IF bError THEN
    FOR nIterState := 0 TO GeneralConstants.MAX_STATES DO
        IF abStateError[nIterState] THEN
            asLookupKeys[nIterState] := &#39;&#39;;
        END_IF
    END_FOR
END_IF

// Copy the keys into the db state params
FOR nIterState := 0 TO GeneralConstants.MAX_STATES DO
    astDbStateParams[nIterState].sPmpsState := asLookupKeys[nIterState];
END_FOR

// Check if the keys changed from prev cycle
bNewKeys := FALSE;
FOR nIterState := 0 TO GeneralConstants.MAX_STATES DO
    IF asLookupKeys[nIterState] &lt;&gt; asPrevLookupKeys[nIterState] THEN
        bNewKeys := TRUE;
        EXIT;
    END_IF
END_FOR

// Save prev keys for next cycle
asPrevLookupKeys := asLookupKeys;
END_ACTION
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionreadpmpsdbnd-test">
<h2>FB_MotionReadPMPSDBND_Test<a class="headerlink" href="#fb-motionreadpmpsdbnd-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionReadPMPSDBND_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">We</span> <span class="n">test</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">db</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">pmps</span> <span class="n">lib</span>
    <span class="n">Here</span><span class="p">,</span> <span class="n">we</span> <span class="n">test</span> <span class="n">that</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">keys</span> <span class="n">are</span> <span class="n">ready</span> <span class="k">for</span> <span class="n">the</span> <span class="n">read</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">inputs</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">user</span> <span class="n">submits</span> <span class="n">a</span> <span class="n">transition</span> <span class="n">key</span> <span class="ow">and</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">their</span> <span class="n">ST_PositionState</span> <span class="n">instances</span> <span class="kn">from</span> <span class="nn">all</span> <span class="n">of</span> <span class="n">their</span> <span class="n">motors</span><span class="o">.</span>
    <span class="n">Any</span> <span class="n">subset</span> <span class="n">of</span> <span class="n">these</span> <span class="n">instances</span> <span class="n">can</span> <span class="n">have</span> <span class="n">lookup</span> <span class="n">keys</span><span class="o">.</span>

    <span class="n">If</span> <span class="n">only</span> <span class="n">one</span> <span class="n">state</span> <span class="n">at</span> <span class="n">the</span> <span class="n">index</span> <span class="n">has</span> <span class="n">a</span> <span class="n">lookup</span> <span class="n">key</span><span class="p">,</span> <span class="n">use</span> <span class="n">that</span> <span class="n">key</span><span class="o">.</span>
    <span class="n">If</span> <span class="n">more</span> <span class="n">than</span> <span class="n">one</span> <span class="n">state</span> <span class="n">at</span> <span class="n">the</span> <span class="n">index</span> <span class="n">has</span> <span class="n">the</span> <span class="n">same</span> <span class="n">lookup</span> <span class="n">key</span><span class="p">,</span> <span class="n">use</span> <span class="n">that</span> <span class="n">key</span><span class="o">.</span>
    <span class="n">If</span> <span class="n">states</span> <span class="n">at</span> <span class="n">the</span> <span class="n">same</span> <span class="n">index</span> <span class="n">have</span> <span class="n">different</span> <span class="n">keys</span><span class="p">,</span> <span class="n">that</span><span class="s1">&#39;s an error and a fast fault.</span>
    <span class="n">If</span> <span class="n">states</span> <span class="n">at</span> <span class="n">different</span> <span class="n">indices</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">keys</span><span class="p">,</span> <span class="n">that</span><span class="s1">&#39;s an error and a fast fault.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">astCorrectStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astNonsenseStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astDuplicatedStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Set</span> <span class="n">up</span> <span class="n">the</span> <span class="n">state</span> <span class="n">arrays</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">test</span> <span class="n">methods</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">astCorrectStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">));</span>
    <span class="n">astNonsenseStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;asdf&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">));</span>
    <span class="n">IF</span> <span class="n">UINT_TO_BOOL</span><span class="p">(</span><span class="n">nIter</span> <span class="n">MOD</span> <span class="mi">2</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">astDuplicatedStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="s1">&#39;State0&#39;</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">astDuplicatedStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="s1">&#39;State1&#39;</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_FOR</span>

<span class="n">TestSolo</span><span class="p">();</span>
<span class="n">TestTrio</span><span class="p">();</span>
<span class="n">TestNonsense</span><span class="p">();</span>
<span class="n">TestDupe</span><span class="p">();</span>
<span class="n">TestBackfill</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestBackfill</span>
<span class="n">VAR_INST</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">stDefaultBP</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestBackfill&#39;</span><span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astCorrectStates</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Pick</span> <span class="n">a</span> <span class="n">few</span> <span class="n">parameters</span> <span class="n">to</span> <span class="n">drop</span> <span class="ow">in</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nRate</span> <span class="o">:=</span> <span class="mi">999</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">777</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">bBeamParamsLoaded</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">stDefaultBP</span><span class="o">.</span><span class="n">bBeamParamsLoaded</span><span class="p">;</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestBackfill&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">Everything</span> <span class="n">should</span> <span class="n">be</span> <span class="n">cleared</span> <span class="n">to</span> <span class="n">the</span> <span class="n">defaults</span><span class="p">:</span> <span class="n">the</span> <span class="n">library</span> <span class="n">should</span> <span class="n">let</span> <span class="n">us</span> <span class="n">know</span> <span class="n">what</span> <span class="n">params</span> <span class="n">got</span> <span class="n">loaded</span> <span class="p">(</span><span class="n">none</span><span class="p">)</span>
<span class="n">AssertEquals_UDINT</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">stDefaultBP</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nRate</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nRate</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;nRate of motor 1 state 3 not backfilled&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_UDINT</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">stDefaultBP</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;nRequestAssertionID of motor 2 state 3 not backfilled&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">stDefaultBP</span><span class="o">.</span><span class="n">bBeamParamsLoaded</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">bBeamParamsLoaded</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;bBeamParamsLoaded of motor 3 state 2 not backfilled&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestDupe</span>
<span class="n">VAR_INST</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestDupe&#39;</span><span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astDuplicatedStates</span><span class="p">;</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestTrio&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbRead</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Should have had an error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">AssertEquals_STRING</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Errored output should have had no state names&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestNonsense</span>
<span class="n">VAR_INST</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestNonsense&#39;</span><span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astCorrectStates</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astNonsenseStates</span><span class="p">;</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestTrio&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbRead</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Should have had an error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">Only</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="n">should</span> <span class="n">be</span> <span class="n">spared</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">nonsense</span>
<span class="n">AssertEquals_STRING</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Transition state should be OK&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">AssertEquals_STRING</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Errored output should have had no state names&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestSolo</span>
<span class="n">VAR_INST</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestSolo&#39;</span><span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astCorrectStates</span><span class="p">;</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestSolo&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbRead</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Had an error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_STRING</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Output did not have the correct transition state&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">AssertEquals_STRING</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astCorrectStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Output did not have the correct position state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestTrio</span>
<span class="n">VAR_INST</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestTrio&#39;</span><span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astCorrectStates</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astCorrectStates</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astCorrectStates</span><span class="p">;</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;State0&#39;</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestTrio&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbRead</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Had an error&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_STRING</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Output did not have the correct transition state&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">AssertEquals_STRING</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astCorrectStates</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Output did not have the correct position state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionreadpmpsdbnd">FB_MotionReadPMPSDBND</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionrequest">
<h2>FB_MotionRequest<a class="headerlink" href="#fb-motionrequest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionRequest</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Request</span> <span class="n">a</span> <span class="n">move</span> <span class="kn">from</span> <span class="nn">an</span> <span class="n">axis</span> <span class="n">controlled</span> <span class="n">via</span> <span class="n">EPICS</span> <span class="n">using</span> <span class="n">FB_MotionStage</span>
    <span class="n">This</span> <span class="n">exists</span> <span class="n">to</span> <span class="n">manage</span> <span class="n">situations</span> <span class="n">where</span> <span class="n">different</span> <span class="n">bits</span> <span class="n">of</span> <span class="n">code</span> <span class="n">may</span> <span class="n">need</span> <span class="n">to</span> <span class="n">move</span> <span class="n">the</span> <span class="n">same</span> <span class="n">motor</span><span class="o">.</span>
    <span class="n">With</span> <span class="n">just</span> <span class="n">the</span> <span class="n">ST_MotionStage</span><span class="o">/</span><span class="n">FB_MotionStage</span> <span class="n">setup</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">possible</span> <span class="k">for</span> <span class="n">two</span> <span class="n">function</span> <span class="n">blocks</span> <span class="n">to</span>
    <span class="n">fight</span> <span class="k">with</span> <span class="ow">and</span> <span class="n">interfere</span> <span class="k">with</span> <span class="n">each</span> <span class="n">other</span> <span class="ow">and</span> <span class="k">with</span> <span class="n">the</span> <span class="n">EPICS</span> <span class="n">commands</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">move</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">stop</span> <span class="n">move</span> <span class="n">on</span> <span class="n">falling</span> <span class="n">edge</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Reset</span> <span class="n">errors</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">behavior</span> <span class="k">for</span> <span class="n">when</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">moving</span>
    <span class="n">enumMotionRequest</span><span class="p">:</span> <span class="n">E_MotionRequest</span> <span class="o">:=</span> <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">WAIT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goal</span> <span class="n">position</span>
    <span class="n">fPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Move</span> <span class="n">velocity</span>
    <span class="n">fVel</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Optional</span> <span class="n">acceleration</span>
    <span class="n">fAcc</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Optional</span> <span class="n">deceleration</span>
    <span class="n">fDec</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="kc">True</span> <span class="k">if</span> <span class="ow">in</span> <span class="n">error</span> <span class="n">state</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">What</span> <span class="n">the</span> <span class="n">error</span> <span class="n">code</span> <span class="n">means</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">motor</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">and</span> <span class="n">our</span> <span class="n">most</span> <span class="n">recent</span> <span class="n">move</span> <span class="n">was</span> <span class="n">successful</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftExec</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">rtReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftBusy</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bMyMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bCausedError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Define</span> <span class="n">local</span> <span class="n">constants</span> <span class="k">for</span> <span class="n">our</span> <span class="n">state</span> <span class="n">machine</span> <span class="n">states</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">INIT</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">WAIT_EXEC</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">PICK_REQUEST</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">WAIT_OTHER_MOVE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">STOP_OTHER_MOVE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">START_MOVE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">WAIT_MY_MOVE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">STOP_MY_MOVE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">;</span>
    <span class="n">DONE_MOVING</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">ERROR</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">9</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">ftExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bReset</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Go</span> <span class="n">back</span> <span class="n">to</span> <span class="n">INIT</span> <span class="n">state</span> <span class="n">on</span> <span class="n">reset</span>
<span class="n">IF</span> <span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">nState</span> <span class="o">:=</span> <span class="n">INIT</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">by</span> <span class="n">setting</span> <span class="n">everything</span> <span class="n">to</span> <span class="n">a</span> <span class="n">known</span> <span class="n">value</span>
    <span class="n">INIT</span><span class="p">:</span>
        <span class="n">nState</span> <span class="o">:=</span> <span class="n">WAIT_EXEC</span><span class="p">;</span>
        <span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bCausedError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="s2">&quot;waiting for move command&quot;</span> <span class="n">state</span>
    <span class="n">WAIT_EXEC</span><span class="p">:</span>
        <span class="n">bMyMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">Looking</span> <span class="k">for</span> <span class="n">a</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">on</span> <span class="n">bExecute</span>
        <span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">PICK_REQUEST</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Decide</span> <span class="n">how</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">the</span> <span class="n">request</span>
    <span class="n">PICK_REQUEST</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
            <span class="n">CASE</span> <span class="n">enumMotionRequest</span> <span class="n">OF</span>
                <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">WAIT</span><span class="p">:</span>
                    <span class="n">nState</span> <span class="o">:=</span> <span class="n">WAIT_OTHER_MOVE</span><span class="p">;</span>
                <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="p">:</span>
                    <span class="n">nState</span> <span class="o">:=</span> <span class="n">STOP_OTHER_MOVE</span><span class="p">;</span>
                <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">ABORT</span><span class="p">:</span>
                    <span class="n">nState</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
                    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="n">nErrorId</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#7900;</span>
            <span class="n">END_CASE</span>
        <span class="n">ELSE</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">START_MOVE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Watch</span> <span class="n">the</span> <span class="n">other</span> <span class="n">move</span><span class="p">,</span> <span class="n">then</span> <span class="n">see</span> <span class="k">if</span> <span class="n">it</span><span class="s1">&#39;s our turn</span>
    <span class="n">WAIT_OTHER_MOVE</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">Try</span> <span class="n">to</span> <span class="n">pick</span> <span class="n">request</span> <span class="n">again</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">once</span> <span class="n">the</span> <span class="n">move</span> <span class="ow">is</span> <span class="n">over</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">PICK_REQUEST</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Interrupt</span> <span class="n">the</span> <span class="n">other</span> <span class="n">move</span><span class="p">,</span> <span class="n">then</span> <span class="n">go</span> <span class="n">to</span> <span class="n">start</span> <span class="n">ours</span>
    <span class="n">STOP_OTHER_MOVE</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">START_MOVE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">values</span> <span class="n">on</span> <span class="n">ST_MotionStage</span> <span class="n">to</span> <span class="n">start</span> <span class="n">a</span> <span class="n">new</span> <span class="n">absolute</span> <span class="n">move</span>
    <span class="n">START_MOVE</span><span class="p">:</span>
        <span class="n">bMyMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCommand</span> <span class="o">:=</span> <span class="n">E_EpicsMotorCmd</span><span class="o">.</span><span class="n">MOVE_ABSOLUTE</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fPos</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">fVel</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">fAcc</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fDeceleration</span> <span class="o">:=</span> <span class="n">fDec</span><span class="p">;</span>
        <span class="n">nState</span> <span class="o">:=</span> <span class="n">WAIT_MY_MOVE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Watch</span> <span class="n">our</span> <span class="n">ongoing</span> <span class="n">move</span><span class="p">,</span> <span class="n">look</span> <span class="k">for</span> <span class="n">the</span> <span class="n">move</span> <span class="n">to</span> <span class="n">end</span> <span class="ow">or</span> <span class="n">requests</span> <span class="n">to</span> <span class="n">stop</span> <span class="n">the</span> <span class="n">move</span> <span class="kn">from</span> <span class="nn">this</span> <span class="n">FB</span>
    <span class="n">WAIT_MY_MOVE</span><span class="p">:</span>
        <span class="n">ftBusy</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>
        <span class="n">IF</span> <span class="n">ftBusy</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">DONE_MOVING</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="o">//</span> <span class="n">Implement</span> <span class="n">stop</span> <span class="n">on</span> <span class="n">falling</span> <span class="n">trigger</span>
        <span class="n">IF</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">STOP_MY_MOVE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Request</span> <span class="n">a</span> <span class="n">stop</span> <span class="ow">and</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">it</span> <span class="n">to</span> <span class="n">happen</span>
    <span class="n">STOP_MY_MOVE</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">DONE_MOVING</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Pick</span> <span class="n">out</span> <span class="n">the</span> <span class="n">bDone</span> <span class="n">state</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">to</span> <span class="n">waiting</span>
    <span class="n">DONE_MOVING</span><span class="p">:</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bDone</span><span class="p">;</span>
        <span class="n">nState</span> <span class="o">:=</span> <span class="n">WAIT_EXEC</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Lock</span> <span class="n">us</span> <span class="n">into</span> <span class="n">the</span> <span class="n">error</span> <span class="n">state</span> <span class="n">until</span> <span class="n">the</span> <span class="n">FB</span> <span class="ow">is</span> <span class="n">reset</span>
    <span class="n">ERROR</span><span class="p">:</span>
        <span class="n">bMyMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="o">//</span> <span class="n">Transition</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ERROR</span> <span class="n">state</span> <span class="k">if</span> <span class="n">applicable</span>
<span class="n">IF</span> <span class="n">bMyMove</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">nState</span> <span class="o">:=</span> <span class="n">ERROR</span><span class="p">;</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
    <span class="n">bCausedError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">F_MotionErrorCodeLookup</span><span class="p">(</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">nErrorId</span><span class="p">);</span>

<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="n">INIT</span><span class="p">,</span> <span class="n">WAIT_EXEC</span><span class="p">,</span> <span class="n">ERROR</span><span class="p">:</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></p></li>
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#f-motionerrorcodelookup">F_MotionErrorCodeLookup</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionstage">
<h2>FB_MotionStage<a class="headerlink" href="#fb-motionstage" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionStage</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Default</span> <span class="n">implementation</span> <span class="k">for</span> <span class="n">PLC</span> <span class="n">behavior</span> <span class="n">when</span> <span class="n">motor</span> <span class="n">IOC</span> <span class="n">asks</span> <span class="k">for</span> <span class="n">a</span> <span class="n">move</span>
    <span class="n">This</span> <span class="n">can</span> <span class="n">be</span> <span class="n">extended</span> <span class="ow">or</span> <span class="n">replaced</span> <span class="ow">in</span> <span class="n">your</span> <span class="n">PLC</span> <span class="n">project</span> <span class="k">if</span> <span class="n">you</span> <span class="n">want</span>
    <span class="n">non</span><span class="o">-</span><span class="n">default</span> <span class="n">behavior</span> <span class="n">to</span> <span class="n">arise</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">motor</span> <span class="n">record</span> <span class="n">processing</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbDriveVirtual</span><span class="p">:</span> <span class="n">FB_DriveVirtual</span><span class="p">;</span>
    <span class="n">fbMotionHome</span><span class="p">:</span> <span class="n">FB_MotionHoming</span><span class="p">;</span>
    <span class="n">fbSaveRestore</span><span class="p">:</span> <span class="n">FB_EncSaveRestore</span><span class="p">;</span>
    <span class="n">fbLogError</span><span class="p">:</span> <span class="n">FB_LogMotionError</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecHome</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bFwdHit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBwdHit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ftExec</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtUserExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtTarget</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtHomed</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fbSetEnables</span><span class="p">:</span> <span class="n">FB_SetEnables</span><span class="p">;</span>
    <span class="n">bPosGoal</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bNegGoal</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fbEncoderValue</span><span class="p">:</span> <span class="n">FB_EncoderValue</span><span class="p">;</span>
    <span class="n">fbNCParams</span><span class="p">:</span> <span class="n">FB_MotionStageNCParams</span><span class="p">;</span>
    <span class="n">bNewMoveReq</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bPrepareDisable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMoveCmd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtMoveCmdShortcut</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtHomeCmdShortcut</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Start</span> <span class="k">with</span> <span class="n">an</span> <span class="n">accurate</span> <span class="n">status</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">ReadStatus</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">the</span> <span class="n">plc</span> <span class="n">shortcut</span> <span class="n">commands</span>
<span class="o">//</span> <span class="n">Used</span> <span class="k">for</span> <span class="n">testing</span> <span class="ow">or</span> <span class="n">to</span> <span class="n">circumvent</span> <span class="n">motor</span> <span class="n">record</span> <span class="n">issues</span>
<span class="n">rtMoveCmdShortcut</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bMoveCmd</span><span class="p">);</span>
<span class="n">rtHomeCmdShortcut</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHomeCmd</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Execute</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span>
<span class="n">IF</span> <span class="n">rtMoveCmdShortcut</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCommand</span> <span class="o">:=</span> <span class="n">E_EpicsMotorCmd</span><span class="o">.</span><span class="n">MOVE_ABSOLUTE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">rtHomeCmdShortcut</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCommand</span> <span class="o">:=</span> <span class="n">E_EpicsMotorCmd</span><span class="o">.</span><span class="n">HOME</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Always</span> <span class="n">reset</span><span class="p">,</span> <span class="n">even</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">so</span> <span class="n">command</span> <span class="n">can</span> <span class="n">be</span> <span class="n">issued</span> <span class="n">again</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="n">OR</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHomeCmd</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bMoveCmd</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHomeCmd</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Automatically</span> <span class="n">fill</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">nCmdData</span> <span class="k">for</span> <span class="n">homing</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCommand</span> <span class="o">=</span> <span class="n">E_EpicsMotorCmd</span><span class="o">.</span><span class="n">HOME</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCmdData</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nHomingMode</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">the</span> <span class="n">command</span> <span class="n">wants</span> <span class="n">to</span> <span class="n">cause</span> <span class="n">a</span> <span class="n">move</span>
<span class="n">bMoveCmd</span> <span class="n">R</span><span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCmdData</span> <span class="o">=</span> <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">ABSOLUTE_SET</span><span class="p">;</span>
<span class="n">bMoveCmd</span> <span class="n">R</span><span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCmdData</span> <span class="o">=</span> <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">NONE</span><span class="p">;</span>
<span class="n">bMoveCmd</span> <span class="n">S</span><span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCommand</span> <span class="o">&lt;&gt;</span> <span class="n">E_EpicsMotorCmd</span><span class="o">.</span><span class="n">HOME</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Handle</span> <span class="n">main</span> <span class="n">execs</span>
<span class="n">rtUserExec</span><span class="p">(</span><span class="n">CLK</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">bNewMoveReq</span> <span class="n">S</span><span class="o">=</span> <span class="n">rtUserExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">bMoveCmd</span><span class="p">;</span>
<span class="n">bNewMoveReq</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
<span class="n">bPrepareDisable</span> <span class="n">R</span><span class="o">=</span> <span class="n">bNewMoveReq</span><span class="p">;</span>

<span class="n">bPosGoal</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&lt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
<span class="n">bNegGoal</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&gt;</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Moves</span> <span class="n">are</span> <span class="n">automatically</span> <span class="n">allowed</span> <span class="k">if</span> <span class="n">no</span> <span class="n">safety</span> <span class="n">hooks</span><span class="o">.</span> <span class="n">Otherwise</span><span class="p">,</span> <span class="n">some</span> <span class="n">other</span> <span class="n">code</span> <span class="n">will</span> <span class="nb">set</span> <span class="n">this</span><span class="o">.</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="n">S</span><span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bPowerSelf</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Handle</span> <span class="n">auto</span><span class="o">-</span><span class="n">enable</span> <span class="n">timing</span>
<span class="n">CASE</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="n">OF</span>
    <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">bNewMoveReq</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCommand</span> <span class="o">=</span> <span class="n">E_EpicsMotorCmd</span><span class="o">.</span><span class="n">HOME</span> <span class="n">THEN</span>
                <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span><span class="p">;</span>
            <span class="n">ELSIF</span> <span class="n">bPosGoal</span> <span class="n">THEN</span>
                <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllForwardEnable</span> <span class="n">THEN</span>
                    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="n">S</span><span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span><span class="p">;</span>
                <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
                    <span class="o">//</span> <span class="n">Not</span> <span class="n">an</span> <span class="n">error</span><span class="p">,</span> <span class="n">just</span> <span class="n">a</span> <span class="n">warning</span>
                    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Cannot move past positive limit.&#39;</span><span class="p">;</span>
                    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">END_IF</span>
            <span class="n">ELSIF</span> <span class="n">bNegGoal</span> <span class="n">THEN</span>
                <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllBackwardEnable</span> <span class="n">THEN</span>
                    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="n">S</span><span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span><span class="p">;</span>
                <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
                    <span class="o">//</span> <span class="n">Not</span> <span class="n">an</span> <span class="n">error</span><span class="p">,</span> <span class="n">just</span> <span class="n">a</span> <span class="n">warning</span>
                    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Cannot move past negative limit.&#39;</span><span class="p">;</span>
                    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">END_IF</span>
            <span class="n">ELSE</span>
                <span class="o">//</span> <span class="n">Super</span> <span class="n">rare</span> <span class="n">condition</span> <span class="n">where</span> <span class="n">we</span> <span class="n">asked</span> <span class="k">for</span> <span class="n">a</span> <span class="n">move</span> <span class="n">to</span> <span class="n">exactly</span> <span class="n">the</span> <span class="n">same</span> <span class="n">floating</span> <span class="n">point</span> <span class="n">we</span><span class="s1">&#39;re already at</span>
                <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="n">S</span><span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span><span class="p">;</span>
            <span class="n">END_IF</span>
            <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="n">OR</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
                <span class="n">bNewMoveReq</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>
<span class="n">END_CASE</span>

<span class="o">//</span> <span class="n">Update</span> <span class="nb">all</span> <span class="n">enable</span> <span class="n">booleans</span>
<span class="n">fbSetEnables</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">move</span> <span class="n">to</span> <span class="n">end</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">bMoveCmd</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">start</span> <span class="n">the</span> <span class="n">move</span> <span class="n">until</span> <span class="n">we</span> <span class="n">have</span> <span class="n">power</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">safety</span> <span class="n">system</span> <span class="n">says</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">OK</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnableDone</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Reset</span> <span class="n">local</span> <span class="n">warnings</span> <span class="k">if</span> <span class="n">things</span> <span class="n">are</span> <span class="n">going</span> <span class="n">well</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">No</span> <span class="n">moves</span> <span class="n">allowed</span> <span class="ow">in</span> <span class="n">error</span> <span class="n">states</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="n">bExecHome</span> <span class="o">:=</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCommand</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">bExecMove</span> <span class="o">:=</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecHome</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Handle</span> <span class="n">standard</span> <span class="n">commands</span> <span class="n">using</span> <span class="n">ESS</span><span class="s1">&#39;s FB</span>
<span class="n">fbDriveVirtual</span><span class="p">(</span><span class="n">En</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecMove</span><span class="p">,</span>
    <span class="n">nCommand</span><span class="o">:=</span><span class="n">INT_TO_UINT</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCommand</span><span class="p">),</span>
    <span class="n">nCmdData</span><span class="o">:=</span><span class="n">INT_TO_UINT</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCmdData</span><span class="p">),</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="n">fPosition</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fAcceleration</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">fDeceleration</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">bLimitFwd</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">,</span>
    <span class="n">bLimitBwd</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllBackwardEnable</span><span class="p">,</span>
    <span class="n">bHomeSensor</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHome</span><span class="p">,</span>
    <span class="n">fHomePosition</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">fHomePosition</span><span class="p">,</span>
    <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bPowerSelf</span><span class="p">,</span>
    <span class="n">nMotionAxisID</span><span class="o">=&gt;</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nMotionAxisID</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Some</span> <span class="n">custom</span> <span class="n">home</span> <span class="n">handling</span>
<span class="n">fbMotionHome</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecHome</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Update</span> <span class="n">status</span> <span class="n">again</span> <span class="n">after</span> <span class="n">the</span> <span class="n">move</span> <span class="n">starts</span> <span class="ow">or</span> <span class="n">stops</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">ReadStatus</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">a</span> <span class="n">new</span> <span class="n">error</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">fbDriveVirtual</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">fbDriveVirtual</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">fbMotionHome</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">fbMotionHome</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bUserEnable</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Move requested, but user enable is disabled!&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">error</span> <span class="n">message</span> <span class="k">if</span> <span class="n">we</span> <span class="n">have</span> <span class="n">one</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Hook</span> <span class="k">if</span> <span class="n">other</span> <span class="n">code</span> <span class="n">wants</span> <span class="n">to</span> <span class="n">inject</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">NC</span> <span class="n">error</span>
    <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">stMotionSTage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">F_MotionErrorCodeLookup</span><span class="p">(</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">);</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">fbLogError</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

<span class="o">//</span> <span class="n">When</span> <span class="n">we</span> <span class="n">start</span><span class="p">,</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">busy</span><span class="o">/</span><span class="n">done</span> <span class="n">appropriately</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Force</span> <span class="n">everything</span> <span class="n">off</span> <span class="ow">in</span> <span class="n">case</span> <span class="n">of</span> <span class="n">error</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Check</span> <span class="n">the</span> <span class="n">limits</span> <span class="ow">and</span> <span class="n">cancel</span> <span class="n">execution</span> <span class="k">if</span> <span class="n">appropriate</span><span class="o">.</span> <span class="n">Without</span> <span class="n">this</span> <span class="n">block</span> <span class="n">we</span> <span class="n">have</span> <span class="n">infinite</span> <span class="n">error</span> <span class="n">spam</span>
<span class="n">bFwdHit</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">PositiveDirection</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">;</span>
<span class="n">bBwdHit</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NegativeDirection</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllBackwardEnable</span><span class="p">;</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">bFwdHit</span> <span class="n">OR</span> <span class="n">bBwdHit</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMotionHome</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Check</span> <span class="n">done</span> <span class="n">moving</span> <span class="n">via</span> <span class="n">user</span> <span class="n">stop</span><span class="p">,</span> <span class="n">fbDriveVirtual</span> <span class="ow">and</span> <span class="n">Target</span> <span class="n">Position</span> <span class="n">Monitoring</span><span class="p">,</span> <span class="ow">or</span> <span class="kn">from</span> <span class="nn">homing.</span>
<span class="n">ftExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">rtTarget</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">InTargetPosition</span> <span class="n">AND</span> <span class="n">fbDriveVirtual</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecMove</span><span class="p">));</span>
<span class="n">rtHomed</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbMotionHome</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">bExecHome</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">rtTarget</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">rtHomed</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
            <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Handle</span> <span class="n">auto</span><span class="o">-</span><span class="n">disable</span> <span class="n">timing</span>
<span class="n">bPrepareDisable</span> <span class="n">S</span><span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span> <span class="n">AND</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Delay</span> <span class="n">the</span> <span class="n">disable</span> <span class="n">until</span> <span class="n">we</span> <span class="n">reach</span> <span class="n">standstill</span><span class="p">,</span> <span class="k">else</span> <span class="n">brake</span> <span class="n">issues</span> <span class="ow">or</span> <span class="n">other</span> <span class="n">race</span> <span class="n">conditions</span>
<span class="n">IF</span> <span class="n">bPrepareDisable</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">MotionState</span> <span class="o">=</span> <span class="n">MC_AXISSTATE_STANDSTILL</span> <span class="n">THEN</span>
    <span class="n">bPrepareDisable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Get</span> <span class="n">a</span> <span class="n">definitive</span> <span class="n">bEnabled</span> <span class="n">reading</span>
<span class="n">CASE</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">MotionState</span> <span class="n">OF</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">enabled</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">issue</span>
    <span class="n">MC_AXISSTATE_UNDEFINED</span><span class="p">,</span> <span class="n">MC_AXISSTATE_DISABLED</span><span class="p">,</span> <span class="n">MC_AXISSTATE_ERRORSTOP</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnableDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnableDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="o">//</span> <span class="n">Handle</span> <span class="n">the</span> <span class="n">brake</span><span class="o">.</span> <span class="n">TRUE</span> <span class="n">means</span> <span class="n">brake</span> <span class="n">disabled</span><span class="o">/</span><span class="n">released</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nBrakeMode</span> <span class="o">&lt;&gt;</span> <span class="n">E_StageBrakeMode</span><span class="o">.</span><span class="n">NO_BRAKE</span> <span class="n">THEN</span>
    <span class="n">CASE</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">MotionState</span> <span class="n">OF</span>
        <span class="n">MC_AXISSTATE_UNDEFINED</span><span class="p">,</span>
        <span class="n">MC_AXISSTATE_DISABLED</span><span class="p">,</span>
        <span class="n">MC_AXISSTATE_ERRORSTOP</span><span class="p">:</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBrakeRelease</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">MC_AXISSTATE_STANDSTILL</span><span class="p">:</span>
            <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nBrakeMode</span> <span class="o">=</span> <span class="n">E_StageBrakeMode</span><span class="o">.</span><span class="n">IF_MOVING</span> <span class="n">THEN</span>
                <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBrakeRelease</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBrakeRelease</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">ELSE</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBrakeRelease</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_CASE</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Sync</span> <span class="n">the</span> <span class="n">epics</span> <span class="n">status</span> <span class="n">struct</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span> <span class="o">:=</span> <span class="n">fbDriveVirtual</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bEnabled</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnableDone</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Override</span> <span class="n">homing</span> <span class="n">status</span><span class="p">,</span> <span class="n">dmov</span> <span class="k">as</span> <span class="n">appropriate</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHomed</span> <span class="o">:=</span> <span class="n">fbMotionHome</span><span class="o">.</span><span class="n">bDone</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMotionHome</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bHomed</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHomed</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">nCommand</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span> <span class="o">//</span> <span class="n">If</span> <span class="n">this</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">3</span><span class="p">,</span> <span class="n">the</span> <span class="n">IOC</span> <span class="n">stops</span> <span class="n">updating</span> <span class="n">positions</span> <span class="n">during</span> <span class="n">homing</span>

<span class="o">//</span> <span class="n">Fill</span> <span class="ow">in</span> <span class="n">auxiliary</span> <span class="n">status</span> <span class="n">info</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosDiff</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">PosDiff</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Reset</span> <span class="n">everything</span> <span class="n">when</span> <span class="n">bReset</span> <span class="ow">is</span> <span class="n">flagged</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbEncoderValue</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">fbNCParams</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">tRefreshDelay</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1s);</span>

<span class="o">//</span> <span class="n">Save</span> <span class="ow">and</span> <span class="n">restore</span> <span class="k">as</span> <span class="n">long</span> <span class="k">as</span> <span class="ow">not</span> <span class="n">an</span> <span class="n">absolute</span> <span class="n">encoder</span>
<span class="n">fbSaveRestore</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nHomingMode</span> <span class="o">&lt;&gt;</span> <span class="n">E_EpicsHomeCmd</span><span class="o">.</span><span class="n">NONE</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicshomecmd">E_EpicsHomeCmd</a></p></li>
<li><p><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></p></li>
<li><p><a class="reference internal" href="#e-stagebrakemode">E_StageBrakeMode</a></p></li>
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#fb-drivevirtual">FB_DriveVirtual</a></p></li>
<li><p><a class="reference internal" href="#fb-encsaverestore">FB_EncSaveRestore</a></p></li>
<li><p><a class="reference internal" href="#fb-encodervalue">FB_EncoderValue</a></p></li>
<li><p><a class="reference internal" href="#fb-logmotionerror">FB_LogMotionError</a></p></li>
<li><p><a class="reference internal" href="#fb-motionhoming">FB_MotionHoming</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstagencparams">FB_MotionStageNCParams</a></p></li>
<li><p><a class="reference internal" href="#fb-setenables">FB_SetEnables</a></p></li>
<li><p><a class="reference internal" href="#f-motionerrorcodelookup">F_MotionErrorCodeLookup</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionstagencparams">
<h2>FB_MotionStageNCParams<a class="headerlink" href="#fb-motionstagencparams" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionStageNCParams</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Read</span> <span class="ow">and</span> <span class="n">refresh</span> <span class="n">axis</span> <span class="n">parameters</span> <span class="n">struct</span> <span class="n">on</span> <span class="n">ST_MotionStage</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tRefreshDelay</span><span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">mcReadParams</span><span class="p">:</span> <span class="n">MC_ReadParameterSet</span><span class="p">;</span>
    <span class="n">timer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nLatchErrId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">timer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bEnable</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">tRefreshDelay</span><span class="p">);</span>
<span class="n">bExecute</span> <span class="n">S</span><span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">mcReadParams</span><span class="p">(</span>
    <span class="n">Parameter</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bEnable</span> <span class="n">AND</span> <span class="n">bExecute</span><span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span><span class="n">bError</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">mcReadParams</span><span class="o">.</span><span class="n">ErrorID</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">nLatchErrId</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">bExecute</span> <span class="n">R</span><span class="o">=</span> <span class="n">mcReadParams</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">mcReadParams</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAxisParamsInit</span> <span class="n">S</span><span class="o">=</span> <span class="n">mcReadParams</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motionstagesim">
<h2>FB_MotionStageSim<a class="headerlink" href="#fb-motionstagesim" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotionStageSim</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Set</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">values</span> <span class="n">needed</span> <span class="k">for</span> <span class="n">a</span> <span class="n">fake</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">be</span> <span class="n">movable</span>
    <span class="n">via</span> <span class="n">the</span> <span class="n">IOC</span><span class="p">,</span> <span class="n">then</span> <span class="n">call</span> <span class="n">FB_MotionStage</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nEnableMode</span><span class="p">:</span> <span class="n">E_StageEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Stand</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">no</span> <span class="n">forward</span> <span class="n">limit</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Stand</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">no</span> <span class="n">reverse</span> <span class="n">limit</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Stand</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">no</span> <span class="n">STO</span> <span class="n">button</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Stand</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">no</span> <span class="n">PMPS</span> <span class="n">governer</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Always</span> <span class="n">keep</span> <span class="n">it</span> <span class="n">enabled</span> <span class="k">for</span> <span class="n">testing</span> <span class="n">ease</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">nEnableMode</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Call</span> <span class="n">FB_MotionStage</span> <span class="n">to</span> <span class="n">do</span> <span class="n">the</span> <span class="n">thing</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-motortestsuite">
<h2>FB_MotorTestSuite<a class="headerlink" href="#fb-motortestsuite" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MotorTestSuite</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Base</span> <span class="k">class</span> <span class="nc">for</span> <span class="n">motion</span> <span class="n">tests</span><span class="o">.</span>

    <span class="n">Contains</span> <span class="n">some</span> <span class="n">helper</span> <span class="n">methods</span> <span class="n">that</span> <span class="n">would</span> <span class="n">otherwise</span> <span class="n">need</span> <span class="n">to</span> <span class="n">be</span> <span class="n">instantiated</span> <span class="n">many</span> <span class="n">times</span><span class="p">,</span>
    <span class="n">but</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">form</span> <span class="n">can</span> <span class="n">be</span> <span class="n">accessed</span> <span class="n">quickly</span> <span class="ow">and</span> <span class="n">succinctly</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>


<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">SetEnables</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Set</span> <span class="n">a</span> <span class="n">motion</span> <span class="n">stage</span><span class="s1">&#39;s enables such that it is fully allowed to move.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">SetEnablesPMPS</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Set</span> <span class="n">a</span> <span class="n">motion</span> <span class="n">stage</span><span class="s1">&#39;s enables such that only PMPS would be preventing a move.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">SetGoodState</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Mark</span> <span class="n">a</span> <span class="n">state</span> <span class="k">as</span> <span class="n">valid</span> <span class="ow">and</span> <span class="n">ready</span> <span class="n">to</span> <span class="n">use</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ncaxis">
<h2>FB_NcAxis<a class="headerlink" href="#fb-ncaxis" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="c1">#########################################################</span>
<span class="o">///</span><span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">communicate</span> <span class="n">between</span> <span class="n">Nc</span> <span class="ow">and</span> <span class="n">Plc</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Library</span><span class="p">:</span>
<span class="o">///</span> <span class="n">Tc2_MC2</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Global</span> <span class="n">Variables</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Data</span> <span class="n">types</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">External</span> <span class="n">functions</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span><span class="c1">###########################################################</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_NcAxis</span>
<span class="n">VAR</span>
    <span class="n">sVersion</span><span class="p">:</span> <span class="n">STRING</span><span class="o">:=</span><span class="s1">&#39;1.0.0&#39;</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Status</span><span class="p">:</span> <span class="n">ST_AxisStatus</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">InfoData_State</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">AND</span> <span class="n">InfoData_State</span><span class="o">&lt;&gt;</span><span class="mi">16</span><span class="c1">#8 THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">En</span> <span class="n">THEN</span>
    <span class="n">Axis</span><span class="o">.</span><span class="n">ReadStatus</span><span class="p">();</span>
    <span class="n">Status</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-ncerrorffo">
<h2>FB_NCErrorFFO<a class="headerlink" href="#fb-ncerrorffo" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_NCErrorFFO</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Configure</span> <span class="n">a</span> <span class="n">ST_MotionStage</span> <span class="n">to</span> <span class="n">trigger</span> <span class="n">an</span> <span class="n">FFO</span> <span class="n">when</span> <span class="n">we</span> <span class="n">have</span> <span class="n">an</span> <span class="n">error</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">can</span> <span class="n">be</span> <span class="n">configured</span> <span class="n">to</span> <span class="n">only</span> <span class="n">apply</span> <span class="n">to</span> <span class="n">specific</span> <span class="n">error</span> <span class="n">ranges</span><span class="p">,</span>
    <span class="n">though</span> <span class="n">the</span> <span class="n">default</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">normal</span> <span class="mi">16</span><span class="c1">#4XXX NC error range. The error</span>
    <span class="n">ranges</span> <span class="n">are</span><span class="p">:</span>
    <span class="mi">16</span><span class="c1">#40XX General Errors</span>
    <span class="mi">16</span><span class="c1">#41XX Channel Errors</span>
    <span class="mi">16</span><span class="c1">#42XX Group Errors</span>
    <span class="mi">16</span><span class="c1">#43XX Axis Errors</span>
    <span class="mi">16</span><span class="c1">#44XX Encoder Errors</span>
    <span class="mi">16</span><span class="c1">#45XX Controller Errors</span>
    <span class="mi">16</span><span class="c1">#46XX Drive Errors</span>
    <span class="mi">16</span><span class="c1">#4AXX Table Errors</span>
    <span class="mi">16</span><span class="c1">#4BXX NC PLC Errors</span>
    <span class="mi">16</span><span class="c1">#4CXX Kinematic Transformation</span>

    <span class="n">There</span> <span class="ow">is</span> <span class="n">also</span> <span class="n">a</span> <span class="n">new</span> <span class="n">extended</span> <span class="n">NC</span> <span class="n">error</span> <span class="nb">range</span><span class="p">,</span> <span class="n">but</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">sparsely</span> <span class="n">populated</span><span class="o">.</span>
    <span class="n">This</span> <span class="nb">range</span> <span class="ow">is</span> <span class="mi">16</span><span class="c1">#8XXX:</span>
    <span class="mi">16</span><span class="c1">#8100 - 16#811F: Bode plot (diagnosis)</span>
    <span class="mi">16</span><span class="c1">#8120 - 16#8FFF: Further errors</span>

    <span class="n">To</span> <span class="n">configure</span> <span class="n">multiple</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">simply</span> <span class="n">use</span> <span class="n">multiple</span> <span class="n">instances</span> <span class="n">of</span> <span class="n">this</span>
    <span class="n">function</span> <span class="n">block</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motion</span> <span class="n">stage</span> <span class="n">to</span> <span class="n">monitor</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">FFO</span> <span class="n">to</span> <span class="n">trip</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">fault</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Auto</span><span class="o">-</span><span class="n">reset</span> <span class="n">the</span> <span class="n">fault</span>
    <span class="n">bAutoReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">lowest</span> <span class="n">error</span> <span class="n">code</span> <span class="n">that</span> <span class="n">will</span> <span class="n">trip</span> <span class="n">the</span> <span class="n">FFO</span>
    <span class="n">nLowErrorId</span><span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#4000;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">highest</span> <span class="n">error</span> <span class="n">code</span> <span class="n">that</span> <span class="n">will</span> <span class="n">trip</span> <span class="n">the</span> <span class="n">FFO</span>
    <span class="n">nHighErrorId</span><span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#4FFF;</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">description</span> <span class="n">of</span> <span class="n">the</span> <span class="n">fault</span>
    <span class="n">sDesc</span><span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;Motor error&#39;</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Quick</span> <span class="n">way</span> <span class="k">for</span> <span class="n">nearby</span> <span class="n">code</span> <span class="n">to</span> <span class="n">check</span> <span class="k">if</span> <span class="n">this</span> <span class="n">block</span> <span class="n">has</span> <span class="n">tripped</span> <span class="n">the</span> <span class="n">FFO</span><span class="o">.</span>
    <span class="n">bTripped</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">PMPS</span><span class="o">.</span> <span class="n">Is</span> <span class="n">always</span> <span class="mi">16</span><span class="c1">#20XX, where XX is the first two hex in the NC error.</span>
    <span class="n">nErrorTypeCode</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">stBeamParams</span><span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">fbFF</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">rtTrip</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">fbFF</span><span class="o">.</span><span class="n">i_Desc</span> <span class="o">:=</span> <span class="n">sDesc</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">LEN</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">sName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">fbFF</span><span class="o">.</span><span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sName</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">fbFF</span><span class="o">.</span><span class="n">i_DevName</span> <span class="o">:=</span> <span class="s1">&#39;Unnamed Motor&#39;</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bTripped</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">&gt;=</span> <span class="n">nLowErrorId</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">&lt;=</span> <span class="n">nHighErrorId</span><span class="p">;</span>
<span class="n">rtTrip</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bTripped</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtTrip</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">nErrorTypeCode</span> <span class="o">:=</span> <span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">LOW_RESERVED_NC</span> <span class="o">+</span> <span class="n">UDINT_TO_UINT</span><span class="p">(</span><span class="n">SHR</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
    <span class="n">nErrorTypeCode</span> <span class="o">:=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">nErrorTypeCode</span><span class="p">,</span> <span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">HIGH_RESERVED_NC</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">fbFF</span><span class="p">(</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bTripped</span><span class="p">,</span>
     <span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">bReset</span><span class="p">,</span>
     <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">bAutoReset</span><span class="p">,</span>
     <span class="n">i_TypeCode</span><span class="o">:=</span> <span class="n">nErrorTypeCode</span><span class="p">,</span>
     <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFHWO</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ncerrorffo-test">
<h2>FB_NCErrorFFO_Test<a class="headerlink" href="#fb-ncerrorffo-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_NCErrorFFO_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">the</span> <span class="n">following</span> <span class="n">related</span> <span class="n">FBs</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">FB_NCErrorFFO</span>
    <span class="o">-</span> <span class="n">FB_EncErrorFFO</span>

    <span class="n">These</span> <span class="n">function</span> <span class="n">blocks</span> <span class="n">are</span> <span class="n">designed</span> <span class="n">to</span> <span class="n">trip</span> <span class="n">the</span> <span class="n">beam</span> <span class="n">when</span> <span class="n">there</span>
    <span class="ow">is</span> <span class="n">an</span> <span class="n">NC</span> <span class="n">error</span> <span class="n">reported</span> <span class="n">by</span> <span class="n">stMotionStage</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbCauseNCError</span><span class="p">:</span> <span class="n">FB_CauseNCError</span><span class="p">;</span>

    <span class="n">fbNCErrorFFO</span><span class="p">:</span> <span class="n">FB_NCErrorFFO</span><span class="p">;</span>
    <span class="n">fbEncErrorFFO</span><span class="p">:</span> <span class="n">FB_EncErrorFFO</span><span class="p">;</span>

    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Limit</span> <span class="n">to</span> <span class="n">drive</span> <span class="n">errors</span> <span class="n">so</span> <span class="n">I</span> <span class="n">can</span> <span class="n">isolate</span> <span class="n">it</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">enc</span> <span class="n">error</span>
<span class="n">fbNCErrorFFO</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nLowErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4500,</span>
    <span class="n">nHighErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#45FF,</span>
<span class="p">);</span>
<span class="n">fbEncErrorFFO</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">Fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="n">when</span> <span class="n">there</span> <span class="n">are</span> <span class="n">no</span> <span class="n">issues</span> <span class="ow">and</span> <span class="n">FALSE</span> <span class="n">when</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">issue</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="n">TestNC</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">TestEnc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">fbCauseNCError</span><span class="p">(</span>
        <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestEnc</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestEncError&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">First</span> <span class="n">cycle</span><span class="p">:</span> <span class="n">no</span> <span class="n">error</span><span class="p">,</span> <span class="n">no</span> <span class="n">fault</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
            <span class="s1">&#39;Should have had no error before running this test&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
            <span class="s1">&#39;Should have had no fault with no error&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">nState</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="mi">1</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Next</span> <span class="n">time</span><span class="p">:</span> <span class="n">cause</span> <span class="n">an</span> <span class="n">error</span>
        <span class="n">fbCauseNCError</span><span class="p">(</span>
            <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">nErrorCode</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4467, // Invalid encoder position data</span>
        <span class="p">);</span>
<span class="n">END_CASE</span>

<span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">the</span> <span class="n">fault</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">then</span> <span class="n">check</span> <span class="n">everything</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorID</span> <span class="o">=</span> <span class="mi">16</span><span class="c1">#4467) THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="s1">&#39;Did not get motor error in error test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UDINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4467,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error causer is broken&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not cause a fast fault&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbNCErrorFFO</span><span class="o">.</span><span class="n">bTripped</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Drive error FB tripped with an enc error&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbEncErrorFFO</span><span class="o">.</span><span class="n">bTripped</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Enc error fb did not trip with an enc error&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestNC</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestNCError&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">First</span> <span class="n">cycle</span><span class="p">:</span> <span class="n">no</span> <span class="n">error</span><span class="p">,</span> <span class="n">no</span> <span class="n">fault</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
            <span class="s1">&#39;Should have had no error before running this test&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
            <span class="s1">&#39;Should have had no fault with no error&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">nState</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="mi">1</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Next</span> <span class="n">time</span><span class="p">:</span> <span class="n">cause</span> <span class="n">an</span> <span class="n">error</span>
        <span class="n">fbCauseNCError</span><span class="p">(</span>
            <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">nErrorCode</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4550, // Position lag monitoring error code</span>
        <span class="p">);</span>
<span class="n">END_CASE</span>

<span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">the</span> <span class="n">fault</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">then</span> <span class="n">check</span> <span class="n">everything</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">=</span> <span class="mi">16</span><span class="c1">#4550) THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="s1">&#39;Did not get motor error in error test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UDINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4550,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error causer is broken&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not cause a fast fault&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbNCErrorFFO</span><span class="o">.</span><span class="n">bTripped</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;NC error FB did not trip with a drive error&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbEncErrorFFO</span><span class="o">.</span><span class="n">bTripped</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Enc error tripped with a drive error&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-causencerror">FB_CauseNCError</a></p></li>
<li><p><a class="reference internal" href="#fb-encerrorffo">FB_EncErrorFFO</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-ncerrorffo">FB_NCErrorFFO</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-permotorffond">
<h2>FB_PerMotorFFOND<a class="headerlink" href="#fb-permotorffond" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PerMotorFFOND</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">PMPS</span> <span class="n">fast</span> <span class="n">faults</span> <span class="n">that</span> <span class="n">must</span> <span class="n">be</span> <span class="n">done</span> <span class="n">per</span> <span class="n">motor</span><span class="p">,</span> <span class="n">rather</span> <span class="n">than</span> <span class="n">per</span> <span class="n">state</span><span class="p">,</span> <span class="n">based</span> <span class="n">purely</span>
    <span class="n">on</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">status</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other</span> <span class="n">PMPS</span> <span class="n">considerations</span><span class="o">.</span>

    <span class="n">These</span> <span class="n">currently</span> <span class="n">include</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Fault</span> <span class="k">if</span> <span class="n">the</span> <span class="n">encoder</span> <span class="n">has</span> <span class="n">an</span> <span class="n">error</span><span class="o">.</span> <span class="n">Every</span> <span class="n">other</span> <span class="n">protection</span> <span class="ow">is</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">encoder</span><span class="p">,</span>
      <span class="n">so</span> <span class="n">we</span> <span class="n">can</span><span class="s1">&#39;t trust anything if the encoder is faulting.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">motors</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">state</span> <span class="n">mover</span><span class="o">.</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">we</span><span class="s1">&#39;re actually using</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Identifying</span> <span class="n">name</span> <span class="n">to</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">group</span> <span class="n">fast</span> <span class="n">faults</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">arrays</span> <span class="n">don</span><span class="s1">&#39;t have the same bounds. In this FB, that&#39;</span><span class="n">s</span> <span class="n">an</span> <span class="n">automatic</span> <span class="n">fault</span><span class="o">.</span>
    <span class="n">bMotorCountError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">afbEncError</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_EncErrorFFO</span><span class="p">;</span>
    <span class="n">ffProgrammerError</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CheckCount</span><span class="p">();</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMotorCountError</span> <span class="n">THEN</span>
    <span class="n">HandleLoops</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">HandleFFO</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">CheckCount</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">valid</span> <span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">,</span> <span class="n">less</span> <span class="ow">or</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">max</span><span class="p">)</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&gt;</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandleFFO</span><span class="p">:</span>
<span class="n">ffProgrammerError</span><span class="p">(</span>
    <span class="n">i_xOK</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bMotorCountError</span><span class="p">,</span>
    <span class="n">i_xAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_DevName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">i_Desc</span><span class="o">:=</span><span class="s1">&#39;Programmer error picking motor count&#39;</span><span class="p">,</span>
    <span class="n">i_TypeCode</span><span class="o">:=</span><span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">INTERNAL_ERROR</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandleLoops</span><span class="p">:</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">afbEncError</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span>
        <span class="n">stMotionstage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
        <span class="n">bAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#fb-encerrorffo">FB_EncErrorFFO</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-permotorffond-test">
<h2>FB_PerMotorFFOND_Test<a class="headerlink" href="#fb-permotorffond-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PerMotorFFOND_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">FFO</span> <span class="k">if</span> <span class="n">an</span> <span class="n">illogical</span> <span class="n">motor</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">passed</span>
    <span class="n">FFO</span> <span class="k">if</span> <span class="nb">any</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">what</span> <span class="n">looks</span> <span class="n">like</span> <span class="n">an</span> <span class="n">encoder</span> <span class="n">error</span>
       <span class="o">-</span> <span class="n">We</span><span class="s1">&#39;ll just simulate this without doing it legit</span>
       <span class="o">-</span> <span class="n">The</span> <span class="n">legit</span> <span class="n">test</span> <span class="ow">is</span> <span class="n">done</span> <span class="n">elsewhere</span>
    <span class="n">More</span> <span class="n">FFOs</span> <span class="n">may</span> <span class="n">be</span> <span class="n">added</span> <span class="n">later</span> <span class="ow">and</span> <span class="n">these</span> <span class="n">will</span> <span class="n">need</span> <span class="n">to</span> <span class="n">be</span> <span class="n">tested</span> <span class="n">too</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TestBlankCount</span><span class="p">();</span>
<span class="n">TestTwoMotorEncError</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestBlankCount</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFO</span><span class="p">:</span> <span class="n">FB_PerMotorFFOND</span><span class="p">;</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestBlankCount&#39;</span><span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Started with a fault&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFO</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Blank count did not fault&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFO</span><span class="o">.</span><span class="n">bMotorCountError</span><span class="p">,</span>
    <span class="s1">&#39;Blank count did not error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestTwoMotorEncError</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFO</span><span class="p">:</span> <span class="n">FB_PerMotorFFOND</span><span class="p">;</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestTwoMotorEncError&#39;</span><span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Started with a fault&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#4467; // Invalid encoder position data</span>
<span class="n">fbFFO</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Encoder error did not fault&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-permotorffond">FB_PerMotorFFOND</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-pmpsjsontesthelper">
<h2>FB_PMPSJsonTestHelper<a class="headerlink" href="#fb-pmpsjsontesthelper" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PMPSJsonTestHelper</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Create</span> <span class="n">a</span> <span class="n">JSON</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">memory</span> <span class="n">to</span> <span class="n">match</span> <span class="n">the</span> <span class="nb">input</span> <span class="n">structs</span>
    <span class="n">Assumes</span> <span class="mi">1</span> <span class="n">device</span> <span class="k">for</span> <span class="n">simplicity</span>
    <span class="n">Writes</span> <span class="n">to</span> <span class="n">the</span> <span class="k">global</span> <span class="n">pmps</span> <span class="n">json</span> <span class="n">doc</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">astBeamParams</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sDevName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">jsonRoot</span><span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">jsonDevice</span><span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">ajsonState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">fbJson</span><span class="p">:</span> <span class="n">FB_JsonDomParser</span><span class="p">;</span>

    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nId</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>

    <span class="n">aseVRange</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">asRate</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">asBCRange</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">asTran</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">jsonRoot</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">NewDocument</span><span class="p">();</span>
<span class="n">jsonDevice</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">AddObjectMember</span><span class="p">(</span><span class="n">jsonRoot</span><span class="p">,</span> <span class="n">sDevName</span><span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="n">LOWER_BOUND</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">TO</span> <span class="n">UPPER_BOUND</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">DO</span>
    <span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">AddObjectMember</span><span class="p">(</span><span class="n">jsonDevice</span><span class="p">,</span> <span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">);</span>

    <span class="n">nId</span> <span class="o">:=</span> <span class="n">nId</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddIntMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">nId</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;beamline&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;tst&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">aseVRange</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">bitmaskToString</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;neVRange&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">aseVRange</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">asRate</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">UDINT_TO_STRING</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nRate</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;nRate&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">asRate</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_ygap&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_xgap&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;damage_limit&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;notes&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;reactive_temp&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;reactive_pressure&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">asBCRange</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">bitmaskToString</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;nBeamClassRange&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">asBCRange</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">asTran</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">REAL_TO_STRING</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nTran</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;nTran&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">asTran</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_name&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_ycenter&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_xcenter&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;pulse_energy&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddBoolMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;special&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">BP_jsonDoc</span> <span class="o">:=</span> <span class="n">jsonRoot</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">bitmaskToString</span> <span class="p">:</span> <span class="n">STRING</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nBitmask</span><span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="n">nBits</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bitmaskToString</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nBits</span> <span class="n">DO</span>
    <span class="n">bitmaskToString</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">DWORD_TO_STRING</span><span class="p">(</span><span class="n">SHR</span><span class="p">(</span><span class="n">nBitmask</span><span class="p">,</span> <span class="n">nIter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AND</span> <span class="mi">1</span><span class="p">),</span> <span class="n">bitmaskToString</span><span class="p">);</span>
<span class="n">END_FOR</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
</section>
<section id="fb-positionstate1d">
<h2>FB_PositionState1D<a class="headerlink" href="#fb-positionstate1d" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionState1D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="mi">1</span><span class="o">-</span><span class="n">Dimensional</span> <span class="n">position</span> <span class="n">state</span> <span class="n">function</span> <span class="n">block</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">move</span> <span class="n">a</span> <span class="n">motor</span> <span class="n">among</span> <span class="n">some</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">use</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">state</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">give</span> <span class="n">them</span> <span class="n">pytmc</span> <span class="n">pragmas</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">FB_PositionState1D_InOut</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">example</span><span class="o">.</span>
    <span class="n">These</span> <span class="n">enums</span> <span class="n">must</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="ow">and</span> <span class="n">eEnumGet</span> <span class="n">VAR_IN_OUT</span> <span class="n">variables</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">enum</span> <span class="n">values</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">array</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">astPositionState</span><span class="o">.</span>

    <span class="n">A</span> <span class="n">move</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">when</span> <span class="n">eEnumSet</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span> <span class="n">value</span><span class="o">.</span> <span class="n">eEnumSet</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">allowing</span> <span class="n">us</span>
    <span class="n">to</span> <span class="n">accept</span> <span class="n">a</span> <span class="n">new</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">move</span> <span class="n">request</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="n">the</span> <span class="n">first</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motor</span> <span class="n">must</span> <span class="n">already</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">point</span> <span class="n">motion</span> <span class="n">via</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">,</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">work</span> <span class="n">properly</span><span class="o">.</span>

    <span class="n">With</span> <span class="n">no</span> <span class="n">PMPS</span> <span class="n">handling</span><span class="p">,</span> <span class="n">this</span> <span class="n">FB</span> <span class="n">basically</span> <span class="n">just</span> <span class="n">links</span> <span class="n">the</span> <span class="n">state</span> <span class="n">names</span> <span class="k">with</span> <span class="n">positions</span> <span class="ow">in</span> <span class="n">both</span> <span class="n">directions</span> <span class="k">for</span> <span class="nb">set</span> <span class="ow">and</span> <span class="n">readback</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span><span class="o">.</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">;</span>

<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">astPositionState</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstate1d-inout">
<h2>FB_PositionState1D_InOut<a class="headerlink" href="#fb-positionstate1d-inout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionState1D_InOut</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">An</span> <span class="n">example</span> <span class="ow">and</span> <span class="n">usable</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="n">instance</span> <span class="k">for</span> <span class="n">a</span> <span class="mi">1</span><span class="n">D</span> <span class="n">state</span> <span class="n">device</span> <span class="k">with</span> <span class="n">just</span> <span class="n">an</span> <span class="n">IN</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">a</span> <span class="n">stage</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">into</span> <span class="n">the</span> <span class="n">FB</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Simplify</span> <span class="n">the</span> <span class="n">interface</span><span class="p">,</span> <span class="n">the</span> <span class="n">user</span> <span class="n">just</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">construct</span> <span class="ow">and</span> <span class="k">pass</span> <span class="ow">in</span> <span class="ow">and</span> <span class="n">out</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">a</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">expected</span> <span class="n">this</span> <span class="n">will</span> <span class="n">be</span> <span class="n">written</span> <span class="n">to</span> <span class="n">during</span> <span class="n">one</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">so</span> <span class="n">don</span><span class="s1">&#39;t continually apply a value here in the PLC code.</span>
    <span class="o">//</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">exposed</span> <span class="k">as</span> <span class="n">an</span> <span class="nb">input</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">test</span> <span class="n">it</span> <span class="n">using</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateReq</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="n">report</span> <span class="n">the</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateGet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">fb</span> <span class="k">with</span> <span class="n">blank</span> <span class="n">pv</span> <span class="n">pragma</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">fbPositionState1D</span><span class="p">:</span> <span class="n">FB_PositionState1D</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">standard</span> <span class="n">fb</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">full</span> <span class="n">array</span> <span class="n">of</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Optional</span><span class="p">:</span> <span class="n">default</span> <span class="n">state</span> <span class="n">names</span>
<span class="n">IF</span> <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Assemble</span> <span class="n">the</span> <span class="n">states</span> <span class="n">array</span><span class="p">,</span> <span class="n">matching</span> <span class="n">the</span> <span class="n">enum</span> <span class="n">values</span> <span class="p">(</span><span class="n">IN</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OUT</span> <span class="ow">is</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">main</span> <span class="n">function</span> <span class="n">block</span><span class="p">,</span> <span class="n">passing</span> <span class="n">our</span> <span class="n">motors</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">enums</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">enable</span>
<span class="n">fbPositionState1D</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eStateReq</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eStateGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Send</span> <span class="n">updates</span> <span class="n">made</span> <span class="n">on</span> <span class="n">the</span> <span class="n">array</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">inputs</span> <span class="p">(</span><span class="n">VAR_IN_OUT</span><span class="p">)</span> <span class="k">for</span> <span class="n">maximum</span> <span class="n">clarity</span>
<span class="n">stIn</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stOut</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsinout">E_EpicsInOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstate2d">
<h2>FB_PositionState2D<a class="headerlink" href="#fb-positionstate2d" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionState2D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="mi">2</span><span class="o">-</span><span class="n">Dimensional</span> <span class="n">position</span> <span class="n">state</span> <span class="n">function</span> <span class="n">block</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">move</span> <span class="mi">2</span> <span class="n">motors</span> <span class="n">among</span> <span class="n">some</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">use</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">state</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">give</span> <span class="n">them</span> <span class="n">pytmc</span> <span class="n">pragmas</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">FB_PositionState1D_InOut</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">example</span><span class="o">.</span>
    <span class="n">These</span> <span class="n">enums</span> <span class="n">must</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="ow">and</span> <span class="n">eEnumGet</span> <span class="n">VAR_IN_OUT</span> <span class="n">variables</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">enum</span> <span class="n">values</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">array</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">astPositionState1</span> <span class="ow">and</span> <span class="n">astPositionState2</span><span class="o">.</span>

    <span class="n">A</span> <span class="n">move</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">when</span> <span class="n">eEnumSet</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span> <span class="n">value</span><span class="o">.</span> <span class="n">eEnumSet</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">allowing</span> <span class="n">us</span>
    <span class="n">to</span> <span class="n">accept</span> <span class="n">a</span> <span class="n">new</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">move</span> <span class="n">request</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="n">the</span> <span class="n">first</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motors</span> <span class="n">must</span> <span class="n">already</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">point</span> <span class="n">motion</span> <span class="n">via</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">,</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">work</span> <span class="n">properly</span><span class="o">.</span>

    <span class="n">With</span> <span class="n">no</span> <span class="n">PMPS</span> <span class="n">handling</span><span class="p">,</span> <span class="n">this</span> <span class="n">FB</span> <span class="n">basically</span> <span class="n">just</span> <span class="n">links</span> <span class="n">the</span> <span class="n">state</span> <span class="n">names</span> <span class="k">with</span> <span class="n">positions</span> <span class="ow">in</span> <span class="n">both</span> <span class="n">directions</span> <span class="k">for</span> <span class="nb">set</span> <span class="ow">and</span> <span class="n">readback</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">1</span><span class="n">st</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">1</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="mi">01</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">2</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="mi">02</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage1</span><span class="p">;</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage2</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">;</span>

<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stMotionStage1</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stMotionStage2</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">astPositionState1</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">astPositionState2</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstate2d-inout">
<h2>FB_PositionState2D_InOut<a class="headerlink" href="#fb-positionstate2d-inout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionState2D_InOut</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">An</span> <span class="n">example</span> <span class="ow">and</span> <span class="n">usable</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="n">instance</span> <span class="k">for</span> <span class="n">a</span> <span class="mi">2</span><span class="n">D</span> <span class="n">state</span> <span class="n">device</span> <span class="k">with</span> <span class="n">just</span> <span class="n">an</span> <span class="n">IN</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">stages</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">into</span> <span class="n">the</span> <span class="n">FB</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Simplify</span> <span class="n">the</span> <span class="n">interface</span><span class="p">,</span> <span class="n">the</span> <span class="n">user</span> <span class="n">just</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">construct</span> <span class="ow">and</span> <span class="k">pass</span> <span class="ow">in</span> <span class="ow">and</span> <span class="n">out</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">stIn1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stOut1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stIn2</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stOut2</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">a</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">expected</span> <span class="n">this</span> <span class="n">will</span> <span class="n">be</span> <span class="n">written</span> <span class="n">to</span> <span class="n">during</span> <span class="n">one</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">so</span> <span class="n">don</span><span class="s1">&#39;t continually apply a value here in the PLC code.</span>
    <span class="o">//</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">exposed</span> <span class="k">as</span> <span class="n">an</span> <span class="nb">input</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">test</span> <span class="n">it</span> <span class="n">using</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateSet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="n">report</span> <span class="n">the</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateGet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">fb</span> <span class="k">with</span> <span class="n">blank</span> <span class="n">pv</span> <span class="n">pragma</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">fbPositionState2D</span><span class="p">:</span> <span class="n">FB_PositionState2D</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">standard</span> <span class="n">fb</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">full</span> <span class="n">array</span> <span class="n">of</span> <span class="n">position</span> <span class="n">states</span> <span class="n">per</span> <span class="n">motor</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Optional</span><span class="p">:</span> <span class="n">default</span> <span class="n">state</span> <span class="n">names</span>
<span class="n">IF</span> <span class="n">stIn1</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stIn1</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stOut1</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stOut1</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stIn2</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stIn2</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stOut2</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stOut2</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Assemble</span> <span class="n">the</span> <span class="n">states</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">matching</span> <span class="n">the</span> <span class="n">enum</span> <span class="n">values</span> <span class="p">(</span><span class="n">IN</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OUT</span> <span class="ow">is</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn1</span><span class="p">;</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut1</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn2</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut2</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">main</span> <span class="n">function</span> <span class="n">block</span><span class="p">,</span> <span class="n">passing</span> <span class="n">our</span> <span class="n">motors</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">enable</span>
<span class="n">fbPositionState2D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eStateSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eStateGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Send</span> <span class="n">updates</span> <span class="n">made</span> <span class="n">on</span> <span class="n">the</span> <span class="n">array</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">inputs</span> <span class="p">(</span><span class="n">VAR_IN_OUT</span><span class="p">)</span> <span class="k">for</span> <span class="n">maximum</span> <span class="n">clarity</span>
<span class="n">stIn1</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stOut1</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">stIn2</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stOut2</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsinout">E_EpicsInOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate2d">FB_PositionState2D</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstate3d">
<h2>FB_PositionState3D<a class="headerlink" href="#fb-positionstate3d" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionState3D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="mi">3</span><span class="o">-</span><span class="n">Dimensional</span> <span class="n">position</span> <span class="n">state</span> <span class="n">function</span> <span class="n">block</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">move</span> <span class="mi">3</span> <span class="n">motors</span> <span class="n">among</span> <span class="n">some</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">use</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">state</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">give</span> <span class="n">them</span> <span class="n">pytmc</span> <span class="n">pragmas</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">FB_PositionState1D_InOut</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">example</span><span class="o">.</span>
    <span class="n">These</span> <span class="n">enums</span> <span class="n">must</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="ow">and</span> <span class="n">eEnumGet</span> <span class="n">VAR_IN_OUT</span> <span class="n">variables</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">enum</span> <span class="n">values</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">array</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">astPositionState1</span><span class="p">,</span> <span class="n">astPositionState2</span><span class="p">,</span> <span class="ow">and</span> <span class="n">astPositionState3</span><span class="o">.</span>

    <span class="n">A</span> <span class="n">move</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">when</span> <span class="n">eEnumSet</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span> <span class="n">value</span><span class="o">.</span> <span class="n">eEnumSet</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">allowing</span> <span class="n">us</span>
    <span class="n">to</span> <span class="n">accept</span> <span class="n">a</span> <span class="n">new</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">move</span> <span class="n">request</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="n">the</span> <span class="n">first</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motors</span> <span class="n">must</span> <span class="n">already</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">point</span> <span class="n">motion</span> <span class="n">via</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">,</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">work</span> <span class="n">properly</span><span class="o">.</span>

    <span class="n">With</span> <span class="n">no</span> <span class="n">PMPS</span> <span class="n">handling</span><span class="p">,</span> <span class="n">this</span> <span class="n">FB</span> <span class="n">basically</span> <span class="n">just</span> <span class="n">links</span> <span class="n">the</span> <span class="n">state</span> <span class="n">names</span> <span class="k">with</span> <span class="n">positions</span> <span class="ow">in</span> <span class="n">both</span> <span class="n">directions</span> <span class="k">for</span> <span class="nb">set</span> <span class="ow">and</span> <span class="n">readback</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">1</span><span class="n">st</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">3</span><span class="n">rd</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage3</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">1</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="mi">01</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">2</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="mi">02</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">3</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="mi">03</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState3</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage1</span><span class="p">;</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage2</span><span class="p">;</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage3</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState3</span><span class="p">;</span>

<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stMotionStage1</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stMotionStage2</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">stMotionStage3</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="n">astPositionState1</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">astPositionState2</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">astPositionState3</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatebase">
<h2>FB_PositionStateBase<a class="headerlink" href="#fb-positionstatebase" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionState1D instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateBase</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Handles</span> <span class="n">EPICS</span> <span class="n">moves</span> <span class="n">between</span> <span class="n">multiple</span> <span class="n">states</span> <span class="k">for</span> <span class="n">a</span> <span class="n">single</span> <span class="n">axis</span>
    <span class="n">Should</span> <span class="n">be</span> <span class="n">subclassed</span> <span class="k">for</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">enumSet</span> <span class="ow">and</span> <span class="n">enumGet</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">body</span> <span class="n">comment</span>  <span class="ow">or</span> <span class="n">FB_PositionStateInOut</span> <span class="k">for</span> <span class="n">an</span> <span class="n">implementation</span> <span class="n">example</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">start</span> <span class="n">a</span> <span class="n">move</span> <span class="n">when</span> <span class="n">setState</span> <span class="n">transitions</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">number</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">On</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">reset</span> <span class="n">this</span> <span class="n">FB</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RESET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">error</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">ID</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRID</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">error</span> <span class="n">that</span> <span class="n">caused</span> <span class="n">bError</span> <span class="n">to</span> <span class="n">flip</span> <span class="n">TRUE</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRMSG</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">motor</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BUSY</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">last</span> <span class="n">move</span> <span class="n">completed</span> <span class="n">successfully</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DONE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Pre</span><span class="o">-</span><span class="n">allocated</span> <span class="n">array</span> <span class="n">of</span> <span class="n">states</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">arrStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Corresponding</span> <span class="n">arrStates</span> <span class="n">index</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span><span class="p">,</span> <span class="ow">or</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">no</span> <span class="n">move</span> <span class="n">selected</span>
    <span class="n">setState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">we</span> <span class="n">are</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">reach</span><span class="p">,</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="n">goalState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">readback</span> <span class="n">position</span>
    <span class="n">getState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">stUnknown</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stGoal</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbStateMove</span><span class="p">:</span> <span class="n">FB_PositionStateMove</span><span class="p">;</span>
    <span class="n">fbStateInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bNewGoal</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInnerExec</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInnerReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bMoveRequested</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Subclass</span> <span class="n">me</span><span class="p">,</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">to</span> <span class="n">translate</span> <span class="n">setState</span> <span class="ow">and</span> <span class="n">getState</span><span class="p">,</span> <span class="n">call</span> <span class="n">Exec</span>

    <span class="n">Example</span><span class="p">:</span>

    <span class="o">&lt;</span><span class="n">something</span> <span class="n">to</span> <span class="n">fill</span> <span class="n">arrStates</span><span class="o">&gt;</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
    <span class="n">Exec</span><span class="p">();</span>
    <span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
    <span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">Exec</span><span class="p">:</span>
<span class="n">StateHandler</span><span class="p">();</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">StateHandler</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Reset</span> <span class="n">just</span> <span class="n">goes</span> <span class="n">through</span> <span class="n">the</span> <span class="n">first</span><span class="o">-</span><span class="n">cycle</span> <span class="n">init</span> <span class="n">again</span>
<span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bReset</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">First</span><span class="o">-</span><span class="n">cycle</span> <span class="n">init</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorID</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bNewGoal</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goalState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">All</span> <span class="n">state</span> <span class="n">internal</span> <span class="n">handlers</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
        <span class="n">fbStateInternal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">](</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">arrStates</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]);</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">Check</span> <span class="n">where</span> <span class="n">we</span> <span class="n">are</span> <span class="n">by</span> <span class="n">going</span> <span class="n">through</span> <span class="nb">all</span> <span class="n">possible</span> <span class="n">states</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Note</span> <span class="n">this</span> <span class="n">favors</span> <span class="n">the</span> <span class="n">highest</span><span class="o">-</span><span class="n">number</span> <span class="n">state</span> <span class="n">that</span> <span class="n">we</span><span class="s1">&#39;re at, it&#39;</span><span class="n">s</span> <span class="n">up</span> <span class="n">to</span> <span class="n">you</span> <span class="n">to</span> <span class="n">make</span> <span class="n">your</span> <span class="n">states</span> <span class="n">mutually</span> <span class="n">exclusive</span><span class="o">.</span>
<span class="n">getState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">F_AtPositionState</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span> <span class="n">stPositionState</span><span class="o">:=</span><span class="n">arrStates</span><span class="p">[</span><span class="n">nIndex</span><span class="p">])</span> <span class="n">THEN</span>
        <span class="n">getState</span> <span class="o">:=</span> <span class="n">nIndex</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">changing</span> <span class="nb">set</span> <span class="n">pv</span> <span class="k">as</span> <span class="n">a</span> <span class="n">rising</span><span class="o">-</span><span class="n">edge</span> <span class="n">trigger</span>
<span class="n">IF</span> <span class="n">setState</span> <span class="o">&lt;&gt;</span> <span class="n">goalState</span> <span class="n">THEN</span>
    <span class="n">goalState</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>
    <span class="n">bNewGoal</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Special</span> <span class="n">move</span> <span class="n">handling</span> <span class="k">for</span> <span class="n">error</span><span class="o">/</span><span class="n">enable</span> <span class="n">state</span>
<span class="n">IF</span> <span class="n">bError</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">bNewGoal</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="o">//</span> <span class="n">Stop</span> <span class="n">previous</span> <span class="n">move</span> <span class="k">if</span> <span class="n">we</span> <span class="n">were</span> <span class="n">already</span> <span class="n">moving</span> <span class="n">but</span> <span class="n">want</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span>
        <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="o">//</span> <span class="n">If</span> <span class="n">we</span> <span class="n">hit</span> <span class="n">this</span> <span class="n">branch</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;re ready to start a new move</span>
        <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bNewGoal</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Pick</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">goal</span> <span class="n">structure</span> <span class="ow">or</span> <span class="n">Unknown</span>
<span class="n">IF</span> <span class="n">goalState</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stGoal</span> <span class="o">:=</span> <span class="n">stUnknown</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">stGoal</span> <span class="o">:=</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">goalState</span><span class="p">];</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Do</span> <span class="n">the</span> <span class="n">move</span>
<span class="n">fbStateMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span> <span class="o">:=</span> <span class="n">stGoal</span><span class="p">,</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bInnerExec</span><span class="p">,</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">bInnerReset</span><span class="p">,</span>
    <span class="n">enumMotionRequest</span> <span class="o">:=</span> <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="p">,</span>
    <span class="n">bBusy</span> <span class="o">=&gt;</span> <span class="n">bBusy</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Only</span> <span class="k">pass</span> <span class="n">up</span> <span class="n">bDone</span> <span class="n">information</span> <span class="k">if</span> <span class="n">this</span> <span class="n">FB</span> <span class="ow">is</span> <span class="n">active</span>
<span class="n">IF</span> <span class="n">bInnerExec</span> <span class="n">THEN</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">bDone</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Pick</span> <span class="n">up</span> <span class="nb">any</span> <span class="n">new</span> <span class="n">errors</span><span class="p">,</span> <span class="n">but</span> <span class="n">don</span><span class="s1">&#39;t override uncleared existing errors</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">bError</span> <span class="n">THEN</span>
        <span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
        <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">setpoint</span> <span class="ow">and</span> <span class="n">goal</span> <span class="n">to</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re not doing anything</span>
<span class="o">//</span> <span class="n">because</span> <span class="n">FB</span> <span class="ow">is</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">a</span> <span class="n">change</span> <span class="kn">from</span> <span class="mi">0</span> <span class="n">to</span> <span class="s2">&quot;something&quot;</span>
<span class="n">bMoveRequested</span> <span class="o">:=</span> <span class="n">bInnerExec</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bDone</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bNewGoal</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bMoveRequested</span> <span class="n">THEN</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goalState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Bring</span> <span class="n">inner</span> <span class="n">reset</span> <span class="n">back</span> <span class="n">low</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">the</span> <span class="n">init</span> <span class="n">cycle</span> <span class="n">so</span> <span class="n">that</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span> <span class="n">triggered</span> <span class="n">again</span> <span class="n">later</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinout">FB_PositionStateInOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemove">FB_PositionStateMove</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatebase-withpmps">
<h2>FB_PositionStateBase_WithPMPS<a class="headerlink" href="#fb-positionstatebase-withpmps" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionStatePMPS1D instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateBase_WithPMPS</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStateBase</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Handles</span> <span class="n">EPICS</span> <span class="n">moves</span> <span class="n">between</span> <span class="n">multiple</span> <span class="n">states</span> <span class="k">for</span> <span class="n">a</span> <span class="n">single</span> <span class="n">axis</span> <span class="k">with</span> <span class="n">PMPS</span><span class="o">.</span>
    <span class="n">Should</span> <span class="n">be</span> <span class="n">subclassed</span> <span class="k">for</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">enumSet</span> <span class="ow">and</span> <span class="n">enumGet</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">body</span> <span class="n">comment</span>  <span class="ow">or</span> <span class="n">FB_PositionStateInOut_WithPMPS</span> <span class="k">for</span> <span class="n">an</span> <span class="n">implementation</span> <span class="n">example</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sPmpsDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PMPS</span><span class="p">:</span><span class="n">ARB</span><span class="p">:</span><span class="n">ENABLE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">bArbiterEnabled</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">tArbiterTimeout</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1s;</span>
    <span class="n">bMoveOnArbiterTimeout</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fStateBoundaryDeadband</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bBPOKAutoReset</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="kc">False</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: PMPS&#39;</span><span class="p">}</span>
    <span class="n">fbStatePMPS</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS</span><span class="p">;</span>
    <span class="n">fbEncErrFFO</span><span class="p">:</span> <span class="n">FB_EncErrorFFO</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Subclass</span> <span class="n">me</span><span class="p">,</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">to</span> <span class="n">translate</span> <span class="n">setState</span> <span class="ow">and</span> <span class="n">getState</span><span class="p">,</span> <span class="n">call</span> <span class="n">Exec</span>

    <span class="n">Example</span><span class="p">:</span>

    <span class="o">&lt;</span><span class="n">something</span> <span class="n">to</span> <span class="n">fill</span> <span class="n">arrStates</span><span class="o">&gt;</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
    <span class="n">Exec</span><span class="p">();</span>
    <span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
    <span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">Exec</span><span class="p">:</span>
<span class="n">StateHandler</span><span class="p">();</span>
<span class="n">PMPSHandler</span><span class="p">();</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">PMPSHandler</span><span class="p">:</span>
<span class="n">fbStatePMPS</span><span class="p">(</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">arrStates</span><span class="o">:=</span><span class="n">arrStates</span><span class="p">,</span>
    <span class="n">sPmpsDeviceName</span><span class="o">:=</span><span class="n">sPmpsDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">stPmpsDoc</span><span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">BP_jsonDoc</span><span class="p">,</span>
    <span class="n">bRequestTransition</span><span class="o">:=</span><span class="n">setState</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">setState</span><span class="o">:=</span><span class="n">setState</span><span class="p">,</span>
    <span class="n">getState</span><span class="o">:=</span><span class="n">getState</span><span class="p">,</span>
    <span class="n">bArbiterEnabled</span><span class="o">:=</span><span class="n">bArbiterEnabled</span><span class="p">,</span>
    <span class="n">tArbiterTimeout</span><span class="o">:=</span><span class="n">tArbiterTimeout</span><span class="p">,</span>
    <span class="n">bMoveOnArbiterTimeout</span><span class="o">:=</span><span class="n">bMoveOnArbiterTimeout</span><span class="p">,</span>
    <span class="n">fStateBoundaryDeadband</span><span class="o">:=</span><span class="n">fStateBoundaryDeadband</span><span class="p">,</span>
    <span class="n">bBPOKAutoReset</span><span class="o">:=</span><span class="n">bBPOKAutoReset</span><span class="p">);</span>

<span class="n">fbEncErrFFO</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-encerrorffo">FB_EncErrorFFO</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatebase">FB_PositionStateBase</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinout-withpmps">FB_PositionStateInOut_WithPMPS</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps">FB_PositionStatePMPS</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatebase-withpmps-test">
<h2>FB_PositionStateBase_WithPMPS_Test<a class="headerlink" href="#fb-positionstatebase-withpmps-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;No longer any reason to use this, all state classes can have unit tests.&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateBase_WithPMPS_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStateBase</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Handles</span> <span class="n">EPICS</span> <span class="n">moves</span> <span class="n">between</span> <span class="n">multiple</span> <span class="n">states</span> <span class="k">for</span> <span class="n">a</span> <span class="n">single</span> <span class="n">axis</span> <span class="k">with</span> <span class="n">fake</span> <span class="n">PMPS</span><span class="o">.</span>
    <span class="n">Should</span> <span class="n">be</span> <span class="n">subclassed</span> <span class="k">for</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">enumSet</span> <span class="ow">and</span> <span class="n">enumGet</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">body</span> <span class="n">comment</span>  <span class="ow">or</span> <span class="n">FB_PositionStateInOut_WithPMPS_Test</span> <span class="k">for</span> <span class="n">an</span> <span class="n">implementation</span> <span class="n">example</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">stTransitionBeam</span><span class="p">:</span> <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">;</span>
    <span class="n">nTransitionAssertionID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbStatePMPS</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS_Test</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Subclass</span> <span class="n">me</span><span class="p">,</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">to</span> <span class="n">translate</span> <span class="n">setState</span> <span class="ow">and</span> <span class="n">getState</span><span class="p">,</span> <span class="n">call</span> <span class="n">Exec</span>

    <span class="n">Example</span><span class="p">:</span>

    <span class="o">&lt;</span><span class="n">something</span> <span class="n">to</span> <span class="n">fill</span> <span class="n">arrStates</span><span class="o">&gt;</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
    <span class="n">Exec</span><span class="p">();</span>
    <span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
    <span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">Exec</span><span class="p">:</span>
<span class="n">StateHandler</span><span class="p">();</span>
<span class="n">PMPSHandler</span><span class="p">();</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">PMPSHandler</span><span class="p">:</span>
<span class="n">fbStatePMPS</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">arrStates</span><span class="o">:=</span><span class="n">arrStates</span><span class="p">,</span>
    <span class="n">bRequestTransition</span><span class="o">:=</span><span class="n">setState</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">setState</span><span class="o">:=</span><span class="n">setState</span><span class="p">,</span>
    <span class="n">getState</span><span class="o">:=</span><span class="n">getState</span><span class="p">);</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstatebase">FB_PositionStateBase</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinout-withpmps-test">FB_PositionStateInOut_WithPMPS_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps-test">FB_PositionStatePMPS_Test</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateinout">
<h2>FB_PositionStateInOut<a class="headerlink" href="#fb-positionstateinout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionState1D_InOut instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateInOut</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStateBase</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Example</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">FB_PositionStateBase</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">IN</span><span class="o">/</span><span class="n">OUT</span> <span class="n">axis</span><span class="o">.</span> <span class="n">See</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">comments</span><span class="o">.</span>
    <span class="n">Also</span> <span class="n">usable</span> <span class="k">as</span> <span class="n">a</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">these</span> <span class="n">cases</span> <span class="p">(</span><span class="n">no</span> <span class="n">need</span> <span class="n">to</span> <span class="n">roll</span> <span class="n">your</span> <span class="n">own</span> <span class="ow">in</span><span class="o">/</span><span class="n">out</span><span class="p">)</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enum</span> <span class="n">position</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumSet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumSet</span>

    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">position</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">pragma</span> <span class="n">these</span><span class="p">,</span> <span class="n">let</span> <span class="n">it</span> <span class="n">happen</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">manager</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">IN</span> <span class="n">position</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enum</span> <span class="n">state</span> <span class="n">readback</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumGet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumGet</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInOutInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInOutInit</span> <span class="n">THEN</span>
    <span class="n">bInOutInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>
    <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
    <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
<span class="n">Exec</span><span class="p">();</span>
<span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
<span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-epicsinout-int">ENUM_EpicsInOut_INT</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatebase">FB_PositionStateBase</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateinout-withpmps">
<h2>FB_PositionStateInOut_WithPMPS<a class="headerlink" href="#fb-positionstateinout-withpmps" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionStatePMPS1D_InOut instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateInOut_WithPMPS</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStateBase_WithPMPS</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Example</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">FB_PositionStateBase_WithPMPS</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">IN</span><span class="o">/</span><span class="n">OUT</span> <span class="n">axis</span><span class="o">.</span> <span class="n">See</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">comments</span><span class="o">.</span>
    <span class="n">Also</span> <span class="n">usable</span> <span class="k">as</span> <span class="n">a</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">these</span> <span class="n">cases</span> <span class="p">(</span><span class="n">no</span> <span class="n">need</span> <span class="n">to</span> <span class="n">roll</span> <span class="n">your</span> <span class="n">own</span> <span class="ow">in</span><span class="o">/</span><span class="n">out</span><span class="p">)</span>

    <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">version</span><span class="o">.</span> <span class="n">Note</span> <span class="n">that</span> <span class="n">the</span> <span class="n">only</span> <span class="n">difference</span> <span class="ow">is</span> <span class="n">that</span> <span class="n">we</span> <span class="n">extend</span> <span class="n">the</span> <span class="n">_WithPMPS</span> <span class="n">FB</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enum</span> <span class="n">position</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumSet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumSet</span>

    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">position</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">pragma</span> <span class="n">these</span><span class="p">,</span> <span class="n">let</span> <span class="n">it</span> <span class="n">happen</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">manager</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">IN</span> <span class="n">position</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enum</span> <span class="n">state</span> <span class="n">readback</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumGet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumGet</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInOutInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInOutInit</span> <span class="n">THEN</span>
    <span class="n">bInOutInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>
    <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
    <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
<span class="n">Exec</span><span class="p">();</span>
<span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
<span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-epicsinout-int">ENUM_EpicsInOut_INT</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatebase-withpmps">FB_PositionStateBase_WithPMPS</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d-inout">FB_PositionStatePMPS1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateinout-withpmps-test">
<h2>FB_PositionStateInOut_WithPMPS_Test<a class="headerlink" href="#fb-positionstateinout-withpmps-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;No longer any reason to use this, all state classes can have unit tests.&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateInOut_WithPMPS_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStateBase_WithPMPS_Test</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Example</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">FB_PositionStateBase_WithPMPS_Test</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">IN</span><span class="o">/</span><span class="n">OUT</span> <span class="n">axis</span><span class="o">.</span> <span class="n">See</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">comments</span><span class="o">.</span>
    <span class="n">Also</span> <span class="n">usable</span> <span class="k">as</span> <span class="n">a</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">these</span> <span class="n">cases</span> <span class="p">(</span><span class="n">no</span> <span class="n">need</span> <span class="n">to</span> <span class="n">roll</span> <span class="n">your</span> <span class="n">own</span> <span class="ow">in</span><span class="o">/</span><span class="n">out</span><span class="p">)</span>

    <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">version</span><span class="o">.</span> <span class="n">Note</span> <span class="n">that</span> <span class="n">the</span> <span class="n">only</span> <span class="n">difference</span> <span class="ow">is</span> <span class="n">that</span> <span class="n">we</span> <span class="n">extend</span> <span class="n">the</span> <span class="n">_WithPMPS_Test</span> <span class="n">FB</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enum</span> <span class="n">position</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumSet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumSet</span>

    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">position</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">pragma</span> <span class="n">these</span><span class="p">,</span> <span class="n">let</span> <span class="n">it</span> <span class="n">happen</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">manager</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">Information</span> <span class="n">about</span> <span class="n">the</span> <span class="n">IN</span> <span class="n">position</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enum</span> <span class="n">state</span> <span class="n">readback</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumGet</span><span class="p">:</span> <span class="n">ENUM_EpicsInOut_INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">Please</span> <span class="n">copy</span> <span class="n">this</span> <span class="n">pragma</span> <span class="n">exactly</span> <span class="n">on</span> <span class="n">your</span> <span class="n">enumGet</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInOutInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInOutInit</span> <span class="n">THEN</span>
    <span class="n">bInOutInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>
    <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
    <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
<span class="n">Exec</span><span class="p">();</span>
<span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
<span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-epicsinout-int">ENUM_EpicsInOut_INT</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatebase-withpmps-test">FB_PositionStateBase_WithPMPS_Test</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateinternal">
<h2>FB_PositionStateInternal<a class="headerlink" href="#fb-positionstateinternal" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateInternal</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Routines</span> <span class="n">that</span> <span class="n">must</span> <span class="n">be</span> <span class="n">called</span> <span class="n">on</span> <span class="nb">all</span> <span class="n">ST_PositionState</span>

    <span class="n">Currently</span><span class="p">,</span> <span class="n">this</span> <span class="n">FB</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">ensures</span> <span class="n">that</span> <span class="n">a</span> <span class="n">position</span> <span class="n">state</span> <span class="n">has</span> <span class="n">both</span> <span class="n">a</span> <span class="n">proper</span> <span class="n">encoder</span> <span class="n">count</span>
      <span class="ow">and</span> <span class="n">a</span> <span class="n">proper</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">engineering</span> <span class="n">units</span> <span class="k">with</span> <span class="n">both</span> <span class="n">of</span> <span class="n">these</span> <span class="n">quantities</span> <span class="n">matching</span>
    <span class="o">-</span> <span class="n">handles</span> <span class="n">the</span> <span class="n">parameter</span> <span class="n">locking</span> <span class="n">feature</span><span class="p">,</span> <span class="n">which</span> <span class="n">nominally</span> <span class="n">prevents</span> <span class="n">the</span> <span class="n">user</span> <span class="kn">from</span> <span class="nn">changing</span>
      <span class="n">details</span> <span class="n">about</span> <span class="n">a</span> <span class="n">locked</span> <span class="n">state</span> <span class="n">via</span> <span class="n">EPICS</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbEncConverter</span><span class="p">:</span> <span class="n">FB_RawCountConverter</span><span class="p">;</span>
    <span class="n">fbLock</span><span class="p">:</span> <span class="n">FB_PositionStateLock</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Mark</span> <span class="n">that</span> <span class="n">we</span><span class="s1">&#39;ve been here</span>
<span class="n">stPositionState</span><span class="o">.</span><span class="n">bUpdated</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Update</span> <span class="n">pos</span> <span class="n">state</span><span class="s1">&#39;s count or egu position as appropriate</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAxisParamsInit</span> <span class="n">THEN</span>
    <span class="n">fbEncConverter</span><span class="p">(</span>
        <span class="n">stParameters</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="p">,</span>
        <span class="n">nCountCheck</span><span class="o">:=</span><span class="n">stPositionState</span><span class="o">.</span><span class="n">nEncoderCount</span><span class="p">,</span>
        <span class="n">fPosCheck</span><span class="o">:=</span><span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="n">THEN</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fbEncConverter</span><span class="o">.</span><span class="n">fPosGet</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">fbEncConverter</span><span class="o">.</span><span class="n">nCountGet</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Handle</span> <span class="n">state</span> <span class="n">parameter</span> <span class="n">locking</span>
<span class="n">fbLock</span><span class="p">(</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAxisParamsInit</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstatelock">FB_PositionStateLock</a></p></li>
<li><p><a class="reference internal" href="#fb-rawcountconverter">FB_RawCountConverter</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateinternalnd">
<h2>FB_PositionStateInternalND<a class="headerlink" href="#fb-positionstateinternalnd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateInternalND</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Given</span> <span class="n">a</span> <span class="n">standard</span> <span class="n">ND</span> <span class="n">state</span> <span class="n">setup</span><span class="p">,</span> <span class="n">call</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">required</span> <span class="n">state</span> <span class="n">management</span> <span class="n">FBs</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">apply</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">routines</span> <span class="n">to</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Each</span> <span class="n">motor</span><span class="s1">&#39;s respective position states along its direction</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">individual</span> <span class="n">instantiated</span> <span class="n">internal</span> <span class="n">FBs</span><span class="o">.</span> <span class="n">Must</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">bounds</span> <span class="k">as</span> <span class="n">astPositionState</span><span class="o">.</span>
    <span class="n">afbStateInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">nIterMotors</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nIterStates</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">FOR</span> <span class="n">nIterMotors</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span> <span class="n">DO</span>
    <span class="n">FOR</span> <span class="n">nIterStates</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
        <span class="n">afbStateInternal</span><span class="p">[</span><span class="n">nIterMotors</span><span class="p">][</span><span class="n">nIterStates</span><span class="p">](</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIterMotors</span><span class="p">],</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIterMotors</span><span class="p">][</span><span class="n">nIterStates</span><span class="p">],</span>
        <span class="p">);</span>
    <span class="n">END_FOR</span>
<span class="n">END_FOR</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatelock">
<h2>FB_PositionStateLock<a class="headerlink" href="#fb-positionstatelock" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateLock</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Implements</span> <span class="n">immutability</span> <span class="k">for</span> <span class="n">a</span> <span class="n">locked</span> <span class="n">ST_PositionState</span>
    <span class="n">Once</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">called</span> <span class="n">the</span> <span class="n">first</span> <span class="n">time</span><span class="p">,</span> <span class="n">the</span> <span class="n">parameters</span> <span class="n">at</span> <span class="n">the</span> <span class="n">time</span> <span class="n">of</span> <span class="n">the</span> <span class="n">call</span> <span class="n">will</span> <span class="n">be</span> <span class="n">restored</span> <span class="n">on</span> <span class="nb">all</span> <span class="n">subsequent</span> <span class="n">calls</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">stCachedPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Force</span> <span class="n">values</span> <span class="n">to</span> <span class="n">be</span> <span class="n">cached</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;ve cached something</span>
    <span class="n">IF</span> <span class="n">bInit</span> <span class="n">AND</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bLocked</span> <span class="n">THEN</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">sName</span><span class="p">;</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fAccel</span><span class="p">;</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">:=</span> <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fDecel</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">we</span> <span class="n">haven</span><span class="s1">&#39;t cached and we should, make the cache. Note that we skip bLocked, bValid, and bMoveOk</span>
    <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">AND</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bLocked</span> <span class="n">THEN</span>
        <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">sName</span><span class="p">;</span>
        <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
        <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
        <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fAccel</span><span class="p">;</span>
        <span class="n">stCachedPositionState</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDecel</span><span class="p">;</span>
        <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Do</span> <span class="n">nothing</span><span class="p">,</span> <span class="ow">or</span> <span class="n">unlock</span> <span class="n">the</span> <span class="n">state</span> <span class="k">if</span> <span class="n">bLocked</span> <span class="n">goes</span> <span class="n">FALSE</span>
    <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bLocked</span> <span class="n">THEN</span>
        <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatemanager">
<h2>FB_PositionStateManager<a class="headerlink" href="#fb-positionstatemanager" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionState1D instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateManager</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Handles</span> <span class="n">EPICS</span> <span class="n">moves</span> <span class="n">between</span> <span class="n">multiple</span> <span class="n">states</span> <span class="k">for</span> <span class="n">a</span> <span class="n">single</span> <span class="n">axis</span>
    <span class="n">Should</span> <span class="n">be</span> <span class="n">wrapped</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">block</span> <span class="k">with</span> <span class="n">enums</span> <span class="k">for</span> <span class="n">states</span><span class="p">,</span>
    <span class="n">see</span> <span class="n">FB_EpicsInOut</span> <span class="k">for</span> <span class="n">an</span> <span class="n">example</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Allocated</span> <span class="n">space</span> <span class="k">for</span> <span class="mi">15</span> <span class="n">states</span> <span class="n">besides</span> <span class="n">Unknown</span> <span class="p">(</span><span class="mi">16</span> <span class="ow">is</span> <span class="n">the</span> <span class="nb">max</span> <span class="k">for</span> <span class="n">an</span> <span class="n">EPICS</span> <span class="n">MBBI</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">arrStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..15</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Corresponding</span> <span class="n">arrStates</span> <span class="n">index</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span><span class="p">,</span> <span class="ow">or</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">no</span> <span class="n">move</span> <span class="n">selected</span>
    <span class="n">setState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">start</span> <span class="n">a</span> <span class="n">move</span> <span class="n">when</span> <span class="n">setState</span> <span class="n">transitions</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">number</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">On</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">reset</span> <span class="n">this</span> <span class="n">FB</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RESET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">error</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Error</span> <span class="n">ID</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRID</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">error</span> <span class="n">that</span> <span class="n">caused</span> <span class="n">bError</span> <span class="n">to</span> <span class="n">flip</span> <span class="n">TRUE</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRMSG</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">motor</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BUSY</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">moving</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">last</span> <span class="n">move</span> <span class="n">completed</span> <span class="n">successfully</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DONE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">we</span> <span class="n">are</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">reach</span><span class="p">,</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="n">goalState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">readback</span> <span class="n">position</span>
    <span class="n">getState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">stUnknown</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stGoal</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbStateMove</span><span class="p">:</span> <span class="n">FB_PositionStateMove</span><span class="p">;</span>
    <span class="n">fbStateInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..15</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bNewGoal</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInnerExec</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInnerReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bMoveRequested</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Reset</span> <span class="n">just</span> <span class="n">goes</span> <span class="n">through</span> <span class="n">the</span> <span class="n">first</span><span class="o">-</span><span class="n">cycle</span> <span class="n">init</span> <span class="n">again</span>
<span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bReset</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">First</span><span class="o">-</span><span class="n">cycle</span> <span class="n">init</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bNewGoal</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goalState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">All</span> <span class="n">state</span> <span class="n">internal</span> <span class="n">handlers</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">15</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
        <span class="n">fbStateInternal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">](</span>
            <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
            <span class="n">stPositionState</span><span class="o">:=</span><span class="n">arrStates</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]);</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">Check</span> <span class="n">where</span> <span class="n">we</span> <span class="n">are</span> <span class="n">by</span> <span class="n">going</span> <span class="n">through</span> <span class="nb">all</span> <span class="n">possible</span> <span class="n">states</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Note</span> <span class="n">this</span> <span class="n">favors</span> <span class="n">the</span> <span class="n">highest</span><span class="o">-</span><span class="n">number</span> <span class="n">state</span> <span class="n">that</span> <span class="n">we</span><span class="s1">&#39;re at, it&#39;</span><span class="n">s</span> <span class="n">up</span> <span class="n">to</span> <span class="n">you</span> <span class="n">to</span> <span class="n">make</span> <span class="n">your</span> <span class="n">states</span> <span class="n">mutually</span> <span class="n">exclusive</span><span class="o">.</span>
<span class="n">getState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">15</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">F_AtPositionState</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span> <span class="n">stPositionState</span><span class="o">:=</span><span class="n">arrStates</span><span class="p">[</span><span class="n">nIndex</span><span class="p">])</span> <span class="n">THEN</span>
        <span class="n">getState</span> <span class="o">:=</span> <span class="n">nIndex</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">changing</span> <span class="nb">set</span> <span class="n">pv</span> <span class="k">as</span> <span class="n">a</span> <span class="n">rising</span><span class="o">-</span><span class="n">edge</span> <span class="n">trigger</span>
<span class="n">IF</span> <span class="n">setState</span> <span class="o">&lt;&gt;</span> <span class="n">goalState</span> <span class="n">THEN</span>
    <span class="n">goalState</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>
    <span class="n">bNewGoal</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Special</span> <span class="n">move</span> <span class="n">handling</span> <span class="k">for</span> <span class="n">error</span><span class="o">/</span><span class="n">enable</span> <span class="n">state</span>
<span class="n">IF</span> <span class="n">bError</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Reset</span> <span class="n">inner</span> <span class="n">block</span> <span class="n">this</span> <span class="n">cycle</span> <span class="k">if</span> <span class="n">we</span> <span class="n">were</span> <span class="n">already</span> <span class="n">moving</span> <span class="n">but</span> <span class="n">want</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span>
<span class="n">ELSIF</span> <span class="n">bInnerExec</span> <span class="n">AND</span> <span class="n">bNewGoal</span> <span class="n">THEN</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">we</span> <span class="n">hit</span> <span class="n">this</span> <span class="n">branch</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;re starting a new move</span>
<span class="n">ELSIF</span> <span class="n">bNewGoal</span> <span class="n">THEN</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bNewGoal</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Pick</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">goal</span> <span class="n">structure</span> <span class="ow">or</span> <span class="n">Unknown</span>
<span class="n">IF</span> <span class="n">goalState</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stGoal</span> <span class="o">:=</span> <span class="n">stUnknown</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">stGoal</span> <span class="o">:=</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">goalState</span><span class="p">];</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Do</span> <span class="n">the</span> <span class="n">move</span>
<span class="n">fbStateMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span> <span class="o">:=</span> <span class="n">stGoal</span><span class="p">,</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bInnerExec</span><span class="p">,</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">bInnerReset</span><span class="p">,</span>
    <span class="n">enumMotionRequest</span> <span class="o">:=</span> <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="p">,</span>
    <span class="n">bBusy</span> <span class="o">=&gt;</span> <span class="n">bBusy</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Only</span> <span class="k">pass</span> <span class="n">up</span> <span class="n">bDone</span> <span class="n">information</span> <span class="k">if</span> <span class="n">this</span> <span class="n">FB</span> <span class="ow">is</span> <span class="n">active</span>
<span class="n">IF</span> <span class="n">bInnerExec</span> <span class="n">THEN</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">bDone</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Pick</span> <span class="n">up</span> <span class="nb">any</span> <span class="n">new</span> <span class="n">errors</span><span class="p">,</span> <span class="n">but</span> <span class="n">don</span><span class="s1">&#39;t override uncleared existing errors</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">fbStateMove</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">setpoint</span> <span class="ow">and</span> <span class="n">goal</span> <span class="n">to</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re not doing anything</span>
<span class="o">//</span> <span class="n">because</span> <span class="n">FB</span> <span class="ow">is</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">a</span> <span class="n">change</span> <span class="kn">from</span> <span class="mi">0</span> <span class="n">to</span> <span class="s2">&quot;something&quot;</span>
<span class="n">bMoveRequested</span> <span class="o">:=</span> <span class="n">bInnerExec</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bDone</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bNewGoal</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bMoveRequested</span> <span class="n">THEN</span>
    <span class="n">setState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goalState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bInnerExec</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Bring</span> <span class="n">inner</span> <span class="n">reset</span> <span class="n">back</span> <span class="n">low</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">the</span> <span class="n">init</span> <span class="n">cycle</span> <span class="n">so</span> <span class="n">that</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span> <span class="n">triggered</span> <span class="n">again</span> <span class="n">later</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bInnerReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-epicsinout">FB_EpicsInOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemove">FB_PositionStateMove</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatemove">
<h2>FB_PositionStateMove<a class="headerlink" href="#fb-positionstatemove" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateMove</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Request</span> <span class="n">a</span> <span class="n">move</span> <span class="n">to</span> <span class="n">a</span> <span class="n">particular</span> <span class="n">state</span> <span class="kn">from</span> <span class="nn">an</span> <span class="n">axis</span> <span class="n">controlled</span> <span class="n">via</span> <span class="n">EPICS</span>
    <span class="n">pytmc</span> <span class="n">PVs</span> <span class="n">here</span> <span class="n">only</span> <span class="n">exposed</span> <span class="k">if</span> <span class="n">using</span> <span class="n">directly</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">through</span> <span class="n">another</span> <span class="n">states</span> <span class="n">function</span> <span class="n">block</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">State</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">move</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">stop</span> <span class="n">move</span> <span class="n">on</span> <span class="n">falling</span> <span class="n">edge</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GO</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Rising</span> <span class="n">edge</span> <span class="n">error</span> <span class="n">reset</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RESET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Define</span> <span class="n">behavior</span> <span class="k">for</span> <span class="n">when</span> <span class="n">a</span> <span class="n">move</span> <span class="ow">is</span> <span class="n">already</span> <span class="n">active</span>
    <span class="n">enumMotionRequest</span><span class="p">:</span> <span class="n">E_MotionRequest</span> <span class="o">:=</span> <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">WAIT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">at</span> <span class="n">this</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">AT_STATE</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bAtState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span> <span class="n">have</span> <span class="n">an</span> <span class="n">error</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Error</span> <span class="n">code</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRID</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">nErrorID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Error</span> <span class="n">description</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRMSG</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="n">moving</span> <span class="n">to</span> <span class="n">a</span> <span class="n">state</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BUSY</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">moving</span> <span class="ow">and</span> <span class="n">we</span> <span class="n">reached</span> <span class="n">a</span> <span class="n">state</span> <span class="n">successfully</span> <span class="n">on</span> <span class="n">our</span> <span class="n">last</span> <span class="n">move</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DONE</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbMotionRequest</span><span class="p">:</span> <span class="n">FB_MotionRequest</span><span class="p">;</span>
    <span class="n">bAllowMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Veto</span> <span class="n">the</span> <span class="n">move</span> <span class="k">for</span> <span class="n">uninitialized</span> <span class="ow">and</span> <span class="n">unsafe</span> <span class="n">states</span>
<span class="n">bAllowMove</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="n">AND</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Do</span> <span class="n">the</span> <span class="n">move</span>
<span class="n">fbMotionRequest</span><span class="p">(</span>
    <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">bAllowMove</span><span class="p">,</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">bReset</span><span class="p">,</span>
    <span class="n">enumMotionRequest</span> <span class="o">:=</span> <span class="n">enumMotionRequest</span><span class="p">,</span>
    <span class="n">fPos</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fVel</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="n">fAcc</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fAccel</span><span class="p">,</span>
    <span class="n">fDec</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDecel</span><span class="p">,</span>
    <span class="n">bError</span> <span class="o">=&gt;</span> <span class="n">bError</span><span class="p">,</span>
    <span class="n">nErrorId</span> <span class="o">=&gt;</span> <span class="n">nErrorId</span><span class="p">,</span>
    <span class="n">sErrorMessage</span> <span class="o">=&gt;</span> <span class="n">sErrorMessage</span><span class="p">,</span>
    <span class="n">bBusy</span> <span class="o">=&gt;</span> <span class="n">bBusy</span><span class="p">,</span>
    <span class="n">bDone</span> <span class="o">=&gt;</span> <span class="n">bDone</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Inject</span> <span class="n">custom</span> <span class="n">error</span> <span class="k">if</span> <span class="n">we</span> <span class="n">can</span><span class="s1">&#39;t move because of bMoveOk or bValid</span>
<span class="n">IF</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bAllowMove</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
        <span class="n">nErrorId</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#7901;</span>
    <span class="n">ELSE</span>
        <span class="n">nErrorId</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#7902;</span>
    <span class="n">END_IF</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">F_MotionErrorCodeLookup</span><span class="p">(</span><span class="n">nErrorId</span> <span class="o">:=</span> <span class="n">nErrorID</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">This</span> <span class="n">can</span> <span class="n">be</span> <span class="n">useful</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re running this FB standalone for some reason</span>
<span class="n">bAtState</span> <span class="o">:=</span> <span class="n">F_AtPositionState</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span> <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPositionState</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-motionrequest">FB_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#f-motionerrorcodelookup">F_MotionErrorCodeLookup</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatemove-test">
<h2>FB_PositionStateMove_Test<a class="headerlink" href="#fb-positionstatemove-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateMove_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">that</span> <span class="n">FB_PositionStateMove</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">move</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span>
    <span class="n">And</span> <span class="n">that</span> <span class="n">the</span> <span class="n">API</span> <span class="n">behaves</span> <span class="n">exactly</span> <span class="k">as</span> <span class="n">described</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">stDummyPos</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stInvalid</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stNotUpdated</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stUnsafe</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_PositionStateMove</span><span class="p">;</span>

    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fTestStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bStatesReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;UNO&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;DOS&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TRES&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

<span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="n">stInvalid</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">stInvalid</span><span class="o">.</span><span class="n">bUpdated</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stInvalid</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stNotUpdated</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stNotUpdated</span><span class="o">.</span><span class="n">bUpdated</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">stNotUpdated</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stUnsafe</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stUnsafe</span><span class="o">.</span><span class="n">bUpdated</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stUnsafe</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">nTestCounter</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t run any tests until the states are ready</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Warm</span> <span class="n">up</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">FB</span> <span class="k">with</span> <span class="n">a</span> <span class="n">exec</span> <span class="n">false</span> <span class="n">runthrough</span>
    <span class="n">fbMove</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Test</span> <span class="n">that</span> <span class="n">we</span> <span class="n">can</span> <span class="n">move</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">outputs</span> <span class="n">are</span> <span class="n">correct</span> <span class="k">as</span> <span class="n">we</span> <span class="n">go</span>
<span class="n">TestMove</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Test</span> <span class="n">that</span> <span class="n">we</span> <span class="n">can</span> <span class="n">move</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">outputs</span> <span class="n">are</span> <span class="n">correct</span> <span class="k">as</span> <span class="n">we</span> <span class="n">go</span>
<span class="n">TestMove</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Test</span> <span class="n">that</span> <span class="n">we</span> <span class="n">can</span> <span class="n">interrupt</span> <span class="n">a</span> <span class="n">move</span> <span class="n">to</span> <span class="n">state</span> <span class="mi">3</span> <span class="n">by</span> <span class="n">dropping</span> <span class="n">bExecute</span>
<span class="n">TestMove</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Test</span> <span class="n">that</span> <span class="n">we</span> <span class="n">cannot</span> <span class="n">move</span> <span class="n">to</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">state</span>
<span class="n">TestBadStates</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fbMove</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="n">bReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbMove</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="n">bReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bStatesReady</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestBadStates</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;TestInvalid&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nTestIndex</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIndex</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Started with an error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stInvalid</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Invalid should have given an error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stInvalid</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Started with an error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stNotUpdated</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Not updated should have given an error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stNotUpdated</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Started with an error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stUnsafe</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="s1">&#39;Unsafe should have given an error&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestMove</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nStateIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bInterrupt</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">bLocalInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInterruptStarted</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;TestMove&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nTestIndex</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIndex</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLocalInit</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Starting</span> <span class="n">output</span> <span class="n">checks</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Tried to start test with busy motor&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Tried to start test with errored motor&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bLocalInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bInterruptStarted</span> <span class="n">S</span><span class="o">=</span> <span class="n">bInterrupt</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nStateIndex</span><span class="p">],</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInterruptStarted</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bDone</span> <span class="n">OR</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bInterruptStarted</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Test timed out&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">IF</span> <span class="n">bInterrupt</span> <span class="n">THEN</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">fbMove</span><span class="o">.</span><span class="n">bAtState</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Should have been interrupted, but made it to the goal&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbMove</span><span class="o">.</span><span class="n">bAtState</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not end at the state&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
            <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not reach the goal state&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="n">END_IF</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Was busy while done&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Should not end in error: &#39;</span><span class="p">,</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">),</span>
    <span class="p">);</span>

    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bLocalInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bInterruptStarted</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemove">FB_PositionStateMove</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatemovend">
<h2>FB_PositionStateMoveND<a class="headerlink" href="#fb-positionstatemovend" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateMoveND</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">coordinates</span> <span class="n">multidimensional</span> <span class="n">state</span> <span class="n">moves</span> <span class="k">for</span> <span class="n">groups</span> <span class="n">of</span> <span class="n">motors</span><span class="o">.</span>
    <span class="n">It</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">building</span> <span class="n">block</span> <span class="ow">not</span> <span class="n">meant</span> <span class="k">for</span> <span class="n">use</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">lcls</span><span class="o">-</span><span class="n">twintcat</span><span class="o">-</span><span class="n">motion</span><span class="o">.</span>

    <span class="n">Use</span> <span class="n">FB_PositionState1D</span><span class="p">,</span> <span class="n">FB_PositionState2D</span><span class="p">,</span> <span class="o">...</span> <span class="n">etc</span><span class="o">.</span> <span class="n">instead</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Array</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">move</span> <span class="n">together</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="mi">1</span><span class="n">D</span> <span class="n">Position</span> <span class="n">states</span><span class="p">:</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">to</span> <span class="n">send</span> <span class="n">each</span> <span class="n">axis</span> <span class="n">to</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">we</span><span class="s1">&#39;re actually using</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="nb">all</span> <span class="n">moves</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">stop</span> <span class="nb">all</span> <span class="n">moves</span> <span class="n">on</span> <span class="n">falling</span> <span class="n">edge</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Reset</span> <span class="nb">any</span> <span class="n">errors</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">behavior</span> <span class="k">for</span> <span class="n">when</span> <span class="n">a</span> <span class="n">move</span> <span class="n">request</span> <span class="ow">is</span> <span class="n">interrupted</span> <span class="k">with</span> <span class="n">a</span> <span class="n">new</span> <span class="n">request</span>
    <span class="n">enumMotionRequest</span><span class="p">:</span> <span class="n">E_MotionRequest</span> <span class="o">:=</span> <span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">WAIT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ALL</span> <span class="n">of</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">at</span> <span class="n">their</span> <span class="n">goal</span> <span class="n">states</span>
    <span class="n">bAtState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ANY</span> <span class="n">of</span> <span class="n">this</span> <span class="n">FB</span><span class="s1">&#39;s moves are in progress</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ALL</span> <span class="n">motors</span> <span class="n">have</span> <span class="n">completed</span> <span class="n">the</span> <span class="n">last</span> <span class="n">move</span> <span class="n">request</span> <span class="kn">from</span> <span class="nn">this</span> <span class="n">FB</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ANY</span> <span class="n">of</span> <span class="n">this</span> <span class="n">FB</span><span class="s1">&#39;s moves had an error</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">How</span> <span class="n">many</span> <span class="n">FBs</span> <span class="n">are</span> <span class="n">erroring</span>
    <span class="n">nErrorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Which</span> <span class="n">component</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">source</span> <span class="n">of</span> <span class="n">the</span> <span class="n">example</span><span class="o">/</span><span class="n">summarized</span> <span class="n">error</span>
    <span class="n">nShownError</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">One</span> <span class="n">of</span> <span class="n">the</span> <span class="n">error</span> <span class="n">ids</span>
    <span class="n">nErrorID</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">error</span> <span class="n">error</span> <span class="n">message</span> <span class="n">matching</span> <span class="n">the</span> <span class="n">ID</span>
    <span class="n">sErrorMessage</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="mi">1</span><span class="n">D</span> <span class="n">State</span> <span class="n">movers</span><span class="p">:</span> <span class="n">FBs</span> <span class="n">to</span> <span class="n">move</span> <span class="n">the</span> <span class="n">motors</span>
    <span class="n">afbPositionStateMove</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateMove</span><span class="p">;</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bMotorCountError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nLowerBound</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nUpperBound</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CheckCount</span><span class="p">();</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMotorCountError</span> <span class="n">THEN</span>
    <span class="n">DoStateMoves</span><span class="p">();</span>
    <span class="n">CombineOutputs</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">CheckCount</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">valid</span> <span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">,</span> <span class="n">less</span> <span class="ow">or</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">max</span><span class="p">)</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&gt;</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bMotorCountError</span> <span class="n">THEN</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Internal Error: invalid motor count&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">CombineOutputs</span><span class="p">:</span>
<span class="o">//</span> <span class="n">bAtState</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ALL</span> <span class="n">entries</span> <span class="n">are</span> <span class="n">TRUE</span>
<span class="n">bAtState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bAtState</span> <span class="o">:=</span> <span class="n">bAtState</span> <span class="n">AND</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bAtState</span><span class="p">;</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">bBusy</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ANY</span> <span class="n">entry</span> <span class="ow">is</span> <span class="n">TRUE</span>
<span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">bBusy</span> <span class="n">OR</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">bDone</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ALL</span> <span class="n">entries</span> <span class="n">are</span> <span class="n">TRUE</span>
<span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">bDone</span> <span class="n">AND</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bDone</span><span class="p">;</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">bError</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ANY</span> <span class="n">entry</span> <span class="ow">is</span> <span class="n">TRUE</span>
<span class="o">//</span> <span class="n">also</span> <span class="nb">set</span> <span class="n">nShownError</span> <span class="ow">and</span> <span class="n">increment</span> <span class="n">nErrorCount</span>
<span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">nErrorCount</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">bError</span> <span class="n">OR</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
        <span class="n">nShownError</span> <span class="o">:=</span> <span class="n">nIndex</span><span class="p">;</span>
        <span class="n">nErrorCount</span> <span class="o">:=</span> <span class="n">nErrorCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">Pick</span> <span class="n">error</span> <span class="nb">id</span> <span class="ow">and</span> <span class="n">message</span> <span class="n">using</span> <span class="n">nShownError</span>
<span class="n">IF</span> <span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">nErrorID</span> <span class="o">:=</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nShownError</span><span class="p">]</span><span class="o">.</span><span class="n">nErrorID</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nShownError</span><span class="p">]</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">nErrorID</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">DoStateMoves</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Do</span> <span class="n">the</span> <span class="n">individual</span> <span class="n">moves</span>
<span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">afbPositionStateMove</span><span class="p">[</span><span class="n">nIndex</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">],</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">],</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
        <span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">,</span>
        <span class="n">enumMotionRequest</span><span class="o">:=</span><span class="n">enumMotionRequest</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate2d">FB_PositionState2D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemove">FB_PositionStateMove</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatemovend-test">
<h2>FB_PositionStateMoveND_Test<a class="headerlink" href="#fb-positionstatemovend-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateMoveND_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">that</span> <span class="n">FB_PositionStateMoveND</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">move</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span>
    <span class="n">And</span> <span class="n">that</span> <span class="n">the</span> <span class="n">API</span> <span class="n">behaves</span> <span class="n">exactly</span> <span class="k">as</span> <span class="n">described</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">afbMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">astGoalPositions</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">stDummyPos</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_PositionStateMoveND</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fTestStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bStatesReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">ResetGoals</span><span class="p">();</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astGoalPositions</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astGoalPositions</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
    <span class="n">SetEnables</span><span class="p">(</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">afbMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
<span class="n">END_FOR</span>

<span class="n">IF</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">nTestCounter</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t run any tests until the states are ready</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Warm</span> <span class="n">up</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">FB</span> <span class="k">with</span> <span class="n">a</span> <span class="n">exec</span> <span class="n">false</span> <span class="n">runthrough</span>
    <span class="n">fbMove</span><span class="p">(</span>
        <span class="n">astMotionStage</span> <span class="o">:=</span> <span class="n">astMotionStage</span><span class="p">,</span>
        <span class="n">astPositionState</span> <span class="o">:=</span> <span class="n">astGoalPositions</span><span class="p">,</span>
        <span class="n">nActiveMotorCount</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Move</span> <span class="n">to</span> <span class="n">somewhere</span>
<span class="n">TestMove</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Somewhere</span> <span class="k">else</span>
<span class="n">TestMove</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Interrupt</span> <span class="n">on</span> <span class="n">the</span> <span class="n">way</span> <span class="n">to</span> <span class="n">the</span> <span class="n">last</span> <span class="n">place</span>
<span class="n">TestMove</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ResetGoals</span><span class="p">();</span>
    <span class="n">fbMove</span><span class="p">(</span>
        <span class="n">astMotionStage</span> <span class="o">:=</span> <span class="n">astMotionStage</span><span class="p">,</span>
        <span class="n">astPositionState</span> <span class="o">:=</span> <span class="n">astGoalPositions</span><span class="p">,</span>
        <span class="n">nActiveMotorCount</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
        <span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bStatesReady</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">ResetGoals</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Goal1&#39;</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Goal2&#39;</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Goal3&#39;</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestMove</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fMotor1Pos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMotor3Pos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bInterrupt</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">bLocalInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInterruptStarted</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;TestMove&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nTestIndex</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestIndex</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bLocalInit</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Starting</span> <span class="n">output</span> <span class="n">checks</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Tried to start test with busy motor&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Tried to start test with errored motor&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bLocalInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fMotor1Pos</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fMotor2Pos</span><span class="p">;</span>
<span class="n">astGoalPositions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fMotor3Pos</span><span class="p">;</span>

<span class="n">bInterruptStarted</span> <span class="n">S</span><span class="o">=</span> <span class="n">bInterrupt</span> <span class="n">AND</span> <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astGoalPositions</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInterruptStarted</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bDone</span> <span class="n">OR</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bInterruptStarted</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bInterrupt</span> <span class="n">THEN</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">fbMove</span><span class="o">.</span><span class="n">bAtState</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Should have been interrupted, but made it to the goal&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">AssertTrue</span><span class="p">(</span>
            <span class="n">fbMove</span><span class="o">.</span><span class="n">bAtState</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not end at the state&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span>
            <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
                <span class="n">Expected</span><span class="o">:=</span><span class="n">astGoalPositions</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
                <span class="n">Actual</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
                <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.01</span><span class="p">,</span>
                <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not reach the goal state&#39;</span><span class="p">,</span>
            <span class="p">);</span>
        <span class="n">END_FOR</span>

    <span class="n">END_IF</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Was busy while done&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Should not end in error&#39;</span><span class="p">,</span>
    <span class="p">);</span>

    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemovend">FB_PositionStateMoveND</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatend-core">
<h2>FB_PositionStateND_Core<a class="headerlink" href="#fb-positionstatend-core" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateND_Core</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Collection</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">actions</span> <span class="n">shared</span> <span class="n">between</span> <span class="nb">all</span> <span class="n">states</span> <span class="n">FBs</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">FB_PositionState1D</span>
    <span class="o">-</span> <span class="n">FB_PositionState2D</span>
    <span class="o">-</span> <span class="o">...</span> <span class="n">etc</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS1D</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS2D</span>
    <span class="o">-</span> <span class="o">...</span> <span class="n">etc</span><span class="o">.</span>

    <span class="n">This</span> <span class="ow">is</span> <span class="n">essentially</span> <span class="nb">input</span> <span class="n">handling</span><span class="p">,</span> <span class="n">position</span> <span class="n">state</span> <span class="n">reading</span><span class="p">,</span> <span class="n">standard</span> <span class="n">management</span> <span class="n">blocks</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">state</span> <span class="n">machine</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">be</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">states</span> <span class="n">move</span><span class="p">,</span> <span class="n">including</span> <span class="n">blank</span><span class="o">/</span><span class="n">uninitialized</span> <span class="n">structs</span><span class="o">.</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">motors</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">be</span> <span class="n">included</span> <span class="ow">in</span> <span class="n">astMotionStageMax</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">index</span> <span class="n">goal</span><span class="p">,</span> <span class="n">where</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">supposed</span> <span class="n">to</span> <span class="n">be</span> <span class="n">moving</span> <span class="n">towards</span><span class="o">.</span>
    <span class="n">nCurrGoal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbInput</span><span class="p">:</span> <span class="n">FB_StatesInputHandler</span><span class="p">;</span>
    <span class="n">fbInternal</span><span class="p">:</span> <span class="n">FB_PositionStateInternalND</span><span class="p">;</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_PositionStateMoveND</span><span class="p">;</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_PositionStateReadND</span><span class="p">;</span>
    <span class="n">astMoveGoals</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stInvalidPos</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">nIterMotor</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">nSetValue</span> <span class="o">:=</span> <span class="n">eEnumSet</span><span class="p">;</span>

<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="n">nActiveMotorCount</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">=&gt;</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbInput</span><span class="p">(</span>
    <span class="n">stUserInput</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">bMoveBusy</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
    <span class="n">nStartingState</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">nPositionIndex</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">=&gt;</span><span class="n">nCurrGoal</span><span class="p">,</span>
    <span class="n">bExecMove</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bResetMove</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbInternal</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">FOR</span> <span class="n">nIterMotor</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">nCurrGoal</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">astMoveGoals</span><span class="p">[</span><span class="n">nIterMotor</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="n">nIterMotor</span><span class="p">][</span><span class="n">nCurrGoal</span><span class="p">];</span>
    <span class="n">ELSE</span>
        <span class="n">astMoveGoals</span><span class="p">[</span><span class="n">nIterMotor</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stInvalidPos</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astMoveGoals</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="n">nActiveMotorCount</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">fbInput</span><span class="o">.</span><span class="n">bExecMove</span> <span class="n">AND</span> <span class="n">bEnable</span><span class="p">,</span>
    <span class="n">bReset</span><span class="o">:=</span><span class="n">fbInput</span><span class="o">.</span><span class="n">bResetMove</span><span class="p">,</span>
    <span class="n">enumMotionRequest</span><span class="o">:=</span><span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="p">,</span>
    <span class="n">bAtState</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bError</span><span class="o">=&gt;</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
    <span class="n">nErrorID</span><span class="o">=&gt;</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nErrorID</span><span class="p">,</span>
    <span class="n">sErrorMessage</span><span class="o">=&gt;</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">sErrorMsg</span><span class="p">,</span>
    <span class="n">bBusy</span><span class="o">=&gt;</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
    <span class="n">bDone</span><span class="o">=&gt;</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">eEnumSet</span> <span class="o">:=</span> <span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">nSetValue</span><span class="p">;</span>
<span class="n">eEnumGet</span> <span class="o">:=</span> <span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate2d">FB_PositionState2D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternalnd">FB_PositionStateInternalND</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemovend">FB_PositionStateMoveND</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps2d">FB_PositionStatePMPS2D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatereadnd">FB_PositionStateReadND</a></p></li>
<li><p><a class="reference internal" href="#fb-statesinputhandler">FB_StatesInputHandler</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatend-test">
<h2>FB_PositionStateND_Test<a class="headerlink" href="#fb-positionstatend-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateND_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Sanity</span> <span class="n">checks</span> <span class="k">for</span> <span class="n">the</span> <span class="n">following</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">FB_PositionState1D</span>
    <span class="o">-</span> <span class="n">FB_PositionState2D</span>
    <span class="o">-</span> <span class="n">FB_PositionState3D</span>
    <span class="n">The</span> <span class="n">internals</span> <span class="n">have</span> <span class="n">already</span> <span class="n">been</span> <span class="n">tested</span><span class="p">,</span> <span class="n">but</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">that</span>
    <span class="n">they</span><span class="s1">&#39;ve been put together at least somewhat sensibly.</span>
    <span class="n">This</span> <span class="n">FB</span> <span class="n">will</span> <span class="n">simply</span> <span class="n">use</span> <span class="n">each</span> <span class="n">FB</span> <span class="n">to</span> <span class="n">move</span> <span class="ow">and</span> <span class="n">check</span> <span class="n">the</span> <span class="n">results</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStage3</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">afbMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="n">fb_Move1D</span><span class="p">:</span> <span class="n">FB_PositionState1D</span><span class="p">;</span>
    <span class="n">fb_Move2D</span><span class="p">:</span> <span class="n">FB_PositionState2D</span><span class="p">;</span>
    <span class="n">fb_Move3D</span><span class="p">:</span> <span class="n">FB_PositionState3D</span><span class="p">;</span>

    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fTestStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bStatesReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">eSetPos</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
    <span class="n">eGetPos</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">][</span><span class="mi">3</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage1</span><span class="p">);</span>
<span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage2</span><span class="p">);</span>
<span class="n">SetEnables</span><span class="p">(</span><span class="n">stMotionStage3</span><span class="p">);</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">);</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">);</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="mi">3</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">nTestCounter</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t run any tests until the states are ready</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Run</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">FBs</span> <span class="k">for</span> <span class="n">one</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">warm</span> <span class="n">them</span> <span class="n">up</span>
    <span class="n">fb_Move1D</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move2D</span><span class="p">(</span>
        <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move3D</span><span class="p">(</span>
        <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">stMotionStage3</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
        <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
        <span class="n">astPositionState3</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">Test1D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">);</span>
<span class="n">Test1D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">);</span>
<span class="n">Test1D</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">);</span>
<span class="n">Test2D</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">);</span>
<span class="n">Test2D</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">);</span>
<span class="n">Test2D</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">);</span>
<span class="n">Test3D</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">);</span>
<span class="n">Test3D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">);</span>
<span class="n">Test3D</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bStatesReady</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">Test1D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">nLocalInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Test1D_state&#39;</span><span class="p">,</span> <span class="n">DINT_TO_STRING</span><span class="p">(</span><span class="n">nState</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">nLocalInit</span> <span class="n">THEN</span>
    <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">nState</span><span class="p">;</span>
    <span class="n">nLocalInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fb_Move1D</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be True after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_DINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">nState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move1D</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nLocalInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Test2D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">nLocalInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Test2D_state&#39;</span><span class="p">,</span> <span class="n">DINT_TO_STRING</span><span class="p">(</span><span class="n">nState</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">nLocalInit</span> <span class="n">THEN</span>
    <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">nState</span><span class="p">;</span>
    <span class="n">nLocalInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fb_Move2D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be True after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_DINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">nState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position for stage 1&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">nState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position for stage 2&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move2D</span><span class="p">(</span>
        <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nLocalInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Test3D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">nLocalInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Test3D_state&#39;</span><span class="p">,</span> <span class="n">DINT_TO_STRING</span><span class="p">(</span><span class="n">nState</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">nLocalInit</span> <span class="n">THEN</span>
    <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">nState</span><span class="p">;</span>
    <span class="n">nLocalInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fb_Move3D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">stMotionStage3</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">astPositionState3</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be True after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_DINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">nState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position for stage 1&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">nState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position for stage 2&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">[</span><span class="n">nState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position for stage 3&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move3D</span><span class="p">(</span>
        <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">stMotionStage3</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
        <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
        <span class="n">astPositionState3</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nLocalInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-teststates">E_TestStates</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d">FB_PositionState1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate2d">FB_PositionState2D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate3d">FB_PositionState3D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps">
<h2>FB_PositionStatePMPS<a class="headerlink" href="#fb-positionstatepmps" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{attribute &#39;obsolete&#39; := &#39;Use FB_PositionStatePMPS1D instead&#39;}
FUNCTION_BLOCK FB_PositionStatePMPS EXTENDS FB_PositionStatePMPS_Base
(*
    Hooks up a position state to an arbiter and an FFO
        Use BeamParameterTransitionManager to manage transition requests between states
        Hook up to the inputs/outputs of the state function block
        Raises FFO if beam parameters are worse than required for current state
*)
VAR_IN_OUT
    fbArbiter: FB_Arbiter;
    fbFFHWO: FB_HardwareFFOutput;
END_VAR
VAR_INPUT
    bReadPmpsDb: BOOL;
    sPmpsDeviceName: STRING;
    sTransitionKey: STRING;
    stPmpsDoc: SJsonValue;
    stHighBeamThreshold: ST_BeamParams := PMPS_GVL.cstFullBeam;
    bBPOKAutoReset: BOOL := False;
END_VAR
VAR
    arrPMPS: ARRAY[0..GeneralConstants.MAX_STATES] OF ST_DbStateParams;
    nBPIndex: UINT;
    nTransitionAssertionID: UDINT;
    nLastReqAssertionID: UDINT;
    fbReadPmpsDb: FB_JsonDocToSafeBP;
    ftDbBusy: F_TRIG;
    rtReadDBExec: R_TRIG;
    ftRead: F_TRIG;
    bptm: BeamParameterTransitionManager;
    ffBeamParamsOk: FB_FastFault;
    ffZeroRate: FB_FastFault;
    ffBPTMTimeoutAndMove: FB_FastFault;
    ffBPTMError: FB_FastFault;
    ffMaint: FB_FastFault;
    ffUnknown: FB_FastFault;
    bFFOxOk: BOOL;
    bAtSafeState: BOOL;
    nIter: UINT;
END_VAR
Exec();

END_FUNCTION_BLOCK

ACTION AssertHere:
fbArbiter.AddRequest(
    sDevName := stMotionStage.sName,
    nReqID := stStateReq.stPMPS.nRequestAssertionID,
    stReqBP := stStateReq.stPMPS.stBeamParams);
END_ACTION

ACTION ClearAsserts:
fbArbiter.RemoveRequest(nTransitionAssertionID);
FOR nIter := 1 TO GeneralConstants.MAX_STATES DO
    fbArbiter.RemoveRequest(arrStates[nIter].stPMPS.nRequestAssertionID);
END_FOR
END_ACTION

ACTION HandleBPTM:
(*
  Handle finishing the bptm late if timed out
  bptm needs a rising edge of bTransDone after authorizing transition
  If we fall into this block, bTransDone would otherwise be stuck at TRUE forever
  so the BPTM would never see a rising edge and therefore stay stuck
  We set to FALSE here to reset the BPTM, then gets set to TRUE again if really done.
*)
rtDoLateFinish(CLK:=bLateFinish AND bInternalAuth);
IF rtDoLateFinish.Q THEN
    bTransDone := FALSE;
    bLateFinish := FALSE;
END_IF

IF stStateReq.stPMPS.nRequestAssertionID &lt;&gt; nTransitionAssertionID THEN
    (*
        Edge case: the request is swapped out without a move
        Same as above: we need a rising edge of bTransDone, so cause a falling edge and the let the rising edge happen next cycle
        This will already be false when we request a positional move
    *)
    bTransDone R= stStateReq.stPMPS.nRequestAssertionID &lt;&gt; nLastReqAssertionID;
    // Just normal bptm call
    bptm(fbArbiter:=fbArbiter,
         i_sDeviceName:=stMotionStage.sName,
         i_TransitionAssertionID:=nTransitionAssertionID,
         i_stTransitionAssertion:=stTransitionBeam,
         i_nRequestedAssertionID:=stStateReq.stPMPS.nRequestAssertionID,
         i_stRequestedAssertion:=stStateReq.stPMPS.stBeamParams,
         i_xDoneMoving:=bTransDone,
         stCurrentBeamParameters:=PMPS_GVL.stCurrentBeamParameters,
         q_xTransitionAuthorized=&gt;bInternalAuth,
         bDone=&gt;bBPTMDone);
    nLastReqAssertionID := stStateReq.stPMPS.nRequestAssertionID;
END_IF
END_ACTION

ACTION HandleFFO:
// stBeamNeeded will point to Unknown/No beam if we are out of state bounds or in motion
// Otherwise we&#39;ll have the current state&#39;s beam parameters

// Check for bad conditions
bFFOxOk := F_SafeBPCompare(PMPS_GVL.stCurrentBeamParameters, stBeamNeeded);
// It is safe to reset automatically if our current state can take full beam.
// Otherwise we&#39;ll have to ask for a user acknowledgement to clear.
// This avoids rapidly cycling the FFOs on/off
// You can pass in a different stHighBeamThreshold as an input parameter to customize this behavior
bAtSafeState := F_SafeBPCompare(stHighBeamThreshold, stBeamNeeded);

// If the beam parameters are wrong, it is a fault! This encompasses all unknown arbiter-related errors.
ffBeamParamsOk.i_xOK := bFFOxOk;
ffBeamParamsOk.i_xReset S= bFFOxOk AND bAtSafeState;
ffBeamParamsOk.i_xReset R= NOT ffBeamParamsOk.i_xOK;
ffBeamParamsOk.i_xAutoReset := bBPOKAutoReset;

ffBeamParamsOk(
    i_DevName:=stMotionStage.sName,
    i_Desc:=&#39;Beam parameter mismatch&#39;,
    i_TypeCode:=16#1000,
    io_fbFFHWO:=fbFFHWO);

// Trip the beam for zero-rate states. This is a PMPS training wheel and should ultimately be removed.
// Note: I think this is already redundant
ffZeroRate(
    i_xOk := stBeamNeeded.nRate &gt; 0,
    i_xAutoReset := TRUE,
    i_DevName := stMotionStage.sName,
    i_Desc := &#39;Device requesting zero rate&#39;,
    i_TypeCode := 16#1001,
    io_fbFFHWO := fbFFHWO);

// Trip the beam for BPTM timeouts if we want to move
// Only reset at safe beam OR at no bptm errors (some other FF should catch additional issues)
ffBPTMTimeoutAndMove.i_xOK := NOT (bArbiterTimeout AND bMoveOnArbiterTimeout);
ffBPTMTimeoutAndMove.i_xReset S= bAtSafeState OR (bptm.bDone AND NOT bptm.bError);
ffBPTMTimeoutAndMove.i_xReset R= NOT ffBPTMTimeoutAndMove.i_xOK;
ffBPTMTimeoutAndMove(
    i_DevName := stMotionStage.sName,
    i_Desc := &#39;BPTM Timeout&#39;,
    i_TypeCode := 16#1002,
    io_fbFFHWO := fbFFHWO);

// Trip the beam for BPTM Errors
ffBPTMError.i_xOK := NOT bptm.bError;
ffBPTMError.i_xReset S= bptm.bDone AND NOT bptm.bError;
ffBPTMError.i_xReset R= NOT ffBPTMError.i_xOK;
ffBPTMError(
    i_DevName := stMotionStage.sName,
    i_Desc := &#39;BPTM error, state transition failed&#39;,
    i_TypeCode := 16#1003,
    io_fbFFHWO := fbFFHWO);

// Trip the beam for maintenance mode
ffMaint(
    i_xOK := NOT bMaintMode,
    i_xAutoReset := TRUE,
    i_DevName := stMotionStage.sName,
    i_Desc := &#39;Device is in maintenance mode&#39;,
    i_TypeCode := 16#1004,
    io_fbFFHWO := fbFFHWO);

// Trip the beam for unknown state
ffUnknown(
    i_xOK := getState &gt; 0 OR bInTransition,
    i_xAutoReset := TRUE,
    i_DevName := stMotionStage.sName,
    i_Desc := &#39;Unknown position between moves&#39;,
    i_TypeCode := 16#1005,
    io_fbFFHWO := fbFFHWO);
END_ACTION

ACTION HandlePmpsDb:
// Automatically read from the pmps db when it updates
// Assume update if no longer busy and no errors

ftDbBusy(CLK:=MOTION_GVL.fbPmpsFileReader.bBusy);
IF ftDbBusy.Q THEN
    bReadPmpsDb S= NOT MOTION_GVL.fbPmpsFileReader.bError;
END_IF

rtReadDBExec(CLK:=bReadPmpsDb);
IF rtReadDBExec.Q THEN
    arrPMPS[0].sPmpsState := sTransitionKey;
    FOR nBPIndex := 1 TO GeneralConstants.MAX_STATES BY 1 DO
        arrPMPS[nBPIndex] := arrStates[nBPIndex].stPMPS;
    END_FOR
END_IF

fbReadPmpsDb(
    bExecute:=bReadPmpsDb,
    jsonDoc:=stPmpsDoc,
    sDeviceName:=sPmpsDeviceName,
    io_fbFFHWO:=fbFFHWO,
    arrStates:=arrPMPS,
);
bReadPmpsDb R= NOT fbReadPmpsDb.bBusy;

ftRead(CLK:=fbReadPmpsDb.bBusy);

stTransitionState.sName := &#39;Transition&#39;;
IF ftRead.Q AND NOT fbReadPmpsDb.bError THEN
    stTransitionDb := arrPMPS[0];
    stTransitionBeam := arrPMPS[0].stBeamParams;
    nTransitionAssertionID := arrPMPS[0].nRequestAssertionID;
    stTransitionState.stPMPS := arrPMPS[0];
    FOR nBPIndex := 1 TO GeneralConstants.MAX_STATES BY 1 DO
        arrStates[nBPIndex].stPMPS := arrPMPS[nBPIndex];
    END_FOR
END_IF
END_ACTION
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps-base">FB_PositionStatePMPS_Base</a></p></li>
<li><p><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps1d">
<h2>FB_PositionStatePMPS1D<a class="headerlink" href="#fb-positionstatepmps1d" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS1D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="mi">1</span><span class="o">-</span><span class="n">Dimensional</span> <span class="n">position</span> <span class="n">state</span> <span class="n">function</span> <span class="n">block</span> <span class="k">with</span> <span class="n">PMPS</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">move</span> <span class="n">a</span> <span class="n">motor</span> <span class="n">among</span> <span class="n">some</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span> <span class="k">with</span> <span class="n">PMPS</span> <span class="n">protection</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">use</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">state</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">give</span> <span class="n">them</span> <span class="n">pytmc</span> <span class="n">pragmas</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">FB_PositionState1D_InOut</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">example</span><span class="o">.</span>
    <span class="n">These</span> <span class="n">enums</span> <span class="n">must</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="ow">and</span> <span class="n">eEnumGet</span> <span class="n">VAR_IN_OUT</span> <span class="n">variables</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">enum</span> <span class="n">values</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">array</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">astPositionState</span><span class="o">.</span>

    <span class="n">A</span> <span class="n">move</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">when</span> <span class="n">eEnumSet</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span> <span class="n">value</span><span class="o">.</span> <span class="n">eEnumSet</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">allowing</span> <span class="n">us</span>
    <span class="n">to</span> <span class="n">accept</span> <span class="n">a</span> <span class="n">new</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">move</span> <span class="n">request</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="n">the</span> <span class="n">first</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motor</span> <span class="n">must</span> <span class="n">already</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">point</span> <span class="n">motion</span> <span class="n">via</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">,</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">work</span> <span class="n">properly</span><span class="o">.</span>

    <span class="n">PMPS</span> <span class="n">handling</span> <span class="ow">is</span> <span class="n">done</span> <span class="n">via</span> <span class="n">database</span> <span class="n">lookups</span> <span class="n">by</span> <span class="n">setting</span> <span class="n">sPmpsState</span> <span class="n">on</span> <span class="n">each</span> <span class="n">position</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">on</span>
    <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="nb">input</span> <span class="n">appropriately</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span><span class="o">.</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableMotion</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StatePMPSEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPMPSPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePMPSPlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">fbPMPSCore</span><span class="p">:</span> <span class="n">FB_PositionStatePMPSND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">;</span>

<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnableMotion</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbPMPSCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="o">:=</span><span class="n">stPMPSEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">stPMPSPlcToEpics</span><span class="o">:=</span><span class="n">stPMPSPlcToEpics</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">:=</span><span class="n">fbCore</span><span class="o">.</span><span class="n">nCurrGoal</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">stDbStateParams</span><span class="o">=&gt;</span><span class="n">stDbStateParams</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">astPositionState</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmpsnd-core">FB_PositionStatePMPSND_Core</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsepicstoplc">ST_StatePMPSEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsplctoepics">ST_StatePMPSPlcToEpics</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps1d-inout">
<h2>FB_PositionStatePMPS1D_InOut<a class="headerlink" href="#fb-positionstatepmps1d-inout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS1D_InOut</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">An</span> <span class="n">example</span> <span class="ow">and</span> <span class="n">usable</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="n">instance</span> <span class="k">for</span> <span class="n">a</span> <span class="mi">1</span><span class="n">D</span> <span class="n">pmps</span> <span class="n">state</span> <span class="n">device</span> <span class="k">with</span> <span class="n">just</span> <span class="n">an</span> <span class="n">IN</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">Note</span> <span class="n">that</span> <span class="n">the</span> <span class="n">outward</span><span class="o">-</span><span class="n">facing</span> <span class="n">API</span> <span class="ow">is</span> <span class="n">nearly</span> <span class="n">identical</span> <span class="n">to</span> <span class="n">the</span> <span class="n">non</span><span class="o">-</span><span class="n">PMPS</span> <span class="n">version</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">a</span> <span class="n">stage</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">into</span> <span class="n">the</span> <span class="n">FB</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Simplify</span> <span class="n">the</span> <span class="n">interface</span><span class="p">,</span> <span class="n">the</span> <span class="n">user</span> <span class="n">just</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">construct</span> <span class="ow">and</span> <span class="k">pass</span> <span class="ow">in</span> <span class="ow">and</span> <span class="n">out</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">PMPS</span> <span class="n">output</span> <span class="n">helpers</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">a</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">expected</span> <span class="n">this</span> <span class="n">will</span> <span class="n">be</span> <span class="n">written</span> <span class="n">to</span> <span class="n">during</span> <span class="n">one</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">so</span> <span class="n">don</span><span class="s1">&#39;t continually apply a value here in the PLC code.</span>
    <span class="o">//</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">exposed</span> <span class="k">as</span> <span class="n">an</span> <span class="nb">input</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">test</span> <span class="n">it</span> <span class="n">using</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateSet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="n">report</span> <span class="n">the</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateGet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">fb</span> <span class="k">with</span> <span class="n">blank</span> <span class="n">pv</span> <span class="n">pragma</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">fbPositionStatePMPS1D</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS1D</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">standard</span> <span class="n">fb</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">full</span> <span class="n">array</span> <span class="n">of</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Optional</span><span class="p">:</span> <span class="n">default</span> <span class="n">state</span> <span class="n">names</span>
<span class="n">IF</span> <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stIn</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stOut</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Assemble</span> <span class="n">the</span> <span class="n">states</span> <span class="n">array</span><span class="p">,</span> <span class="n">matching</span> <span class="n">the</span> <span class="n">enum</span> <span class="n">values</span> <span class="p">(</span><span class="n">IN</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OUT</span> <span class="ow">is</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">main</span> <span class="n">function</span> <span class="n">block</span><span class="p">,</span> <span class="n">passing</span> <span class="n">our</span> <span class="n">motors</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">enable</span>
<span class="n">fbPositionStatePMPS1D</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eStateSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eStateGet</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Send</span> <span class="n">updates</span> <span class="n">made</span> <span class="n">on</span> <span class="n">the</span> <span class="n">array</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">inputs</span> <span class="p">(</span><span class="n">VAR_IN_OUT</span><span class="p">)</span> <span class="k">for</span> <span class="n">maximum</span> <span class="n">clarity</span>
<span class="n">stIn</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stOut</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsinout">E_EpicsInOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps2d">
<h2>FB_PositionStatePMPS2D<a class="headerlink" href="#fb-positionstatepmps2d" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS2D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="mi">2</span><span class="o">-</span><span class="n">Dimensional</span> <span class="n">position</span> <span class="n">state</span> <span class="n">function</span> <span class="n">block</span> <span class="k">with</span> <span class="n">PMPS</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">move</span> <span class="mi">2</span> <span class="n">motors</span> <span class="n">among</span> <span class="n">some</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span> <span class="k">with</span> <span class="n">PMPS</span> <span class="n">protection</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">use</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">state</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">give</span> <span class="n">them</span> <span class="n">pytmc</span> <span class="n">pragmas</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">FB_PositionState1D_InOut</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">example</span><span class="o">.</span>
    <span class="n">These</span> <span class="n">enums</span> <span class="n">must</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="ow">and</span> <span class="n">eEnumGet</span> <span class="n">VAR_IN_OUT</span> <span class="n">variables</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">enum</span> <span class="n">values</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">array</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">astPositionState1</span> <span class="ow">and</span> <span class="n">astPositionState2</span><span class="o">.</span>

    <span class="n">A</span> <span class="n">move</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">when</span> <span class="n">eEnumSet</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span> <span class="n">value</span><span class="o">.</span> <span class="n">eEnumSet</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">allowing</span> <span class="n">us</span>
    <span class="n">to</span> <span class="n">accept</span> <span class="n">a</span> <span class="n">new</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">move</span> <span class="n">request</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="n">the</span> <span class="n">first</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motors</span> <span class="n">must</span> <span class="n">already</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">point</span> <span class="n">motion</span> <span class="n">via</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">,</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">work</span> <span class="n">properly</span><span class="o">.</span>

    <span class="n">PMPS</span> <span class="n">handling</span> <span class="ow">is</span> <span class="n">done</span> <span class="n">via</span> <span class="n">database</span> <span class="n">lookups</span> <span class="n">by</span> <span class="n">setting</span> <span class="n">sPmpsState</span> <span class="n">on</span> <span class="n">each</span> <span class="n">position</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">on</span>
    <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="nb">input</span> <span class="n">appropriately</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">1</span><span class="n">st</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">1</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">M1</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">2</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">M2</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableMotion</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StatePMPSEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPMPSPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePMPSPlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">fbPMPSCore</span><span class="p">:</span> <span class="n">FB_PositionStatePMPSND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage1</span><span class="p">;</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage2</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">;</span>

<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnableMotion</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbPMPSCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="o">:=</span><span class="n">stPMPSEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">stPMPSPlcToEpics</span><span class="o">:=</span><span class="n">stPMPSPlcToEpics</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">:=</span><span class="n">fbCore</span><span class="o">.</span><span class="n">nCurrGoal</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">stDbStateParams</span><span class="o">=&gt;</span><span class="n">stDbStateParams</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stMotionStage1</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stMotionStage2</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">astPositionState1</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">astPositionState2</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmpsnd-core">FB_PositionStatePMPSND_Core</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsepicstoplc">ST_StatePMPSEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsplctoepics">ST_StatePMPSPlcToEpics</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps2d-inout">
<h2>FB_PositionStatePMPS2D_InOut<a class="headerlink" href="#fb-positionstatepmps2d-inout" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS2D_InOut</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">An</span> <span class="n">example</span> <span class="ow">and</span> <span class="n">usable</span> <span class="n">drop</span><span class="o">-</span><span class="ow">in</span> <span class="n">instance</span> <span class="k">for</span> <span class="n">a</span> <span class="mi">2</span><span class="n">D</span> <span class="n">state</span> <span class="n">device</span> <span class="k">with</span> <span class="n">just</span> <span class="n">an</span> <span class="n">IN</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">Note</span> <span class="n">that</span> <span class="n">the</span> <span class="n">outward</span><span class="o">-</span><span class="n">facing</span> <span class="n">API</span> <span class="ow">is</span> <span class="n">nearly</span> <span class="n">identical</span> <span class="n">to</span> <span class="n">the</span> <span class="n">non</span><span class="o">-</span><span class="n">PMPS</span> <span class="n">version</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">stages</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">into</span> <span class="n">the</span> <span class="n">FB</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Simplify</span> <span class="n">the</span> <span class="n">interface</span><span class="p">,</span> <span class="n">the</span> <span class="n">user</span> <span class="n">just</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">construct</span> <span class="ow">and</span> <span class="k">pass</span> <span class="ow">in</span> <span class="ow">and</span> <span class="n">out</span> <span class="n">position</span> <span class="n">states</span>
    <span class="n">stIn1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stOut1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stIn2</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">stOut2</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">PMPS</span> <span class="n">output</span> <span class="n">helpers</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">a</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">expected</span> <span class="n">this</span> <span class="n">will</span> <span class="n">be</span> <span class="n">written</span> <span class="n">to</span> <span class="n">during</span> <span class="n">one</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">so</span> <span class="n">don</span><span class="s1">&#39;t continually apply a value here in the PLC code.</span>
    <span class="o">//</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">exposed</span> <span class="k">as</span> <span class="n">an</span> <span class="nb">input</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">test</span> <span class="n">it</span> <span class="n">using</span> <span class="n">the</span> <span class="n">PLC</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateSet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Define</span> <span class="n">an</span> <span class="n">ENUM</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">use</span> <span class="n">to</span> <span class="n">report</span> <span class="n">the</span> <span class="n">new</span> <span class="n">value</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eStateGet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">Include</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">fb</span> <span class="k">with</span> <span class="n">blank</span> <span class="n">pv</span> <span class="n">pragma</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv:&#39;</span><span class="p">}</span>
    <span class="n">fbPositionStatePMPS2D</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS2D</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">standard</span> <span class="n">fb</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">full</span> <span class="n">array</span> <span class="n">of</span> <span class="n">position</span> <span class="n">states</span> <span class="n">per</span> <span class="n">motor</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Optional</span><span class="p">:</span> <span class="n">default</span> <span class="n">state</span> <span class="n">names</span>
<span class="n">IF</span> <span class="n">stIn1</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stIn1</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stOut1</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stOut1</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stIn2</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stIn2</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stOut2</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
    <span class="n">stOut2</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Assemble</span> <span class="n">the</span> <span class="n">states</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">matching</span> <span class="n">the</span> <span class="n">enum</span> <span class="n">values</span> <span class="p">(</span><span class="n">IN</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OUT</span> <span class="ow">is</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn1</span><span class="p">;</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut1</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn2</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut2</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">main</span> <span class="n">function</span> <span class="n">block</span><span class="p">,</span> <span class="n">passing</span> <span class="n">our</span> <span class="n">motors</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">enable</span>
<span class="n">fbPositionStatePMPS2D</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eStateSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eStateGet</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Send</span> <span class="n">updates</span> <span class="n">made</span> <span class="n">on</span> <span class="n">the</span> <span class="n">array</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">inputs</span> <span class="p">(</span><span class="n">VAR_IN_OUT</span><span class="p">)</span> <span class="k">for</span> <span class="n">maximum</span> <span class="n">clarity</span>
<span class="n">stIn1</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stOut1</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">stIn2</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stOut2</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsinout">E_EpicsInOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps2d">FB_PositionStatePMPS2D</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps3d">
<h2>FB_PositionStatePMPS3D<a class="headerlink" href="#fb-positionstatepmps3d" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS3D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="mi">3</span><span class="o">-</span><span class="n">Dimensional</span> <span class="n">position</span> <span class="n">state</span> <span class="n">function</span> <span class="n">block</span> <span class="k">with</span> <span class="n">PMPS</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">user</span> <span class="n">to</span> <span class="n">move</span> <span class="mi">3</span> <span class="n">motors</span> <span class="n">among</span> <span class="n">some</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">named</span> <span class="n">state</span> <span class="n">positions</span> <span class="k">with</span> <span class="n">PMPS</span> <span class="n">protection</span><span class="o">.</span>

    <span class="n">To</span> <span class="n">use</span> <span class="n">a</span> <span class="n">states</span> <span class="n">block</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span> <span class="n">define</span> <span class="n">enums</span> <span class="n">that</span> <span class="n">match</span> <span class="n">the</span> <span class="n">state</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">give</span> <span class="n">them</span> <span class="n">pytmc</span> <span class="n">pragmas</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">FB_PositionState1D_InOut</span> <span class="k">for</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">example</span><span class="o">.</span>
    <span class="n">These</span> <span class="n">enums</span> <span class="n">must</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="k">as</span> <span class="n">the</span> <span class="n">eEnumSet</span> <span class="ow">and</span> <span class="n">eEnumGet</span> <span class="n">VAR_IN_OUT</span> <span class="n">variables</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">enum</span> <span class="n">values</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">array</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">astPositionState1</span><span class="p">,</span> <span class="n">astPositionState2</span><span class="p">,</span> <span class="ow">and</span> <span class="n">astPositionState3</span><span class="o">.</span>

    <span class="n">A</span> <span class="n">move</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">when</span> <span class="n">eEnumSet</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">a</span> <span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span> <span class="n">value</span><span class="o">.</span> <span class="n">eEnumSet</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">on</span> <span class="n">every</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">allowing</span> <span class="n">us</span>
    <span class="n">to</span> <span class="n">accept</span> <span class="n">a</span> <span class="n">new</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">conflicting</span><span class="p">,</span> <span class="n">move</span> <span class="n">request</span> <span class="n">on</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span> <span class="n">to</span> <span class="n">interrupt</span> <span class="n">the</span> <span class="n">first</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motors</span> <span class="n">must</span> <span class="n">already</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">point</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">point</span> <span class="n">motion</span> <span class="n">via</span> <span class="n">FB_MotionStage</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">,</span> <span class="k">for</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">work</span> <span class="n">properly</span><span class="o">.</span>

    <span class="n">PMPS</span> <span class="n">handling</span> <span class="ow">is</span> <span class="n">done</span> <span class="n">via</span> <span class="n">database</span> <span class="n">lookups</span> <span class="n">by</span> <span class="n">setting</span> <span class="n">sPmpsState</span> <span class="n">on</span> <span class="n">each</span> <span class="n">position</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">on</span>
    <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="nb">input</span> <span class="n">appropriately</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">1</span><span class="n">st</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="mi">3</span><span class="n">rd</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">move</span>
    <span class="n">stMotionStage3</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">1</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">M1</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">2</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">M2</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">motor</span> <span class="mi">3</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STATE</span><span class="p">:</span><span class="n">M3</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">expand</span><span class="p">:</span> <span class="p">:</span><span class="o">%</span><span class="mf">.2</span><span class="n">d</span>
    <span class="s1">&#39;}</span>
    <span class="n">astPositionState3</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">nonzero</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span> <span class="n">It</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">every</span> <span class="n">cycle</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum input.</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">state</span> <span class="n">index</span><span class="p">,</span> <span class="ow">or</span> <span class="n">zero</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">state</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">hooked</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">user</span><span class="s1">&#39;s EPICS enum output.</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableMotion</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StatePMPSEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STATE&#39;</span><span class="p">}</span>
    <span class="n">stPMPSPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePMPSPlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCore</span><span class="p">:</span> <span class="n">FB_PositionStateND_Core</span><span class="p">;</span>
    <span class="n">fbPMPSCore</span><span class="p">:</span> <span class="n">FB_PositionStatePMPSND_Core</span><span class="p">;</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage1</span><span class="p">;</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage2</span><span class="p">;</span>
<span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMotionStage3</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState1</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState2</span><span class="p">;</span>
<span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">astPositionState3</span><span class="p">;</span>

<span class="n">fbCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnableMotion</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbPMPSCore</span><span class="p">(</span>
    <span class="n">astMotionStageMax</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionStateMax</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">stEpicsToPlc</span><span class="o">:=</span><span class="n">stEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="o">:=</span><span class="n">stPMPSEpicsToPlc</span><span class="p">,</span>
    <span class="n">stPlcToEpics</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="p">,</span>
    <span class="n">stPMPSPlcToEpics</span><span class="o">:=</span><span class="n">stPMPSPlcToEpics</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">nCurrGoal</span><span class="o">:=</span><span class="n">fbCore</span><span class="o">.</span><span class="n">nCurrGoal</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">stDbStateParams</span><span class="o">=&gt;</span><span class="n">stDbStateParams</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stMotionStage1</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">stMotionStage2</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">stMotionStage3</span> <span class="o">:=</span> <span class="n">astMotionStageMax</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="n">astPositionState1</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">astPositionState2</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">astPositionState3</span> <span class="o">:=</span> <span class="n">astPositionStateMax</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate1d-inout">FB_PositionState1D_InOut</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-core">FB_PositionStateND_Core</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmpsnd-core">FB_PositionStatePMPSND_Core</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsepicstoplc">ST_StatePMPSEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsplctoepics">ST_StatePMPSPlcToEpics</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps-base">
<h2>FB_PositionStatePMPS_Base<a class="headerlink" href="#fb-positionstatepmps-base" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionStatePMPS1D instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS_Base</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">FB_PositionStatePMPS</span> <span class="n">without</span> <span class="n">Arbiter</span><span class="p">,</span> <span class="n">BPTM</span><span class="p">,</span> <span class="n">FFO</span>

    <span class="n">This</span> <span class="n">allows</span> <span class="n">me</span> <span class="n">to</span> <span class="n">test</span> <span class="n">most</span> <span class="n">of</span> <span class="n">the</span> <span class="n">code</span> <span class="n">without</span> <span class="n">an</span> <span class="n">arbiter</span> <span class="n">plc</span> <span class="n">setup</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bArbiterEnabled</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MAINT</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">bMaintMode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bRequestTransition</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">setState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">getState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">fStateBoundaryDeadband</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">tArbiterTimeout</span><span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#1s;</span>
    <span class="n">bMoveOnArbiterTimeout</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bTransitionAuthorized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bForwardAuthorized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBackwardAuthorized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bArbiterTimeout</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">TRANS</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">stTransitionDb</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
    <span class="n">stTransitionBeam</span><span class="p">:</span> <span class="n">ST_BeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">;</span>
    <span class="n">stTransitionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bTransDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtTransReq</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bBPTMDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtBPTMDone</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftMotorExec</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">rtTransDone</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtDoLateFinish</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tonDone</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">stStateReq</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">mcPower</span><span class="p">:</span> <span class="n">MC_POWER</span><span class="p">;</span>
    <span class="n">fUpperBound</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fLowerBound</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nGoalState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">stGoalState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fActPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fReqPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bInTransition</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">stBeamNeeded</span><span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
    <span class="n">bFwdOk</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBwdOk</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">tonArbiter</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bLateFinish</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bInternalAuth</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">meant</span> <span class="n">to</span> <span class="n">be</span> <span class="n">subclassed</span><span class="o">.</span> <span class="n">The</span> <span class="n">parent</span> <span class="k">class</span> <span class="nc">body</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">Exec</span> <span class="n">action</span><span class="o">.</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">AssertHere</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ClearAsserts</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">Exec</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Load</span> <span class="n">the</span> <span class="n">pmps</span> <span class="n">parameters</span> <span class="k">as</span> <span class="n">needed</span>
<span class="n">HandlePmpsDb</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Initialize</span> <span class="ow">or</span> <span class="n">reinitialize</span> <span class="n">to</span> <span class="n">the</span> <span class="n">current</span> <span class="n">state</span> <span class="n">value</span>
<span class="n">rtBPTMDone</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bBPTMDone</span><span class="p">);</span>
<span class="n">ftMotorExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">tonDone</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bTransDone</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#100ms</span>
    <span class="p">);</span>
<span class="n">IF</span> <span class="n">rtBPTMDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">ftMotorExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">tonDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">bInit</span> <span class="n">OR</span> <span class="n">nGoalState</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">OR</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="n">R</span><span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAxisParamsInit</span><span class="p">;</span>
    <span class="n">nGoalState</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
    <span class="n">stStateReq</span> <span class="o">:=</span> <span class="n">GetStateStruct</span><span class="p">(</span><span class="n">getState</span><span class="p">);</span>
    <span class="n">bInTransition</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">rtTransReq</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">bTransitionAuthorized</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bArbiterTimeout</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Request</span> <span class="n">transition</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span>
<span class="n">rtTransReq</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bRequestTransition</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtTransReq</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">nGoalState</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>
    <span class="n">stStateReq</span> <span class="o">:=</span> <span class="n">GetStateStruct</span><span class="p">(</span><span class="n">setState</span><span class="p">);</span>
    <span class="n">bInTransition</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bTransDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bTransDone</span> <span class="o">:=</span> <span class="n">F_AtPositionState</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span> <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stStateReq</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Mark</span> <span class="n">late</span> <span class="n">finish</span> <span class="k">if</span> <span class="n">bTransDone</span> <span class="o">-&gt;</span> <span class="n">true</span> <span class="n">before</span> <span class="n">the</span> <span class="n">bptm</span> <span class="ow">is</span> <span class="n">done</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">means</span> <span class="n">that</span> <span class="n">we</span> <span class="n">finished</span> <span class="n">the</span> <span class="n">move</span> <span class="n">so</span> <span class="n">fast</span> <span class="n">that</span> <span class="n">the</span> <span class="n">bptm</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">unstuck</span> <span class="n">via</span> <span class="n">toggling</span> <span class="n">bTransDone</span>
<span class="n">rtTransDone</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bTransDone</span><span class="p">);</span>
<span class="n">bLateFinish</span> <span class="n">S</span><span class="o">=</span> <span class="n">rtTransDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bBPTMDone</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bArbiterEnabled</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Handles</span> <span class="n">getting</span> <span class="n">the</span> <span class="n">request</span> <span class="n">to</span> <span class="n">the</span> <span class="n">arbiter</span> <span class="ow">and</span> <span class="n">back</span>
    <span class="n">HandleBPTM</span><span class="p">();</span>
    <span class="o">//</span> <span class="n">Handle</span> <span class="n">arbiter</span> <span class="n">timeouts</span>
    <span class="n">IF</span> <span class="n">tArbiterTimeout</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#0s THEN</span>
        <span class="n">tonArbiter</span><span class="p">(</span>
            <span class="n">IN</span><span class="o">:=</span><span class="n">bInTransition</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bInternalAuth</span><span class="p">,</span>
            <span class="n">PT</span><span class="o">:=</span><span class="n">tArbiterTimeout</span><span class="p">,</span>
            <span class="n">Q</span><span class="o">=&gt;</span><span class="n">bArbiterTimeout</span><span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">bArbiterTimeout</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">bTransitionAuthorized</span> <span class="n">S</span><span class="o">=</span> <span class="n">bInternalAuth</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bArbiterTimeout</span> <span class="n">AND</span> <span class="n">bMoveOnArbiterTimeout</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="o">//</span> <span class="n">Clear</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">our</span> <span class="n">assertions</span> <span class="k">if</span> <span class="n">we</span> <span class="n">decide</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">the</span> <span class="n">arbiter</span>
    <span class="n">ClearAsserts</span><span class="p">();</span>
    <span class="o">//</span> <span class="n">Do</span> <span class="n">some</span> <span class="n">dummy</span> <span class="n">request</span> <span class="n">handling</span>
    <span class="n">bTransitionAuthorized</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">bArbiterTimeout</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">up</span> <span class="n">MPS</span> <span class="n">virtual</span> <span class="n">limit</span> <span class="k">for</span> <span class="n">moves</span> <span class="n">at</span> <span class="ow">and</span> <span class="n">between</span> <span class="n">states</span>
<span class="n">stGoalState</span> <span class="o">:=</span> <span class="n">GetStateStruct</span><span class="p">(</span><span class="n">nGoalState</span><span class="p">);</span>
<span class="n">fActPos</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">fReqPos</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">fReqPos</span> <span class="o">:=</span> <span class="n">fActPos</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Start</span> <span class="k">with</span> <span class="n">no</span> <span class="n">move</span> <span class="n">authority</span>
<span class="n">bForwardAuthorized</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">bBackwardAuthorized</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">it</span> <span class="n">would</span> <span class="n">be</span> <span class="n">OK</span> <span class="n">to</span> <span class="n">move</span> <span class="n">without</span> <span class="n">granting</span> <span class="n">auth</span>
<span class="n">bFwdOk</span> <span class="o">:=</span> <span class="n">F_PosUnderUpperBound</span><span class="p">(</span><span class="n">MAX</span><span class="p">(</span><span class="n">fActPos</span><span class="p">,</span> <span class="n">fReqPos</span><span class="p">)</span> <span class="o">+</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fStateBoundaryDeadband</span><span class="p">),</span> <span class="n">stGoalState</span><span class="p">);</span>
<span class="n">bBwdOk</span> <span class="o">:=</span> <span class="n">F_PosOverLowerBound</span><span class="p">(</span><span class="n">MIN</span><span class="p">(</span><span class="n">fActPos</span><span class="p">,</span> <span class="n">fReqPos</span><span class="p">)</span> <span class="o">-</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fStateBoundaryDeadband</span><span class="p">),</span> <span class="n">stGoalState</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Grant</span> <span class="n">auth</span> <span class="n">during</span> <span class="n">moves</span> <span class="n">based</span> <span class="n">on</span> <span class="n">goal</span> <span class="n">state</span><span class="p">,</span> <span class="n">current</span> <span class="n">position</span><span class="p">,</span> <span class="ow">and</span> <span class="n">goal</span> <span class="n">position</span>
<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">stGoalState</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
    <span class="n">bForwardAuthorized</span> <span class="o">:=</span> <span class="n">bFwdOk</span><span class="p">;</span>
    <span class="n">bBackwardAuthorized</span> <span class="o">:=</span> <span class="n">bBwdOk</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bInTransition</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Deny</span> <span class="n">auth</span> <span class="n">during</span> <span class="n">a</span> <span class="n">transition</span> <span class="n">request</span> <span class="n">until</span> <span class="n">transition</span> <span class="ow">is</span> <span class="n">authorized</span>
    <span class="n">bForwardAuthorized</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bTransitionAuthorized</span><span class="p">;</span>
    <span class="n">bBackwardAuthorized</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bTransitionAuthorized</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Have</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">permission</span> <span class="n">to</span> <span class="n">start</span> <span class="n">move</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">immediately</span> <span class="n">erroring</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">bTransitionAuthorized</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="o">//</span> <span class="n">If</span> <span class="ow">not</span> <span class="n">transitioning</span><span class="p">,</span> <span class="n">no</span> <span class="n">need</span> <span class="n">to</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">safety</span><span class="p">:</span> <span class="n">immediately</span> <span class="k">try</span> <span class="n">to</span> <span class="n">move</span> <span class="ow">and</span> <span class="n">error</span> <span class="k">if</span> <span class="n">no</span> <span class="n">auth</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">an</span> <span class="n">error</span> <span class="n">message</span> <span class="n">override</span> <span class="ow">in</span> <span class="n">case</span> <span class="n">this</span> <span class="n">causes</span> <span class="n">an</span> <span class="n">error</span>
    <span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">bArbiterEnabled</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bMaintMode</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">fReqPos</span> <span class="o">&gt;</span> <span class="n">fActPos</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bFwdOk</span> <span class="n">THEN</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Unsafe tweak forward blocked by PMPS&#39;</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fReqPos</span> <span class="o">&lt;</span> <span class="n">fActPos</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bBwdOk</span> <span class="n">THEN</span>
            <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Unsafe tweak backward blocked by PMPS&#39;</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bArbiterEnabled</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bMaintMode</span> <span class="n">THEN</span>
<span class="o">//</span> <span class="n">Only</span> <span class="n">let</span> <span class="n">us</span> <span class="n">move</span> <span class="k">if</span> <span class="n">the</span> <span class="n">transition</span> <span class="ow">is</span> <span class="n">allowed</span><span class="p">,</span> <span class="ow">or</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="n">moving</span> <span class="n">within</span> <span class="n">a</span> <span class="n">state</span><span class="s1">&#39;s bounds</span>
    <span class="n">mcPower</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">Enable</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span><span class="p">,</span>
            <span class="n">Enable_Positive</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllForwardEnable</span> <span class="n">AND</span> <span class="n">bForwardAuthorized</span><span class="p">,</span>
            <span class="n">Enable_Negative</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllBackwardEnable</span> <span class="n">AND</span> <span class="n">bBackwardAuthorized</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">mcPower</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
            <span class="n">Enable</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span><span class="p">,</span>
            <span class="n">Enable_Positive</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">,</span>
            <span class="n">Enable_Negative</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllBackwardEnable</span><span class="p">);</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Raise</span> <span class="n">fast</span> <span class="n">faults</span> <span class="k">as</span> <span class="n">needed</span>
<span class="n">stBeamNeeded</span> <span class="o">:=</span> <span class="n">GetBeamFromState</span><span class="p">(</span><span class="n">getState</span><span class="p">);</span>
<span class="n">HandleFFO</span><span class="p">();</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandleBPTM</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandleFFO</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandlePmpsDb</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">METHOD</span> <span class="n">GetBeamFromState</span> <span class="p">:</span> <span class="n">ST_BeamParams</span><span class="p">;</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">stState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stState</span> <span class="o">:=</span> <span class="n">GetStateStruct</span><span class="p">(</span><span class="n">nState</span><span class="p">);</span>
<span class="n">GetBeamFromState</span> <span class="o">:=</span> <span class="n">stState</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">stBeamParams</span><span class="p">;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">GetStateCode</span> <span class="p">:</span> <span class="n">INT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">nState</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">OR</span> <span class="n">nState</span> <span class="o">&gt;</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">THEN</span>
    <span class="n">GetStateCode</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">GetStateCode</span> <span class="o">:=</span> <span class="n">nState</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">GetStateStruct</span> <span class="p">:</span> <span class="n">ST_PositionState</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">{</span><span class="n">warning</span> <span class="n">disable</span> <span class="n">C0371</span><span class="p">}</span>
<span class="o">//</span> <span class="n">Implicit</span> <span class="n">VAR_IN_OUT</span> <span class="n">reference</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">method</span> <span class="n">needs</span> <span class="n">special</span> <span class="n">handling</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">__ISVALIDREF</span><span class="p">(</span><span class="n">arrStates</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">GetStateStruct</span> <span class="o">:=</span> <span class="n">stTransitionState</span><span class="p">;</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">CASE</span> <span class="n">GetStateCode</span><span class="p">(</span><span class="n">nState</span><span class="p">)</span> <span class="n">OF</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">GetStateStruct</span> <span class="o">:=</span> <span class="n">stTransitionState</span><span class="p">;</span>
    <span class="mi">0</span><span class="p">:</span> <span class="n">GetStateStruct</span> <span class="o">:=</span> <span class="n">stTransitionState</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">GetStateStruct</span> <span class="o">:=</span> <span class="n">arrStates</span><span class="p">[</span><span class="n">nState</span><span class="p">];</span>
<span class="n">END_CASE</span>
<span class="p">{</span><span class="n">warning</span> <span class="n">restore</span> <span class="n">C0371</span><span class="p">}</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstatepmps">FB_PositionStatePMPS</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#f-posoverlowerbound">F_PosOverLowerBound</a></p></li>
<li><p><a class="reference internal" href="#f-posunderupperbound">F_PosUnderUpperBound</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmps-test">
<h2>FB_PositionStatePMPS_Test<a class="headerlink" href="#fb-positionstatepmps-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;No longer any reason to use this, all state classes can have unit tests.&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPS_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStatePMPS_Base</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Implement</span> <span class="n">position</span> <span class="n">state</span> <span class="n">pmps</span> <span class="k">with</span> <span class="n">no</span> <span class="n">FFO</span> <span class="ow">and</span> <span class="n">auto</span><span class="o">-</span><span class="n">accept</span> <span class="n">transition</span> <span class="n">after</span> <span class="mi">3</span><span class="n">s</span>
    <span class="n">Use</span> <span class="k">for</span> <span class="n">offline</span> <span class="n">testing</span> <span class="n">of</span> <span class="n">everything</span> <span class="k">except</span> <span class="n">the</span> <span class="n">explicit</span> <span class="n">interface</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">tonReq</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">Exec</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">HandleBPTM</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Send</span> <span class="n">the</span> <span class="n">fake</span> <span class="n">BPTM</span> <span class="n">our</span> <span class="n">assertion</span> <span class="n">request</span> <span class="n">by</span> <span class="n">changing</span> <span class="n">stStateReq</span><span class="o">.</span><span class="n">stBeamParams</span>
<span class="o">//</span> <span class="n">We</span> <span class="n">expect</span> <span class="n">to</span> <span class="n">recieve</span> <span class="n">bTransitionAuthorized</span> <span class="n">TRUE</span> <span class="n">after</span> <span class="n">some</span> <span class="n">delta</span> <span class="n">T</span>
<span class="o">//</span> <span class="n">We</span> <span class="n">expect</span> <span class="n">bTransitionAuthorized</span> <span class="n">to</span> <span class="n">go</span> <span class="n">FALSE</span> <span class="n">after</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">goes</span> <span class="n">FALSE</span>
<span class="n">tonReq</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bInTransition</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#3s);</span>
<span class="n">bTransitionAuthorized</span> <span class="o">:=</span> <span class="n">tonReq</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">HandleFFO</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Skip</span> <span class="n">implementing</span> <span class="n">this</span> <span class="k">for</span> <span class="n">offline</span> <span class="n">testing</span>
<span class="o">//</span> <span class="n">We</span> <span class="n">won</span><span class="s1">&#39;t be able to tell if it worked anyway</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstatepmps-base">FB_PositionStatePMPS_Base</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmpsnd-core">
<h2>FB_PositionStatePMPSND_Core<a class="headerlink" href="#fb-positionstatepmpsnd-core" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPSND_Core</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Collection</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">core</span> <span class="n">actions</span> <span class="n">shared</span> <span class="n">between</span> <span class="nb">all</span> <span class="n">PMPS</span> <span class="n">states</span> <span class="n">FBs</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS1D</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS2D</span>
    <span class="o">-</span> <span class="o">...</span> <span class="n">etc</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">handles</span> <span class="n">database</span> <span class="n">reading</span><span class="p">,</span> <span class="n">BPTM</span><span class="p">,</span> <span class="n">motor</span> <span class="n">enables</span><span class="p">,</span> <span class="n">virtual</span> <span class="n">limits</span><span class="p">,</span> <span class="ow">and</span> <span class="nb">all</span> <span class="n">FFOS</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">be</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">states</span> <span class="n">move</span><span class="p">,</span> <span class="n">including</span> <span class="n">blank</span><span class="o">/</span><span class="n">uninitialized</span> <span class="n">structs</span><span class="o">.</span>
    <span class="n">astMotionStageMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">motors</span><span class="p">,</span> <span class="n">including</span> <span class="n">unused</span><span class="o">/</span><span class="n">invalid</span> <span class="n">states</span><span class="o">.</span>
    <span class="n">astPositionStateMax</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stPMPSEpicsToPlc</span><span class="p">:</span> <span class="n">ST_StatePMPSEpicsToPlc</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Normal</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">EPICS</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">gathered</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">struct</span>
    <span class="n">stPMPSPlcToEpics</span><span class="p">:</span> <span class="n">ST_StatePMPSPlcToEpics</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">to</span> <span class="n">be</span> <span class="n">included</span> <span class="ow">in</span> <span class="n">astMotionStageMax</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">index</span> <span class="n">goal</span><span class="p">,</span> <span class="n">where</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">supposed</span> <span class="n">to</span> <span class="n">be</span> <span class="n">moving</span> <span class="n">towards</span><span class="o">.</span>
    <span class="n">nCurrGoal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbMotionReadPMPSDB</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND</span><span class="p">;</span>
    <span class="n">fbMotionBPTM</span><span class="p">:</span> <span class="n">FB_MotionBPTM</span><span class="p">;</span>
    <span class="n">fbMotionClearAsserts</span><span class="p">:</span> <span class="n">FB_MotionClearAsserts</span><span class="p">;</span>
    <span class="n">fbStatePMPSEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnablesND</span><span class="p">;</span>
    <span class="n">fbMiscStatesErrorFFO</span><span class="p">:</span> <span class="n">FB_MiscStatesErrorFFO</span><span class="p">;</span>
    <span class="n">fbPerMotorFFO</span><span class="p">:</span> <span class="n">FB_PerMotorFFOND</span><span class="p">;</span>

    <span class="n">eStatePMPSStatus</span><span class="p">:</span> <span class="n">E_StatePMPSStatus</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">stPMPSEpicsToPlc</span><span class="o">.</span><span class="n">bMaintMode</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">stPMPSEpicsToPlc</span><span class="o">.</span><span class="n">bArbiterEnabled</span> <span class="n">THEN</span>
    <span class="n">eStatePMPSStatus</span> <span class="o">:=</span> <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">nCurrGoal</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">eStatePMPSStatus</span> <span class="o">:=</span> <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span> <span class="o">=</span> <span class="n">nCurrGoal</span> <span class="n">THEN</span>
    <span class="n">eStatePMPSStatus</span> <span class="o">:=</span> <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">AT_STATE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">eStatePMPSStatus</span> <span class="o">:=</span> <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">TRANSITION</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbMotionReadPMPSDB</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">bReadNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">astDbStateParams</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bError</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMotionBPTM</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">stGoalParams</span><span class="o">:=</span><span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">nCurrGoal</span><span class="p">],</span>
    <span class="n">stTransParams</span><span class="o">:=</span><span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="n">nActiveMotorCount</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">stPMPSEpicsToPlc</span><span class="o">.</span><span class="n">bArbiterEnabled</span> <span class="n">AND</span> <span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bAtState</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span> <span class="o">=</span> <span class="n">nCurrGoal</span> <span class="n">AND</span> <span class="n">nCurrGoal</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">bTransitionAuthorized</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bDone</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bMotorCountError</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbMotionClearAsserts</span><span class="p">(</span>
    <span class="n">astDbStateParams</span><span class="o">:=</span><span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">fbMotionBPTM</span><span class="o">.</span><span class="n">bEnable</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbStatePMPSEnables</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionStateMax</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="n">nActiveMotorCount</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nCurrGoal</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">bMaintMode</span><span class="o">:=</span><span class="n">stPMPSEpicsToPlc</span><span class="o">.</span><span class="n">bMaintMode</span><span class="p">,</span>
    <span class="n">eStatePMPSStatus</span><span class="o">:=</span><span class="n">eStatePMPSStatus</span><span class="p">,</span>
    <span class="n">bTransitionAuthorized</span><span class="o">:=</span><span class="n">fbMotionBPTM</span><span class="o">.</span><span class="n">bTransitionAuthorized</span><span class="p">,</span>
    <span class="n">abEnabled</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">abForwardEnabled</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">abBackwardEnabled</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">abValidGoal</span><span class="o">=&gt;</span><span class="p">,</span>
    <span class="n">bMotorCountError</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">bEnableBeamParams</span> <span class="n">THEN</span>
    <span class="n">fbMiscStatesErrorFFO</span><span class="o">.</span><span class="n">stCurrentBeamReq</span> <span class="o">:=</span> <span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">fbMiscStatesErrorFFO</span><span class="o">.</span><span class="n">stCurrentBeamReq</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">fbMiscStatesErrorFFO</span><span class="p">(</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">nTransitionID</span><span class="o">:=</span><span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbPerMotorFFO</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStageMax</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="n">nActiveMotorCount</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">bMotorCountError</span><span class="o">=&gt;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stPMPSPlcToEpics</span><span class="o">.</span><span class="n">stTransitionDb</span> <span class="o">:=</span> <span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">stDbStateParams</span> <span class="o">:=</span> <span class="n">fbMotionReadPMPSDB</span><span class="o">.</span><span class="n">astDbStateParams</span><span class="p">[</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">nGetValue</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-statepmpsstatus">E_StatePMPSStatus</a></p></li>
<li><p><a class="reference internal" href="#fb-miscstateserrorffo">FB_MiscStatesErrorFFO</a></p></li>
<li><p><a class="reference internal" href="#fb-motionbptm">FB_MotionBPTM</a></p></li>
<li><p><a class="reference internal" href="#fb-motionclearasserts">FB_MotionClearAsserts</a></p></li>
<li><p><a class="reference internal" href="#fb-motionreadpmpsdbnd">FB_MotionReadPMPSDBND</a></p></li>
<li><p><a class="reference internal" href="#fb-permotorffond">FB_PerMotorFFOND</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps2d">FB_PositionStatePMPS2D</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenablesnd">FB_StatePMPSEnablesND</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsepicstoplc">ST_StatePMPSEpicsToPlc</a></p></li>
<li><p><a class="reference internal" href="#st-statepmpsplctoepics">ST_StatePMPSPlcToEpics</a></p></li>
<li><p><a class="reference internal" href="#st-stateplctoepics">ST_StatePlcToEpics</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatepmpsnd-test">
<h2>FB_PositionStatePMPSND_Test<a class="headerlink" href="#fb-positionstatepmpsnd-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStatePMPSND_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Sanity</span> <span class="n">checks</span> <span class="k">for</span> <span class="n">the</span> <span class="n">following</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS1D</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS2D</span>
    <span class="o">-</span> <span class="n">FB_PositionStatePMPS3D</span>
    <span class="n">The</span> <span class="n">internals</span> <span class="n">have</span> <span class="n">already</span> <span class="n">been</span> <span class="n">tested</span><span class="p">,</span> <span class="n">but</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">that</span>
    <span class="n">they</span><span class="s1">&#39;ve been put together at least somewhat sensibly.</span>
    <span class="n">This</span> <span class="n">FB</span> <span class="n">will</span> <span class="n">simply</span> <span class="n">use</span> <span class="n">each</span> <span class="n">FB</span> <span class="n">to</span> <span class="n">move</span> <span class="ow">and</span> <span class="n">check</span> <span class="n">the</span> <span class="n">results</span><span class="o">.</span>
    <span class="n">In</span> <span class="n">addition</span> <span class="n">to</span> <span class="n">reaching</span> <span class="n">the</span> <span class="n">goals</span><span class="p">,</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">check</span> <span class="n">the</span> <span class="n">beam</span> <span class="n">assertions</span>
    <span class="ow">and</span> <span class="n">the</span> <span class="n">pmps</span> <span class="n">limit</span> <span class="n">enables</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage1</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStage2</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stMotionStage3</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">afbMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="n">astBeam</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>

    <span class="n">fb_Move1D</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS1D</span><span class="p">;</span>
    <span class="n">fb_Move2D</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS2D</span><span class="p">;</span>
    <span class="n">fb_Move3D</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS3D</span><span class="p">;</span>

    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fTestStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bStatesReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">eSetPos</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
    <span class="n">eGetPos</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>

    <span class="n">fbArbiter1D</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">fbArbiter2D</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">fbArbiter3D</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

    <span class="n">fbSubSysIO1D</span><span class="p">:</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>
    <span class="n">fbSubSysIO2D</span><span class="p">:</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>
    <span class="n">fbSubSysIO3D</span><span class="p">:</span> <span class="n">FB_DummyArbIO</span><span class="p">;</span>

    <span class="n">jsonHelper</span><span class="p">:</span> <span class="n">FB_PMPSJsonTestHelper</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">0.5</span><span class="p">;</span>
    <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">0.5</span><span class="p">;</span>
    <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">0.5</span><span class="p">;</span>
    <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]);</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">][</span><span class="mi">3</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState1</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState2</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState3</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage1</span><span class="p">);</span>
<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage2</span><span class="p">);</span>
<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage3</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Startup</span> <span class="n">tests</span><span class="p">,</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">enabled</span> <span class="n">so</span> <span class="n">we</span> <span class="n">can</span> <span class="n">inspect</span> <span class="n">MC_Power</span><span class="s1">&#39;s output</span>
    <span class="o">//</span> <span class="n">Otherwise</span> <span class="n">we</span> <span class="n">can</span><span class="s1">&#39;t snoop on the PlcToNc control DWORD since this is all 0&#39;</span><span class="n">s</span> <span class="k">if</span> <span class="n">disabled</span>
    <span class="o">//</span> <span class="n">When</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">some</span> <span class="n">of</span> <span class="n">the</span> <span class="n">other</span> <span class="n">bits</span> <span class="n">go</span> <span class="n">to</span> <span class="mi">1</span> <span class="n">to</span> <span class="n">represent</span> <span class="n">directional</span> <span class="n">enables</span>
    <span class="n">stMotionStage1</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
    <span class="n">stMotionStage2</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
    <span class="n">stMotionStage3</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="o">//</span> <span class="n">Otherwise</span><span class="p">,</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">most</span> <span class="n">complicated</span> <span class="n">mode</span> <span class="p">(</span><span class="ow">and</span> <span class="n">the</span> <span class="n">default</span><span class="p">)</span> <span class="n">works</span>
    <span class="n">stMotionStage1</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>
    <span class="n">stMotionStage2</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>
    <span class="n">stMotionStage3</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">E_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">);</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">);</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="mi">3</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">);</span>

<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cst0RateBeam</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="s1">&#39;trans&#39;</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="s1">&#39;out&#39;</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="s1">&#39;target1&#39;</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nTran</span> <span class="o">:=</span> <span class="mf">0.01</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="s1">&#39;target2&#39;</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Assign</span> <span class="n">beam</span> <span class="n">params</span> <span class="n">to</span> <span class="n">states</span> <span class="mi">1</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span> <span class="o">:=</span> <span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span> <span class="o">:=</span> <span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">];</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">stPMPS</span> <span class="o">:=</span> <span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">];</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">some</span> <span class="n">names</span> <span class="k">for</span> <span class="n">maybe</span> <span class="n">help</span> <span class="ow">in</span> <span class="n">debug</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TARGET1&#39;</span><span class="p">;</span>
<span class="n">astPositionState1</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TARGET2&#39;</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TARGET1&#39;</span><span class="p">;</span>
<span class="n">astPositionState2</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TARGET2&#39;</span><span class="p">;</span>
<span class="n">astPositionState3</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">astPositionState3</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TARGET1&#39;</span><span class="p">;</span>
<span class="n">astPositionState3</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TARGET2&#39;</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Load</span> <span class="n">a</span> <span class="n">fake</span> <span class="n">json</span> <span class="n">doc</span> <span class="n">to</span> <span class="n">be</span> <span class="n">consumed</span> <span class="n">by</span> <span class="n">our</span> <span class="n">FB</span>
<span class="n">jsonHelper</span><span class="p">(</span>
    <span class="n">astBeamParams</span><span class="o">:=</span><span class="n">astBeam</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">nTestCounter</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t run any tests until the states are ready</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">TestStartup1D</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">TestStartup2D</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">TestStartup3D</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">Test1D</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">);</span>
<span class="n">Test1D</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">);</span>
<span class="n">Test1D</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">);</span>
<span class="n">Test2D</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">);</span>
<span class="n">Test2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">);</span>
<span class="n">Test2D</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">);</span>
<span class="n">Test3D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">OUT</span><span class="p">);</span>
<span class="n">Test3D</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">);</span>
<span class="n">Test3D</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">E_TestStates</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bStatesReady</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">AssertMotionLims</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">eState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
    <span class="n">sID</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nExpected</span><span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">F_AtPositionState</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">,</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">eState</span><span class="p">])</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Both</span> <span class="n">allowed</span>
    <span class="n">nExpected</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#111;</span>
<span class="n">ELSIF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&lt;</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Only</span> <span class="o">+</span> <span class="n">allowed</span>
    <span class="n">nExpected</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#011;</span>
<span class="n">ELSE</span>
    <span class="o">//</span> <span class="n">Only</span> <span class="o">-</span> <span class="n">allowed</span>
    <span class="n">nExpected</span> <span class="o">:=</span> <span class="mi">2</span><span class="c1">#101;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">nExpected</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Wrong control dword in test &#39;</span><span class="p">,</span> <span class="n">sID</span><span class="p">),</span>
    <span class="p">);</span>
    <span class="n">AssertMotionLims</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Test1D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">eState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimAsserted</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Test1D_state&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">eState</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbSubSysIO1D</span><span class="p">(</span>
    <span class="n">LA</span><span class="o">:=</span><span class="n">fbArbiter1D</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fb_Move1D</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter1D</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInit</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">When</span> <span class="n">ready</span><span class="p">:</span> <span class="n">check</span> <span class="n">that</span> <span class="n">directonal</span> <span class="n">enables</span> <span class="n">are</span> <span class="n">correct</span>
<span class="n">bLimAsserted</span> <span class="n">S</span><span class="o">=</span> <span class="n">AssertMotionLims</span><span class="p">(</span><span class="n">stMotionStage1</span><span class="p">,</span> <span class="n">astPositionState1</span><span class="p">,</span> <span class="n">eState</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;1D mot 1 state &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>


<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">bLimAsserted</span><span class="p">,</span>
        <span class="s1">&#39;Skipped limit assert test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be True after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">eState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter1D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;Destination bp should have been in the arbiter&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move1D</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
        <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter1D</span><span class="p">,</span>
        <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bLimAsserted</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Test2D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">eState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimAsserted1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimAsserted2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Test2D_state&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">eState</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbSubSysIO2D</span><span class="p">(</span>
    <span class="n">LA</span><span class="o">:=</span><span class="n">fbArbiter2D</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fb_Move2D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter2D</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInit</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">When</span> <span class="n">ready</span><span class="p">:</span> <span class="n">check</span> <span class="n">that</span> <span class="n">directonal</span> <span class="n">enables</span> <span class="n">are</span> <span class="n">correct</span>
<span class="n">bLimAsserted1</span> <span class="n">S</span><span class="o">=</span> <span class="n">AssertMotionLims</span><span class="p">(</span><span class="n">stMotionStage1</span><span class="p">,</span> <span class="n">astPositionState1</span><span class="p">,</span> <span class="n">eState</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;2D mot 1 state &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>
<span class="n">bLimAsserted2</span> <span class="n">S</span><span class="o">=</span> <span class="n">AssertMotionLims</span><span class="p">(</span><span class="n">stMotionStage2</span><span class="p">,</span> <span class="n">astPositionState2</span><span class="p">,</span> <span class="n">eState</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;2D mot 2 state &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">bLimAsserted1</span> <span class="n">AND</span> <span class="n">bLimAsserted2</span><span class="p">,</span>
        <span class="s1">&#39;Skipped limit assert test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be True after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">eState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter2D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;Destination bp should have been in the arbiter&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move2D</span><span class="p">(</span>
        <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
        <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter2D</span><span class="p">,</span>
        <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bLimAsserted1</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bLimAsserted2</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">Test3D</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">eState</span><span class="p">:</span> <span class="n">E_TestStates</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimAsserted1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimAsserted2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimAsserted3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Test3D_state&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">eSetPos</span> <span class="o">:=</span> <span class="n">eState</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbSubSysIO3D</span><span class="p">(</span>
    <span class="n">LA</span><span class="o">:=</span><span class="n">fbArbiter3D</span><span class="p">,</span>
    <span class="n">FFO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fb_Move3D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">stMotionStage3</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">astPositionState3</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter3D</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInit</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">When</span> <span class="n">ready</span><span class="p">:</span> <span class="n">check</span> <span class="n">that</span> <span class="n">directonal</span> <span class="n">enables</span> <span class="n">are</span> <span class="n">correct</span>
<span class="n">bLimAsserted1</span> <span class="n">S</span><span class="o">=</span> <span class="n">AssertMotionLims</span><span class="p">(</span><span class="n">stMotionStage1</span><span class="p">,</span> <span class="n">astPositionState1</span><span class="p">,</span> <span class="n">eState</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;3D mot 1 state &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>
<span class="n">bLimAsserted2</span> <span class="n">S</span><span class="o">=</span> <span class="n">AssertMotionLims</span><span class="p">(</span><span class="n">stMotionStage2</span><span class="p">,</span> <span class="n">astPositionState2</span><span class="p">,</span> <span class="n">eState</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;3D mot 2 state &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>
<span class="n">bLimAsserted3</span> <span class="n">S</span><span class="o">=</span> <span class="n">AssertMotionLims</span><span class="p">(</span><span class="n">stMotionStage3</span><span class="p">,</span> <span class="n">astPositionState3</span><span class="p">,</span> <span class="n">eState</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;3D mot 3 state &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">eState</span><span class="p">)));</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">bLimAsserted1</span> <span class="n">AND</span> <span class="n">bLimAsserted2</span> <span class="n">AND</span> <span class="n">bLimAsserted3</span><span class="p">,</span>
        <span class="s1">&#39;Skipped limit assert test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be True after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error should be False after move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">eState</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not get to the input state position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter3D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">eState</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;Destination bp should have been in the arbiter&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stEpicsToPlc</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fb_Move3D</span><span class="p">(</span>
        <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
        <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
        <span class="n">stMotionStage3</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
        <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
        <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
        <span class="n">astPositionState3</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">,</span>
        <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
        <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
        <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
        <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter3D</span><span class="p">,</span>
        <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bLimAsserted1</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bLimAsserted2</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bLimAsserted3</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestStartup1D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="o">-</span> <span class="n">On</span> <span class="n">startup</span><span class="p">,</span> <span class="n">there</span> <span class="n">should</span> <span class="n">be</span> <span class="n">no</span> <span class="n">move</span> <span class="n">request</span>
    <span class="o">-</span> <span class="n">In</span> <span class="n">this</span> <span class="n">case</span><span class="p">,</span> <span class="n">we</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">unknown</span> <span class="n">state</span> <span class="n">since</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">matching</span> <span class="nb">any</span> <span class="n">state</span> <span class="k">for</span> <span class="nb">any</span> <span class="n">motor</span>
    <span class="o">-</span> <span class="n">Movement</span> <span class="n">should</span> <span class="n">be</span> <span class="n">free</span> <span class="n">but</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">assertion</span> <span class="n">must</span> <span class="n">be</span> <span class="n">active</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestStartup1D&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fb_Move1D</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter1D</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInit</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">sit</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">fb</span> <span class="k">for</span> <span class="n">some</span> <span class="n">timeout</span> <span class="n">number</span> <span class="n">of</span> <span class="n">seconds</span> <span class="n">on</span> <span class="n">purpose</span><span class="p">,</span> <span class="ow">not</span> <span class="n">an</span> <span class="n">error</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">neither</span> <span class="n">be</span> <span class="n">busy</span> <span class="n">nor</span> <span class="n">done</span> <span class="p">(</span><span class="n">we</span> <span class="n">didn</span><span class="s1">&#39;t do anything)</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be False with no move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move1D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False with no move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">still</span> <span class="n">be</span> <span class="n">at</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Why did we move? motor1 should have default position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">move</span> <span class="n">both</span> <span class="n">directions</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">control</span> <span class="n">word</span> <span class="mi">7</span> <span class="p">(</span><span class="mi">2</span><span class="c1">#111)</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#111,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Expected full +/- enables&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter1D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;Transition assertion ID not in pool&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestStartup2D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="o">-</span> <span class="n">On</span> <span class="n">startup</span><span class="p">,</span> <span class="n">there</span> <span class="n">should</span> <span class="n">be</span> <span class="n">no</span> <span class="n">move</span> <span class="n">request</span>
    <span class="o">-</span> <span class="n">Starting</span> <span class="kn">from</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">all</span> <span class="n">motors</span> <span class="n">should</span> <span class="n">only</span> <span class="n">be</span> <span class="n">allowed</span> <span class="n">to</span> <span class="n">move</span> <span class="o">+</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestStartup2D&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fb_Move2D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter2D</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInit</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">sit</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">fb</span> <span class="k">for</span> <span class="n">some</span> <span class="n">timeout</span> <span class="n">number</span> <span class="n">of</span> <span class="n">seconds</span> <span class="n">on</span> <span class="n">purpose</span><span class="p">,</span> <span class="ow">not</span> <span class="n">an</span> <span class="n">error</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">neither</span> <span class="n">be</span> <span class="n">busy</span> <span class="n">nor</span> <span class="n">done</span> <span class="p">(</span><span class="n">we</span> <span class="n">didn</span><span class="s1">&#39;t do anything)</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be False with no move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move2D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False with no move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">still</span> <span class="n">be</span> <span class="n">at</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Why did we move? motor1 should have default position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Why did we move? motor2 should have default position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">move</span> <span class="n">both</span> <span class="n">directions</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">control</span> <span class="n">word</span> <span class="mi">7</span> <span class="p">(</span><span class="mi">2</span><span class="c1">#111)</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#111,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Expected full +/- enables&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#111,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Expected full +/- enables&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter2D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;Transition assertion ID not in pool&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestStartup3D</span>
<span class="p">(</span><span class="o">*</span>
    <span class="o">-</span> <span class="n">On</span> <span class="n">startup</span><span class="p">,</span> <span class="n">there</span> <span class="n">should</span> <span class="n">be</span> <span class="n">no</span> <span class="n">move</span> <span class="n">request</span>
    <span class="o">-</span> <span class="n">Starting</span> <span class="kn">from</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">all</span> <span class="n">motors</span> <span class="n">should</span> <span class="n">only</span> <span class="n">be</span> <span class="n">allowed</span> <span class="n">to</span> <span class="n">move</span> <span class="o">+</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestStartup3D&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fb_Move3D</span><span class="p">(</span>
    <span class="n">stMotionStage1</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="p">,</span>
    <span class="n">stMotionStage2</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="p">,</span>
    <span class="n">stMotionStage3</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="p">,</span>
    <span class="n">astPositionState1</span><span class="o">:=</span><span class="n">astPositionState1</span><span class="p">,</span>
    <span class="n">astPositionState2</span><span class="o">:=</span><span class="n">astPositionState2</span><span class="p">,</span>
    <span class="n">astPositionState3</span><span class="o">:=</span><span class="n">astPositionState3</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eSetPos</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eGetPos</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter3D</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bInit</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">sit</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">fb</span> <span class="k">for</span> <span class="n">some</span> <span class="n">timeout</span> <span class="n">number</span> <span class="n">of</span> <span class="n">seconds</span> <span class="n">on</span> <span class="n">purpose</span><span class="p">,</span> <span class="ow">not</span> <span class="n">an</span> <span class="n">error</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">neither</span> <span class="n">be</span> <span class="n">busy</span> <span class="n">nor</span> <span class="n">done</span> <span class="p">(</span><span class="n">we</span> <span class="n">didn</span><span class="s1">&#39;t do anything)</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Done should be False with no move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fb_Move3D</span><span class="o">.</span><span class="n">stPlcToEpics</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Busy should be False with no move&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">still</span> <span class="n">be</span> <span class="n">at</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Why did we move? motor1 should have default position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Why did we move? motor2 should have default position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Why did we move? motor3 should have default position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">move</span> <span class="n">both</span> <span class="n">directions</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">control</span> <span class="n">word</span> <span class="mi">7</span> <span class="p">(</span><span class="mi">2</span><span class="c1">#111)</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#111,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage1</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Expected full +/- enables&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#111,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage2</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Expected full +/- enables&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_DWORD</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="mi">2</span><span class="c1">#111,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">stMotionStage3</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">PlcToNc</span><span class="o">.</span><span class="n">ControlDWord</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Expected full +/- enables&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbArbiter3D</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">astBeam</span><span class="p">[</span><span class="n">E_TestStates</span><span class="o">.</span><span class="n">Unknown</span><span class="p">]</span><span class="o">.</span><span class="n">nRequestAssertionID</span><span class="p">),</span>
        <span class="s1">&#39;Transition assertion ID not in pool&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-stageenablemode">E_StageEnableMode</a></p></li>
<li><p><a class="reference internal" href="#e-teststates">E_TestStates</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-pmpsjsontesthelper">FB_PMPSJsonTestHelper</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps1d">FB_PositionStatePMPS1D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps2d">FB_PositionStatePMPS2D</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmps3d">FB_PositionStatePMPS3D</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateread">
<h2>FB_PositionStateRead<a class="headerlink" href="#fb-positionstateread" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateRead</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">tells</span> <span class="n">us</span> <span class="n">what</span> <span class="n">state</span> <span class="n">a</span> <span class="n">single</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">at</span><span class="o">.</span>
    <span class="n">In</span> <span class="n">the</span> <span class="n">case</span> <span class="n">of</span> <span class="n">multiple</span> <span class="n">valid</span> <span class="n">overlapping</span> <span class="n">states</span><span class="p">,</span> <span class="n">one</span> <span class="n">will</span> <span class="n">be</span> <span class="n">picked</span> <span class="n">arbitrarily</span><span class="p">,</span>
    <span class="n">but</span> <span class="n">we</span> <span class="n">can</span> <span class="n">see</span> <span class="n">a</span> <span class="n">full</span> <span class="n">description</span> <span class="n">of</span> <span class="n">which</span> <span class="n">overlapping</span> <span class="n">states</span> <span class="n">are</span> <span class="n">present</span> <span class="n">using</span> <span class="n">the</span> <span class="n">abAtPosition</span> <span class="n">array</span><span class="o">.</span>

    <span class="n">This</span> <span class="n">will</span> <span class="n">only</span> <span class="n">run</span> <span class="n">properly</span> <span class="k">if</span> <span class="n">FB_PositionStateInternal</span> <span class="n">has</span> <span class="n">been</span> <span class="n">called</span> <span class="n">on</span> <span class="n">each</span> <span class="n">position</span> <span class="n">state</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">it</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">check</span> <span class="n">the</span> <span class="n">state</span> <span class="n">of</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">allowed</span> <span class="n">states</span> <span class="k">for</span> <span class="n">this</span> <span class="n">motor</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re standing still at a known state, or moving within the bounds of a state to another location in the bounds.</span>
    <span class="n">bKnownState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re moving to some other state or to another non-state position.</span>
    <span class="n">bMovingState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;re at a known state, this will be the index in the astPositionState array that matches the state. Otherwise, this will be 0, which is below the bounds of the array, so it cannot be confused with a valid output.</span>
    <span class="n">nPositionIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">copy</span> <span class="n">of</span> <span class="n">the</span> <span class="n">details</span> <span class="n">of</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="p">,</span> <span class="k">for</span> <span class="n">convenience</span><span class="o">.</span> <span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="n">moving</span> <span class="n">state</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">unknown</span> <span class="n">state</span> <span class="k">as</span> <span class="n">a</span> <span class="n">placeholder</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">a</span> <span class="n">known</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stCurrentPosition</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">full</span> <span class="n">description</span> <span class="n">of</span> <span class="n">whether</span> <span class="n">we</span><span class="s1">&#39;re at each of our states. This is used in 2D, 3D, etc. to clarify cases where states may overlap in 1D.</span>
    <span class="n">abAtPosition</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">bMovingState</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="n">THEN</span>
        <span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">nMaxStates</span> <span class="o">:=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">nMaxStates</span><span class="p">,</span> <span class="n">nIter</span><span class="p">);</span>
    <span class="n">END_IF</span>
    <span class="n">IF</span> <span class="n">F_AtPositionState</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span> <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">])</span> <span class="n">THEN</span>
        <span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">nPositionIndex</span> <span class="o">:=</span> <span class="n">nIter</span><span class="p">;</span>
        <span class="n">stCurrentPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">];</span>
        <span class="n">abAtPosition</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">abAtPosition</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bKnownState</span> <span class="n">THEN</span>
    <span class="n">nPositionIndex</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">bMovingState</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">bMovingState</span> <span class="n">THEN</span>
        <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Moving&#39;</span><span class="p">;</span>
        <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
        <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#f-atpositionstate">F_AtPositionState</a></p></li>
<li><p><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstateread-test">
<h2>FB_PositionStateRead_Test<a class="headerlink" href="#fb-positionstateread-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateRead_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">that</span> <span class="n">FB_PositionStateRead</span> <span class="n">works</span> <span class="n">exactly</span> <span class="n">how</span> <span class="n">it</span> <span class="n">should</span>
    <span class="n">according</span> <span class="n">to</span> <span class="n">its</span> <span class="n">API</span> <span class="n">during</span> <span class="n">normal</span> <span class="ow">and</span> <span class="n">failure</span> <span class="n">states</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">stDummyPos</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbTestMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_PositionStateRead</span><span class="p">;</span>

    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fTestStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bStatesReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;UNO&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;DOS&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;TRES&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;QUATRO&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">4</span> <span class="n">DO</span>
    <span class="n">afbInternal</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">bStatesReady</span> <span class="o">:=</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">At</span> <span class="n">position</span> <span class="mi">1</span> <span class="n">check</span>
<span class="n">TestStaticPosition</span><span class="p">(</span>
    <span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">sTestName</span><span class="o">:=</span><span class="s1">&#39;AtPos1&#39;</span><span class="p">,</span>
    <span class="n">fPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">Outside</span> <span class="n">the</span> <span class="n">deltas</span> <span class="n">check</span>
<span class="n">TestStaticPosition</span><span class="p">(</span>
    <span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sTestName</span><span class="o">:=</span><span class="s1">&#39;OutsidePos1Delta&#39;</span><span class="p">,</span>
    <span class="n">fPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">At</span> <span class="n">invalid</span> <span class="n">state</span> <span class="mi">2</span> <span class="n">check</span>
<span class="n">TestStaticPosition</span><span class="p">(</span>
    <span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">sTestName</span><span class="o">:=</span><span class="s1">&#39;AtInvalidPos&#39;</span><span class="p">,</span>
    <span class="n">fPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">At</span> <span class="n">position</span> <span class="mi">3</span> <span class="n">check</span>
<span class="n">TestStaticPosition</span><span class="p">(</span>
    <span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">sTestName</span><span class="o">:=</span><span class="s1">&#39;AtPos3&#39;</span><span class="p">,</span>
    <span class="n">fPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">At</span> <span class="n">position</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">moving</span> <span class="n">within</span> <span class="n">bounds</span> <span class="n">check</span>
<span class="n">TestMovingPosition</span><span class="p">(</span>
    <span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">sTestName</span><span class="o">:=</span><span class="s1">&#39;MovingAt3&#39;</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">At</span> <span class="n">position</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">moving</span> <span class="n">away</span> <span class="n">check</span>
<span class="n">TestMovingPosition</span><span class="p">(</span>
    <span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">sTestName</span><span class="o">:=</span><span class="s1">&#39;MovingFrom3&#39;</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">bKnownState</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bMovingState</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nPositionIndex</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">stDummyPos</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">TestDupe</span><span class="p">(</span><span class="n">nTestIndex</span><span class="o">:=</span><span class="mi">6</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fbTestMove</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">Asserts</span>
<span class="n">VAR_INPUT</span>
    <span class="n">tTimeout</span><span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
    <span class="n">bKnownState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMovingState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nPositionIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">abExpected</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionstate</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">tTimeout</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Test timed out&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">bKnownState</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">bKnownState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Incorrect bKnownState&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">bMovingState</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">bMovingState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Incorrect bMovingState&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertEquals_DINT</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">nPositionIndex</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">nPositionIndex</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Incorrect nPositionIndex&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">nPositionIndex</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">nPositionIndex</span> <span class="o">&lt;=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">THEN</span>
        <span class="n">abExpected</span><span class="p">[</span><span class="n">nPositionIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
 <span class="n">END_IF</span>
<span class="n">AssertArrayEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expecteds</span><span class="o">:=</span><span class="n">abExpected</span><span class="p">,</span>
    <span class="n">Actuals</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">abAtPosition</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Wrong at position array&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">bKnownState</span> <span class="n">THEN</span>
    <span class="n">AssertEquals_STRING</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">sName</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">stCurrentPosition</span><span class="o">.</span><span class="n">sName</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not provide correct current position struct&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestDupe</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">abExpected</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestDupe&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestIndex</span> <span class="o">&lt;&gt;</span> <span class="n">nTestCounter</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">In</span> <span class="n">this</span> <span class="n">test</span><span class="p">,</span> <span class="ow">and</span> <span class="n">only</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">test</span><span class="p">,</span> <span class="n">we</span> <span class="n">must</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">state</span> <span class="mi">4</span> <span class="ow">is</span> <span class="n">valid</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">abExpected</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">abExpected</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (fbTestMove.bSetDone AND bStatesReady) THEN</span>
    <span class="n">fbRead</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionstate</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_BOOL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Test timed out&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_BOOL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">bKnownState</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Incorrect bKnownState&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertArrayEquals_BOOL</span><span class="p">(</span>
        <span class="n">Expecteds</span><span class="o">:=</span><span class="n">abExpected</span><span class="p">,</span>
        <span class="n">Actuals</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">abAtPosition</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Wrong at position array&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestMovingPosition</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">sTestName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fStartPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fGoalPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bKnownState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMovingState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nPositionIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">sTestName</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestIndex</span> <span class="o">&lt;&gt;</span> <span class="n">nTestCounter</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fStartPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fGoalPosition</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s OR (fbTestMove.bMotionStarted AND bStatesReady) THEN</span>
    <span class="n">Asserts</span><span class="p">(</span>
        <span class="n">tTimeout</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
        <span class="n">bKnownState</span><span class="o">:=</span><span class="n">bKnownState</span><span class="p">,</span>
        <span class="n">bMovingState</span><span class="o">:=</span><span class="n">bMovingState</span><span class="p">,</span>
        <span class="n">nPositionIndex</span><span class="o">:=</span><span class="n">nPositionIndex</span><span class="p">,</span>
        <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">stCurrentPosition</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestStaticPosition</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">sTestName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bKnownState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMovingState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nPositionIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">stCurrentPosition</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">sTestName</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestIndex</span> <span class="o">&lt;&gt;</span> <span class="n">nTestCounter</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#1s OR (fbTestMove.bSetDone AND bStatesReady) THEN</span>
    <span class="n">Asserts</span><span class="p">(</span>
        <span class="n">tTimeout</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1s,</span>
        <span class="n">bKnownState</span><span class="o">:=</span><span class="n">bKnownState</span><span class="p">,</span>
        <span class="n">bMovingState</span><span class="o">:=</span><span class="n">bMovingState</span><span class="p">,</span>
        <span class="n">nPositionIndex</span><span class="o">:=</span><span class="n">nPositionIndex</span><span class="p">,</span>
        <span class="n">stCurrentPosition</span><span class="o">:=</span><span class="n">stCurrentPosition</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateread">FB_PositionStateRead</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove">FB_TestHelperSetAndMove</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatereadnd">
<h2>FB_PositionStateReadND<a class="headerlink" href="#fb-positionstatereadnd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateReadND</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">get</span> <span class="n">the</span> <span class="n">combined</span> <span class="n">N</span><span class="o">-</span><span class="n">dimensional</span> <span class="n">state</span> <span class="n">of</span> <span class="n">a</span> <span class="n">group</span> <span class="n">of</span> <span class="n">motors</span><span class="o">.</span>
    <span class="n">It</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">building</span> <span class="n">block</span> <span class="ow">not</span> <span class="n">meant</span> <span class="k">for</span> <span class="n">use</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">lcls</span><span class="o">-</span><span class="n">twintcat</span><span class="o">-</span><span class="n">motion</span><span class="o">.</span>

    <span class="n">Use</span> <span class="n">FB_PositionStateRead1D</span><span class="p">,</span> <span class="n">FB_PositionStateRead2D</span><span class="p">,</span> <span class="o">...</span> <span class="n">etc</span><span class="o">.</span> <span class="n">instead</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motors</span> <span class="k">with</span> <span class="n">a</span> <span class="n">combined</span> <span class="n">N</span><span class="o">-</span><span class="n">dimensional</span> <span class="n">state</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Each</span> <span class="n">motor</span><span class="s1">&#39;s respective position states along its direction</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">we</span><span class="s1">&#39;re actually using</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re standing still at a known state.</span>
    <span class="n">bKnownState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re moving, there can be no valid state if we are moving.</span>
    <span class="n">bMovingState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;re at a known state, this will be the state index along the enclosed states arrays. Otherwise, it will be zero, which is below the bounds of the states array.</span>
    <span class="n">nPositionIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">active</span> <span class="n">motor</span> <span class="n">count</span> <span class="n">was</span> <span class="n">invalid</span>
    <span class="n">bMotorCountError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">full</span> <span class="n">description</span> <span class="n">of</span> <span class="n">whether</span> <span class="n">we</span><span class="s1">&#39;re at each of our states. This is used to clarify cases where states may overlap.</span>
    <span class="n">abAtPosition</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">individual</span> <span class="n">position</span> <span class="n">state</span> <span class="n">reader</span> <span class="n">function</span> <span class="n">blocks</span>
    <span class="n">afbPositionStateRead</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateRead</span><span class="p">;</span>

    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nIter2</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CheckCount</span><span class="p">();</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMotorCountError</span> <span class="n">THEN</span>
    <span class="n">DoStateReads</span><span class="p">();</span>
    <span class="n">CombineOutputs</span><span class="p">();</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">CheckCount</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">valid</span> <span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">,</span> <span class="n">less</span> <span class="ow">or</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">max</span><span class="p">)</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&gt;</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">CombineOutputs</span><span class="p">:</span>
<span class="o">//</span> <span class="n">bKnownState</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ALL</span> <span class="n">motors</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">known</span> <span class="n">state</span>
<span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">bKnownState</span> <span class="n">AND</span> <span class="n">afbPositionStateRead</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bKnownState</span><span class="p">;</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">bMovingState</span> <span class="ow">is</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">ANY</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">moving</span>
<span class="n">bMovingState</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">bMovingState</span> <span class="o">:=</span> <span class="n">bMovingState</span> <span class="n">OR</span> <span class="n">afbPositionStateRead</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bMovingState</span><span class="p">;</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">To</span> <span class="n">account</span> <span class="k">for</span> <span class="n">redundant</span> <span class="mi">1</span><span class="n">D</span> <span class="n">states</span><span class="p">,</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">check</span> <span class="n">the</span> <span class="n">full</span> <span class="n">output</span> <span class="n">arrays</span><span class="o">.</span>
<span class="n">nPositionIndex</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
    <span class="n">abAtPosition</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">FOR</span> <span class="n">nIter2</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
        <span class="n">abAtPosition</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">afbPositionStateRead</span><span class="p">[</span><span class="n">nIter2</span><span class="p">]</span><span class="o">.</span><span class="n">abAtPosition</span><span class="p">[</span><span class="n">nIter</span><span class="p">];</span>
    <span class="n">END_FOR</span>
    <span class="n">IF</span> <span class="n">abAtPosition</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="n">THEN</span>
        <span class="n">nPositionIndex</span> <span class="o">:=</span> <span class="n">nIter</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>

<span class="o">//</span> <span class="n">Position</span> <span class="n">index</span> <span class="mi">0</span> <span class="n">means</span> <span class="n">different</span> <span class="n">positions</span>
<span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">bKnownState</span> <span class="n">AND</span> <span class="n">nPositionIndex</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">DoStateReads</span><span class="p">:</span>
<span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">nMaxStateMotorCount</span> <span class="o">:=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">nMaxStateMotorCount</span><span class="p">,</span> <span class="n">nActiveMotorCount</span><span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">afbPositionStateRead</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstateread">FB_PositionStateRead</a></p></li>
<li><p><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-positionstatereadnd-test">
<h2>FB_PositionStateReadND_Test<a class="headerlink" href="#fb-positionstatereadnd-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionStateReadND_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Test</span> <span class="n">that</span> <span class="n">FB_PositionStateReadND</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">read</span> <span class="ow">and</span> <span class="n">summarize</span>
    <span class="n">N</span><span class="o">-</span><span class="n">dimensional</span> <span class="n">state</span> <span class="n">positions</span> <span class="n">where</span> <span class="n">multiple</span> <span class="n">motors</span> <span class="n">must</span> <span class="n">move</span> <span class="ow">in</span>
    <span class="n">sync</span> <span class="n">to</span> <span class="n">a</span> <span class="n">shared</span> <span class="n">named</span> <span class="n">state</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">afbMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>

    <span class="n">afbTestMove</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>
    <span class="n">fbRead</span><span class="p">:</span> <span class="n">FB_PositionStateReadND</span><span class="p">;</span>
    <span class="n">bOneAssertDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nAssertCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nIter1</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nIter2</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nIter3</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="n">fbMisRead</span><span class="p">:</span> <span class="n">FB_PositionStateReadND</span><span class="p">;</span>
    <span class="n">astGoodStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astGoodStateShape</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>

    <span class="n">astSqMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">afbSqMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">astSquareStates</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbSqInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..4</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>

    <span class="n">afbSqTestMove</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>
    <span class="n">fbSqRead</span><span class="p">:</span> <span class="n">FB_PositionStateReadND</span><span class="p">;</span>
    <span class="n">bSqAssertDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nSqAssertCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">NO_STATE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">OUT_STATE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">IN_STATE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">IN_TWEAK</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">AWAY</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">LAST_TEST</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="n">AWAY</span><span class="p">;</span>
    <span class="n">TEST_COUNT</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">PerMotor</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">PerMotor</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">PerMotor</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">SquareSetup</span><span class="p">();</span>

<span class="o">//</span> <span class="n">First</span> <span class="n">check</span> <span class="n">the</span> <span class="n">case</span> <span class="n">of</span> <span class="n">mismatched</span> <span class="n">arrays</span>
<span class="n">TestForgot</span><span class="p">();</span>
<span class="n">TestCombos</span><span class="p">(</span><span class="n">nAssertCounter</span><span class="p">);</span>
<span class="n">TestSquare</span><span class="p">(</span><span class="n">nSqAssertCounter</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneAssertDone</span> <span class="n">THEN</span>
    <span class="n">afbTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">afbTestMove</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">afbTestMove</span><span class="p">[</span><span class="mi">3</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">IF</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bResetDone</span> <span class="n">AND</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bResetDone</span> <span class="n">AND</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bResetDone</span> <span class="n">THEN</span>
        <span class="n">bOneAssertDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nAssertCounter</span> <span class="o">:=</span> <span class="n">nAssertCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bSqAssertDone</span> <span class="n">THEN</span>
    <span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">IF</span> <span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bResetDone</span> <span class="n">AND</span> <span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bResetDone</span> <span class="n">THEN</span>
        <span class="n">bSqAssertDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nSqAssertCounter</span> <span class="o">:=</span> <span class="n">nSqAssertCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">DoAssert</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nMotorCase1</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nMotorCase2</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nMotorCase3</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bReady1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReady2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReady3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bKnownState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMovingState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nPositionIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">sTestCase</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">sTestCase</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nMotorCase1</span><span class="p">),</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nMotorCase2</span><span class="p">)),</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nMotorCase3</span><span class="p">));</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">bReady1</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Timeout for motor 1 during test case &#39;</span><span class="p">,</span> <span class="n">sTestCase</span><span class="p">),</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">bReady2</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Timeout for motor 2 during test case &#39;</span><span class="p">,</span> <span class="n">sTestCase</span><span class="p">),</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">bReady3</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Timeout for motor 3 during test case &#39;</span><span class="p">,</span> <span class="n">sTestCase</span><span class="p">),</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">All</span> <span class="n">at</span> <span class="n">OUT</span> <span class="ow">or</span> <span class="nb">all</span> <span class="n">at</span> <span class="n">IN</span> <span class="n">should</span> <span class="n">be</span> <span class="n">OUT</span> <span class="ow">and</span> <span class="n">IN</span> <span class="n">respectively</span><span class="p">,</span> <span class="n">even</span> <span class="k">if</span> <span class="n">doing</span> <span class="n">a</span> <span class="n">tweak</span> <span class="n">move</span>
<span class="o">//</span> <span class="n">Any</span> <span class="n">other</span> <span class="n">combination</span> <span class="ow">is</span> <span class="n">at</span> <span class="n">no</span> <span class="n">state</span>
<span class="n">IF</span> <span class="n">nMotorCase1</span> <span class="o">=</span> <span class="n">OUT_STATE</span> <span class="n">AND</span> <span class="n">nMotorCase2</span> <span class="o">=</span> <span class="n">OUT_STATE</span> <span class="n">AND</span> <span class="n">nMotorCase3</span> <span class="o">=</span> <span class="n">OUT_STATE</span> <span class="n">THEN</span>
    <span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nPositionIndex</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="p">(</span><span class="n">nMotorCase1</span> <span class="o">=</span> <span class="n">IN_STATE</span> <span class="n">OR</span> <span class="n">nMotorCase1</span> <span class="o">=</span> <span class="n">IN_TWEAK</span><span class="p">)</span> <span class="n">AND</span>
      <span class="p">(</span><span class="n">nMotorCase2</span> <span class="o">=</span> <span class="n">IN_STATE</span> <span class="n">OR</span> <span class="n">nMotorCase2</span> <span class="o">=</span> <span class="n">IN_TWEAK</span><span class="p">)</span> <span class="n">AND</span>
      <span class="p">(</span><span class="n">nMotorCase3</span> <span class="o">=</span> <span class="n">IN_STATE</span> <span class="n">OR</span> <span class="n">nMotorCase3</span> <span class="o">=</span> <span class="n">IN_TWEAK</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bKnownState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nPositionIndex</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">In</span> <span class="n">addition</span><span class="p">,</span> <span class="n">bMovingState</span> <span class="n">must</span> <span class="n">be</span> <span class="nb">set</span> <span class="k">if</span> <span class="nb">any</span> <span class="ow">is</span> <span class="n">moving</span> <span class="n">away</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">state</span>
<span class="n">IF</span> <span class="n">nMotorCase1</span> <span class="o">=</span> <span class="n">AWAY</span> <span class="n">OR</span> <span class="n">nMotorCase2</span> <span class="o">=</span> <span class="n">AWAY</span> <span class="n">OR</span> <span class="n">nMotorCase3</span> <span class="o">=</span> <span class="n">AWAY</span> <span class="n">THEN</span>
    <span class="n">bMovingState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">AssertEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">bKnownState</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">bKnownState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Wrong bKnownState for test case &#39;</span><span class="p">,</span> <span class="n">sTestCase</span><span class="p">),</span>
<span class="p">);</span>
<span class="n">AssertEquals_BOOL</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">bMovingState</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">bMovingState</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Wrong bMovingState for test case &#39;</span><span class="p">,</span> <span class="n">sTestCase</span><span class="p">),</span>
<span class="p">);</span>
<span class="n">AssertEquals_DINT</span><span class="p">(</span>
    <span class="n">Expected</span><span class="o">:=</span><span class="n">nPositionIndex</span><span class="p">,</span>
    <span class="n">Actual</span><span class="o">:=</span><span class="n">fbRead</span><span class="o">.</span><span class="n">nPositionIndex</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Wrong nPositionIndex for test case &#39;</span><span class="p">,</span> <span class="n">sTestCase</span><span class="p">),</span>
<span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">DoMove</span><span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nMotorIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nMotorCase</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fStartPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fGoalPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CASE</span> <span class="n">nMotorCase</span> <span class="n">OF</span>
    <span class="o">//</span> <span class="n">Somewhere</span> <span class="n">smaller</span> <span class="n">than</span> <span class="n">OUT</span><span class="p">,</span> <span class="n">static</span>
    <span class="n">NO_STATE</span><span class="p">:</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
        <span class="n">fGoalPosition</span> <span class="o">:=</span> <span class="n">fStartPosition</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Exactly</span> <span class="n">at</span> <span class="n">OUT</span><span class="p">,</span> <span class="n">static</span>
    <span class="n">OUT_STATE</span><span class="p">:</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">fGoalPosition</span> <span class="o">:=</span> <span class="n">fStartPosition</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Exactly</span> <span class="n">at</span> <span class="n">IN</span><span class="p">,</span> <span class="n">static</span>
    <span class="n">IN_STATE</span><span class="p">:</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">fGoalPosition</span> <span class="o">:=</span> <span class="n">fStartPosition</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">at</span> <span class="n">IN</span><span class="p">,</span> <span class="n">do</span> <span class="n">a</span> <span class="n">small</span> <span class="n">tweak</span>
    <span class="n">IN_TWEAK</span><span class="p">:</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">fGoalPosition</span> <span class="o">:=</span> <span class="n">fStartPosition</span> <span class="o">+</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Start</span> <span class="n">at</span> <span class="n">IN</span><span class="p">,</span> <span class="n">move</span> <span class="n">positive</span> <span class="n">a</span> <span class="n">lot</span>
    <span class="n">AWAY</span><span class="p">:</span>
        <span class="n">fStartPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">fGoalPosition</span> <span class="o">:=</span> <span class="n">fStartPosition</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">],</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fStartPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fGoalPosition</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">CASE</span> <span class="n">nMotorCase</span> <span class="n">OF</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">static</span> <span class="n">states</span><span class="p">:</span> <span class="n">report</span> <span class="n">ready</span> <span class="n">when</span> <span class="nb">set</span> <span class="ow">is</span> <span class="n">done</span>
    <span class="n">NO_STATE</span><span class="p">:</span>
        <span class="n">DoMove</span> <span class="o">:=</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bSetDone</span><span class="p">;</span>
    <span class="n">OUT_STATE</span><span class="p">:</span>
        <span class="n">DoMove</span> <span class="o">:=</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bSetDone</span><span class="p">;</span>
    <span class="n">IN_STATE</span><span class="p">:</span>
        <span class="n">DoMove</span> <span class="o">:=</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bSetDone</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">moving</span> <span class="n">states</span><span class="p">:</span> <span class="n">report</span> <span class="n">ready</span> <span class="n">when</span> <span class="n">move</span> <span class="n">starts</span>
    <span class="n">IN_TWEAK</span><span class="p">:</span>
        <span class="n">DoMove</span> <span class="o">:=</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bMotionStarted</span><span class="p">;</span>
    <span class="n">AWAY</span><span class="p">:</span>
        <span class="n">DoMove</span> <span class="o">:=</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bMotionStarted</span><span class="p">;</span>
<span class="n">END_CASE</span>
<span class="o">//</span> <span class="n">Universal</span> <span class="mi">5</span><span class="n">s</span> <span class="n">timeout</span>
<span class="n">DoMove</span> <span class="n">S</span><span class="o">=</span> <span class="n">afbTestMove</span><span class="p">[</span><span class="n">nMotorIndex</span><span class="p">]</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s;</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">DoRead</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">fbRead</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">PerMotor</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">afbMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">nIndex</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">afbInternal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">nIndex</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
<span class="n">afbInternal</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIndex</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIndex</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
<span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">SquareSetup</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="mi">2</span> <span class="n">motors</span><span class="p">,</span> <span class="mi">4</span> <span class="n">positions</span> <span class="n">per</span> <span class="n">motor</span><span class="p">,</span> <span class="n">square</span> <span class="n">geometry</span>
<span class="o">//</span> <span class="n">Motor</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">X</span><span class="p">,</span> <span class="n">motor</span> <span class="mi">2</span> <span class="ow">is</span> <span class="n">Y</span>
<span class="o">//</span> <span class="n">Corners</span> <span class="n">at</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="o">//</span> <span class="n">So</span> <span class="n">motor</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">either</span> <span class="n">LEFT</span><span class="o">=</span><span class="mi">10</span> <span class="ow">or</span> <span class="n">RIGHT</span><span class="o">=</span><span class="mi">20</span>
<span class="o">//</span> <span class="n">motor</span> <span class="mi">2</span> <span class="ow">is</span> <span class="n">either</span> <span class="n">BOT</span><span class="o">=</span><span class="mi">10</span> <span class="ow">or</span> <span class="n">TOP</span><span class="o">=</span><span class="mi">20</span>

<span class="n">afbSqMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astSqMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">afbSqMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astSqMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Top Left&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Top Right&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Bot Left&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Bot Right&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Top Left&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Top Right&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Bot Left&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
<span class="p">);</span>

<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Bot Right&#39;</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]);</span>
<span class="n">afbSqInternal</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span>
<span class="p">);</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestCombos</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nAssertID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nMotor1Case</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nMotor2Case</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nMotor3Case</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bReady1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReady2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReady3</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">tonTimeout</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">should</span> <span class="n">be</span> <span class="n">one</span> <span class="n">big</span> <span class="n">test</span> <span class="n">case</span> <span class="k">with</span> <span class="mi">125</span> <span class="n">asserts</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAllCombos&#39;</span><span class="p">);</span>

<span class="n">nMotor1Case</span> <span class="o">:=</span> <span class="n">nAssertID</span> <span class="n">MOD</span> <span class="n">TEST_COUNT</span><span class="p">;</span>
<span class="n">nMotor2Case</span> <span class="o">:=</span> <span class="n">LREAL_TO_UINT</span><span class="p">(</span><span class="n">FLOOR</span><span class="p">(</span><span class="n">nAssertID</span> <span class="o">/</span> <span class="n">TEST_COUNT</span><span class="p">))</span> <span class="n">MOD</span> <span class="n">TEST_COUNT</span><span class="p">;</span>
<span class="n">nMotor3Case</span> <span class="o">:=</span> <span class="n">LREAL_TO_UINT</span><span class="p">(</span><span class="n">FLOOR</span><span class="p">(</span><span class="n">nAssertID</span> <span class="o">/</span> <span class="n">TEST_COUNT</span> <span class="o">/</span> <span class="n">TEST_COUNT</span><span class="p">))</span> <span class="n">MOD</span> <span class="n">TEST_COUNT</span><span class="p">;</span>

<span class="n">bReady1</span> <span class="o">:=</span> <span class="n">DoMove</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nMotor1Case</span><span class="p">);</span>
<span class="n">bReady2</span> <span class="o">:=</span> <span class="n">DoMove</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">nMotor2Case</span><span class="p">);</span>
<span class="n">bReady3</span> <span class="o">:=</span> <span class="n">DoMove</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">nMotor3Case</span><span class="p">);</span>

<span class="o">//</span> <span class="n">There</span> <span class="ow">is</span> <span class="n">a</span> <span class="mi">5</span><span class="n">s</span> <span class="n">timeout</span> <span class="n">at</span> <span class="n">a</span> <span class="n">lower</span> <span class="n">level</span><span class="p">,</span> <span class="n">but</span> <span class="n">that</span> <span class="n">timeout</span> <span class="n">could</span> <span class="n">fail</span>
<span class="n">tonTimeout</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#7s,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bReady1</span> <span class="n">AND</span> <span class="n">bReady2</span> <span class="n">AND</span> <span class="n">bReady3</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">DoRead</span><span class="p">();</span>
    <span class="n">DoAssert</span><span class="p">(</span><span class="n">nMotor1Case</span><span class="p">,</span> <span class="n">nMotor2Case</span><span class="p">,</span> <span class="n">nMotor3Case</span><span class="p">,</span> <span class="n">bReady1</span><span class="p">,</span> <span class="n">bReady2</span><span class="p">,</span> <span class="n">bReady3</span><span class="p">);</span>
    <span class="n">bOneAssertDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">final</span> <span class="k">assert</span> <span class="n">case</span> <span class="n">marks</span> <span class="n">test</span> <span class="k">as</span> <span class="n">finished</span>
    <span class="n">IF</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="p">(</span><span class="n">nMotor1Case</span> <span class="o">=</span> <span class="n">LAST_TEST</span> <span class="n">AND</span> <span class="n">nMotor2Case</span> <span class="o">=</span> <span class="n">LAST_TEST</span> <span class="n">AND</span> <span class="n">nMotor3Case</span> <span class="o">=</span> <span class="n">LAST_TEST</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="o">//</span> <span class="mi">11</span> <span class="n">extra</span> <span class="n">tests</span>
        <span class="o">//</span> <span class="mi">1</span> <span class="kn">from</span> <span class="nn">TestForgot</span>
        <span class="o">//</span> <span class="mi">10</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">TestSquare</span>
        <span class="n">AssertEquals_UINT</span><span class="p">(</span>
            <span class="n">Expected</span><span class="o">:=</span><span class="mi">6</span> <span class="o">*</span> <span class="n">TEST_COUNT</span> <span class="o">*</span> <span class="n">TEST_COUNT</span> <span class="o">*</span> <span class="n">TEST_COUNT</span> <span class="o">+</span> <span class="mi">11</span><span class="p">,</span>
            <span class="n">Actual</span><span class="o">:=</span><span class="n">AssertResults</span><span class="o">.</span><span class="n">TotalAsserts</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Some of the asserts were not run&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">AssertFalse</span><span class="p">(</span>
            <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
            <span class="s1">&#39;Level 2 timeout in test&#39;</span><span class="p">,</span>
        <span class="p">);</span>
        <span class="n">TEST_FINISHED</span><span class="p">();</span>
    <span class="n">END_IF</span>
    <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">TestForgot</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;ForgotCount&#39;</span><span class="p">);</span>

<span class="n">fbMisRead</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astGoodStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astGoodStateShape</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">Condition</span><span class="o">:=</span><span class="n">fbMisRead</span><span class="o">.</span><span class="n">bMotorCountError</span><span class="p">,</span>
    <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Failed to notice missing count&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestSquare</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nAssertID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fMotor1Pos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nGoal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">tonTimeout</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">We</span><span class="s1">&#39;ll do 5 tests, one at each square point and one more in the middle</span>
<span class="n">Test</span><span class="p">(</span><span class="s1">&#39;TestSquare&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nAssertID</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">nAssertID</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">fMotor1Pos</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">nGoal</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">nAssertID</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">THEN</span>
    <span class="n">fMotor1Pos</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">nGoal</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">nAssertID</span> <span class="o">=</span> <span class="mi">2</span> <span class="n">THEN</span>
    <span class="n">fMotor1Pos</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="n">nGoal</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">nAssertID</span> <span class="o">=</span> <span class="mi">3</span> <span class="n">THEN</span>
    <span class="n">fMotor1Pos</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="n">nGoal</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">nAssertID</span> <span class="o">=</span> <span class="mi">4</span> <span class="n">THEN</span>
    <span class="n">fMotor1Pos</span> <span class="o">:=</span> <span class="mi">15</span><span class="p">;</span>
    <span class="n">fMotor2Pos</span> <span class="o">:=</span> <span class="mi">15</span><span class="p">;</span>
    <span class="n">nGoal</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astSqMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fMotor1Pos</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fMotor1Pos</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astSqMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">fMotor2Pos</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">fMotor2Pos</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">tonTimeout</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">IF</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">AND</span> <span class="n">afbSqTestMove</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">fbSqRead</span><span class="p">(</span>
        <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astSqMotionStage</span><span class="p">,</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astSquareStates</span><span class="p">,</span>
        <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Timeout in square test &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nAssertID</span><span class="p">)),</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_UINT</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">nGoal</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbSqRead</span><span class="o">.</span><span class="n">nPositionIndex</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Wrong read in square test &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nAssertID</span><span class="p">)),</span>
    <span class="p">);</span>

    <span class="n">bSqAssertDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">nAssertID</span> <span class="o">=</span> <span class="mi">4</span> <span class="n">THEN</span>
        <span class="n">TEST_FINISHED</span><span class="p">();</span>
    <span class="n">END_IF</span>
    <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatereadnd">FB_PositionStateReadND</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove">FB_TestHelperSetAndMove</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-rawcountconverter">
<h2>FB_RawCountConverter<a class="headerlink" href="#fb-rawcountconverter" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_RawCountConverter</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Utility</span> <span class="n">function</span> <span class="n">block</span> <span class="k">for</span> <span class="n">converting</span> <span class="n">raw</span> <span class="n">counts</span> <span class="n">to</span> <span class="n">EGU</span> <span class="ow">and</span> <span class="n">back</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Parameters</span> <span class="n">to</span> <span class="n">check</span> <span class="n">against</span>
    <span class="n">stParameters</span><span class="p">:</span> <span class="n">ST_AxisParameterSet</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Optional</span> <span class="n">count</span> <span class="n">to</span> <span class="n">convert</span> <span class="n">to</span> <span class="n">a</span> <span class="n">real</span> <span class="n">position</span>
    <span class="n">nCountCheck</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Optional</span> <span class="n">position</span> <span class="n">to</span> <span class="n">convert</span> <span class="n">to</span> <span class="n">encoder</span> <span class="n">counts</span>
    <span class="n">fPosCheck</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">converting</span> <span class="n">position</span><span class="p">,</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">counts</span>
    <span class="n">nCountGet</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">converting</span> <span class="n">counts</span><span class="p">,</span> <span class="n">the</span> <span class="n">position</span>
    <span class="n">fPosGet</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="kc">True</span> <span class="n">during</span> <span class="n">a</span> <span class="n">parameter</span> <span class="n">get</span><span class="o">/</span><span class="n">calc</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="kc">True</span> <span class="n">after</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">get</span><span class="o">/</span><span class="n">calc</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">the</span> <span class="n">calculation</span> <span class="n">errored</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">stParameters</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">nCountGet</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">((</span><span class="n">fPosCheck</span> <span class="o">-</span> <span class="n">stParameters</span><span class="o">.</span><span class="n">fEncOffset</span><span class="p">)</span> <span class="o">/</span> <span class="n">stParameters</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span><span class="p">);</span>
    <span class="n">fPosGet</span> <span class="o">:=</span> <span class="n">nCountCheck</span> <span class="o">*</span> <span class="n">stParameters</span><span class="o">.</span><span class="n">fEncScaleFactorInternal</span> <span class="o">+</span> <span class="n">stParameters</span><span class="o">.</span><span class="n">fEncOffset</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-readfloatparameter">
<h2>FB_ReadFloatParameter<a class="headerlink" href="#fb-readfloatparameter" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ReadFloatParameter</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="mi">16</span><span class="c1">#4000=Axisdata, 16#5000=Encoderdata, 16#6000=Controldata, 16#7000=Drivedata</span>
    <span class="n">nDeviceGroup</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndexOffset</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">nData</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fbADSREAD</span><span class="p">:</span> <span class="n">ADSREAD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">Sequence</span> <span class="n">to</span> <span class="n">read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="mi">0</span><span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">Start</span> <span class="n">sequence</span><span class="o">.</span> <span class="n">Wait</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">TRUE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bBusy</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fbADSREAD</span><span class="p">(</span>
            <span class="n">PORT</span><span class="o">:=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">IDXGRP</span><span class="o">:=</span><span class="n">nDeviceGroup</span><span class="o">+</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">,</span>
            <span class="n">IDXOFFS</span><span class="o">:=</span><span class="n">nIndexOffset</span><span class="p">,</span>
            <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">DESTADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">READ</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Wait</span> <span class="n">until</span> <span class="n">it</span><span class="s1">&#39;s done or if an error occurs*)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSREAD</span><span class="o">.</span><span class="n">ERR</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSREAD</span><span class="o">.</span><span class="n">BUSY</span> <span class="n">THEN</span>
                    <span class="n">fbADSREAD</span><span class="p">(</span><span class="n">READ</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                    <span class="n">nState</span><span class="o">:=</span><span class="mi">20</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">ELSE</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbADSREAD</span><span class="o">.</span><span class="n">ERRID</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">999</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Sequense</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span> <span class="n">Waits</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">999</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbADSREAD</span><span class="p">(</span><span class="n">READ</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-readparameterinnc-v1-00">
<h2>FB_ReadParameterInNc_v1_00<a class="headerlink" href="#fb-readparameterinnc-v1-00" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="c1">#########################################################</span>
<span class="o">///</span><span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Library</span><span class="p">:</span>
<span class="o">///</span> <span class="n">Tc2_MC2</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span> <span class="n">Tc2_System</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Global</span> <span class="n">Variables</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Data</span> <span class="n">types</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">External</span> <span class="n">functions</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">History</span><span class="p">:</span>
<span class="o">///</span> <span class="mi">2014</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">05</span>      <span class="n">v1</span><span class="mf">.00</span>   <span class="n">NB</span>      <span class="n">Release</span> <span class="n">code</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Known</span> <span class="n">bugs</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span>
<span class="o">///</span>
<span class="o">///</span><span class="c1">###########################################################</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ReadParameterInNc_v1_00</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="mi">16</span><span class="c1">#4000=Axisdata, 16#5000=Encoderdata, 16#6000=Controldata, 16#7000=Drivedata</span>
    <span class="n">nDeviceGroup</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndexOffset</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">nData</span><span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fbADSREAD</span><span class="p">:</span> <span class="n">ADSREAD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">Sequence</span> <span class="n">to</span> <span class="n">read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="mi">0</span><span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">Start</span> <span class="n">sequence</span><span class="o">.</span> <span class="n">Wait</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">TRUE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bBusy</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fbADSREAD</span><span class="p">(</span>
            <span class="n">PORT</span><span class="o">:=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">IDXGRP</span><span class="o">:=</span><span class="n">nDeviceGroup</span><span class="o">+</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">,</span>
            <span class="n">IDXOFFS</span><span class="o">:=</span><span class="n">nIndexOffset</span><span class="p">,</span>
            <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">DESTADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">READ</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Wait</span> <span class="n">until</span> <span class="n">it</span><span class="s1">&#39;s done or if an error occurs*)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSREAD</span><span class="o">.</span><span class="n">ERR</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSREAD</span><span class="o">.</span><span class="n">BUSY</span> <span class="n">THEN</span>
                    <span class="n">fbADSREAD</span><span class="p">(</span><span class="n">READ</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                    <span class="n">nState</span><span class="o">:=</span><span class="mi">20</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">ELSE</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbADSREAD</span><span class="o">.</span><span class="n">ERRID</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">999</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Sequense</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span> <span class="n">Waits</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">999</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbADSREAD</span><span class="p">(</span><span class="n">READ</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-setenables">
<h2>FB_SetEnables<a class="headerlink" href="#fb-setenables" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SetEnables</span>
<span class="o">//</span> <span class="n">Update</span> <span class="n">the</span> <span class="nb">all</span> <span class="n">enable</span> <span class="n">booleans</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">booleans</span> <span class="n">that</span> <span class="n">make</span> <span class="n">them</span> <span class="n">up</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllForwardEnable</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="n">AND</span> <span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bGantryForwardEnable</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bGantryAxis</span><span class="p">)</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stEPSForwardEnable</span><span class="o">.</span><span class="n">bEPS_OK</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllBackwardEnable</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="n">AND</span> <span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bGantryBackwardEnable</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bGantryAxis</span><span class="p">)</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stEPSBackwardEnable</span><span class="o">.</span><span class="n">bEPS_OK</span><span class="p">;</span>

<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bEnable</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stEPSPowerEnable</span><span class="o">.</span><span class="n">bEPS_OK</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bUserEnable</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-standard-pmpsdb">
<h2>FB_Standard_PMPSDB<a class="headerlink" href="#fb-standard-pmpsdb" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Standard_PMPSDB</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">FB</span> <span class="n">should</span> <span class="n">be</span> <span class="n">run</span> <span class="n">on</span> <span class="n">every</span> <span class="n">motion</span> <span class="n">PLC</span> <span class="n">to</span> <span class="n">encapsulate</span> <span class="n">the</span> <span class="n">pmps</span> <span class="n">file</span> <span class="n">reader</span><span class="o">.</span>
    <span class="n">It</span> <span class="ow">is</span> <span class="n">pre</span><span class="o">-</span><span class="n">instantiated</span> <span class="n">at</span> <span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">fbStandardPMPSDB</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">io_fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">FB</span> <span class="n">will</span> <span class="n">run</span><span class="o">.</span> <span class="n">Reads</span> <span class="n">when</span> <span class="n">enable</span> <span class="n">goes</span> <span class="n">TRUE</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">E</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">lfe</span><span class="o">-</span><span class="n">motion</span>
    <span class="n">sPlcName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">REFRESH</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">cause</span> <span class="n">an</span> <span class="n">extra</span> <span class="n">read</span><span class="o">.</span>
    <span class="n">bRefresh</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Directory</span> <span class="n">where</span> <span class="n">the</span> <span class="n">DB</span> <span class="ow">is</span> <span class="n">stored</span><span class="o">.</span>
    <span class="n">sDirectory</span><span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;/Hard Disk/ftp/PMPS/&#39;</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">LAST_REFRESH</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nLastRefreshTime</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">bReadPmpsDb</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtEnable</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtRefresh</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftBusy</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Time</span> <span class="n">tracking</span> <span class="n">liften</span> <span class="kn">from</span> <span class="nn">Arbiter</span> <span class="n">PLCs</span>
    <span class="n">fbTime</span> <span class="p">:</span> <span class="n">FB_LocalSystemTime</span> <span class="o">:=</span> <span class="p">(</span> <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">dwCycle</span> <span class="o">:=</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="n">fbTime_to_UTC</span><span class="p">:</span> <span class="n">FB_TzSpecificLocalTimeToSystemTime</span><span class="p">;</span>
    <span class="n">fbGetTimeZone</span><span class="p">:</span> <span class="n">FB_GetTimeZoneInformation</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">rtEnable</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">);</span>
<span class="n">rtRefresh</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bRefresh</span><span class="p">);</span>
<span class="n">bRefresh</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">rtEnable</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">rtRefresh</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">file</span> <span class="n">reader</span> <span class="n">gets</span> <span class="n">a</span> <span class="n">rising</span> <span class="n">edge</span>
    <span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">fbPmpsFileReader</span><span class="p">(</span>
        <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">fbPmpsFileReader</span><span class="p">(</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">sSrcPathName</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">sDirectory</span><span class="p">,</span> <span class="n">sPlcName</span><span class="p">),</span> <span class="s1">&#39;.json&#39;</span><span class="p">),</span>
    <span class="n">sPLCName</span><span class="o">:=</span><span class="n">sPLCName</span><span class="p">,</span>
    <span class="n">PMPS_jsonDoc</span><span class="o">=&gt;</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">BP_jsonDoc</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">ftBusy</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">fbPmpsFileReader</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">ftBusy</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">bReadPmpsDb</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bReadPmpsDb</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Lifted</span> <span class="kn">from</span> <span class="nn">Arbiter</span> <span class="n">PLCs</span><span class="p">:</span> <span class="n">keep</span> <span class="n">track</span> <span class="n">of</span> <span class="n">the</span> <span class="n">time</span>
<span class="n">fbTime</span><span class="p">(</span><span class="n">sNetID</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="n">fbGetTimeZone</span><span class="p">(</span><span class="n">sNetID</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">tTimeout</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>
<span class="n">fbTime_to_UTC</span><span class="p">(</span><span class="ow">in</span><span class="o">:=</span> <span class="n">fbTime</span><span class="o">.</span><span class="n">systemTime</span> <span class="p">,</span> <span class="n">tzInfo</span><span class="o">:=</span><span class="n">fbGetTimeZone</span><span class="o">.</span><span class="n">tzInfo</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Update</span> <span class="n">the</span> <span class="n">refresh</span> <span class="n">time</span> <span class="n">on</span> <span class="n">successful</span> <span class="n">read</span>
<span class="n">IF</span> <span class="n">ftBusy</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">fbPmpsFileReader</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
   <span class="n">nLastRefreshTime</span> <span class="o">:=</span> <span class="n">TO_DINT</span><span class="p">(</span><span class="n">TO_DT</span><span class="p">(</span><span class="n">SystemTime_TO_DT</span><span class="p">(</span><span class="n">fbTime_to_UTC</span><span class="o">.</span><span class="n">out</span><span class="p">)));</span>
<span class="n">END_IF</span>

<span class="n">bExecute</span> <span class="n">R</span><span class="o">=</span> <span class="n">ftBusy</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#motion-gvl">MOTION_GVL</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statepmpsenables">
<h2>FB_StatePMPSEnables<a class="headerlink" href="#fb-statepmpsenables" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StatePMPSEnables</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">virtual</span> <span class="n">limit</span> <span class="n">enables</span> <span class="n">using</span> <span class="n">MC_POWER</span> <span class="k">for</span> <span class="n">single</span> <span class="n">dimensional</span> <span class="n">state</span> <span class="n">movers</span><span class="o">.</span>
    <span class="n">It</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">building</span> <span class="n">block</span> <span class="ow">not</span> <span class="n">meant</span> <span class="k">for</span> <span class="n">use</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">lcls</span><span class="o">-</span><span class="n">twintcat</span><span class="o">-</span><span class="n">motion</span><span class="o">.</span>

    <span class="n">Each</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">a</span> <span class="n">virtual</span> <span class="s2">&quot;allowed&quot;</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">motion</span> <span class="n">based</span> <span class="n">on</span> <span class="n">its</span> <span class="n">goal</span> <span class="n">position</span><span class="o">.</span>
    <span class="n">When</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">the</span> <span class="n">goal</span><span class="p">,</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">can</span> <span class="n">only</span> <span class="n">move</span> <span class="n">toward</span> <span class="n">the</span> <span class="n">goal</span><span class="o">.</span>
    <span class="n">When</span> <span class="n">at</span> <span class="n">the</span> <span class="n">goal</span><span class="p">,</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">can</span> <span class="n">move</span> <span class="n">within</span> <span class="n">the</span> <span class="n">position</span><span class="s1">&#39;s delta.</span>

    <span class="n">With</span> <span class="n">no</span> <span class="n">goals</span> <span class="ow">or</span> <span class="n">other</span> <span class="n">strange</span> <span class="n">states</span><span class="p">,</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">permitted</span> <span class="n">to</span> <span class="n">move</span> <span class="ow">in</span> <span class="n">either</span> <span class="n">direction</span>
    <span class="n">to</span> <span class="n">help</span> <span class="n">restore</span> <span class="n">it</span> <span class="n">to</span> <span class="n">a</span> <span class="n">known</span> <span class="n">position</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motor</span> <span class="k">with</span> <span class="n">a</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">All</span> <span class="n">possible</span> <span class="n">position</span> <span class="n">states</span> <span class="k">for</span> <span class="n">this</span> <span class="n">motor</span><span class="o">.</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Hardware</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">problem</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">do</span> <span class="n">the</span> <span class="n">limits</span> <span class="k">as</span> <span class="n">normal</span><span class="o">.</span> <span class="n">If</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">allow</span> <span class="nb">all</span> <span class="n">moves</span> <span class="n">regardless</span> <span class="n">of</span> <span class="n">the</span> <span class="n">limits</span> <span class="n">defined</span> <span class="n">here</span><span class="o">.</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">state</span> <span class="n">that</span> <span class="n">the</span> <span class="n">motor</span> <span class="ow">is</span> <span class="n">moving</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">nGoalStateIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">overal</span> <span class="n">PMPS</span> <span class="n">FB</span> <span class="n">state</span>
    <span class="n">eStatePMPSStatus</span><span class="p">:</span> <span class="n">E_StatePMPSStatus</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Connect</span> <span class="n">to</span> <span class="n">the</span> <span class="n">BPTM</span>
    <span class="n">bTransitionAuthorized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">enable</span> <span class="n">state</span> <span class="n">we</span> <span class="n">send</span> <span class="n">to</span> <span class="n">MC_Power</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="k">pass</span><span class="o">-</span><span class="n">through</span> <span class="kn">from</span> <span class="nn">stMotionStage.</span>
    <span class="n">bEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">forward</span> <span class="n">enable</span> <span class="n">state</span> <span class="n">we</span> <span class="n">send</span> <span class="n">to</span> <span class="n">MC_Power</span><span class="o">.</span> <span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="k">pass</span><span class="o">-</span><span class="n">through</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">override</span> <span class="n">to</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">bForwardEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">backwards</span> <span class="n">enable</span> <span class="n">state</span> <span class="n">we</span> <span class="n">send</span> <span class="n">to</span> <span class="n">MC_Power</span><span class="o">.</span> <span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="k">pass</span><span class="o">-</span><span class="n">through</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">override</span> <span class="n">to</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">bBackwardEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">goal</span> <span class="n">position</span> <span class="ow">and</span> <span class="n">FALSE</span> <span class="n">otherwise</span><span class="o">.</span> <span class="n">This</span> <span class="n">makes</span> <span class="n">a</span> <span class="n">fast</span> <span class="n">fault</span> <span class="k">if</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">bValidGoal</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">mc_power</span><span class="p">:</span> <span class="n">MC_POWER</span><span class="p">;</span>
    <span class="n">nPrevStateIndex</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">fLowerPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fUpperPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">ffNoGoal</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">GetBounds</span><span class="p">();</span>
<span class="n">SetEnables</span><span class="p">();</span>
<span class="n">ApplyEnables</span><span class="p">();</span>
<span class="n">RunFastFaults</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ApplyEnables</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">action</span> <span class="n">takes</span> <span class="n">runs</span> <span class="n">MC_POWER</span> <span class="n">appropriately</span>
    <span class="n">given</span> <span class="n">the</span> <span class="n">motor</span><span class="s1">&#39;s own enables and the results of this FB&#39;</span><span class="n">s</span> <span class="n">checks</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">bEnabled</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span><span class="p">;</span>
<span class="n">bForwardEnabled</span> <span class="o">:=</span> <span class="n">bForwardEnabled</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">;</span>
<span class="n">bBackwardEnabled</span> <span class="o">:=</span> <span class="n">bBackwardEnabled</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllBackwardEnable</span><span class="p">;</span>

<span class="n">CASE</span> <span class="n">eStatePMPSStatus</span> <span class="n">OF</span>
    <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">TRANSITION</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">bTransitionAuthorized</span><span class="p">;</span>
        <span class="n">bForwardEnabled</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bTransitionAuthorized</span><span class="p">;</span>
        <span class="n">bBackwardEnabled</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">bTransitionAuthorized</span><span class="p">;</span>
    <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">AT_STATE</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">:</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bSafetyReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">mc_power</span><span class="p">(</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Enable</span><span class="o">:=</span><span class="n">bEnabled</span><span class="p">,</span>
    <span class="n">Enable_Positive</span><span class="o">:=</span><span class="n">bForwardEnabled</span><span class="p">,</span>
    <span class="n">Enable_Negative</span><span class="o">:=</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">GetBounds</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">action</span> <span class="n">sets</span> <span class="n">fLowerPos</span> <span class="ow">and</span> <span class="n">fUpperPos</span> <span class="n">based</span> <span class="n">on</span> <span class="n">our</span> <span class="n">goal</span> <span class="n">position</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">nGoalStateIndex</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">nGoalStateIndex</span> <span class="o">&lt;=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bValid</span> <span class="n">AND</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span> <span class="n">THEN</span>
        <span class="n">bValidGoal</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">fLowerPos</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="n">ABS</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">);</span>
        <span class="n">fUpperPos</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">ABS</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalStateIndex</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">bValidGoal</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">bValidGoal</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">RunFastFaults</span><span class="p">:</span>
<span class="n">ffNoGoal</span><span class="p">(</span>
    <span class="n">i_xOK</span><span class="o">:=</span><span class="n">bValidGoal</span><span class="p">,</span>
    <span class="n">i_xAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_DevName</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">sName</span><span class="p">,</span>
    <span class="n">i_Desc</span><span class="o">:=</span><span class="s1">&#39;Invalid goal position in state move&#39;</span><span class="p">,</span>
    <span class="n">i_TypeCode</span><span class="o">:=</span><span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">INVALID_GOAL</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">SetEnables</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="n">action</span> <span class="n">sets</span> <span class="n">bForwardEnable</span> <span class="ow">and</span> <span class="n">bBackwardEnable</span> <span class="n">based</span> <span class="n">on</span>
    <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">calculated</span> <span class="n">bounds</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">bValidGoal</span> <span class="n">AND</span> <span class="n">bEnable</span> <span class="n">THEN</span>
    <span class="n">bForwardEnabled</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&lt;</span> <span class="n">fUpperPos</span><span class="p">;</span>
    <span class="n">bBackwardEnabled</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&gt;</span> <span class="n">fLowerPos</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="o">//</span> <span class="n">Either</span> <span class="n">invalid</span> <span class="n">state</span> <span class="k">with</span> <span class="n">a</span> <span class="n">fault</span> <span class="ow">or</span> <span class="n">FB</span> <span class="ow">not</span> <span class="n">enabled</span>
    <span class="n">bForwardEnabled</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBackwardEnabled</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#e-statepmpsstatus">E_StatePMPSStatus</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statepmpsenables-test">
<h2>FB_StatePMPSEnables_Test<a class="headerlink" href="#fb-statepmpsenables-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StatePMPSEnables_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Tests</span> <span class="k">for</span> <span class="n">FB_StatePMPSEnables</span>

    <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">ensures</span> <span class="n">that</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">When</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">our</span> <span class="n">goal</span> <span class="n">state</span><span class="p">,</span> <span class="n">we</span> <span class="n">cannot</span> <span class="n">move</span> <span class="n">away</span> <span class="kn">from</span> <span class="nn">our</span> <span class="n">goal</span> <span class="n">state</span>
    <span class="o">-</span> <span class="n">When</span> <span class="n">at</span> <span class="n">our</span> <span class="n">goal</span> <span class="n">state</span><span class="p">,</span> <span class="n">we</span> <span class="n">must</span> <span class="n">stay</span> <span class="n">within</span> <span class="n">the</span> <span class="n">state</span> <span class="n">bounds</span>
    <span class="o">-</span> <span class="n">When</span> <span class="n">at</span> <span class="n">our</span> <span class="n">goal</span> <span class="n">state</span><span class="p">,</span> <span class="n">we</span> <span class="n">still</span> <span class="n">obey</span> <span class="n">other</span> <span class="n">constraints</span> <span class="n">like</span> <span class="n">limit</span> <span class="n">switches</span>

    <span class="n">We</span> <span class="n">also</span> <span class="n">include</span> <span class="n">a</span> <span class="nb">super</span> <span class="n">basic</span> <span class="n">real</span> <span class="n">move</span> <span class="n">test</span> <span class="k">with</span> <span class="n">our</span> <span class="n">simulator</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">enables</span> <span class="n">are</span> <span class="nb">set</span> <span class="n">properly</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbInternal1</span><span class="p">:</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">fbInternal2</span><span class="p">:</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">nInvalidState</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">nGoalState</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">nNotUpdatedState</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nTestCounter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bOneTestDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fTestStartPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bStatesReady</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]);</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nInvalidState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nInvalidState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nNotUpdatedState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="n">nNotUpdatedState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nNotUpdatedState</span><span class="p">]);</span>
<span class="n">fbInternal1</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">],</span>
<span class="p">);</span>
<span class="n">fbInternal2</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nInvalidState</span><span class="p">],</span>
<span class="p">);</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="n">bStatesReady</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span> <span class="n">AND</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nInvalidState</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bStatesReady</span> <span class="n">AND</span> <span class="n">nTestCounter</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t run any tests until the states are ready</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">TestInvalid</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">TestNotUpdated</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">TestBelow</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">TestAbove</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="n">TestAt</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="n">TestDisabled</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
<span class="n">TestLimits</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
<span class="n">TestMoveTo</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="n">TestMoveAt</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">bOneTestDone</span> <span class="n">THEN</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nTestCounter</span> <span class="o">:=</span> <span class="n">nTestCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tonTimer</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">END_IF</span>
<span class="o">//</span> <span class="n">Use</span> <span class="n">this</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">time</span> <span class="n">out</span> <span class="nb">any</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">stall</span>
<span class="n">tonTimer</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bStatesReady</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#5s,</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestAbove</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAbove&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">above</span> <span class="n">the</span> <span class="n">goal</span><span class="s1">&#39;s range</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve set the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Position was not set correctly&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward enabled when above goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward disabled when above goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestAt</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAt&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">at</span> <span class="n">the</span> <span class="n">goal</span> <span class="n">state</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve set the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Position was not set correctly&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward disabled when at goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward disabled when at goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestBelow</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestBelow&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">below</span> <span class="n">the</span> <span class="n">goal</span><span class="s1">&#39;s range</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve set the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Position was not set correctly&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward enabled when below goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward disabled when below goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestDisabled</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestDisabled&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">below</span> <span class="n">the</span> <span class="n">goal</span><span class="s1">&#39;s range</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve set the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Position was not set correctly&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward disabled when fb is supposed to be disabled&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward disabled when fb is supposed to be disabled&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestInvalid</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestInvalid&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Faulted prior to test&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">The</span> <span class="n">invalid</span> <span class="n">state</span> <span class="n">should</span> <span class="n">give</span> <span class="n">us</span> <span class="n">a</span> <span class="n">fault</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nInvalidState</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Invalid state did not fault&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestLimits</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestLimits&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Kill</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">switches</span> <span class="k">for</span> <span class="n">this</span> <span class="n">test</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">at</span> <span class="n">the</span> <span class="n">goal</span> <span class="n">state</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve set the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bSetDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Position was not set correctly&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward enabled with limit hit&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward enabled with limit hit&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestMoveAt</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestMoveAt&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span> <span class="n">which</span> <span class="n">should</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">real</span> <span class="n">move</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
    <span class="n">eStatePMPSStatus</span><span class="o">:=</span><span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">AT_STATE</span><span class="p">,</span>
    <span class="n">bTransitionAuthorized</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">below</span> <span class="n">the</span> <span class="n">goal</span><span class="s1">&#39;s range, and move to the goal</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve reached the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bMoveDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not reach the goal position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward disabled when at goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward disabled when at goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestMoveTo</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>

    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestMoveTo&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Run</span> <span class="n">our</span> <span class="n">FB</span> <span class="n">which</span> <span class="n">should</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">real</span> <span class="n">move</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalState</span><span class="p">,</span>
    <span class="n">eStatePMPSStatus</span><span class="o">:=</span><span class="n">E_StatePMPSStatus</span><span class="o">.</span><span class="n">TRANSITION</span><span class="p">,</span>
    <span class="n">bTransitionAuthorized</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">position</span> <span class="n">to</span> <span class="n">be</span> <span class="n">below</span> <span class="n">the</span> <span class="n">goal</span><span class="s1">&#39;s range, and move to the goal</span>
<span class="n">fbMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">bInit</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>

<span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;ve reached the position OR ran out of time to set the position, check the asserts</span>
<span class="n">IF</span> <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">fbMove</span><span class="o">.</span><span class="n">bMoveDone</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">tonTimer</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="s1">&#39;Timeout in test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nGoalState</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.0001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not reach the goal position&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
        <span class="s1">&#39;Fast fault in normal situation&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bBackwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Backward disabled when at goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">fbStateEnables</span><span class="o">.</span><span class="n">bForwardEnabled</span><span class="p">,</span>
        <span class="s1">&#39;Forward disabled when at goal&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestNotUpdated</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nTestID</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbStateEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestNotUpdated&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">nTestCounter</span> <span class="o">&lt;&gt;</span> <span class="n">nTestID</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">SetEnablesPMPS</span><span class="p">(</span><span class="n">stMotionStage</span><span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Faulted prior to test&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">The</span> <span class="n">invalid</span> <span class="n">state</span> <span class="n">should</span> <span class="n">give</span> <span class="n">us</span> <span class="n">a</span> <span class="n">fault</span>
<span class="n">fbStateEnables</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nNotUpdatedState</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Not updated state did not fault&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">bOneTestDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-statepmpsstatus">E_StatePMPSStatus</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenables">FB_StatePMPSEnables</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove">FB_TestHelperSetAndMove</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statepmpsenablesnd">
<h2>FB_StatePMPSEnablesND<a class="headerlink" href="#fb-statepmpsenablesnd" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StatePMPSEnablesND</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">virtual</span> <span class="n">limit</span> <span class="n">enables</span> <span class="n">using</span> <span class="n">MC_POWER</span> <span class="k">for</span> <span class="n">multidimensional</span> <span class="n">state</span> <span class="n">movers</span><span class="o">.</span>
    <span class="n">It</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">building</span> <span class="n">block</span> <span class="ow">not</span> <span class="n">meant</span> <span class="k">for</span> <span class="n">use</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">lcls</span><span class="o">-</span><span class="n">twintcat</span><span class="o">-</span><span class="n">motion</span><span class="o">.</span>

    <span class="n">Each</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">a</span> <span class="n">virtual</span> <span class="s2">&quot;allowed&quot;</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">motion</span> <span class="n">based</span> <span class="n">on</span> <span class="n">its</span> <span class="n">goal</span> <span class="n">position</span><span class="o">.</span>
    <span class="n">Motors</span> <span class="n">can</span> <span class="n">move</span> <span class="n">toward</span> <span class="n">their</span> <span class="n">goal</span> <span class="n">delta</span> <span class="n">ranges</span> <span class="ow">or</span> <span class="n">within</span> <span class="n">them</span><span class="p">,</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">away</span> <span class="kn">from</span> <span class="nn">these</span> <span class="n">ranges</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motors</span> <span class="k">with</span> <span class="n">a</span> <span class="n">combined</span> <span class="n">N</span><span class="o">-</span><span class="n">dimensional</span> <span class="n">state</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Each</span> <span class="n">motor</span><span class="s1">&#39;s respective position states along its direction</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Hardware</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">problem</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Whether</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">to</span> <span class="n">do</span> <span class="n">anything</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">motors</span> <span class="n">we</span><span class="s1">&#39;re actually using</span>
    <span class="n">nActiveMotorCount</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">state</span> <span class="n">that</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">are</span> <span class="n">moving</span> <span class="n">to</span><span class="p">,</span> <span class="n">along</span> <span class="n">dimension</span> <span class="mi">2</span> <span class="n">of</span> <span class="n">the</span> <span class="n">position</span> <span class="n">state</span> <span class="n">array</span><span class="o">.</span> <span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="n">the</span> <span class="n">same</span> <span class="k">as</span> <span class="n">the</span> <span class="n">current</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">nGoalStateIndex</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">A</span> <span class="n">name</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="n">this</span> <span class="n">state</span> <span class="n">mover</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">case</span> <span class="n">of</span> <span class="n">fast</span> <span class="n">faults</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">put</span> <span class="n">motors</span> <span class="n">into</span> <span class="n">maintenance</span> <span class="n">mode</span><span class="o">.</span> <span class="n">This</span> <span class="n">allows</span> <span class="n">us</span> <span class="n">to</span> <span class="n">freely</span> <span class="n">move</span> <span class="n">the</span> <span class="n">motors</span> <span class="n">at</span> <span class="n">the</span> <span class="n">cost</span> <span class="n">of</span> <span class="n">a</span> <span class="n">fast</span> <span class="n">fault</span><span class="o">.</span>
    <span class="n">bMaintMode</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">overal</span> <span class="n">PMPS</span> <span class="n">FB</span> <span class="n">state</span>
    <span class="n">eStatePMPSStatus</span><span class="p">:</span> <span class="n">E_StatePMPSStatus</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Connect</span> <span class="kn">from</span> <span class="nn">bptm</span> <span class="n">bTransitionAuthorized</span>
    <span class="n">bTransitionAuthorized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Per</span><span class="o">-</span><span class="n">motor</span> <span class="n">enable</span> <span class="n">state</span> <span class="n">we</span> <span class="n">send</span> <span class="n">to</span> <span class="n">MC_Power</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="k">pass</span><span class="o">-</span><span class="n">through</span> <span class="kn">from</span> <span class="nn">stMotionStage.</span>
    <span class="n">abEnabled</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Per</span><span class="o">-</span><span class="n">motor</span> <span class="n">forward</span> <span class="n">enable</span> <span class="n">state</span> <span class="n">we</span> <span class="n">send</span> <span class="n">to</span> <span class="n">MC_Power</span><span class="o">.</span> <span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="k">pass</span><span class="o">-</span><span class="n">through</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">override</span> <span class="n">to</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">abForwardEnabled</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Per</span><span class="o">-</span><span class="n">motor</span> <span class="n">backwards</span> <span class="n">enable</span> <span class="n">state</span> <span class="n">we</span> <span class="n">send</span> <span class="n">to</span> <span class="n">MC_Power</span><span class="o">.</span> <span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="k">pass</span><span class="o">-</span><span class="n">through</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">override</span> <span class="n">to</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">abBackwardEnabled</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Per</span><span class="o">-</span><span class="n">motor</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">goal</span> <span class="n">position</span> <span class="ow">and</span> <span class="n">FALSE</span> <span class="n">otherwise</span><span class="o">.</span> <span class="n">This</span> <span class="n">makes</span> <span class="n">a</span> <span class="n">fast</span> <span class="n">fault</span> <span class="k">if</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">abValidGoal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">the</span> <span class="n">arrays</span> <span class="n">have</span> <span class="n">mismatched</span> <span class="n">sizing</span><span class="o">.</span> <span class="n">For</span> <span class="n">this</span> <span class="n">FB</span><span class="p">,</span> <span class="n">this</span> <span class="n">means</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">won</span><span class="s1">&#39;t ever get an enable.</span>
    <span class="n">bMotorCountError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">individual</span> <span class="n">state</span> <span class="n">limit</span> <span class="n">function</span> <span class="n">blocks</span>
    <span class="n">afbStateEnables</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_StatePMPSEnables</span><span class="p">;</span>
    <span class="n">ffMaint</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">ffProgrammerError</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CheckCount</span><span class="p">();</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMotorCountError</span> <span class="n">THEN</span>
    <span class="n">DoLimits</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">RunFastFaults</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">CheckCount</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">valid</span> <span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">nonzero</span><span class="p">,</span> <span class="n">less</span> <span class="ow">or</span> <span class="n">equal</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">max</span><span class="p">)</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bMotorCountError</span> <span class="n">S</span><span class="o">=</span> <span class="n">nActiveMotorCount</span> <span class="o">&gt;</span> <span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">;</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">DoLimits</span><span class="p">:</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nActiveMotorCount</span> <span class="n">DO</span>
    <span class="n">afbStateEnables</span><span class="p">[</span><span class="n">nIter</span><span class="p">](</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
        <span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnable</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bMaintMode</span><span class="p">,</span>
        <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="n">nGoalStateIndex</span><span class="p">,</span>
        <span class="n">eStatePMPSStatus</span><span class="o">:=</span><span class="n">eStatePMPSStatus</span><span class="p">,</span>
        <span class="n">bTransitionAuthorized</span><span class="o">:=</span><span class="n">bTransitionAuthorized</span><span class="p">,</span>
        <span class="n">bEnabled</span><span class="o">=&gt;</span><span class="n">abEnabled</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">bForwardEnabled</span><span class="o">=&gt;</span><span class="n">abForwardEnabled</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">bBackwardEnabled</span><span class="o">=&gt;</span><span class="n">abBackwardEnabled</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">bValidGoal</span><span class="o">=&gt;</span><span class="n">abValidGoal</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">RunFastFaults</span><span class="p">:</span>
<span class="n">ffMaint</span><span class="p">(</span>
    <span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bMaintMode</span><span class="p">,</span>
    <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Device is in maintenance mode&#39;</span><span class="p">,</span>
    <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">MAINT_MODE</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">ffProgrammerError</span><span class="p">(</span>
    <span class="n">i_xOK</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bMotorCountError</span><span class="p">,</span>
    <span class="n">i_xAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_DevName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">i_Desc</span><span class="o">:=</span><span class="s1">&#39;Programmer error picking motor count&#39;</span><span class="p">,</span>
    <span class="n">i_TypeCode</span><span class="o">:=</span><span class="n">E_MotionFFType</span><span class="o">.</span><span class="n">INTERNAL_ERROR</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionfftype">E_MotionFFType</a></p></li>
<li><p><a class="reference internal" href="#e-statepmpsstatus">E_StatePMPSStatus</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenables">FB_StatePMPSEnables</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statepmpsenablesnd-test">
<h2>FB_StatePMPSEnablesND_Test<a class="headerlink" href="#fb-statepmpsenablesnd-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StatePMPSEnablesND_Test</span> <span class="n">EXTENDS</span> <span class="n">FB_MotorTestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Unit</span> <span class="n">tests</span> <span class="k">for</span> <span class="n">FB_StatePMPSEnablesND</span>
    <span class="n">I</span><span class="s1">&#39;m confident that FB_StatePMPSEnables was tested in FB_StatePMPSEnables_Test</span>
    <span class="n">There</span> <span class="n">will</span> <span class="n">be</span> <span class="n">one</span> <span class="n">core</span> <span class="n">functionality</span> <span class="n">check</span>
    <span class="n">Then</span><span class="p">,</span> <span class="n">the</span> <span class="n">rest</span> <span class="n">will</span> <span class="n">be</span> <span class="n">about</span> <span class="n">the</span> <span class="n">ND</span> <span class="n">feature</span> <span class="n">adds</span><span class="o">.</span>
    <span class="n">Full</span> <span class="n">checks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Core</span> <span class="n">motors</span> <span class="ow">not</span> <span class="n">at</span> <span class="n">goal</span> <span class="n">can</span><span class="s1">&#39;t move away check</span>
    <span class="o">-</span> <span class="n">bMaintMode</span> <span class="o">=</span> <span class="n">no</span> <span class="n">move</span> <span class="n">restrictions</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">motors</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">bMaintMode</span> <span class="o">=</span> <span class="n">fast</span> <span class="n">fault</span>
    <span class="o">-</span> <span class="n">Wrong</span> <span class="n">count</span> <span class="o">=</span> <span class="n">fast</span> <span class="n">fault</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">astMotionStage</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MotionConstants</span><span class="o">.</span><span class="n">MAX_STATE_MOTORS</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">afbInternal</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_PositionStateInternal</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Spoof</span> <span class="n">motor</span> <span class="n">enables</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">3</span> <span class="n">DO</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bAllForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">bAllBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="o">//</span> <span class="n">Note</span><span class="p">:</span> <span class="n">the</span> <span class="n">fake</span> <span class="n">motors</span> <span class="n">show</span> <span class="k">as</span> <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">so</span> <span class="n">they</span> <span class="n">will</span> <span class="n">be</span> <span class="n">over</span><span class="o">/</span><span class="n">under</span> <span class="n">the</span> <span class="n">goals</span> <span class="n">here</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">afbInternal</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
<span class="p">);</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>

<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">10</span><span class="p">;</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">afbInternal</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
<span class="p">);</span>
<span class="n">SetGoodState</span><span class="p">(</span><span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>

<span class="n">TestUnderOverGoals</span><span class="p">();</span>
<span class="n">TestMaint</span><span class="p">();</span>
<span class="n">TestCount</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestCount</span>
<span class="n">VAR_INST</span>
    <span class="n">fbEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnablesND</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestCount&#39;</span><span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">No</span> <span class="n">faults</span> <span class="n">please</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Had faults prior to test&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbEnables</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestUnderOverGoals&#39;</span><span class="p">,</span>
    <span class="n">bMaintMode</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Must</span> <span class="n">fault</span> <span class="k">with</span> <span class="n">bad</span> <span class="n">count</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Had no fault with bad count&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestMaint</span>
<span class="n">VAR_INST</span>
    <span class="n">fbEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnablesND</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestMaint&#39;</span><span class="p">);</span>

<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">No</span> <span class="n">faults</span> <span class="n">please</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Had faults prior to test&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbEnables</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestUnderOverGoals&#39;</span><span class="p">,</span>
    <span class="n">bMaintMode</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Must</span> <span class="n">fault</span> <span class="ow">in</span> <span class="n">maint</span> <span class="n">mode</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Had no fault in maintenance mode&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">All</span> <span class="n">overrides</span> <span class="n">should</span> <span class="n">be</span> <span class="n">relaxed</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abForwardEnabled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;In maintenance mode, we should be able to move anywhere&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abBackwardEnabled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;In maintenance mode, we should be able to move anywhere&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abForwardEnabled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;In maintenance mode, we should be able to move anywhere&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abBackwardEnabled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;In maintenance mode, we should be able to move anywhere&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestUnderOverGoals</span>
<span class="n">VAR_INST</span>
    <span class="n">fbEnables</span><span class="p">:</span> <span class="n">FB_StatePMPSEnablesND</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">bAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestUnderOverGoals&#39;</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bUpdated</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Cannot</span> <span class="n">run</span> <span class="n">this</span> <span class="n">test</span> <span class="n">until</span> <span class="n">the</span> <span class="n">one</span><span class="o">-</span><span class="n">time</span><span class="o">-</span><span class="n">setup</span> <span class="n">runs</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbEnables</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="o">:=</span><span class="n">astMotionStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">bEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">nActiveMotorCount</span><span class="o">:=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">nGoalStateIndex</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="s1">&#39;TestUnderOverGoals&#39;</span><span class="p">,</span>
    <span class="n">bMaintMode</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">EvaluateOutput</span><span class="p">();</span>
<span class="o">//</span> <span class="n">No</span> <span class="n">faults</span> <span class="n">please</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">,</span>
    <span class="s1">&#39;Had faults in normal situation&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">All</span> <span class="n">core</span> <span class="n">enables</span> <span class="n">are</span> <span class="n">true</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">,</span>
    <span class="s1">&#39;Core enables should be TRUE&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bAllBackwardEnable</span><span class="p">,</span>
    <span class="s1">&#39;Core enables should be TRUE&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">,</span>
    <span class="s1">&#39;Core enables should be TRUE&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">astMotionStage</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">bAllBackwardEnable</span><span class="p">,</span>
    <span class="s1">&#39;Core enables should be TRUE&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">But</span> <span class="n">the</span> <span class="n">overrides</span> <span class="n">force</span> <span class="n">us</span> <span class="n">to</span> <span class="n">move</span> <span class="n">toward</span> <span class="n">the</span> <span class="n">goal</span>
<span class="o">//</span> <span class="n">Motor</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">below</span> <span class="n">the</span> <span class="n">goal</span><span class="p">,</span> <span class="n">Motor</span> <span class="mi">2</span> <span class="ow">is</span> <span class="n">above</span> <span class="n">the</span> <span class="n">goal</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abForwardEnabled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;Motor 1 should be able to move up to the goal&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abBackwardEnabled</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s1">&#39;Motor 1 should not be able to move down away from the goal&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abForwardEnabled</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="s1">&#39;Motor 2 should not be able to move up away from the goal&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbEnables</span><span class="o">.</span><span class="n">abBackwardEnabled</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="s1">&#39;Motor 2 should be able to move down to the goal&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motortestsuite">FB_MotorTestSuite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenables">FB_StatePMPSEnables</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenablesnd">FB_StatePMPSEnablesND</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenables-test">FB_StatePMPSEnables_Test</a></p></li>
<li><p><a class="reference internal" href="#motionconstants">MotionConstants</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-stateptpmove">
<h2>FB_StatePTPMove<a class="headerlink" href="#fb-stateptpmove" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;obsolete&#39;</span> <span class="o">:=</span> <span class="s1">&#39;Use FB_PositionStateMove instead&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StatePTPMove</span>
<span class="o">//</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span><span class="p">,</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">deprecated</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span>
    <span class="s1">&#39;}</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GO</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">bMoveOk</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">AT_STATE</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bAtState</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DMOV</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BUSY</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERRMSG</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">sError</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bExecTrig</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bExecEnd</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">fActPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fLowPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fHighPos</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bExecTrig</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">bExecTrig</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">bMoveOk</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">nCommand</span> <span class="o">:=</span> <span class="n">E_EpicsMotorCmd</span><span class="o">.</span><span class="n">MOVE_ABSOLUTE</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fAccel</span><span class="p">;</span>
        <span class="n">stMotionStage</span><span class="o">.</span><span class="n">fDeceleration</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDecel</span><span class="p">;</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>
<span class="n">bError</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">;</span>
<span class="n">sError</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">;</span>

<span class="n">fActPosition</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
<span class="n">fLowPos</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">-</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">fHighPos</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">fLowPos</span> <span class="o">&lt;</span> <span class="n">fActPosition</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">fHighPos</span> <span class="o">&gt;</span> <span class="n">fActPosition</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bAtState</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">bAtState</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bExecEnd</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">bExecEnd</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-epicsmotorcmd">E_EpicsMotorCmd</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemove">FB_PositionStateMove</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statesetuphelper">
<h2>FB_StateSetupHelper<a class="headerlink" href="#fb-statesetuphelper" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StateSetupHelper</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">helper</span> <span class="k">for</span> <span class="n">setting</span> <span class="n">up</span> <span class="n">large</span> <span class="n">numbers</span> <span class="n">of</span> <span class="n">ST_PositionState</span> <span class="n">instances</span><span class="o">.</span>

    <span class="n">This</span> <span class="ow">is</span> <span class="n">typically</span> <span class="n">verbose</span> <span class="n">to</span> <span class="n">do</span> <span class="n">by</span> <span class="n">hand</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">normal</span> <span class="n">ways</span> <span class="ow">and</span> <span class="n">can</span> <span class="n">be</span> <span class="n">error</span><span class="o">-</span><span class="n">prone</span><span class="o">.</span>

    <span class="n">Calling</span> <span class="k">with</span> <span class="n">bSetDefault</span><span class="o">:=</span><span class="n">TRUE</span> <span class="n">will</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">default</span> <span class="n">values</span> <span class="n">to</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">values</span>
    <span class="kn">from</span> <span class="nn">the</span> <span class="nb">input</span> <span class="n">stPositionState</span><span class="o">.</span> <span class="n">Note</span> <span class="n">that</span> <span class="n">the</span> <span class="n">other</span> <span class="n">args</span> <span class="n">will</span> <span class="n">be</span> <span class="n">ignored</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">case</span><span class="o">.</span>
    <span class="n">This</span> <span class="n">must</span> <span class="n">be</span> <span class="n">done</span> <span class="n">at</span> <span class="n">least</span> <span class="n">once</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">forget</span> <span class="n">to</span> <span class="n">do</span> <span class="n">this</span><span class="p">,</span> <span class="n">there</span> <span class="n">will</span> <span class="n">be</span> <span class="n">a</span> <span class="n">warning</span> <span class="ow">and</span>
    <span class="n">bValid</span> <span class="n">will</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">making</span> <span class="n">it</span> <span class="n">so</span> <span class="n">we</span> <span class="n">cannot</span> <span class="n">move</span> <span class="n">to</span> <span class="n">that</span> <span class="n">state</span><span class="o">.</span>

    <span class="n">Calling</span> <span class="n">without</span> <span class="n">bSetDefault</span> <span class="ow">or</span> <span class="k">with</span> <span class="n">it</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">FALSE</span> <span class="n">will</span> <span class="n">apply</span> <span class="n">values</span> <span class="n">to</span> <span class="n">the</span>
    <span class="nb">input</span> <span class="n">stPositionState</span> <span class="k">with</span> <span class="n">the</span> <span class="n">following</span> <span class="n">priority</span> <span class="n">order</span><span class="p">:</span>

    <span class="mf">1.</span> <span class="n">The</span> <span class="n">value</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">function</span> <span class="n">block</span> <span class="n">call</span>
    <span class="mf">2.</span> <span class="n">The</span> <span class="n">value</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">template</span> <span class="n">stPositionState</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">most</span> <span class="n">recent</span>
       <span class="n">call</span> <span class="k">with</span> <span class="n">bSetDefault</span><span class="o">:=</span><span class="n">TRUE</span>
    <span class="mf">3.</span> <span class="n">The</span> <span class="n">original</span> <span class="n">default</span> <span class="n">value</span> <span class="k">as</span> <span class="n">defined</span> <span class="n">on</span> <span class="n">ST_PositionState</span>

    <span class="n">For</span> <span class="n">ease</span> <span class="n">of</span> <span class="n">use</span><span class="p">,</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">EPICS</span> <span class="n">writes</span> <span class="k">if</span> <span class="n">unlocked</span><span class="p">,</span> <span class="ow">and</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">repeated</span>
    <span class="bp">self</span><span class="o">-</span><span class="n">overwrites</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">encoder</span> <span class="n">count</span> <span class="n">use</span> <span class="n">case</span><span class="p">,</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="n">will</span> <span class="ow">not</span>
    <span class="n">reapply</span> <span class="n">the</span> <span class="n">values</span> <span class="n">to</span> <span class="n">the</span> <span class="n">same</span> <span class="n">state</span> <span class="n">again</span> <span class="n">after</span> <span class="n">the</span> <span class="n">state</span> <span class="n">has</span> <span class="n">been</span> <span class="n">fully</span>
    <span class="n">initialized</span> <span class="n">by</span> <span class="n">the</span> <span class="n">states</span> <span class="n">function</span> <span class="n">blocks</span><span class="p">,</span> <span class="k">as</span> <span class="n">determined</span> <span class="n">by</span> <span class="n">the</span> <span class="n">bUpdated</span> <span class="n">struct</span>
    <span class="n">member</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">reapply</span> <span class="n">every</span> <span class="n">cycle</span> <span class="n">you</span> <span class="n">can</span>
    <span class="nb">set</span> <span class="n">bForceUpdate</span> <span class="n">to</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">but</span> <span class="n">it</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">recommended</span><span class="o">.</span> <span class="n">Without</span> <span class="n">this</span> <span class="n">feature</span><span class="p">,</span>
    <span class="n">you</span> <span class="n">would</span> <span class="n">be</span> <span class="n">required</span> <span class="n">to</span> <span class="n">wrap</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">guard</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">it</span>
    <span class="n">was</span> <span class="n">only</span> <span class="n">called</span> <span class="n">once</span> <span class="n">per</span> <span class="n">state</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">fairly</span> <span class="n">annoying</span><span class="o">.</span>

    <span class="n">Example</span> <span class="n">expected</span> <span class="n">usage</span><span class="p">:</span>
    <span class="n">VAR</span>
        <span class="n">fbStateSetup</span><span class="p">:</span> <span class="n">FB_StateSetupHelper</span><span class="p">;</span>
        <span class="n">stDefault</span><span class="p">:</span> <span class="n">ST_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
            <span class="n">fDelta</span> <span class="o">:=</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
            <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span>
        <span class="p">);</span>
        <span class="n">astStates1</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
        <span class="n">astStates2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
        <span class="n">astStates2</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">END_VAR</span>

    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stDefault</span><span class="p">,</span> <span class="n">bSetDefault</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;YAG&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mi">20</span><span class="p">);</span>
    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;TT&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mi">30</span><span class="p">);</span>

    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=-</span><span class="mi">30</span><span class="p">);</span>
    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;YAG&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mi">35</span><span class="p">);</span>
    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates2</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;TT&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mi">70</span><span class="p">);</span>

    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">fDelta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">);</span>
    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates3</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;YAG&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mf">2.3</span><span class="p">,</span> <span class="n">fDelta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">);</span>
    <span class="n">fbStateSetup</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">astStates3</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;TT&#39;</span><span class="p">,</span> <span class="n">fPosition</span><span class="o">:=</span><span class="mf">5.6</span><span class="p">,</span> <span class="n">fDelta</span><span class="o">:=</span><span class="mf">0.1</span><span class="p">;</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bSetDefault</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bForceUpdate</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nEncoderCount</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">fDelta</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fAccel</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fDecel</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bMoveOk</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLocked</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bValid</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bUseRawCounts</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sPmpsState</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">stDefault</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbWarning</span><span class="p">:</span> <span class="n">FB_LogMessage</span><span class="p">;</span>
    <span class="n">bHasDefault</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHasWarned</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sJson</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">bSetDefault</span> <span class="n">THEN</span>
    <span class="n">bSetDefault</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bHasDefault</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stDefault</span> <span class="o">:=</span> <span class="n">stPositionState</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">bForceUpdate</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">bUpdated</span> <span class="n">THEN</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="n">sName</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fPosition</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">nEncoderCount</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fDelta</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">fVelocity</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">fAccel</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">:=</span> <span class="n">fDecel</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">bMoveOk</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">bLocked</span> <span class="o">:=</span> <span class="n">bLocked</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">bValid</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">bUseRawCounts</span><span class="p">;</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="n">sPmpsState</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bHasDefault</span> <span class="n">THEN</span>
        <span class="n">stPositionState</span><span class="o">.</span><span class="n">bValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bHasWarned</span> <span class="n">THEN</span>
            <span class="n">bHasWarned</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">sJson</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;{&quot;sName&quot;: &quot;&#39;</span><span class="p">,</span> <span class="n">sName</span><span class="p">),</span> <span class="s1">&#39;&quot;, &quot;sPmpsState&quot;: &quot;&#39;</span><span class="p">),</span> <span class="n">sPmpsState</span><span class="p">),</span> <span class="s1">&#39;&quot;}&#39;</span><span class="p">);</span>
            <span class="n">fbWarning</span><span class="p">(</span>
                <span class="n">sMsg</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Did not initialize any defaults in FB_StateSetupHelper! Some states are disabled, check your code! &#39;</span><span class="p">,</span> <span class="n">sJson</span><span class="p">),</span>
                <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Warning</span><span class="p">,</span>
                <span class="n">eSubSystem</span><span class="o">:=</span><span class="n">E_Subsystem</span><span class="o">.</span><span class="n">MOTION</span><span class="p">,</span>
                <span class="n">sJson</span><span class="o">:=</span><span class="n">sJson</span><span class="p">,</span>
            <span class="p">);</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Overwrite</span> <span class="n">the</span> <span class="nb">input</span> <span class="n">args</span> <span class="n">so</span> <span class="n">that</span> <span class="n">unset</span> <span class="n">args</span> <span class="n">are</span> <span class="n">the</span> <span class="n">defaults</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">call</span>
<span class="n">sName</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">sName</span><span class="p">;</span>
<span class="n">fPosition</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
<span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">nEncoderCount</span><span class="p">;</span>
<span class="n">fDelta</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
<span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
<span class="n">fAccel</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">fAccel</span><span class="p">;</span>
<span class="n">fDecel</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">fDecel</span><span class="p">;</span>
<span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">bMoveOk</span><span class="p">;</span>
<span class="n">bLocked</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">bLocked</span><span class="p">;</span>
<span class="n">bValid</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">bValid</span><span class="p">;</span>
<span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">bUseRawCounts</span><span class="p">;</span>
<span class="n">sPmpsState</span> <span class="o">:=</span> <span class="n">stDefault</span><span class="o">.</span><span class="n">stPMPS</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statesetuphelper-test">
<h2>FB_StateSetupHelper_Test<a class="headerlink" href="#fb-statesetuphelper-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_StateSetupHelper_Test EXTENDS FB_TestSuite
VAR
    astStates: ARRAY[1..10] OF ST_PositionState;
    stDefaultDefault: ST_PositionState;
END_VAR
TestNormalCase();
TestDefaultOnly();
TestManyOverrides();
TestNoDefault();
TestOnlyOnce();

END_FUNCTION_BLOCK

METHOD TestDefaultOnly
VAR
    fbStateSetup: FB_StateSetupHelper;
    stDefault: ST_PositionState := (
        sName := &#39;DEFAULT&#39;,
        fPosition := 100,
        nEncoderCount := 200,
        fDelta := 0.5,
        fVelocity := 10,
        fAccel := 12,
        fDecel := 24,
        bMoveOk := TRUE,
        bLocked := TRUE,
        bValid := TRUE,
        bUseRawCounts := TRUE
    );
    stOriginal: ST_PositionState;
    stTarget: ST_PositionState;
END_VAR
TEST(&#39;TestDefaultOnly&#39;);

// Add a pmps key
stDefault.stPMPS.sPmpsState := &#39;KEY&#39;;
// Cache the defaults to use as the check in case stDefault gets mutated by a bug
stOriginal := stDefault;
// Apply only defaults
fbStateSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbStateSetup(stPositionState:=stTarget);
// Check everything
AssertEquals_STRING(stOriginal.sName, stTarget.sName, &#39;Wrong sName&#39;);
AssertEquals_LREAL(stOriginal.fPosition, stTarget.fPosition, 0, &#39;Wrong fPosition&#39;);
AssertEquals_UDINT(stOriginal.nEncoderCount, stTarget.nEncoderCount, &#39;Wrong nEncoderCount&#39;);
AssertEquals_LREAL(stOriginal.fDelta, stTarget.fDelta, 0, &#39;Wrong fDelta&#39;);
AssertEquals_LREAL(stOriginal.fVelocity, stTarget.fVelocity, 0, &#39;Wrong fVelocity&#39;);
AssertEquals_LREAL(stOriginal.fAccel, stTarget.fAccel, 0, &#39;Wrong fAccel&#39;);
AssertEquals_LREAL(stOriginal.fDecel, stTarget.fDecel, 0, &#39;Wrong fDecel&#39;);
AssertEquals_BOOL(stOriginal.bMoveOk, stTarget.bMoveOk, &#39;Wrong bMoveOk&#39;);
AssertEquals_BOOL(stOriginal.bLocked, stTarget.bLocked, &#39;Wrong bLocked&#39;);
AssertEquals_BOOL(stOriginal.bValid, stTarget.bValid, &#39;Wrong bValid&#39;);
AssertEquals_BOOL(stOriginal.bUseRawCounts, stTarget.bUseRawCounts, &#39;Wrong bUseRawCounts&#39;);
AssertEquals_STRING(stOriginal.stPMPS.sPmpsState, stTarget.stPMPS.sPmpsState, &#39;Wrong sPmpsState&#39;);

TEST_FINISHED();
END_METHOD

METHOD TestManyOverrides
VAR
    fbStateSetup: FB_StateSetupHelper;
    stDefault: ST_PositionState := (
        sName := &#39;POTATO&#39;,
        fPosition := 23,
        fDelta := 0.5,
        fVelocity := 10
    );
    stOne: ST_PositionState;
    stTwo: ST_PositionState;
END_VAR
TEST(&#39;TestManyOverrides&#39;);
// This is the case where the defaults are always overriden

fbStateSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbStateSetup(stPositionState:=stOne, sName:=&#39;ONE&#39;, fPosition:=10, fDelta:=0.1, fVelocity:=20);
fbStateSetup(stPositionState:=stTWO, sName:=&#39;TWO&#39;, fPosition:=30, fDelta:=0.23, fVelocity:=4);

// Check Everything
AssertEquals_STRING(&#39;ONE&#39;, stOne.sName, &#39;Wrong sName in state 1&#39;);
AssertEquals_LREAL(10, stOne.fPosition, 0, &#39;Wrong fPosition in state 1&#39;);
AssertEquals_UDINT(stDefaultDefault.nEncoderCount, stOne.nEncoderCount, &#39;Wrong nEncoderCount in state 1&#39;);
AssertEquals_LREAL(0.1, stOne.fDelta, 0, &#39;Wrong fDelta in state 1&#39;);
AssertEquals_LREAL(20, stOne.fVelocity, 0, &#39;Wrong fVelocity in state 1&#39;);
AssertEquals_LREAL(stDefaultDefault.fAccel, stOne.fAccel, 0, &#39;Wrong fAccel in state 1&#39;);
AssertEquals_LREAL(stDefaultDefault.fDecel, stOne.fDecel, 0, &#39;Wrong fDecel in state 1&#39;);
AssertEquals_BOOL(stDefaultDefault.bMoveOk, stOne.bMoveOk, &#39;Wrong bMoveOk in state 1&#39;);
AssertEquals_BOOL(stDefaultDefault.bLocked, stOne.bLocked, &#39;Wrong bLocked in state 1&#39;);
AssertEquals_BOOL(stDefaultDefault.bValid, stOne.bValid, &#39;Wrong bValid in state 1&#39;);
AssertEquals_BOOL(stDefaultDefault.bUseRawCounts, stOne.bUseRawCounts, &#39;Wrong bUseRawCounts in state 1&#39;);
AssertEquals_STRING(stDefaultDefault.stPMPS.sPmpsState, stOne.stPMPS.sPmpsState, &#39;Wrong sPmpsState in state 1&#39;);

AssertEquals_STRING(&#39;TWO&#39;, stTwo.sName, &#39;Wrong sName in state 2&#39;);
AssertEquals_LREAL(30, stTwo.fPosition, 0, &#39;Wrong fPosition in state 2&#39;);
AssertEquals_UDINT(stDefaultDefault.nEncoderCount, stTwo.nEncoderCount, &#39;Wrong nEncoderCount in state 2&#39;);
AssertEquals_LREAL(0.23, stTwo.fDelta, 0, &#39;Wrong fDelta in state 2&#39;);
AssertEquals_LREAL(4, stTwo.fVelocity, 0, &#39;Wrong fVelocity in state 2&#39;);
AssertEquals_LREAL(stDefaultDefault.fAccel, stTwo.fAccel, 0, &#39;Wrong fAccel in state 2&#39;);
AssertEquals_LREAL(stDefaultDefault.fDecel, stTwo.fDecel, 0, &#39;Wrong fDecel in state 2&#39;);
AssertEquals_BOOL(stDefaultDefault.bMoveOk, stTwo.bMoveOk, &#39;Wrong bMoveOk in state 2&#39;);
AssertEquals_BOOL(stDefaultDefault.bLocked, stTwo.bLocked, &#39;Wrong bLocked in state 2&#39;);
AssertEquals_BOOL(stDefaultDefault.bValid, stTwo.bValid, &#39;Wrong bValid in state 2&#39;);
AssertEquals_BOOL(stDefaultDefault.bUseRawCounts, stTwo.bUseRawCounts, &#39;Wrong bUseRawCounts in state 2&#39;);
AssertEquals_STRING(stDefaultDefault.stPMPS.sPmpsState, stTwo.stPMPS.sPmpsState, &#39;Wrong sPmpsState in state 2&#39;);

TEST_FINISHED();
END_METHOD

METHOD TestNoDefault
VAR
    fbStateSetup: FB_StateSetupHelper;
    stTarget: ST_PositionState;
END_VAR
TEST(&#39;TestNoDefault&#39;);
// No default = invalid state + warning log message

fbStateSetup(stPositionState:=stTarget, sName:=&#39;TestNoDefault&#39;, sPmpsState:=&#39;TestPMPS&#39;, bValid:=TRUE);
// Only bValid matters, it must not be valid!
AssertFalse(stTarget.bValid, &#39;bValid should be FALSE with no default set.&#39;);

TEST_FINISHED();
END_METHOD

METHOD TestNormalCase
VAR
    fbStateSetup: FB_StateSetupHelper;
    stDefault: ST_PositionState;
END_VAR
VAR CONSTANT
    cDelta: LREAL := 0.5;
    cVelocity: LREAL := 10;
    cMoveOk: BOOL := TRUE;
    cValid: BOOL := TRUE;
END_VAR
TEST(&#39;TestNormalCase&#39;);
// Mimic what I might do in a real project

stDefault.fDelta := cDelta;
stDefault.fVelocity := cVelocity;
stDefault.bMoveOk := cMoveOk;
stDefault.bValid := cValid;

fbStateSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbStateSetup(stPositionState:=astStates[1], sName:=&#39;OUT&#39;, fPosition:=10, sPmpsState:=&#39;FAKE_OUT&#39;);
fbStateSetup(stPositionState:=astStates[2], sName:=&#39;YAG&#39;, fPosition:=20, sPmpsState:=&#39;FAKE_YAG&#39;);
fbStateSetup(stPositionState:=astStates[3], sName:=&#39;TT&#39;, fPosition:=30, sPmpsState:=&#39;FAKE_TT&#39;);

// Check everything
AssertEquals_STRING(&#39;OUT&#39;, astStates[1].sName, &#39;Wrong sName in state 1&#39;);
AssertEquals_LREAL(10, astStates[1].fPosition, 0, &#39;Wrong fPosition in state 1&#39;);
AssertEquals_UDINT(stDefaultDefault.nEncoderCount, astStates[1].nEncoderCount, &#39;Wrong nEncoderCount in state 1&#39;);
AssertEquals_LREAL(cDelta, astStates[1].fDelta, 0, &#39;Wrong fDelta in state 1&#39;);
AssertEquals_LREAL(cVelocity, astStates[1].fVelocity, 0, &#39;Wrong fVelocity in state 1&#39;);
AssertEquals_LREAL(stDefaultDefault.fAccel, astStates[1].fAccel, 0, &#39;Wrong fAccel in state 1&#39;);
AssertEquals_LREAL(stDefaultDefault.fDecel, astStates[1].fDecel, 0, &#39;Wrong fDecel in state 1&#39;);
AssertEquals_BOOL(cMoveOk, astStates[1].bMoveOk, &#39;Wrong bMoveOk in state 1&#39;);
AssertEquals_BOOL(stDefaultDefault.bLocked, astStates[1].bLocked, &#39;Wrong bLocked in state 1&#39;);
AssertEquals_BOOL(cValid, astStates[1].bValid, &#39;Wrong bValid in state 1&#39;);
AssertEquals_BOOL(stDefaultDefault.bUseRawCounts, astStates[1].bUseRawCounts, &#39;Wrong bUseRawCounts in state 1&#39;);
AssertEquals_STRING(&#39;FAKE_OUT&#39;, astStates[1].stPMPS.sPmpsState, &#39;Wrong sPmpsState in state 1&#39;);

AssertEquals_STRING(&#39;YAG&#39;, astStates[2].sName, &#39;Wrong sName in state 2&#39;);
AssertEquals_LREAL(20, astStates[2].fPosition, 0, &#39;Wrong fPosition in state 2&#39;);
AssertEquals_UDINT(stDefaultDefault.nEncoderCount, astStates[2].nEncoderCount, &#39;Wrong nEncoderCount in state 2&#39;);
AssertEquals_LREAL(cDelta, astStates[2].fDelta, 0, &#39;Wrong fDelta in state 2&#39;);
AssertEquals_LREAL(cVelocity, astStates[2].fVelocity, 0, &#39;Wrong fVelocity in state 2&#39;);
AssertEquals_LREAL(stDefaultDefault.fAccel, astStates[2].fAccel, 0, &#39;Wrong fAccel in state 2&#39;);
AssertEquals_LREAL(stDefaultDefault.fDecel, astStates[2].fDecel, 0, &#39;Wrong fDecel in state 2&#39;);
AssertEquals_BOOL(cMoveOk, astStates[2].bMoveOk, &#39;Wrong bMoveOk in state 2&#39;);
AssertEquals_BOOL(stDefaultDefault.bLocked, astStates[2].bLocked, &#39;Wrong bLocked in state 2&#39;);
AssertEquals_BOOL(cValid, astStates[2].bValid, &#39;Wrong bValid in state 2&#39;);
AssertEquals_BOOL(stDefaultDefault.bUseRawCounts, astStates[2].bUseRawCounts, &#39;Wrong bUseRawCounts in state 2&#39;);
AssertEquals_STRING(&#39;FAKE_YAG&#39;, astStates[2].stPMPS.sPmpsState, &#39;Wrong sPmpsState in state 2&#39;);

AssertEquals_STRING(&#39;TT&#39;, astStates[3].sName, &#39;Wrong sName in state 3&#39;);
AssertEquals_LREAL(30, astStates[3].fPosition, 0, &#39;Wrong fPosition in state 3&#39;);
AssertEquals_UDINT(stDefaultDefault.nEncoderCount, astStates[3].nEncoderCount, &#39;Wrong nEncoderCount in state 3&#39;);
AssertEquals_LREAL(cDelta, astStates[3].fDelta, 0, &#39;Wrong fDelta in state 3&#39;);
AssertEquals_LREAL(cVelocity, astStates[3].fVelocity, 0, &#39;Wrong fVelocity in state 3&#39;);
AssertEquals_LREAL(stDefaultDefault.fAccel, astStates[3].fAccel, 0, &#39;Wrong fAccel in state 3&#39;);
AssertEquals_LREAL(stDefaultDefault.fDecel, astStates[3].fDecel, 0, &#39;Wrong fDecel in state 3&#39;);
AssertEquals_BOOL(cMoveOk, astStates[3].bMoveOk, &#39;Wrong bMoveOk in state 3&#39;);
AssertEquals_BOOL(stDefaultDefault.bLocked, astStates[3].bLocked, &#39;Wrong bLocked in state 3&#39;);
AssertEquals_BOOL(cValid, astStates[3].bValid, &#39;Wrong bValid in state 3&#39;);
AssertEquals_BOOL(stDefaultDefault.bUseRawCounts, astStates[3].bUseRawCounts, &#39;Wrong bUseRawCounts in state 3&#39;);
AssertEquals_STRING(&#39;FAKE_TT&#39;, astStates[3].stPMPS.sPmpsState, &#39;Wrong sPmpsState in state 3&#39;);

TEST_FINISHED();
END_METHOD

METHOD TestOnlyOnce
VAR
    fbStateSetup: FB_StateSetupHelper;
    stDefault: ST_PositionState;
    stTarget: ST_PositionState;
END_VAR
TEST(&#39;TestOnlyOnce&#39;);

// Required call, even though we don&#39;t need anything here
fbStateSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
// Start with no position
AssertEquals_LREAL(stTarget.fPosition, 0, 0, &#39;Start position sanity check failed&#39;);
// Apply a new position
fbStateSetup(stPositionState:=stTarget, fPosition:=10);
AssertEquals_LREAL(stTarget.fPosition, 10, 0, &#39;Basic set position failed&#39;);
// Simulate the position state being used and updated via EPICS or otherwise
stTarget.bUpdated := TRUE; // Set by FB_PositionStateInternal
stTarget.fPosition := 12; // Someone tweaked the value in EPICS
// Run through the state setup again
fbStateSetup(stPositionState:=stTarget, fPosition:=10);
// But we should still be at position 12
AssertEquals_LREAL(stTarget.fPosition, 12, 0, &#39;FB_StateSetupHelper ran twice!&#39;);
// Unless we override the behavior
fbStateSetup(stPositionState:=stTarget, bForceUpdate:=TRUE, fPosition:=10);
AssertEquals_LREAL(stTarget.fPosition, 10, 0, &#39;bForceUpdate failed&#39;);

TEST_FINISHED();
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-positionstateinternal">FB_PositionStateInternal</a></p></li>
<li><p><a class="reference internal" href="#fb-statesetuphelper">FB_StateSetupHelper</a></p></li>
<li><p><a class="reference internal" href="#st-positionstate">ST_PositionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-statesinputhandler">
<h2>FB_StatesInputHandler<a class="headerlink" href="#fb-statesinputhandler" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_StatesInputHandler</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Handle</span> <span class="n">the</span> <span class="n">state</span> <span class="n">enum</span> <span class="n">EPICS</span> <span class="nb">input</span> <span class="k">for</span> <span class="nb">any</span> <span class="n">of</span> <span class="n">the</span> <span class="n">ND</span> <span class="n">state</span> <span class="n">function</span> <span class="n">blocks</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">desired</span> <span class="n">behavior</span> <span class="ow">is</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Trigger</span> <span class="n">a</span> <span class="n">move</span> <span class="n">to</span> <span class="n">a</span> <span class="n">new</span> <span class="n">state</span> <span class="n">when</span> <span class="n">the</span> <span class="n">enum</span> <span class="n">PV</span> <span class="ow">is</span> <span class="n">written</span> <span class="n">to</span>
    <span class="o">-</span> <span class="n">Interrupt</span> <span class="n">an</span> <span class="n">ongoing</span> <span class="n">move</span> <span class="k">with</span> <span class="n">a</span> <span class="n">new</span> <span class="n">one</span> <span class="k">if</span> <span class="n">the</span> <span class="n">enum</span> <span class="n">changes</span> <span class="n">mid</span><span class="o">-</span><span class="n">move</span>
    <span class="o">-</span> <span class="n">Stop</span> <span class="n">the</span> <span class="n">move</span> <span class="k">if</span> <span class="n">the</span> <span class="n">enum</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">value</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">user</span><span class="s1">&#39;s inputs from EPICS. This is an IN_OUT variable because we will write values back to this to help us detect when the same value is re-caput</span>
    <span class="n">stUserInput</span><span class="p">:</span> <span class="n">ST_StateEpicsToPlc</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">bBusy</span> <span class="n">boolean</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">motion</span> <span class="n">FB</span>
    <span class="n">bMoveBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">starting</span> <span class="n">state</span> <span class="n">number</span> <span class="n">to</span> <span class="n">seed</span> <span class="n">nCurrGoal</span> <span class="k">with</span>
    <span class="n">nStartingState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">goal</span> <span class="n">index</span> <span class="n">to</span> <span class="nb">input</span> <span class="n">to</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">FB</span><span class="o">.</span> <span class="n">This</span> <span class="n">will</span> <span class="n">be</span> <span class="n">clamped</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">range</span> <span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span>
    <span class="n">nCurrGoal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">bExecute</span> <span class="n">boolean</span> <span class="n">to</span> <span class="nb">input</span> <span class="n">to</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">FB</span>
    <span class="n">bExecMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">bReset</span> <span class="n">boolean</span> <span class="n">to</span> <span class="nb">input</span> <span class="n">to</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">FB</span>
    <span class="n">bResetMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nQueuedGoal</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bNewMove</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">IDLE</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">GOING</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">WAIT_STOP</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stUserInput</span><span class="o">.</span><span class="n">nSetValue</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nCurrGoal</span> <span class="o">:=</span> <span class="n">nStartingState</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">bResetMove</span> <span class="o">:=</span> <span class="n">stUserInput</span><span class="o">.</span><span class="n">bReset</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">stUserInput</span><span class="o">.</span><span class="n">nSetValue</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">nQueuedGoal</span> <span class="o">:=</span> <span class="n">stUserInput</span><span class="o">.</span><span class="n">nSetValue</span><span class="p">;</span>
    <span class="n">bNewMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
    <span class="n">IDLE</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">bNewMove</span> <span class="n">AND</span> <span class="n">nQueuedGoal</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">nQueuedGoal</span> <span class="o">&lt;=</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">New</span> <span class="n">request</span><span class="p">,</span> <span class="n">currently</span> <span class="n">idle</span> <span class="o">-&gt;</span> <span class="n">ask</span> <span class="k">for</span> <span class="n">a</span> <span class="n">move</span>
            <span class="n">nCurrGoal</span> <span class="o">:=</span> <span class="n">nQueuedGoal</span><span class="p">;</span>
            <span class="n">bExecMove</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">bNewMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">bMoveBusy</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">We</span><span class="s1">&#39;re moving but used to be idle -&gt; switch to GOING</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">GOING</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">GOING</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">bNewMove</span> <span class="n">THEN</span>
            <span class="o">//</span> <span class="n">New</span> <span class="n">request</span><span class="p">,</span> <span class="n">currently</span> <span class="n">moving</span> <span class="o">-&gt;</span> <span class="n">ask</span> <span class="k">for</span> <span class="n">a</span> <span class="n">stop</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">WAIT_STOP</span><span class="p">;</span>
            <span class="n">bExecMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">bMoveBusy</span> <span class="n">THEN</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">IDLE</span><span class="p">;</span>
            <span class="n">nQueuedGoal</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">bExecMove</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">WAIT_STOP</span><span class="p">:</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bMoveBusy</span> <span class="n">THEN</span>
            <span class="n">nState</span> <span class="o">:=</span> <span class="n">IDLE</span><span class="p">;</span>
        <span class="n">END_IF</span>
<span class="n">END_CASE</span>

<span class="o">//</span> <span class="n">Help</span> <span class="n">us</span> <span class="n">detect</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">EPICS</span> <span class="n">put</span> <span class="n">before</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span>
<span class="n">stUserInput</span><span class="o">.</span><span class="n">nSetValue</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">stUserInput</span><span class="o">.</span><span class="n">bReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-stateepicstoplc">ST_StateEpicsToPlc</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-terminalerror">
<h2>FB_TerminalError<a class="headerlink" href="#fb-terminalerror" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TerminalError</span>

<span class="n">VAR_INPUT</span>
    <span class="n">En</span>                                      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iTerminal_ID</span>            <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">bWcState</span>                        <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">uiInfoData_State</span>        <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">pErrorSystem</span>            <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">ST_ErrorSystem</span><span class="p">;</span>                                    <span class="o">//</span><span class="n">Pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">error</span> <span class="n">system</span>
<span class="n">END_VAR</span>

<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">iStateError</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">iOtherError</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">ErrorData</span>       <span class="p">:</span> <span class="n">DUT_TerminalError</span><span class="p">;</span>
    <span class="n">nErrSysCNT</span>      <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">testing</span>
    <span class="n">bStateChanged</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                           <span class="o">//</span><span class="n">Indicate</span> <span class="k">if</span> <span class="n">state</span> <span class="n">change</span> <span class="n">happened</span>
    <span class="n">uiInfoData_State_Prev</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#8;           //Previous value of Infodata.State</span>
    <span class="n">bWcState_Prev</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>                          <span class="o">//</span><span class="n">Previous</span> <span class="n">state</span> <span class="n">of</span> <span class="n">WcState</span>

    <span class="o">//</span><span class="n">FB</span><span class="o">-</span><span class="n">s</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="n">Currently</span><span class="p">:</span>

<span class="n">Problem</span><span class="p">:</span>

<span class="n">TODO</span><span class="p">:</span>

<span class="o">*</span><span class="p">)</span>

<span class="o">//</span><span class="n">Connect</span> <span class="n">EN</span> <span class="n">to</span> <span class="n">EnO</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="o">//</span><span class="n">Check</span> <span class="k">if</span> <span class="n">pointer</span> <span class="ow">is</span> <span class="n">OK</span>
<span class="n">IF</span> <span class="n">pErrorSystem</span><span class="o">=</span><span class="mi">0</span> <span class="n">THEN</span> <span class="n">RETURN</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="o">//</span><span class="n">Any</span> <span class="n">difference</span> <span class="kn">from</span> <span class="nn">normal</span> <span class="n">state</span> <span class="n">creates</span> <span class="n">an</span> <span class="n">error</span>
<span class="n">IF</span> <span class="n">En</span> <span class="n">AND</span> <span class="p">(</span><span class="n">bWcState</span> <span class="n">OR</span> <span class="n">uiInfoData_State</span><span class="o">&lt;&gt;</span><span class="mi">16</span><span class="c1">#8) THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Change</span> <span class="n">detection</span>
<span class="n">IF</span> <span class="n">uiInfoData_State</span> <span class="o">&lt;&gt;</span> <span class="n">uiInfoData_State_Prev</span> <span class="n">OR</span> <span class="n">bWcState</span> <span class="o">&lt;&gt;</span> <span class="n">bWcState_Prev</span> <span class="n">THEN</span>
    <span class="n">bStateChanged</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">bStateChanged</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Update</span> <span class="n">previous</span> <span class="n">values</span>
<span class="n">uiInfoData_State_Prev</span> <span class="o">:=</span> <span class="n">uiInfoData_State</span><span class="p">;</span>
<span class="n">bWcState_Prev</span> <span class="o">:=</span> <span class="n">bWcState</span><span class="p">;</span>

<span class="o">//</span><span class="n">Decision</span> <span class="n">tree</span>
<span class="n">IF</span> <span class="n">bStateChanged</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Active</span> <span class="n">THEN</span>
                    <span class="o">//</span><span class="n">Close</span> <span class="n">active</span> <span class="n">error</span>
                    <span class="o">//</span><span class="n">Read</span> <span class="n">system</span> <span class="n">time</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOff</span> <span class="o">:=</span> <span class="n">Tc2_EtherCAT</span><span class="o">.</span><span class="n">F_GetActualDcTime64</span><span class="p">();</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sDateTimeOff</span> <span class="o">:=</span> <span class="n">Tc2_EtherCat</span><span class="o">.</span><span class="n">DCTIME64_TO_STRING</span><span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOff</span><span class="p">);</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">:=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Inactive</span><span class="p">;</span>
                    <span class="o">//</span><span class="n">Write</span> <span class="n">Off</span><span class="o">-</span><span class="n">time</span> <span class="n">to</span> <span class="n">Error</span> <span class="n">System</span>
                    <span class="n">FOR</span> <span class="n">nErrSysCNT</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">DO</span>
                            <span class="n">IF</span> <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">Error_ID</span> <span class="o">=</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">Error_ID</span> <span class="n">THEN</span>
                                    <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">nDateTimeOff</span> <span class="o">:=</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOff</span><span class="p">;</span>
                                    <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">sDateTimeOff</span> <span class="o">:=</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">sDateTimeOff</span><span class="p">;</span>
                                    <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">:=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Inactive</span><span class="p">;</span>
                                    <span class="n">EXIT</span><span class="p">;</span>
                            <span class="n">END_IF</span>
                    <span class="n">END_FOR</span>

                    <span class="o">//</span><span class="n">Clear</span> <span class="n">ErrorData</span>
                    <span class="n">MEMSET</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">ErrorData</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">ErrorData</span><span class="p">));</span>
            <span class="n">END_IF</span>

            <span class="o">//</span><span class="n">Open</span> <span class="n">a</span> <span class="n">new</span> <span class="n">error</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">:=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Active</span><span class="p">;</span>                                                                                          <span class="o">//</span><span class="n">Set</span> <span class="n">Error</span> <span class="n">State</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOn</span> <span class="o">:=</span> <span class="n">Tc2_EtherCAT</span><span class="o">.</span><span class="n">F_GetActualDcTime64</span><span class="p">();</span>                                                            <span class="o">//</span><span class="n">Get</span> <span class="n">system</span> <span class="n">time</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">sDateTimeOn</span> <span class="o">:=</span> <span class="n">Tc2_EtherCat</span><span class="o">.</span><span class="n">DCTIME64_TO_STRING</span><span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOn</span><span class="p">);</span>                        <span class="o">//</span><span class="n">Convert</span> <span class="n">to</span> <span class="n">string</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">iTerminalID</span> <span class="o">:=</span> <span class="n">iTerminal_ID</span><span class="p">;</span>                                                                                                          <span class="o">//</span><span class="n">Terminal_ID</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">bWcState</span> <span class="o">:=</span> <span class="n">bWcState</span><span class="p">;</span>                                                                                                                         <span class="o">//</span><span class="n">WcState</span> <span class="n">bit</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">uiInfoDataState</span> <span class="o">:=</span> <span class="n">uiInfoData_State</span><span class="p">;</span>                                                                                          <span class="o">//</span><span class="n">uiInfoData_State</span>

            <span class="o">//</span><span class="n">Error</span> <span class="n">message</span> <span class="n">according</span> <span class="n">to</span> <span class="n">uiInfoData_State</span> <span class="ow">and</span> <span class="n">WcState</span>
            <span class="n">iStateError</span> <span class="o">:=</span> <span class="p">(</span><span class="n">uiInfoData_State</span> <span class="n">AND</span> <span class="mi">16</span><span class="c1">#000F);                                                                                          //Mask for operation state</span>
            <span class="n">iOtherError</span> <span class="o">:=</span> <span class="p">(</span><span class="n">uiInfoData_State</span> <span class="n">AND</span> <span class="mi">16</span><span class="c1">#00F0);                                                                                          //Mask for the other 3 kind of errors</span>
            <span class="o">//</span><span class="n">Error</span> <span class="n">messages</span> <span class="n">according</span> <span class="n">to</span> <span class="n">the</span> <span class="n">least</span> <span class="n">significant</span> <span class="n">digit</span>
            <span class="n">CASE</span> <span class="n">iStateError</span> <span class="n">OF</span>
                    <span class="mi">16</span><span class="c1">#0001 : ErrorData.sErrorMessage := &#39;Slave in INIT state;   &#39;;</span>
                    <span class="mi">16</span><span class="c1">#0002 : ErrorData.sErrorMessage := &#39;Slave in PREOP state;   &#39;;</span>
                    <span class="mi">16</span><span class="c1">#0003 : ErrorData.sErrorMessage := &#39;Slave in BOOT state;   &#39;;</span>
                    <span class="mi">16</span><span class="c1">#0004 : ErrorData.sErrorMessage := &#39;Slave in SAFEOP state;   &#39;;</span>
                    <span class="mi">16</span><span class="c1">#0008 : ;                                                                                                                                                     //Normal operation state</span>
            <span class="n">ELSE</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Undefined State of operation;   &#39;</span><span class="p">;</span>                                          <span class="o">//</span><span class="n">I</span> <span class="n">hope</span> <span class="n">we</span> <span class="n">will</span> <span class="n">never</span> <span class="n">see</span> <span class="n">this</span> <span class="n">message</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">iStateError</span><span class="p">));</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="s1">&#39;   &#39;</span><span class="p">);</span>
            <span class="n">END_CASE</span>

            <span class="o">//</span><span class="n">Error</span> <span class="n">messages</span> <span class="n">according</span> <span class="n">to</span> <span class="n">the</span> <span class="n">second</span> <span class="n">least</span> <span class="n">significant</span> <span class="n">digit</span>
            <span class="n">CASE</span> <span class="n">iOtherError</span> <span class="n">OF</span>
                    <span class="mi">16</span><span class="c1">#0000 : ;                                                                                                                                                     //No error case</span>
                    <span class="mi">16</span><span class="c1">#0010 : ErrorData.sErrorMessage := CONCAT (ErrorData.sErrorMessage, &#39;Slave signals error;   &#39;);</span>
                    <span class="mi">16</span><span class="c1">#0020 : ErrorData.sErrorMessage := CONCAT (ErrorData.sErrorMessage, &#39;Invalid vendorID/productCode read;   &#39;);</span>
                    <span class="mi">16</span><span class="c1">#0040 : ErrorData.sErrorMessage := CONCAT (ErrorData.sErrorMessage, &#39;Initialisation error occured;   &#39;);</span>
            <span class="n">ELSE</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="s1">&#39;Undefined Error ID: &#39;</span><span class="p">);</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">iOtherError</span><span class="p">));</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="s1">&#39;   &#39;</span><span class="p">);</span>
            <span class="n">END_CASE</span>

            <span class="o">//</span><span class="n">Errormessage</span> <span class="n">according</span> <span class="n">to</span> <span class="n">WcState</span> <span class="n">bit</span>
            <span class="n">IF</span> <span class="n">bWcState</span> <span class="n">THEN</span>
                    <span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span> <span class="o">:=</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">sErrorMessage</span><span class="p">,</span> <span class="s1">&#39;Invalid Data;&#39;</span><span class="p">);</span>
            <span class="n">END_IF</span>

            <span class="o">//</span><span class="n">Check</span> <span class="k">for</span> <span class="n">overflow</span>
            <span class="n">IF</span> <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">nNoErrors</span> <span class="o">=</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="n">THEN</span>
                    <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">nNoOverflows</span> <span class="o">:=</span> <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">nNoOverflows</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>

            <span class="o">//</span><span class="n">Write</span> <span class="n">Error</span> <span class="n">Data</span> <span class="n">into</span> <span class="n">Error</span> <span class="n">System</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">Error_ID</span> <span class="o">:=</span> <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">lNextErrorID</span> <span class="p">;</span>
            <span class="n">MEMMOVE</span><span class="p">(</span> <span class="n">ADR</span><span class="p">(</span><span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">ADR</span><span class="p">(</span><span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">DUT_TerminalError</span><span class="p">));</span>
            <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:=</span> <span class="n">ErrorData</span><span class="p">;</span>
            <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">lNextErrorID</span> <span class="o">:=</span> <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">lNextErrorID</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">ELSE</span>
            <span class="o">//</span><span class="n">Close</span> <span class="n">Active</span> <span class="n">Error</span>
            <span class="o">//</span><span class="n">Read</span> <span class="n">system</span> <span class="n">time</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOff</span> <span class="o">:=</span> <span class="n">Tc2_EtherCAT</span><span class="o">.</span><span class="n">F_GetActualDcTime64</span><span class="p">();</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">sDateTimeOff</span> <span class="o">:=</span> <span class="n">Tc2_EtherCat</span><span class="o">.</span><span class="n">DCTIME64_TO_STRING</span><span class="p">(</span><span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOff</span><span class="p">);</span>
            <span class="n">ErrorData</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">:=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Inactive</span><span class="p">;</span>

            <span class="o">//</span><span class="n">Write</span> <span class="n">Off</span> <span class="n">time</span> <span class="n">to</span> <span class="n">Error</span> <span class="n">System</span>
            <span class="n">FOR</span> <span class="n">nErrSysCNT</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="n">GVL_ErrorSystem</span><span class="o">.</span><span class="n">cSizeOfErrorData</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">DO</span>
                    <span class="n">IF</span> <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">Error_ID</span> <span class="o">=</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">Error_ID</span> <span class="n">THEN</span>
                            <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">nDateTimeOff</span> <span class="o">:=</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">nDateTimeOff</span><span class="p">;</span>
                            <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">sDateTimeOff</span> <span class="o">:=</span> <span class="n">ErrorData</span><span class="o">.</span><span class="n">sDateTimeOff</span><span class="p">;</span>
                            <span class="n">pErrorSystem</span><span class="o">^.</span><span class="n">aErrorData</span><span class="p">[</span><span class="n">nErrSysCNT</span><span class="p">]</span><span class="o">.</span><span class="n">ErrorState</span> <span class="o">:=</span> <span class="n">DUT_ErrorState</span><span class="o">.</span><span class="n">Inactive</span><span class="p">;</span>
                            <span class="n">EXIT</span><span class="p">;</span>
                    <span class="n">END_IF</span>
            <span class="n">END_FOR</span>

            <span class="o">//</span><span class="n">Clear</span> <span class="n">ErrorData</span>
            <span class="n">MEMSET</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">ErrorData</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">ErrorData</span><span class="p">));</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-errorstate">DUT_ErrorState</a></p></li>
<li><p><a class="reference internal" href="#dut-terminalerror">DUT_TerminalError</a></p></li>
<li><p><a class="reference internal" href="#gvl-errorsystem">GVL_ErrorSystem</a></p></li>
<li><p><a class="reference internal" href="#st-errorsystem">ST_ErrorSystem</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-testhelpersetandmove">
<h2>FB_TestHelperSetAndMove<a class="headerlink" href="#fb-testhelpersetandmove" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TestHelperSetAndMove</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Set</span> <span class="n">an</span> <span class="n">stMotionStage</span> <span class="n">to</span> <span class="n">a</span> <span class="n">start</span> <span class="n">position</span><span class="p">,</span> <span class="n">then</span> <span class="n">cause</span> <span class="n">a</span> <span class="n">move</span><span class="o">.</span>
    <span class="n">On</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">of</span> <span class="n">bExecute</span><span class="p">,</span> <span class="n">errors</span> <span class="n">are</span> <span class="n">cleared</span><span class="p">,</span> <span class="n">the</span> <span class="n">user</span> <span class="n">enable</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">FALSE</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">position</span> <span class="ow">is</span> <span class="nb">set</span><span class="o">.</span>
    <span class="n">After</span> <span class="n">the</span> <span class="n">position</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">,</span> <span class="n">user</span> <span class="n">enable</span> <span class="ow">is</span> <span class="n">re</span><span class="o">-</span><span class="n">introduced</span> <span class="ow">and</span> <span class="n">a</span> <span class="n">move</span> <span class="n">begins</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">progress</span> <span class="n">of</span> <span class="n">this</span> <span class="n">function</span> <span class="n">block</span> <span class="k">for</span> <span class="n">the</span> <span class="n">purposes</span> <span class="n">of</span> <span class="n">a</span> <span class="n">unit</span> <span class="n">test</span> <span class="n">can</span> <span class="n">be</span> <span class="n">monitored</span> <span class="n">via</span> <span class="n">the</span> <span class="n">outputs</span><span class="o">.</span>

    <span class="n">The</span> <span class="n">motion</span> <span class="n">stage</span> <span class="n">should</span> <span class="n">have</span> <span class="n">its</span> <span class="n">own</span> <span class="n">FB_MotionStage</span> <span class="ow">or</span> <span class="n">some</span> <span class="n">stand</span><span class="o">-</span><span class="ow">in</span> <span class="k">for</span> <span class="n">it</span> <span class="n">running</span> <span class="n">on</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">the</span> <span class="n">FB</span><span class="o">.</span>

    <span class="n">This</span> <span class="ow">is</span><span class="p">,</span> <span class="ow">in</span> <span class="n">itself</span><span class="p">,</span> <span class="n">tested</span> <span class="ow">in</span> <span class="n">FB_TestHelperSetAndMove_Test</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">motion</span> <span class="n">state</span> <span class="n">to</span> <span class="n">test</span> <span class="k">with</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Begin</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span><span class="p">,</span> <span class="n">stop</span> <span class="n">on</span> <span class="n">falling</span> <span class="n">edge</span><span class="o">.</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">position</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">to</span>
    <span class="n">fStartPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">goal</span> <span class="n">to</span> <span class="n">move</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">towards</span>
    <span class="n">fGoalPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">velocity</span> <span class="n">to</span> <span class="n">move</span> <span class="n">at</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;ll set all the hardware enable signals. Leave this as FALSE if your testing involves any of the hardware enables.</span>
    <span class="n">bHWEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">has</span> <span class="n">no</span> <span class="n">errors</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">deactivated</span><span class="o">.</span>
    <span class="n">bResetDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="nb">set</span> <span class="n">position</span> <span class="n">completes</span><span class="o">.</span>
    <span class="n">bSetDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">begins</span> <span class="n">moving</span><span class="o">.</span>
    <span class="n">bMotionStarted</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">once</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">reaches</span> <span class="n">its</span> <span class="n">destination</span><span class="o">.</span>
    <span class="n">bMoveDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">bBusy</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">the</span> <span class="n">function</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">ready</span> <span class="k">for</span> <span class="n">a</span> <span class="n">new</span> <span class="n">request</span><span class="o">.</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">after</span> <span class="n">bExecute</span> <span class="n">rises</span> <span class="ow">and</span> <span class="n">back</span> <span class="n">to</span> <span class="n">FALSE</span> <span class="n">after</span> <span class="n">bMoveDone</span> <span class="ow">or</span> <span class="n">bError</span> <span class="n">rises</span><span class="o">.</span> <span class="n">Also</span> <span class="n">goes</span> <span class="n">to</span> <span class="n">FALSE</span> <span class="n">after</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">stops</span> <span class="n">following</span> <span class="n">bExecute</span> <span class="n">being</span> <span class="n">dropped</span> <span class="n">to</span> <span class="n">FALSE</span><span class="o">.</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="ow">in</span> <span class="n">case</span> <span class="n">of</span> <span class="n">an</span> <span class="n">error</span> <span class="kn">from</span> <span class="nn">FB_MotionRequest</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Counts</span> <span class="n">up</span> <span class="kn">from</span> <span class="nn">bExecute</span><span class="s1">&#39;s rising trigger. Can be used to implement a timeout.</span>
    <span class="n">tElapsed</span><span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Current</span> <span class="n">motor</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">case</span> <span class="n">you</span><span class="s1">&#39;re looking for it</span>
    <span class="n">fActPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Goes</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re trying to stop a move. We&#39;</span><span class="n">ll</span> <span class="n">stop</span> <span class="n">an</span> <span class="ow">in</span><span class="o">-</span><span class="n">progress</span> <span class="n">move</span> <span class="n">when</span> <span class="n">bExecute</span> <span class="n">goes</span> <span class="n">to</span> <span class="n">FALSE</span><span class="p">,</span> <span class="ow">and</span> <span class="n">we</span><span class="s1">&#39;ll make sure the motor fully stops before responding to the next bExecute rising edge.</span>
    <span class="n">bStoppingMotor</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbMoveRequest</span><span class="p">:</span> <span class="n">FB_MotionRequest</span><span class="p">;</span>
    <span class="n">mcSetPos</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">tonTimeout</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftExec</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">bExecQueued</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nLatchError</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">tonTimeout</span><span class="p">(</span>
    <span class="n">IN</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1h,</span>
    <span class="n">ET</span><span class="o">=&gt;</span><span class="n">tElapsed</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">ftExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">outputs</span> <span class="n">to</span> <span class="n">known</span> <span class="n">values</span> <span class="n">on</span> <span class="n">exec</span>
<span class="n">bResetDone</span> <span class="n">R</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bSetDone</span> <span class="n">R</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bMotionStarted</span> <span class="n">R</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bMoveDone</span> <span class="n">R</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bBusy</span> <span class="n">S</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bError</span> <span class="n">R</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="n">bExecQueued</span> <span class="n">S</span><span class="o">=</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bExecQueued</span> <span class="n">R</span><span class="o">=</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">bStoppingMotor</span> <span class="n">S</span><span class="o">=</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">hardware</span> <span class="n">enables</span> <span class="k">if</span> <span class="n">asked</span>
<span class="n">IF</span> <span class="n">bHWEnable</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="o">//</span> <span class="n">Note</span> <span class="n">that</span> <span class="n">we</span> <span class="n">only</span> <span class="n">reset</span> <span class="k">if</span> <span class="n">it</span><span class="s1">&#39;s needed, e.g. the motor has an error or is enabled or moving etc. etc.</span>
<span class="n">bResetDone</span> <span class="n">S</span><span class="o">=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bAllEnable</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">All</span> <span class="n">uses</span> <span class="n">of</span> <span class="n">fbMoveRequest</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">IF</span><span class="o">/</span><span class="n">ELSE</span> <span class="n">tree</span>
<span class="n">IF</span> <span class="n">bStoppingMotor</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Continue</span> <span class="n">stopping</span> <span class="n">the</span> <span class="n">motor</span> <span class="kn">from</span> <span class="nn">previous</span> <span class="n">cycles</span>
    <span class="n">fbMoveRequest</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bStoppingMotor</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ControlLoopClosed</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbMoveRequest</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">bExecQueued</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">First</span> <span class="n">exec</span> <span class="n">cycle</span><span class="p">:</span> <span class="n">bring</span> <span class="n">these</span> <span class="n">to</span> <span class="n">FALSE</span> <span class="k">for</span> <span class="n">later</span> <span class="n">use</span>
    <span class="n">bExecQueued</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bUserEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbMoveRequest</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="n">bReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">bResetDone</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Other</span> <span class="n">cycles</span><span class="p">:</span> <span class="n">reset</span> <span class="n">until</span> <span class="n">we</span><span class="s1">&#39;re done resetting</span>
    <span class="n">fbMoveRequest</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">bReset</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">ELSIF</span> <span class="n">fStartPosition</span> <span class="o">&lt;&gt;</span> <span class="n">fGoalPosition</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Later</span><span class="p">:</span> <span class="n">do</span> <span class="n">the</span> <span class="n">move</span>
    <span class="o">//</span> <span class="n">Important</span> <span class="n">to</span> <span class="ow">not</span> <span class="n">enable</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">until</span> <span class="n">the</span> <span class="nb">set</span> <span class="n">position</span> <span class="ow">is</span> <span class="n">done</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bUserEnable</span> <span class="o">:=</span> <span class="n">bSetDone</span><span class="p">;</span>
    <span class="n">fbMoveRequest</span><span class="p">(</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
        <span class="n">bExecute</span><span class="o">:=</span><span class="n">bSetDone</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bMoveDone</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span><span class="p">,</span>
        <span class="n">bReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="n">enumMotionRequest</span><span class="o">:=</span><span class="n">E_MotionRequest</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="p">,</span>
        <span class="n">fPos</span><span class="o">:=</span><span class="n">fGoalPosition</span><span class="p">,</span>
        <span class="n">fVel</span><span class="o">:=</span><span class="n">fVelocity</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">bMotionStarted</span> <span class="n">S</span><span class="o">=</span> <span class="n">bSetDone</span> <span class="n">AND</span> <span class="n">fbMoveRequest</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&lt;&gt;</span> <span class="n">fStartPosition</span><span class="p">;</span>
    <span class="n">bMoveDone</span> <span class="n">S</span><span class="o">=</span> <span class="n">bMotionStarted</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">=</span> <span class="n">fGoalPosition</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">position</span> <span class="n">prior</span> <span class="n">to</span> <span class="n">the</span> <span class="n">move</span> <span class="n">but</span> <span class="n">after</span> <span class="n">the</span> <span class="n">reset</span><span class="o">.</span>
<span class="n">mcSetPos</span><span class="p">(</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bResetDone</span> <span class="n">AND</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bSetDone</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bError</span><span class="p">,</span>
    <span class="n">Position</span><span class="o">:=</span><span class="n">fStartPosition</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">nLatchError</span> <span class="o">:=</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">bSetDone</span> <span class="n">S</span><span class="o">=</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Done</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">=</span> <span class="n">fStartPosition</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Any</span> <span class="n">sub</span><span class="o">-</span><span class="n">error</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">error</span> <span class="n">here</span>
<span class="n">bError</span> <span class="o">:=</span> <span class="n">fbMoveRequest</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">mcSetPos</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Reset</span> <span class="n">bBusy</span> <span class="n">when</span> <span class="n">appropriate</span>
<span class="n">bBusy</span> <span class="n">R</span><span class="o">=</span> <span class="p">(</span><span class="n">bMoveDone</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bStoppingMotor</span><span class="p">)</span> <span class="n">OR</span> <span class="n">bError</span> <span class="n">OR</span> <span class="n">ftExec</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Extract</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">position</span>
<span class="n">fActPosition</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-motionrequest">E_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-motionrequest">FB_MotionRequest</a></p></li>
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove-test">FB_TestHelperSetAndMove_Test</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-testhelpersetandmove-test">
<h2>FB_TestHelperSetAndMove_Test<a class="headerlink" href="#fb-testhelpersetandmove-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TestHelperSetAndMove_Test</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Ensure</span> <span class="n">that</span> <span class="n">the</span> <span class="n">test</span> <span class="n">helper</span> <span class="n">function</span> <span class="n">block</span> <span class="n">works</span> <span class="k">as</span> <span class="n">needed</span><span class="o">.</span>
    <span class="n">Without</span> <span class="n">this</span><span class="p">,</span> <span class="nb">all</span> <span class="n">tests</span> <span class="n">that</span> <span class="n">need</span> <span class="n">motion</span> <span class="n">cannot</span> <span class="k">pass</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR</span>
    <span class="n">stMotionStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbTestMove</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove</span><span class="p">;</span>
    <span class="n">rtResetDone</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtSetDone</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtMotionStart</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtMoveDone</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbMotionStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionstage</span><span class="p">);</span>
<span class="n">BasicMotion</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">PRIVATE</span> <span class="n">BasicMotion</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;BasicMotion&#39;</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">fbTestMove</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="p">,</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">fStartPosition</span><span class="o">:=</span><span class="mf">15.0</span><span class="p">,</span>
    <span class="n">fGoalPosition</span><span class="o">:=</span><span class="mf">17.0</span><span class="p">,</span>
    <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">bHWEnable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">rtResetDone</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">bResetDone</span><span class="p">);</span>
<span class="n">rtSetDone</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">bSetDone</span><span class="p">);</span>
<span class="n">rtMotionStart</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">bMotionStarted</span><span class="p">);</span>
<span class="n">rtMoveDone</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">bMoveDone</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtResetDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Reset did not clear error&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Real position output does not match real position.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">rtSetDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Was not set to start position after set done&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">rtMotionStart</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;stMotionStage is not busy, but motion is said to have started.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&gt;</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">fStartPosition</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;stMotionStage has not moved, but motion is said to have started.&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">rtMoveDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">AssertEquals_LREAL</span><span class="p">(</span>
        <span class="n">Expected</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fGoalPosition</span><span class="p">,</span>
        <span class="n">Actual</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span>
        <span class="n">Delta</span><span class="o">:=</span><span class="mf">0.001</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Did not reach destination at move done&#39;</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s OR (fbTestMove.bResetDone AND fbTestMove.bSetDone AND fbTestMove.bMotionStarted AND fbTestMove.bMoveDone) THEN</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Error in fbTestMove&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">AssertFalse</span><span class="p">(</span>
        <span class="n">Condition</span><span class="o">:=</span><span class="n">fbTestMove</span><span class="o">.</span><span class="n">tElapsed</span> <span class="o">&gt;</span> <span class="n">T</span><span class="c1">#5s,</span>
        <span class="n">Message</span><span class="o">:=</span><span class="s1">&#39;Timeout in basic motion test&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_IF</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-motionstage">FB_MotionStage</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove">FB_TestHelperSetAndMove</a></p></li>
<li><p><a class="reference internal" href="#st-motionstage">ST_MotionStage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-writefloatparameter">
<h2>FB_WriteFloatParameter<a class="headerlink" href="#fb-writefloatparameter" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="c1">#########################################################</span>
<span class="o">///</span><span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Library</span><span class="p">:</span>
<span class="o">///</span> <span class="n">Tc2_MC2</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span> <span class="n">Tc2_System</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Global</span> <span class="n">Variables</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Data</span> <span class="n">types</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">External</span> <span class="n">functions</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">History</span><span class="p">:</span>
<span class="o">///</span> <span class="mi">2014</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">05</span>      <span class="n">v1</span><span class="mf">.00</span>   <span class="n">NB</span>      <span class="n">Release</span> <span class="n">code</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Known</span> <span class="n">bugs</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span>
<span class="o">///</span>
<span class="o">///</span><span class="c1">###########################################################</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_WriteFloatParameter</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="mi">16</span><span class="c1">#4000=Axisdata, 16#5000=Encoderdata, 16#6000=Controldata, 16#7000=Drivedata</span>
    <span class="n">nDeviceGroup</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndexOffset</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nData</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fbADSWRITE</span><span class="p">:</span> <span class="n">ADSWRITE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">Sequence</span> <span class="n">to</span> <span class="n">write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="mi">0</span><span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">Start</span> <span class="n">sequence</span><span class="o">.</span> <span class="n">Wait</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">TRUE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bBusy</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fbADSWRITE</span><span class="p">(</span>
            <span class="n">PORT</span><span class="o">:=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">IDXGRP</span><span class="o">:=</span><span class="n">nDeviceGroup</span><span class="o">+</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">,</span>
            <span class="n">IDXOFFS</span><span class="o">:=</span><span class="n">nIndexOffset</span><span class="p">,</span>
            <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">SRCADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">WRITE</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Wait</span> <span class="n">until</span> <span class="n">it</span><span class="s1">&#39;s done or if an error occurs*)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">ERR</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">BUSY</span> <span class="n">THEN</span>
                    <span class="n">fbADSWRITE</span><span class="p">(</span><span class="n">WRITE</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                    <span class="n">nState</span><span class="o">:=</span><span class="mi">20</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">ELSE</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">ERRID</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">999</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Sequense</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span> <span class="n">Waits</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">999</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbADSWRITE</span><span class="p">(</span><span class="n">WRITE</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-writeparameterinnc-v1-00">
<h2>FB_WriteParameterInNc_v1_00<a class="headerlink" href="#fb-writeparameterinnc-v1-00" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">///</span><span class="c1">#########################################################</span>
<span class="o">///</span><span class="n">Function</span> <span class="n">block</span> <span class="n">to</span> <span class="n">write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Library</span><span class="p">:</span>
<span class="o">///</span> <span class="n">Tc2_MC2</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span> <span class="n">Tc2_System</span><span class="o">.</span><span class="n">lib</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Global</span> <span class="n">Variables</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Data</span> <span class="n">types</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">External</span> <span class="n">functions</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">History</span><span class="p">:</span>
<span class="o">///</span> <span class="mi">2014</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">05</span>      <span class="n">v1</span><span class="mf">.00</span>   <span class="n">NB</span>      <span class="n">Release</span> <span class="n">code</span><span class="o">.</span>
<span class="o">///</span>
<span class="o">///</span> <span class="n">Known</span> <span class="n">bugs</span><span class="p">:</span>
<span class="o">///</span>
<span class="o">///</span>
<span class="o">///</span>
<span class="o">///</span><span class="c1">###########################################################</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_WriteParameterInNc_v1_00</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="mi">16</span><span class="c1">#4000=Axisdata, 16#5000=Encoderdata, 16#6000=Controldata, 16#7000=Drivedata</span>
    <span class="n">nDeviceGroup</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndexOffset</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nData</span><span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fbADSWRITE</span><span class="p">:</span> <span class="n">ADSWRITE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">Sequence</span> <span class="n">to</span> <span class="n">write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="mi">0</span><span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">Start</span> <span class="n">sequence</span><span class="o">.</span> <span class="n">Wait</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">TRUE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bBusy</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
            <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fbADSWRITE</span><span class="p">(</span>
            <span class="n">PORT</span><span class="o">:=</span><span class="mi">500</span><span class="p">,</span>
            <span class="n">IDXGRP</span><span class="o">:=</span><span class="n">nDeviceGroup</span><span class="o">+</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">,</span>
            <span class="n">IDXOFFS</span><span class="o">:=</span><span class="n">nIndexOffset</span><span class="p">,</span>
            <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">SRCADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
            <span class="n">WRITE</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Wait</span> <span class="n">until</span> <span class="n">it</span><span class="s1">&#39;s done or if an error occurs*)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">ERR</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">BUSY</span> <span class="n">THEN</span>
                    <span class="n">fbADSWRITE</span><span class="p">(</span><span class="n">WRITE</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
                    <span class="n">nState</span><span class="o">:=</span><span class="mi">20</span><span class="p">;</span>
            <span class="n">END_IF</span>
    <span class="n">ELSE</span>
            <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">ERRID</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">999</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Sequense</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span> <span class="n">Waits</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">999</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbADSWRITE</span><span class="p">(</span><span class="n">WRITE</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="prg-test">
<h2>PRG_TEST<a class="headerlink" href="#prg-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">PRG_TEST</span>
<span class="n">VAR</span>
    <span class="n">fb_TestHelperSetAndMove_Test</span><span class="p">:</span> <span class="n">FB_TestHelperSetAndMove_Test</span><span class="p">;</span>
    <span class="n">fb_AtPositionState_Test</span><span class="p">:</span> <span class="n">FB_AtPositionState_Test</span><span class="p">;</span>
    <span class="n">fb_PositionStateRead_Test</span><span class="p">:</span> <span class="n">FB_PositionStateRead_Test</span><span class="p">;</span>
    <span class="n">fb_PositionStateReadND_Test</span><span class="p">:</span> <span class="n">FB_PositionStateReadND_Test</span><span class="p">;</span>
    <span class="n">fb_PositionStateMove_Test</span><span class="p">:</span> <span class="n">FB_PositionStateMove_Test</span><span class="p">;</span>
    <span class="n">fb_PositionStateMoveND_Test</span><span class="p">:</span> <span class="n">FB_PositionStateMoveND_Test</span><span class="p">;</span>
    <span class="n">fb_PositionStateND_Test</span><span class="p">:</span> <span class="n">FB_PositionStateND_Test</span><span class="p">;</span>
    <span class="n">fb_NCErrorFFO_Test</span><span class="p">:</span> <span class="n">FB_NCErrorFFO_Test</span><span class="p">;</span>
    <span class="n">fb_MiscStatesErrorFFO_Test</span><span class="p">:</span> <span class="n">FB_MiscStatesErrorFFO_Test</span><span class="p">;</span>
    <span class="n">fb_MotionBPTM_Test</span><span class="p">:</span> <span class="n">FB_MotionBPTM_Test</span><span class="p">;</span>
    <span class="n">fb_MotionClearAsserts_Test</span><span class="p">:</span> <span class="n">FB_MotionClearAsserts_Test</span><span class="p">;</span>
    <span class="n">fb_StatePMPSEnables_Test</span><span class="p">:</span> <span class="n">FB_StatePMPSEnables_Test</span><span class="p">;</span>
    <span class="n">fb_MotionReadPMPSDBND_Test</span><span class="p">:</span> <span class="n">FB_MotionReadPMPSDBND_Test</span><span class="p">;</span>
    <span class="n">fb_PerMotorFFOND_Test</span><span class="p">:</span> <span class="n">FB_PerMotorFFOND_Test</span><span class="p">;</span>
    <span class="n">fb_StatePMPSEnablesND_Test</span><span class="p">:</span> <span class="n">FB_StatePMPSEnablesND_Test</span><span class="p">;</span>
    <span class="n">fb_PositionStatePMPSND_Test</span><span class="p">:</span> <span class="n">FB_PositionStatePMPSND_Test</span><span class="p">;</span>
    <span class="n">fb_StateSetupHelper_Test</span><span class="p">:</span> <span class="n">FB_StateSetupHelper_Test</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TcUnit</span><span class="o">.</span><span class="n">RUN</span><span class="p">();</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-atpositionstate-test">FB_AtPositionState_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-miscstateserrorffo-test">FB_MiscStatesErrorFFO_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-motionbptm-test">FB_MotionBPTM_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-motionclearasserts-test">FB_MotionClearAsserts_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-motionreadpmpsdbnd-test">FB_MotionReadPMPSDBND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-ncerrorffo-test">FB_NCErrorFFO_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-permotorffond-test">FB_PerMotorFFOND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemovend-test">FB_PositionStateMoveND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatemove-test">FB_PositionStateMove_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatend-test">FB_PositionStateND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatepmpsnd-test">FB_PositionStatePMPSND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstatereadnd-test">FB_PositionStateReadND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstateread-test">FB_PositionStateRead_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenablesnd-test">FB_StatePMPSEnablesND_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-statepmpsenables-test">FB_StatePMPSEnables_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-statesetuphelper-test">FB_StateSetupHelper_Test</a></p></li>
<li><p><a class="reference internal" href="#fb-testhelpersetandmove-test">FB_TestHelperSetAndMove_Test</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="lcls-twincat-motion_Library_epics.html" class="btn btn-neutral float-left" title="Data Types" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, SLAC National Accelerator Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>